import{u as L}from"./workflowStore-Bgj2M1T-.js";import M from"./StepCard-C4GzHSut.js";import W from"./DataTokenInserter-CMXvnI3L.js";import{S as f}from"./SelectDropdown-ChnFxdu6.js";import{a as q}from"./RelatedDataPicker-CEz4Yi0k.js";import{P as E}from"./plus-DaKXsK2I.js";import{T as P}from"./trash-CJv9kWOn.js";import{c as r,r as z,g as V,o as i,w as G,b as a,a as v,i as H,d,m as $,u as F,F as J,l as K,t as Q}from"./app-x8m_4hY2.js";/* empty css                                                                       */import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./createLucideIcon-BoPNbwuz.js";const X={class:"space-y-3"},Y={key:0,class:"space-y-3"},Z={class:"flex items-center justify-between"},ee={class:"space-y-2"},te={class:"grid grid-cols-3 gap-2 items-center"},le={class:"flex items-center justify-end"},oe=["onClick"],ae={class:"grid grid-cols-2 gap-2"},se={class:"flex items-center gap-1"},ne=["value","onChange"],ue=["type","value","onInput"],re={class:"flex items-center gap-2 pt-1"},ie={class:"inline-flex items-center gap-2 text-sm"},de=["checked"],ce={class:"p-2 border rounded-md bg-gray-50/60"},pe={class:"flex items-center justify-between"},me={class:"text-[11px] text-gray-500"},Se={__name:"FetchRecordsStep",props:{step:{type:Object,required:!0},allStepsBefore:{type:Array,default:()=>[]},loopContextSchema:{type:Object,default:null}},emits:["update:step","delete"],setup(b,{emit:D}){const y=b,h=D,T=L(),x=r(()=>T.automationSchema||[]),o=r({get:()=>y.step.step_config||{conditions:[]},set:t=>h("update:step",{...y.step,step_config:t})}),U=r(()=>x.value.map(t=>t.name)),I=r(()=>U.value.map(t=>({value:t,label:t}))),_=r(()=>o.value.model&&x.value.find(t=>t.name===o.value.model)||null);function C(t){if(!t||typeof t!="string")return"";let e=t.toLowerCase();if(e==="id")return"ID";e.endsWith("_id")&&(e=e.slice(0,-3)),e=e.replace(/[_-]+/g," ");let l=e.replace(/\b\w/g,s=>s.toUpperCase());return l=l.replace(/\bId\b/g,"ID").replace(/\bUrl\b/g,"URL"),l}const w=r(()=>_.value?(_.value.columns||[]).map(t=>typeof t=="string"?{name:t,label:C(t),type:"Text"}:{...t,label:t.label||C(t.name)}):[]),j=r(()=>w.value.map(t=>({value:t.name,label:`${t.label||t.name}${t.type?` (${t.type})`:""}`})));function c(t){return w.value.find(e=>e.name===t)||null}function O(t){const e=c(t);switch((e==null?void 0:e.type)||"Text"){case"True/False":return[{value:"==",label:"is"},{value:"!=",label:"is not"}];case"Number":return[{value:"==",label:"equals"},{value:">",label:">"},{value:"<",label:"<"},{value:">=",label:">="},{value:"<=",label:"<="}];case"Date":case"DateTime":return[{value:"==",label:"on"},{value:">",label:"after"},{value:"<",label:"before"}];default:return[{value:"==",label:"is"},{value:"!=",label:"is not"},{value:"contains",label:"contains"}]}}function A(){const t=[...o.value.conditions||[],{column:"",operator:"==",value:""}];o.value={...o.value,conditions:t}}function B(t){const e=(o.value.conditions||[]).filter((l,s)=>s!==t);o.value={...o.value,conditions:e}}function p(t,e,l){const s=[...o.value.conditions||[]];s[t]={...s[t],[e]:l},o.value={...o.value,conditions:s}}function N(t,e){var u;const s=((u=(o.value.conditions||[])[t])==null?void 0:u.value)||"";p(t,"value",`${s}${e}`)}const g=z(!1),R=r(()=>{const t=o.value.relationships||{},e=Array.isArray(t.roots)?t.roots:[],l=t.nested||{};if(!e.length)return"None";const s=[];return e.forEach(u=>{const m=Array.isArray(l[u])?l[u]:[];m.length?s.push(`${u} (+ ${m.join(", ")})`):s.push(u)}),s.join(", ")});return(t,e)=>(i(),V(M,{icon:"🔍",title:"Fetch Records",onDelete:()=>h("delete")},{default:G(()=>[a("div",X,[a("div",null,[e[5]||(e[5]=a("label",{class:"block text-xs font-medium text-gray-600 mb-1"},"Find records from",-1)),d(f,{options:I.value,"model-value":o.value.model||null,placeholder:"Select model...","onUpdate:modelValue":e[0]||(e[0]=l=>o.value={...o.value,model:l,conditions:[]})},null,8,["options","model-value"])]),o.value.model?(i(),v("div",Y,[a("div",Z,[e[7]||(e[7]=a("label",{class:"text-xs font-medium text-gray-600"},"Where conditions match",-1)),a("button",{onClick:A,class:"flex items-center gap-1 px-2 py-1 text-xs rounded-md bg-gray-100 hover:bg-gray-200"},[d(F(E),{class:"h-3 w-3"}),e[6]||(e[6]=$(" Add",-1))])]),a("div",ee,[(i(!0),v(J,null,K(o.value.conditions,(l,s)=>{var u,m,k,S;return i(),v("div",{key:s,class:"p-2 border rounded-md bg-gray-50/50 space-y-2"},[a("div",te,[d(f,{options:j.value,"model-value":l.column||null,placeholder:"Field...","onUpdate:modelValue":n=>p(s,"column",n),class:"col-span-2"},null,8,["options","model-value","onUpdate:modelValue"]),a("div",le,[a("button",{onClick:n=>B(s),class:"p-1 text-gray-400 hover:text-red-500"},[d(F(P),{class:"w-4 h-4"})],8,oe)])]),a("div",ae,[d(f,{options:O(l.column),"model-value":l.operator||"==",placeholder:"Operator","onUpdate:modelValue":n=>p(s,"operator",n)},null,8,["options","model-value","onUpdate:modelValue"]),a("div",se,[(u=c(l.column))!=null&&u.allowed_values?(i(),V(f,{key:0,options:(c(l.column).allowed_values||[]).map(n=>({value:n.value,label:n.label})),"model-value":l.value||null,placeholder:"Select value...","onUpdate:modelValue":n=>p(s,"value",n)},null,8,["options","model-value","onUpdate:modelValue"])):((m=c(l.column))==null?void 0:m.type)==="True/False"?(i(),v("select",{key:1,value:l.value??"true",onChange:n=>p(s,"value",n.target.value),class:"w-full border rounded px-2 py-2 text-sm"},e[8]||(e[8]=[a("option",{value:"true"},"True",-1),a("option",{value:"false"},"False",-1)]),40,ne)):(i(),v("input",{key:2,type:((k=c(l.column))==null?void 0:k.type)==="Date"?"date":((S=c(l.column))==null?void 0:S.type)==="DateTime"?"datetime-local":"text",value:l.value,onInput:n=>p(s,"value",n.target.value),placeholder:"Value",class:"w-full border rounded px-2 py-2 text-sm"},null,40,ue)),d(W,{"all-steps-before":b.allStepsBefore,"loop-context-schema":b.loopContextSchema,onInsert:n=>N(s,n)},null,8,["all-steps-before","loop-context-schema","onInsert"])])])])}),128))]),a("div",re,[a("label",ie,[a("input",{type:"checkbox",checked:!!o.value.single,onChange:e[1]||(e[1]=l=>o.value={...o.value,single:l.target.checked}),class:"rounded border-gray-300"},null,40,de),e[9]||(e[9]=$(" Only first match (single record) ",-1))])]),a("div",ce,[a("div",pe,[a("div",null,[e[10]||(e[10]=a("p",{class:"text-xs font-medium text-gray-700"},"Include Related Data",-1)),a("p",me,Q(R.value),1)]),a("button",{type:"button",class:"text-xs px-2 py-1 rounded-md bg-white ring-1 ring-gray-300 hover:bg-gray-50",onClick:e[2]||(e[2]=l=>g.value=!0)},"Choose…")]),d(q,{show:g.value,"base-model-name":o.value.model,"model-value":o.value.relationships||{base_model:o.value.model,roots:[],nested:{},fields:{}},"onUpdate:modelValue":e[3]||(e[3]=l=>o.value={...o.value,relationships:l}),onClose:e[4]||(e[4]=l=>g.value=!1)},null,8,["show","base-model-name","model-value"])])])):H("",!0)])]),_:1},8,["onDelete"]))}};export{Se as default};
