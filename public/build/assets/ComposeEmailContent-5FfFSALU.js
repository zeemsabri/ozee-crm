import{A as W,r as d,c as F,e as M,f as X,a as n,o,b as m,i as p,d as c,u as l,g as k,t as D,F as Y,l as ee,w as B,m as I,j as te,x as ae,p as u}from"./app-DO6hfj1S.js";import{_ as w}from"./InputLabel-C8S7OxCX.js";import{_ as se}from"./TextInput-BiLrj9VW.js";import{_ as x}from"./InputError-L_lS4kVQ.js";import{O}from"./CustomMultiSelect-DFHxA1R9.js";import{_ as A}from"./PrimaryButton-CjtE71I3.js";import{S as L}from"./SelectDropdown-BHqjyRQ4.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";/* empty css                                                                       */const le={class:"p-4 space-y-6"},oe={class:"space-y-4"},ie={key:0},ne={key:0,class:"text-xs text-gray-500 mt-1"},re={key:1},ce={key:0,class:"text-gray-500 text-sm"},de={key:1,class:"text-red-500 text-sm"},me={key:2},pe={key:3,class:"space-y-4"},ue={key:0},_e={key:0,class:"text-gray-500 text-sm mt-1"},fe={key:1},ve={key:0,class:"text-gray-500 text-sm mt-1"},ye={key:4,class:"mt-6"},be={class:"flex justify-between items-center mb-3"},ge=["innerHTML"],je={class:"flex items-center justify-end mt-4"},Fe={__name:"ComposeEmailContent",props:{projectId:[Number,String]},emits:["submitted","error"],setup(N,{emit:H}){const V=N,T=H,e=W({subject:"",client_ids:[],status:"pending_approval",template_id:null,template_data:{},project_id:V.projectId||null}),U=d([]),S=d(!1),E=d([]),$=d(!1),v=d(""),y=d([]),_=d({}),f=d(!1),b=d(""),g=d(!1),P=F(()=>y.value.find(a=>a.id===e.template_id)),R=F(()=>P.value?P.value.placeholders.filter(a=>a.is_dynamic||a.is_repeatable||a.is_selectable):[]),z=F(()=>y.value.map(a=>({value:a.id,label:a.name}))),G=async()=>{S.value=!0;try{const a=await u.get("/api/projects-simplified");U.value=a.data}catch(a){console.error("Failed to fetch projects:",a)}finally{S.value=!1}},Z=async a=>{var s,t;if(!a){E.value=[];return}$.value=!0,v.value="";try{const i=await u.get(`/api/projects/${a}/sections/clients?type=clients`);E.value=i.data}catch(i){console.error("Failed to fetch project clients:",i),v.value=((t=(s=i.response)==null?void 0:s.data)==null?void 0:t.message)||"Failed to load client data."}finally{$.value=!1}},q=async()=>{try{const a=await u.get("/api/email-templates");y.value=a.data}catch(a){console.error("Failed to fetch email templates:",a)}},J=async a=>{if(!(!e.project_id||!a||!a.placeholders)){f.value=!0,_.value={};try{const s=a.placeholders.filter(r=>(r.is_selectable||r.is_repeatable)&&r.source_model);if(s.length===0){f.value=!1;return}const t={};s.forEach(r=>{t[r.source_model]||(t[r.source_model]=[]),t[r.source_model].push(r)});const i=Object.keys(t).map(async r=>{try{const C=await u.get(`/api/source-models/${encodeURIComponent(r)}`);t[r].forEach(j=>{_.value[j.name]=C.data.map(h=>({id:h.id,label:h[j.source_attribute]||h.name||`ID: ${h.id}`}))})}catch(C){console.error(`Failed to fetch data for model ${r}:`,C),t[r].forEach(j=>{_.value[j.name]=[]})}});await Promise.all(i)}catch(s){console.error("Error fetching source models data:",s)}finally{f.value=!1}}},K=async()=>{if(!e.template_id||e.client_ids.length===0||!e.project_id){b.value='<p class="text-gray-500 italic">Select a project, template, and at least one recipient to see a preview.</p>';return}g.value=!0;try{const a={template_id:e.template_id,client_id:e.client_ids[0],template_data:e.template_data},s=await u.post(`/api/projects/${e.project_id}/email-preview`,a);b.value=s.data.body_html,s.data.subject&&(e.subject=s.data.subject)}catch(a){console.error("Failed to fetch email preview:",a),b.value='<p class="text-red-500 italic">Error loading preview.</p>'}finally{g.value=!1}},Q=async()=>{const a=!!e.template_id;if(!a){console.error("Template not selected. All emails must be template-based.");return}const s="/api/emails/templated",t={project_id:e.project_id,subject:e.subject,body:null,composition_type:"template",status:"pending_approval"};e.client_ids.length>0?t.client_ids=e.client_ids:t.client_ids=[],a&&(t.template_id=e.template_id,t.template_data=e.template_data);try{await u.post(s,t),e.reset(),T("submitted")}catch(i){console.error("Email submission error:",i),T("error",i)}};return M(()=>e.project_id,a=>{e.client_ids=[],e.template_id=null,e.template_data={},Z(a)},{immediate:!0}),M(()=>e.template_id,a=>{e.template_data={};const s=y.value.find(t=>t.id===a);s&&(s.placeholders.forEach(t=>{t.is_repeatable?e.template_data[t.name]=[]:t.is_selectable?e.template_data[t.name]=null:e.template_data[t.name]=""}),J(s))},{immediate:!0}),X(()=>{q(),V.projectId||G()}),(a,s)=>(o(),n("div",le,[m("form",{onSubmit:ae(Q,["prevent"])},[m("div",oe,[V.projectId?p("",!0):(o(),n("div",ie,[c(w,{for:"project",value:"Select Project"}),c(L,{id:"project",modelValue:l(e).project_id,"onUpdate:modelValue":s[0]||(s[0]=t=>l(e).project_id=t),options:U.value,placeholder:"Select a project","value-key":"id","label-key":"name","allow-empty":!0,class:"mt-1"},null,8,["modelValue","options"]),S.value?(o(),n("div",ne," Loading projects... ")):p("",!0),c(x,{message:l(e).errors.project_id,class:"mt-2"},null,8,["message"])])),l(e).project_id?(o(),n("div",re,[c(w,{for:"client_ids",value:"To (Clients)"}),$.value?(o(),n("div",ce,"Loading clients...")):v.value?(o(),n("div",de,D(v.value),1)):(o(),k(O,{key:2,modelValue:l(e).client_ids,"onUpdate:modelValue":s[1]||(s[1]=t=>l(e).client_ids=t),options:E.value,placeholder:"Select one or more clients","label-key":"name","value-key":"id",class:"mt-1 block w-full"},null,8,["modelValue","options"])),c(x,{message:l(e).errors.client_ids,class:"mt-2"},null,8,["message"])])):p("",!0),l(e).project_id?(o(),n("div",me,[c(w,{for:"template-select",value:"Select Template"}),c(L,{id:"template-select",modelValue:l(e).template_id,"onUpdate:modelValue":s[2]||(s[2]=t=>l(e).template_id=t),options:z.value,placeholder:"Select a template","value-key":"value","label-key":"label","allow-empty":!1,class:"mt-1"},null,8,["modelValue","options"]),c(x,{message:l(e).errors.template_id,class:"mt-2"},null,8,["message"])])):p("",!0),l(e).template_id&&l(e).project_id?(o(),n("div",pe,[(o(!0),n(Y,null,ee(R.value,t=>(o(),n("div",{key:t.name},[c(w,{for:t.name,value:t.label||t.name},null,8,["for","value"]),t.is_repeatable?(o(),n("div",ue,[f.value?(o(),n("div",_e,"Loading options...")):(o(),k(O,{key:1,modelValue:l(e).template_data[t.name],"onUpdate:modelValue":i=>l(e).template_data[t.name]=i,options:_.value[t.name]||[],placeholder:`Select ${t.name}`,"label-key":"label","value-key":"id",class:"mt-1"},null,8,["modelValue","onUpdate:modelValue","options","placeholder"]))])):t.is_selectable?(o(),n("div",fe,[f.value?(o(),n("div",ve,"Loading options...")):(o(),k(L,{key:1,id:t.name,modelValue:l(e).template_data[t.name],"onUpdate:modelValue":i=>l(e).template_data[t.name]=i,options:_.value[t.name]||[],placeholder:`Select a ${t.name}`,"value-key":"id","label-key":"label",class:"mt-1 block w-full"},null,8,["id","modelValue","onUpdate:modelValue","options","placeholder"]))])):(o(),k(se,{key:2,id:t.name,modelValue:l(e).template_data[t.name],"onUpdate:modelValue":i=>l(e).template_data[t.name]=i,type:"text",class:"mt-1 block w-full",placeholder:`Enter a value for ${t.name}`},null,8,["id","modelValue","onUpdate:modelValue","placeholder"])),c(x,{message:l(e).errors[`template_data.${t.name}`],class:"mt-2"},null,8,["message"])]))),128))])):p("",!0),l(e).template_id?(o(),n("div",ye,[m("div",be,[s[3]||(s[3]=m("h4",{class:"text-md font-semibold text-gray-800"},"Email Preview",-1)),c(A,{onClick:K,disabled:g.value||!l(e).project_id||l(e).client_ids.length===0},{default:B(()=>[I(D(g.value?"Loading...":"Refresh Preview"),1)]),_:1},8,["disabled"])]),m("div",{class:"bg-gray-100 p-4 rounded-lg shadow-inner min-h-[300px]",innerHTML:b.value},null,8,ge)])):p("",!0)]),m("div",je,[c(A,{class:te({"opacity-25":l(e).processing}),disabled:l(e).processing||!l(e).project_id||l(e).client_ids.length===0},{default:B(()=>s[4]||(s[4]=[I(" Submit for Approval ",-1)])),_:1,__:[4]},8,["class","disabled"])])],32)]))}};export{Fe as default};
