import{p as P,z as K,r as d,s as B,A as Q,h as n,o as r,e as a,u as W,q as X,a as c,b as s,g as E,t as p,F as R,i as U,k as m,d as q,f as D,v as Z,c as ee,j as te}from"./app-C5dhlUiN.js";import{_ as se}from"./AuthenticatedLayout-DKPQWXUx.js";import{P as C}from"./PrimaryButton-DAvucddZ.js";import{a as S,_ as T}from"./SecondaryButton-BmPmG-1_.js";import{_ as w,a as L}from"./TextInput-KuNtvHVp.js";import{_ as j}from"./InputError-DOCuQf8z.js";import{R as oe}from"./RichTextEditor-BqktpB7V.js";import"./ApplicationLogo-CdSr8yep.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const ae={class:"py-12"},le={class:"max-w-7xl mx-auto sm:px-6 lg:px-8"},ie={class:"bg-white overflow-hidden shadow-sm sm:rounded-lg"},re={class:"p-6 text-gray-900"},ne={key:0,class:"bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4",role:"alert"},de={class:"block sm:inline"},ce={key:1,class:"text-gray-600"},ue={key:2,class:"text-red-600"},pe={key:3,class:"text-gray-600"},ve={key:4},me={class:"min-w-full divide-y divide-gray-200"},_e={class:"bg-white divide-y divide-gray-200"},fe={class:"px-6 py-4 whitespace-nowrap"},ge={class:"px-6 py-4 whitespace-nowrap"},xe={class:"px-6 py-4 truncate max-w-xs"},ye={class:"px-6 py-4 whitespace-nowrap"},be={class:"px-6 py-4 whitespace-nowrap"},we={class:"px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2"},je={class:"p-6"},he={key:0},ke={class:"mb-4"},Ee=["value"],Ce={class:"mb-4"},$e={class:"mb-4"},Ae={class:"mb-6"},Pe={class:"mt-6 flex justify-end space-x-2"},Re={class:"p-6"},Se={key:0},Ve={class:"mb-6"},Me={class:"mt-6 flex justify-end space-x-2"},Ie={__name:"PendingApprovals",setup(Fe){const V=P(()=>K().props.auth.user),$=d([]),h=d([]),M=d([]),A=d(!0),i=d(""),_=d(""),f=d(!1),g=d(!1),v=d(null),l=B({project_id:"",client_id:"",subject:"",body:""}),u=d({}),x=B({rejection_reason:""}),y=d({}),z=P(()=>V.value.role==="contractor"?h.value.filter(t=>t.users&&t.users.some(e=>e.id===V.value.id)):h.value),b=P(()=>{const t=h.value.find(e=>e.id===l.project_id);return t?M.value.find(e=>e.id===t.client_id):null}),O=t=>{if(!t||!t.to)return"";if(typeof t.to=="string")try{const e=JSON.parse(t.to);return Array.isArray(e)?e[0]||"":t.to}catch{return t.to}return""},k=async()=>{A.value=!0,i.value="";try{const[t,e,o]=await Promise.all([window.axios.get("/api/projects"),window.axios.get("/api/clients"),window.axios.get("/api/emails/pending-approval")]);h.value=t.data,M.value=e.data.data,$.value=o.data}catch(t){i.value="Failed to load data.",console.error("Error fetching initial data:",t),t.response&&(t.response.status===401||t.response.status===403)&&(i.value="You are not authorized to view this content or your session expired. Please log in.")}finally{A.value=!1}},I=t=>{v.value=t,l.project_id=t.conversation.project_id,l.client_id=t.conversation.client_id,l.subject=t.subject,l.body=t.body,u.value={},f.value=!0},J=async()=>{u.value={},i.value="";try{const t={project_id:l.project_id,client_id:l.client_id,subject:l.subject,body:l.body};await window.axios.post(`/api/emails/${v.value.id}/edit-and-approve`,t),_.value="Email updated and approved successfully!",f.value=!1,await k()}catch(t){t.response&&t.response.status===422?u.value=t.response.data.errors:t.response&&t.response.data.message?i.value=t.response.data.message:(i.value="Failed to update and approve email.",console.error("Error updating and approving email:",t))}},Y=async t=>{i.value="";try{await window.axios.post(`/api/emails/${t.id}/approve`),_.value="Email approved successfully!",await k()}catch(e){e.response&&e.response.data.message?i.value=e.response.data.message:(i.value="Failed to approve email.",console.error("Error approving email:",e))}},G=t=>{v.value=t,x.rejection_reason="",y.value={},g.value=!0},H=async()=>{y.value={},i.value="";try{await window.axios.post(`/api/emails/${v.value.id}/reject`,{rejection_reason:x.rejection_reason}),_.value="Email rejected successfully!",x.rejection_reason="",g.value=!1,await k()}catch(t){t.response&&t.response.status===422?y.value=t.response.data.errors:t.response&&t.response.data.message?i.value=t.response.data.message:(i.value="Failed to reject email.",console.error("Error rejecting email:",t))}};return Q(()=>{k()}),(t,e)=>(r(),n(R,null,[a(W(X),{title:"Pending Approvals"}),a(se,null,{header:c(()=>e[8]||(e[8]=[s("h2",{class:"font-semibold text-xl text-gray-800 leading-tight"},"Pending Email Approvals",-1)])),default:c(()=>[s("div",ae,[s("div",le,[s("div",ie,[s("div",re,[e[13]||(e[13]=s("h3",{class:"text-2xl font-bold mb-4"},"Emails Pending Approval",-1)),_.value?(r(),n("div",ne,[s("span",de,p(_.value),1)])):E("",!0),A.value?(r(),n("div",ce,"Loading pending emails...")):i.value?(r(),n("div",ue,p(i.value),1)):$.value.length===0?(r(),n("div",pe,"No pending emails found.")):(r(),n("div",ve,[s("table",me,[e[12]||(e[12]=s("thead",{class:"bg-gray-50"},[s("tr",null,[s("th",{scope:"col",class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"},"Project"),s("th",{scope:"col",class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"},"Client"),s("th",{scope:"col",class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"},"Subject"),s("th",{scope:"col",class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"},"Sender"),s("th",{scope:"col",class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"},"Submitted On"),s("th",{scope:"col",class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"},"Actions")])],-1)),s("tbody",_e,[(r(!0),n(R,null,U($.value,o=>{var F;return r(),n("tr",{key:o.id},[s("td",fe,p(o.conversation.project.name),1),s("td",ge,p(o.conversation.client.name),1),s("td",xe,p(o.subject),1),s("td",ye,p((F=o.sender)==null?void 0:F.name),1),s("td",be,p(new Date(o.created_at).toLocaleString()),1),s("td",we,[a(C,{onClick:N=>Y(o)},{default:c(()=>e[9]||(e[9]=[m("Approve")])),_:2,__:[9]},1032,["onClick"]),a(C,{onClick:N=>I(o)},{default:c(()=>e[10]||(e[10]=[m("Edit & Approve")])),_:2,__:[10]},1032,["onClick"]),a(S,{onClick:N=>G(o)},{default:c(()=>e[11]||(e[11]=[m("Reject")])),_:2,__:[11]},1032,["onClick"])])])}),128))])])]))])])])]),a(T,{show:f.value,onClose:e[4]||(e[4]=o=>f.value=!1),"max-width":"3xl"},{default:c(()=>[s("div",je,[e[17]||(e[17]=s("h2",{class:"text-2xl font-bold text-gray-900 mb-4"},"Edit and Approve Email",-1)),v.value?(r(),n("div",he,[s("form",{onSubmit:q(J,["prevent"])},[s("div",ke,[a(w,{for:"project_id",value:"Select Project"}),D(s("select",{id:"project_id",class:"border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 rounded-md shadow-sm mt-1 block w-full","onUpdate:modelValue":e[0]||(e[0]=o=>l.project_id=o),required:""},[e[14]||(e[14]=s("option",{value:"",disabled:""},"Select a Project",-1)),(r(!0),n(R,null,U(z.value,o=>(r(),n("option",{key:o.id,value:o.id},p(o.name)+" (Client: "+p(o.client&&o.client.name?o.client.name:"No Client Assigned")+") ",9,Ee))),128))],512),[[Z,l.project_id]]),a(j,{message:u.value.project_id?u.value.project_id[0]:"",class:"mt-2"},null,8,["message"])]),s("div",Ce,[a(w,{for:"to_client_email",value:"To (Client Email)"}),a(L,{id:"to_client_email",type:"email",class:"mt-1 block w-full bg-gray-100",value:b.value&&b.value.email?b.value.email:O(v.value),readonly:""},null,8,["value"]),(!b.value||!b.value.email)&&l.project_id?(r(),ee(j,{key:0,message:"Selected project has no client or client email is missing.",class:"mt-2"})):E("",!0)]),s("div",$e,[a(w,{for:"subject",value:"Subject"}),a(L,{id:"subject",type:"text",class:"mt-1 block w-full",modelValue:l.subject,"onUpdate:modelValue":e[1]||(e[1]=o=>l.subject=o),required:""},null,8,["modelValue"]),a(j,{message:u.value.subject?u.value.subject[0]:"",class:"mt-2"},null,8,["message"])]),s("div",Ae,[a(w,{for:"body",value:"Email Body"}),a(oe,{id:"body",modelValue:l.body,"onUpdate:modelValue":e[2]||(e[2]=o=>l.body=o),placeholder:"Edit your email here...",height:"300px"},null,8,["modelValue"]),a(j,{message:u.value.body?u.value.body[0]:"",class:"mt-2"},null,8,["message"])]),s("div",Pe,[a(S,{onClick:e[3]||(e[3]=o=>f.value=!1)},{default:c(()=>e[15]||(e[15]=[m("Cancel")])),_:1,__:[15]}),a(C,{type:"submit"},{default:c(()=>e[16]||(e[16]=[m("Save & Approve")])),_:1,__:[16]})])],32)])):E("",!0)])]),_:1},8,["show"]),a(T,{show:g.value,onClose:e[7]||(e[7]=o=>g.value=!1),"max-width":"2xl"},{default:c(()=>[s("div",Re,[e[20]||(e[20]=s("h2",{class:"text-2xl font-bold text-gray-900 mb-4"},"Reject Email",-1)),v.value?(r(),n("div",Se,[s("form",{onSubmit:q(H,["prevent"])},[s("div",Ve,[a(w,{for:"rejection_reason",value:"Rejection Reason"}),D(s("textarea",{id:"rejection_reason",rows:"5",class:"border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 rounded-md shadow-sm mt-1 block w-full","onUpdate:modelValue":e[5]||(e[5]=o=>x.rejection_reason=o),required:"",placeholder:"Please provide a reason for rejecting this email (minimum 10 characters)"},null,512),[[te,x.rejection_reason]]),a(j,{message:y.value.rejection_reason?y.value.rejection_reason[0]:"",class:"mt-2"},null,8,["message"])]),s("div",Me,[a(S,{onClick:e[6]||(e[6]=o=>g.value=!1)},{default:c(()=>e[18]||(e[18]=[m("Cancel")])),_:1,__:[18]}),a(C,{type:"submit",class:"bg-red-600 hover:bg-red-700"},{default:c(()=>e[19]||(e[19]=[m("Reject Email")])),_:1,__:[19]})])],32)])):E("",!0)])]),_:1},8,["show"])]),_:1})],64))}};export{Ie as default};
