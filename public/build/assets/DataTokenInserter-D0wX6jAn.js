import{u as z}from"./workflowStore-DOdgr6Xd.js";import{r as L,b as U,d as G,l as N,c as A,o as y,a as C,q as V,k as X,j as W,f as q,v as Y,F as M,i as j,t as H,T as J,p as K}from"./app-BfaUIa5i.js";const Q=["disabled"],Z={class:"p-2 border-b"},ee={class:"px-3 py-1.5 text-[11px] font-semibold uppercase tracking-wide text-gray-500 bg-gray-50"},te=["onClick"],ne={key:1,class:"px-3 py-2 text-xs text-gray-500"},ae={__name:"DataTokenPicker",props:{groups:{type:Array,default:()=>[]},placeholder:{type:String,default:""},disabled:{type:Boolean,default:!1},maxHeight:{type:String,default:"300px"},minWidth:{type:[String,Number],default:320},maxPanelWidth:{type:[String,Number],default:480}},emits:["select"],setup(R,{emit:D}){const p=R,P=D,v=L(!1),b=L(null),E=L(null),x=L({top:0,left:0,width:0}),T=L(""),I=l=>{if(typeof l=="number")return l;const o=parseInt(String(l).replace("px",""));return isNaN(o)?0:o};function n(){p.disabled||(v.value=!v.value,K(()=>u()))}function u(){const l=b.value;if(!l)return;const o=l.getBoundingClientRect(),e=8,t=window.innerWidth||document.documentElement.clientWidth,i=Math.max(o.width,I(p.minWidth)),$=Math.min(I(p.maxPanelWidth),t-e*2),h=Math.min(Math.max(i,I(p.minWidth)),$);let a=o.left+window.scrollX;a+h+e>t+window.scrollX&&(a=t+window.scrollX-h-e,a<e&&(a=e)),x.value={top:o.bottom+window.scrollY,left:a,width:h}}function f(){v.value&&u()}function g(l){const o=b.value&&b.value.contains(l.target),e=E.value&&E.value.contains(l.target);!o&&!e&&(v.value=!1)}U(()=>{window.addEventListener("scroll",f,!0),window.addEventListener("resize",f),document.addEventListener("click",g)}),G(()=>{window.removeEventListener("scroll",f,!0),window.removeEventListener("resize",f),document.removeEventListener("click",g)}),N(()=>{const l=[];return(p.groups||[]).forEach((o,e)=>{(o.fields||[]).forEach((t,i)=>{l.push({groupIndex:e,itemIndex:i,group:o.name||"Data",label:t.label,value:t.value})})}),l});const k=N(()=>{const l=T.value.trim().toLowerCase();if(!l)return p.groups;const o=[];return(p.groups||[]).forEach(e=>{const t=(e.fields||[]).filter(i=>String(i.label||"").toLowerCase().includes(l));t.length&&o.push({name:e.name,fields:t})}),o});function F(l){P("select",l),v.value=!1}return(l,o)=>(y(),A("div",{class:"relative inline-block",ref_key:"triggerRef",ref:b},[C("button",{type:"button",onClick:n,disabled:R.disabled,"aria-label":"Insert data",class:"inline-flex items-center justify-center rounded-full border border-gray-300 bg-white p-1.5 text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-60"},o[1]||(o[1]=[C("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-4 w-4",viewBox:"0 0 20 20",fill:"currentColor"},[C("path",{"fill-rule":"evenodd",d:"M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z","clip-rule":"evenodd"})],-1)]),8,Q),(y(),V(J,{to:"body"},[v.value?(y(),A("div",{key:0,ref_key:"portalRef",ref:E,class:"fixed z-[9999] bg-white rounded-md shadow-xl ring-1 ring-black ring-opacity-5",style:W({top:x.value.top+"px",left:x.value.left+"px",width:x.value.width+"px",maxWidth:"min(480px, 96vw)"})},[C("div",Z,[q(C("input",{type:"text","onUpdate:modelValue":o[0]||(o[0]=e=>T.value=e),placeholder:"Search fields...",class:"w-full border border-gray-200 rounded px-2 py-1 text-xs focus:ring-indigo-500 focus:border-indigo-500"},null,512),[[Y,T.value]])]),C("div",{class:"max-h-[calc(100vh-180px)] overflow-auto",style:W({maxHeight:R.maxHeight})},[k.value&&k.value.length?(y(!0),A(M,{key:0},j(k.value,e=>(y(),A("div",{key:e.name,class:"py-1"},[C("div",ee,H(e.name),1),(y(!0),A(M,null,j(e.fields||[],t=>(y(),A("button",{key:t.value,type:"button",class:"w-full text-left px-3 py-2 text-sm hover:bg-gray-50",onClick:i=>F(t.value)},H(t.label),9,te))),128))]))),128)):(y(),A("div",ne,"No data available"))],4)],4)):X("",!0)]))],512))}},re={__name:"DataTokenInserter",props:{allStepsBefore:{type:Array,default:()=>[]},loopContextSchema:{type:Object,default:null},inferLoopFromNearest:{type:Boolean,default:!0}},emits:["insert"],setup(R,{emit:D}){const p=R,P=D,v=z(),b=N(()=>v.automationSchema||[]);function E(n){if(!n||typeof n!="string")return"";let u=n.toLowerCase();if(u==="id")return"ID";u.endsWith("_id")&&(u=u.slice(0,-3)),u=u.replace(/[_-]+/g," ");let f=u.replace(/\b\w/g,g=>g.toUpperCase());return f=f.replace(/\bId\b/g,"ID").replace(/\bUrl\b/g,"URL"),f}const x=N(()=>{var k,F,l,o;const n=[];let u=p.loopContextSchema;const f=e=>{const t=String((e==null?void 0:e.type)||"").toLowerCase(),i=String((e==null?void 0:e.itemType)||"").toLowerCase();return t==="array of objects"||t==="array"&&i==="object"};if(!u&&p.inferLoopFromNearest){const e=[...p.allStepsBefore].reverse().find(t=>{var i;return t.step_type==="FOR_EACH"&&((i=t.step_config)==null?void 0:i.sourceArray)});if(e){const t=e.step_config.sourceArray,i=typeof t=="string"?t.match(/{{step_(\w+)\.(.+)}}/):null;if(i){const $=i[1],h=i[2],a=p.allStepsBefore.find(_=>String(_.id)===String($)),O=h.replace(/^parsed\./,"");if((a==null?void 0:a.step_type)==="AI_PROMPT"||(a==null?void 0:a.step_type)==="ACTION"&&((k=a==null?void 0:a.step_config)==null?void 0:k.action_type)==="FETCH_API_DATA"){const _=(((F=a.step_config)==null?void 0:F.responseStructure)||[]).find(s=>s.name===O);f(_)&&(u={name:"Loop Item",columns:_.schema||[]})}if(!u&&(a==null?void 0:a.step_type)==="FETCH_RECORDS"&&h==="records"){const _=(l=a.step_config)==null?void 0:l.model,s=b.value.find(c=>c.name===_);s&&(u={name:"Loop Item",columns:(s.columns||[]).map(m=>typeof m=="string"?{name:m}:m)})}}}}u&&Array.isArray(u.columns)&&(n.push({name:"Current Loop Item (from For Each)",fields:u.columns.filter(e=>!!(e&&e.name)).map(e=>({label:e.name,value:`{{loop.item.${e.name}}}`}))}),n.push({name:"Loop Details",fields:[{label:"index",value:"{{loop.index}}"},{label:"is_first",value:"{{loop.is_first}}"},{label:"is_last",value:"{{loop.is_last}}"}]}));const g=p.allStepsBefore.find(e=>e.step_type==="TRIGGER");if(g&&((o=g.step_config)!=null&&o.model)){const e=b.value.find(t=>t.name===g.step_config.model);e&&n.push({name:`Trigger: ${g.step_config.model}`,fields:e.columns.map(t=>{const i=typeof t=="string"?t:t.name||"";return{label:typeof t=="string"?E(t):t.label||t.name||"",value:`{{trigger.${g.step_config.model.toLowerCase()}.${i}}}`}})})}return p.allStepsBefore.forEach((e,t)=>{var i,$,h,a,O,_;if(e.step_type==="AI_PROMPT"&&(($=(i=e.step_config)==null?void 0:i.responseStructure)==null?void 0:$.length)>0){const s=[],c=(m,w="",d=0)=>{(m||[]).forEach(r=>{if(!(r!=null&&r.name))return;const S=w?`${w}.${r.name}`:r.name,B="  ".repeat(d);s.push({label:`${B}${r.name}`,value:`{{step_${e.id}.${S}}}`}),Array.isArray(r.schema)&&r.type==="Object"&&c(r.schema,S,d+1)})};c(e.step_config.responseStructure),n.push({name:`Step ${t+1}: AI Response`,fields:s})}if(e.step_type==="FETCH_RECORDS"){const s=[{label:"records (array)",value:`{{step_${e.id}.records}}`},{label:"count",value:`{{step_${e.id}.count}}`}],c=e.step_config&&e.step_config.model?e.step_config.model:null,m=`Step ${t+1}: Fetch Records`+(c?` — ${c}`:"");if(e.step_config&&e.step_config.single&&c){const w=b.value.find(d=>d.name===c);w&&(w.columns||[]).forEach(d=>{const r=typeof d=="string"?d:d.name||"",S=typeof d=="string"?E(d):d.label||d.name||"";r&&s.push({label:`record.${S}`,value:`{{step_${e.id}.record.${r}}}`})}),s.push({label:"record (object)",value:`{{step_${e.id}.record}}`})}n.push({name:m,fields:s})}if(e.step_type==="TRANSFORM_CONTENT"){const s=[{label:"cleaned_body",value:`{{step_${e.id}.cleaned_body}}`},{label:"result",value:`{{step_${e.id}.result}}`}];n.push({name:`Step ${t+1}: Transformed Content`,fields:s})}if(e.step_type==="ACTION"&&e.step_config&&e.step_config.action_type==="CREATE_RECORD"){const s=e.step_config.target_model||"",c=`Step ${t+1}: Create Record`+(s?` — ${s}`:""),m=[{label:"new_record_id",value:`{{step_${e.id}.new_record_id}}`},{label:"id (legacy)",value:`{{step_${e.id}.id}}`}];n.push({name:c,fields:m})}if(e.step_type==="DEFINE_VARIABLE"&&Array.isArray((h=e.step_config)==null?void 0:h.variables)){const s=e.step_config.variables.filter(c=>!!c.name).map(c=>({label:c.name,value:`{{step_${e.id}.${c.name}}}`}));s.length>0&&n.push({name:`Step ${t+1}: Defined Variables`,fields:s})}if(e.step_type==="ACTION"&&((a=e.step_config)==null?void 0:a.action_type)==="FETCH_API_DATA"&&((_=(O=e.step_config)==null?void 0:O.responseStructure)==null?void 0:_.length)>0){const s=[],c=(m,w="",d=0)=>{(m||[]).forEach(r=>{if(!(r!=null&&r.name))return;const S=w?`${w}.${r.name}`:r.name,B="  ".repeat(d);s.push({label:`${B}${r.name}`,value:`{{step_${e.id}.${S}}}`}),Array.isArray(r.schema)&&r.type==="Object"&&c(r.schema,S,d+1)})};c(e.step_config.responseStructure),n.push({name:`Step ${t+1}: API Response`,fields:s})}}),n}),T=N(()=>x.value.some(n=>Array.isArray(n.fields)&&n.fields.length>0));function I(n){n&&P("insert",n)}return(n,u)=>(y(),V(ae,{groups:x.value,disabled:!T.value,onSelect:I},null,8,["groups","disabled"]))}};export{re as default};
