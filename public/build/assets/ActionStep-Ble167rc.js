import{u as de}from"./workflowStore-CwnCX0-l.js";import ce from"./StepCard-D-wvFQZv.js";import x from"./DataTokenInserter-DjuovE1r.js";import{S as K}from"./SelectDropdown-C0bIEcrS.js";import{c as b,r as W,e as H,f as me,g as z,o as r,w as pe,b as s,a as u,i as d,F as f,l as k,t as p,d as v,u as P,m as Y,j as ve,p as fe}from"./app-DDhvGD51.js";import{_ as ye}from"./RelationshipPathPicker-CJ7FMlR-.js";import{c as ge}from"./createLucideIcon-Cxptu_AU.js";import{P as be}from"./plus-DG_BxV1V.js";import{T as xe}from"./trash-CDFETcX2.js";/* empty css                                                                       */import"./_plugin-vue_export-helper-DlAUqK2U.js";/**
 * @license lucide-vue-next v0.536.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const he=ge("clock",[["path",{d:"M12 6v6l4 2",key:"mmk7yg"}],["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]),_e=["value"],Ce=["value"],ke={class:"mt-2 flex items-center gap-2 text-xs text-gray-600"},we={key:0,class:"flex items-center gap-2"},Se=["value"],Ae={key:0,class:"space-y-4 mt-4 border-t pt-4"},Ie={class:"flex items-center gap-2"},Ee=["value"],Re={class:"flex items-center gap-2"},De=["value"],Me={class:"relative"},Te=["value"],Oe={class:"absolute top-2 right-2"},Fe={class:"block text-xs font-medium text-gray-600 mb-1"},Pe={key:0},Be={class:"flex items-center gap-2"},qe=["value"],Le={class:"flex items-center justify-between mb-2"},Ne={key:0,class:"mb-2 text-[11px]"},Ue={class:"text-gray-600"},$e={class:"px-1.5 py-0.5 rounded bg-amber-50 border border-amber-200 text-amber-700"},Ve={key:0},je={key:0,class:"mt-1 text-red-600"},Ke={key:1,class:"space-y-2"},We={class:"flex items-center justify-between gap-2"},He={class:"flex-1 flex items-center gap-2"},ze=["value","onChange","disabled"],Ye=["value"],Ge={key:0,class:"text-[10px] px-1.5 py-0.5 rounded bg-amber-50 border border-amber-200 text-amber-700"},Je=["onClick","title"],Qe={class:"flex items-center gap-2 mt-2"},Xe=["value","onChange"],Ze=["value"],et=["value","onInput"],tt=["value","onInput"],lt={class:"mt-1 text-[14px] text-gray-500"},ot={key:0,class:"mt-1 text-[11px] text-gray-500"},st={class:"flex items-center gap-2"},nt=["value"],at={key:0},rt=["value"],ut=["value"],it={key:0,class:"mt-1 text-[11px] text-gray-500"},dt={key:1},ct=["value"],mt={key:2},pt={class:"flex items-center gap-2"},vt=["value"],ft={key:3,class:"p-3 bg-blue-50 border-l-4 border-blue-400 text-blue-800 text-sm rounded-r-md"},It={__name:"ActionStep",props:{step:{type:Object,required:!0},allStepsBefore:{type:Array,default:()=>[]},loopContextSchema:{type:Object,default:null}},emits:["update:step","delete"],setup(c,{emit:G}){const E=c,M=G,J=de(),w=b(()=>J.automationSchema||[]),S=W({});function B(l,e){return`${l||""}:${e||""}`}async function R(l,e){if(!l||!e)return null;const t=B(l,e);if(Array.isArray(S.value[t])&&S.value[t].length)return S.value[t];try{const{data:o}=await fe.get(`/api/value-dictionaries/${encodeURIComponent(l)}/${encodeURIComponent(e)}`);let i=null;if(Array.isArray(o)?i=o:o&&Array.isArray(o.values)&&(i=o.values),Array.isArray(i)&&i.length)return S.value[t]=i,i}catch{}return null}const Q=[{value:"SEND_EMAIL",label:"Send Email"},{value:"PROCESS_EMAIL",label:"Process Email"},{value:"CREATE_RECORD",label:"Create Record"},{value:"UPDATE_RECORD",label:"Update Record"},{value:"SYNC_RELATIONSHIP",label:"Sync Relationship"},{value:"CHECK_MILESTONE_COMPLETION",label:"Check for Milestone Completion & Update"}],n=b({get:()=>E.step.step_config||{},set:l=>M("update:step",{...E.step,step_config:l})});function m(l,e){n.value={...n.value,[l]:e}}function X(l){n.value={action_type:l}}function h(l,e){const t=n.value[l]||"";m(l,`${t}${e}`)}b(()=>w.value.map(l=>l.name));const q=b(()=>(w.value||[]).map(l=>({label:l.name,value:l.name})));function A(l){if(!l||typeof l!="string")return"";let e=l.toLowerCase();if(e==="id")return"ID";e.endsWith("_id")&&(e=e.slice(0,-3)),e=e.replace(/[_-]+/g," ");let t=e.replace(/\b\w/g,o=>o.toUpperCase());return t=t.replace(/\bId\b/g,"ID").replace(/\bUrl\b/g,"URL"),t}const I=b(()=>{const l=n.value.target_model;if(!l)return null;let e=(w.value||[]).find(o=>o.name===l);if(e||(e=(w.value||[]).find(o=>o.full_class===l),e))return e;const t=typeof l=="string"?l.split("\\").pop().split("/").pop():l;return(w.value||[]).find(o=>o.name===t)||null}),D=b(()=>{const l=I.value;return l?(l.columns||[]).map(e=>typeof e=="string"?{name:e,label:A(e),is_required:!1,allowed_values:null,description:null,ui:null}:{name:e.name,label:e.label||A(e.name),is_required:!!e.is_required,allowed_values:e.allowed_values??null,description:e.description||null,ui:e.ui||null}):[]});function T(l){return D.value.find(e=>e.name===l)||null}function L(l){return typeof l=="string"&&l.endsWith("_type")}function Z(l){return typeof l=="string"&&l.endsWith("_id")}function ee(l){const e=T(l.column);return Z(l.column)||L(l.column)&&((e==null?void 0:e.ui)==="morph_type"||Array.isArray(e==null?void 0:e.allowed_values))}function te(l){return L(l.column)?"type":"id"}const _=b(()=>{var l;return((l=I.value)==null?void 0:l.required_on_create)||[]}),le=b(()=>{var l;return((l=I.value)==null?void 0:l.defaults_on_create)||{}});function N(l){return _.value.includes(l)}function oe(l){const e=le.value||{},t=n.value.target_model,i=`{{trigger.${t?t.toLowerCase():""}.${l}}}`,a=(()=>{const g=(D.value||[]).find(ie=>ie.name===l);return!!(g&&Array.isArray(g.allowed_values)&&g.allowed_values.length>0)})();return n.value.action_type==="CREATE_RECORD"&&a?"":e[l]!==void 0&&e[l]!==null||l.endsWith("_id")?i:""}function U(){const l=_.value||[];if(!l.length)return;const e=Array.isArray(n.value.fields)?[...n.value.fields]:[],t=new Map;e.forEach(a=>{const y=a.column||a.field||a.name;y&&t.set(y,!0)});const o=[];for(const a of l)t.has(a)||o.push({column:a,value:oe(a)});o.length&&m("fields",[...e,...o]);const i=n.value.target_model;if(i)for(const a of l)R(i,a)}function $(l){m("target_model",l),U()}H(()=>n.value.target_model,async(l,e)=>{if(l&&l!==e){U();const t=Array.isArray(n.value.fields)?n.value.fields:[];for(const o of t){const i=(o==null?void 0:o.column)||(o==null?void 0:o.field)||(o==null?void 0:o.name);i&&await R(l,i)}}}),H(()=>n.value.fields,async l=>{const e=n.value.target_model;if(!(!e||!Array.isArray(l)))for(const t of l){const o=(t==null?void 0:t.column)||(t==null?void 0:t.field)||(t==null?void 0:t.name);o&&await R(e,o)}},{deep:!0,immediate:!0}),me(async()=>{const l=n.value.target_model,e=Array.isArray(n.value.fields)?n.value.fields:[];if(l)for(const t of e){const o=(t==null?void 0:t.column)||(t==null?void 0:t.field)||(t==null?void 0:t.name);o&&await R(l,o)}});function se(){const l=n.value.fields||[];m("fields",[...l,{column:"",value:""}])}function ne(l){const e=n.value.fields||[];m("fields",e.filter((t,o)=>o!==l))}function C(l,e,t){const i=[...n.value.fields||[]];i[l]={...i[l],[e]:t},m("fields",i)}function ae(l,e){const o=(n.value.fields||[])[l].value||"";C(l,"value",o+e)}function V(l){var y;const e=n.value.target_model;if(!e||!l)return null;const t=l.column||l.field||l.name;if(!t)return null;const o=(y=(D.value||[]).find(g=>g.name===t))==null?void 0:y.allowed_values;if(Array.isArray(o)&&o.length)return o;const i=B(e,t),a=S.value[i];return Array.isArray(a)&&a.length?a:null}function re(l){const e=V(l);return!(!e||!e.length||(l.value||"").toString().includes("{{"))}const j=b(()=>{const l=_.value||[];if(!l.length)return[];const e=new Map;return(Array.isArray(n.value.fields)?n.value.fields:[]).forEach(o=>{const i=o.column||o.field||o.name,a=(o.value??"").toString().trim();i&&a&&e.set(i,!0)}),l.filter(o=>!e.has(o))});function O(l){var i,a,y;const e=Array.isArray(n.value.fields)?n.value.fields:[],t=((i=e[l])==null?void 0:i.column)||((a=e[l])==null?void 0:a.field)||((y=e[l])==null?void 0:y.name);return!t||!N(t)?!0:e.filter(g=>(g.column||g.field||g.name)===t).length>1}const F=W(!1);function ue(l){const e=Math.max(0,parseInt(l??0,10)||0);M("update:step",{...E.step,delay_minutes:e})}return(l,e)=>(r(),z(ce,{icon:"⚙️",title:"Perform an Action",onDelete:()=>M("delete")},{default:pe(()=>[s("select",{value:n.value.action_type||"",onChange:e[0]||(e[0]=t=>X(t.target.value)),class:"p-2 border border-gray-300 rounded-md bg-white shadow-sm w-full text-sm"},[e[17]||(e[17]=s("option",{value:"",disabled:""},"Select an action...",-1)),(r(),u(f,null,k(Q,t=>s("option",{key:t.value,value:t.value},p(t.label),9,Ce)),64))],40,_e),s("div",ke,[s("button",{type:"button",onClick:e[1]||(e[1]=t=>F.value=!F.value),class:"p-1.5 rounded-md border text-gray-600 hover:bg-gray-50",title:"Set delay (minutes)"},[v(P(he),{class:"w-4 h-4"})]),F.value?(r(),u("div",we,[e[18]||(e[18]=s("label",null,"Delay",-1)),s("input",{type:"number",min:"0",value:E.step.delay_minutes||0,onInput:e[2]||(e[2]=t=>ue(t.target.value)),class:"w-20 p-1 border rounded"},null,40,Se),e[19]||(e[19]=s("span",null,"minutes",-1))])):d("",!0)]),n.value.action_type?(r(),u("div",Ae,[n.value.action_type==="SEND_EMAIL"?(r(),u(f,{key:0},[s("div",null,[e[20]||(e[20]=s("label",{class:"block text-xs font-medium text-gray-600 mb-1"},"To",-1)),s("div",Ie,[s("input",{type:"text",value:n.value.to||"",onInput:e[3]||(e[3]=t=>m("to",t.target.value)),class:"w-full p-2 border border-gray-300 rounded-md text-sm",placeholder:"e.g., {{trigger.email.sender}}"},null,40,Ee),v(x,{"all-steps-before":c.allStepsBefore,"loop-context-schema":c.loopContextSchema,onInsert:e[4]||(e[4]=t=>h("to",t))},null,8,["all-steps-before","loop-context-schema"])])]),s("div",null,[e[21]||(e[21]=s("label",{class:"block text-xs font-medium text-gray-600 mb-1"},"Subject",-1)),s("div",Re,[s("input",{type:"text",value:n.value.subject||"",onInput:e[5]||(e[5]=t=>m("subject",t.target.value)),class:"w-full p-2 border border-gray-300 rounded-md text-sm",placeholder:"e.g., AI says: {{step_2.category}}"},null,40,De),v(x,{"all-steps-before":c.allStepsBefore,"loop-context-schema":c.loopContextSchema,onInsert:e[6]||(e[6]=t=>h("subject",t))},null,8,["all-steps-before","loop-context-schema"])])]),s("div",null,[e[22]||(e[22]=s("label",{class:"block text-xs font-medium text-gray-600 mb-1"},"Body",-1)),s("div",Me,[s("textarea",{rows:"5",value:n.value.body||"",onInput:e[7]||(e[7]=t=>m("body",t.target.value)),class:"w-full p-2 border border-gray-300 rounded-md text-sm"},null,40,Te),s("div",Oe,[v(x,{"all-steps-before":c.allStepsBefore,"loop-context-schema":c.loopContextSchema,onInsert:e[8]||(e[8]=t=>h("body",t))},null,8,["all-steps-before","loop-context-schema"])])])])],64)):d("",!0),n.value.action_type==="CREATE_RECORD"||n.value.action_type==="UPDATE_RECORD"?(r(),u(f,{key:1},[s("div",null,[s("label",Fe,p(n.value.action_type==="CREATE_RECORD"?"Model to Create":"Model to Update"),1),v(K,{"model-value":n.value.target_model||"",options:q.value,placeholder:"Select model...","onUpdate:modelValue":$,class:"w-full"},null,8,["model-value","options"])]),n.value.action_type==="UPDATE_RECORD"?(r(),u("div",Pe,[e[23]||(e[23]=s("label",{class:"block text-xs font-medium text-gray-600 mb-1"},"Record ID",-1)),s("div",Be,[s("input",{type:"text",value:n.value.record_id||"",onInput:e[9]||(e[9]=t=>m("record_id",t.target.value)),class:"w-full p-2 border border-gray-300 rounded-md text-sm",placeholder:"e.g., {{trigger.task.id}}"},null,40,qe),v(x,{"all-steps-before":c.allStepsBefore,"loop-context-schema":c.loopContextSchema,onInsert:e[10]||(e[10]=t=>h("record_id",t))},null,8,["all-steps-before","loop-context-schema"])])])):d("",!0),s("div",null,[s("div",Le,[e[25]||(e[25]=s("label",{class:"text-xs font-medium text-gray-600"},"Fields to set",-1)),s("button",{onClick:se,class:"flex items-center gap-1 px-2 py-1 text-xs rounded-md bg-gray-100 hover:bg-gray-200"},[v(P(be),{class:"h-3 w-3"}),e[24]||(e[24]=Y(" Add ",-1))])]),_.value.length?(r(),u("div",Ne,[s("span",Ue,"Required for "+p(n.value.target_model)+":",1),(r(!0),u(f,null,k(_.value,(t,o)=>(r(),u("span",{class:"ml-1",key:t},[s("span",$e,p(A(t)),1),o<_.value.length-1?(r(),u("span",Ve,", ")):d("",!0)]))),128)),j.value.length?(r(),u("div",je,"Missing: "+p(j.value.map(A).join(", ")),1)):d("",!0)])):d("",!0),n.value.fields&&n.value.fields.length>0?(r(),u("div",Ke,[(r(!0),u(f,null,k(n.value.fields,(t,o)=>{var i;return r(),u("div",{key:o,class:"p-2 border rounded-md bg-gray-50/50"},[s("div",We,[s("div",He,[s("select",{value:t.column,onChange:a=>C(o,"column",a.target.value),class:"w-full p-2 border border-gray-300 rounded-md text-sm",disabled:!n.value.target_model},[e[26]||(e[26]=s("option",{value:"",disabled:""},"Field...",-1)),(r(!0),u(f,null,k(D.value,a=>(r(),u("option",{key:a.name,value:a.name},p(a.label),9,Ye))),128))],40,ze),N(t.column)?(r(),u("span",Ge,"Required")):d("",!0)]),s("button",{onClick:a=>O(o)&&ne(o),class:ve([[O(o)?"text-gray-400 hover:text-red-500 hover:bg-red-50":"text-gray-300 cursor-not-allowed"],"p-1 rounded-full"]),title:O(o)?"Remove Field":"Cannot remove required field"},[v(P(xe),{class:"w-4 h-4"})],10,Je)]),s("div",Qe,[n.value.target_model?(r(),u(f,{key:0},[re(t)?(r(),u("select",{key:0,value:t.value||"",onChange:a=>C(o,"value",a.target.value),class:"w-full p-2 border border-gray-300 rounded-md text-sm"},[e[27]||(e[27]=s("option",{value:"",disabled:""},"Select value...",-1)),(r(!0),u(f,null,k(V(t)||[],a=>(r(),u("option",{key:a.value,value:a.value},p(a.label??a.value),9,Ze))),128))],40,Xe)):(r(),u("input",{key:1,value:t.value,onInput:a=>C(o,"value",a.target.value),type:"text",class:"w-full border rounded px-2 py-2 text-sm",placeholder:"Value..."},null,40,et))],64)):(r(),u("input",{key:1,value:t.value,onInput:a=>C(o,"value",a.target.value),type:"text",class:"w-full border rounded px-2 py-2 text-sm",placeholder:"Value..."},null,40,tt)),v(x,{"all-steps-before":c.allStepsBefore,"loop-context-schema":c.loopContextSchema,onInsert:a=>ae(o,a)},null,8,["all-steps-before","loop-context-schema","onInsert"]),ee(t)?(r(),z(ye,{key:2,mode:te(t),"all-steps-before":c.allStepsBefore,value:t.value,onSelect:a=>C(o,"value",a)},null,8,["mode","all-steps-before","value","onSelect"])):d("",!0)]),s("p",lt,[e[28]||(e[28]=Y("Selected Relationship: ",-1)),s("strong",null,p(t.value),1)]),(i=T(t.column))!=null&&i.description?(r(),u("p",ot,p(T(t.column).description),1)):d("",!0)])}),128))])):d("",!0)])],64)):d("",!0),n.value.action_type==="SYNC_RELATIONSHIP"?(r(),u(f,{key:2},[s("div",null,[e[29]||(e[29]=s("label",{class:"block text-xs font-medium text-gray-600 mb-1"},"Target Model",-1)),v(K,{"model-value":n.value.target_model||"",options:q.value,placeholder:"Select model...","onUpdate:modelValue":$,class:"w-full"},null,8,["model-value","options"])]),s("div",null,[e[30]||(e[30]=s("label",{class:"block text-xs font-medium text-gray-600 mb-1"},"Record ID",-1)),s("div",st,[s("input",{type:"text",value:n.value.record_id||"",onInput:e[11]||(e[11]=t=>m("record_id",t.target.value)),class:"w-full p-2 border border-gray-300 rounded-md text-sm",placeholder:"e.g., {{trigger.task.id}}"},null,40,nt),v(x,{"all-steps-before":c.allStepsBefore,"loop-context-schema":c.loopContextSchema,onInsert:e[12]||(e[12]=t=>h("record_id",t))},null,8,["all-steps-before","loop-context-schema"])])]),I.value?(r(),u("div",at,[e[32]||(e[32]=s("label",{class:"block text-xs font-medium text-gray-600 mb-1"},"Relationship",-1)),s("select",{value:n.value.relationship||"",onChange:e[13]||(e[13]=t=>m("relationship",t.target.value)),class:"w-full p-2 border border-gray-300 rounded-md text-sm bg-white shadow-sm"},[e[31]||(e[31]=s("option",{value:"",disabled:""},"Select relationship...",-1)),(r(!0),u(f,null,k(I.value.relationships.filter(t=>["BelongsToMany","MorphToMany"].includes(t.type)),t=>(r(),u("option",{key:t.name,value:t.name},p(A(t.name))+" ("+p(t.type)+") ",9,ut))),128))],40,rt),n.value.relationship?(r(),u("p",it,' This will sync the many-to-many relationship "'+p(n.value.relationship)+'" on the selected '+p(n.value.target_model)+" record. ",1)):d("",!0)])):d("",!0),n.value.relationship?(r(),u("div",dt,[e[34]||(e[34]=s("label",{class:"block text-xs font-medium text-gray-600 mb-1"},"Sync Mode",-1)),s("select",{value:n.value.sync_mode||"sync",onChange:e[14]||(e[14]=t=>m("sync_mode",t.target.value)),class:"w-full p-2 border border-gray-300 rounded-md text-sm bg-white shadow-sm"},e[33]||(e[33]=[s("option",{value:"sync"},"Sync (Replace all with new IDs)",-1),s("option",{value:"attach"},"Attach (Add new IDs without removing existing)",-1),s("option",{value:"detach"},"Detach (Remove specified IDs)",-1)]),40,ct)])):d("",!0),n.value.relationship?(r(),u("div",mt,[e[35]||(e[35]=s("label",{class:"block text-xs font-medium text-gray-600 mb-1"},"Related Record IDs",-1)),s("div",pt,[s("input",{type:"text",value:n.value.related_ids||"",onInput:e[15]||(e[15]=t=>m("related_ids",t.target.value)),class:"w-full p-2 border border-gray-300 rounded-md text-sm",placeholder:"e.g., {{step_1.category_ids}} or 1,2,3"},null,40,vt),v(x,{"all-steps-before":c.allStepsBefore,"loop-context-schema":c.loopContextSchema,onInsert:e[16]||(e[16]=t=>h("related_ids",t))},null,8,["all-steps-before","loop-context-schema"])]),e[36]||(e[36]=s("p",{class:"mt-1 text-[11px] text-gray-500"}," Comma-separated list of IDs to sync/attach/detach. Can use tokens from previous steps. ",-1))])):d("",!0)],64)):d("",!0),n.value.action_type==="CHECK_MILESTONE_COMPLETION"?(r(),u("div",ft,e[37]||(e[37]=[s("p",{class:"font-semibold"},"This is a smart action.",-1),s("p",null,"It will automatically use the context from the trigger to check if all tasks in the milestone are complete. If so, it will mark the milestone as completed.",-1)]))):d("",!0)])):d("",!0)]),_:1},8,["onDelete"]))}};export{It as default};
