import{u as ue}from"./workflowStore-DRHLjFWB.js";import me from"./StepCard-jOqKdasI.js";import{_ as pe,a as ce}from"./RelatedDataPicker-9hfkthT0.js";import{B as de}from"./BaseFormModal-DV79F91Q.js";import ve from"./PromptForm-BCXG6NUr.js";import{S as fe}from"./SelectDropdown-DkHSCcqm.js";import ge from"./DataTokenInserter-CEJ56sw8.js";import{C as ye}from"./circle-x-Zc1grOVA.js";import{c as l,e as X,f as he,r as T,a as r,o as n,d as x,w as K,b as o,i as _,t as p,F as g,l as j,m as y,u as be,g as xe}from"./app-BosDeu9q.js";import"./trash-CQC9EFiE.js";import"./createLucideIcon-D87RImiA.js";import"./Modal-BmGRC3Dd.js";import"./PrimaryButton-STiVSC5k.js";import"./SecondaryButton-B6E-c3zE.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./ResponseBuilder-Cir7Bgsf.js";import"./FieldBuilder-Bsq_B_YB.js";import"./chevron-down-Dapwow0i.js";/* empty css                                                                       */const _e={class:"mb-3"},Se={class:"flex gap-2 mt-1 items-center"},we={class:"flex-1"},ke=["disabled"],Ce={key:0,class:"text-[11px] text-gray-500 mt-1"},Ie={class:"space-y-1 mb-4"},Ae={class:"flex items-start gap-2 mt-1"},$e=["value"],Pe={class:"space-y-2"},Ne={class:"p-2 bg-gray-50 rounded-md border space-y-2"},Oe={class:"text-sm font-medium text-indigo-700"},Te=["onClick"],je={class:"flex items-center justify-between"},Le={class:"text-xs inline-flex items-center gap-1"},Re=["checked"],Ve={key:0,class:"border-t pt-3 mt-3"},Ee={class:"flex items-center justify-between"},Fe={class:"block text-sm font-medium text-gray-700"},Be={key:0,class:"mt-2 text-xs text-gray-700"},Me={class:"list-disc ml-5 space-y-0.5"},De={class:"space-y-2"},We={class:"p-2 bg-gray-50 rounded border"},Je={key:0,class:"text-xs text-gray-500"},Ue={key:1,class:"text-xs text-gray-700 space-y-1"},ze={class:"font-medium"},Ge={key:0,class:"ml-4 list-disc"},He={class:"font-medium"},dt={__name:"AIStep",props:{step:{type:Object,required:!0},allStepsBefore:{type:Array,default:()=>[]},loopContextSchema:{type:Object,default:null}},emits:["update:step","delete"],setup(L,{emit:Q}){const f=L,M=Q,h=ue(),R=l(()=>h.automationSchema||[]);l(()=>h.campaigns||[]);const D=l(()=>h.prompts||[]),$=l(()=>{const t=Array.isArray(D.value)?[...D.value]:[];return t.sort((e,s)=>{const a=(e.name||"").localeCompare(s.name||"");return a!==0?a:(s.version||0)-(e.version||0)}),t}),Z=l(()=>$.value.map(t=>({value:t.id,label:`${t.name} (v${t.version})`}))),m=l({get:()=>f.step.step_config||{},set:t=>M("update:step",{...f.step,step_config:t})}),P=l(()=>{var e,s;const t=(s=(e=m.value)==null?void 0:e.promptRef)==null?void 0:s.id;return t&&$.value.find(a=>String(a.id)===String(t))||null});X(P,t=>{if(t&&Array.isArray(t.response_variables)){const e=JSON.parse(JSON.stringify(t.response_variables));c("responseStructure",e)}},{immediate:!0}),he(()=>{h.prompts.length||h.fetchPrompts()});const k=l({get:()=>{var t,e;return((e=(t=m.value)==null?void 0:t.promptRef)==null?void 0:e.id)||null},set:t=>{const e=$.value.find(s=>String(s.id)===String(t))||null;e?c("promptRef",{id:e.id,name:e.name,version:e.version}):c("promptRef",null)}}),S=T(!1),V=T("create"),b=T(null);function ee(){V.value="create",b.value={name:"New Prompt",category:"General",version:1,system_prompt_text:`You are a helpful AI assistant.

Use the provided template variables like {{example_variable}} to craft your response.`,model_name:"gemini-2.5-flash-preview-05-20",generation_config:{temperature:.7,maxOutputTokens:2048,responseMimeType:"application/json"},template_variables:["example_variable"],response_variables:[],response_json_template:[],status:"draft"},S.value=!0}function te(){const t=k.value,e=$.value.find(s=>s.id===t);e&&(V.value="edit",b.value=JSON.parse(JSON.stringify(e)),S.value=!0)}async function se(t){try{let e;if(t.id&&!t.isNewVersion)e=await h.updatePrompt(t.id,t);else{const{id:s,isNewVersion:a,...d}=t;e=await h.createPrompt(d)}e&&e.id&&(k.value=e.id),S.value=!1,b.value=null}catch(e){console.error("Failed to save prompt from modal",e)}}const C=l(()=>f.allStepsBefore.find(t=>t.step_type==="TRIGGER")),W=l(()=>{var t,e;return((e=(t=C.value)==null?void 0:t.step_config)==null?void 0:e.model)||"Trigger"}),N=l(()=>{var t;return!C.value||!((t=C.value.step_config)!=null&&t.model)?null:R.value.find(e=>e.name===C.value.step_config.model)}),E=l(()=>Array.isArray(m.value.aiInputs)?m.value.aiInputs:[]),oe=l(()=>E.value.filter(t=>typeof t=="string"&&(t.startsWith("trigger:")||!t.includes(":"))).map(t=>t.startsWith("trigger:")?t.slice(8):t)),ae=l(()=>E.value.filter(t=>typeof t=="string"&&t.startsWith("loop:")).map(t=>t.slice(5)));l(()=>{if(!N.value)return[];const t=new Set(oe.value);return(N.value.columns||[]).filter(e=>!t.has(e.name||e))});const J=l(()=>{var H,Y;if(f.loopContextSchema&&Array.isArray(f.loopContextSchema.columns)&&f.loopContextSchema.columns.length>0)return f.loopContextSchema;const t=[...f.allStepsBefore].reverse().find(u=>{var v;return u.step_type==="FOR_EACH"&&((v=u.step_config)==null?void 0:v.sourceArray)});if(!t)return null;const e=t.step_config.sourceArray,s=typeof e=="string"?e.match(/{{\s*step_(\w+)\.(.+?)\s*}}/):null;if(!s)return null;const a=s[1],d=s[2],I=f.allStepsBefore.find(u=>String(u.id)===String(a));if(!I)return null;const ie=u=>{const v=String((u==null?void 0:u.type)||"").toLowerCase(),q=String((u==null?void 0:u.itemType)||"").toLowerCase();return v==="array of objects"||v==="array"&&q==="object"};if(I.step_type==="AI_PROMPT"){const u=(((H=I.step_config)==null?void 0:H.responseStructure)||[]).find(v=>v.name===d);return ie(u)?{name:"Loop Item",columns:u.schema||[]}:null}if(I.step_type==="FETCH_RECORDS"&&d==="records"){const u=(Y=I.step_config)==null?void 0:Y.model;if(!u)return null;const v=R.value.find(A=>A.name===u);return v?{name:"Loop Item",columns:(v.columns||[]).map(A=>typeof A=="string"?{name:A}:A),modelName:u}:null}return null}),U=l(()=>{const t=J.value;if(!t||!Array.isArray(t.columns)||t.columns.length===0)return[];const e=new Set(ae.value);return t.columns.map(s=>typeof s=="string"?{name:s,label:s}:{name:s.name,label:s.label||s.name}).filter(s=>s.name&&!e.has(s.name))}),O=l(()=>{const t=[];if(N.value){const e=W.value||"Trigger";(N.value.columns||[]).forEach(s=>{const a=typeof s=="string"?s:s.name||"",d=typeof s=="string"?s:s.label||s.name||"";a&&t.push({value:`trigger:${a}`,label:`Trigger: ${e} â€” ${d}`})})}return U.value.length>0&&U.value.forEach(e=>{const s=e.name,a=e.label||e.name;s&&t.push({value:`loop:${s}`,label:`Current Loop Item â€” ${a}`})}),t}),F=l({get:()=>(Array.isArray(m.value.aiInputs)?m.value.aiInputs:[]).map(e=>typeof e=="string"&&e.includes(":")?e:`trigger:${e}`),set:t=>{c("aiInputs",Array.isArray(t)?t:[])}}),z=l(()=>{const t=O.value.length,e=new Set(F.value||[]),s=new Set(O.value.map(d=>d.value));let a=0;return s.forEach(d=>{e.has(d)&&a++}),t>0&&a===t});function le(){z.value?c("aiInputs",[]):c("aiInputs",O.value.map(t=>t.value))}const w=l(()=>{var t,e,s;return((t=J.value)==null?void 0:t.modelName)||((s=(e=C.value)==null?void 0:e.step_config)==null?void 0:s.model)||null}),G=l(()=>w.value?R.value.find(t=>t.name===w.value):null),i=l({get:()=>m.value.relationships||{base_model:w.value||null,roots:[],nested:{},fields:{}},set:t=>c("relationships",t)});X(w,t=>{const e=i.value||{};e.base_model!==t&&(i.value={...e,base_model:t})},{immediate:!0}),l(()=>{var t;return((t=G.value)==null?void 0:t.relationships)||[]});function c(t,e){m.value={...m.value,[t]:e}}function ne(t){const e=E.value;c("aiInputs",e.filter(s=>s!==t))}l(()=>{const t=m.value.responseStructure||[];if(t.length===0)return"";const e=s=>(s||[]).filter(a=>a.name).map(a=>a.type==="Array of Objects"?`"${a.name}": [{ ${e(a.schema||[])} }]`:`"${a.name}": <${a.type.toLowerCase()}>`).join(", ");return`Respond with JSON in this exact format: { ${e(t)} }`});const B=T(!1);function re(t){const e=m.value.freeText||"";c("freeText",e+t)}return(t,e)=>(n(),r(g,null,[x(me,{icon:"ðŸ§ ",title:"Analyze with AI",onDelete:()=>M("delete")},{default:K(()=>[o("div",_e,[e[8]||(e[8]=o("label",{class:"block text-sm font-medium text-gray-700"},"Prompt",-1)),o("div",Se,[o("div",we,[x(fe,{options:Z.value,modelValue:k.value,"onUpdate:modelValue":e[0]||(e[0]=s=>k.value=s),placeholder:"â€” Select a prompt â€”"},null,8,["options","modelValue"])]),o("button",{type:"button",onClick:ee,class:"px-2 py-1 text-xs font-semibold text-white bg-indigo-600 rounded-md hover:bg-indigo-700"},"Create"),o("button",{type:"button",onClick:te,disabled:!k.value,class:"px-2 py-1 text-xs font-semibold bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"},"Edit",8,ke)]),P.value?(n(),r("p",Ce,"Linked: "+p(P.value.name)+" (v"+p(P.value.version)+")",1)):_("",!0)]),o("div",Ie,[e[9]||(e[9]=o("label",{class:"block text-sm font-medium text-gray-700"},"Custom Text (optional)",-1)),o("div",Ae,[o("textarea",{value:m.value.freeText||"",onInput:e[1]||(e[1]=s=>c("freeText",s.target.value)),class:"w-full p-2 border border-gray-300 rounded-md text-sm min-h-[90px]",placeholder:"Type or paste text hereâ€¦ You can insert tokens like {{trigger.email.body}} or {{step_12.cleaned_body}}"},null,40,$e),x(ge,{"all-steps-before":L.allStepsBefore,"loop-context-schema":L.loopContextSchema,onInsert:re},null,8,["all-steps-before","loop-context-schema"])]),e[10]||(e[10]=o("p",{class:"text-[11px] text-gray-500"},"If provided, this text will be sent to the AI as the primary body, even if fields are selected below.",-1))]),o("div",Pe,[e[12]||(e[12]=o("h4",{class:"text-sm font-medium text-gray-700"},"Data to Analyze",-1)),o("div",Ne,[(n(!0),r(g,null,j(m.value.aiInputs||[],s=>(n(),r("div",{key:s,class:"flex items-center justify-between bg-white p-1 rounded border"},[o("span",Oe,[typeof s=="string"&&s.startsWith("loop:")?(n(),r(g,{key:0},[y(" Current Loop Item: "+p(s.slice(5)),1)],64)):(n(),r(g,{key:1},[y(p(W.value)+": "+p(typeof s=="string"&&s.startsWith("trigger:")?s.slice(8):s),1)],64))]),o("button",{onClick:a=>ne(s),class:"text-gray-400 hover:text-red-500"},[x(be(ye),{class:"h-4 w-4"})],8,Te)]))),128)),o("div",je,[o("label",Le,[o("input",{type:"checkbox",checked:z.value,onChange:le,class:"rounded border-gray-300"},null,40,Re),e[11]||(e[11]=y(" Select all ",-1))])]),x(pe,{options:O.value,"model-value":F.value,placeholder:"Select fields from Trigger and/or Current Loop Item...","onUpdate:modelValue":e[2]||(e[2]=s=>F.value=s)},null,8,["options","model-value"])])]),G.value?(n(),r("div",Ve,[o("div",Ee,[o("label",Fe,"Include Related Data from "+p(w.value),1),o("button",{onClick:e[3]||(e[3]=s=>B.value=!0),type:"button",class:"text-xs px-2 py-1 rounded-md bg-white ring-1 ring-gray-300 hover:bg-gray-50"},"Chooseâ€¦")]),i.value&&(i.value.roots&&i.value.roots.length||Object.keys(i.value.fields||{}).length)?(n(),r("div",Be,[e[13]||(e[13]=o("p",{class:"font-medium"},"Summary",-1)),o("ul",Me,[(n(!0),r(g,null,j(i.value.roots||[],s=>(n(),r("li",{key:"sum-"+s},[y(p(s)+" ",1),i.value.fields&&i.value.fields[s]&&i.value.fields[s].length&&!i.value.fields[s].includes("*")?(n(),r(g,{key:0},[y(" â€” fields: "+p(i.value.fields[s].join(", ")),1)],64)):_("",!0),i.value.nested&&i.value.nested[s]&&i.value.nested[s].length?(n(),r(g,{key:1},[y(" â€” also: "+p(i.value.nested[s].map(a=>s+"."+a).join(", ")),1)],64)):_("",!0)]))),128))]),e[14]||(e[14]=o("p",{class:"text-[11px] text-gray-500 mt-1"},"Selected related records will be available in your prompt under the with key (e.g., with.campaign, with.campaign.leads).",-1))])):_("",!0),x(ce,{show:B.value,"base-model-name":w.value,modelValue:i.value,"onUpdate:modelValue":e[4]||(e[4]=s=>i.value=s),onClose:e[5]||(e[5]=s=>B.value=!1)},null,8,["show","base-model-name","modelValue"])])):_("",!0),o("div",De,[e[16]||(e[16]=o("h4",{class:"text-sm font-medium text-gray-700"},"Expected AI Response Structure",-1)),o("div",We,[m.value.responseStructure&&m.value.responseStructure.length?(n(),r("ul",Ue,[(n(!0),r(g,null,j(m.value.responseStructure,s=>(n(),r("li",{key:"r-"+s.id},[o("span",ze,p(s.name),1),y(": "+p(s.type)+" ",1),s.schema&&s.schema.length?(n(),r("ul",Ge,[(n(!0),r(g,null,j(s.schema,a=>(n(),r("li",{key:"r-"+s.id+"-"+a.id},[o("span",He,p(a.name),1),y(": "+p(a.type),1)]))),128))])):_("",!0)]))),128))])):(n(),r("p",Je," Link a Prompt to auto-fill the expected response structure. ")),e[15]||(e[15]=o("p",{class:"text-[11px] text-gray-500 mt-1"},"To change the structure, edit the linked Prompt.",-1))])])]),_:1},8,["onDelete"]),x(de,{show:S.value,title:V.value==="create"?"Create Prompt":"Edit Prompt",formData:b.value||{},showFooter:!1,onClose:e[7]||(e[7]=s=>S.value=!1)},{default:K(()=>[b.value?(n(),xe(ve,{key:0,prompt:b.value,onSave:se,onCancel:e[6]||(e[6]=s=>{S.value=!1,b.value=null})},null,8,["prompt"])):_("",!0)]),_:1},8,["show","title","formData"])],64))}};export{dt as default};
