import{u as ie}from"./workflowStore-Bpiwde2G.js";import de from"./StepCard-BcFfCpd6.js";import k from"./DataTokenInserter-k9UKlWJp.js";import{S as ce}from"./SelectDropdown-1YLG6EIf.js";import{c as f,r as N,e as V,f as me,g as K,o as u,w as pe,b as s,a as i,i as d,F as b,l as A,t as y,d as g,u as q,m as W,j as ve,p as fe}from"./app-CsGDI9I1.js";import{_ as ye}from"./RelationshipPathPicker-B8fArWBm.js";import{c as ge}from"./createLucideIcon-B-MJot2i.js";import{P as be}from"./plus-DDMyVbUp.js";import{T as he}from"./trash-53BkXZLB.js";/* empty css                                                                       */import"./_plugin-vue_export-helper-DlAUqK2U.js";/**
 * @license lucide-vue-next v0.536.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _e=ge("clock",[["path",{d:"M12 6v6l4 2",key:"mmk7yg"}],["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]),xe=["value"],Ce=["value"],ke={class:"mt-2 flex items-center gap-2 text-xs text-gray-600"},Ae={key:0,class:"flex items-center gap-2"},we=["value"],Se={key:0,class:"space-y-4 mt-4 border-t pt-4"},Ee={class:"flex items-center gap-2"},Ie=["value"],Re={class:"flex items-center gap-2"},Me=["value"],De={class:"relative"},Te=["value"],Fe={class:"absolute top-2 right-2"},Oe={class:"block text-xs font-medium text-gray-600 mb-1"},qe={key:0},Pe={class:"flex items-center gap-2"},$e=["value"],Be={class:"flex items-center justify-between mb-2"},Le={key:0,class:"mb-2 text-[11px]"},Ue={class:"text-gray-600"},je={class:"px-1.5 py-0.5 rounded bg-amber-50 border border-amber-200 text-amber-700"},Ne={key:0},Ve={key:0,class:"mt-1 text-red-600"},Ke={key:1,class:"space-y-2"},We={class:"flex items-center justify-between gap-2"},ze={class:"flex-1 flex items-center gap-2"},He=["value","onChange","disabled"],Ge=["value"],Je={key:0,class:"text-[10px] px-1.5 py-0.5 rounded bg-amber-50 border border-amber-200 text-amber-700"},Qe=["onClick","title"],Xe={class:"flex items-center gap-2 mt-2"},Ye=["value","onChange"],Ze=["value"],et=["value","onInput"],tt=["value","onInput"],lt={class:"mt-1 text-[14px] text-gray-500"},ot={key:0,class:"mt-1 text-[11px] text-gray-500"},nt={key:2,class:"p-3 bg-blue-50 border-l-4 border-blue-400 text-blue-800 text-sm rounded-r-md"},yt={__name:"ActionStep",props:{step:{type:Object,required:!0},allStepsBefore:{type:Array,default:()=>[]},loopContextSchema:{type:Object,default:null}},emits:["update:step","delete"],setup(c,{emit:z}){const w=c,M=z,H=ie(),x=f(()=>H.automationSchema||[]),C=N({});function P(t,e){return`${t||""}:${e||""}`}async function S(t,e){if(!t||!e)return null;const l=P(t,e);if(Array.isArray(C.value[l])&&C.value[l].length)return C.value[l];try{const{data:o}=await fe.get(`/api/value-dictionaries/${encodeURIComponent(t)}/${encodeURIComponent(e)}`);let r=null;if(Array.isArray(o)?r=o:o&&Array.isArray(o.values)&&(r=o.values),Array.isArray(r)&&r.length)return C.value[l]=r,r}catch{}return null}const G=[{value:"SEND_EMAIL",label:"Send Email"},{value:"PROCESS_EMAIL",label:"Process Email"},{value:"CREATE_RECORD",label:"Create Record"},{value:"UPDATE_RECORD",label:"Update Record"},{value:"CHECK_MILESTONE_COMPLETION",label:"Check for Milestone Completion & Update"}],n=f({get:()=>w.step.step_config||{},set:t=>M("update:step",{...w.step,step_config:t})});function m(t,e){n.value={...n.value,[t]:e}}function J(t){n.value={action_type:t}}function E(t,e){const l=n.value[t]||"";m(t,`${l}${e}`)}f(()=>x.value.map(t=>t.name));const Q=f(()=>(x.value||[]).map(t=>({label:t.name,value:t.name})));function I(t){if(!t||typeof t!="string")return"";let e=t.toLowerCase();if(e==="id")return"ID";e.endsWith("_id")&&(e=e.slice(0,-3)),e=e.replace(/[_-]+/g," ");let l=e.replace(/\b\w/g,o=>o.toUpperCase());return l=l.replace(/\bId\b/g,"ID").replace(/\bUrl\b/g,"URL"),l}const D=f(()=>{const t=n.value.target_model;if(!t)return null;let e=(x.value||[]).find(o=>o.name===t);if(e||(e=(x.value||[]).find(o=>o.full_class===t),e))return e;const l=typeof t=="string"?t.split("\\").pop().split("/").pop():t;return(x.value||[]).find(o=>o.name===l)||null}),R=f(()=>{const t=D.value;return t?(t.columns||[]).map(e=>typeof e=="string"?{name:e,label:I(e),is_required:!1,allowed_values:null,description:null,ui:null}:{name:e.name,label:e.label||I(e.name),is_required:!!e.is_required,allowed_values:e.allowed_values??null,description:e.description||null,ui:e.ui||null}):[]});function T(t){return R.value.find(e=>e.name===t)||null}function $(t){return typeof t=="string"&&t.endsWith("_type")}function X(t){return typeof t=="string"&&t.endsWith("_id")}function Y(t){const e=T(t.column);return X(t.column)||$(t.column)&&((e==null?void 0:e.ui)==="morph_type"||Array.isArray(e==null?void 0:e.allowed_values))}function Z(t){return $(t.column)?"type":"id"}const h=f(()=>{var t;return((t=D.value)==null?void 0:t.required_on_create)||[]}),ee=f(()=>{var t;return((t=D.value)==null?void 0:t.defaults_on_create)||{}});function B(t){return h.value.includes(t)}function te(t){const e=ee.value||{},l=n.value.target_model,r=`{{trigger.${l?l.toLowerCase():""}.${t}}}`,a=(()=>{const v=(R.value||[]).find(ue=>ue.name===t);return!!(v&&Array.isArray(v.allowed_values)&&v.allowed_values.length>0)})();return n.value.action_type==="CREATE_RECORD"&&a?"":e[t]!==void 0&&e[t]!==null||t.endsWith("_id")?r:""}function L(){const t=h.value||[];if(!t.length)return;const e=Array.isArray(n.value.fields)?[...n.value.fields]:[],l=new Map;e.forEach(a=>{const p=a.column||a.field||a.name;p&&l.set(p,!0)});const o=[];for(const a of t)l.has(a)||o.push({column:a,value:te(a)});o.length&&m("fields",[...e,...o]);const r=n.value.target_model;if(r)for(const a of t)S(r,a)}function le(t){m("target_model",t),L()}V(()=>n.value.target_model,async(t,e)=>{if(t&&t!==e){L();const l=Array.isArray(n.value.fields)?n.value.fields:[];for(const o of l){const r=(o==null?void 0:o.column)||(o==null?void 0:o.field)||(o==null?void 0:o.name);r&&await S(t,r)}}}),V(()=>n.value.fields,async t=>{const e=n.value.target_model;if(!(!e||!Array.isArray(t)))for(const l of t){const o=(l==null?void 0:l.column)||(l==null?void 0:l.field)||(l==null?void 0:l.name);o&&await S(e,o)}},{deep:!0,immediate:!0}),me(async()=>{const t=n.value.target_model,e=Array.isArray(n.value.fields)?n.value.fields:[];if(t)for(const l of e){const o=(l==null?void 0:l.column)||(l==null?void 0:l.field)||(l==null?void 0:l.name);o&&await S(t,o)}});function oe(){const t=n.value.fields||[];m("fields",[...t,{column:"",value:""}])}function ne(t){const e=n.value.fields||[];m("fields",e.filter((l,o)=>o!==t))}function _(t,e,l){const r=[...n.value.fields||[]];r[t]={...r[t],[e]:l},m("fields",r)}function se(t,e){const o=(n.value.fields||[])[t].value||"";_(t,"value",o+e)}function U(t){var p;const e=n.value.target_model;if(!e||!t)return null;const l=t.column||t.field||t.name;if(!l)return null;const o=(p=(R.value||[]).find(v=>v.name===l))==null?void 0:p.allowed_values;if(Array.isArray(o)&&o.length)return o;const r=P(e,l),a=C.value[r];return Array.isArray(a)&&a.length?a:null}function ae(t){const e=U(t);return!(!e||!e.length||(t.value||"").toString().includes("{{"))}const j=f(()=>{const t=h.value||[];if(!t.length)return[];const e=new Map;return(Array.isArray(n.value.fields)?n.value.fields:[]).forEach(o=>{const r=o.column||o.field||o.name,a=(o.value??"").toString().trim();r&&a&&e.set(r,!0)}),t.filter(o=>!e.has(o))});function F(t){var r,a,p;const e=Array.isArray(n.value.fields)?n.value.fields:[],l=((r=e[t])==null?void 0:r.column)||((a=e[t])==null?void 0:a.field)||((p=e[t])==null?void 0:p.name);return!l||!B(l)?!0:e.filter(v=>(v.column||v.field||v.name)===l).length>1}const O=N(!1);function re(t){const e=Math.max(0,parseInt(t??0,10)||0);M("update:step",{...w.step,delay_minutes:e})}return(t,e)=>(u(),K(de,{icon:"⚙️",title:"Perform an Action",onDelete:()=>M("delete")},{default:pe(()=>[s("select",{value:n.value.action_type||"",onChange:e[0]||(e[0]=l=>J(l.target.value)),class:"p-2 border border-gray-300 rounded-md bg-white shadow-sm w-full text-sm"},[e[11]||(e[11]=s("option",{value:"",disabled:""},"Select an action...",-1)),(u(),i(b,null,A(G,l=>s("option",{key:l.value,value:l.value},y(l.label),9,Ce)),64))],40,xe),s("div",ke,[s("button",{type:"button",onClick:e[1]||(e[1]=l=>O.value=!O.value),class:"p-1.5 rounded-md border text-gray-600 hover:bg-gray-50",title:"Set delay (minutes)"},[g(q(_e),{class:"w-4 h-4"})]),O.value?(u(),i("div",Ae,[e[12]||(e[12]=s("label",null,"Delay",-1)),s("input",{type:"number",min:"0",value:w.step.delay_minutes||0,onInput:e[2]||(e[2]=l=>re(l.target.value)),class:"w-20 p-1 border rounded"},null,40,we),e[13]||(e[13]=s("span",null,"minutes",-1))])):d("",!0)]),n.value.action_type?(u(),i("div",Se,[n.value.action_type==="SEND_EMAIL"?(u(),i(b,{key:0},[s("div",null,[e[14]||(e[14]=s("label",{class:"block text-xs font-medium text-gray-600 mb-1"},"To",-1)),s("div",Ee,[s("input",{type:"text",value:n.value.to||"",onInput:e[3]||(e[3]=l=>m("to",l.target.value)),class:"w-full p-2 border border-gray-300 rounded-md text-sm",placeholder:"e.g., {{trigger.email.sender}}"},null,40,Ie),g(k,{"all-steps-before":c.allStepsBefore,"loop-context-schema":c.loopContextSchema,onInsert:e[4]||(e[4]=l=>E("to",l))},null,8,["all-steps-before","loop-context-schema"])])]),s("div",null,[e[15]||(e[15]=s("label",{class:"block text-xs font-medium text-gray-600 mb-1"},"Subject",-1)),s("div",Re,[s("input",{type:"text",value:n.value.subject||"",onInput:e[5]||(e[5]=l=>m("subject",l.target.value)),class:"w-full p-2 border border-gray-300 rounded-md text-sm",placeholder:"e.g., AI says: {{step_2.category}}"},null,40,Me),g(k,{"all-steps-before":c.allStepsBefore,"loop-context-schema":c.loopContextSchema,onInsert:e[6]||(e[6]=l=>E("subject",l))},null,8,["all-steps-before","loop-context-schema"])])]),s("div",null,[e[16]||(e[16]=s("label",{class:"block text-xs font-medium text-gray-600 mb-1"},"Body",-1)),s("div",De,[s("textarea",{rows:"5",value:n.value.body||"",onInput:e[7]||(e[7]=l=>m("body",l.target.value)),class:"w-full p-2 border border-gray-300 rounded-md text-sm"},null,40,Te),s("div",Fe,[g(k,{"all-steps-before":c.allStepsBefore,"loop-context-schema":c.loopContextSchema,onInsert:e[8]||(e[8]=l=>E("body",l))},null,8,["all-steps-before","loop-context-schema"])])])])],64)):d("",!0),n.value.action_type==="CREATE_RECORD"||n.value.action_type==="UPDATE_RECORD"?(u(),i(b,{key:1},[s("div",null,[s("label",Oe,y(n.value.action_type==="CREATE_RECORD"?"Model to Create":"Model to Update"),1),g(ce,{"model-value":n.value.target_model||"",options:Q.value,placeholder:"Select model...","onUpdate:modelValue":le,class:"w-full"},null,8,["model-value","options"])]),n.value.action_type==="UPDATE_RECORD"?(u(),i("div",qe,[e[17]||(e[17]=s("label",{class:"block text-xs font-medium text-gray-600 mb-1"},"Record ID",-1)),s("div",Pe,[s("input",{type:"text",value:n.value.record_id||"",onInput:e[9]||(e[9]=l=>m("record_id",l.target.value)),class:"w-full p-2 border border-gray-300 rounded-md text-sm",placeholder:"e.g., {{trigger.task.id}}"},null,40,$e),g(k,{"all-steps-before":c.allStepsBefore,"loop-context-schema":c.loopContextSchema,onInsert:e[10]||(e[10]=l=>E("record_id",l))},null,8,["all-steps-before","loop-context-schema"])])])):d("",!0),s("div",null,[s("div",Be,[e[19]||(e[19]=s("label",{class:"text-xs font-medium text-gray-600"},"Fields to set",-1)),s("button",{onClick:oe,class:"flex items-center gap-1 px-2 py-1 text-xs rounded-md bg-gray-100 hover:bg-gray-200"},[g(q(be),{class:"h-3 w-3"}),e[18]||(e[18]=W(" Add ",-1))])]),h.value.length?(u(),i("div",Le,[s("span",Ue,"Required for "+y(n.value.target_model)+":",1),(u(!0),i(b,null,A(h.value,(l,o)=>(u(),i("span",{class:"ml-1",key:l},[s("span",je,y(I(l)),1),o<h.value.length-1?(u(),i("span",Ne,", ")):d("",!0)]))),128)),j.value.length?(u(),i("div",Ve,"Missing: "+y(j.value.map(I).join(", ")),1)):d("",!0)])):d("",!0),n.value.fields&&n.value.fields.length>0?(u(),i("div",Ke,[(u(!0),i(b,null,A(n.value.fields,(l,o)=>{var r;return u(),i("div",{key:o,class:"p-2 border rounded-md bg-gray-50/50"},[s("div",We,[s("div",ze,[s("select",{value:l.column,onChange:a=>_(o,"column",a.target.value),class:"w-full p-2 border border-gray-300 rounded-md text-sm",disabled:!n.value.target_model},[e[20]||(e[20]=s("option",{value:"",disabled:""},"Field...",-1)),(u(!0),i(b,null,A(R.value,a=>(u(),i("option",{key:a.name,value:a.name},y(a.label),9,Ge))),128))],40,He),B(l.column)?(u(),i("span",Je,"Required")):d("",!0)]),s("button",{onClick:a=>F(o)&&ne(o),class:ve([[F(o)?"text-gray-400 hover:text-red-500 hover:bg-red-50":"text-gray-300 cursor-not-allowed"],"p-1 rounded-full"]),title:F(o)?"Remove Field":"Cannot remove required field"},[g(q(he),{class:"w-4 h-4"})],10,Qe)]),s("div",Xe,[n.value.target_model?(u(),i(b,{key:0},[ae(l)?(u(),i("select",{key:0,value:l.value||"",onChange:a=>_(o,"value",a.target.value),class:"w-full p-2 border border-gray-300 rounded-md text-sm"},[e[21]||(e[21]=s("option",{value:"",disabled:""},"Select value...",-1)),(u(!0),i(b,null,A(U(l)||[],a=>(u(),i("option",{key:a.value,value:a.value},y(a.label??a.value),9,Ze))),128))],40,Ye)):(u(),i("input",{key:1,value:l.value,onInput:a=>_(o,"value",a.target.value),type:"text",class:"w-full border rounded px-2 py-2 text-sm",placeholder:"Value..."},null,40,et))],64)):(u(),i("input",{key:1,value:l.value,onInput:a=>_(o,"value",a.target.value),type:"text",class:"w-full border rounded px-2 py-2 text-sm",placeholder:"Value..."},null,40,tt)),g(k,{"all-steps-before":c.allStepsBefore,"loop-context-schema":c.loopContextSchema,onInsert:a=>se(o,a)},null,8,["all-steps-before","loop-context-schema","onInsert"]),Y(l)?(u(),K(ye,{key:2,mode:Z(l),"all-steps-before":c.allStepsBefore,value:l.value,onSelect:a=>_(o,"value",a)},null,8,["mode","all-steps-before","value","onSelect"])):d("",!0)]),s("p",lt,[e[22]||(e[22]=W("Selected Relationship: ",-1)),s("strong",null,y(l.value),1)]),(r=T(l.column))!=null&&r.description?(u(),i("p",ot,y(T(l.column).description),1)):d("",!0)])}),128))])):d("",!0)])],64)):d("",!0),n.value.action_type==="CHECK_MILESTONE_COMPLETION"?(u(),i("div",nt,e[23]||(e[23]=[s("p",{class:"font-semibold"},"This is a smart action.",-1),s("p",null,"It will automatically use the context from the trigger to check if all tasks in the milestone are complete. If so, it will mark the milestone as completed.",-1)]))):d("",!0)])):d("",!0)]),_:1},8,["onDelete"]))}};export{yt as default};
