import{u as W}from"./workflowStore-NlcWbgL0.js";import{r as $,c as V,f as Y,Q as J,a as m,o as c,b as n,g as Z,t as L,F as E,l as F,m as U,s as q,i as T,k as H,v as I,x as Q,Y as X,n as G,e as ee,d as j}from"./app-D1j92mid.js";const te=["disabled"],le={class:"flex flex-wrap gap-1 items-center"},ne={key:0,class:"text-gray-500"},oe=["onClick"],se={class:"p-2 border-b"},ae=["checked","onChange"],ie={key:0,class:"px-3 py-2 text-xs text-gray-500"},B={__name:"OverlayMultiSelect",props:{modelValue:{type:Array,default:()=>[]},options:{type:Array,default:()=>[]},placeholder:{type:String,default:"Select..."},valueKey:{type:String,default:"value"},labelKey:{type:String,default:"label"},maxHeight:{type:String,default:"260px"},disabled:{type:Boolean,default:!1}},emits:["update:modelValue","change"],setup(f,{emit:K}){const d=f,_=K,g=$(!1),v=$(null),h=$(null),o=$(""),b=$({top:0,left:0,width:0}),w=V(()=>Array.isArray(d.modelValue)?d.modelValue:[]),A=V(()=>{const i=new Map(d.options.map(s=>[s[d.valueKey],s[d.labelKey]]));return w.value.map(s=>i.get(s)).filter(Boolean)}),k=V(()=>{const i=o.value.trim().toLowerCase();return i?d.options.filter(s=>String(s[d.labelKey]||"").toLowerCase().includes(i)):d.options});function y(){d.disabled||(g.value=!g.value,G(()=>R()))}function R(){const i=v.value;if(!i)return;const s=i.getBoundingClientRect();b.value={top:s.bottom+window.scrollY,left:s.left+window.scrollX,width:s.width}}function x(){g.value&&R()}function S(i){const s=v.value&&v.value.contains(i.target),r=h.value&&h.value.contains(i.target);!s&&!r&&(g.value=!1)}function M(i){const s=new Set(w.value);s.has(i)?s.delete(i):s.add(i);const r=Array.from(s);_("update:modelValue",r),_("change",r)}function O(i){M(i)}return Y(()=>{window.addEventListener("scroll",x,!0),window.addEventListener("resize",x),document.addEventListener("click",S)}),J(()=>{window.removeEventListener("scroll",x,!0),window.removeEventListener("resize",x),document.removeEventListener("click",S)}),(i,s)=>(c(),m("div",{class:"relative",ref_key:"triggerRef",ref:v},[n("button",{type:"button",onClick:y,disabled:f.disabled,class:"w-full inline-flex items-center justify-between rounded-md border border-gray-300 bg-white px-2 py-1.5 text-left text-sm shadow-sm hover:bg-gray-50 disabled:opacity-60"},[n("span",le,[A.value.length===0?(c(),m("span",ne,L(f.placeholder),1)):(c(!0),m(E,{key:1},F(A.value,(r,t)=>(c(),m("span",{key:t,class:"inline-flex items-center gap-1 px-1.5 py-0.5 rounded bg-indigo-50 text-indigo-700 border border-indigo-200 text-xs"},[U(L(r)+" ",1),(c(),m("svg",{onClick:q(e=>O(w.value[t]),["stop"]),xmlns:"http://www.w3.org/2000/svg",class:"h-3.5 w-3.5 cursor-pointer",viewBox:"0 0 20 20",fill:"currentColor"},s[1]||(s[1]=[n("path",{"fill-rule":"evenodd",d:"M10 8.586 5.293 3.879A1 1 0 1 0 3.879 5.293L8.586 10l-4.707 4.707a1 1 0 1 0 1.414 1.414L10 11.414l4.707 4.707a1 1 0 0 0 1.414-1.414L11.414 10l4.707-4.707a1 1 0 1 0-1.414-1.414L10 8.586Z","clip-rule":"evenodd"},null,-1)]),8,oe))]))),128))]),s[2]||(s[2]=n("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-4 w-4 text-gray-500",viewBox:"0 0 20 20",fill:"currentColor"},[n("path",{"fill-rule":"evenodd",d:"M5.23 7.21a.75.75 0 0 1 1.06.02L10 10.94l3.71-3.71a.75.75 0 1 1 1.06 1.06l-4.24 4.24a.75.75 0 0 1-1.06 0L5.25 8.29a.75.75 0 0 1-.02-1.08Z","clip-rule":"evenodd"})],-1))],8,te),(c(),Z(X,{to:"body"},[g.value?(c(),m("div",{key:0,ref_key:"portalRef",ref:h,class:"fixed z-[9999] bg-white rounded-md shadow-xl ring-1 ring-black ring-opacity-5",style:H({top:b.value.top+"px",left:b.value.left+"px",width:b.value.width+"px"})},[n("div",se,[I(n("input",{type:"text","onUpdate:modelValue":s[0]||(s[0]=r=>o.value=r),placeholder:"Search...",class:"w-full border border-gray-200 rounded px-2 py-1 text-sm focus:ring-indigo-500 focus:border-indigo-500"},null,512),[[Q,o.value]])]),n("div",{class:"max-h-[calc(100vh-180px)] overflow-auto",style:H({maxHeight:f.maxHeight})},[(c(!0),m(E,null,F(k.value,r=>(c(),m("label",{key:r[f.valueKey],class:"flex items-center gap-2 px-3 py-2 text-sm hover:bg-gray-50 cursor-pointer select-none"},[n("input",{type:"checkbox",class:"rounded border-gray-300",checked:w.value.includes(r[f.valueKey]),onChange:t=>M(r[f.valueKey])},null,40,ae),n("span",null,L(r[f.labelKey]),1)]))),128)),k.value.length===0?(c(),m("div",ie,"No options")):T("",!0)],4)],4)):T("",!0)]))],512))}},de={key:0,class:"fixed inset-0 z-50"},re={class:"absolute right-0 top-0 h-full w-full max-w-xl bg-white shadow-xl flex flex-col"},ue={class:"p-4 border-b flex items-center justify-between"},ce={class:"p-4 space-y-4 overflow-y-auto"},me=["value"],fe={class:"flex items-center justify-between"},pe={class:"text-sm font-medium"},ve={class:"text-xs inline-flex items-center gap-1"},ge=["checked","onChange"],be={class:"flex items-center justify-between"},ye={class:"text-xs font-medium"},xe={class:"text-xs inline-flex items-center gap-1"},he=["checked","onChange"],we={class:"p-3 border-t flex justify-end gap-2"},ke={__name:"RelatedDataPicker",props:{modelValue:{type:Object,default:()=>({base_model:null,roots:[],nested:{},fields:{}})},baseModelName:{type:String,default:null},show:{type:Boolean,default:!1}},emits:["update:modelValue","close"],setup(f,{emit:K}){const d=f,_=K,g=W(),v=V(()=>g.automationSchema||[]);function h(t){const e={base_model:(t==null?void 0:t.base_model)??d.baseModelName??null,roots:Array.isArray(t==null?void 0:t.roots)?t.roots:[],nested:t!=null&&t.nested&&typeof t.nested=="object"?t.nested:{},fields:t!=null&&t.fields&&typeof t.fields=="object"?t.fields:{}};try{return JSON.parse(JSON.stringify(e))}catch{return{...e,roots:[...e.roots||[]],nested:{...e.nested||{}},fields:{...e.fields||{}}}}}const o=$(h(d.modelValue||{base_model:d.baseModelName,roots:[],nested:{},fields:{}}));ee(()=>d.show,t=>{t&&(o.value=h(d.modelValue||{}))});const b=V(()=>v.value.find(t=>t.name===(o.value.base_model||d.baseModelName))||null),w=V(()=>{var t;return(((t=b.value)==null?void 0:t.relationships)||[]).map(e=>({value:e.name,label:`${e.name} → ${e.model}`}))});function A(t){const e=new Set(t),l={...o.value.nested},a={...o.value.fields};Object.keys(l).forEach(p=>{e.has(p)||delete l[p]}),Object.keys(a).forEach(p=>{e.has(p.split(".")[0])||delete a[p]}),o.value.roots=[...e],o.value.nested=l,o.value.fields=a}function k(t){return v.value.find(e=>e.name===t)||null}function y(t){var l;const e=(((l=b.value)==null?void 0:l.relationships)||[]).find(a=>a.name===t);return e?e.model:null}function R(t,e){var N;const l=y(t),a=k(l),p=(N=a==null?void 0:a.relationships)==null?void 0:N.find(u=>u.name===e);return p?p.model:null}function x(t){const e=k(t);return((e==null?void 0:e.columns)||[]).map(a=>({value:typeof a=="string"?a:a.name,label:typeof a=="string"?a:a.label||a.name}))}function S(t){var l;const e=((l=o.value.fields)==null?void 0:l[t])||[];return Array.isArray(e)&&e.includes("*")}function M(t){const e={...o.value.fields||{}};S(t)?delete e[t]:e[t]=["*"],o.value.fields=e}function O(t,e){const l={...o.value.fields||{}};!e||e.length===0?delete l[t]:l[t]=e.filter(a=>a!=="*"),o.value.fields=l}function i(t){const e=y(t),l=k(e);return((l==null?void 0:l.relationships)||[]).map(a=>({value:a.name,label:`${t}.${a.name} → ${a.model}`}))}function s(t,e){const l={...o.value.nested||{}};l[t]=e,o.value.nested=l}function r(){const t={base_model:o.value.base_model||d.baseModelName||null,roots:Array.isArray(o.value.roots)?o.value.roots:[],nested:o.value.nested||{},fields:o.value.fields||{}};_("update:modelValue",t),_("close")}return(t,e)=>f.show?(c(),m("div",de,[n("div",{class:"absolute inset-0 bg-black/40",onClick:e[0]||(e[0]=l=>t.$emit("close"))}),n("div",re,[n("div",ue,[e[3]||(e[3]=n("h3",{class:"text-base font-semibold"},"Include Related Data",-1)),n("button",{class:"text-gray-500 hover:text-gray-700",onClick:e[1]||(e[1]=l=>t.$emit("close"))},"✕")]),n("div",ce,[n("div",null,[e[4]||(e[4]=n("label",{class:"block text-xs font-medium text-gray-600 mb-1"},"Base Model",-1)),n("input",{type:"text",value:o.value.base_model||f.baseModelName||"",disabled:"",class:"w-full border rounded px-2 py-1.5 bg-gray-50 text-sm"},null,8,me)]),n("div",null,[e[5]||(e[5]=n("label",{class:"block text-xs font-medium text-gray-600 mb-1"},"Top-level Relationships",-1)),j(B,{options:w.value,"model-value":o.value.roots,placeholder:"Select relationships (e.g., campaign, contexts)","onUpdate:modelValue":A},null,8,["options","model-value"]),e[6]||(e[6]=n("p",{class:"text-xs text-gray-500 mt-1"},"Choose one or more relationships to include. You can then pick fields and add nested relationships.",-1))]),(c(!0),m(E,null,F(o.value.roots||[],l=>{var a,p,N;return c(),m("div",{key:l,class:"p-3 border rounded-md bg-gray-50/60 space-y-3"},[n("div",fe,[n("p",pe,"Fields in "+L(y(l)),1),n("label",ve,[n("input",{type:"checkbox",checked:S(l),onChange:u=>M(l),class:"rounded border-gray-300"},null,40,ge),e[7]||(e[7]=U(" Select all ",-1))])]),n("div",null,[j(B,{options:x(y(l)),"model-value":((a=o.value.fields)==null?void 0:a[l])||[],placeholder:"Select fields...","onUpdate:modelValue":u=>O(l,u)},null,8,["options","model-value","onUpdate:modelValue"])]),n("div",null,[e[8]||(e[8]=n("label",{class:"block text-xs font-medium text-gray-600 mb-1"},"Also include...",-1)),j(B,{options:i(l),"model-value":((p=o.value.nested)==null?void 0:p[l])||[],placeholder:"Select nested relationships...","onUpdate:modelValue":u=>s(l,u)},null,8,["options","model-value","onUpdate:modelValue"])]),(c(!0),m(E,null,F(((N=o.value.nested)==null?void 0:N[l])||[],u=>{var z,D,P;return c(),m("div",{key:`${l}.${u}`,class:"ml-2 p-2 border rounded bg-white"},[n("div",be,[n("p",ye,"Fields in "+L(R(l,u)||l+"."+u),1),n("label",xe,[n("input",{type:"checkbox",checked:S(l+"."+u),onChange:C=>M(l+"."+u),class:"rounded border-gray-300"},null,40,he),e[9]||(e[9]=U(" Select all ",-1))])]),j(B,{options:x((D=(((z=v.value.find(C=>C.name===y(l)))==null?void 0:z.relationships)||[]).find(C=>C.name===u))==null?void 0:D.model),"model-value":((P=o.value.fields)==null?void 0:P[l+"."+u])||[],placeholder:"Select fields...","onUpdate:modelValue":C=>O(l+"."+u,C)},null,8,["options","model-value","onUpdate:modelValue"])])}),128))])}),128))]),n("div",we,[n("button",{class:"px-3 py-1.5 rounded-md bg-white ring-1 ring-gray-300 text-sm",onClick:e[2]||(e[2]=l=>t.$emit("close"))},"Cancel"),n("button",{class:"px-3 py-1.5 rounded-md bg-indigo-600 text-white text-sm",onClick:r},"Save")])])])):T("",!0)}},$e=Object.freeze(Object.defineProperty({__proto__:null,default:ke},Symbol.toStringTag,{value:"Module"}));export{$e as R,B as _,ke as a};
