import{p as b,r as l,c as g,e as B,a as i,i as y,o as r,b as a,t as d,g as z,d as H}from"./app-C2DlCbPA.js";import N from"./EmailAttachmentsList-DUPVp5B9.js";import V from"./TaskCreationForm-BgcrhXYA.js";const x="/api",fe=async(o,v)=>{const n={...o,page:v};return n.type==="new"&&(n.is_read=!1),n.type==="waiting-approval"&&(n.statuses=["pending_approval","pending_approval_received"]),(await b.get(`${x}/inbox/all-emails`,{params:n})).data},q=async o=>(await b.get(`${x}/emails/${o}`)).data,ge=async o=>(await b.post(`${x}/inbox/emails/${o}/mark-as-read`)).data,G=async o=>(await b.get(`${x}/files`,{params:{model_type:"App\\Models\\Email",model_id:o}})).data,I={key:0,class:"flex items-center justify-center h-full"},J={key:1,class:"flex items-center justify-center h-full"},K={key:2,class:"space-y-4 p-4"},Q={class:"border-b pb-4"},W={class:"text-xl font-semibold text-gray-800"},X={class:"text-sm text-gray-600 mt-1"},Y={key:0,class:"text-sm text-gray-600 mt-1"},Z={class:"text-sm text-gray-600 mt-1"},ee={class:"flex flex-col sm:flex-row justify-between items-start sm:items-center pt-4"},te={class:"w-full sm:w-auto"},se={key:0,class:"text-gray-500"},ae={key:1,class:"text-red-500"},ne={key:0,class:"mt-6 border-t border-gray-200 pt-6"},oe={class:"prose max-w-none"},re=["innerHTML"],le={key:1},ie={class:"bg-red-100 border-l-4 border-red-500 text-red-700 p-4",role:"alert"},ce={class:"flex justify-end items-center pt-4"},ue={key:0,class:"flex space-x-2"},de={__name:"EmailDetailsContent",props:{email:Object,canApproveEmails:Boolean},emits:["edit","reject","open-bulk-tasks"],setup(o,{emit:v}){const n=o,p=l([]),k=l(!1),_=l(null),m=l(!1),s=l(null),w=l(!1),j=l([]),$=l(!1),A=l(null),D=g(()=>{var e,t;return((e=s.value)==null?void 0:e.status)==="pending_approval"||((t=s.value)==null?void 0:t.status)==="pending_approval_received"}),C=g(()=>{var e;return((e=s.value)==null?void 0:e.type)==="sent"}),F=g(()=>C.value?"Approve & Send":"Approve"),L=async()=>{if(!n.email||!n.email.id){s.value=null;return}w.value=!0,s.value=null;try{const e=await q(n.email.id);s.value=e,s.value&&s.value.id&&S()}catch(e){console.error("Failed to fetch email details:",e),s.value=null}finally{w.value=!1}},S=async()=>{if(!s.value||!s.value.id){p.value=[];return}k.value=!0,_.value=null;try{const e=await G(s.value.id);p.value=e}catch(e){console.error("Failed to fetch attachments:",e),_.value="Failed to load attachments."}finally{k.value=!1}},R=async e=>{if(!e){j.value=[];return}$.value=!0,A.value=null;try{const{data:t}=await axios.get(`/api/projects/${e}/sections/users`,{params:{type:"users"}}),c=Array.isArray(t==null?void 0:t.users)?t.users:Array.isArray(t)?t:(t==null?void 0:t.project_users)||[];j.value=c.map(u=>({id:u.id,name:u.name}))}catch(t){A.value="Failed to load users",console.error(t)}finally{$.value=!1}},M=g(()=>{var u;if(!s.value||!s.value.body_html)return((u=s.value)==null?void 0:u.body)||"";let e=s.value.body_html;const t=/src="cid:(.*?)"/g;return e=e.replace(t,(E,h)=>{const f=p.value.find(T=>T.cid===h);return f?`src="${f.path_url}"`:'src=""'}),new DOMParser().parseFromString(e,"text/html").body.innerHTML}),O=g(()=>{var e;if(!n.email||!((e=n.email.sender)!=null&&e.name))return"Unknown";if(n.email.type==="sent")return n.email.recipient_email}),P=()=>{m.value=!1},U=()=>{var e,t,c;m.value=!m.value,m.value&&((c=(t=(e=s.value)==null?void 0:e.conversation)==null?void 0:t.project)!=null&&c.id)&&R(s.value.conversation.project.id)};return B(()=>n.email,e=>{e&&(L(),m.value=!1)},{immediate:!0}),B(s,e=>{e&&e.id&&S()}),(e,t)=>{var c,u,E,h,f;return o.email?w.value?(r(),i("div",J,t[3]||(t[3]=[a("div",{class:"animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500"},null,-1)]))):s.value?(r(),i("div",K,[a("div",Q,[a("h2",W,d(s.value.subject),1),a("div",X," From: "+d(((u=(c=n.email)==null?void 0:c.sender)==null?void 0:u.name)||"Unknown"),1),n.email.type==="sent"?(r(),i("div",Y," To: "+d(O.value),1)):y("",!0),a("div",Z," Date: "+d(new Date((E=n.email)==null?void 0:E.created_at).toLocaleString()),1)]),a("div",ee,[a("div",te,[k.value?(r(),i("div",se,"Loading attachments...")):_.value?(r(),i("div",ae,d(_.value),1)):(r(),z(N,{key:2,attachments:p.value},null,8,["attachments"]))]),a("div",{class:"mt-4 sm:mt-0"},[a("button",{onClick:U,class:"inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"}," Create Tasks ")])]),t[6]||(t[6]=a("hr",{class:"my-4"},null,-1)),m.value?(r(),i("div",ne,[t[4]||(t[4]=a("h3",{class:"text-lg font-medium text-gray-900 mb-4"},"Create Tasks",-1)),H(V,{"email-id":s.value.id,"project-id":(f=(h=s.value.conversation)==null?void 0:h.project)==null?void 0:f.id,users:j.value,"users-loading":$.value,"users-error":A.value,onTasksSubmitted:P},null,8,["email-id","project-id","users","users-loading","users-error"])])):y("",!0),a("div",oe,[a("div",{innerHTML:M.value},null,8,re)]),s.value.rejection_reason?(r(),i("div",le,[a("div",ie,[t[5]||(t[5]=a("p",{class:"font-bold"},"Rejection Reason",-1)),a("p",null,d(s.value.rejection_reason),1)])])):y("",!0),a("div",ce,[D.value&&o.canApproveEmails?(r(),i("div",ue,[a("button",{onClick:t[0]||(t[0]=T=>e.$emit("edit",n.email)),class:"inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"},d(F.value),1),a("button",{onClick:t[1]||(t[1]=T=>e.$emit("reject",n.email)),class:"inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"}," Reject ")])):y("",!0)])])):y("",!0):(r(),i("div",I,t[2]||(t[2]=[a("p",{class:"text-gray-500"},"Select an email to view its details.",-1)])))}}},ye=Object.freeze(Object.defineProperty({__proto__:null,default:de},Symbol.toStringTag,{value:"Module"}));export{ye as E,de as _,fe as f,ge as m};
