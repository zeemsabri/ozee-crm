import{r as $,z as Qe,s as M,w as Z,i,o as r,g as y,t as _,b as s,e as d,f as pe,v as Ne,F as ae,j as oe,n as se,m as Q,M as lt,a as le,J as Ze,B as ze,h as u,a2 as nt,c as Le,q as rt,x as Fe,H as it,ab as dt,a0 as ut,a1 as Je,k as qe,d as ct}from"./app-1BkEvk7R.js";import{P as ye}from"./PrimaryButton-DH_yz1w4.js";import{_ as A,a as X,b as B}from"./InputError-moOwHBGM.js";import{_ as mt}from"./Checkbox-DvOSfDjP.js";import{a as Re}from"./SecondaryButton-DTb9YXmO.js";import{S as Ae,e as xe,s as Te}from"./AuthenticatedLayout-CiYBWSVz.js";const vt={key:0,class:"text-red-600 text-sm mb-4"},pt={key:1,class:"text-gray-500 text-sm mb-4"},yt={key:2},ft={class:"mb-4"},gt={class:"mb-4"},_t=["disabled"],bt=["value"],ht={class:"mb-4"},xt={class:"mt-2"},wt={class:"flex items-center mb-2"},kt=["for"],jt={key:0,class:"pl-6"},$t={class:"grid grid-cols-2 gap-4 mb-2"},Pt=["id","onUpdate:modelValue","disabled"],St={class:"mb-2"},It={key:0},Dt={class:"flex justify-between items-center mb-1"},Ct=["onClick"],Vt={class:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2"},Ut={class:"flex"},At=["onClick"],Rt={key:0},Tt={class:"mt-4"},Nt={key:1,class:"mt-2 flex items-center"},Ft={key:0,class:"mt-6 flex justify-end"},Et={__name:"ServicesAndPaymentForm",props:{projectId:{type:[Number,String],required:!0},paymentTypeOptions:{type:Array,required:!0},canManageProjectServicesAndPayments:{type:Boolean,required:!0},canViewProjectServicesAndPayments:{type:Boolean,required:!0}},emits:["updated"],setup(g,{emit:R}){const I=g,G=R,h=$({}),S=$(!1),N=$([...[{value:"Website Designing",label:"Website Designing"},{value:"SEO",label:"SEO"},{value:"Social Media",label:"Social Media"},{value:"Content Writing",label:"Content Writing"},{value:"Graphic Design",label:"Graphic Design"}]]),P=$(""),O=$(!1),w=Qe({services:[],service_details:[],total_amount:"",payment_type:"one_off"}),C=M(()=>{const m=w.services.filter(a=>{const l=T(a);return l&&l.frequency!=="monthly"});return m.length===0?!0:m.every(a=>j(a)===100)}),F=M(()=>!I.projectId||!I.canManageProjectServicesAndPayments||!C.value),Y=()=>{const m=P.value.trim();m&&!N.value.some(a=>a.label.toLowerCase()===m.toLowerCase())&&(N.value.push({value:m,label:m}),P.value="",O.value=!1)},J=async()=>{if(I.projectId){S.value=!0;try{const a=(await window.axios.get(`/api/projects/${I.projectId}/sections/services-payment`)).data;return w.services=a.services||[],w.service_details=a.service_details||[],w.total_amount=a.total_amount||"",w.payment_type=a.payment_type||"one_off",w.services.forEach(l=>{N.value.some(x=>x.value===l)||N.value.push({value:l,label:l})}),w.service_details.forEach(l=>{if(l.payment_breakdown&&!Array.isArray(l.payment_breakdown)){const x=l.payment_breakdown;l.payment_breakdown=[{label:"First",percentage:parseInt(x.first)||30},{label:"Second",percentage:parseInt(x.second)||30},{label:"Third",percentage:parseInt(x.third)||40}]}else(!l.payment_breakdown||l.payment_breakdown.length===0)&&(l.payment_breakdown=[{label:"Payment 1",percentage:100}])}),a}catch(m){return console.error("Error fetching services and payment data:",m),h.value.general="Failed to fetch services and payment data.",null}finally{S.value=!1}}},K=async()=>{h.value={},S.value=!0;try{const m={services:w.services,service_details:w.service_details,total_amount:w.total_amount,payment_type:w.payment_type},a=await window.axios.put(`/api/projects/${I.projectId}/sections/services-payment`,m);alert("Services and payment information updated successfully!"),G("updated")}catch(m){m.response&&m.response.status===422?h.value=m.response.data.errors:m.response&&m.response.data.message?h.value.general=m.response.data.message:(h.value.general="Failed to update services and payment information.",console.error("Error:",m))}finally{S.value=!1}},W=(m,a)=>{a?w.service_details.some(l=>l.service_id===m)||w.service_details.push({service_id:m,amount:"",frequency:"one_off",start_date:"",payment_breakdown:[{label:"Payment 1",percentage:100}]}):w.service_details=w.service_details.filter(l=>l.service_id!==m)},T=m=>{let a=w.service_details.find(l=>l.service_id===m);if(!a)a={service_id:m,amount:"",frequency:"one_off",start_date:"",payment_breakdown:[{label:"Payment 1",percentage:100}]},w.service_details.push(a);else if(a.payment_breakdown&&!Array.isArray(a.payment_breakdown)){const l=a.payment_breakdown;a.payment_breakdown=[{label:"First",percentage:parseInt(l.first)||30},{label:"Second",percentage:parseInt(l.second)||30},{label:"Third",percentage:parseInt(l.third)||40}]}else(!a.payment_breakdown||a.payment_breakdown.length===0)&&(a.payment_breakdown=[{label:"Payment 1",percentage:100}]);return a},j=m=>{const a=T(m);return!a.payment_breakdown||!Array.isArray(a.payment_breakdown)?0:a.payment_breakdown.reduce((l,x)=>l+(parseInt(x.percentage)||0),0)},V=m=>{const a=T(m);if(a.payment_breakdown||(a.payment_breakdown=[]),!Array.isArray(a.payment_breakdown)){const D=a.payment_breakdown;a.payment_breakdown=[{label:"First",percentage:parseInt(D.first)||30},{label:"Second",percentage:parseInt(D.second)||30},{label:"Third",percentage:parseInt(D.third)||40}]}const l=a.payment_breakdown.length;let x=0;if(l>0){const D=a.payment_breakdown[l-1];x=Math.floor(D.percentage/2),D.percentage-=x}else x=100;a.payment_breakdown.push({label:`Payment ${l+1}`,percentage:x})},k=(m,a)=>{const l=T(m);if(!l.payment_breakdown||!Array.isArray(l.payment_breakdown)||l.payment_breakdown.length<=1)return;const x=parseInt(l.payment_breakdown[a].percentage)||0;if(l.payment_breakdown.splice(a,1),x>0&&l.payment_breakdown.length>0){const D=a>0&&a<=l.payment_breakdown.length?a-1:0;l.payment_breakdown[D].percentage=(parseInt(l.payment_breakdown[D].percentage)||0)+x}l.payment_breakdown.forEach((D,re)=>{D.label=`Payment ${re+1}`})};return Z(()=>I.projectId,m=>{m&&J()},{immediate:!0}),(m,a)=>(r(),i("div",null,[h.value.general?(r(),i("div",vt,_(h.value.general),1)):y("",!0),S.value?(r(),i("div",pt,"Loading...")):(r(),i("div",yt,[s("div",ft,[d(A,{for:"total_amount",value:"Total Amount"}),d(X,{id:"total_amount",type:"number",step:"0.01",class:"mt-1 block w-full",modelValue:w.total_amount,"onUpdate:modelValue":a[0]||(a[0]=l=>w.total_amount=l),disabled:!g.canManageProjectServicesAndPayments},null,8,["modelValue","disabled"]),d(B,{message:h.value.total_amount?h.value.total_amount[0]:"",class:"mt-2"},null,8,["message"])]),s("div",gt,[d(A,{for:"payment_type",value:"Payment Type"}),pe(s("select",{id:"payment_type",class:"border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 rounded-md shadow-sm mt-1 block w-full","onUpdate:modelValue":a[1]||(a[1]=l=>w.payment_type=l),required:"",disabled:!g.canManageProjectServicesAndPayments},[(r(!0),i(ae,null,oe(g.paymentTypeOptions,l=>(r(),i("option",{key:l.value,value:l.value},_(l.label),9,bt))),128))],8,_t),[[Ne,w.payment_type]]),d(B,{message:h.value.payment_type?h.value.payment_type[0]:"",class:"mt-2"},null,8,["message"])]),s("div",ht,[d(A,{for:"services",value:"Services"}),s("div",xt,[(r(!0),i(ae,null,oe(N.value,l=>(r(),i("div",{key:l.value,class:"border p-3 mb-3 rounded"},[s("div",wt,[d(mt,{id:`service_${l.value}`,value:l.value,checked:w.services,"onUpdate:checked":[a[2]||(a[2]=x=>w.services=x),x=>W(l.value,x)],disabled:!g.canManageProjectServicesAndPayments},null,8,["id","value","checked","onUpdate:checked","disabled"]),s("label",{for:`service_${l.value}`,class:"ms-2 text-sm font-medium text-gray-700"},_(l.label),9,kt)]),(w.services||[]).includes(l.value)?(r(),i("div",jt,[s("div",$t,[s("div",null,[d(A,{for:`service_amount_${l.value}`,value:"Amount",class:"text-xs"},null,8,["for"]),d(X,{id:`service_amount_${l.value}`,type:"number",step:"0.01",placeholder:"Amount",class:"w-full",modelValue:T(l.value).amount,"onUpdate:modelValue":x=>T(l.value).amount=x,disabled:!g.canManageProjectServicesAndPayments},null,8,["id","modelValue","onUpdate:modelValue","disabled"])]),s("div",null,[d(A,{for:`service_frequency_${l.value}`,value:"Frequency",class:"text-xs"},null,8,["for"]),pe(s("select",{id:`service_frequency_${l.value}`,class:"border-gray-300 rounded-md w-full","onUpdate:modelValue":x=>T(l.value).frequency=x,disabled:!g.canManageProjectServicesAndPayments},a[6]||(a[6]=[s("option",{value:"monthly"},"Monthly",-1),s("option",{value:"one_off"},"One off",-1)]),8,Pt),[[Ne,T(l.value).frequency]])])]),s("div",St,[d(A,{for:`service_start_date_${l.value}`,value:"Start Date",class:"text-xs"},null,8,["for"]),d(X,{id:`service_start_date_${l.value}`,type:"date",class:"w-full",modelValue:T(l.value).start_date,"onUpdate:modelValue":x=>T(l.value).start_date=x,disabled:!g.canManageProjectServicesAndPayments},null,8,["id","modelValue","onUpdate:modelValue","disabled"])]),T(l.value).frequency!=="monthly"?(r(),i("div",It,[s("div",Dt,[d(A,{value:"Payment Breakdown (%)",class:"text-xs"}),g.canManageProjectServicesAndPayments?(r(),i("button",{key:0,type:"button",class:"text-xs text-blue-600 hover:text-blue-800",onClick:x=>V(l.value)}," + Add Payment ",8,Ct)):y("",!0)]),s("div",Vt,[(r(!0),i(ae,null,oe(T(l.value).payment_breakdown,(x,D)=>(r(),i("div",{key:D,class:"relative"},[d(A,{for:`service_payment_${D}_${l.value}`,value:x.label,class:"text-xs"},null,8,["for","value"]),s("div",Ut,[d(X,{id:`service_payment_${D}_${l.value}`,type:"text",inputmode:"numeric",pattern:"[0-9]*",min:"0",max:"100",class:"w-full",modelValue:x.percentage,"onUpdate:modelValue":re=>x.percentage=re,modelModifiers:{number:!0},onInput:re=>{x.percentage=Math.max(0,Math.min(100,parseInt(re.target.value)||0))},disabled:!g.canManageProjectServicesAndPayments},null,8,["id","modelValue","onUpdate:modelValue","onInput","disabled"]),g.canManageProjectServicesAndPayments&&T(l.value).payment_breakdown.length>1?(r(),i("button",{key:0,type:"button",class:"ml-1 text-red-500 hover:text-red-700",onClick:re=>k(l.value,D)},a[7]||(a[7]=[s("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor"},[s("path",{"fill-rule":"evenodd",d:"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z","clip-rule":"evenodd"})],-1)]),8,At)):y("",!0)])]))),128))]),s("div",{class:se(["text-xs mt-2",{"text-gray-500":j(l.value)===100,"text-red-500 font-bold":j(l.value)!==100}])},[Q(" Total: "+_(j(l.value))+"% ",1),j(l.value)!==100?(r(),i("span",Rt," (Total must be 100%) ")):y("",!0)],2)])):y("",!0)])):y("",!0)]))),128))]),s("div",Tt,[g.canManageProjectServicesAndPayments&&!O.value?(r(),i("button",{key:0,type:"button",class:"text-sm text-blue-600 hover:text-blue-800",onClick:a[3]||(a[3]=l=>O.value=!0)}," + Add New Service/Department ")):y("",!0),g.canManageProjectServicesAndPayments&&O.value?(r(),i("div",Nt,[d(X,{type:"text",class:"flex-grow mr-2",modelValue:P.value,"onUpdate:modelValue":a[4]||(a[4]=l=>P.value=l),placeholder:"New service/department name",onKeyup:lt(Y,["enter"])},null,8,["modelValue"]),d(ye,{onClick:Y},{default:le(()=>a[8]||(a[8]=[Q("Add",-1)])),_:1,__:[8]}),s("button",{type:"button",class:"ml-2 text-sm text-gray-500 hover:text-gray-700",onClick:a[5]||(a[5]=l=>{O.value=!1,P.value=""})}," Cancel ")])):y("",!0)]),d(B,{message:h.value.services?h.value.services[0]:"",class:"mt-2"},null,8,["message"])]),g.canManageProjectServicesAndPayments?(r(),i("div",Ft,[d(ye,{onClick:K,disabled:F.value,class:se({"opacity-25":F.value})},{default:le(()=>a[9]||(a[9]=[Q(" Update Services & Payment ",-1)])),_:1,__:[9]},8,["disabled","class"])])):y("",!0)]))]))}},z=$({}),Ot=localStorage.getItem("displayCurrency"),et=$(Ot||"USD");Z(et,g=>{localStorage.setItem("displayCurrency",g)});const Ke=async()=>{try{const g=await window.axios.get("/api/currency-rates");z.value=g.data,console.log("Fetched currency rates:",z.value)}catch(g){console.error("Failed to fetch currency rates:",g),z.value={PKR:.0034,AUD:.65,INR:.012,EUR:1.08,GBP:1.28,USD:1}}},te=(g,R="USD")=>{if(isNaN(g)||g==null)return"0.00";try{return new Intl.NumberFormat("en-US",{style:"currency",currency:R,minimumFractionDigits:2,maximumFractionDigits:2}).format(g)}catch(I){return console.warn(`Error formatting currency for ${g} ${R}:`,I),`${R} ${parseFloat(g).toFixed(2)}`}},je=(g,R,I)=>{if(isNaN(g)||g==null||!R||!I)return 0;if(R.toUpperCase()===I.toUpperCase())return Number(g);const G=z.value,h=G[R.toUpperCase()],S=G[I.toUpperCase()];if(!h||!S)return console.warn(`Missing conversion rates for: ${R} or ${I}. Cannot perform conversion.`),Number(g);const N=Number(g)*h/S;return Number(N.toFixed(2))},Mt={class:"p-6 bg-white rounded-lg shadow-xl"},Bt={key:0,class:"text-red-600 text-sm mb-4"},qt={key:1,class:"mb-6 p-4 bg-gray-50 rounded-md"},Lt={class:"mb-6"},zt={class:"flex justify-end items-center mb-4"},Gt={class:"grid grid-cols-1 md:grid-cols-3 gap-4"},Wt={class:"p-3 bg-blue-100 rounded-md"},Yt={class:"text-lg font-bold text-blue-800"},Jt={class:"p-3 bg-red-100 rounded-md"},Kt={class:"text-lg font-bold text-red-800"},Ht={class:"text-xs text-gray-500"},Xt={class:"p-3 bg-purple-100 rounded-md"},Qt={class:"text-lg font-bold text-purple-800"},Zt={class:"p-3 bg-green-100 rounded-md"},es={class:"text-lg font-bold text-green-800"},ts={class:"p-3 bg-yellow-100 rounded-md col-span-full md:col-span-1"},ss={class:"text-lg font-bold text-yellow-800"},as={class:"text-xs text-gray-500"},os={class:"p-3 bg-orange-100 rounded-md col-span-full md:col-span-1"},ls={class:"text-lg font-bold text-orange-900 mt-1"},ns={class:"text-xs text-gray-500"},rs={class:"p-3 bg-gray-100 rounded-md col-span-full md:col-span-1"},is={class:"text-lg font-bold mt-1 text-green-400"},ds={class:"p-3 bg-gray-100 rounded-md col-span-full md:col-span-1"},us={class:"text-lg font-bold text-red-400 mt-1"},cs={class:"grid grid-cols-1 gap-4 md:grid-cols-2"},ms={key:0},vs={key:1},ps={class:"mt-4 flex justify-end"},ys={key:2},fs={key:0,class:"space-y-3"},gs={key:1,class:"p-4 bg-gray-50 rounded-md text-gray-600 text-center"},_s={key:2,class:"space-y-4"},bs={class:"flex justify-between items-start mb-2"},hs={class:"flex-grow"},xs={class:"font-medium text-gray-900 text-lg"},ws={class:"text-xs text-gray-500 mt-1"},ks={class:"flex-shrink-0 text-right"},js={key:0,class:"text-sm text-gray-600"},$s={class:"flex justify-between items-end text-xs text-gray-600 mt-2 border-t border-gray-200 pt-2"},Ps={key:0,class:"block"},Ss={key:1,class:"block"},Is={key:2,class:"block mt-1 text-gray-500"},Ds={class:"flex space-x-2 mt-2"},Cs={key:0,class:"mt-4 p-4 bg-blue-50 rounded-md border border-blue-200"},Vs={class:"text-md font-medium text-gray-900 mb-4"},Us={class:"mb-4"},As={class:"mb-4"},Rs={class:"flex items-center"},Ts=["disabled"],Ns={class:"text-sm text-gray-700"},Fs={key:0,class:"mb-4"},Es={class:"flex justify-end space-x-2"},He=.25,Os={__name:"ProjectTransactions",props:{projectId:{type:[Number,String],required:!0},userProjectRole:{type:Object,default:()=>({})}},setup(g){const R=g,{canDo:I,canManage:G}=Ze(()=>R.projectId),h=G("project_expenses",R.userProjectRole),S=G("project_income",R.userProjectRole),ne=I("view_project_transactions",R.userProjectRole),N=$([]),P=$([]),O=$({}),w=$(""),C=$(!1),F=$(null),Y=$(""),J=$(!1),K=$({}),W=$(null),T=$(""),j=$({description:"",amount:"",currency:"PKR",user_id:null,hours_spent:"",type:"expense"}),V=et,k=[{value:"PKR",label:"PKR"},{value:"AUD",label:"AUD"},{value:"INR",label:"INR"},{value:"USD",label:"USD"},{value:"EUR",label:"EUR"},{value:"GBP",label:"GBP"}],m=[{value:"expense",label:"Expense"},{value:"income",label:"Income"},{value:"bonus",label:"Bonus"}],a=M(()=>P.value.map(p=>({value:p.id,label:p.name||"Unknown User"}))),l=()=>{const p=new Date,n=p.getFullYear(),f=String(p.getMonth()+1).padStart(2,"0"),U=String(p.getDate()).padStart(2,"0");return`${n}-${f}-${U}`},x=async()=>{if(!(!R.projectId||!ne.value))try{const p=await window.axios.get(`/api/projects/${R.projectId}/sections/clients-users`);P.value=p.data.users||[]}catch(p){w.value="Failed to fetch users.",console.error("Error fetching users:",p)}},D=async()=>{if(!(!R.projectId||!ne.value)){C.value=!0;try{(!z.value||Object.keys(z.value).length===0)&&await Ke();const p=await window.axios.get(`/api/projects/${R.projectId}/sections/transactions`);N.value=p.data}catch(p){w.value="Failed to fetch transactions.",console.error("Error fetching transactions:",p)}finally{C.value=!1}}},re=async()=>{var p;if(!h.value&&!S.value){xe("You do not have permission to manage transactions.");return}if(!j.value.amount||isNaN(j.value.amount)){O.value.amount=["Please enter a valid amount"];return}if(j.value.type==="expense"&&!h.value){xe("You do not have permission to add expenses.");return}if(j.value.type==="income"&&!S.value){xe("You do not have permission to add income.");return}if(j.value.type==="bonus"&&!h.value){xe("You do not have permission to add bonuses.");return}O.value={},w.value="",C.value=!0;try{const n={...j.value,amount:Number(j.value.amount)},f=await window.axios.post(`/api/projects/${R.projectId}/transactions`,n);await D(),L(),Te("Transaction saved successfully!")}catch(n){((p=n.response)==null?void 0:p.status)===422?O.value=n.response.data.errors:(w.value="Failed to save transaction.",console.error("Error saving transaction:",n))}finally{C.value=!1}},L=()=>{j.value={description:"",amount:"",currency:"PKR",user_id:null,hours_spent:"",type:"expense"}},Ee=async p=>{if(!h.value&&!S.value){xe("You do not have permission to delete transactions.");return}if(window.confirm("Are you sure you want to delete this transaction?"))try{const n=N.value[p].id;await window.axios.delete(`/api/projects/${R.projectId}/transactions/${n}`),await D(),Te("Transaction deleted successfully!")}catch(n){w.value="Failed to delete transaction.",console.error("Error deleting transaction:",n)}},ce=p=>{if(!h.value&&!S.value){xe("You do not have permission to manage transactions.");return}const n=N.value[p];F.value===n.id?(F.value=null,W.value=null,T.value=""):(W.value=p,F.value=n.id,Y.value=n.amount,J.value=!1,K.value={},T.value=l(),(Number(n.amount)===0||Math.abs(Number(Y.value)-Number(n.amount))<.01)&&(J.value=!0))};Z(Y,p=>{if(W.value!==null){const n=N.value[W.value];J.value=Math.abs(Number(p)-Number(n.amount))<.01}});const ve=()=>{F.value=null,W.value=null,Y.value="",J.value=!1,K.value={},T.value=""},fe=async()=>{var U;if(!h.value&&!S.value){xe("You do not have permission to manage transactions.");return}const p=W.value,n=N.value[p],f=Number(Y.value);if(!J.value&&(!Y.value||isNaN(f)||f<=0||f>Number(n.amount))){K.value.amount=["Please enter a valid amount between 0 and "+te(Number(n.amount),n.currency)];return}if(!T.value){K.value.date=["Please select a payment date."];return}K.value={},C.value=!0;try{const q=n.id,ge=J.value||Math.abs(f-Number(n.amount))<.01,me={payment_amount:ge?Number(n.amount):f,pay_in_full:ge,transaction_currency:n.currency,transaction_type:n.type,original_description:n.description,payment_date:T.value};await window.axios.patch(`/api/projects/${R.projectId}/transactions/${q}/process-payment`,me),await D(),Te("Payment processed successfully!"),ve()}catch(q){((U=q.response)==null?void 0:U.status)===422?K.value=q.response.data.errors:(w.value="Failed to process payment.",console.error("Error processing payment:",q))}finally{C.value=!1}},H=M(()=>!z.value||Object.keys(z.value).length===0?0:N.value.filter(p=>p.type==="income").reduce((p,n)=>p+je(parseFloat(n.amount||0),n.currency,V.value),0)),ue=M(()=>!z.value||Object.keys(z.value).length===0?0:N.value.filter(p=>p.type==="expense").reduce((p,n)=>p+je(parseFloat(n.amount||0),n.currency,V.value),0)),we=M(()=>!z.value||Object.keys(z.value).length===0?0:N.value.filter(p=>p.type==="bonus").reduce((p,n)=>p+je(parseFloat(n.amount||0),n.currency,V.value),0)),$e=M(()=>te(H.value,V.value)),Pe=M(()=>te(ue.value,V.value)),Oe=M(()=>te(we.value,V.value)),Me=M(()=>{if(!z.value||Object.keys(z.value).length===0)return te(0,V.value);const p=ue.value+we.value;return te(H.value-p,V.value)}),Se=M(()=>H.value===0?"0.00%":`${(ue.value/H.value*100).toFixed(2)}%`),Ie=M(()=>H.value===0?"0.00%":`${((ue.value+we.value)/H.value*100).toFixed(2)}%`),ke=M(()=>{if(H.value<=0)return te(0,V.value);const p=H.value*He;return te(p,V.value)}),De=M(()=>{const p=N.value.filter(f=>(f.type==="expense"||f.type==="bonus")&&f.is_paid&&f.payment_date);if(p.length===0)return"N/A";const n=p.reduce((f,U)=>new Date(U.payment_date)>new Date(f.payment_date)?U:f);return new Date(n.payment_date).toLocaleDateString()}),Ce=M(()=>{const p=N.value.filter(f=>f.type==="income"&&f.payment_date);if(p.length===0)return"N/A";const n=p.reduce((f,U)=>new Date(U.payment_date)>new Date(f.payment_date)?U:f);return new Date(n.payment_date).toLocaleDateString()});return ze(async()=>{const p=localStorage.getItem("displayCurrency");p&&(V.value=p),await Ke(),D(),x()}),Z([()=>R.projectId,V,z],()=>{R.projectId&&z.value&&Object.keys(z.value).length>0&&(D(),x())},{deep:!0}),Z(V,p=>{p&&localStorage.setItem("displayCurrency",p)},{deep:!0}),(p,n)=>{var f,U,q,ge,me,_e;return r(),i("div",Mt,[n[25]||(n[25]=s("h3",{class:"text-lg font-medium text-gray-900 mb-4"},"Project Transactions",-1)),w.value?(r(),i("div",Bt,_(w.value),1)):y("",!0),u(h)||u(S)?(r(),i("div",qt,[s("div",Lt,[s("div",zt,[n[10]||(n[10]=s("span",{class:"text-sm font-medium text-gray-700 mr-2"},"Currency:",-1)),d(Ae,{id:"transactions-display-currency-switcher",modelValue:u(V),"onUpdate:modelValue":n[0]||(n[0]=v=>nt(V)?V.value=v:null),options:k,"value-key":"value","label-key":"label",class:"w-24"},null,8,["modelValue"])]),n[19]||(n[19]=s("h4",{class:"text-md font-medium text-gray-700 mb-2"},"Summary",-1)),s("div",Gt,[s("div",Wt,[n[11]||(n[11]=s("p",{class:"text-sm text-gray-600"},"Total Income",-1)),s("p",Yt,_($e.value),1)]),s("div",Jt,[n[12]||(n[12]=s("p",{class:"text-sm text-gray-600"},"Total Expenses",-1)),s("p",Kt,_(Pe.value),1),s("p",Ht,"("+_(Se.value)+" of Income)",1)]),s("div",Xt,[n[13]||(n[13]=s("p",{class:"text-sm text-gray-600"},"Total Bonuses",-1)),s("p",Qt,_(Oe.value),1)]),s("div",Zt,[n[14]||(n[14]=s("p",{class:"text-sm text-gray-600"},"Balance",-1)),s("p",es,_(Me.value),1)]),s("div",ts,[n[15]||(n[15]=s("p",{class:"text-sm text-gray-600"},"Expense + Bonus",-1)),s("p",ss,_(u(te)(ue.value+we.value,u(V))),1),s("p",as,"("+_(Ie.value)+" of Income)",1)]),s("div",os,[n[16]||(n[16]=s("p",{class:"text-sm font-medium text-orange-800"},"Estimated Income Tax (AUD)",-1)),s("p",ls,_(ke.value),1),s("p",ns," (Based on "+_((He*100).toFixed(1))+"% of Total Income. This is an estimation.) ",1)]),s("div",rs,[n[17]||(n[17]=s("p",{class:"text-sm font-medium text-gray-800"},"Last Payment Received Date",-1)),s("p",is,_(Ce.value),1)]),s("div",ds,[n[18]||(n[18]=s("p",{class:"text-sm font-medium text-gray-800"},"Last Payment Sent Date",-1)),s("p",us,_(De.value),1)])])]),n[20]||(n[20]=s("h4",{class:"text-md font-medium text-gray-700 mb-4"},"Add Transaction",-1)),s("div",cs,[s("div",null,[d(A,{for:"description",value:"Description"}),d(X,{id:"description",modelValue:j.value.description,"onUpdate:modelValue":n[1]||(n[1]=v=>j.value.description=v),class:"mt-1 block w-full",disabled:C.value},null,8,["modelValue","disabled"]),d(B,{message:(f=O.value.description)==null?void 0:f[0],class:"mt-2"},null,8,["message"])]),s("div",null,[d(A,{for:"amount",value:"Amount"}),d(X,{id:"amount",type:"number",modelValue:j.value.amount,"onUpdate:modelValue":n[2]||(n[2]=v=>j.value.amount=v),class:"mt-1 block w-full",disabled:C.value},null,8,["modelValue","disabled"]),d(B,{message:(U=O.value.amount)==null?void 0:U[0],class:"mt-2"},null,8,["message"])]),s("div",null,[d(A,{for:"currency",value:"Currency"}),d(Ae,{id:"currency",modelValue:j.value.currency,"onUpdate:modelValue":n[3]||(n[3]=v=>j.value.currency=v),options:k,disabled:C.value},null,8,["modelValue","disabled"]),d(B,{message:(q=O.value.currency)==null?void 0:q[0],class:"mt-2"},null,8,["message"])]),s("div",null,[d(A,{for:"type",value:"Type"}),d(Ae,{id:"type",modelValue:j.value.type,"onUpdate:modelValue":n[4]||(n[4]=v=>j.value.type=v),options:m,disabled:C.value||!u(h)&&j.value.type==="expense"&&j.value.type!=="bonus"||!u(S)&&j.value.type==="income"},null,8,["modelValue","disabled"]),d(B,{message:(ge=O.value.type)==null?void 0:ge[0],class:"mt-2"},null,8,["message"])]),j.value.type==="expense"||j.value.type==="bonus"?(r(),i("div",ms,[d(A,{for:"user_id",value:"User"}),d(Ae,{id:"user_id",modelValue:j.value.user_id,"onUpdate:modelValue":n[5]||(n[5]=v=>j.value.user_id=v),options:a.value,disabled:C.value||!P.value.length,placeholder:"Select a user"},null,8,["modelValue","options","disabled"]),d(B,{message:(me=O.value.user_id)==null?void 0:me[0],class:"mt-2"},null,8,["message"])])):y("",!0),j.value.type==="expense"||j.value.type==="bonus"?(r(),i("div",vs,[d(A,{for:"hours_spent",value:"Hours Spent (Optional)"}),d(X,{id:"hours_spent",type:"number",modelValue:j.value.hours_spent,"onUpdate:modelValue":n[6]||(n[6]=v=>j.value.hours_spent=v),class:"mt-1 block w-full",disabled:C.value},null,8,["modelValue","disabled"]),d(B,{message:(_e=O.value.hours_spent)==null?void 0:_e[0],class:"mt-2"},null,8,["message"])])):y("",!0)]),s("div",ps,[d(ye,{onClick:re,disabled:C.value},{default:le(()=>[Q(_(C.value?"Saving...":"Save Transaction"),1)]),_:1},8,["disabled"])])])):y("",!0),u(ne)?(r(),i("div",ys,[n[24]||(n[24]=s("h4",{class:"text-md font-medium text-gray-700 mb-4"},"Transaction History",-1)),C.value?(r(),i("div",fs,n[21]||(n[21]=[s("div",{class:"h-4 bg-gray-200 rounded animate-pulse w-full"},null,-1),s("div",{class:"h-4 bg-gray-200 rounded animate-pulse w-5/6"},null,-1),s("div",{class:"h-4 bg-gray-200 rounded animate-pulse w-3/4"},null,-1)]))):N.value.length===0?(r(),i("div",gs," No transactions found for this project. ")):(r(),i("div",_s,[(r(!0),i(ae,null,oe(N.value,(v,be)=>{var he,ie,e;return r(),i("div",{key:v.id,class:se([{"bg-green-50 border-green-200":v.type==="income","bg-red-50 border-red-200":v.type==="expense","bg-purple-50 border-purple-200":v.type==="bonus","border-l-4":!0},"p-4 rounded-md shadow-sm transition-all duration-200 ease-in-out hover:shadow-md"])},[s("div",bs,[s("div",hs,[s("p",xs,_(v.description),1),s("p",ws,_(v.type==="income"?"Income":v.type==="expense"?"Expense":"Bonus")+" on "+_(new Date(v.created_at).toLocaleDateString()),1)]),s("div",ks,[s("p",{class:se(["text-lg font-bold",{"text-green-700":v.type==="income","text-red-700":v.type==="expense","text-purple-700":v.type==="bonus"}])},_(u(te)(v.amount,v.currency)),3),v.currency.toUpperCase()!==u(V).toUpperCase()?(r(),i("p",js," ("+_(u(te)(u(je)(v.amount,v.currency,u(V)),u(V)))+") ",1)):y("",!0),s("span",{class:se(["block text-xs mt-1",v.is_paid?"text-green-600":"text-red-600"])},_(v.is_paid?"Paid":"Unpaid"),3)])]),s("div",$s,[s("div",null,[v.user_id?(r(),i("span",Ps,"User: "+_(((he=P.value.find(de=>de.id===v.user_id))==null?void 0:he.name)||"Unknown"),1)):y("",!0),v.hours_spent?(r(),i("span",Ss,"Hours: "+_(v.hours_spent),1)):y("",!0),(v.type==="expense"||v.type==="bonus")&&H.value>0?(r(),i("span",Is,_((u(je)(v.amount,v.currency,u(V))/H.value*100).toFixed(2))+"% of Income ",1)):y("",!0)]),s("div",Ds,[!v.is_paid&&(u(h)||u(S))?(r(),Le(Re,{key:0,onClick:de=>ce(be),class:se({"text-green-600":v.type!=="income","text-blue-600":v.type==="income"})},{default:le(()=>[Q(_(v.type==="income"?"Receive":"Pay"),1)]),_:2},1032,["onClick","class"])):y("",!0),u(h)||u(S)?(r(),Le(Re,{key:1,onClick:de=>Ee(be),class:"text-red-600"},{default:le(()=>n[22]||(n[22]=[Q(" Delete ",-1)])),_:2,__:[22]},1032,["onClick"])):y("",!0)])]),F.value===v.id?(r(),i("div",Cs,[s("h4",Vs,_(v.type==="income"?"Record Receipt":"Make Payment"),1),s("div",Us,[d(A,{for:"payment_date",value:"Date"}),d(X,{id:"payment_date",type:"date",modelValue:T.value,"onUpdate:modelValue":n[7]||(n[7]=de=>T.value=de),class:"mt-1 block w-full",disabled:C.value},null,8,["modelValue","disabled"]),d(B,{message:(ie=K.value.date)==null?void 0:ie[0],class:"mt-2"},null,8,["message"])]),s("div",As,[s("label",Rs,[pe(s("input",{type:"checkbox","onUpdate:modelValue":n[8]||(n[8]=de=>J.value=de),class:"mr-2 rounded text-blue-600 focus:ring-blue-500",disabled:C.value},null,8,Ts),[[rt,J.value]]),s("span",Ns,_(v.type==="income"?"Receive in Full":"Pay in Full"),1)])]),J.value?y("",!0):(r(),i("div",Fs,[d(A,{for:"payment_amount",value:"Amount"}),d(X,{id:"payment_amount",type:"number",modelValue:Y.value,"onUpdate:modelValue":n[9]||(n[9]=de=>Y.value=de),class:"mt-1 block w-full",disabled:C.value,placeholder:"Enter partial "+(v.type==="income"?"receipt":"payment")+" amount (Max: "+u(te)(v.amount,v.currency)+")"},null,8,["modelValue","disabled","placeholder"]),d(B,{message:(e=K.value.amount)==null?void 0:e[0],class:"mt-2"},null,8,["message"])])),s("div",Es,[d(Re,{onClick:ve,disabled:C.value},{default:le(()=>n[23]||(n[23]=[Q(" Cancel ",-1)])),_:1,__:[23]},8,["disabled"]),d(ye,{onClick:fe,disabled:C.value},{default:le(()=>[Q(_(C.value?"Processing...":v.type==="income"?"Record Receipt":"Submit Payment"),1)]),_:2},1032,["disabled"])])])):y("",!0)],2)}),128))]))])):y("",!0)])}}},Ms={class:"mt-2"},Bs={class:"mb-2"},qs={key:0,class:"text-gray-500 text-sm mb-2"},Ls=["disabled"],zs={value:""},Gs=["value"],Ws={class:"flex-grow"},Ys=["value","onChange","disabled"],Js=["value"],Ks=["onClick"],Xe={__name:"MultiSelectWithRoles",props:{label:{type:String,required:!0},items:{type:Array,default:()=>[]},endpoint:{type:String,default:""},selectedItems:{type:Array,default:()=>[]},itemText:{type:String,default:"name"},itemSubtext:{type:String,default:"email"},itemValue:{type:String,default:"id"},roleOptions:{type:Array,default:()=>[]},roleType:{type:String,default:"application"},defaultRoleId:{type:Number,default:null},error:{type:String,default:""},placeholder:{type:String,default:"Select an item"},showRemoveButton:{type:Boolean,default:!0}},emits:["update:selectedItems"],setup(g,{emit:R}){const I=g,G=R,h=$([]),S=$([]),ne=$([]),N=$([]),P=$(!1),O=async()=>{if(!(I.roleOptions.length>0))try{const m=(await Fe.get(`/api/roles?type=${I.roleType}`)).data;ne.value=m.map(a=>({value:a.id,label:a.name}))}catch(k){console.error("Error fetching roles:",k)}},w=M(()=>ne.value.length>0?ne.value:I.roleOptions),C=()=>I.defaultRoleId?I.defaultRoleId:w.value.length>0?w.value[0].value:1,F=()=>{if(console.log("initializeFromProps called with selectedItems:",I.selectedItems),!I.selectedItems||I.selectedItems.length===0){h.value=[],S.value=[],console.log("Cleared selectedIds and selectedItemsWithRoles because props.selectedItems is empty");return}const k=new Set;I.selectedItems.forEach(m=>{const a=typeof m=="object"?m.id:m;if(!k.has(a)){if(k.add(a),!h.value.includes(a))h.value.push(a),typeof m=="object"&&m.role_id?S.value.push({id:a,role_id:m.role_id}):S.value.push({id:a,role_id:C()});else if(typeof m=="object"&&m.role_id){const l=S.value.find(x=>x.id===a);l&&(l.role_id=m.role_id)}}}),console.log("After initialization, selectedIds:",h.value),console.log("After initialization, selectedItemsWithRoles:",S.value)};Z(()=>I.selectedItems,(k,m)=>{console.log("selectedItems changed:",k),JSON.stringify(k)!==JSON.stringify(m)?(console.log("selectedItems changed significantly, reinitializing"),F()):console.log("selectedItems change was not significant, skipping reinitialization")},{deep:!0,immediate:!0}),Z(S,k=>{G("update:selectedItems",k)},{deep:!0});const Y=k=>{k&&!h.value.includes(k)&&(h.value.push(k),S.value.push({id:k,role_id:C()}))},J=k=>{h.value=h.value.filter(m=>m!==k),S.value=S.value.filter(m=>m.id!==k)},K=(k,m)=>{const a=S.value.find(l=>l.id===k);a&&(a.role_id=parseInt(m))},W=k=>V.value.find(m=>m[I.itemValue]===k),T=k=>{const m=S.value.find(a=>a.id===k);return m?m.role_id:C()},j=async()=>{if(I.endpoint){P.value=!0;try{const k=await Fe.get(I.endpoint);k.data&&Array.isArray(k.data)?N.value=k.data:k.data&&k.data.data&&Array.isArray(k.data.data)&&(N.value=k.data.data)}catch(k){console.error("Error fetching items from endpoint:",k)}finally{P.value=!1}}},V=M(()=>I.endpoint&&N.value.length>0?N.value:I.items);return ze(()=>{O(),F(),I.endpoint&&j()}),(k,m)=>(r(),i("div",null,[d(A,{value:g.label},null,8,["value"]),s("div",Ms,[s("div",Bs,[P.value?(r(),i("div",qs,"Loading...")):y("",!0),g.showRemoveButton?(r(),i("select",{key:1,class:"border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 rounded-md shadow-sm mt-1 block w-full",onChange:m[0]||(m[0]=a=>{const l=parseInt(a.target.value);Y(l),a.target.value=""}),disabled:P.value},[s("option",zs,_(g.placeholder),1),(r(!0),i(ae,null,oe(V.value.filter(a=>!h.value.includes(a[g.itemValue])),a=>(r(),i("option",{key:a[g.itemValue],value:a[g.itemValue]},_(a[g.itemText])+" ("+_(a[g.itemSubtext])+") ",9,Gs))),128))],40,Ls)):y("",!0)]),(r(!0),i(ae,null,oe(h.value,a=>{var l,x;return r(),i("div",{key:a,class:"flex items-center mb-1 p-2 border rounded"},[s("div",Ws,_((l=W(a))==null?void 0:l[g.itemText])+" ("+_((x=W(a))==null?void 0:x[g.itemSubtext])+") ",1),s("select",{class:"ms-2 border-gray-300 rounded-md",value:T(a),onChange:D=>K(a,D.target.value),disabled:!g.showRemoveButton},[(r(!0),i(ae,null,oe(w.value,D=>(r(),i("option",{key:D.value,value:D.value},_(D.label),9,Js))),128))],40,Ys),g.showRemoveButton?(r(),i("button",{key:0,type:"button",class:"ml-2 text-red-600",onClick:()=>J(a)}," Remove ",8,Ks)):y("",!0)])}),128))]),d(B,{message:g.error,class:"mt-2"},null,8,["message"])]))}},Hs={class:"p-6 w-full max-w-6xl mx-auto bg-white rounded-lg shadow-xl"},Xs={class:"flex justify-between items-center mb-4"},Qs={class:"text-lg font-medium text-gray-900"},Zs={key:0,class:"text-red-600 text-sm mb-4"},ea={key:1,class:"mb-4"},ta={key:0,class:"text-xs text-gray-500 mt-2 p-2 bg-gray-100 rounded"},sa={class:"font-bold"},aa={class:"mt-1"},oa={key:0},la={key:1},na={key:2},ra={key:0},ia={class:"list-disc ml-4"},da={key:0},ua={class:"mt-1"},ca={class:"border-b border-gray-200 mb-6"},ma={class:"flex -mb-px"},va={key:0},pa={class:"mb-4"},ya={class:"mb-4"},fa=["disabled"],ga={class:"mb-4"},_a={class:"mb-4"},ba={key:0,class:"mb-4"},ha={key:1,class:"mb-4"},xa={class:"mb-4"},wa=["disabled"],ka=["value"],ja={class:"mb-4"},$a=["disabled"],Pa=["value"],Sa={key:2,class:"mt-6 flex justify-end"},Ia={key:1},Da={key:0,class:"mb-4"},Ca={key:0,class:"mt-2 flex justify-end"},Va={key:1,class:"mt-2 text-green-600 text-sm"},Ua={key:2,class:"mt-2 text-red-600 text-sm"},Aa={class:"mb-4"},Ra=["disabled"],Ta={key:1,class:"mb-4"},Na={key:0,class:"mt-2 flex justify-end"},Fa={key:1,class:"mt-2 text-green-600 text-sm"},Ea={key:2,class:"mt-2 text-red-600 text-sm"},Oa={key:2},Ma={key:3},Ba={key:4},qa={class:"mb-4"},La={class:"mt-2"},za={key:0,class:"mb-4"},Ga={class:"mt-4"},Wa={key:0,class:"text-sm text-red-500 mt-2"},Ya={key:1,class:"mt-4"},Ja={class:"flex-grow"},Ka=["href"],Ha=["onClick"],Xa={key:5},Qa={class:"mb-4"},Za={class:"mt-2"},eo={key:0},to={class:"flex items-start mb-2"},so=["onUpdate:modelValue","readonly"],ao={key:1,class:"p-4 bg-gray-50 rounded-md text-gray-600 text-center"},oo={class:"mt-6 flex justify-end"},mo={__name:"ProjectForm",props:{show:{type:Boolean,required:!0},project:{type:Object,default:()=>({})},statusOptions:{type:Array,required:!0},departmentOptions:{type:Array,required:!0},sourceOptions:{type:Array,required:!0},clientRoleOptions:{type:Array,default:()=>[]},userRoleOptions:{type:Array,default:()=>[]},paymentTypeOptions:{type:Array,required:!0}},emits:["close","submit"],setup(g,{emit:R}){it();const I=$({}),G=g;Z(()=>G.project,t=>{I.value=t||{}},{immediate:!0});const h=M(()=>{var t;return((t=I.value)==null?void 0:t.id)||null}),{permissions:S,loading:ne,error:N}=dt(h),P=ut(I);M(()=>!!P.value),M(()=>{if(!P.value)return!1;const t=P.value.name,o=P.value.slug;return t==="Manager"||t==="Project Manager"||o==="manager"||o==="project-manager"});const{canDo:O,canView:w,canManage:C}=Ze(h),F=O("manage_projects",P),Y=O("create_projects",P),J=O("create_clients",P),K=O("upload_project_documents",P);C("project_expenses",P),C("project_income",P);const W=C("project_services_and_payments",P),T=O("add_project_notes",P),j=C("project_users",P),V=C("project_clients",P),k=C("project_basic_details",P),m=w("project_documents",P),a=w("project_services_and_payments",P),l=w("project_notes",P),x=w("project_users",P),D=w("project_clients",P),re=w("project_transactions",P),L=$("basic"),Ee=M(()=>D.value&&x.value?"Clients and Users":D.value?"Clients":x.value?"Users":"Clients and Users"),ce=t=>{if(!(t==="documents"&&!e.id)&&(L.value=t,e.id))switch(q.value=!0,t){case"basic":Se(e.id).finally(()=>{q.value=!1});break;case"client":D.value||V.value||x.value||j.value?Ie(e.id).finally(()=>{q.value=!1}):q.value=!1;break;case"services":a.value||W.value?ke(e.id).finally(()=>{q.value=!1}):q.value=!1;break;case"transactions":q.value=!1;break;case"documents":m.value?De(e.id).finally(()=>{q.value=!1}):q.value=!1;break;case"notes":l.value||T.value?Ce(e.id).finally(()=>{q.value=!1}):q.value=!1;break;default:q.value=!1;break}},ve=$([]),fe=$([]),H=$([]),ue=$([]),we=async()=>{try{const o=(await Fe.get("/api/roles?type=client")).data;ve.value=o.map(E=>({value:E.id,label:E.name}));const c=(await Fe.get("/api/roles?type=project")).data;fe.value=c.map(E=>({value:E.id,label:E.name}))}catch(t){console.error("Error fetching roles:",t)}},$e=async()=>{try{if(J.value){const t=await window.axios.get("/api/clients");H.value=t.data.data||t.data}else if(h.value){const t=await window.axios.get(`/api/projects/${h.value}/clients`);H.value=t.data}else{const t=await window.axios.get("/api/clients");H.value=t.data.data||t.data}}catch(t){console.error("Error fetching clients:",t),U.value="Failed to load clients."}},Pe=async()=>{try{if(Y.value){const t=await window.axios.get("/api/users");ue.value=t.data}else if(h.value){const t=await window.axios.get(`/api/projects/${h.value}/users`);ue.value=t.data}else{const t=await window.axios.get("/api/users");ue.value=t.data}}catch(t){console.error("Error fetching users:",t),U.value="Failed to load users."}},Oe=M(()=>ve.value.length>0?ve.value:G.clientRoleOptions),Me=M(()=>fe.value.length>0?fe.value:G.userRoleOptions),Se=async t=>{try{const b=(await window.axios.get(`/api/projects/${t}/sections/basic`)).data;return e.name=b.name||"",e.description=b.description||"",e.website=b.website||"",e.social_media_link=b.social_media_link||"",e.preferred_keywords=b.preferred_keywords||"",e.google_chat_id=b.google_chat_id||"",e.status=b.status||"active",e.project_type=b.project_type||"",e.source=b.source||"",e.google_drive_link=b.google_drive_link||"",b}catch(o){return console.error("Error fetching basic project data:",o),U.value="Failed to fetch basic project data.",null}},Ie=async t=>{try{const b=(await window.axios.get(`/api/projects/${t}/sections/clients-users`)).data;return b.clients&&b.clients.length>0&&(e.client_ids=b.clients.map(c=>{var ee;let E=((ee=c.pivot)==null?void 0:ee.role_id)||(ve.value.length>0?ve.value[0].value:1);return{id:c.id,role_id:E}})),b.users&&b.users.length>0&&(e.user_ids=b.users.map(c=>{var ee;let E=((ee=c.pivot)==null?void 0:ee.role_id)||(fe.value.length>0?fe.value[0].value:2);return{id:c.id,role_id:E}})),b.contract_details!==void 0&&(e.contract_details=b.contract_details||""),b}catch(o){return console.error("Error fetching clients and users data:",o),U.value="Failed to fetch clients and users data.",null}},ke=async t=>{try{const b=(await window.axios.get(`/api/projects/${t}/sections/services-payment`)).data;return e.services=b.services||[],e.service_details=b.service_details||[],e.total_amount=b.total_amount||"",e.payment_type=b.payment_type||"one_off",b}catch(o){return console.error("Error fetching services and payment data:",o),U.value="Failed to fetch services and payment data.",null}},De=async t=>{try{const b=(await window.axios.get(`/api/projects/${t}/sections/documents`)).data;return e.documents=b.documents||[],b}catch(o){return console.error("Error fetching documents data:",o),U.value="Failed to fetch documents data.",null}},Ce=async t=>{try{const b=(await window.axios.get(`/api/projects/${t}/sections/notes`)).data;return e.notes=b.map(c=>({content:c.content})),b}catch(o){return console.error("Error fetching notes data:",o),U.value="Failed to fetch notes data.",null}},p=async t=>{try{switch(await Se(t),L.value){case"client":(D.value||V.value||x.value||j.value)&&await Ie(t);break;case"services":(a.value||W.value)&&await ke(t);break;case"documents":m.value&&await De(t);break;case"notes":(l.value||T.value)&&await Ce(t);break}}catch(o){console.error("Error fetching project data:",o),U.value="Failed to fetch project data."}};ze(()=>{we(),$e(),Pe(),h.value&&Je(h.value).then(t=>{}).catch(t=>{})}),Z(h,(t,o)=>{t&&t!==o&&(Je(t).then(b=>{}).catch(b=>{}),Pe(),$e())});const n=R,f=$({}),U=$(""),q=$(!1),ge=$(!1),me=$(!1),_e=$(!1),v=$(""),be=$(!1),he=$(!1),ie=$(""),e=Qe({id:null,name:"",description:"",website:"",social_media_link:"",preferred_keywords:"",google_chat_id:"",logo:null,documents:[],client_ids:[],status:"active",project_type:"",services:[],service_details:[],source:"",total_amount:"",contract_details:"",google_drive_link:"",payment_type:"one_off",user_ids:[],notes:[]});Z(()=>G.show,t=>{t&&(e.client_ids||(e.client_ids=[]),e.user_ids||(e.user_ids=[]),e.id&&p(e.id))},{immediate:!0}),Z(()=>G.project,t=>{const o=e.id;e.id=t.id||null,o&&!e.id&&L.value==="documents"&&ce("basic"),e.name=t.name||"",e.description=t.description||"",e.website=t.website||"",e.social_media_link=t.social_media_link||"",e.preferred_keywords=t.preferred_keywords||"",e.google_chat_id=t.google_chat_id||"",e.logo=t.logo||null,e.documents=t.documents||[],e.client_ids=[],e.status=t.status||"active",e.project_type=t.project_type||"",e.services=t.services||[],e.service_details=t.service_details||[],e.source=t.source||"",e.total_amount=t.total_amount||"",e.contract_details=t.contract_details||"",e.google_drive_link=t.google_drive_link||"",e.payment_type=t.payment_type||"one_off",e.user_ids=[],e.notes=t.notes?t.notes.map(b=>({content:b.content})):[],f.value={},U.value=""},{immediate:!0});const de=async()=>{f.value={},U.value="";try{const t={name:e.name,description:e.description,website:e.website,social_media_link:e.social_media_link,preferred_keywords:e.preferred_keywords,google_chat_id:e.google_chat_id,status:e.status,project_type:e.project_type,source:e.source,google_drive_link:e.google_drive_link,user_ids:e.user_ids},o=e.logo;typeof o=="object"&&o!==null&&"name"in o&&delete t.logo;const b=await window.axios.post("/api/projects",t);e.id=b.data.id,typeof o=="object"&&o!==null&&"name"in o&&await Ye(o,e.id),n("submit",b.data)}catch(t){Ge(t,"Failed to create project.")}},tt=async()=>{f.value={},U.value="";try{const t={name:e.name,description:e.description,website:e.website,social_media_link:e.social_media_link,preferred_keywords:e.preferred_keywords,google_chat_id:e.google_chat_id,status:e.status,project_type:e.project_type,source:e.source,google_drive_link:e.google_drive_link},o=e.logo;typeof o=="object"&&o!==null&&"name"in o&&delete t.logo;const b=await window.axios.put(`/api/projects/${e.id}/sections/basic`,t);typeof o=="object"&&o!==null&&"name"in o&&await Ye(o,e.id),Te("Basic information updated successfully!")}catch(t){Ge(t,"Failed to update basic information.")}},Ge=(t,o)=>{t.response&&t.response.status===422?f.value=t.response.data.errors:t.response&&t.response.data.message?U.value=t.response.data.message:(U.value=o,console.error("Error:",t))},Ve=$(!1),Be=$({});Z(e,()=>{Object.keys(Be.value).length>0&&(Ve.value=!0)},{deep:!0}),Z(()=>G.show,t=>{t&&setTimeout(()=>{Be.value=JSON.parse(JSON.stringify(e)),Ve.value=!1},100)});const We=()=>{Ve.value?confirm("You have unsaved changes. Are you sure you want to close this form?")&&n("close"):n("close")},Ye=async(t,o)=>{try{const b=new FormData;b.append("logo",t);const c=await window.axios.post(`/api/projects/${o}/logo`,b,{headers:{"Content-Type":"multipart/form-data"}});return c.data&&c.data.logo&&(e.logo=c.data.logo),c}catch(b){console.error("Error uploading logo:",b)}},st=async()=>{if(!e.id){v.value="Please save the project first before saving clients.";return}if(!e.client_ids||e.client_ids.length===0){v.value="Please select at least one client to save.";return}me.value=!0,_e.value=!1,v.value="";try{const t=await window.axios.post(`/api/projects/${e.id}/attach-clients`,{client_ids:e.client_ids});_e.value=!0,setTimeout(()=>{_e.value=!1},3e3)}catch(t){t.response&&t.response.status===422?v.value="Validation error. Please check your input.":t.response&&t.response.data.message?v.value=t.response.data.message:(v.value="Failed to save clients.",console.error("Error saving clients:",t))}finally{me.value=!1}},at=async()=>{if(!e.id){ie.value="Please save the project first before saving users.";return}if(!e.user_ids||e.user_ids.length===0){ie.value="Please select at least one user to save.";return}be.value=!0,he.value=!1,ie.value="";try{const t=await window.axios.post(`/api/projects/${e.id}/attach-users`,{user_ids:e.user_ids});he.value=!0,setTimeout(()=>{he.value=!1},3e3)}catch(t){t.response&&t.response.status===422?ie.value="Validation error. Please check your input.":t.response&&t.response.data.message?ie.value=t.response.data.message:(ie.value="Failed to save users.",console.error("Error saving users:",t))}finally{be.value=!1}},ot=async()=>{if(!e.id){U.value="Please save the project first before uploading documents.";return}if(!e.documents||!e.documents.some(t=>typeof t=="object"&&t!==null&&"name"in t&&"size"in t&&"type"in t)){U.value="Please select documents to upload.";return}try{const t=new FormData;e.documents.filter(E=>typeof E=="object"&&E!==null&&"name"in E&&"size"in E&&"type"in E).forEach((E,ee)=>{t.append(`documents[${ee}]`,E)});const b=await window.axios.post(`/api/projects/${e.id}/documents`,t,{headers:{"Content-Type":"multipart/form-data"}});e.documents=b.data.documents||[],document.getElementById("documents").value="",alert("Documents uploaded successfully!");const c=JSON.parse(JSON.stringify(e));Be.value=c,Ve.value=!1}catch(t){t.response&&t.response.status===422?f.value=t.response.data.errors:t.response&&t.response.data.message?U.value=t.response.data.message:(U.value="Failed to upload documents.",console.error("Error uploading documents:",t))}};return(t,o)=>{var b;return r(),i("div",Hs,[s("div",Xs,[s("h2",Qs,_(e.id?"Edit Project":"Create New Project"),1),s("button",{onClick:We,class:"text-gray-400 hover:text-gray-500"},o[21]||(o[21]=[s("svg",{class:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)]))]),U.value?(r(),i("div",Zs,_(U.value),1)):y("",!0),h.value?(r(),i("div",ea,[ge.value?(r(),i("div",ta,[s("div",sa,"Project ID: "+_(h.value),1),s("div",null,_(u(P)?"Project Role: "+(((b=u(P).value)==null?void 0:b.name)||"None"):"No Project Role"),1),s("div",aa,[o[23]||(o[23]=s("div",{class:"font-semibold"},"Project Permissions:",-1)),u(ne)?(r(),i("div",oa,"Loading project permissions...")):u(N)?(r(),i("div",la,"Error loading project permissions")):u(S)?(r(),i("div",na,[Q(" Count: "+_(u(S).permissions?u(S).permissions.length:0)+" ",1),u(S).permissions&&u(S).permissions.length>0?(r(),i("div",ra,[o[22]||(o[22]=s("div",{class:"font-semibold"},"Permissions:",-1)),s("ul",ia,[(r(!0),i(ae,null,oe(u(S).permissions.slice(0,5),c=>(r(),i("li",{key:c.slug},_(c.name)+" ("+_(c.source)+") ",1))),128)),u(S).permissions.length>5?(r(),i("li",da," ... and "+_(u(S).permissions.length-5)+" more ",1)):y("",!0)])])):y("",!0)])):y("",!0)]),s("div",ua,"Can manage projects: "+_(u(F)?"Yes":"No"),1)])):y("",!0)])):y("",!0),s("div",ca,[s("nav",ma,[u(F)?(r(),i("button",{key:0,onClick:o[0]||(o[0]=c=>ce("basic")),class:se(["py-2 px-4 text-center border-b-2 font-medium text-sm",L.value==="basic"?"border-indigo-500 text-indigo-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"])}," Basic Information ",2)):y("",!0),u(D)||u(x)?(r(),i("button",{key:1,onClick:o[1]||(o[1]=c=>ce("client")),class:se(["py-2 px-4 text-center border-b-2 font-medium text-sm",L.value==="client"?"border-indigo-500 text-indigo-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"])},_(Ee.value),3)):y("",!0),e.id&&(u(W)||u(a))?(r(),i("button",{key:2,onClick:o[2]||(o[2]=c=>ce("services")),class:se(["py-2 px-4 text-center border-b-2 font-medium text-sm",L.value==="services"?"border-indigo-500 text-indigo-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"])}," Services & Payment ",2)):y("",!0),e.id&&u(re)?(r(),i("button",{key:3,onClick:o[3]||(o[3]=c=>ce("transactions")),class:se(["py-2 px-4 text-center border-b-2 font-medium text-sm",L.value==="transactions"?"border-indigo-500 text-indigo-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"])}," Transactions ",2)):y("",!0),e.id&&u(m)?(r(),i("button",{key:4,onClick:o[4]||(o[4]=c=>ce("documents")),class:se(["py-2 px-4 text-center border-b-2 font-medium text-sm",L.value==="documents"?"border-indigo-500 text-indigo-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"])}," Documents ",2)):y("",!0),e.id&&(u(T)||u(l))?(r(),i("button",{key:5,onClick:o[5]||(o[5]=c=>ce("notes")),class:se(["py-2 px-4 text-center border-b-2 font-medium text-sm",L.value==="notes"?"border-indigo-500 text-indigo-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"])}," Notes ",2)):y("",!0)])]),s("form",{onSubmit:o[20]||(o[20]=ct(()=>{},["prevent"]))},[L.value==="basic"?(r(),i("div",va,[s("div",pa,[d(A,{for:"name",value:"Project Name"}),d(X,{id:"name",type:"text",class:"mt-1 block w-full",modelValue:e.name,"onUpdate:modelValue":o[6]||(o[6]=c=>e.name=c),required:"",autofocus:"",disabled:!u(F)},null,8,["modelValue","disabled"]),d(B,{message:f.value.name?f.value.name[0]:"",class:"mt-2"},null,8,["message"])]),s("div",ya,[d(A,{for:"description",value:"Description"}),pe(s("textarea",{id:"description",class:"border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 rounded-md shadow-sm mt-1 block w-full","onUpdate:modelValue":o[7]||(o[7]=c=>e.description=c),disabled:!u(F)},null,8,fa),[[qe,e.description]]),d(B,{message:f.value.description?f.value.description[0]:"",class:"mt-2"},null,8,["message"])]),s("div",ga,[d(A,{for:"website",value:"Website"}),d(X,{id:"website",type:"url",class:"mt-1 block w-full",modelValue:e.website,"onUpdate:modelValue":o[8]||(o[8]=c=>e.website=c),disabled:!u(F)},null,8,["modelValue","disabled"]),d(B,{message:f.value.website?f.value.website[0]:"",class:"mt-2"},null,8,["message"])]),s("div",_a,[d(A,{for:"preferred_keywords",value:"Client Preferred Keywords"}),d(X,{id:"preferred_keywords",type:"text",class:"mt-1 block w-full",modelValue:e.preferred_keywords,"onUpdate:modelValue":o[9]||(o[9]=c=>e.preferred_keywords=c),disabled:!u(F)},null,8,["modelValue","disabled"]),d(B,{message:f.value.preferred_keywords?f.value.preferred_keywords[0]:"",class:"mt-2"},null,8,["message"])]),u(k)?(r(),i("div",ba,[d(A,{for:"google_chat_id",value:"Google Chat ID"}),d(X,{id:"google_chat_id",type:"text",class:"mt-1 block w-full",modelValue:e.google_chat_id,"onUpdate:modelValue":o[10]||(o[10]=c=>e.google_chat_id=c),disabled:!u(F)},null,8,["modelValue","disabled"]),d(B,{message:f.value.google_chat_id?f.value.google_chat_id[0]:"",class:"mt-2"},null,8,["message"])])):y("",!0),u(k)?(r(),i("div",ha,[d(A,{for:"google_drive_link",value:"Google Drive Link"}),d(X,{id:"google_drive_link",type:"text",class:"mt-1 block w-full",modelValue:e.google_drive_link,"onUpdate:modelValue":o[11]||(o[11]=c=>e.google_drive_link=c),disabled:!u(F)},null,8,["modelValue","disabled"]),d(B,{message:f.value.google_chat_id?f.value.google_chat_id[0]:"",class:"mt-2"},null,8,["message"])])):y("",!0),s("div",xa,[d(A,{for:"status",value:"Status"}),pe(s("select",{id:"status",class:"border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 rounded-md shadow-sm mt-1 block w-full","onUpdate:modelValue":o[12]||(o[12]=c=>e.status=c),required:"",disabled:!u(F)},[(r(!0),i(ae,null,oe(g.statusOptions,c=>(r(),i("option",{key:c.value,value:c.value},_(c.label),9,ka))),128))],8,wa),[[Ne,e.status]]),d(B,{message:f.value.status?f.value.status[0]:"",class:"mt-2"},null,8,["message"])]),s("div",ja,[d(A,{for:"source",value:"Source"}),pe(s("select",{id:"source",class:"border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 rounded-md shadow-sm mt-1 block w-full","onUpdate:modelValue":o[13]||(o[13]=c=>e.source=c),disabled:!u(F)},[o[24]||(o[24]=s("option",{value:"",disabled:""},"Select a Source",-1)),(r(!0),i(ae,null,oe(g.sourceOptions,c=>(r(),i("option",{key:c.value,value:c.value},_(c.label),9,Pa))),128))],8,$a),[[Ne,e.source]]),d(B,{message:f.value.source?f.value.source[0]:"",class:"mt-2"},null,8,["message"])]),u(F)?(r(),i("div",Sa,[e.id&&u(k)||!e.id?(r(),Le(ye,{key:0,onClick:o[14]||(o[14]=c=>e.id?tt():de()),disabled:!u(F)},{default:le(()=>[Q(_(e.id?"Update Basic Information":"Create Project"),1)]),_:1},8,["disabled"])):y("",!0)])):y("",!0)])):y("",!0),L.value==="client"?(r(),i("div",Ia,[u(D)?(r(),i("div",Da,[d(Xe,{label:"Clients",items:H.value,selectedItems:e.client_ids,"onUpdate:selectedItems":o[15]||(o[15]=c=>e.client_ids=c),roleOptions:Oe.value,roleType:"client",error:f.value.client_ids?f.value.client_ids[0]:"",placeholder:"Select a client to add",disabled:!u(V),readonly:!u(V)&&u(D),showRemoveButton:u(V)},null,8,["items","selectedItems","roleOptions","error","disabled","readonly","showRemoveButton"]),u(V)?(r(),i("div",Ca,[d(ye,{onClick:st,disabled:me.value},{default:le(()=>[Q(_(me.value?"Saving...":"Save Clients"),1)]),_:1},8,["disabled"])])):y("",!0),_e.value?(r(),i("div",Va," Clients saved successfully! ")):y("",!0),v.value?(r(),i("div",Ua,_(v.value),1)):y("",!0)])):y("",!0),s("div",Aa,[d(A,{for:"contract_details",value:"Contract Details"}),pe(s("textarea",{id:"contract_details",class:"border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 rounded-md shadow-sm mt-1 block w-full","onUpdate:modelValue":o[16]||(o[16]=c=>e.contract_details=c),disabled:!u(F)},null,8,Ra),[[qe,e.contract_details]]),d(B,{message:f.value.contract_details?f.value.contract_details[0]:"",class:"mt-2"},null,8,["message"])]),u(x)?(r(),i("div",Ta,[d(Xe,{label:"Assign Users",items:ue.value,selectedItems:e.user_ids,"onUpdate:selectedItems":o[17]||(o[17]=c=>e.user_ids=c),roleOptions:Me.value,roleType:"project",defaultRoleId:2,error:f.value.user_ids?f.value.user_ids[0]:"",placeholder:"Select a user to add",disabled:!u(j),readonly:!u(j)&&u(x),showRemoveButton:u(j)},null,8,["items","selectedItems","roleOptions","error","disabled","readonly","showRemoveButton"]),u(j)?(r(),i("div",Na,[d(ye,{onClick:at,disabled:be.value},{default:le(()=>[Q(_(be.value?"Saving...":"Save Users"),1)]),_:1},8,["disabled"])])):y("",!0),he.value?(r(),i("div",Fa," Users saved successfully! ")):y("",!0),ie.value?(r(),i("div",Ea,_(ie.value),1)):y("",!0)])):y("",!0)])):y("",!0),L.value==="services"?(r(),i("div",Oa,[d(Et,{projectId:e.id,departmentOptions:g.departmentOptions,paymentTypeOptions:g.paymentTypeOptions,canManageProjectServicesAndPayments:u(W),canViewProjectServicesAndPayments:u(a),onUpdated:o[18]||(o[18]=c=>ke(e.id))},null,8,["projectId","departmentOptions","paymentTypeOptions","canManageProjectServicesAndPayments","canViewProjectServicesAndPayments"])])):y("",!0),L.value==="transactions"&&u(re)?(r(),i("div",Ma,[d(Os,{projectId:e.id,userProjectRole:u(P).value},null,8,["projectId","userProjectRole"])])):y("",!0),L.value==="documents"?(r(),i("div",Ba,[s("div",qa,[d(A,{value:"Project Documents"}),s("div",La,[u(K)?(r(),i("div",za,[d(A,{for:"documents",value:"Upload Documents"}),s("input",{type:"file",id:"documents",onChange:o[19]||(o[19]=c=>{const E=Array.from(c.target.files);if(E.length>0){const ee=Array.isArray(e.documents)?e.documents.filter(Ue=>typeof Ue=="object"&&"path"in Ue):[];e.documents=[...ee,...E]}}),class:"mt-1 block w-full",multiple:"",accept:".pdf,.doc,.docx,.jpg,.png"},null,32),o[26]||(o[26]=s("p",{class:"text-sm text-gray-500 mt-1"},"Supported formats: PDF, DOC, DOCX, JPG, PNG",-1)),d(B,{message:f.value.documents?f.value.documents[0]:"",class:"mt-2"},null,8,["message"]),s("div",Ga,[d(ye,{type:"button",onClick:ot,disabled:!e.id||!e.documents||!e.documents.some(c=>typeof c=="object"&&c!==null&&"name"in c&&"size"in c&&"type"in c)},{default:le(()=>o[25]||(o[25]=[Q(" Upload Documents ",-1)])),_:1,__:[25]},8,["disabled"]),e.id?y("",!0):(r(),i("p",Wa," Please save the project first before uploading documents. "))])])):y("",!0),e.documents&&e.documents.length>0&&typeof e.documents[0]=="object"&&"path"in e.documents[0]?(r(),i("div",Ya,[o[27]||(o[27]=s("h3",{class:"font-medium text-gray-700 mb-2"},"Existing Documents",-1)),(r(!0),i(ae,null,oe(e.documents,(c,E)=>(r(),i("div",{key:E,class:"flex items-center mb-2 p-2 border rounded"},[s("div",Ja,[s("a",{href:"/storage/"+c.path,target:"_blank",class:"text-blue-600 hover:underline"},_(c.filename),9,Ka)]),u(K).value?(r(),i("button",{key:0,type:"button",class:"ml-2 text-red-600",onClick:()=>{e.documents=e.documents.filter((ee,Ue)=>Ue!==E)}}," Remove ",8,Ha)):y("",!0)]))),128))])):y("",!0),o[28]||(o[28]=s("div",{class:"mt-4"},[s("p",{class:"text-sm text-gray-500"}," Documents will be uploaded to the project's Google Drive folder. ")],-1))])])])):y("",!0),L.value==="notes"?(r(),i("div",Xa,[s("div",Qa,[d(A,{value:"Notes"}),s("div",Za,[e.notes&&e.notes.length>0?(r(),i("div",eo,[(r(!0),i(ae,null,oe(e.notes,(c,E)=>(r(),i("div",{key:E,class:"mb-4"},[s("div",to,[pe(s("textarea",{"onUpdate:modelValue":ee=>c.content=ee,readonly:!u(T),placeholder:"Note Content",class:"border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 rounded-md shadow-sm mt-1 block w-full h-32"},null,8,so),[[qe,c.content]])])]))),128))])):(r(),i("div",ao," No notes found for this project. "))]),d(B,{message:f.value.notes?f.value.notes[0]:"",class:"mt-2"},null,8,["message"])])])):y("",!0),s("div",oo,[d(Re,{onClick:We},{default:le(()=>o[29]||(o[29]=[Q("Close",-1)])),_:1,__:[29]})])],32)])}}};export{mo as _,je as a,Ke as b,z as c,et as d,te as f};
