import{_ as G,r as g,E as J,w as A,H as z,i as a,g as _,o as s,b as e,t as m,m as H,f as K,k as Q,F as W,j as X}from"./app-ejp7RTek.js";const ee={key:0,class:"fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4"},te={class:"bg-white rounded-lg shadow-xl w-full h-full max-w-6xl max-h-[90vh] flex flex-col relative"},le={class:"flex justify-between items-center p-4 border-b border-gray-200"},oe={class:"text-xl font-semibold text-gray-800 truncate pr-10"},ae={class:"flex-1 overflow-hidden flex flex-col lg:flex-row"},se={class:"flex-1 p-4 bg-gray-50 overflow-auto flex items-center justify-center"},re={key:0,class:"w-full h-full flex items-center justify-center"},ie=["src"],ne={key:1,class:"text-center text-gray-600 p-8"},de=["href"],ce={key:1,class:"p-4 text-gray-700 bg-white rounded-lg shadow-md max-w-prose overflow-auto max-h-full"},ue={class:"whitespace-pre-wrap"},ve={key:2,class:"text-center text-gray-600 p-8"},be={class:"lg:w-96 p-4 border-l border-gray-200 flex flex-col"},me={class:"space-y-3 mb-4"},fe=["disabled"],ge={key:0},pe={key:1},ye=["disabled"],xe={key:0},he={key:1},we=["disabled"],_e={key:0},ke={key:1},Ae={key:0,class:"mb-3"},Ce={class:"mb-1"},je={class:"text-xs text-gray-500"},qe={key:1,class:"mt-4 pt-4 border-t border-gray-200"},Re={class:"font-semibold text-blue-700"},Se={class:"text-xs text-gray-500 mt-1"},Te={key:0,class:"ml-2 text-gray-400"},Oe={key:2,class:"text-center text-gray-500"},Me={__name:"DeliverablViewerModal",props:{isOpen:{type:Boolean,required:!0},deliverable:{type:Object,default:null},initialAuthToken:{type:String,required:!0},projectId:{type:[String,Number],required:!0}},emits:["update:isOpen","deliverable-action-success"],setup(t,{emit:F}){const n=t,p=F,r=g(""),y=g(null),d=g(!1),u=g([]),x=g(null),{showModal:v}=J("modalService");A(()=>n.deliverable,l=>{var o;l&&(r.value=((o=l.client_interaction)==null?void 0:o.feedback_text)||"",u.value=[...l.comments||[]])},{immediate:!0}),A(()=>n.isOpen,l=>{l&&n.deliverable?($(),z(()=>{C()})):l||(r.value="",y.value=null,d.value=!1,u.value=[])}),A(u,()=>{z(()=>{C()})},{deep:!0});const k=()=>{p("update:isOpen",!1)},h=async(l,o,c=null)=>{y.value=null,d.value=!0;try{const i=await fetch(`/api/client-api/deliverables/${n.deliverable.id}/${l}`,{method:o,headers:{Authorization:`Bearer ${n.initialAuthToken}`,"Content-Type":"application/json",Accept:"application/json"},body:c?JSON.stringify(c):null}),f=await i.json();if(!i.ok){const w=f.errors?Object.values(f.errors).flat().join(`
`):f.message||"API request failed.";throw new Error(w)}return f}catch(i){throw console.error(`Error during API call to ${l}:`,i),y.value=i.message||"An unexpected error occurred.",v("Error",y.value,"alert"),i}finally{d.value=!1}},$=async()=>{if(n.deliverable&&(!n.deliverable.client_interaction||!n.deliverable.client_interaction.read_at))try{await h("mark-read","POST"),p("deliverable-action-success")}catch(l){console.error("Error marking deliverable as read:",l)}},U=async()=>{v("Confirm Approval","Are you sure you want to approve this deliverable? This action cannot be undone easily.","confirm",async()=>{try{await h("approve","POST",{feedback_text:r.value}),v("Success","Deliverable approved successfully!","alert"),p("deliverable-action-success",n.deliverable.id,"approve"),k()}catch{}})},V=async()=>{if(!r.value.trim()){v("Feedback Required","Please provide detailed feedback for requesting revisions.","alert");return}v("Confirm Revisions","Are you sure you want to request revisions for this deliverable? Your feedback will be sent to the team.","confirm",async()=>{try{await h("request-revisions","POST",{feedback_text:r.value}),v("Success","Revision request sent successfully!","alert"),p("deliverable-action-success"),k()}catch{}})},Y=async()=>{if(!r.value.trim()){v("Comment Required","Please type a comment before submitting.","alert");return}try{const l=await h("comments","POST",{comment_text:r.value});v("Success","Comment added successfully!","alert"),u.value.push(l.comment),r.value=""}catch{}},C=()=>{x.value&&(x.value.scrollTop=x.value.scrollHeight)},Z=(l,o)=>{if(!l)return null;if(l.includes("drive.google.com/file/d/")){const c=l.match(/\/d\/([a-zA-Z0-9_-]+)/);if(c&&c[1])return`https://drive.google.com/uc?export=view&id=${c[1]}`}return(o==="google_doc"||o==="report"||l.includes("docs.google.com")||l.includes(".pdf"))&&l.includes("docs.google.com")?l.replace(/\/edit(\?usp=[a-zA-Z0-9]+)?/,"/preview").replace(/\/view(\?usp=[a-zA-Z0-9]+)?/,"/preview"):l};return(l,o)=>{var c,i,f,w,j,q,R,S,T,O,M,D,E,N,P,B,I;return t.isOpen&&t.deliverable?(s(),a("div",ee,[e("div",te,[e("div",le,[e("h3",oe,"Review: "+m((c=t.deliverable)==null?void 0:c.title),1),e("button",{onClick:k,class:"text-gray-500 hover:text-gray-800 text-3xl transition-colors leading-none","aria-label":"Close"},"Ã—")]),e("div",ae,[e("div",se,[t.deliverable.content_url?(s(),a("div",re,[["blog_post","report","contract_draft","proposal","social_media_post","design_mockup"].includes(t.deliverable.type)||t.deliverable.content_url.includes("docs.google.com")||t.deliverable.content_url.includes(".pdf")?(s(),a("iframe",{key:0,src:Z(t.deliverable.content_url,t.deliverable.type),class:"w-full h-full border-0 rounded-lg shadow-md",allowfullscreen:"",frameborder:"0",allow:"autoplay",sandbox:"allow-forms allow-modals allow-popups allow-popups-to-escape-sandbox allow-scripts allow-same-origin"},null,8,ie)):(s(),a("div",ne,[o[2]||(o[2]=e("p",{class:"text-lg mb-2"},"Unsupported content type or unable to embed:",-1)),e("a",{href:t.deliverable.content_url,target:"_blank",class:"text-blue-600 hover:underline font-semibold"},o[1]||(o[1]=[H(" Open in New Tab ",-1),e("svg",{class:"inline-block w-4 h-4 ml-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"})],-1)]),8,de)]))])):t.deliverable.content_text?(s(),a("div",ce,[o[3]||(o[3]=e("h4",{class:"font-bold text-lg mb-2"},"Text Content:",-1)),e("p",ue,m(t.deliverable.content_text),1)])):(s(),a("div",ve,o[4]||(o[4]=[e("p",null,"No preview available for this deliverable.",-1)])))]),e("div",be,[o[7]||(o[7]=e("h4",{class:"text-lg font-semibold mb-3 text-gray-800"},"Your Feedback / General Comment:",-1)),K(e("textarea",{"onUpdate:modelValue":o[0]||(o[0]=b=>r.value=b),placeholder:"Leave your comments here...",rows:"4",class:"w-full p-2 border border-gray-300 rounded-lg mb-4 focus:ring-blue-500 focus:border-blue-500 resize-y"},null,512),[[Q,r.value]]),e("div",me,[e("button",{onClick:U,class:"w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",disabled:d.value||((f=(i=t.deliverable)==null?void 0:i.client_interaction)==null?void 0:f.approved_at)||((j=(w=t.deliverable)==null?void 0:w.client_interaction)==null?void 0:j.rejected_at)||((q=t.deliverable)==null?void 0:q.status)==="approved"},[d.value&&!((S=(R=t.deliverable)==null?void 0:R.client_interaction)!=null&&S.approved_at)?(s(),a("span",ge,"Approving...")):(s(),a("span",pe,"Approve"))],8,fe),e("button",{onClick:V,class:"w-full bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",disabled:d.value||!r.value.trim()||((O=(T=t.deliverable)==null?void 0:T.client_interaction)==null?void 0:O.approved_at)||((D=(M=t.deliverable)==null?void 0:M.client_interaction)==null?void 0:D.rejected_at)||((E=t.deliverable)==null?void 0:E.status)==="approved"},[d.value&&!((P=(N=t.deliverable)==null?void 0:N.client_interaction)!=null&&P.revisions_requested_at)?(s(),a("span",xe,"Requesting Revisions...")):(s(),a("span",he,"Request Revisions"))],8,ye),e("button",{onClick:Y,class:"w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",disabled:d.value||!r.value.trim()},[d.value?(s(),a("span",_e,"Adding Comment...")):(s(),a("span",ke,"Add Comment"))],8,we)]),o[8]||(o[8]=e("h4",{class:"text-lg font-semibold mb-3 text-gray-800 mt-auto"},"Comments History:",-1)),e("div",{ref_key:"commentsHistoryRef",ref:x,class:"bg-gray-100 p-3 rounded-lg flex-1 overflow-y-auto text-sm text-gray-600"},[t.deliverable&&t.deliverable.client_interaction&&t.deliverable.client_interaction.feedback_text?(s(),a("div",Ae,[o[5]||(o[5]=e("p",{class:"font-bold text-gray-800"},"Your Last Action Feedback:",-1)),e("p",Ce,m(t.deliverable.client_interaction.feedback_text),1),e("p",je," ("+m(new Date(t.deliverable.client_interaction.updated_at).toLocaleString())+") ",1)])):_("",!0),u.value&&u.value.length>0?(s(),a("div",qe,[o[6]||(o[6]=e("p",{class:"font-bold text-gray-800 mb-2"},"All Client Comments:",-1)),(s(!0),a(W,null,X(u.value,b=>{var L;return s(),a("div",{key:b.id,class:"mb-3 p-2 bg-white rounded-lg shadow-sm"},[e("p",Re,m(((L=b.client)==null?void 0:L.name)||"Client"),1),e("p",null,m(b.comment_text),1),e("p",Se,[H(m(new Date(b.created_at).toLocaleString())+" ",1),b.context?(s(),a("span",Te,"("+m(b.context)+")",1)):_("",!0)])])}),128))])):!((I=(B=t.deliverable)==null?void 0:B.client_interaction)!=null&&I.feedback_text)&&u.value.length===0?(s(),a("p",Oe," No feedback or comments yet for this deliverable. ")):_("",!0)],512)])])])])):_("",!0)}}},Ee=G(Me,[["__scopeId","data-v-abb2c44e"]]);export{Ee as default};
