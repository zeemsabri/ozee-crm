import{u as F}from"./workflowStore--NuplNyD.js";import{r as C,f as P,Q as D,c as k,a as v,o as m,b as y,g as W,i as M,k as I,v as H,x as z,F as N,l as B,t as O,Y as j,n as U}from"./app-BeWHP9Dz.js";const V=["disabled"],G={class:"p-2 border-b"},X={class:"px-3 py-1.5 text-[11px] font-semibold uppercase tracking-wide text-gray-500 bg-gray-50"},Y=["onClick"],q={key:1,class:"px-3 py-2 text-xs text-gray-500"},Q={__name:"DataTokenPicker",props:{groups:{type:Array,default:()=>[]},placeholder:{type:String,default:""},disabled:{type:Boolean,default:!1},maxHeight:{type:String,default:"300px"},minWidth:{type:[String,Number],default:320},maxPanelWidth:{type:[String,Number],default:480}},emits:["select"],setup(b,{emit:R}){const c=b,L=R,f=C(!1),g=C(null),w=C(null),h=C({top:0,left:0,width:0}),x=C(""),S=s=>{if(typeof s=="number")return s;const e=parseInt(String(s).replace("px",""));return isNaN(e)?0:e};function r(){c.disabled||(f.value=!f.value,U(()=>l()))}function l(){const s=g.value;if(!s)return;const e=s.getBoundingClientRect(),t=8,o=window.innerWidth||document.documentElement.clientWidth,d=Math.max(e.width,S(c.minWidth)),i=Math.min(S(c.maxPanelWidth),o-t*2),n=Math.min(Math.max(d,S(c.minWidth)),i);let a=e.left+window.scrollX;a+n+t>o+window.scrollX&&(a=o+window.scrollX-n-t,a<t&&(a=t)),h.value={top:e.bottom+window.scrollY,left:a,width:n}}function u(){f.value&&l()}function p(s){const e=g.value&&g.value.contains(s.target),t=w.value&&w.value.contains(s.target);!e&&!t&&(f.value=!1)}P(()=>{window.addEventListener("scroll",u,!0),window.addEventListener("resize",u),document.addEventListener("click",p)}),D(()=>{window.removeEventListener("scroll",u,!0),window.removeEventListener("resize",u),document.removeEventListener("click",p)}),k(()=>{const s=[];return(c.groups||[]).forEach((e,t)=>{(e.fields||[]).forEach((o,d)=>{s.push({groupIndex:t,itemIndex:d,group:e.name||"Data",label:o.label,value:o.value})})}),s});const _=k(()=>{const s=x.value.trim().toLowerCase();if(!s)return c.groups;const e=[];return(c.groups||[]).forEach(t=>{const o=(t.fields||[]).filter(d=>String(d.label||"").toLowerCase().includes(s));o.length&&e.push({name:t.name,fields:o})}),e});function E(s){L("select",s),f.value=!1}return(s,e)=>(m(),v("div",{class:"relative inline-block",ref_key:"triggerRef",ref:g},[y("button",{type:"button",onClick:r,disabled:b.disabled,"aria-label":"Insert data",class:"inline-flex items-center justify-center rounded-full border border-gray-300 bg-white p-1.5 text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-60"},e[1]||(e[1]=[y("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-4 w-4",viewBox:"0 0 20 20",fill:"currentColor"},[y("path",{"fill-rule":"evenodd",d:"M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z","clip-rule":"evenodd"})],-1)]),8,V),(m(),W(j,{to:"body"},[f.value?(m(),v("div",{key:0,ref_key:"portalRef",ref:w,class:"fixed z-[9999] bg-white rounded-md shadow-xl ring-1 ring-black ring-opacity-5",style:I({top:h.value.top+"px",left:h.value.left+"px",width:h.value.width+"px",maxWidth:"min(480px, 96vw)"})},[y("div",G,[H(y("input",{type:"text","onUpdate:modelValue":e[0]||(e[0]=t=>x.value=t),placeholder:"Search fields...",class:"w-full border border-gray-200 rounded px-2 py-1 text-xs focus:ring-indigo-500 focus:border-indigo-500"},null,512),[[z,x.value]])]),y("div",{class:"max-h-[calc(100vh-180px)] overflow-auto",style:I({maxHeight:b.maxHeight})},[_.value&&_.value.length?(m(!0),v(N,{key:0},B(_.value,t=>(m(),v("div",{key:t.name,class:"py-1"},[y("div",X,O(t.name),1),(m(!0),v(N,null,B(t.fields||[],o=>(m(),v("button",{key:o.value,type:"button",class:"w-full text-left px-3 py-2 text-sm hover:bg-gray-50",onClick:d=>E(o.value)},O(o.label),9,Y))),128))]))),128)):(m(),v("div",q,"No data available"))],4)],4)):M("",!0)]))],512))}},Z={__name:"DataTokenInserter",props:{allStepsBefore:{type:Array,default:()=>[]},loopContextSchema:{type:Object,default:null},inferLoopFromNearest:{type:Boolean,default:!0}},emits:["insert"],setup(b,{emit:R}){const c=b,L=R,f=F(),g=k(()=>f.automationSchema||[]);function w(r){if(!r||typeof r!="string")return"";let l=r.toLowerCase();if(l==="id")return"ID";l.endsWith("_id")&&(l=l.slice(0,-3)),l=l.replace(/[_-]+/g," ");let u=l.replace(/\b\w/g,p=>p.toUpperCase());return u=u.replace(/\bId\b/g,"ID").replace(/\bUrl\b/g,"URL"),u}const h=k(()=>{var _,E,s;const r=[];let l=c.loopContextSchema;const u=e=>{const t=String((e==null?void 0:e.type)||"").toLowerCase(),o=String((e==null?void 0:e.itemType)||"").toLowerCase();return t==="array of objects"||t==="array"&&o==="object"};if(!l&&c.inferLoopFromNearest){const e=[...c.allStepsBefore].reverse().find(t=>{var o;return t.step_type==="FOR_EACH"&&((o=t.step_config)==null?void 0:o.sourceArray)});if(e){const t=e.step_config.sourceArray,o=typeof t=="string"?t.match(/{{step_(\w+)\.(.+)}}/):null;if(o){const d=o[1],i=o[2],n=c.allStepsBefore.find(a=>String(a.id)===String(d));if((n==null?void 0:n.step_type)==="AI_PROMPT"){const a=(((_=n.step_config)==null?void 0:_.responseStructure)||[]).find($=>$.name===i);u(a)&&(l={name:"Loop Item",columns:a.schema||[]})}if(!l&&(n==null?void 0:n.step_type)==="FETCH_RECORDS"&&i==="records"){const a=(E=n.step_config)==null?void 0:E.model,$=g.value.find(T=>T.name===a);$&&(l={name:"Loop Item",columns:($.columns||[]).map(A=>typeof A=="string"?{name:A}:A)})}}}}l&&Array.isArray(l.columns)&&(r.push({name:"Current Loop Item (from For Each)",fields:l.columns.filter(e=>!!(e&&e.name)).map(e=>({label:e.name,value:`{{loop.item.${e.name}}}`}))}),r.push({name:"Loop Details",fields:[{label:"index",value:"{{loop.index}}"},{label:"is_first",value:"{{loop.is_first}}"},{label:"is_last",value:"{{loop.is_last}}"}]}));const p=c.allStepsBefore.find(e=>e.step_type==="TRIGGER");if(p&&((s=p.step_config)!=null&&s.model)){const e=g.value.find(t=>t.name===p.step_config.model);e&&r.push({name:`Trigger: ${p.step_config.model}`,fields:e.columns.map(t=>{const o=typeof t=="string"?t:t.name||"";return{label:typeof t=="string"?w(t):t.label||t.name||"",value:`{{trigger.${p.step_config.model.toLowerCase()}.${o}}}`}})})}return c.allStepsBefore.forEach((e,t)=>{var o,d;if(e.step_type==="AI_PROMPT"&&((d=(o=e.step_config)==null?void 0:o.responseStructure)==null?void 0:d.length)>0){const i=[];(e.step_config.responseStructure||[]).forEach(n=>{i.push({label:n.name,value:`{{step_${e.id}.${n.name}}}`}),u(n)&&Array.isArray(n.schema)&&n.schema.forEach(a=>{a!=null&&a.name&&i.push({label:`- ${a.name}`,value:`{{step_${e.id}.${n.name}.${a.name}}}`})})}),r.push({name:`Step ${t+1}: AI Response`,fields:i})}if(e.step_type==="FETCH_RECORDS"){const i=[{label:"records (array)",value:`{{step_${e.id}.records}}`},{label:"count",value:`{{step_${e.id}.count}}`}],n=e.step_config&&e.step_config.model?e.step_config.model:null,a=`Step ${t+1}: Fetch Records`+(n?` — ${n}`:"");r.push({name:a,fields:i})}if(e.step_type==="TRANSFORM_CONTENT"){const i=[{label:"cleaned_body",value:`{{step_${e.id}.cleaned_body}}`},{label:"result",value:`{{step_${e.id}.result}}`}];r.push({name:`Step ${t+1}: Transformed Content`,fields:i})}if(e.step_type==="ACTION"&&e.step_config&&e.step_config.action_type==="CREATE_RECORD"){const i=e.step_config.target_model||"",n=`Step ${t+1}: Create Record`+(i?` — ${i}`:""),a=[{label:"new_record_id",value:`{{step_${e.id}.new_record_id}}`},{label:"id (legacy)",value:`{{step_${e.id}.id}}`}];r.push({name:n,fields:a})}}),r}),x=k(()=>h.value.some(r=>Array.isArray(r.fields)&&r.fields.length>0));function S(r){r&&L("insert",r)}return(r,l)=>(m(),W(Q,{groups:h.value,disabled:!x.value,onSelect:S},null,8,["groups","disabled"]))}};export{Z as default};
