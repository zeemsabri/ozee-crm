import{u as z}from"./workflowStore-DjV57QTj.js";import{r as L,b as U,d as G,l as F,c as E,o as y,a as C,q as V,k as X,j as W,f as q,v as Y,F as j,i as M,t as H,T as J,p as K}from"./app-DBy4gMm0.js";const Q=["disabled"],Z={class:"p-2 border-b"},ee={class:"px-3 py-1.5 text-[11px] font-semibold uppercase tracking-wide text-gray-500 bg-gray-50"},te=["onClick"],oe={key:1,class:"px-3 py-2 text-xs text-gray-500"},ae={__name:"DataTokenPicker",props:{groups:{type:Array,default:()=>[]},placeholder:{type:String,default:""},disabled:{type:Boolean,default:!1},maxHeight:{type:String,default:"300px"},minWidth:{type:[String,Number],default:320},maxPanelWidth:{type:[String,Number],default:480}},emits:["select"],setup(R,{emit:P}){const p=R,B=P,v=L(!1),b=L(null),A=L(null),x=L({top:0,left:0,width:0}),I=L(""),T=l=>{if(typeof l=="number")return l;const n=parseInt(String(l).replace("px",""));return isNaN(n)?0:n};function o(){p.disabled||(v.value=!v.value,K(()=>i()))}function i(){const l=b.value;if(!l)return;const n=l.getBoundingClientRect(),e=8,t=window.innerWidth||document.documentElement.clientWidth,c=Math.max(n.width,T(p.minWidth)),$=Math.min(T(p.maxPanelWidth),t-e*2),h=Math.min(Math.max(c,T(p.minWidth)),$);let a=n.left+window.scrollX;a+h+e>t+window.scrollX&&(a=t+window.scrollX-h-e,a<e&&(a=e)),x.value={top:n.bottom+window.scrollY,left:a,width:h}}function f(){v.value&&i()}function g(l){const n=b.value&&b.value.contains(l.target),e=A.value&&A.value.contains(l.target);!n&&!e&&(v.value=!1)}U(()=>{window.addEventListener("scroll",f,!0),window.addEventListener("resize",f),document.addEventListener("click",g)}),G(()=>{window.removeEventListener("scroll",f,!0),window.removeEventListener("resize",f),document.removeEventListener("click",g)}),F(()=>{const l=[];return(p.groups||[]).forEach((n,e)=>{(n.fields||[]).forEach((t,c)=>{l.push({groupIndex:e,itemIndex:c,group:n.name||"Data",label:t.label,value:t.value})})}),l});const k=F(()=>{const l=I.value.trim().toLowerCase();if(!l)return p.groups;const n=[];return(p.groups||[]).forEach(e=>{const t=(e.fields||[]).filter(c=>String(c.label||"").toLowerCase().includes(l));t.length&&n.push({name:e.name,fields:t})}),n});function N(l){B("select",l),v.value=!1}return(l,n)=>(y(),E("div",{class:"relative inline-block",ref_key:"triggerRef",ref:b},[C("button",{type:"button",onClick:o,disabled:R.disabled,"aria-label":"Insert data",class:"inline-flex items-center justify-center rounded-full border border-gray-300 bg-white p-1.5 text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-60"},n[1]||(n[1]=[C("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-4 w-4",viewBox:"0 0 20 20",fill:"currentColor"},[C("path",{"fill-rule":"evenodd",d:"M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z","clip-rule":"evenodd"})],-1)]),8,Q),(y(),V(J,{to:"body"},[v.value?(y(),E("div",{key:0,ref_key:"portalRef",ref:A,class:"fixed z-[9999] bg-white rounded-md shadow-xl ring-1 ring-black ring-opacity-5",style:W({top:x.value.top+"px",left:x.value.left+"px",width:x.value.width+"px",maxWidth:"min(480px, 96vw)"})},[C("div",Z,[q(C("input",{type:"text","onUpdate:modelValue":n[0]||(n[0]=e=>I.value=e),placeholder:"Search fields...",class:"w-full border border-gray-200 rounded px-2 py-1 text-xs focus:ring-indigo-500 focus:border-indigo-500"},null,512),[[Y,I.value]])]),C("div",{class:"max-h-[calc(100vh-180px)] overflow-auto",style:W({maxHeight:R.maxHeight})},[k.value&&k.value.length?(y(!0),E(j,{key:0},M(k.value,e=>(y(),E("div",{key:e.name,class:"py-1"},[C("div",ee,H(e.name),1),(y(!0),E(j,null,M(e.fields||[],t=>(y(),E("button",{key:t.value,type:"button",class:"w-full text-left px-3 py-2 text-sm hover:bg-gray-50",onClick:c=>N(t.value)},H(t.label),9,te))),128))]))),128)):(y(),E("div",oe,"No data available"))],4)],4)):X("",!0)]))],512))}},re={__name:"DataTokenInserter",props:{allStepsBefore:{type:Array,default:()=>[]},loopContextSchema:{type:Object,default:null},inferLoopFromNearest:{type:Boolean,default:!0}},emits:["insert"],setup(R,{emit:P}){const p=R,B=P,v=z(),b=F(()=>v.automationSchema||[]);function A(o){if(!o||typeof o!="string")return"";let i=o.toLowerCase();if(i==="id")return"ID";i.endsWith("_id")&&(i=i.slice(0,-3)),i=i.replace(/[_-]+/g," ");let f=i.replace(/\b\w/g,g=>g.toUpperCase());return f=f.replace(/\bId\b/g,"ID").replace(/\bUrl\b/g,"URL"),f}const x=F(()=>{var k,N,l,n;const o=[];let i=p.loopContextSchema;const f=e=>{const t=String((e==null?void 0:e.type)||"").toLowerCase(),c=String((e==null?void 0:e.itemType)||"").toLowerCase();return t==="array of objects"||t==="array"&&c==="object"};if(!i&&p.inferLoopFromNearest){const e=[...p.allStepsBefore].reverse().find(t=>{var c;return t.step_type==="FOR_EACH"&&((c=t.step_config)==null?void 0:c.sourceArray)});if(e){const t=e.step_config.sourceArray,c=typeof t=="string"?t.match(/{{step_(\w+)\.(.+)}}/):null;if(c){const $=c[1],h=c[2],a=p.allStepsBefore.find(_=>String(_.id)===String($)),O=h.replace(/^parsed\./,"");if((a==null?void 0:a.step_type)==="AI_PROMPT"||(a==null?void 0:a.step_type)==="ACTION"&&((k=a==null?void 0:a.step_config)==null?void 0:k.action_type)==="FETCH_API_DATA"){const _=(((N=a.step_config)==null?void 0:N.responseStructure)||[]).find(s=>s.name===O);f(_)&&(i={name:"Loop Item",columns:_.schema||[]})}if(!i&&(a==null?void 0:a.step_type)==="FETCH_RECORDS"&&h==="records"){const _=(l=a.step_config)==null?void 0:l.model,s=b.value.find(u=>u.name===_);s&&(i={name:"Loop Item",columns:(s.columns||[]).map(m=>typeof m=="string"?{name:m}:m)})}}}}if(i&&Array.isArray(i.columns)){const e=[{label:"⬤ Entire loop item (full object)",value:"{{loop.item}}"}];i.columns.filter(t=>!!(t&&t.name)).forEach(t=>{e.push({label:t.name,value:`{{loop.item.${t.name}}}`})}),e.push({label:"— index",value:"{{loop.index}}"},{label:"— is_first",value:"{{loop.is_first}}"},{label:"— is_last",value:"{{loop.is_last}}"}),o.push({name:"Current Loop Item (from For Each)",fields:e})}else if(!i){const e=[{label:"⬤ Entire loop item (full object)",value:"{{loop.item}}"},{label:"— index",value:"{{loop.index}}"},{label:"— is_first",value:"{{loop.is_first}}"},{label:"— is_last",value:"{{loop.is_last}}"}];p.loopContextSchema!==null&&o.push({name:"Current Loop Item (from For Each)",fields:e})}const g=p.allStepsBefore.find(e=>e.step_type==="TRIGGER");if(g&&((n=g.step_config)!=null&&n.model)){const e=b.value.find(t=>t.name===g.step_config.model);e&&o.push({name:`Trigger: ${g.step_config.model}`,fields:e.columns.map(t=>{const c=typeof t=="string"?t:t.name||"";return{label:typeof t=="string"?A(t):t.label||t.name||"",value:`{{trigger.${g.step_config.model.toLowerCase()}.${c}}}`}})})}return p.allStepsBefore.forEach((e,t)=>{var c,$,h,a,O,_;if(e.step_type==="AI_PROMPT"&&(($=(c=e.step_config)==null?void 0:c.responseStructure)==null?void 0:$.length)>0){const s=[],u=(m,w="",d=0)=>{(m||[]).forEach(r=>{if(!(r!=null&&r.name))return;const S=w?`${w}.${r.name}`:r.name,D="  ".repeat(d);s.push({label:`${D}${r.name}`,value:`{{step_${e.id}.${S}}}`}),Array.isArray(r.schema)&&r.type==="Object"&&u(r.schema,S,d+1)})};u(e.step_config.responseStructure),o.push({name:`Step ${t+1}: AI Response`,fields:s})}if(e.step_type==="FETCH_RECORDS"){const s=[{label:"records (array)",value:`{{step_${e.id}.records}}`},{label:"count",value:`{{step_${e.id}.count}}`}],u=e.step_config&&e.step_config.model?e.step_config.model:null,m=`Step ${t+1}: Fetch Records`+(u?` — ${u}`:"");if(e.step_config&&e.step_config.single&&u){const w=b.value.find(d=>d.name===u);w&&(w.columns||[]).forEach(d=>{const r=typeof d=="string"?d:d.name||"",S=typeof d=="string"?A(d):d.label||d.name||"";r&&s.push({label:`record.${S}`,value:`{{step_${e.id}.record.${r}}}`})}),s.push({label:"record (object)",value:`{{step_${e.id}.record}}`})}o.push({name:m,fields:s})}if(e.step_type==="TRANSFORM_CONTENT"){const s=[{label:"cleaned_body",value:`{{step_${e.id}.cleaned_body}}`},{label:"result",value:`{{step_${e.id}.result}}`}];o.push({name:`Step ${t+1}: Transformed Content`,fields:s})}if(e.step_type==="ACTION"&&e.step_config&&e.step_config.action_type==="CREATE_RECORD"){const s=e.step_config.target_model||"",u=`Step ${t+1}: Create Record`+(s?` — ${s}`:""),m=[{label:"new_record_id",value:`{{step_${e.id}.new_record_id}}`},{label:"id (legacy)",value:`{{step_${e.id}.id}}`}];o.push({name:u,fields:m})}if(e.step_type==="DEFINE_VARIABLE"&&Array.isArray((h=e.step_config)==null?void 0:h.variables)){const s=e.step_config.variables.filter(u=>!!u.name).map(u=>({label:u.name,value:`{{step_${e.id}.${u.name}}}`}));s.length>0&&o.push({name:`Step ${t+1}: Defined Variables`,fields:s})}if(e.step_type==="ACTION"&&((a=e.step_config)==null?void 0:a.action_type)==="FETCH_API_DATA"&&((_=(O=e.step_config)==null?void 0:O.responseStructure)==null?void 0:_.length)>0){const s=[],u=(m,w="",d=0)=>{(m||[]).forEach(r=>{if(!(r!=null&&r.name))return;const S=w?`${w}.${r.name}`:r.name,D="  ".repeat(d);s.push({label:`${D}${r.name}`,value:`{{step_${e.id}.${S}}}`}),Array.isArray(r.schema)&&r.type==="Object"&&u(r.schema,S,d+1)})};u(e.step_config.responseStructure),o.push({name:`Step ${t+1}: API Response`,fields:s})}}),o}),I=F(()=>x.value.some(o=>Array.isArray(o.fields)&&o.fields.length>0));function T(o){o&&B("insert",o)}return(o,i)=>(y(),V(ae,{groups:x.value,disabled:!I.value,onSelect:T},null,8,["groups","disabled"]))}};export{re as default};
