import{u as P}from"./workflowStore-3Vyxb0wC.js";import W from"./StepCard-DYLLALCF.js";import E from"./DataTokenInserter-DiLt-moy.js";import{S as y}from"./SelectDropdown-CzJBflKr.js";import{a as z}from"./RelatedDataPicker-B133ciLS.js";import{P as H}from"./plus-Cfwa6LTb.js";import{T as J}from"./trash-CPxY_8H8.js";import{b as m,r as G,q as $,o as u,w as K,a as s,c as p,l as D,f as v,i as F,u as U,F as Q,j as Y,t as Z}from"./app-CyL2wLyO.js";import"./createLucideIcon-CO9mYJgo.js";import"./x-ZMax1QnZ.js";/* empty css                                                                       */import"./_plugin-vue_export-helper-DlAUqK2U.js";const ee={class:"space-y-3"},le={key:0,class:"space-y-3"},te={class:"flex items-center justify-between"},ae={class:"space-y-2"},oe={class:"grid grid-cols-3 gap-2 items-center"},se={class:"flex items-center justify-end"},ne=["onClick"],ue={class:"grid grid-cols-2 gap-2"},re={class:"flex items-center gap-1"},ie={key:0,class:"text-xs text-gray-500 italic px-2"},de=["value","onChange"],pe=["value","onInput"],me=["value","onInput"],ve=["type","value","onInput"],ce={key:0,class:"col-span-2 mt-1"},be=["value","onInput"],ye={class:"flex items-center gap-2 pt-1"},fe={class:"inline-flex items-center gap-2 text-sm"},he=["checked"],_e={class:"p-2 border rounded-md bg-gray-50/60"},ge={class:"flex items-center justify-between"},xe={class:"text-[11px] text-gray-500"},Ne={__name:"FetchRecordsStep",props:{step:{type:Object,required:!0},allStepsBefore:{type:Array,default:()=>[]},loopContextSchema:{type:Object,default:null}},emits:["update:step","delete"],setup(f,{emit:T}){const b=f,h=T,N=P(),g=m(()=>N.automationSchema||[]),a=m({get:()=>b.step.step_config||{conditions:[]},set:t=>h("update:step",{...b.step,step_config:t})}),A=m(()=>g.value.map(t=>t.name)),O=m(()=>A.value.map(t=>({value:t,label:t}))),x=m(()=>a.value.model&&g.value.find(t=>t.name===a.value.model)||null);function w(t){if(!t||typeof t!="string")return"";let e=t.toLowerCase();if(e==="id")return"ID";e.endsWith("_id")&&(e=e.slice(0,-3)),e=e.replace(/[_-]+/g," ");let l=e.replace(/\b\w/g,o=>o.toUpperCase());return l=l.replace(/\bId\b/g,"ID").replace(/\bUrl\b/g,"URL"),l}const k=m(()=>x.value?(x.value.columns||[]).map(t=>typeof t=="string"?{name:t,label:w(t),type:"Text"}:{...t,label:t.label||w(t.name)}):[]),B=m(()=>k.value.map(t=>({value:t.name,label:`${t.label||t.name}${t.type?` (${t.type})`:""}`})));function i(t){return k.value.find(e=>e.name===t)||null}function R(t){const e=i(t);switch((e==null?void 0:e.type)||"Text"){case"True/False":return[{value:"==",label:"is"},{value:"!=",label:"is not"},{value:"is_null",label:"is null"},{value:"is_not_null",label:"is not null"}];case"Number":return[{value:"==",label:"equals"},{value:"!=",label:"not equals"},{value:">",label:">"},{value:"<",label:"<"},{value:">=",label:">="},{value:"<=",label:"<="},{value:"is_null",label:"is null"},{value:"is_not_null",label:"is not null"}];case"Date":case"DateTime":return[{value:"==",label:"on"},{value:"!=",label:"not on"},{value:">",label:"after"},{value:"<",label:"before"},{value:">=",label:"on or after"},{value:"<=",label:"on or before"},{value:"is_null",label:"is null"},{value:"is_not_null",label:"is not null"},{value:"older_than_hours",label:"older than X hours"},{value:"within_hours",label:"within last X hours"},{value:"older_than_days",label:"older than X days"},{value:"within_days",label:"within last X days"}];case"json":case"jsonb":case"Array":return[{value:"==",label:"is"},{value:"!=",label:"is not"},{value:"contains",label:"contains"},{value:"is_null",label:"is null"},{value:"is_not_null",label:"is not null"}];default:return[{value:"==",label:"is"},{value:"!=",label:"is not"},{value:"contains",label:"contains"},{value:"starts_with",label:"starts with"},{value:"ends_with",label:"ends with"},{value:"is_null",label:"is null"},{value:"is_not_null",label:"is not null"}]}}function q(){const t=[...a.value.conditions||[],{column:"",operator:"==",value:""}];a.value={...a.value,conditions:t}}function X(t){const e=(a.value.conditions||[]).filter((l,o)=>o!==t);a.value={...a.value,conditions:e}}function d(t,e,l){const o=[...a.value.conditions||[]];o[t]={...o[t],[e]:l},a.value={...a.value,conditions:o}}function L(t,e){var r;const o=((r=(a.value.conditions||[])[t])==null?void 0:r.value)||"";d(t,"value",`${o}${e}`)}const _=G(!1),M=m(()=>{const t=a.value.relationships||{},e=Array.isArray(t.roots)?t.roots:[],l=t.nested||{};if(!e.length)return"None";const o=[];return e.forEach(r=>{const c=Array.isArray(l[r])?l[r]:[];c.length?o.push(`${r} (+ ${c.join(", ")})`):o.push(r)}),o.join(", ")});return(t,e)=>(u(),$(W,{icon:"ðŸ”",title:b.step.name||"Fetch Records",onDelete:()=>h("delete"),"onUpdate:title":e[5]||(e[5]=l=>h("update:step",{...b.step,name:l}))},{default:K(()=>[s("div",ee,[s("div",null,[e[6]||(e[6]=s("label",{class:"block text-xs font-medium text-gray-600 mb-1"},"Find records from",-1)),v(y,{options:O.value,"model-value":a.value.model||null,placeholder:"Select model...","onUpdate:modelValue":e[0]||(e[0]=l=>a.value={...a.value,model:l,conditions:[]})},null,8,["options","model-value"])]),a.value.model?(u(),p("div",le,[s("div",te,[e[8]||(e[8]=s("label",{class:"text-xs font-medium text-gray-600"},"Where conditions match",-1)),s("button",{onClick:q,class:"flex items-center gap-1 px-2 py-1 text-xs rounded-md bg-gray-100 hover:bg-gray-200"},[v(U(H),{class:"h-3 w-3"}),e[7]||(e[7]=F(" Add",-1))])]),s("div",ae,[(u(!0),p(Q,null,Y(a.value.conditions,(l,o)=>{var r,c,C,S,j,I,V;return u(),p("div",{key:o,class:"p-2 border rounded-md bg-gray-50/50 space-y-2"},[s("div",oe,[v(y,{options:B.value,"model-value":l.column||null,placeholder:"Field...","onUpdate:modelValue":n=>d(o,"column",n),class:"col-span-2"},null,8,["options","model-value","onUpdate:modelValue"]),s("div",se,[s("button",{onClick:n=>X(o),class:"p-1 text-gray-400 hover:text-red-500"},[v(U(J),{class:"w-4 h-4"})],8,ne)])]),s("div",ue,[v(y,{options:R(l.column),"model-value":l.operator||"==",placeholder:"Operator","onUpdate:modelValue":n=>d(o,"operator",n)},null,8,["options","model-value","onUpdate:modelValue"]),s("div",re,[l.operator==="is_null"||l.operator==="is_not_null"?(u(),p("span",ie,"No value needed")):(r=i(l.column))!=null&&r.allowed_values?(u(),$(y,{key:1,options:(i(l.column).allowed_values||[]).map(n=>({value:n.value,label:n.label})),"model-value":l.value||null,placeholder:"Select value...","onUpdate:modelValue":n=>d(o,"value",n)},null,8,["options","model-value","onUpdate:modelValue"])):((c=i(l.column))==null?void 0:c.type)==="True/False"?(u(),p("select",{key:2,value:l.value??"true",onChange:n=>d(o,"value",n.target.value),class:"w-full border rounded px-2 py-2 text-sm"},e[9]||(e[9]=[s("option",{value:"true"},"True",-1),s("option",{value:"false"},"False",-1)]),40,de)):l.operator==="older_than_hours"||l.operator==="within_hours"?(u(),p("input",{key:3,type:"number",value:l.value,onInput:n=>d(o,"value",n.target.value),placeholder:"Hours (e.g. 24)",min:"1",class:"w-full border rounded px-2 py-2 text-sm"},null,40,pe)):l.operator==="older_than_days"||l.operator==="within_days"?(u(),p("input",{key:4,type:"number",value:l.value,onInput:n=>d(o,"value",n.target.value),placeholder:"Days (e.g. 7)",min:"1",class:"w-full border rounded px-2 py-2 text-sm"},null,40,me)):(u(),p("input",{key:5,type:((C=i(l.column))==null?void 0:C.type)==="Date"?"date":((S=i(l.column))==null?void 0:S.type)==="DateTime"?"datetime-local":"text",value:l.value,onInput:n=>d(o,"value",n.target.value),placeholder:"Value",class:"w-full border rounded px-2 py-2 text-sm"},null,40,ve)),v(E,{"all-steps-before":f.allStepsBefore,"loop-context-schema":f.loopContextSchema,onInsert:n=>L(o,n)},null,8,["all-steps-before","loop-context-schema","onInsert"])]),((j=i(l.column))==null?void 0:j.type)==="json"||((I=i(l.column))==null?void 0:I.type)==="jsonb"||((V=i(l.column))==null?void 0:V.type)==="Array"?(u(),p("div",ce,[e[10]||(e[10]=s("label",{class:"block text-[10px] font-medium text-gray-500 mb-1"},"Nested JSON Path (optional)",-1)),s("input",{type:"text",value:l.json_path||"",onInput:n=>d(o,"json_path",n.target.value),placeholder:"e.g. metadata.key or address.city",class:"w-full border border-gray-300 rounded-md px-2 py-1.5 text-xs bg-gray-50"},null,40,be)])):D("",!0)])])}),128))]),s("div",ye,[s("label",fe,[s("input",{type:"checkbox",checked:!!a.value.single,onChange:e[1]||(e[1]=l=>a.value={...a.value,single:l.target.checked}),class:"rounded border-gray-300"},null,40,he),e[11]||(e[11]=F(" Only first match (single record) ",-1))])]),s("div",_e,[s("div",ge,[s("div",null,[e[12]||(e[12]=s("p",{class:"text-xs font-medium text-gray-700"},"Include Related Data",-1)),s("p",xe,Z(M.value),1)]),s("button",{type:"button",class:"text-xs px-2 py-1 rounded-md bg-white ring-1 ring-gray-300 hover:bg-gray-50",onClick:e[2]||(e[2]=l=>_.value=!0)},"Chooseâ€¦")]),v(z,{show:_.value,"base-model-name":a.value.model,"model-value":a.value.relationships||{base_model:a.value.model,roots:[],nested:{},fields:{}},"onUpdate:modelValue":e[3]||(e[3]=l=>a.value={...a.value,relationships:l}),onClose:e[4]||(e[4]=l=>_.value=!1)},null,8,["show","base-model-name","model-value"])])])):D("",!0)])]),_:1},8,["title","onDelete"]))}};export{Ne as default};
