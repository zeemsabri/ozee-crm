import{r as g,f as C,c as w,a as v,o as f,u as G,b as s,F as I,g as A,i as D,v as N,x as U,d as L}from"./app-BeWHP9Dz.js";import{u as W}from"./workflowStore--NuplNyD.js";import $ from"./Workflow-Dhkh0ZyX.js";import F from"./TriggerSelectionModal-C-0GjkYs.js";import"./TriggerStep-DTNbXA_i.js";import"./StepCard-BaDaFxx2.js";import"./trash-CmfpFFw2.js";import"./createLucideIcon-CiObZrs0.js";import"./SelectDropdown-BY4DgivF.js";/* empty css                                                                       */import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./ConditionStep-2_BTC1DM.js";import"./RelationshipPathPicker-BRxg_cmt.js";import"./plus-Dsh9JESk.js";import"./ActionStep-DbWao18_.js";import"./DataTokenInserter-DBFhPQcf.js";import"./AIStep-CxTa8d-O.js";import"./RelatedDataPicker-BvFhPZU-.js";import"./BaseFormModal-DGM2LUD8.js";import"./Modal-CLVS_0rd.js";import"./PrimaryButton-B0ACJT5L.js";import"./SecondaryButton-C-Qjx1Et.js";import"./PromptForm-BvipFsCo.js";import"./ResponseBuilder-Bb382ztE.js";import"./FieldBuilder--dDMEMMs.js";import"./chevron-down-DjZAlwy7.js";import"./circle-x-Dkg80ixM.js";import"./ForEachStep-_znRddMa.js";import"./FetchRecordsStep-D7QuMaKG.js";import"./ScheduleTriggerStep-N5ArfspF.js";import"./AddStepButton-mX6_y8ZF.js";import"./TransformStep-BzTgG_52.js";const H={class:"max-w-12xl mx-auto space-y-6"},B={key:0,class:"text-center py-10"},O={class:"bg-white p-4 rounded-lg shadow-md border flex justify-between items-center sticky top-4 z-20"},V={class:"flex space-x-2"},M=["disabled"],J={class:"p-2 sm:p-6 pb-40 overflow-x-auto"},j={class:"inline-block min-w-max"},Se={__name:"AutomationBuilder",props:{automationId:{type:[Number,String],default:null}},emits:["back"],setup(_,{emit:y}){const m=_,h=y,i=W(),l=g([]),u=g(""),d=g(!1);C(async()=>{try{i.automationSchema.length||await i.fetchAutomationSchema()}catch{}m.automationId?(await i.fetchWorkflow(m.automationId),i.activeWorkflow&&(l.value=JSON.parse(JSON.stringify(i.activeWorkflow.steps)),u.value=i.activeWorkflow.name)):(i.activeWorkflow=null,u.value="Untitled Automation",l.value=[],d.value=!0)});function x(t){let e;t==="SCHEDULE_TRIGGER"?e={id:`temp_${Date.now()}`,step_type:"SCHEDULE_TRIGGER",name:"Starts on a Schedule",step_config:{trigger_event:"schedule.run"}}:e={id:`temp_${Date.now()}`,step_type:"TRIGGER",name:"New Event Trigger",step_config:{}},l.value=[e],d.value=!1}const b=w(()=>{const t=l.value[0];return t?t.step_type==="SCHEDULE_TRIGGER"?!0:!!(t.step_config&&t.step_config.trigger_event):!1}),k=w(()=>b.value&&u.value.trim()!==""),c=(t,e=null,n=null)=>{let a=[];return t.forEach((r,p)=>{const o={...r},E=o.if_true,R=o.if_false,T=o.children;delete o.if_true,delete o.if_false,delete o.children,o.step_order=p+1,e&&(o.step_config=o.step_config||{},o.step_config._parent_id=e,o.step_config._branch=n),a.push(o),r.step_type==="CONDITION"&&(a=[...a,...c(E||[],r.id,"yes"),...c(R||[],r.id,"no")]),r.step_type==="FOR_EACH"&&(a=[...a,...c(T||[],r.id,null)])}),a};async function S(){var r;const t=l.value[0]||{},e=t.step_type==="SCHEDULE_TRIGGER"?"schedule.run":((r=t.step_config)==null?void 0:r.trigger_event)||null,n=c(l.value).map(p=>p.step_type==="SCHEDULE_TRIGGER"?{...p,step_type:"TRIGGER",step_config:{...p.step_config||{},trigger_event:"schedule.run"}}:p),a={name:u.value,trigger_event:e,is_active:!0,steps:n};try{m.automationId?await i.updateWorkflow(m.automationId,a):await i.createWorkflow(a),h("back")}catch(p){console.error("Failed to save automation:",p),i.showAlert("Save Failed","Could not save the automation.")}}return(t,e)=>(f(),v("div",H,[G(i).isLoading&&_.automationId?(f(),v("div",B,e[5]||(e[5]=[s("p",null,"Loading Automation...",-1)]))):(f(),v(I,{key:1},[s("div",O,[N(s("input",{type:"text","onUpdate:modelValue":e[0]||(e[0]=n=>u.value=n),placeholder:"Untitled Automation",class:"text-xl font-bold text-gray-800 focus:outline-none bg-transparent w-full"},null,512),[[U,u.value]]),s("div",V,[s("button",{onClick:e[1]||(e[1]=n=>t.$emit("back")),class:"inline-flex items-center gap-x-2 rounded-md px-3.5 py-2 text-sm font-semibold shadow-sm bg-white text-gray-900 ring-1 ring-inset ring-gray-300 hover:bg-gray-50"}," Cancel "),s("button",{onClick:S,disabled:!k.value,class:"inline-flex items-center gap-x-2 rounded-md px-3.5 py-2 text-sm font-semibold shadow-sm bg-indigo-600 text-white hover:bg-indigo-500 focus-visible:outline-indigo-600 disabled:opacity-50"}," Save and Activate ",8,M)])]),s("div",J,[s("div",j,[L($,{steps:l.value,"onUpdate:steps":e[2]||(e[2]=n=>l.value=n),onAddTrigger:e[3]||(e[3]=n=>d.value=!0)},null,8,["steps"]),e[6]||(e[6]=s("div",{class:"h-60"},null,-1))])]),d.value?(f(),A(F,{key:0,onClose:e[4]||(e[4]=n=>d.value=!1),onSelect:x})):D("",!0)],64))]))}};export{Se as default};
