import{u as Y}from"./workflowStore-bL5r91Cb.js";import{r as F,b as J,d as K,l as O,c as C,o as y,a as E,q,k as Q,j as z,f as Z,v as ee,F as U,i as G,t as X,T as te,p as oe}from"./app-BB49X1tp.js";const ae=["disabled"],ne={class:"p-2 border-b"},le={class:"px-3 py-1.5 text-[11px] font-semibold uppercase tracking-wide text-gray-500 bg-gray-50"},se=["onClick"],re={key:1,class:"px-3 py-2 text-xs text-gray-500"},ie={__name:"DataTokenPicker",props:{groups:{type:Array,default:()=>[]},placeholder:{type:String,default:""},disabled:{type:Boolean,default:!1},maxHeight:{type:String,default:"300px"},minWidth:{type:[String,Number],default:320},maxPanelWidth:{type:[String,Number],default:480}},emits:["select"],setup(S,{emit:B}){const i=S,W=B,v=F(!1),b=F(null),$=F(null),w=F({top:0,left:0,width:0}),I=F(""),k=l=>{if(typeof l=="number")return l;const n=parseInt(String(l).replace("px",""));return isNaN(n)?0:n};function a(){i.disabled||(v.value=!v.value,oe(()=>c()))}function c(){const l=b.value;if(!l)return;const n=l.getBoundingClientRect(),e=8,t=window.innerWidth||document.documentElement.clientWidth,r=Math.max(n.width,k(i.minWidth)),g=Math.min(k(i.maxPanelWidth),t-e*2),m=Math.min(Math.max(r,k(i.minWidth)),g);let o=n.left+window.scrollX;o+m+e>t+window.scrollX&&(o=t+window.scrollX-m-e,o<e&&(o=e)),w.value={top:n.bottom+window.scrollY,left:o,width:m}}function s(){v.value&&c()}function _(l){const n=b.value&&b.value.contains(l.target),e=$.value&&$.value.contains(l.target);!n&&!e&&(v.value=!1)}J(()=>{window.addEventListener("scroll",s,!0),window.addEventListener("resize",s),document.addEventListener("click",_)}),K(()=>{window.removeEventListener("scroll",s,!0),window.removeEventListener("resize",s),document.removeEventListener("click",_)}),O(()=>{const l=[];return(i.groups||[]).forEach((n,e)=>{(n.fields||[]).forEach((t,r)=>{l.push({groupIndex:e,itemIndex:r,group:n.name||"Data",label:t.label,value:t.value})})}),l});const A=O(()=>{const l=I.value.trim().toLowerCase();if(!l)return i.groups;const n=[];return(i.groups||[]).forEach(e=>{const t=(e.fields||[]).filter(r=>String(r.label||"").toLowerCase().includes(l));t.length&&n.push({name:e.name,fields:t})}),n});function P(l){W("select",l),v.value=!1}return(l,n)=>(y(),C("div",{class:"relative inline-block",ref_key:"triggerRef",ref:b},[E("button",{type:"button",onClick:a,disabled:S.disabled,"aria-label":"Insert data",class:"inline-flex items-center justify-center rounded-full border border-gray-300 bg-white p-1.5 text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-60"},n[1]||(n[1]=[E("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-4 w-4",viewBox:"0 0 20 20",fill:"currentColor"},[E("path",{"fill-rule":"evenodd",d:"M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z","clip-rule":"evenodd"})],-1)]),8,ae),(y(),q(te,{to:"body"},[v.value?(y(),C("div",{key:0,ref_key:"portalRef",ref:$,class:"fixed z-[9999] bg-white rounded-md shadow-xl ring-1 ring-black ring-opacity-5",style:z({top:w.value.top+"px",left:w.value.left+"px",width:w.value.width+"px",maxWidth:"min(480px, 96vw)"})},[E("div",ne,[Z(E("input",{type:"text","onUpdate:modelValue":n[0]||(n[0]=e=>I.value=e),placeholder:"Search fields...",class:"w-full border border-gray-200 rounded px-2 py-1 text-xs focus:ring-indigo-500 focus:border-indigo-500"},null,512),[[ee,I.value]])]),E("div",{class:"max-h-[calc(100vh-180px)] overflow-auto",style:z({maxHeight:S.maxHeight})},[A.value&&A.value.length?(y(!0),C(U,{key:0},G(A.value,e=>(y(),C("div",{key:e.name,class:"py-1"},[E("div",le,X(e.name),1),(y(!0),C(U,null,G(e.fields||[],t=>(y(),C("button",{key:t.value,type:"button",class:"w-full text-left px-3 py-2 text-sm hover:bg-gray-50",onClick:r=>P(t.value)},X(t.label),9,se))),128))]))),128)):(y(),C("div",re,"No data available"))],4)],4)):Q("",!0)]))],512))}},de={__name:"DataTokenInserter",props:{allStepsBefore:{type:Array,default:()=>[]},loopContextSchema:{type:Object,default:null},inferLoopFromNearest:{type:Boolean,default:!0}},emits:["insert"],setup(S,{emit:B}){const i=S,W=B,v=Y(),b=O(()=>v.automationSchema||[]);function $(a){if(!a||typeof a!="string")return"";let c=a.toLowerCase();if(c==="id")return"ID";c.endsWith("_id")&&(c=c.slice(0,-3)),c=c.replace(/[_-]+/g," ");let s=c.replace(/\b\w/g,_=>_.toUpperCase());return s=s.replace(/\bId\b/g,"ID").replace(/\bUrl\b/g,"URL"),s}const w=O(()=>{var A,P,l,n;const a=[],c=e=>{const t=String((e==null?void 0:e.type)||"").toLowerCase();return t==="array of objects"||t==="array"||t==="collection"};let s=i.loopContextSchema;if(!s&&i.inferLoopFromNearest){const e=[...i.allStepsBefore].reverse().find(t=>{var r;return t.step_type==="FOR_EACH"&&((r=t.step_config)==null?void 0:r.sourceArray)});if(e){const t=e.step_config.sourceArray,r=typeof t=="string"?t.match(/{{step_(\w+)\.(.+)}}/):null;if(r){const g=r[1],m=r[2],o=i.allStepsBefore.find(h=>String(h.id)===String(g)),D=m.replace(/^parsed\./,"");if((o==null?void 0:o.step_type)==="AI_PROMPT"||(o==null?void 0:o.step_type)==="ACTION"&&((A=o==null?void 0:o.step_config)==null?void 0:A.action_type)==="FETCH_API_DATA"){const h=(((P=o.step_config)==null?void 0:P.responseStructure)||[]).find(x=>x.name===D);c(h)&&(s={name:"Loop Item",columns:h.schema||[]})}if(!s&&(o==null?void 0:o.step_type)==="FETCH_RECORDS"&&m==="records"){const h=(l=o.step_config)==null?void 0:l.model,x=b.value.find(R=>R.name===h);x&&(s={name:"Loop Item",columns:(x.columns||[]).map(T=>typeof T=="string"?{name:T}:T)})}}}}if(s&&Array.isArray(s.columns)){const e=[{label:"⬤ Entire loop item (full object)",value:"{{loop.item}}"}];s.columns.filter(t=>!!(t&&t.name)).forEach(t=>{e.push({label:t.name,value:`{{loop.item.${t.name}}}`})}),e.push({label:"— index",value:"{{loop.index}}"},{label:"— is_first",value:"{{loop.is_first}}"},{label:"— is_last",value:"{{loop.is_last}}"}),a.push({name:"Current Loop Item (from For Each)",fields:e})}else if(!s&&i.loopContextSchema!==null){const e=[{label:"⬤ Entire loop item (full object)",value:"{{loop.item}}"},{label:"— index",value:"{{loop.index}}"},{label:"— is_first",value:"{{loop.is_first}}"},{label:"— is_last",value:"{{loop.is_last}}"}];a.push({name:"Current Loop Item (from For Each)",fields:e})}const _=i.allStepsBefore.find(e=>e.step_type==="TRIGGER");if(_&&((n=_.step_config)!=null&&n.model)){const e=b.value.find(t=>t.name===_.step_config.model);e&&a.push({name:`Trigger: ${_.step_config.model}`,fields:e.columns.map(t=>{const r=typeof t=="string"?t:t.name||"";return{label:typeof t=="string"?$(t):t.label||t.name||"",value:`{{trigger.${_.step_config.model.toLowerCase()}.${r}}}`}})})}return i.allStepsBefore.forEach((e,t)=>{var D,h,x,R,T,H,M,j;const r=e.name||`Step ${t+1}`;let g=e.step_type.split("_").pop().toLowerCase();e.step_type==="AI_PROMPT"?g="AI":e.step_type==="FETCH_RECORDS"?g="Fetch":e.step_type==="ACTION"&&((D=e.step_config)==null?void 0:D.action_type)==="FETCH_API_DATA"&&(g="API");const m=`${r} (${g})`,o=(u,p,L="",f=0)=>{(u||[]).forEach(d=>{if(!(d!=null&&d.name))return;const N=L?`${L}.${d.name}`:d.name,V="  ".repeat(f);p.push({label:`${V}${d.name}`,value:`{{step_${e.id}.${N}}}`}),Array.isArray(d.schema)&&(c(d)?p.push({label:`${V}${d.name} (Count)`,value:`{{step_${e.id}.${N}.count}}`}):d.type==="Object"&&o(d.schema,p,N,f+1))})};if((e.step_type==="AI_PROMPT"||e.step_type==="ACTION"&&((h=e.step_config)==null?void 0:h.action_type)==="FETCH_API_DATA")&&((R=(x=e.step_config)==null?void 0:x.responseStructure)==null?void 0:R.length)>0){const u=[];o(e.step_config.responseStructure,u),a.push({name:`${m}: Response`,fields:u})}if(e.step_type==="FETCH_RECORDS"){const u=[{label:"records (array)",value:`{{step_${e.id}.records}}`},{label:"count",value:`{{step_${e.id}.count}}`}],p=(T=e.step_config)==null?void 0:T.model;if((H=e.step_config)!=null&&H.single&&p){const L=b.value.find(f=>f.name===p);L&&(L.columns||[]).forEach(f=>{const d=typeof f=="string"?f:f.name||"",N=typeof f=="string"?$(f):f.label||f.name||"";d&&u.push({label:`record.${N}`,value:`{{step_${e.id}.record.${d}}}`})}),u.push({label:"record (object)",value:`{{step_${e.id}.record}}`})}a.push({name:`${m}`+(p?` — ${p}`:""),fields:u})}if(e.step_type==="TRANSFORM_CONTENT"&&a.push({name:`${m}: Output`,fields:[{label:"cleaned_body",value:`{{step_${e.id}.cleaned_body}}`},{label:"result",value:`{{step_${e.id}.result}}`}]}),e.step_type==="ACTION"&&((M=e.step_config)==null?void 0:M.action_type)==="CREATE_RECORD"){const u=e.step_config.target_model||"";a.push({name:`${m}: Create Record`+(u?` — ${u}`:""),fields:[{label:"new_record_id",value:`{{step_${e.id}.new_record_id}}`},{label:"id (legacy)",value:`{{step_${e.id}.id}}`}]})}if(e.step_type==="DEFINE_VARIABLE"&&Array.isArray((j=e.step_config)==null?void 0:j.variables)){const u=e.step_config.variables.filter(p=>!!p.name).map(p=>({label:p.name,value:`{{step_${e.id}.${p.name}}}`}));u.length>0&&a.push({name:`${m}: Variables`,fields:u})}}),a}),I=O(()=>w.value.some(a=>Array.isArray(a.fields)&&a.fields.length>0));function k(a){a&&W("insert",a)}return(a,c)=>(y(),q(ie,{groups:w.value,disabled:!I.value,onSelect:k},null,8,["groups","disabled"]))}};export{de as default};
