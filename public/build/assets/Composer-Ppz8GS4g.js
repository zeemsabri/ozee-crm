import{B as D,C as $,D as G,p as _,r as d,s as L,w as M,A as q,E as R,h as r,o as n,e as l,u as x,q as T,a as m,b as a,t as u,k as v,d as I,g as Y,f as z,F as k,i as Q,v as H}from"./app-BHub1TWp.js";import{_ as J}from"./AuthenticatedLayout-DugH88NF.js";import{P as K}from"./PrimaryButton-8_IBrXym.js";import{_ as g,a as O}from"./TextInput-CrXgqVwx.js";import{_ as b}from"./InputError-BxcE-mNL.js";import{R as W}from"./RichTextEditor-Bkh4R9V4.js";import{s as X}from"./vue-multiselect-BUX4FcmF.js";import"./ApplicationLogo-C_K0QUQO.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const Z={class:"py-12"},ee={class:"max-w-7xl mx-auto sm:px-6 lg:px-8"},se={class:"bg-white overflow-hidden shadow-sm sm:rounded-lg"},oe={class:"p-6 text-gray-900"},te={key:0,class:"text-red-600 mb-4"},ae={key:1,class:"text-gray-600 mb-4"},le={key:2,class:"text-red-600 mb-4"},ie={key:3,class:"text-gray-600 mb-4"},re={key:0},ne={key:1},ce={key:4},de={key:0,class:"bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4",role:"alert"},ue={class:"block sm:inline"},me={class:"mb-4"},pe=["value"],_e={class:"mb-4"},ve={class:"multiselect__tag"},ge=["onClick"],be={class:"mb-4"},fe={class:"mb-6"},ye={class:"flex items-center justify-end"},Ae={__name:"Composer",setup(he){const C=D(),{permissions:E,loading:V,error:S}=$(),{canDo:N}=G(),w=_(()=>N("compose_emails").value||!0),f=d([]),y=d([]),h=d(!0),i=d({}),c=d(""),p=d(""),o=L({project_id:"",client_ids:[],subject:"",body:""}),P=_(()=>f.value);_(()=>y.value.filter(e=>o.client_ids.includes(e.id)));const A=_(()=>{if(!o.project_id)return[];const e=f.value.find(s=>s.id===o.project_id);if(!e||!e.clients)return[];const t=e.clients.map(s=>s.id);return y.value.filter(s=>t.includes(s.id))}),F=async()=>{h.value=!0,c.value="";try{const e=await window.axios.get("/api/projects-for-email");f.value=e.data.projects,y.value=e.data.clients}catch(e){c.value="Failed to load projects and clients.",console.error("Error fetching initial data:",e),e.response&&(e.response.status===401||e.response.status===403)&&(c.value="You are not authorized to view this content or your session expired. Please log in.")}finally{h.value=!1}};M(()=>o.project_id,e=>{o.client_ids=[]});const U=async()=>{if(i.value={},c.value="",p.value="",!o.project_id){i.value.project_id=["Please select a project."];return}if(!o.client_ids||o.client_ids.length===0){i.value.client_ids=["Please select at least one client."];return}try{const e=o.client_ids.map(s=>typeof s=="object"&&s!==null?{id:s.id}:{id:s}),t={project_id:o.project_id,client_ids:e,subject:o.subject,body:o.body,status:"pending_approval"};await window.axios.post("/api/emails",t),p.value="Email submitted for approval successfully!",o.project_id="",o.client_ids=[],o.subject="",o.body="",i.value={}}catch(e){e.response&&e.response.status===422?i.value=e.response.data.errors:e.response&&e.response.data.message?c.value=e.response.data.message:(c.value="Failed to submit email. An unexpected error occurred.",console.error("Error submitting email:",e))}},B=()=>{const t=new URLSearchParams(window.location.search).get("project_id");t&&(o.project_id=t)};return q(async()=>{try{console.log("Fetching global permissions...");const e=await R();console.log("Global permissions fetched:",e)}catch(e){console.error("Error fetching global permissions:",e)}F().then(()=>{B()}),console.log("All data loaded, permission status:"),console.log("- Global permissions:",E.value),console.log("- Permissions loading:",V.value),console.log("- Permissions error:",S.value),console.log("- Can compose emails:",w.value)}),(e,t)=>(n(),r(k,null,[l(x(T),{title:"Compose Email"}),l(J,null,{header:m(()=>t[4]||(t[4]=[a("h2",{class:"font-semibold text-xl text-gray-800 leading-tight"},"Compose New Email",-1)])),default:m(()=>[a("div",Z,[a("div",ee,[a("div",se,[a("div",oe,[t[8]||(t[8]=a("h3",{class:"text-2xl font-bold mb-6"},"Create New Email for Client",-1)),w.value?h.value?(n(),r("div",ae,"Loading data...")):c.value?(n(),r("div",le,u(c.value),1)):P.value.length===0?(n(),r("div",ie,[t[5]||(t[5]=v(" No projects assigned to you for email composition. ")),x(C).role==="contractor"?(n(),r("span",re,"Please ensure you are assigned to a project.")):(n(),r("span",ne,"Please ensure there are projects available."))])):(n(),r("div",ce,[a("form",{onSubmit:I(U,["prevent"])},[p.value?(n(),r("div",de,[a("span",ue,u(p.value),1)])):Y("",!0),a("div",me,[l(g,{for:"project_id",value:"Select Project"}),z(a("select",{id:"project_id",class:"border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 rounded-md shadow-sm mt-1 block w-full","onUpdate:modelValue":t[0]||(t[0]=s=>o.project_id=s),required:""},[t[6]||(t[6]=a("option",{value:"",disabled:""},"Select a Project",-1)),(n(!0),r(k,null,Q(P.value,s=>(n(),r("option",{key:s.id,value:s.id},u(s.name)+" (Clients: "+u(s.clients.length?s.clients.map(j=>j.name).join(", "):"N/A")+") ",9,pe))),128))],512),[[H,o.project_id]]),l(b,{message:i.value.project_id?i.value.project_id[0]:"",class:"mt-2"},null,8,["message"])]),a("div",_e,[l(g,{for:"client_ids",value:"To (Clients)"}),l(x(X),{id:"client_ids",modelValue:o.client_ids,"onUpdate:modelValue":t[1]||(t[1]=s=>o.client_ids=s),options:A.value,multiple:!0,"close-on-select":!0,"clear-on-select":!1,"preserve-search":!0,placeholder:"Select one or more clients",label:"name","track-by":"id",searchable:!0,"allow-empty":!0},{option:m(({option:s})=>[v(u(s.name),1)]),tag:m(({option:s,remove:j})=>[a("span",ve,[v(u(s.name)+" ",1),a("i",{class:"multiselect__tag-icon",onClick:je=>j(s)},null,8,ge)])]),_:1},8,["modelValue","options"]),l(b,{message:i.value.client_ids?i.value.client_ids[0]:"",class:"mt-2"},null,8,["message"])]),a("div",be,[l(g,{for:"subject",value:"Subject"}),l(O,{id:"subject",type:"text",class:"mt-1 block w-full",modelValue:o.subject,"onUpdate:modelValue":t[2]||(t[2]=s=>o.subject=s),required:""},null,8,["modelValue"]),l(b,{message:i.value.subject?i.value.subject[0]:"",class:"mt-2"},null,8,["message"])]),a("div",fe,[l(g,{for:"body",value:"Email Body"}),l(W,{id:"body",modelValue:o.body,"onUpdate:modelValue":t[3]||(t[3]=s=>o.body=s),placeholder:"Compose your email here...",height:"300px"},null,8,["modelValue"]),l(b,{message:i.value.body?i.value.body[0]:"",class:"mt-2"},null,8,["message"])]),a("div",ye,[l(K,{type:"submit"},{default:m(()=>t[7]||(t[7]=[v("Submit for Approval")])),_:1,__:[7]})])],32)])):(n(),r("div",te," You do not have permission to compose emails. Please contact your administrator. "))])])])])]),_:1})],64))}};export{Ae as default};
