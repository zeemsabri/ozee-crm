import{u as T}from"./workflowStore-XAGUmoSA.js";import{r as k,f as F,Q as D,c as E,a as v,o as p,b as y,g as P,i as M,k as I,v as O,x as H,F as B,l as W,t as N,Y as z,n as U}from"./app-C_l5dlFM.js";const V=["disabled"],j={class:"p-2 border-b"},G={class:"px-3 py-1.5 text-[11px] font-semibold uppercase tracking-wide text-gray-500 bg-gray-50"},X=["onClick"],Y={key:1,class:"px-3 py-2 text-xs text-gray-500"},q={__name:"DataTokenPicker",props:{groups:{type:Array,default:()=>[]},placeholder:{type:String,default:""},disabled:{type:Boolean,default:!1},maxHeight:{type:String,default:"300px"},minWidth:{type:[String,Number],default:320},maxPanelWidth:{type:[String,Number],default:480}},emits:["select"],setup(_,{emit:L}){const c=_,A=L,f=k(!1),m=k(null),x=k(null),g=k({top:0,left:0,width:0}),w=k(""),S=e=>{if(typeof e=="number")return e;const t=parseInt(String(e).replace("px",""));return isNaN(t)?0:t};function s(){c.disabled||(f.value=!f.value,U(()=>r()))}function r(){const e=m.value;if(!e)return;const t=e.getBoundingClientRect(),o=8,l=window.innerWidth||document.documentElement.clientWidth,i=Math.max(t.width,S(c.minWidth)),n=Math.min(S(c.maxPanelWidth),l-o*2),a=Math.min(Math.max(i,S(c.minWidth)),n);let u=t.left+window.scrollX;u+a+o>l+window.scrollX&&(u=l+window.scrollX-a-o,u<o&&(u=o)),g.value={top:t.bottom+window.scrollY,left:u,width:a}}function d(){f.value&&r()}function h(e){const t=m.value&&m.value.contains(e.target),o=x.value&&x.value.contains(e.target);!t&&!o&&(f.value=!1)}F(()=>{window.addEventListener("scroll",d,!0),window.addEventListener("resize",d),document.addEventListener("click",h)}),D(()=>{window.removeEventListener("scroll",d,!0),window.removeEventListener("resize",d),document.removeEventListener("click",h)}),E(()=>{const e=[];return(c.groups||[]).forEach((t,o)=>{(t.fields||[]).forEach((l,i)=>{e.push({groupIndex:o,itemIndex:i,group:t.name||"Data",label:l.label,value:l.value})})}),e});const b=E(()=>{const e=w.value.trim().toLowerCase();if(!e)return c.groups;const t=[];return(c.groups||[]).forEach(o=>{const l=(o.fields||[]).filter(i=>String(i.label||"").toLowerCase().includes(e));l.length&&t.push({name:o.name,fields:l})}),t});function C(e){A("select",e),f.value=!1}return(e,t)=>(p(),v("div",{class:"relative inline-block",ref_key:"triggerRef",ref:m},[y("button",{type:"button",onClick:s,disabled:_.disabled,"aria-label":"Insert data",class:"inline-flex items-center justify-center rounded-full border border-gray-300 bg-white p-1.5 text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-60"},t[1]||(t[1]=[y("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-4 w-4",viewBox:"0 0 20 20",fill:"currentColor"},[y("path",{"fill-rule":"evenodd",d:"M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z","clip-rule":"evenodd"})],-1)]),8,V),(p(),P(z,{to:"body"},[f.value?(p(),v("div",{key:0,ref_key:"portalRef",ref:x,class:"fixed z-[9999] bg-white rounded-md shadow-xl ring-1 ring-black ring-opacity-5",style:I({top:g.value.top+"px",left:g.value.left+"px",width:g.value.width+"px",maxWidth:"min(480px, 96vw)"})},[y("div",j,[O(y("input",{type:"text","onUpdate:modelValue":t[0]||(t[0]=o=>w.value=o),placeholder:"Search fields...",class:"w-full border border-gray-200 rounded px-2 py-1 text-xs focus:ring-indigo-500 focus:border-indigo-500"},null,512),[[H,w.value]])]),y("div",{class:"max-h-[calc(100vh-180px)] overflow-auto",style:I({maxHeight:_.maxHeight})},[b.value&&b.value.length?(p(!0),v(B,{key:0},W(b.value,o=>(p(),v("div",{key:o.name,class:"py-1"},[y("div",G,N(o.name),1),(p(!0),v(B,null,W(o.fields||[],l=>(p(),v("button",{key:l.value,type:"button",class:"w-full text-left px-3 py-2 text-sm hover:bg-gray-50",onClick:i=>C(l.value)},N(l.label),9,X))),128))]))),128)):(p(),v("div",Y,"No data available"))],4)],4)):M("",!0)]))],512))}},K={__name:"DataTokenInserter",props:{allStepsBefore:{type:Array,default:()=>[]},loopContextSchema:{type:Object,default:null},inferLoopFromNearest:{type:Boolean,default:!0}},emits:["insert"],setup(_,{emit:L}){const c=_,A=L,f=T(),m=E(()=>f.automationSchema||[]);function x(s){if(!s||typeof s!="string")return"";let r=s.toLowerCase();if(r==="id")return"ID";r.endsWith("_id")&&(r=r.slice(0,-3)),r=r.replace(/[_-]+/g," ");let d=r.replace(/\b\w/g,h=>h.toUpperCase());return d=d.replace(/\bId\b/g,"ID").replace(/\bUrl\b/g,"URL"),d}const g=E(()=>{var h,b,C;const s=[];let r=c.loopContextSchema;if(!r&&c.inferLoopFromNearest){const e=[...c.allStepsBefore].reverse().find(t=>{var o;return t.step_type==="FOR_EACH"&&((o=t.step_config)==null?void 0:o.sourceArray)});if(e){const t=e.step_config.sourceArray,o=typeof t=="string"?t.match(/{{step_(\w+)\.(.+)}}/):null;if(o){const l=o[1],i=o[2],n=c.allStepsBefore.find(a=>String(a.id)===String(l));if((n==null?void 0:n.step_type)==="AI_PROMPT"){const a=(((h=n.step_config)==null?void 0:h.responseStructure)||[]).find(u=>u.name===i);(a==null?void 0:a.type)==="Array of Objects"&&(r={name:"Loop Item",columns:a.schema||[]})}if(!r&&(n==null?void 0:n.step_type)==="FETCH_RECORDS"&&i==="records"){const a=(b=n.step_config)==null?void 0:b.model,u=m.value.find($=>$.name===a);u&&(r={name:"Loop Item",columns:(u.columns||[]).map(R=>typeof R=="string"?{name:R}:R)})}}}}r&&Array.isArray(r.columns)&&(s.push({name:"Current Loop Item (from For Each)",fields:r.columns.filter(e=>!!(e&&e.name)).map(e=>({label:e.name,value:`{{loop.item.${e.name}}}`}))}),s.push({name:"Loop Details",fields:[{label:"index",value:"{{loop.index}}"},{label:"is_first",value:"{{loop.is_first}}"},{label:"is_last",value:"{{loop.is_last}}"}]}));const d=c.allStepsBefore.find(e=>e.step_type==="TRIGGER");if(d&&((C=d.step_config)!=null&&C.model)){const e=m.value.find(t=>t.name===d.step_config.model);e&&s.push({name:`Trigger: ${d.step_config.model}`,fields:e.columns.map(t=>{const o=typeof t=="string"?t:t.name||"";return{label:typeof t=="string"?x(t):t.label||t.name||"",value:`{{trigger.${d.step_config.model.toLowerCase()}.${o}}}`}})})}return c.allStepsBefore.forEach((e,t)=>{var o,l;if(e.step_type==="AI_PROMPT"&&((l=(o=e.step_config)==null?void 0:o.responseStructure)==null?void 0:l.length)>0){const i=[];(e.step_config.responseStructure||[]).forEach(n=>{i.push({label:n.name,value:`{{step_${e.id}.${n.name}}}`}),n.type==="Array of Objects"&&Array.isArray(n.schema)&&n.schema.forEach(a=>{a!=null&&a.name&&i.push({label:`- ${a.name}`,value:`{{step_${e.id}.${n.name}.${a.name}}}`})})}),s.push({name:`Step ${t+1}: AI Response`,fields:i})}if(e.step_type==="FETCH_RECORDS"){const i=[{label:"records (array)",value:`{{step_${e.id}.records}}`},{label:"count",value:`{{step_${e.id}.count}}`}],n=e.step_config&&e.step_config.model?e.step_config.model:null,a=`Step ${t+1}: Fetch Records`+(n?` â€” ${n}`:"");s.push({name:a,fields:i})}}),s}),w=E(()=>g.value.some(s=>Array.isArray(s.fields)&&s.fields.length>0));function S(s){s&&A("insert",s)}return(s,r)=>(p(),P(q,{groups:g.value,disabled:!w.value,onSelect:S},null,8,["groups","disabled"]))}};export{K as default};
