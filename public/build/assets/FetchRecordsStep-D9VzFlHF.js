import{u as X}from"./workflowStore-BE3mQCmw.js";import q from"./StepCard-C_sLS4Lu.js";import L from"./DataTokenInserter-VdSXmJM2.js";import{S as b}from"./SelectDropdown-DlV01D_p.js";import{a as M}from"./RelatedDataPicker-BgGDiC4-.js";import{P as W}from"./plus-qFswqvHD.js";import{T as E}from"./trash-XzxR-4yg.js";import{c as d,r as P,g as V,o as r,w as z,b as s,a as p,i as H,d as v,m as $,u as D,F as G,l as J,t as K}from"./app-CDd5Lidm.js";/* empty css                                                                       */import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./createLucideIcon-C_zaZNh1.js";const Q={class:"space-y-3"},Y={key:0,class:"space-y-3"},Z={class:"flex items-center justify-between"},ee={class:"space-y-2"},le={class:"grid grid-cols-3 gap-2 items-center"},te={class:"flex items-center justify-end"},ae=["onClick"],oe={class:"grid grid-cols-2 gap-2"},se={class:"flex items-center gap-1"},ne={key:0,class:"text-xs text-gray-500 italic px-2"},ue=["value","onChange"],re=["value","onInput"],ie=["value","onInput"],de=["type","value","onInput"],pe={class:"flex items-center gap-2 pt-1"},ve={class:"inline-flex items-center gap-2 text-sm"},me=["checked"],ce={class:"p-2 border rounded-md bg-gray-50/60"},be={class:"flex items-center justify-between"},fe={class:"text-[11px] text-gray-500"},De={__name:"FetchRecordsStep",props:{step:{type:Object,required:!0},allStepsBefore:{type:Array,default:()=>[]},loopContextSchema:{type:Object,default:null}},emits:["update:step","delete"],setup(f,{emit:F}){const y=f,_=F,I=X(),g=d(()=>I.automationSchema||[]),a=d({get:()=>y.step.step_config||{conditions:[]},set:l=>_("update:step",{...y.step,step_config:l})}),T=d(()=>g.value.map(l=>l.name)),U=d(()=>T.value.map(l=>({value:l,label:l}))),x=d(()=>a.value.model&&g.value.find(l=>l.name===a.value.model)||null);function w(l){if(!l||typeof l!="string")return"";let e=l.toLowerCase();if(e==="id")return"ID";e.endsWith("_id")&&(e=e.slice(0,-3)),e=e.replace(/[_-]+/g," ");let t=e.replace(/\b\w/g,o=>o.toUpperCase());return t=t.replace(/\bId\b/g,"ID").replace(/\bUrl\b/g,"URL"),t}const C=d(()=>x.value?(x.value.columns||[]).map(l=>typeof l=="string"?{name:l,label:w(l),type:"Text"}:{...l,label:l.label||w(l.name)}):[]),j=d(()=>C.value.map(l=>({value:l.name,label:`${l.label||l.name}${l.type?` (${l.type})`:""}`})));function m(l){return C.value.find(e=>e.name===l)||null}function N(l){const e=m(l);switch((e==null?void 0:e.type)||"Text"){case"True/False":return[{value:"==",label:"is"},{value:"!=",label:"is not"},{value:"is_null",label:"is null"},{value:"is_not_null",label:"is not null"}];case"Number":return[{value:"==",label:"equals"},{value:"!=",label:"not equals"},{value:">",label:">"},{value:"<",label:"<"},{value:">=",label:">="},{value:"<=",label:"<="},{value:"is_null",label:"is null"},{value:"is_not_null",label:"is not null"}];case"Date":case"DateTime":return[{value:"==",label:"on"},{value:"!=",label:"not on"},{value:">",label:"after"},{value:"<",label:"before"},{value:">=",label:"on or after"},{value:"<=",label:"on or before"},{value:"is_null",label:"is null"},{value:"is_not_null",label:"is not null"},{value:"older_than_hours",label:"older than X hours"},{value:"within_hours",label:"within last X hours"},{value:"older_than_days",label:"older than X days"},{value:"within_days",label:"within last X days"}];default:return[{value:"==",label:"is"},{value:"!=",label:"is not"},{value:"contains",label:"contains"},{value:"starts_with",label:"starts with"},{value:"ends_with",label:"ends with"},{value:"is_null",label:"is null"},{value:"is_not_null",label:"is not null"}]}}function O(){const l=[...a.value.conditions||[],{column:"",operator:"==",value:""}];a.value={...a.value,conditions:l}}function A(l){const e=(a.value.conditions||[]).filter((t,o)=>o!==l);a.value={...a.value,conditions:e}}function i(l,e,t){const o=[...a.value.conditions||[]];o[l]={...o[l],[e]:t},a.value={...a.value,conditions:o}}function B(l,e){var u;const o=((u=(a.value.conditions||[])[l])==null?void 0:u.value)||"";i(l,"value",`${o}${e}`)}const h=P(!1),R=d(()=>{const l=a.value.relationships||{},e=Array.isArray(l.roots)?l.roots:[],t=l.nested||{};if(!e.length)return"None";const o=[];return e.forEach(u=>{const c=Array.isArray(t[u])?t[u]:[];c.length?o.push(`${u} (+ ${c.join(", ")})`):o.push(u)}),o.join(", ")});return(l,e)=>(r(),V(q,{icon:"ðŸ”",title:"Fetch Records",onDelete:()=>_("delete")},{default:z(()=>[s("div",Q,[s("div",null,[e[5]||(e[5]=s("label",{class:"block text-xs font-medium text-gray-600 mb-1"},"Find records from",-1)),v(b,{options:U.value,"model-value":a.value.model||null,placeholder:"Select model...","onUpdate:modelValue":e[0]||(e[0]=t=>a.value={...a.value,model:t,conditions:[]})},null,8,["options","model-value"])]),a.value.model?(r(),p("div",Y,[s("div",Z,[e[7]||(e[7]=s("label",{class:"text-xs font-medium text-gray-600"},"Where conditions match",-1)),s("button",{onClick:O,class:"flex items-center gap-1 px-2 py-1 text-xs rounded-md bg-gray-100 hover:bg-gray-200"},[v(D(W),{class:"h-3 w-3"}),e[6]||(e[6]=$(" Add",-1))])]),s("div",ee,[(r(!0),p(G,null,J(a.value.conditions,(t,o)=>{var u,c,k,S;return r(),p("div",{key:o,class:"p-2 border rounded-md bg-gray-50/50 space-y-2"},[s("div",le,[v(b,{options:j.value,"model-value":t.column||null,placeholder:"Field...","onUpdate:modelValue":n=>i(o,"column",n),class:"col-span-2"},null,8,["options","model-value","onUpdate:modelValue"]),s("div",te,[s("button",{onClick:n=>A(o),class:"p-1 text-gray-400 hover:text-red-500"},[v(D(E),{class:"w-4 h-4"})],8,ae)])]),s("div",oe,[v(b,{options:N(t.column),"model-value":t.operator||"==",placeholder:"Operator","onUpdate:modelValue":n=>i(o,"operator",n)},null,8,["options","model-value","onUpdate:modelValue"]),s("div",se,[t.operator==="is_null"||t.operator==="is_not_null"?(r(),p("span",ne,"No value needed")):(u=m(t.column))!=null&&u.allowed_values?(r(),V(b,{key:1,options:(m(t.column).allowed_values||[]).map(n=>({value:n.value,label:n.label})),"model-value":t.value||null,placeholder:"Select value...","onUpdate:modelValue":n=>i(o,"value",n)},null,8,["options","model-value","onUpdate:modelValue"])):((c=m(t.column))==null?void 0:c.type)==="True/False"?(r(),p("select",{key:2,value:t.value??"true",onChange:n=>i(o,"value",n.target.value),class:"w-full border rounded px-2 py-2 text-sm"},e[8]||(e[8]=[s("option",{value:"true"},"True",-1),s("option",{value:"false"},"False",-1)]),40,ue)):t.operator==="older_than_hours"||t.operator==="within_hours"?(r(),p("input",{key:3,type:"number",value:t.value,onInput:n=>i(o,"value",n.target.value),placeholder:"Hours (e.g. 24)",min:"1",class:"w-full border rounded px-2 py-2 text-sm"},null,40,re)):t.operator==="older_than_days"||t.operator==="within_days"?(r(),p("input",{key:4,type:"number",value:t.value,onInput:n=>i(o,"value",n.target.value),placeholder:"Days (e.g. 7)",min:"1",class:"w-full border rounded px-2 py-2 text-sm"},null,40,ie)):(r(),p("input",{key:5,type:((k=m(t.column))==null?void 0:k.type)==="Date"?"date":((S=m(t.column))==null?void 0:S.type)==="DateTime"?"datetime-local":"text",value:t.value,onInput:n=>i(o,"value",n.target.value),placeholder:"Value",class:"w-full border rounded px-2 py-2 text-sm"},null,40,de)),v(L,{"all-steps-before":f.allStepsBefore,"loop-context-schema":f.loopContextSchema,onInsert:n=>B(o,n)},null,8,["all-steps-before","loop-context-schema","onInsert"])])])])}),128))]),s("div",pe,[s("label",ve,[s("input",{type:"checkbox",checked:!!a.value.single,onChange:e[1]||(e[1]=t=>a.value={...a.value,single:t.target.checked}),class:"rounded border-gray-300"},null,40,me),e[9]||(e[9]=$(" Only first match (single record) ",-1))])]),s("div",ce,[s("div",be,[s("div",null,[e[10]||(e[10]=s("p",{class:"text-xs font-medium text-gray-700"},"Include Related Data",-1)),s("p",fe,K(R.value),1)]),s("button",{type:"button",class:"text-xs px-2 py-1 rounded-md bg-white ring-1 ring-gray-300 hover:bg-gray-50",onClick:e[2]||(e[2]=t=>h.value=!0)},"Chooseâ€¦")]),v(M,{show:h.value,"base-model-name":a.value.model,"model-value":a.value.relationships||{base_model:a.value.model,roots:[],nested:{},fields:{}},"onUpdate:modelValue":e[3]||(e[3]=t=>a.value={...a.value,relationships:t}),onClose:e[4]||(e[4]=t=>h.value=!1)},null,8,["show","base-model-name","model-value"])])])):H("",!0)])]),_:1},8,["onDelete"]))}};export{De as default};
