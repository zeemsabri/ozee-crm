import{r as j,z as ze,s as J,w as ce,i as r,o as n,g as v,t as x,b as a,e as d,f as ve,v as Ae,F as se,j as ae,n as te,m as Y,L as Qe,a as le,B as Ne,E as et,M as tt,V as st,J as Ge,h as m,c as ke,q as at,x as Re,H as ot,Y as lt,Z as nt,$ as Le,k as Fe,d as rt}from"./app-C2sBiNbo.js";import{P as ge}from"./PrimaryButton-DpY9NcL_.js";import{_ as A,a as O}from"./InputError-BPrn0zqM.js";import{_ as Z}from"./TextInput-CZ_l5glA.js";import{_ as it}from"./Checkbox-CPIY0qMI.js";import{a as Ie}from"./SecondaryButton-B18ugXVF.js";import{e as Ce,s as De}from"./AuthenticatedLayout-CHJeY_7-.js";const dt={key:0,class:"text-red-600 text-sm mb-4"},ut={key:1,class:"text-gray-500 text-sm mb-4"},ct={key:2},mt={class:"mb-4"},vt={class:"mb-4"},pt=["disabled"],yt=["value"],ft={class:"mb-4"},gt={class:"mt-2"},_t={class:"flex items-center mb-2"},bt=["for"],ht={key:0,class:"pl-6"},wt={class:"grid grid-cols-2 gap-4 mb-2"},kt=["id","onUpdate:modelValue","disabled"],xt={class:"mb-2"},jt={key:0},$t={class:"flex justify-between items-center mb-1"},Pt=["onClick"],St={class:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2"},Vt={class:"flex"},Ct=["onClick"],Ut={key:0},It={class:"mt-4"},Dt={key:1,class:"mt-2 flex items-center"},At={key:0,class:"mt-6 flex justify-end"},Rt={__name:"ServicesAndPaymentForm",props:{projectId:{type:[Number,String],required:!0},paymentTypeOptions:{type:Array,required:!0},canManageProjectServicesAndPayments:{type:Boolean,required:!0},canViewProjectServicesAndPayments:{type:Boolean,required:!0}},emits:["updated"],setup(g,{emit:ie}){const p=g,W=ie,_=j({}),S=j(!1),M=j([...[{value:"Website Designing",label:"Website Designing"},{value:"SEO",label:"SEO"},{value:"Social Media",label:"Social Media"},{value:"Content Writing",label:"Content Writing"},{value:"Graphic Design",label:"Graphic Design"}]]),f=j(""),T=j(!1),b=ze({services:[],service_details:[],total_amount:"",payment_type:"one_off"}),D=J(()=>{const c=b.services.filter(s=>{const o=N(s);return o&&o.frequency!=="monthly"});return c.length===0?!0:c.every(s=>$(s)===100)}),w=J(()=>!p.projectId||!p.canManageProjectServicesAndPayments||!D.value),L=()=>{const c=f.value.trim();c&&!M.value.some(s=>s.label.toLowerCase()===c.toLowerCase())&&(M.value.push({value:c,label:c}),f.value="",T.value=!1)},Q=async()=>{if(p.projectId){S.value=!0;try{const s=(await window.axios.get(`/api/projects/${p.projectId}/sections/services-payment`)).data;return b.services=s.services||[],b.service_details=s.service_details||[],b.total_amount=s.total_amount||"",b.payment_type=s.payment_type||"one_off",b.services.forEach(o=>{M.value.some(h=>h.value===o)||M.value.push({value:o,label:o})}),b.service_details.forEach(o=>{if(o.payment_breakdown&&!Array.isArray(o.payment_breakdown)){const h=o.payment_breakdown;o.payment_breakdown=[{label:"First",percentage:parseInt(h.first)||30},{label:"Second",percentage:parseInt(h.second)||30},{label:"Third",percentage:parseInt(h.third)||40}]}else(!o.payment_breakdown||o.payment_breakdown.length===0)&&(o.payment_breakdown=[{label:"Payment 1",percentage:100}])}),s}catch(c){return console.error("Error fetching services and payment data:",c),_.value.general="Failed to fetch services and payment data.",null}finally{S.value=!1}}},H=async()=>{_.value={},S.value=!0;try{const c={services:b.services,service_details:b.service_details,total_amount:b.total_amount,payment_type:b.payment_type},s=await window.axios.put(`/api/projects/${p.projectId}/sections/services-payment`,c);alert("Services and payment information updated successfully!"),W("updated")}catch(c){c.response&&c.response.status===422?_.value=c.response.data.errors:c.response&&c.response.data.message?_.value.general=c.response.data.message:(_.value.general="Failed to update services and payment information.",console.error("Error:",c))}finally{S.value=!1}},G=(c,s)=>{s?b.service_details.some(o=>o.service_id===c)||b.service_details.push({service_id:c,amount:"",frequency:"one_off",start_date:"",payment_breakdown:[{label:"Payment 1",percentage:100}]}):b.service_details=b.service_details.filter(o=>o.service_id!==c)},N=c=>{let s=b.service_details.find(o=>o.service_id===c);if(!s)s={service_id:c,amount:"",frequency:"one_off",start_date:"",payment_breakdown:[{label:"Payment 1",percentage:100}]},b.service_details.push(s);else if(s.payment_breakdown&&!Array.isArray(s.payment_breakdown)){const o=s.payment_breakdown;s.payment_breakdown=[{label:"First",percentage:parseInt(o.first)||30},{label:"Second",percentage:parseInt(o.second)||30},{label:"Third",percentage:parseInt(o.third)||40}]}else(!s.payment_breakdown||s.payment_breakdown.length===0)&&(s.payment_breakdown=[{label:"Payment 1",percentage:100}]);return s},$=c=>{const s=N(c);return!s.payment_breakdown||!Array.isArray(s.payment_breakdown)?0:s.payment_breakdown.reduce((o,h)=>o+(parseInt(h.percentage)||0),0)},X=c=>{const s=N(c);if(s.payment_breakdown||(s.payment_breakdown=[]),!Array.isArray(s.payment_breakdown)){const V=s.payment_breakdown;s.payment_breakdown=[{label:"First",percentage:parseInt(V.first)||30},{label:"Second",percentage:parseInt(V.second)||30},{label:"Third",percentage:parseInt(V.third)||40}]}const o=s.payment_breakdown.length;let h=0;if(o>0){const V=s.payment_breakdown[o-1];h=Math.floor(V.percentage/2),V.percentage-=h}else h=100;s.payment_breakdown.push({label:`Payment ${o+1}`,percentage:h})},k=(c,s)=>{const o=N(c);if(!o.payment_breakdown||!Array.isArray(o.payment_breakdown)||o.payment_breakdown.length<=1)return;const h=parseInt(o.payment_breakdown[s].percentage)||0;if(o.payment_breakdown.splice(s,1),h>0&&o.payment_breakdown.length>0){const V=s>0&&s<=o.payment_breakdown.length?s-1:0;o.payment_breakdown[V].percentage=(parseInt(o.payment_breakdown[V].percentage)||0)+h}o.payment_breakdown.forEach((V,ne)=>{V.label=`Payment ${ne+1}`})};return ce(()=>p.projectId,c=>{c&&Q()},{immediate:!0}),(c,s)=>(n(),r("div",null,[_.value.general?(n(),r("div",dt,x(_.value.general),1)):v("",!0),S.value?(n(),r("div",ut,"Loading...")):(n(),r("div",ct,[a("div",mt,[d(A,{for:"total_amount",value:"Total Amount"}),d(Z,{id:"total_amount",type:"number",step:"0.01",class:"mt-1 block w-full",modelValue:b.total_amount,"onUpdate:modelValue":s[0]||(s[0]=o=>b.total_amount=o),disabled:!g.canManageProjectServicesAndPayments},null,8,["modelValue","disabled"]),d(O,{message:_.value.total_amount?_.value.total_amount[0]:"",class:"mt-2"},null,8,["message"])]),a("div",vt,[d(A,{for:"payment_type",value:"Payment Type"}),ve(a("select",{id:"payment_type",class:"border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 rounded-md shadow-sm mt-1 block w-full","onUpdate:modelValue":s[1]||(s[1]=o=>b.payment_type=o),required:"",disabled:!g.canManageProjectServicesAndPayments},[(n(!0),r(se,null,ae(g.paymentTypeOptions,o=>(n(),r("option",{key:o.value,value:o.value},x(o.label),9,yt))),128))],8,pt),[[Ae,b.payment_type]]),d(O,{message:_.value.payment_type?_.value.payment_type[0]:"",class:"mt-2"},null,8,["message"])]),a("div",ft,[d(A,{for:"services",value:"Services"}),a("div",gt,[(n(!0),r(se,null,ae(M.value,o=>(n(),r("div",{key:o.value,class:"border p-3 mb-3 rounded"},[a("div",_t,[d(it,{id:`service_${o.value}`,value:o.value,checked:b.services,"onUpdate:checked":[s[2]||(s[2]=h=>b.services=h),h=>G(o.value,h)],disabled:!g.canManageProjectServicesAndPayments},null,8,["id","value","checked","onUpdate:checked","disabled"]),a("label",{for:`service_${o.value}`,class:"ms-2 text-sm font-medium text-gray-700"},x(o.label),9,bt)]),(b.services||[]).includes(o.value)?(n(),r("div",ht,[a("div",wt,[a("div",null,[d(A,{for:`service_amount_${o.value}`,value:"Amount",class:"text-xs"},null,8,["for"]),d(Z,{id:`service_amount_${o.value}`,type:"number",step:"0.01",placeholder:"Amount",class:"w-full",modelValue:N(o.value).amount,"onUpdate:modelValue":h=>N(o.value).amount=h,disabled:!g.canManageProjectServicesAndPayments},null,8,["id","modelValue","onUpdate:modelValue","disabled"])]),a("div",null,[d(A,{for:`service_frequency_${o.value}`,value:"Frequency",class:"text-xs"},null,8,["for"]),ve(a("select",{id:`service_frequency_${o.value}`,class:"border-gray-300 rounded-md w-full","onUpdate:modelValue":h=>N(o.value).frequency=h,disabled:!g.canManageProjectServicesAndPayments},s[6]||(s[6]=[a("option",{value:"monthly"},"Monthly",-1),a("option",{value:"one_off"},"One off",-1)]),8,kt),[[Ae,N(o.value).frequency]])])]),a("div",xt,[d(A,{for:`service_start_date_${o.value}`,value:"Start Date",class:"text-xs"},null,8,["for"]),d(Z,{id:`service_start_date_${o.value}`,type:"date",class:"w-full",modelValue:N(o.value).start_date,"onUpdate:modelValue":h=>N(o.value).start_date=h,disabled:!g.canManageProjectServicesAndPayments},null,8,["id","modelValue","onUpdate:modelValue","disabled"])]),N(o.value).frequency!=="monthly"?(n(),r("div",jt,[a("div",$t,[d(A,{value:"Payment Breakdown (%)",class:"text-xs"}),g.canManageProjectServicesAndPayments?(n(),r("button",{key:0,type:"button",class:"text-xs text-blue-600 hover:text-blue-800",onClick:h=>X(o.value)}," + Add Payment ",8,Pt)):v("",!0)]),a("div",St,[(n(!0),r(se,null,ae(N(o.value).payment_breakdown,(h,V)=>(n(),r("div",{key:V,class:"relative"},[d(A,{for:`service_payment_${V}_${o.value}`,value:h.label,class:"text-xs"},null,8,["for","value"]),a("div",Vt,[d(Z,{id:`service_payment_${V}_${o.value}`,type:"text",inputmode:"numeric",pattern:"[0-9]*",min:"0",max:"100",class:"w-full",modelValue:h.percentage,"onUpdate:modelValue":ne=>h.percentage=ne,modelModifiers:{number:!0},onInput:ne=>{h.percentage=Math.max(0,Math.min(100,parseInt(ne.target.value)||0))},disabled:!g.canManageProjectServicesAndPayments},null,8,["id","modelValue","onUpdate:modelValue","onInput","disabled"]),g.canManageProjectServicesAndPayments&&N(o.value).payment_breakdown.length>1?(n(),r("button",{key:0,type:"button",class:"ml-1 text-red-500 hover:text-red-700",onClick:ne=>k(o.value,V)},s[7]||(s[7]=[a("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor"},[a("path",{"fill-rule":"evenodd",d:"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z","clip-rule":"evenodd"})],-1)]),8,Ct)):v("",!0)])]))),128))]),a("div",{class:te(["text-xs mt-2",{"text-gray-500":$(o.value)===100,"text-red-500 font-bold":$(o.value)!==100}])},[Y(" Total: "+x($(o.value))+"% ",1),$(o.value)!==100?(n(),r("span",Ut," (Total must be 100%) ")):v("",!0)],2)])):v("",!0)])):v("",!0)]))),128))]),a("div",It,[g.canManageProjectServicesAndPayments&&!T.value?(n(),r("button",{key:0,type:"button",class:"text-sm text-blue-600 hover:text-blue-800",onClick:s[3]||(s[3]=o=>T.value=!0)}," + Add New Service/Department ")):v("",!0),g.canManageProjectServicesAndPayments&&T.value?(n(),r("div",Dt,[d(Z,{type:"text",class:"flex-grow mr-2",modelValue:f.value,"onUpdate:modelValue":s[4]||(s[4]=o=>f.value=o),placeholder:"New service/department name",onKeyup:Qe(L,["enter"])},null,8,["modelValue"]),d(ge,{onClick:L},{default:le(()=>s[8]||(s[8]=[Y("Add",-1)])),_:1,__:[8]}),a("button",{type:"button",class:"ml-2 text-sm text-gray-500 hover:text-gray-700",onClick:s[5]||(s[5]=o=>{T.value=!1,f.value=""})}," Cancel ")])):v("",!0)]),d(O,{message:_.value.services?_.value.services[0]:"",class:"mt-2"},null,8,["message"])]),g.canManageProjectServicesAndPayments?(n(),r("div",At,[d(ge,{onClick:H,disabled:w.value,class:te({"opacity-25":w.value})},{default:le(()=>s[9]||(s[9]=[Y(" Update Services & Payment ",-1)])),_:1,__:[9]},8,["disabled","class"])])):v("",!0)]))]))}},Nt=["disabled"],Et={class:"absolute z-50 mt-1 w-full rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5"},Ot=["onClick"],Tt={key:0,class:"block px-4 py-2 text-sm text-gray-500"},Ue={__name:"SelectDropdown",props:{modelValue:{type:[String,Number,Object],default:""},options:{type:Array,default:()=>[]},placeholder:{type:String,default:"Select an option"},valueKey:{type:String,default:"value"},labelKey:{type:String,default:"label"},disabled:{type:Boolean,default:!1},required:{type:Boolean,default:!1},maxHeight:{type:String,default:"250px"},width:{type:String,default:"full"}},emits:["update:modelValue","change"],setup(g,{emit:ie}){const p=g,W=ie,_=j(!1),S=j(null),B=D=>{S.value&&!S.value.contains(D.target)&&(_.value=!1)},M=D=>{D.key==="Escape"&&_.value&&(_.value=!1)};Ne(()=>{document.addEventListener("click",B),document.addEventListener("keydown",M)}),et(()=>{document.removeEventListener("click",B),document.removeEventListener("keydown",M)});const f=J(()=>{if(!p.modelValue)return p.placeholder;const D=p.options.find(w=>w[p.valueKey]===p.modelValue);return D?D[p.labelKey]:p.placeholder}),T=D=>{W("update:modelValue",D[p.valueKey]),W("change",D[p.valueKey]),_.value=!1},b=()=>{p.disabled||(_.value=!_.value)};return(D,w)=>(n(),r("div",{ref_key:"dropdownRef",ref:S,class:te(["relative",{"w-full":g.width==="full"}])},[a("button",{type:"button",onClick:b,disabled:g.disabled,class:te(["border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 rounded-md shadow-sm mt-1 block w-full text-left px-3 py-2 text-gray-700 bg-white",{"opacity-50 cursor-not-allowed":g.disabled}])},[a("span",{class:te({"text-gray-500":!p.modelValue})},x(f.value),3),w[0]||(w[0]=a("svg",{class:"float-right h-4 w-4 mt-1",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor"},[a("path",{"fill-rule":"evenodd",d:"M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z","clip-rule":"evenodd"})],-1))],10,Nt),ve(a("div",Et,[a("div",{class:"py-1 overflow-y-auto",style:st({maxHeight:g.maxHeight})},[(n(!0),r(se,null,ae(g.options,L=>(n(),r("div",{key:L[g.valueKey],onClick:Q=>T(L),class:te(["block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer",{"bg-gray-100":L[g.valueKey]===g.modelValue}])},x(L[g.labelKey]),11,Ot))),128)),g.options.length===0?(n(),r("div",Tt," No options available ")):v("",!0)],4)],512),[[tt,_.value]])],2))}},Ft={class:"p-6 bg-white rounded-lg shadow-xl"},Mt={key:0,class:"text-red-600 text-sm mb-4"},Bt={key:1,class:"mb-6 p-4 bg-gray-50 rounded-md"},qt={class:"mb-6"},Lt={class:"mb-4"},Kt={class:"grid grid-cols-1 md:grid-cols-3 gap-4"},zt={class:"p-3 bg-blue-100 rounded-md"},Gt={class:"text-lg font-bold text-blue-800"},Wt={class:"p-3 bg-red-100 rounded-md"},Jt={class:"text-lg font-bold text-red-800"},Yt={class:"p-3 bg-green-100 rounded-md"},Ht={class:"text-lg font-bold text-green-800"},Xt={class:"grid grid-cols-1 gap-4 md:grid-cols-2"},Zt={key:0},Qt={key:1},es={class:"mt-4 flex justify-end"},ts={key:2},ss={key:0,class:"text-gray-600"},as={key:1,class:"p-4 bg-gray-50 rounded-md text-gray-600 text-center"},os={key:2,class:"space-y-4"},ls={class:"flex justify-between items-center"},ns={class:"font-medium"},rs={class:"text-sm text-gray-600"},is={key:0},ds={key:1},us={key:2},cs={class:"flex space-x-2"},ms={key:0,class:"mt-4 p-4 bg-blue-50 rounded-md border border-blue-200"},vs={class:"mb-4"},ps={class:"flex items-center"},ys=["disabled"],fs={key:0,class:"mb-4"},gs={class:"flex justify-end space-x-2"},_s={__name:"ProjectTransactions",props:{projectId:{type:[Number,String],required:!0},userProjectRole:{type:Object,default:()=>({})}},setup(g){const ie={PKR:.0034,AUD:.65,INR:.012,EUR:1.08,GBP:1.28,USD:1},p=g,{canDo:W,canManage:_}=Ge(()=>p.projectId),S=_("project_expenses",p.userProjectRole),B=_("project_income",p.userProjectRole),M=W("view_project_transactions",p.userProjectRole),f=j([]),T=j([]),b=j({}),D=j(""),w=j(!1),L=j(null),Q=j(""),H=j(!1),G=j({}),N=j(null),$=j({description:"",amount:"",currency:"PKR",user_id:null,hours_spent:"",type:"expense"}),X=[{value:"PKR",label:"PKR"},{value:"AUD",label:"AUD"},{value:"INR",label:"INR"},{value:"USD",label:"USD"},{value:"EUR",label:"EUR"},{value:"GBP",label:"GBP"}],k=[{value:"expense",label:"Expense"},{value:"income",label:"Income"}],c=J(()=>T.value.map(P=>({value:P.id,label:P.name||"Unknown User"}))),s=(P,i)=>isNaN(P)||P==null?"0.00":new Intl.NumberFormat("en-US",{style:"currency",currency:i,minimumFractionDigits:2,maximumFractionDigits:2}).format(P),o=(P,i,I)=>{if(!P||isNaN(P)||!i||!I)return 0;if(i===I)return Number(P);const q=ie[i.toUpperCase()],re=ie[I.toUpperCase()];if(!q||!re)return console.warn(`Invalid currency: ${i} to ${I}`),0;const de=Number(P)*q/re;return Number(de.toFixed(2))},h=async()=>{if(!(!p.projectId||!M))try{const P=await window.axios.get(`/api/projects/${p.projectId}/sections/clients-users`);T.value=P.data.users||[]}catch(P){D.value="Failed to fetch users.",console.error("Error fetching users:",P)}},V=async()=>{if(!(!p.projectId||!M)){w.value=!0;try{const P=await window.axios.get(`/api/projects/${p.projectId}/sections/transactions`);f.value=P.data.map(i=>({...i,amount:Number(i.amount)||0,amount_usd:o(Number(i.amount)||0,i.currency,"USD")}))}catch(P){D.value="Failed to fetch transactions.",console.error("Error fetching transactions:",P)}finally{w.value=!1}}},ne=async()=>{var P;if(!S&&!B){Ce("You do not have permission to manage transactions.");return}if(!$.value.amount||isNaN($.value.amount)){b.value.amount=["Please enter a valid amount"];return}b.value={},D.value="",w.value=!0;try{const i={...$.value,amount:Number($.value.amount),amount_usd:o(Number($.value.amount),$.value.currency,"USD")},I=await window.axios.post(`/api/projects/${p.projectId}/transactions`,i);f.value.unshift({...I.data,amount:Number(I.data.amount)||0,amount_usd:o(Number(I.data.amount)||0,I.data.currency,"USD")}),K(),De("Transaction saved successfully!")}catch(i){((P=i.response)==null?void 0:P.status)===422?b.value=i.response.data.errors:(D.value="Failed to save transaction.",console.error("Error saving transaction:",i))}finally{w.value=!1}},K=()=>{$.value={description:"",amount:"",currency:"PKR",user_id:null,hours_spent:"",type:"expense"}},Ee=async P=>{if(!S&&!B){Ce("You do not have permission to delete transactions.");return}if(confirm("Are you sure you want to delete this transaction?"))try{const i=f.value[P].id;await window.axios.delete(`/api/projects/${p.projectId}/transactions/${i}`),f.value.splice(P,1),De("Transaction deleted successfully!")}catch(i){D.value="Failed to delete transaction.",console.error("Error deleting transaction:",i)}},me=P=>{if(!S&&!B){Ce("You do not have permission to manage transactions.");return}const i=f.value[P];L.value===i.id?(L.value=null,N.value=null):(N.value=P,L.value=i.id,Q.value=i.amount,H.value=!1,G.value={})},pe=()=>{L.value=null,N.value=null,Q.value="",H.value=!1,G.value={}},_e=async()=>{var re;if(!S&&!B){Ce("You do not have permission to manage transactions.");return}const P=N.value,i=f.value[P],I=Number(Q.value),q=Number(i.amount);if(!H.value&&(!Q.value||isNaN(I)||I<=0||I>q)){G.value.amount=["Please enter a valid amount between 0 and "+s(q,i.currency)];return}G.value={},w.value=!0;try{const ee=i.id,de=H.value,be={payment_amount:de?q:I,pay_in_full:de,transaction_currency:i.currency,transaction_type:i.type,original_description:i.description};await window.axios.patch(`/api/projects/${p.projectId}/transactions/${ee}/process-payment`,be),await V(),De("Payment processed successfully!"),pe()}catch(ee){((re=ee.response)==null?void 0:re.status)===422?G.value=ee.response.data.errors:(D.value="Failed to process payment.",console.error("Error processing payment:",ee))}finally{w.value=!1}},z=j("PKR"),he=J(()=>{const P=f.value.filter(i=>i.type==="income").reduce((i,I)=>i+o(Number(I.amount)||0,I.currency,z.value),0);return s(P,z.value)}),Oe=J(()=>{const P=f.value.filter(i=>i.type==="expense").reduce((i,I)=>i+o(Number(I.amount)||0,I.currency,z.value),0);return s(P,z.value)}),xe=J(()=>{const P=f.value.filter(I=>I.type==="income").reduce((I,q)=>I+o(Number(q.amount)||0,q.currency,z.value),0),i=f.value.filter(I=>I.type==="expense").reduce((I,q)=>I+o(Number(q.amount)||0,q.currency,z.value),0);return s(P-i,z.value)});return Ne(()=>{V(),h()}),ce(()=>p.projectId,()=>{V(),h()}),(P,i)=>{var I,q,re,ee,de,be;return n(),r("div",Ft,[i[20]||(i[20]=a("h3",{class:"text-lg font-medium text-gray-900 mb-4"},"Project Transactions",-1)),D.value?(n(),r("div",Mt,x(D.value),1)):v("",!0),m(S)||m(B)?(n(),r("div",Bt,[a("div",qt,[i[12]||(i[12]=a("h4",{class:"text-md font-medium text-gray-700 mb-2"},"Summary",-1)),a("div",Lt,[d(A,{for:"display_currency",value:"Display Currency",class:"sr-only"}),d(Ue,{id:"display_currency",modelValue:z.value,"onUpdate:modelValue":i[0]||(i[0]=C=>z.value=C),options:X,class:"w-32"},null,8,["modelValue"])]),a("div",Kt,[a("div",zt,[i[9]||(i[9]=a("p",{class:"text-sm text-gray-600"},"Total Income",-1)),a("p",Gt,x(he.value),1)]),a("div",Wt,[i[10]||(i[10]=a("p",{class:"text-sm text-gray-600"},"Total Expenses",-1)),a("p",Jt,x(Oe.value),1)]),a("div",Yt,[i[11]||(i[11]=a("p",{class:"text-sm text-gray-600"},"Balance",-1)),a("p",Ht,x(xe.value),1)])])]),i[13]||(i[13]=a("h4",{class:"text-md font-medium text-gray-700 mb-4"},"Add Transaction",-1)),a("div",Xt,[a("div",null,[d(A,{for:"description",value:"Description"}),d(Z,{id:"description",modelValue:$.value.description,"onUpdate:modelValue":i[1]||(i[1]=C=>$.value.description=C),class:"mt-1 block w-full",disabled:w.value},null,8,["modelValue","disabled"]),d(O,{message:(I=b.value.description)==null?void 0:I[0],class:"mt-2"},null,8,["message"])]),a("div",null,[d(A,{for:"amount",value:"Amount"}),d(Z,{id:"amount",type:"number",modelValue:$.value.amount,"onUpdate:modelValue":i[2]||(i[2]=C=>$.value.amount=C),class:"mt-1 block w-full",disabled:w.value},null,8,["modelValue","disabled"]),d(O,{message:(q=b.value.amount)==null?void 0:q[0],class:"mt-2"},null,8,["message"])]),a("div",null,[d(A,{for:"currency",value:"Currency"}),d(Ue,{id:"currency",modelValue:$.value.currency,"onUpdate:modelValue":i[3]||(i[3]=C=>$.value.currency=C),options:X,disabled:w.value},null,8,["modelValue","disabled"]),d(O,{message:(re=b.value.currency)==null?void 0:re[0],class:"mt-2"},null,8,["message"])]),a("div",null,[d(A,{for:"type",value:"Type"}),d(Ue,{id:"type",modelValue:$.value.type,"onUpdate:modelValue":i[4]||(i[4]=C=>$.value.type=C),options:k,disabled:w.value||!m(S)&&$.value.type==="expense"||!m(B)&&$.value.type==="income"},null,8,["modelValue","disabled"]),d(O,{message:(ee=b.value.type)==null?void 0:ee[0],class:"mt-2"},null,8,["message"])]),$.value.type==="expense"?(n(),r("div",Zt,[d(A,{for:"user_id",value:"User"}),d(Ue,{id:"user_id",modelValue:$.value.user_id,"onUpdate:modelValue":i[5]||(i[5]=C=>$.value.user_id=C),options:c.value,disabled:w.value||!T.value.length,placeholder:"Select a user"},null,8,["modelValue","options","disabled"]),$.value.type==="expense"?(n(),ke(O,{key:0,message:(de=b.value.user_id)==null?void 0:de[0],class:"mt-2"},null,8,["message"])):v("",!0)])):v("",!0),$.value.type==="expense"?(n(),r("div",Qt,[d(A,{for:"hours_spent",value:"Hours Spent (Optional)"}),d(Z,{id:"hours_spent",type:"number",modelValue:$.value.hours_spent,"onUpdate:modelValue":i[6]||(i[6]=C=>$.value.hours_spent=C),class:"mt-1 block w-full",disabled:w.value},null,8,["modelValue","disabled"]),$.value.type==="expense"?(n(),ke(O,{key:0,message:(be=b.value.hours_spent)==null?void 0:be[0],class:"mt-2"},null,8,["message"])):v("",!0)])):v("",!0)]),a("div",es,[d(ge,{onClick:ne,disabled:w.value},{default:le(()=>[Y(x(w.value?"Saving...":"Save Transaction"),1)]),_:1},8,["disabled"])])])):v("",!0),m(M)?(n(),r("div",ts,[i[19]||(i[19]=a("h4",{class:"text-md font-medium text-gray-700 mb-4"},"Transaction History",-1)),w.value?(n(),r("div",ss,"Loading transactions...")):f.value.length===0?(n(),r("div",as," No transactions found for this project. ")):(n(),r("div",os,[(n(!0),r(se,null,ae(f.value,(C,we)=>{var U,E;return n(),r("div",{key:C.id,class:"p-4 bg-gray-50 rounded-md shadow-sm"},[a("div",ls,[a("div",null,[a("p",ns,x(C.description),1),a("p",rs,[Y(x(C.type==="income"?"Income":"Expense")+": "+x(s(C.amount,C.currency))+" ",1),z.value!==C.currency?(n(),r("span",is," ("+x(s(o(C.amount,C.currency,z.value),z.value))+") ",1)):v("",!0),C.user_id?(n(),r("span",ds," (User: "+x(((U=T.value.find(F=>F.id===C.user_id))==null?void 0:U.name)||"Unknown")+")",1)):v("",!0),C.hours_spent?(n(),r("span",us," ("+x(C.hours_spent)+" hours)",1)):v("",!0),a("span",{class:te(["ml-2",C.is_paid?"text-green-600":"text-red-600"])},x(C.is_paid?"(Paid)":"(Unpaid)"),3)])]),a("div",cs,[!C.is_paid&&(m(S)||m(B))?(n(),ke(Ie,{key:0,onClick:F=>me(we),class:"text-green-600"},{default:le(()=>i[14]||(i[14]=[Y(" Pay ",-1)])),_:2,__:[14]},1032,["onClick"])):v("",!0),m(S)||m(B)?(n(),ke(Ie,{key:1,onClick:F=>Ee(we),class:"text-red-600"},{default:le(()=>i[15]||(i[15]=[Y(" Delete ",-1)])),_:2,__:[15]},1032,["onClick"])):v("",!0)])]),L.value===C.id?(n(),r("div",ms,[i[18]||(i[18]=a("h4",{class:"text-md font-medium text-gray-900 mb-4"},"Make Payment",-1)),a("div",vs,[a("label",ps,[ve(a("input",{type:"checkbox","onUpdate:modelValue":i[7]||(i[7]=F=>H.value=F),class:"mr-2 rounded text-blue-600 focus:ring-blue-500",disabled:w.value},null,8,ys),[[at,H.value]]),i[16]||(i[16]=a("span",{class:"text-sm text-gray-700"},"Pay in Full",-1))])]),H.value?v("",!0):(n(),r("div",fs,[d(A,{for:"payment_amount",value:"Payment Amount"}),d(Z,{id:"payment_amount",type:"number",modelValue:Q.value,"onUpdate:modelValue":i[8]||(i[8]=F=>Q.value=F),class:"mt-1 block w-full",disabled:w.value,placeholder:"Enter partial payment amount (Max: "+s(C.amount,C.currency)+")"},null,8,["modelValue","disabled","placeholder"]),d(O,{message:(E=G.value.amount)==null?void 0:E[0],class:"mt-2"},null,8,["message"])])),a("div",gs,[d(Ie,{onClick:pe,disabled:w.value},{default:le(()=>i[17]||(i[17]=[Y(" Cancel ",-1)])),_:1,__:[17]},8,["disabled"]),d(ge,{onClick:_e,disabled:w.value},{default:le(()=>[Y(x(w.value?"Processing...":"Submit Payment"),1)]),_:1},8,["disabled"])])])):v("",!0)])}),128))]))])):v("",!0)])}}},bs={class:"mt-2"},hs={class:"mb-2"},ws={key:0,class:"text-gray-500 text-sm mb-2"},ks=["disabled"],xs={value:""},js=["value"],$s={class:"flex-grow"},Ps=["value","onChange","disabled"],Ss=["value"],Vs=["onClick"],Ke={__name:"MultiSelectWithRoles",props:{label:{type:String,required:!0},items:{type:Array,default:()=>[]},endpoint:{type:String,default:""},selectedItems:{type:Array,default:()=>[]},itemText:{type:String,default:"name"},itemSubtext:{type:String,default:"email"},itemValue:{type:String,default:"id"},roleOptions:{type:Array,default:()=>[]},roleType:{type:String,default:"application"},defaultRoleId:{type:Number,default:null},error:{type:String,default:""},placeholder:{type:String,default:"Select an item"},showRemoveButton:{type:Boolean,default:!0}},emits:["update:selectedItems"],setup(g,{emit:ie}){const p=g,W=ie,_=j([]),S=j([]),B=j([]),M=j([]),f=j(!1),T=async()=>{if(!(p.roleOptions.length>0))try{const c=(await Re.get(`/api/roles?type=${p.roleType}`)).data;B.value=c.map(s=>({value:s.id,label:s.name}))}catch(k){console.error("Error fetching roles:",k)}},b=J(()=>B.value.length>0?B.value:p.roleOptions),D=()=>p.defaultRoleId?p.defaultRoleId:b.value.length>0?b.value[0].value:1,w=()=>{if(console.log("initializeFromProps called with selectedItems:",p.selectedItems),!p.selectedItems||p.selectedItems.length===0){_.value=[],S.value=[],console.log("Cleared selectedIds and selectedItemsWithRoles because props.selectedItems is empty");return}const k=new Set;p.selectedItems.forEach(c=>{const s=typeof c=="object"?c.id:c;if(!k.has(s)){if(k.add(s),!_.value.includes(s))_.value.push(s),typeof c=="object"&&c.role_id?S.value.push({id:s,role_id:c.role_id}):S.value.push({id:s,role_id:D()});else if(typeof c=="object"&&c.role_id){const o=S.value.find(h=>h.id===s);o&&(o.role_id=c.role_id)}}}),console.log("After initialization, selectedIds:",_.value),console.log("After initialization, selectedItemsWithRoles:",S.value)};ce(()=>p.selectedItems,(k,c)=>{console.log("selectedItems changed:",k),JSON.stringify(k)!==JSON.stringify(c)?(console.log("selectedItems changed significantly, reinitializing"),w()):console.log("selectedItems change was not significant, skipping reinitialization")},{deep:!0,immediate:!0}),ce(S,k=>{W("update:selectedItems",k)},{deep:!0});const L=k=>{k&&!_.value.includes(k)&&(_.value.push(k),S.value.push({id:k,role_id:D()}))},Q=k=>{_.value=_.value.filter(c=>c!==k),S.value=S.value.filter(c=>c.id!==k)},H=(k,c)=>{const s=S.value.find(o=>o.id===k);s&&(s.role_id=parseInt(c))},G=k=>X.value.find(c=>c[p.itemValue]===k),N=k=>{const c=S.value.find(s=>s.id===k);return c?c.role_id:D()},$=async()=>{if(p.endpoint){f.value=!0;try{const k=await Re.get(p.endpoint);k.data&&Array.isArray(k.data)?M.value=k.data:k.data&&k.data.data&&Array.isArray(k.data.data)&&(M.value=k.data.data)}catch(k){console.error("Error fetching items from endpoint:",k)}finally{f.value=!1}}},X=J(()=>p.endpoint&&M.value.length>0?M.value:p.items);return Ne(()=>{T(),w(),p.endpoint&&$()}),(k,c)=>(n(),r("div",null,[d(A,{value:g.label},null,8,["value"]),a("div",bs,[a("div",hs,[f.value?(n(),r("div",ws,"Loading...")):v("",!0),g.showRemoveButton?(n(),r("select",{key:1,class:"border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 rounded-md shadow-sm mt-1 block w-full",onChange:c[0]||(c[0]=s=>{const o=parseInt(s.target.value);L(o),s.target.value=""}),disabled:f.value},[a("option",xs,x(g.placeholder),1),(n(!0),r(se,null,ae(X.value.filter(s=>!_.value.includes(s[g.itemValue])),s=>(n(),r("option",{key:s[g.itemValue],value:s[g.itemValue]},x(s[g.itemText])+" ("+x(s[g.itemSubtext])+") ",9,js))),128))],40,ks)):v("",!0)]),(n(!0),r(se,null,ae(_.value,s=>{var o,h;return n(),r("div",{key:s,class:"flex items-center mb-1 p-2 border rounded"},[a("div",$s,x((o=G(s))==null?void 0:o[g.itemText])+" ("+x((h=G(s))==null?void 0:h[g.itemSubtext])+") ",1),a("select",{class:"ms-2 border-gray-300 rounded-md",value:N(s),onChange:V=>H(s,V.target.value),disabled:!g.showRemoveButton},[(n(!0),r(se,null,ae(b.value,V=>(n(),r("option",{key:V.value,value:V.value},x(V.label),9,Ss))),128))],40,Ps),g.showRemoveButton?(n(),r("button",{key:0,type:"button",class:"ml-2 text-red-600",onClick:()=>Q(s)}," Remove ",8,Vs)):v("",!0)])}),128))]),d(O,{message:g.error,class:"mt-2"},null,8,["message"])]))}},Cs={class:"p-6 w-full max-w-6xl mx-auto bg-white rounded-lg shadow-xl"},Us={class:"flex justify-between items-center mb-4"},Is={class:"text-lg font-medium text-gray-900"},Ds={key:0,class:"text-red-600 text-sm mb-4"},As={key:1,class:"mb-4"},Rs={key:0,class:"text-xs text-gray-500 mt-2 p-2 bg-gray-100 rounded"},Ns={class:"font-bold"},Es={class:"mt-1"},Os={key:0},Ts={key:1},Fs={key:2},Ms={key:0},Bs={class:"list-disc ml-4"},qs={key:0},Ls={class:"mt-1"},Ks={class:"border-b border-gray-200 mb-6"},zs={class:"flex -mb-px"},Gs={key:0},Ws={class:"mb-4"},Js={class:"mb-4"},Ys=["disabled"],Hs={class:"mb-4"},Xs={class:"mb-4"},Zs={key:0,class:"mb-4"},Qs={key:1,class:"mb-4"},ea={class:"mb-4"},ta=["disabled"],sa=["value"],aa={class:"mb-4"},oa=["disabled"],la=["value"],na={key:2,class:"mt-6 flex justify-end"},ra={key:1},ia={key:0,class:"mb-4"},da={key:0,class:"mt-2 flex justify-end"},ua={key:1,class:"mt-2 text-green-600 text-sm"},ca={key:2,class:"mt-2 text-red-600 text-sm"},ma={class:"mb-4"},va=["disabled"],pa={key:1,class:"mb-4"},ya={key:0,class:"mt-2 flex justify-end"},fa={key:1,class:"mt-2 text-green-600 text-sm"},ga={key:2,class:"mt-2 text-red-600 text-sm"},_a={key:2},ba={key:3},ha={key:4},wa={class:"mb-4"},ka={class:"mt-2"},xa={key:0,class:"mb-4"},ja={class:"mt-4"},$a={key:0,class:"text-sm text-red-500 mt-2"},Pa={key:1,class:"mt-4"},Sa={class:"flex-grow"},Va=["href"],Ca=["onClick"],Ua={key:5},Ia={class:"mb-4"},Da={class:"mt-2"},Aa={key:0},Ra={class:"flex items-start mb-2"},Na=["onUpdate:modelValue","readonly"],Ea={key:1,class:"p-4 bg-gray-50 rounded-md text-gray-600 text-center"},Oa={class:"mt-6 flex justify-end"},za={__name:"ProjectForm",props:{show:{type:Boolean,required:!0},project:{type:Object,default:()=>({})},statusOptions:{type:Array,required:!0},departmentOptions:{type:Array,required:!0},sourceOptions:{type:Array,required:!0},clientRoleOptions:{type:Array,default:()=>[]},userRoleOptions:{type:Array,default:()=>[]},paymentTypeOptions:{type:Array,required:!0}},emits:["close","submit"],setup(g,{emit:ie}){ot();const p=j({}),W=g;ce(()=>W.project,t=>{p.value=t||{}},{immediate:!0});const _=J(()=>{var t;return((t=p.value)==null?void 0:t.id)||null}),{permissions:S,loading:B,error:M}=lt(_),f=nt(p);J(()=>!!f.value),J(()=>{if(!f.value)return!1;const t=f.value.name,l=f.value.slug;return t==="Manager"||t==="Project Manager"||l==="manager"||l==="project-manager"});const{canDo:T,canView:b,canManage:D}=Ge(_),w=T("manage_projects",f),L=T("create_projects",f),Q=T("create_clients",f),H=T("upload_project_documents",f);D("project_expenses",f),D("project_income",f);const G=D("project_services_and_payments",f),N=T("add_project_notes",f),$=D("project_users",f),X=D("project_clients",f),k=D("project_basic_details",f),c=b("project_documents",f),s=b("project_services_and_payments",f),o=b("project_notes",f),h=b("project_users",f),V=b("project_clients",f),ne=b("project_transactions",f),K=j("basic"),Ee=J(()=>V.value&&h.value?"Clients and Users":V.value?"Clients":h.value?"Users":"Clients and Users"),me=t=>{if(!(t==="documents"&&!e.id)&&(K.value=t,e.id))switch(F.value=!0,t){case"basic":q(e.id).finally(()=>{F.value=!1});break;case"client":V.value||X.value||h.value||$.value?re(e.id).finally(()=>{F.value=!1}):F.value=!1;break;case"services":s.value||G.value?ee(e.id).finally(()=>{F.value=!1}):F.value=!1;break;case"transactions":F.value=!1;break;case"documents":c.value?de(e.id).finally(()=>{F.value=!1}):F.value=!1;break;case"notes":o.value||N.value?be(e.id).finally(()=>{F.value=!1}):F.value=!1;break;default:F.value=!1;break}},pe=j([]),_e=j([]),z=j([]),he=j([]),Oe=async()=>{try{const l=(await Re.get("/api/roles?type=client")).data;pe.value=l.map(R=>({value:R.id,label:R.name}));const u=(await Re.get("/api/roles?type=project")).data;_e.value=u.map(R=>({value:R.id,label:R.name}))}catch(t){console.error("Error fetching roles:",t)}},xe=async()=>{try{if(Q.value){const t=await window.axios.get("/api/clients");z.value=t.data.data||t.data}else if(_.value){const t=await window.axios.get(`/api/projects/${_.value}/clients`);z.value=t.data}else{const t=await window.axios.get("/api/clients");z.value=t.data.data||t.data}}catch(t){console.error("Error fetching clients:",t),E.value="Failed to load clients."}},P=async()=>{try{if(L.value){const t=await window.axios.get("/api/users");he.value=t.data}else if(_.value){const t=await window.axios.get(`/api/projects/${_.value}/users`);he.value=t.data}else{const t=await window.axios.get("/api/users");he.value=t.data}}catch(t){console.error("Error fetching users:",t),E.value="Failed to load users."}},i=J(()=>pe.value.length>0?pe.value:W.clientRoleOptions),I=J(()=>_e.value.length>0?_e.value:W.userRoleOptions),q=async t=>{try{const y=(await window.axios.get(`/api/projects/${t}/sections/basic`)).data;return e.name=y.name||"",e.description=y.description||"",e.website=y.website||"",e.social_media_link=y.social_media_link||"",e.preferred_keywords=y.preferred_keywords||"",e.google_chat_id=y.google_chat_id||"",e.status=y.status||"active",e.project_type=y.project_type||"",e.source=y.source||"",e.google_drive_link=y.google_drive_link||"",y}catch(l){return console.error("Error fetching basic project data:",l),E.value="Failed to fetch basic project data.",null}},re=async t=>{try{const y=(await window.axios.get(`/api/projects/${t}/sections/clients-users`)).data;return y.clients&&y.clients.length>0&&(e.client_ids=y.clients.map(u=>{var oe;let R=((oe=u.pivot)==null?void 0:oe.role_id)||(pe.value.length>0?pe.value[0].value:1);return{id:u.id,role_id:R}})),y.users&&y.users.length>0&&(e.user_ids=y.users.map(u=>{var oe;let R=((oe=u.pivot)==null?void 0:oe.role_id)||(_e.value.length>0?_e.value[0].value:2);return{id:u.id,role_id:R}})),y.contract_details!==void 0&&(e.contract_details=y.contract_details||""),y}catch(l){return console.error("Error fetching clients and users data:",l),E.value="Failed to fetch clients and users data.",null}},ee=async t=>{try{const y=(await window.axios.get(`/api/projects/${t}/sections/services-payment`)).data;return e.services=y.services||[],e.service_details=y.service_details||[],e.total_amount=y.total_amount||"",e.payment_type=y.payment_type||"one_off",y}catch(l){return console.error("Error fetching services and payment data:",l),E.value="Failed to fetch services and payment data.",null}},de=async t=>{try{const y=(await window.axios.get(`/api/projects/${t}/sections/documents`)).data;return e.documents=y.documents||[],y}catch(l){return console.error("Error fetching documents data:",l),E.value="Failed to fetch documents data.",null}},be=async t=>{try{const y=(await window.axios.get(`/api/projects/${t}/sections/notes`)).data;return e.notes=y.map(u=>({content:u.content})),y}catch(l){return console.error("Error fetching notes data:",l),E.value="Failed to fetch notes data.",null}},C=async t=>{try{switch(await q(t),K.value){case"client":(V.value||X.value||h.value||$.value)&&await re(t);break;case"services":(s.value||G.value)&&await ee(t);break;case"documents":c.value&&await de(t);break;case"notes":(o.value||N.value)&&await be(t);break}}catch(l){console.error("Error fetching project data:",l),E.value="Failed to fetch project data."}};Ne(()=>{Oe(),xe(),P(),_.value&&Le(_.value).then(t=>{}).catch(t=>{})}),ce(_,(t,l)=>{t&&t!==l&&(Le(t).then(y=>{}).catch(y=>{}),P(),xe())});const we=ie,U=j({}),E=j(""),F=j(!1),We=j(!1),je=j(!1),$e=j(!1),ye=j(""),Pe=j(!1),Se=j(!1),fe=j(""),e=ze({id:null,name:"",description:"",website:"",social_media_link:"",preferred_keywords:"",google_chat_id:"",logo:null,documents:[],client_ids:[],status:"active",project_type:"",services:[],service_details:[],source:"",total_amount:"",contract_details:"",google_drive_link:"",payment_type:"one_off",user_ids:[],notes:[]});ce(()=>W.show,t=>{t&&(e.client_ids||(e.client_ids=[]),e.user_ids||(e.user_ids=[]),e.id&&C(e.id))},{immediate:!0}),ce(()=>W.project,t=>{const l=e.id;e.id=t.id||null,l&&!e.id&&K.value==="documents"&&me("basic"),e.name=t.name||"",e.description=t.description||"",e.website=t.website||"",e.social_media_link=t.social_media_link||"",e.preferred_keywords=t.preferred_keywords||"",e.google_chat_id=t.google_chat_id||"",e.logo=t.logo||null,e.documents=t.documents||[],e.client_ids=[],e.status=t.status||"active",e.project_type=t.project_type||"",e.services=t.services||[],e.service_details=t.service_details||[],e.source=t.source||"",e.total_amount=t.total_amount||"",e.contract_details=t.contract_details||"",e.google_drive_link=t.google_drive_link||"",e.payment_type=t.payment_type||"one_off",e.user_ids=[],e.notes=t.notes?t.notes.map(y=>({content:y.content})):[],U.value={},E.value=""},{immediate:!0});const Je=async()=>{U.value={},E.value="";try{const t={name:e.name,description:e.description,website:e.website,social_media_link:e.social_media_link,preferred_keywords:e.preferred_keywords,google_chat_id:e.google_chat_id,status:e.status,project_type:e.project_type,source:e.source,google_drive_link:e.google_drive_link,user_ids:e.user_ids},l=e.logo;typeof l=="object"&&l!==null&&"name"in l&&delete t.logo;const y=await window.axios.post("/api/projects",t);e.id=y.data.id,typeof l=="object"&&l!==null&&"name"in l&&await qe(l,e.id),we("submit",y.data)}catch(t){Me(t,"Failed to create project.")}},Ye=async()=>{U.value={},E.value="";try{const t={name:e.name,description:e.description,website:e.website,social_media_link:e.social_media_link,preferred_keywords:e.preferred_keywords,google_chat_id:e.google_chat_id,status:e.status,project_type:e.project_type,source:e.source,google_drive_link:e.google_drive_link},l=e.logo;typeof l=="object"&&l!==null&&"name"in l&&delete t.logo;const y=await window.axios.put(`/api/projects/${e.id}/sections/basic`,t);typeof l=="object"&&l!==null&&"name"in l&&await qe(l,e.id),De("Basic information updated successfully!")}catch(t){Me(t,"Failed to update basic information.")}},Me=(t,l)=>{t.response&&t.response.status===422?U.value=t.response.data.errors:t.response&&t.response.data.message?E.value=t.response.data.message:(E.value=l,console.error("Error:",t))},Ve=j(!1),Te=j({});ce(e,()=>{Object.keys(Te.value).length>0&&(Ve.value=!0)},{deep:!0}),ce(()=>W.show,t=>{t&&setTimeout(()=>{Te.value=JSON.parse(JSON.stringify(e)),Ve.value=!1},100)});const Be=()=>{Ve.value?confirm("You have unsaved changes. Are you sure you want to close this form?")&&we("close"):we("close")},qe=async(t,l)=>{try{const y=new FormData;y.append("logo",t);const u=await window.axios.post(`/api/projects/${l}/logo`,y,{headers:{"Content-Type":"multipart/form-data"}});return u.data&&u.data.logo&&(e.logo=u.data.logo),u}catch(y){console.error("Error uploading logo:",y)}},He=async()=>{if(!e.id){ye.value="Please save the project first before saving clients.";return}if(!e.client_ids||e.client_ids.length===0){ye.value="Please select at least one client to save.";return}je.value=!0,$e.value=!1,ye.value="";try{const t=await window.axios.post(`/api/projects/${e.id}/attach-clients`,{client_ids:e.client_ids});$e.value=!0,setTimeout(()=>{$e.value=!1},3e3)}catch(t){t.response&&t.response.status===422?ye.value="Validation error. Please check your input.":t.response&&t.response.data.message?ye.value=t.response.data.message:(ye.value="Failed to save clients.",console.error("Error saving clients:",t))}finally{je.value=!1}},Xe=async()=>{if(!e.id){fe.value="Please save the project first before saving users.";return}if(!e.user_ids||e.user_ids.length===0){fe.value="Please select at least one user to save.";return}Pe.value=!0,Se.value=!1,fe.value="";try{const t=await window.axios.post(`/api/projects/${e.id}/attach-users`,{user_ids:e.user_ids});Se.value=!0,setTimeout(()=>{Se.value=!1},3e3)}catch(t){t.response&&t.response.status===422?fe.value="Validation error. Please check your input.":t.response&&t.response.data.message?fe.value=t.response.data.message:(fe.value="Failed to save users.",console.error("Error saving users:",t))}finally{Pe.value=!1}},Ze=async()=>{if(!e.id){E.value="Please save the project first before uploading documents.";return}if(!e.documents||!e.documents.some(t=>typeof t=="object"&&t!==null&&"name"in t&&"size"in t&&"type"in t)){E.value="Please select documents to upload.";return}try{const t=new FormData;e.documents.filter(R=>typeof R=="object"&&R!==null&&"name"in R&&"size"in R&&"type"in R).forEach((R,oe)=>{t.append(`documents[${oe}]`,R)});const y=await window.axios.post(`/api/projects/${e.id}/documents`,t,{headers:{"Content-Type":"multipart/form-data"}});e.documents=y.data.documents||[],document.getElementById("documents").value="",alert("Documents uploaded successfully!");const u=JSON.parse(JSON.stringify(e));Te.value=u,Ve.value=!1}catch(t){t.response&&t.response.status===422?U.value=t.response.data.errors:t.response&&t.response.data.message?E.value=t.response.data.message:(E.value="Failed to upload documents.",console.error("Error uploading documents:",t))}};return(t,l)=>{var y;return n(),r("div",Cs,[a("div",Us,[a("h2",Is,x(e.id?"Edit Project":"Create New Project"),1),a("button",{onClick:Be,class:"text-gray-400 hover:text-gray-500"},l[21]||(l[21]=[a("svg",{class:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)]))]),E.value?(n(),r("div",Ds,x(E.value),1)):v("",!0),_.value?(n(),r("div",As,[We.value?(n(),r("div",Rs,[a("div",Ns,"Project ID: "+x(_.value),1),a("div",null,x(m(f)?"Project Role: "+(((y=m(f).value)==null?void 0:y.name)||"None"):"No Project Role"),1),a("div",Es,[l[23]||(l[23]=a("div",{class:"font-semibold"},"Project Permissions:",-1)),m(B)?(n(),r("div",Os,"Loading project permissions...")):m(M)?(n(),r("div",Ts,"Error loading project permissions")):m(S)?(n(),r("div",Fs,[Y(" Count: "+x(m(S).permissions?m(S).permissions.length:0)+" ",1),m(S).permissions&&m(S).permissions.length>0?(n(),r("div",Ms,[l[22]||(l[22]=a("div",{class:"font-semibold"},"Permissions:",-1)),a("ul",Bs,[(n(!0),r(se,null,ae(m(S).permissions.slice(0,5),u=>(n(),r("li",{key:u.slug},x(u.name)+" ("+x(u.source)+") ",1))),128)),m(S).permissions.length>5?(n(),r("li",qs," ... and "+x(m(S).permissions.length-5)+" more ",1)):v("",!0)])])):v("",!0)])):v("",!0)]),a("div",Ls,"Can manage projects: "+x(m(w)?"Yes":"No"),1)])):v("",!0)])):v("",!0),a("div",Ks,[a("nav",zs,[m(w)?(n(),r("button",{key:0,onClick:l[0]||(l[0]=u=>me("basic")),class:te(["py-2 px-4 text-center border-b-2 font-medium text-sm",K.value==="basic"?"border-indigo-500 text-indigo-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"])}," Basic Information ",2)):v("",!0),m(V)||m(h)?(n(),r("button",{key:1,onClick:l[1]||(l[1]=u=>me("client")),class:te(["py-2 px-4 text-center border-b-2 font-medium text-sm",K.value==="client"?"border-indigo-500 text-indigo-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"])},x(Ee.value),3)):v("",!0),e.id&&(m(G)||m(s))?(n(),r("button",{key:2,onClick:l[2]||(l[2]=u=>me("services")),class:te(["py-2 px-4 text-center border-b-2 font-medium text-sm",K.value==="services"?"border-indigo-500 text-indigo-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"])}," Services & Payment ",2)):v("",!0),e.id&&m(ne)?(n(),r("button",{key:3,onClick:l[3]||(l[3]=u=>me("transactions")),class:te(["py-2 px-4 text-center border-b-2 font-medium text-sm",K.value==="transactions"?"border-indigo-500 text-indigo-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"])}," Transactions ",2)):v("",!0),e.id&&m(c)?(n(),r("button",{key:4,onClick:l[4]||(l[4]=u=>me("documents")),class:te(["py-2 px-4 text-center border-b-2 font-medium text-sm",K.value==="documents"?"border-indigo-500 text-indigo-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"])}," Documents ",2)):v("",!0),e.id&&(m(N)||m(o))?(n(),r("button",{key:5,onClick:l[5]||(l[5]=u=>me("notes")),class:te(["py-2 px-4 text-center border-b-2 font-medium text-sm",K.value==="notes"?"border-indigo-500 text-indigo-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"])}," Notes ",2)):v("",!0)])]),a("form",{onSubmit:l[20]||(l[20]=rt(()=>{},["prevent"]))},[K.value==="basic"?(n(),r("div",Gs,[a("div",Ws,[d(A,{for:"name",value:"Project Name"}),d(Z,{id:"name",type:"text",class:"mt-1 block w-full",modelValue:e.name,"onUpdate:modelValue":l[6]||(l[6]=u=>e.name=u),required:"",autofocus:"",disabled:!m(w)},null,8,["modelValue","disabled"]),d(O,{message:U.value.name?U.value.name[0]:"",class:"mt-2"},null,8,["message"])]),a("div",Js,[d(A,{for:"description",value:"Description"}),ve(a("textarea",{id:"description",class:"border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 rounded-md shadow-sm mt-1 block w-full","onUpdate:modelValue":l[7]||(l[7]=u=>e.description=u),disabled:!m(w)},null,8,Ys),[[Fe,e.description]]),d(O,{message:U.value.description?U.value.description[0]:"",class:"mt-2"},null,8,["message"])]),a("div",Hs,[d(A,{for:"website",value:"Website"}),d(Z,{id:"website",type:"url",class:"mt-1 block w-full",modelValue:e.website,"onUpdate:modelValue":l[8]||(l[8]=u=>e.website=u),disabled:!m(w)},null,8,["modelValue","disabled"]),d(O,{message:U.value.website?U.value.website[0]:"",class:"mt-2"},null,8,["message"])]),a("div",Xs,[d(A,{for:"preferred_keywords",value:"Client Preferred Keywords"}),d(Z,{id:"preferred_keywords",type:"text",class:"mt-1 block w-full",modelValue:e.preferred_keywords,"onUpdate:modelValue":l[9]||(l[9]=u=>e.preferred_keywords=u),disabled:!m(w)},null,8,["modelValue","disabled"]),d(O,{message:U.value.preferred_keywords?U.value.preferred_keywords[0]:"",class:"mt-2"},null,8,["message"])]),m(k)?(n(),r("div",Zs,[d(A,{for:"google_chat_id",value:"Google Chat ID"}),d(Z,{id:"google_chat_id",type:"text",class:"mt-1 block w-full",modelValue:e.google_chat_id,"onUpdate:modelValue":l[10]||(l[10]=u=>e.google_chat_id=u),disabled:!m(w)},null,8,["modelValue","disabled"]),d(O,{message:U.value.google_chat_id?U.value.google_chat_id[0]:"",class:"mt-2"},null,8,["message"])])):v("",!0),m(k)?(n(),r("div",Qs,[d(A,{for:"google_drive_link",value:"Google Drive Link"}),d(Z,{id:"google_drive_link",type:"text",class:"mt-1 block w-full",modelValue:e.google_drive_link,"onUpdate:modelValue":l[11]||(l[11]=u=>e.google_drive_link=u),disabled:!m(w)},null,8,["modelValue","disabled"]),d(O,{message:U.value.google_chat_id?U.value.google_chat_id[0]:"",class:"mt-2"},null,8,["message"])])):v("",!0),a("div",ea,[d(A,{for:"status",value:"Status"}),ve(a("select",{id:"status",class:"border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 rounded-md shadow-sm mt-1 block w-full","onUpdate:modelValue":l[12]||(l[12]=u=>e.status=u),required:"",disabled:!m(w)},[(n(!0),r(se,null,ae(g.statusOptions,u=>(n(),r("option",{key:u.value,value:u.value},x(u.label),9,sa))),128))],8,ta),[[Ae,e.status]]),d(O,{message:U.value.status?U.value.status[0]:"",class:"mt-2"},null,8,["message"])]),a("div",aa,[d(A,{for:"source",value:"Source"}),ve(a("select",{id:"source",class:"border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 rounded-md shadow-sm mt-1 block w-full","onUpdate:modelValue":l[13]||(l[13]=u=>e.source=u),disabled:!m(w)},[l[24]||(l[24]=a("option",{value:"",disabled:""},"Select a Source",-1)),(n(!0),r(se,null,ae(g.sourceOptions,u=>(n(),r("option",{key:u.value,value:u.value},x(u.label),9,la))),128))],8,oa),[[Ae,e.source]]),d(O,{message:U.value.source?U.value.source[0]:"",class:"mt-2"},null,8,["message"])]),m(w)?(n(),r("div",na,[e.id&&m(k)||!e.id?(n(),ke(ge,{key:0,onClick:l[14]||(l[14]=u=>e.id?Ye():Je()),disabled:!m(w)},{default:le(()=>[Y(x(e.id?"Update Basic Information":"Create Project"),1)]),_:1},8,["disabled"])):v("",!0)])):v("",!0)])):v("",!0),K.value==="client"?(n(),r("div",ra,[m(V)?(n(),r("div",ia,[d(Ke,{label:"Clients",items:z.value,selectedItems:e.client_ids,"onUpdate:selectedItems":l[15]||(l[15]=u=>e.client_ids=u),roleOptions:i.value,roleType:"client",error:U.value.client_ids?U.value.client_ids[0]:"",placeholder:"Select a client to add",disabled:!m(X),readonly:!m(X)&&m(V),showRemoveButton:m(X)},null,8,["items","selectedItems","roleOptions","error","disabled","readonly","showRemoveButton"]),m(X)?(n(),r("div",da,[d(ge,{onClick:He,disabled:je.value},{default:le(()=>[Y(x(je.value?"Saving...":"Save Clients"),1)]),_:1},8,["disabled"])])):v("",!0),$e.value?(n(),r("div",ua," Clients saved successfully! ")):v("",!0),ye.value?(n(),r("div",ca,x(ye.value),1)):v("",!0)])):v("",!0),a("div",ma,[d(A,{for:"contract_details",value:"Contract Details"}),ve(a("textarea",{id:"contract_details",class:"border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 rounded-md shadow-sm mt-1 block w-full","onUpdate:modelValue":l[16]||(l[16]=u=>e.contract_details=u),disabled:!m(w)},null,8,va),[[Fe,e.contract_details]]),d(O,{message:U.value.contract_details?U.value.contract_details[0]:"",class:"mt-2"},null,8,["message"])]),m(h)?(n(),r("div",pa,[d(Ke,{label:"Assign Users",items:he.value,selectedItems:e.user_ids,"onUpdate:selectedItems":l[17]||(l[17]=u=>e.user_ids=u),roleOptions:I.value,roleType:"project",defaultRoleId:2,error:U.value.user_ids?U.value.user_ids[0]:"",placeholder:"Select a user to add",disabled:!m($),readonly:!m($)&&m(h),showRemoveButton:m($)},null,8,["items","selectedItems","roleOptions","error","disabled","readonly","showRemoveButton"]),m($)?(n(),r("div",ya,[d(ge,{onClick:Xe,disabled:Pe.value},{default:le(()=>[Y(x(Pe.value?"Saving...":"Save Users"),1)]),_:1},8,["disabled"])])):v("",!0),Se.value?(n(),r("div",fa," Users saved successfully! ")):v("",!0),fe.value?(n(),r("div",ga,x(fe.value),1)):v("",!0)])):v("",!0)])):v("",!0),K.value==="services"?(n(),r("div",_a,[d(Rt,{projectId:e.id,departmentOptions:g.departmentOptions,paymentTypeOptions:g.paymentTypeOptions,canManageProjectServicesAndPayments:m(G),canViewProjectServicesAndPayments:m(s),onUpdated:l[18]||(l[18]=u=>ee(e.id))},null,8,["projectId","departmentOptions","paymentTypeOptions","canManageProjectServicesAndPayments","canViewProjectServicesAndPayments"])])):v("",!0),K.value==="transactions"&&m(ne)?(n(),r("div",ba,[d(_s,{projectId:e.id,userProjectRole:m(f).value},null,8,["projectId","userProjectRole"])])):v("",!0),K.value==="documents"?(n(),r("div",ha,[a("div",wa,[d(A,{value:"Project Documents"}),a("div",ka,[m(H)?(n(),r("div",xa,[d(A,{for:"documents",value:"Upload Documents"}),a("input",{type:"file",id:"documents",onChange:l[19]||(l[19]=u=>{const R=Array.from(u.target.files);if(R.length>0){const oe=Array.isArray(e.documents)?e.documents.filter(ue=>typeof ue=="object"&&"path"in ue):[];e.documents=[...oe,...R],console.log("Files selected:",R),console.log("Are files File objects?",R.some(ue=>typeof ue=="object"&&ue!==null&&"name"in ue&&"size"in ue&&"type"in ue)),console.log("Updated documents array:",e.documents)}}),class:"mt-1 block w-full",multiple:"",accept:".pdf,.doc,.docx,.jpg,.png"},null,32),l[26]||(l[26]=a("p",{class:"text-sm text-gray-500 mt-1"},"Supported formats: PDF, DOC, DOCX, JPG, PNG",-1)),d(O,{message:U.value.documents?U.value.documents[0]:"",class:"mt-2"},null,8,["message"]),a("div",ja,[d(ge,{type:"button",onClick:Ze,disabled:!e.id||!e.documents||!e.documents.some(u=>typeof u=="object"&&u!==null&&"name"in u&&"size"in u&&"type"in u)},{default:le(()=>l[25]||(l[25]=[Y(" Upload Documents ",-1)])),_:1,__:[25]},8,["disabled"]),e.id?v("",!0):(n(),r("p",$a," Please save the project first before uploading documents. "))])])):v("",!0),e.documents&&e.documents.length>0&&typeof e.documents[0]=="object"&&"path"in e.documents[0]?(n(),r("div",Pa,[l[27]||(l[27]=a("h3",{class:"font-medium text-gray-700 mb-2"},"Existing Documents",-1)),(n(!0),r(se,null,ae(e.documents,(u,R)=>(n(),r("div",{key:R,class:"flex items-center mb-2 p-2 border rounded"},[a("div",Sa,[a("a",{href:"/storage/"+u.path,target:"_blank",class:"text-blue-600 hover:underline"},x(u.filename),9,Va)]),m(H).value?(n(),r("button",{key:0,type:"button",class:"ml-2 text-red-600",onClick:()=>{e.documents=e.documents.filter((oe,ue)=>ue!==R)}}," Remove ",8,Ca)):v("",!0)]))),128))])):v("",!0),l[28]||(l[28]=a("div",{class:"mt-4"},[a("p",{class:"text-sm text-gray-500"}," Documents will be uploaded to the project's Google Drive folder. ")],-1))])])])):v("",!0),K.value==="notes"?(n(),r("div",Ua,[a("div",Ia,[d(A,{value:"Notes"}),a("div",Da,[e.notes&&e.notes.length>0?(n(),r("div",Aa,[(n(!0),r(se,null,ae(e.notes,(u,R)=>(n(),r("div",{key:R,class:"mb-4"},[a("div",Ra,[ve(a("textarea",{"onUpdate:modelValue":oe=>u.content=oe,readonly:!m(N),placeholder:"Note Content",class:"border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 rounded-md shadow-sm mt-1 block w-full h-32"},null,8,Na),[[Fe,u.content]])])]))),128))])):(n(),r("div",Ea," No notes found for this project. "))]),d(O,{message:U.value.notes?U.value.notes[0]:"",class:"mt-2"},null,8,["message"])])])):v("",!0),a("div",Oa,[d(Ie,{onClick:Be},{default:le(()=>l[29]||(l[29]=[Y("Close",-1)])),_:1,__:[29]})])],32)])}}};export{za as _};
