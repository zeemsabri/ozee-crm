import{s as h,x as Q,r as f,l as x,m as W,c as d,o as l,a as c,k as R,e as m,u as r,F as X,i as Y,w as C,g as D,t as q,n as A,f as Z,v as ee,y as te,q as F}from"./app-NvjusqzW.js";import{_ as P}from"./InputLabel-B-JvZrPi.js";import{_ as I}from"./TextInput-DQ5o7k5N.js";import"./EmailEditor.vue_vue_type_style_index_0_lang-Cyhcb-73.js";import{_ as L}from"./InputError-C86gSAlz.js";import{_ as M}from"./PrimaryButton-DyMJ23zT.js";import{S as ae}from"./SelectDropdown-D8hFvJSz.js";import{C as se}from"./CustomMultiSelect-UhXDZGRV.js";/* empty css                                                                       */import"./_plugin-vue_export-helper-DlAUqK2U.js";const oe="/api",le=async(b,V)=>(await h.post(`${oe}/projects/${b}/email-preview`,V)).data,ie={class:"p-4 space-y-6"},re={key:0},ne={key:0,class:"space-y-4"},de={class:"mb-4"},ce={key:0},me={key:0,class:"text-gray-500 text-sm mt-1"},ue={key:1},pe={key:0,class:"text-gray-500 text-sm mt-1"},_e={class:"mt-6"},ve={class:"flex justify-between items-center mb-3"},fe=["innerHTML"],be={key:1,class:"space-y-4"},ye={key:2,class:"flex items-center justify-end mt-4"},je={key:1},he={class:"mb-6"},we={class:"flex items-center justify-end"},De={__name:"EmailActionContent",props:{email:{type:Object,required:!0},mode:{type:String,required:!0}},emits:["submitted","error"],setup(b,{emit:V}){const o=b,$=V,a=Q({subject:"",body:"",rejection_reason:"",template_id:null,template_data:{}}),p=f(!1),S=f([]),_=f({}),y=f(!1),j=f(""),w=f(!1),H=x(()=>{var t;return((t=o.email)==null?void 0:t.type)==="sent"?"Approve & Send":"Approve"}),E=x(()=>{var t;return!!((t=o.email)!=null&&t.template_id)}),T=x(()=>S.value.find(t=>t.id===a.template_id)),N=x(()=>T.value?T.value.placeholders.filter(t=>t.is_dynamic||t.is_repeatable||t.is_selectable):[]),O=async()=>{try{const t=await h.get("/api/email-templates");S.value=t.data}catch(t){console.error("Failed to fetch email templates:",t)}},z=async t=>{var s,e,n;if(!(!((n=(e=(s=o.email)==null?void 0:s.conversation)==null?void 0:e.project)!=null&&n.id)||!t||!t.placeholders)){y.value=!0,_.value={};try{const u=t.placeholders.filter(i=>(i.is_selectable||i.is_repeatable)&&i.source_model);if(u.length===0){y.value=!1;return}const v={};u.forEach(i=>{v[i.source_model]||(v[i.source_model]=[]),v[i.source_model].push(i)});const K=Object.keys(v).map(async i=>{try{const U=await h.get(`/api/source-models/${encodeURIComponent(i)}`);v[i].forEach(g=>{_.value[g.name]=U.data.map(k=>({id:k.id,label:k[g.source_attribute]||k.name||`ID: ${k.id}`}))})}catch(U){console.error(`Failed to fetch data for model ${i}:`,U),v[i].forEach(g=>{_.value[g.name]=[]})}});await Promise.all(K)}catch(u){console.error("Error fetching source models data:",u)}finally{y.value=!1}}},B=async()=>{var t,s,e;if(!a.template_id||!((e=(s=(t=o.email)==null?void 0:t.conversation)==null?void 0:s.project)!=null&&e.id)){j.value='<p class="text-gray-500 italic">Select a template and a project to see a preview.</p>';return}w.value=!0;try{const n={template_id:a.template_id,template_data:a.template_data,client_id:o.email.conversation.conversable_id},u=await le(o.email.conversation.project.id,n);j.value=u.body_html,u.subject&&(a.subject=u.subject)}catch(n){console.error("Failed to fetch email preview:",n),j.value='<p class="text-red-500 italic">Error loading preview.</p>'}finally{w.value=!1}},G=async()=>{var t;if((t=o.email)!=null&&t.id){if(!o.email.template_id){console.error("This email does not use a template and cannot be edited in this workflow.");return}a.reset(),S.value=[],_.value={},j.value="";try{const e=(await h.get(`/api/emails/${o.email.id}/edit-content`)).data;a.subject=e.subject,a.body=e.body,a.rejection_reason="",e.template_id&&(a.template_id=e.template_id,a.template_data=e.template_data||{},await O(),await z(T.value),B())}catch(s){console.error("Failed to fetch email data:",s),$("error",s)}}},J=async()=>{p.value=!0;let t="",s={};o.mode==="reject"?(t=`/api/emails/${o.email.id}/reject`,s={rejection_reason:a.rejection_reason}):o.mode==="edit"&&(t=`/api/emails/${o.email.id}/edit-and-approve`,E.value?s={subject:a.subject,template_id:a.template_id,template_data:a.template_data,client_id:o.email.conversation.conversable_id}:s={subject:a.subject,body:a.body});try{await h.post(t,s),$("submitted")}catch(e){console.error("Form submission error:",e),$("error",e)}finally{p.value=!1,a.reset()}};return W(()=>o.email,t=>{t&&G()},{immediate:!0}),(t,s)=>(l(),d("div",ie,[c("form",{onSubmit:te(J,["prevent"])},[b.mode==="edit"?(l(),d("div",re,[E.value?(l(),d("div",ne,[c("div",de,[m(P,{for:"edit_subject",value:"Subject"}),m(I,{id:"edit_subject",type:"text",class:"mt-1 block w-full",modelValue:r(a).subject,"onUpdate:modelValue":s[0]||(s[0]=e=>r(a).subject=e),required:""},null,8,["modelValue"]),m(L,{message:r(a).errors.subject,class:"mt-2"},null,8,["message"])]),(l(!0),d(X,null,Y(N.value,e=>(l(),d("div",{key:e.name},[m(P,{for:e.name,value:e.label||e.name},null,8,["for","value"]),e.is_repeatable?(l(),d("div",ce,[y.value?(l(),d("div",me,"Loading options...")):(l(),F(se,{key:1,modelValue:r(a).template_data[e.name],"onUpdate:modelValue":n=>r(a).template_data[e.name]=n,options:_.value[e.name]||[],placeholder:`Select ${e.name}`,"label-key":"label","value-key":"id",class:"mt-1"},null,8,["modelValue","onUpdate:modelValue","options","placeholder"]))])):e.is_selectable?(l(),d("div",ue,[y.value?(l(),d("div",pe,"Loading options...")):(l(),F(ae,{key:1,id:e.name,modelValue:r(a).template_data[e.name],"onUpdate:modelValue":n=>r(a).template_data[e.name]=n,options:_.value[e.name]||[],placeholder:`Select a ${e.name}`,"value-key":"id","label-key":"label",class:"mt-1 block w-full"},null,8,["id","modelValue","onUpdate:modelValue","options","placeholder"]))])):(l(),F(I,{key:2,id:e.name,modelValue:r(a).template_data[e.name],"onUpdate:modelValue":n=>r(a).template_data[e.name]=n,type:"text",class:"mt-1 block w-full",placeholder:`Enter a value for ${e.name}`},null,8,["id","modelValue","onUpdate:modelValue","placeholder"])),m(L,{message:r(a).errors[`template_data.${e.name}`],class:"mt-2"},null,8,["message"])]))),128)),c("div",_e,[c("div",ve,[s[2]||(s[2]=c("h4",{class:"text-md font-semibold text-gray-800"},"Email Preview",-1)),m(M,{onClick:B,disabled:w.value},{default:C(()=>[D(q(w.value?"Loading...":"Refresh Preview"),1)]),_:1},8,["disabled"])]),c("div",{class:"bg-gray-100 p-4 rounded-lg shadow-inner min-h-[300px]",innerHTML:j.value},null,8,fe)])])):(l(),d("div",be,s[3]||(s[3]=[c("div",{class:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative",role:"alert"},[c("p",{class:"font-bold"},"Error"),c("p",null,"This email does not use a template and cannot be edited in this workflow.")],-1)]))),E.value?(l(),d("div",ye,[m(M,{class:A({"opacity-25":p.value}),disabled:p.value},{default:C(()=>[D(q(H.value),1)]),_:1},8,["class","disabled"])])):R("",!0)])):b.mode==="reject"?(l(),d("div",je,[c("div",he,[m(P,{for:"rejection_reason",value:"Rejection Reason"}),Z(c("textarea",{id:"rejection_reason",rows:"5",class:"border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 rounded-md shadow-sm mt-1 block w-full","onUpdate:modelValue":s[1]||(s[1]=e=>r(a).rejection_reason=e),required:"",placeholder:"Please provide a reason for rejecting this email (minimum 10 characters)"},null,512),[[ee,r(a).rejection_reason]]),m(L,{message:r(a).errors.rejection_reason,class:"mt-2"},null,8,["message"])]),c("div",we,[m(M,{class:A({"opacity-25":p.value}),disabled:p.value},{default:C(()=>s[4]||(s[4]=[D(" Reject Email ",-1)])),_:1,__:[4]},8,["class","disabled"])])])):R("",!0)],32)]))}};export{De as default};
