import{u as P}from"./workflowStore-DjV57QTj.js";import W from"./StepCard-D9mud0vP.js";import E from"./DataTokenInserter-JC-oaNQr.js";import{S as b}from"./SelectDropdown-BcA2DM2i.js";import{a as z}from"./RelatedDataPicker-CskaVr8d.js";import{P as H}from"./plus-5uR-idN0.js";import{T as J}from"./trash-Cd4CShhb.js";import{l as v,r as G,q as $,o as u,w as K,a as s,c as p,k as D,e as m,g as F,u as T,F as Q,i as Y,t as Z}from"./app-DBy4gMm0.js";import"./createLucideIcon-CTr2rqL2.js";/* empty css                                                                       */import"./_plugin-vue_export-helper-DlAUqK2U.js";const ee={class:"space-y-3"},le={key:0,class:"space-y-3"},te={class:"flex items-center justify-between"},ae={class:"space-y-2"},oe={class:"grid grid-cols-3 gap-2 items-center"},se={class:"flex items-center justify-end"},ne=["onClick"],ue={class:"grid grid-cols-2 gap-2"},re={class:"flex items-center gap-1"},ie={key:0,class:"text-xs text-gray-500 italic px-2"},de=["value","onChange"],pe=["value","onInput"],ve=["value","onInput"],me=["type","value","onInput"],ce={key:0,class:"col-span-2 mt-1"},be=["value","onInput"],ye={class:"flex items-center gap-2 pt-1"},fe={class:"inline-flex items-center gap-2 text-sm"},he=["checked"],_e={class:"p-2 border rounded-md bg-gray-50/60"},ge={class:"flex items-center justify-between"},xe={class:"text-[11px] text-gray-500"},Ue={__name:"FetchRecordsStep",props:{step:{type:Object,required:!0},allStepsBefore:{type:Array,default:()=>[]},loopContextSchema:{type:Object,default:null}},emits:["update:step","delete"],setup(y,{emit:U}){const h=y,_=U,N=P(),g=v(()=>N.automationSchema||[]),a=v({get:()=>h.step.step_config||{conditions:[]},set:l=>_("update:step",{...h.step,step_config:l})}),A=v(()=>g.value.map(l=>l.name)),O=v(()=>A.value.map(l=>({value:l,label:l}))),x=v(()=>a.value.model&&g.value.find(l=>l.name===a.value.model)||null);function w(l){if(!l||typeof l!="string")return"";let e=l.toLowerCase();if(e==="id")return"ID";e.endsWith("_id")&&(e=e.slice(0,-3)),e=e.replace(/[_-]+/g," ");let t=e.replace(/\b\w/g,o=>o.toUpperCase());return t=t.replace(/\bId\b/g,"ID").replace(/\bUrl\b/g,"URL"),t}const k=v(()=>x.value?(x.value.columns||[]).map(l=>typeof l=="string"?{name:l,label:w(l),type:"Text"}:{...l,label:l.label||w(l.name)}):[]),B=v(()=>k.value.map(l=>({value:l.name,label:`${l.label||l.name}${l.type?` (${l.type})`:""}`})));function i(l){return k.value.find(e=>e.name===l)||null}function R(l){const e=i(l);switch((e==null?void 0:e.type)||"Text"){case"True/False":return[{value:"==",label:"is"},{value:"!=",label:"is not"},{value:"is_null",label:"is null"},{value:"is_not_null",label:"is not null"}];case"Number":return[{value:"==",label:"equals"},{value:"!=",label:"not equals"},{value:">",label:">"},{value:"<",label:"<"},{value:">=",label:">="},{value:"<=",label:"<="},{value:"is_null",label:"is null"},{value:"is_not_null",label:"is not null"}];case"Date":case"DateTime":return[{value:"==",label:"on"},{value:"!=",label:"not on"},{value:">",label:"after"},{value:"<",label:"before"},{value:">=",label:"on or after"},{value:"<=",label:"on or before"},{value:"is_null",label:"is null"},{value:"is_not_null",label:"is not null"},{value:"older_than_hours",label:"older than X hours"},{value:"within_hours",label:"within last X hours"},{value:"older_than_days",label:"older than X days"},{value:"within_days",label:"within last X days"}];case"json":case"jsonb":case"Array":return[{value:"==",label:"is"},{value:"!=",label:"is not"},{value:"contains",label:"contains"},{value:"is_null",label:"is null"},{value:"is_not_null",label:"is not null"}];default:return[{value:"==",label:"is"},{value:"!=",label:"is not"},{value:"contains",label:"contains"},{value:"starts_with",label:"starts with"},{value:"ends_with",label:"ends with"},{value:"is_null",label:"is null"},{value:"is_not_null",label:"is not null"}]}}function q(){const l=[...a.value.conditions||[],{column:"",operator:"==",value:""}];a.value={...a.value,conditions:l}}function X(l){const e=(a.value.conditions||[]).filter((t,o)=>o!==l);a.value={...a.value,conditions:e}}function d(l,e,t){const o=[...a.value.conditions||[]];o[l]={...o[l],[e]:t},a.value={...a.value,conditions:o}}function L(l,e){var r;const o=((r=(a.value.conditions||[])[l])==null?void 0:r.value)||"";d(l,"value",`${o}${e}`)}const f=G(!1),M=v(()=>{const l=a.value.relationships||{},e=Array.isArray(l.roots)?l.roots:[],t=l.nested||{};if(!e.length)return"None";const o=[];return e.forEach(r=>{const c=Array.isArray(t[r])?t[r]:[];c.length?o.push(`${r} (+ ${c.join(", ")})`):o.push(r)}),o.join(", ")});return(l,e)=>(u(),$(W,{icon:"ðŸ”",title:"Fetch Records",onDelete:()=>_("delete")},{default:K(()=>[s("div",ee,[s("div",null,[e[5]||(e[5]=s("label",{class:"block text-xs font-medium text-gray-600 mb-1"},"Find records from",-1)),m(b,{options:O.value,"model-value":a.value.model||null,placeholder:"Select model...","onUpdate:modelValue":e[0]||(e[0]=t=>a.value={...a.value,model:t,conditions:[]})},null,8,["options","model-value"])]),a.value.model?(u(),p("div",le,[s("div",te,[e[7]||(e[7]=s("label",{class:"text-xs font-medium text-gray-600"},"Where conditions match",-1)),s("button",{onClick:q,class:"flex items-center gap-1 px-2 py-1 text-xs rounded-md bg-gray-100 hover:bg-gray-200"},[m(T(H),{class:"h-3 w-3"}),e[6]||(e[6]=F(" Add",-1))])]),s("div",ae,[(u(!0),p(Q,null,Y(a.value.conditions,(t,o)=>{var r,c,C,S,I,V,j;return u(),p("div",{key:o,class:"p-2 border rounded-md bg-gray-50/50 space-y-2"},[s("div",oe,[m(b,{options:B.value,"model-value":t.column||null,placeholder:"Field...","onUpdate:modelValue":n=>d(o,"column",n),class:"col-span-2"},null,8,["options","model-value","onUpdate:modelValue"]),s("div",se,[s("button",{onClick:n=>X(o),class:"p-1 text-gray-400 hover:text-red-500"},[m(T(J),{class:"w-4 h-4"})],8,ne)])]),s("div",ue,[m(b,{options:R(t.column),"model-value":t.operator||"==",placeholder:"Operator","onUpdate:modelValue":n=>d(o,"operator",n)},null,8,["options","model-value","onUpdate:modelValue"]),s("div",re,[t.operator==="is_null"||t.operator==="is_not_null"?(u(),p("span",ie,"No value needed")):(r=i(t.column))!=null&&r.allowed_values?(u(),$(b,{key:1,options:(i(t.column).allowed_values||[]).map(n=>({value:n.value,label:n.label})),"model-value":t.value||null,placeholder:"Select value...","onUpdate:modelValue":n=>d(o,"value",n)},null,8,["options","model-value","onUpdate:modelValue"])):((c=i(t.column))==null?void 0:c.type)==="True/False"?(u(),p("select",{key:2,value:t.value??"true",onChange:n=>d(o,"value",n.target.value),class:"w-full border rounded px-2 py-2 text-sm"},e[8]||(e[8]=[s("option",{value:"true"},"True",-1),s("option",{value:"false"},"False",-1)]),40,de)):t.operator==="older_than_hours"||t.operator==="within_hours"?(u(),p("input",{key:3,type:"number",value:t.value,onInput:n=>d(o,"value",n.target.value),placeholder:"Hours (e.g. 24)",min:"1",class:"w-full border rounded px-2 py-2 text-sm"},null,40,pe)):t.operator==="older_than_days"||t.operator==="within_days"?(u(),p("input",{key:4,type:"number",value:t.value,onInput:n=>d(o,"value",n.target.value),placeholder:"Days (e.g. 7)",min:"1",class:"w-full border rounded px-2 py-2 text-sm"},null,40,ve)):(u(),p("input",{key:5,type:((C=i(t.column))==null?void 0:C.type)==="Date"?"date":((S=i(t.column))==null?void 0:S.type)==="DateTime"?"datetime-local":"text",value:t.value,onInput:n=>d(o,"value",n.target.value),placeholder:"Value",class:"w-full border rounded px-2 py-2 text-sm"},null,40,me)),m(E,{"all-steps-before":y.allStepsBefore,"loop-context-schema":y.loopContextSchema,onInsert:n=>L(o,n)},null,8,["all-steps-before","loop-context-schema","onInsert"])]),((I=i(t.column))==null?void 0:I.type)==="json"||((V=i(t.column))==null?void 0:V.type)==="jsonb"||((j=i(t.column))==null?void 0:j.type)==="Array"?(u(),p("div",ce,[e[9]||(e[9]=s("label",{class:"block text-[10px] font-medium text-gray-500 mb-1"},"Nested JSON Path (optional)",-1)),s("input",{type:"text",value:t.json_path||"",onInput:n=>d(o,"json_path",n.target.value),placeholder:"e.g. metadata.key or address.city",class:"w-full border border-gray-300 rounded-md px-2 py-1.5 text-xs bg-gray-50"},null,40,be)])):D("",!0)])])}),128))]),s("div",ye,[s("label",fe,[s("input",{type:"checkbox",checked:!!a.value.single,onChange:e[1]||(e[1]=t=>a.value={...a.value,single:t.target.checked}),class:"rounded border-gray-300"},null,40,he),e[10]||(e[10]=F(" Only first match (single record) ",-1))])]),s("div",_e,[s("div",ge,[s("div",null,[e[11]||(e[11]=s("p",{class:"text-xs font-medium text-gray-700"},"Include Related Data",-1)),s("p",xe,Z(M.value),1)]),s("button",{type:"button",class:"text-xs px-2 py-1 rounded-md bg-white ring-1 ring-gray-300 hover:bg-gray-50",onClick:e[2]||(e[2]=t=>f.value=!0)},"Chooseâ€¦")]),m(z,{show:f.value,"base-model-name":a.value.model,"model-value":a.value.relationships||{base_model:a.value.model,roots:[],nested:{},fields:{}},"onUpdate:modelValue":e[3]||(e[3]=t=>a.value={...a.value,relationships:t}),onClose:e[4]||(e[4]=t=>f.value=!1)},null,8,["show","base-model-name","model-value"])])])):D("",!0)])]),_:1},8,["onDelete"]))}};export{Ue as default};
