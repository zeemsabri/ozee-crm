import{u as re}from"./workflowStore-CDwDjLaB.js";import ie from"./StepCard-TAz2KSIF.js";import{_ as ue,a as me}from"./RelatedDataPicker-DWiYHZRR.js";import{B as pe}from"./BaseFormModal-6yVAnSP5.js";import de from"./PromptForm-2qVhxUGl.js";import{S as ce}from"./SelectDropdown-DhOYwl6i.js";import fe from"./DataTokenInserter-CiDU8Fje.js";import{C as ve}from"./circle-x-D6hfqeok.js";import{c as a,e as q,f as ge,r as T,a as r,o as n,d as b,w as X,b as o,i as _,t as p,F as v,l as R,m as g,u as ye,g as he}from"./app-DolmfznG.js";import"./trash-D2MGtj0k.js";import"./createLucideIcon-BFcFlxUt.js";import"./Modal-T6a1k2oM.js";import"./PrimaryButton-BgzXgDuT.js";import"./SecondaryButton-LmL9DseJ.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./ResponseBuilder-BSh8u4ip.js";import"./FieldBuilder-06VR3bN3.js";import"./chevron-down-By9GPkju.js";/* empty css                                                                       */const xe={class:"mb-3"},be={class:"flex gap-2 mt-1 items-center"},_e={class:"flex-1"},Se=["disabled"],ke={key:0,class:"text-[11px] text-gray-500 mt-1"},we={class:"space-y-1 mb-4"},Ce={class:"flex items-start gap-2 mt-1"},Ie=["value"],Ae={class:"space-y-2"},$e={class:"p-2 bg-gray-50 rounded-md border space-y-2"},Pe={class:"text-sm font-medium text-indigo-700"},Ne=["onClick"],Oe={class:"flex items-center justify-between"},Te={class:"text-xs inline-flex items-center gap-1"},Re=["checked"],Ve={key:0,class:"border-t pt-3 mt-3"},je={class:"flex items-center justify-between"},Ee={class:"block text-sm font-medium text-gray-700"},Le={key:0,class:"mt-2 text-xs text-gray-700"},Fe={class:"list-disc ml-5 space-y-0.5"},Be={class:"space-y-2"},Me={class:"p-2 bg-gray-50 rounded border"},De={key:0,class:"text-xs text-gray-500"},We={key:1,class:"text-xs text-gray-700 space-y-1"},Je={class:"font-medium"},Ue={key:0,class:"ml-4 list-disc"},ze={class:"font-medium"},dt={__name:"AIStep",props:{step:{type:Object,required:!0},allStepsBefore:{type:Array,default:()=>[]},loopContextSchema:{type:Object,default:null}},emits:["update:step","delete"],setup(V,{emit:K}){const f=V,M=K,y=re(),j=a(()=>y.automationSchema||[]);a(()=>y.campaigns||[]);const D=a(()=>y.prompts||[]),$=a(()=>{const t=Array.isArray(D.value)?[...D.value]:[];return t.sort((e,s)=>{const l=(e.name||"").localeCompare(s.name||"");return l!==0?l:(s.version||0)-(e.version||0)}),t}),Q=a(()=>$.value.map(t=>({value:t.id,label:`${t.name} (v${t.version})`}))),u=a({get:()=>f.step.step_config||{},set:t=>M("update:step",{...f.step,step_config:t})}),P=a(()=>{var e,s;const t=(s=(e=u.value)==null?void 0:e.promptRef)==null?void 0:s.id;return t&&$.value.find(l=>String(l.id)===String(t))||null});q(P,t=>{if(t&&Array.isArray(t.response_variables)){const e=JSON.parse(JSON.stringify(t.response_variables));d("responseStructure",e)}},{immediate:!0}),ge(()=>{y.prompts.length||y.fetchPrompts()});const w=a({get:()=>{var t,e;return((e=(t=u.value)==null?void 0:t.promptRef)==null?void 0:e.id)||null},set:t=>{const e=$.value.find(s=>String(s.id)===String(t))||null;e?d("promptRef",{id:e.id,name:e.name,version:e.version}):d("promptRef",null)}}),S=T(!1),E=T("create"),h=T(null);function Z(){E.value="create",h.value={name:"New Prompt",category:"General",version:1,system_prompt_text:`You are a helpful AI assistant.

Use the provided template variables like {{example_variable}} to craft your response.`,model_name:"gemini-2.5-flash-preview-05-20",generation_config:{temperature:.7,maxOutputTokens:2048,responseMimeType:"application/json"},template_variables:["example_variable"],response_variables:[],response_json_template:[],status:"draft"},S.value=!0}function ee(){const t=w.value,e=$.value.find(s=>s.id===t);e&&(E.value="edit",h.value=JSON.parse(JSON.stringify(e)),S.value=!0)}async function te(t){try{let e;if(t.id&&!t.isNewVersion)e=await y.updatePrompt(t.id,t);else{const{id:s,isNewVersion:l,...c}=t;e=await y.createPrompt(c)}e&&e.id&&(w.value=e.id),S.value=!1,h.value=null}catch(e){console.error("Failed to save prompt from modal",e)}}const C=a(()=>f.allStepsBefore.find(t=>t.step_type==="TRIGGER")),W=a(()=>{var t,e;return((e=(t=C.value)==null?void 0:t.step_config)==null?void 0:e.model)||"Trigger"}),N=a(()=>{var t;return!C.value||!((t=C.value.step_config)!=null&&t.model)?null:j.value.find(e=>e.name===C.value.step_config.model)}),L=a(()=>Array.isArray(u.value.aiInputs)?u.value.aiInputs:[]),se=a(()=>L.value.filter(t=>typeof t=="string"&&(t.startsWith("trigger:")||!t.includes(":"))).map(t=>t.startsWith("trigger:")?t.slice(8):t)),oe=a(()=>L.value.filter(t=>typeof t=="string"&&t.startsWith("loop:")).map(t=>t.slice(5)));a(()=>{if(!N.value)return[];const t=new Set(se.value);return(N.value.columns||[]).filter(e=>!t.has(e.name||e))});const J=a(()=>{var H,Y;if(f.loopContextSchema&&Array.isArray(f.loopContextSchema.columns)&&f.loopContextSchema.columns.length>0)return f.loopContextSchema;const t=[...f.allStepsBefore].reverse().find(m=>{var x;return m.step_type==="FOR_EACH"&&((x=m.step_config)==null?void 0:x.sourceArray)});if(!t)return null;const e=t.step_config.sourceArray,s=typeof e=="string"?e.match(/{{\s*step_(\w+)\.(.+?)\s*}}/):null;if(!s)return null;const l=s[1],c=s[2],I=f.allStepsBefore.find(m=>String(m.id)===String(l));if(!I)return null;if(I.step_type==="AI_PROMPT"){const m=(((H=I.step_config)==null?void 0:H.responseStructure)||[]).find(x=>x.name===c);return(m==null?void 0:m.type)==="Array of Objects"?{name:"Loop Item",columns:m.schema||[]}:null}if(I.step_type==="FETCH_RECORDS"&&c==="records"){const m=(Y=I.step_config)==null?void 0:Y.model;if(!m)return null;const x=j.value.find(A=>A.name===m);return x?{name:"Loop Item",columns:(x.columns||[]).map(A=>typeof A=="string"?{name:A}:A),modelName:m}:null}return null}),U=a(()=>{const t=J.value;if(!t||!Array.isArray(t.columns)||t.columns.length===0)return[];const e=new Set(oe.value);return t.columns.map(s=>typeof s=="string"?{name:s,label:s}:{name:s.name,label:s.label||s.name}).filter(s=>s.name&&!e.has(s.name))}),O=a(()=>{const t=[];if(N.value){const e=W.value||"Trigger";(N.value.columns||[]).forEach(s=>{const l=typeof s=="string"?s:s.name||"",c=typeof s=="string"?s:s.label||s.name||"";l&&t.push({value:`trigger:${l}`,label:`Trigger: ${e} â€” ${c}`})})}return U.value.length>0&&U.value.forEach(e=>{const s=e.name,l=e.label||e.name;s&&t.push({value:`loop:${s}`,label:`Current Loop Item â€” ${l}`})}),t}),F=a({get:()=>(Array.isArray(u.value.aiInputs)?u.value.aiInputs:[]).map(e=>typeof e=="string"&&e.includes(":")?e:`trigger:${e}`),set:t=>{d("aiInputs",Array.isArray(t)?t:[])}}),z=a(()=>{const t=O.value.length,e=new Set(F.value||[]),s=new Set(O.value.map(c=>c.value));let l=0;return s.forEach(c=>{e.has(c)&&l++}),t>0&&l===t});function le(){z.value?d("aiInputs",[]):d("aiInputs",O.value.map(t=>t.value))}const k=a(()=>{var t,e,s;return((t=J.value)==null?void 0:t.modelName)||((s=(e=C.value)==null?void 0:e.step_config)==null?void 0:s.model)||null}),G=a(()=>k.value?j.value.find(t=>t.name===k.value):null),i=a({get:()=>u.value.relationships||{base_model:k.value||null,roots:[],nested:{},fields:{}},set:t=>d("relationships",t)});q(k,t=>{const e=i.value||{};e.base_model!==t&&(i.value={...e,base_model:t})},{immediate:!0}),a(()=>{var t;return((t=G.value)==null?void 0:t.relationships)||[]});function d(t,e){u.value={...u.value,[t]:e}}function ae(t){const e=L.value;d("aiInputs",e.filter(s=>s!==t))}a(()=>{const t=u.value.responseStructure||[];if(t.length===0)return"";const e=s=>(s||[]).filter(l=>l.name).map(l=>l.type==="Array of Objects"?`"${l.name}": [{ ${e(l.schema||[])} }]`:`"${l.name}": <${l.type.toLowerCase()}>`).join(", ");return`Respond with JSON in this exact format: { ${e(t)} }`});const B=T(!1);function ne(t){const e=u.value.freeText||"";d("freeText",e+t)}return(t,e)=>(n(),r(v,null,[b(ie,{icon:"ðŸ§ ",title:"Analyze with AI",onDelete:()=>M("delete")},{default:X(()=>[o("div",xe,[e[8]||(e[8]=o("label",{class:"block text-sm font-medium text-gray-700"},"Prompt",-1)),o("div",be,[o("div",_e,[b(ce,{options:Q.value,modelValue:w.value,"onUpdate:modelValue":e[0]||(e[0]=s=>w.value=s),placeholder:"â€” Select a prompt â€”"},null,8,["options","modelValue"])]),o("button",{type:"button",onClick:Z,class:"px-2 py-1 text-xs font-semibold text-white bg-indigo-600 rounded-md hover:bg-indigo-700"},"Create"),o("button",{type:"button",onClick:ee,disabled:!w.value,class:"px-2 py-1 text-xs font-semibold bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"},"Edit",8,Se)]),P.value?(n(),r("p",ke,"Linked: "+p(P.value.name)+" (v"+p(P.value.version)+")",1)):_("",!0)]),o("div",we,[e[9]||(e[9]=o("label",{class:"block text-sm font-medium text-gray-700"},"Custom Text (optional)",-1)),o("div",Ce,[o("textarea",{value:u.value.freeText||"",onInput:e[1]||(e[1]=s=>d("freeText",s.target.value)),class:"w-full p-2 border border-gray-300 rounded-md text-sm min-h-[90px]",placeholder:"Type or paste text hereâ€¦ You can insert tokens like {{trigger.email.body}} or {{step_12.cleaned_body}}"},null,40,Ie),b(fe,{"all-steps-before":V.allStepsBefore,"loop-context-schema":V.loopContextSchema,onInsert:ne},null,8,["all-steps-before","loop-context-schema"])]),e[10]||(e[10]=o("p",{class:"text-[11px] text-gray-500"},"If provided, this text will be sent to the AI as the primary body, even if fields are selected below.",-1))]),o("div",Ae,[e[12]||(e[12]=o("h4",{class:"text-sm font-medium text-gray-700"},"Data to Analyze",-1)),o("div",$e,[(n(!0),r(v,null,R(u.value.aiInputs||[],s=>(n(),r("div",{key:s,class:"flex items-center justify-between bg-white p-1 rounded border"},[o("span",Pe,[typeof s=="string"&&s.startsWith("loop:")?(n(),r(v,{key:0},[g(" Current Loop Item: "+p(s.slice(5)),1)],64)):(n(),r(v,{key:1},[g(p(W.value)+": "+p(typeof s=="string"&&s.startsWith("trigger:")?s.slice(8):s),1)],64))]),o("button",{onClick:l=>ae(s),class:"text-gray-400 hover:text-red-500"},[b(ye(ve),{class:"h-4 w-4"})],8,Ne)]))),128)),o("div",Oe,[o("label",Te,[o("input",{type:"checkbox",checked:z.value,onChange:le,class:"rounded border-gray-300"},null,40,Re),e[11]||(e[11]=g(" Select all ",-1))])]),b(ue,{options:O.value,"model-value":F.value,placeholder:"Select fields from Trigger and/or Current Loop Item...","onUpdate:modelValue":e[2]||(e[2]=s=>F.value=s)},null,8,["options","model-value"])])]),G.value?(n(),r("div",Ve,[o("div",je,[o("label",Ee,"Include Related Data from "+p(k.value),1),o("button",{onClick:e[3]||(e[3]=s=>B.value=!0),type:"button",class:"text-xs px-2 py-1 rounded-md bg-white ring-1 ring-gray-300 hover:bg-gray-50"},"Chooseâ€¦")]),i.value&&(i.value.roots&&i.value.roots.length||Object.keys(i.value.fields||{}).length)?(n(),r("div",Le,[e[13]||(e[13]=o("p",{class:"font-medium"},"Summary",-1)),o("ul",Fe,[(n(!0),r(v,null,R(i.value.roots||[],s=>(n(),r("li",{key:"sum-"+s},[g(p(s)+" ",1),i.value.fields&&i.value.fields[s]&&i.value.fields[s].length&&!i.value.fields[s].includes("*")?(n(),r(v,{key:0},[g(" â€” fields: "+p(i.value.fields[s].join(", ")),1)],64)):_("",!0),i.value.nested&&i.value.nested[s]&&i.value.nested[s].length?(n(),r(v,{key:1},[g(" â€” also: "+p(i.value.nested[s].map(l=>s+"."+l).join(", ")),1)],64)):_("",!0)]))),128))]),e[14]||(e[14]=o("p",{class:"text-[11px] text-gray-500 mt-1"},"Selected related records will be available in your prompt under the with key (e.g., with.campaign, with.campaign.leads).",-1))])):_("",!0),b(me,{show:B.value,"base-model-name":k.value,modelValue:i.value,"onUpdate:modelValue":e[4]||(e[4]=s=>i.value=s),onClose:e[5]||(e[5]=s=>B.value=!1)},null,8,["show","base-model-name","modelValue"])])):_("",!0),o("div",Be,[e[16]||(e[16]=o("h4",{class:"text-sm font-medium text-gray-700"},"Expected AI Response Structure",-1)),o("div",Me,[u.value.responseStructure&&u.value.responseStructure.length?(n(),r("ul",We,[(n(!0),r(v,null,R(u.value.responseStructure,s=>(n(),r("li",{key:"r-"+s.id},[o("span",Je,p(s.name),1),g(": "+p(s.type)+" ",1),s.schema&&s.schema.length?(n(),r("ul",Ue,[(n(!0),r(v,null,R(s.schema,l=>(n(),r("li",{key:"r-"+s.id+"-"+l.id},[o("span",ze,p(l.name),1),g(": "+p(l.type),1)]))),128))])):_("",!0)]))),128))])):(n(),r("p",De," Link a Prompt to auto-fill the expected response structure. ")),e[15]||(e[15]=o("p",{class:"text-[11px] text-gray-500 mt-1"},"To change the structure, edit the linked Prompt.",-1))])])]),_:1},8,["onDelete"]),b(pe,{show:S.value,title:E.value==="create"?"Create Prompt":"Edit Prompt",formData:h.value||{},showFooter:!1,onClose:e[7]||(e[7]=s=>S.value=!1)},{default:X(()=>[h.value?(n(),he(de,{key:0,prompt:h.value,onSave:te,onCancel:e[6]||(e[6]=s=>{S.value=!1,h.value=null})},null,8,["prompt"])):_("",!0)]),_:1},8,["show","title","formData"])],64))}};export{dt as default};
