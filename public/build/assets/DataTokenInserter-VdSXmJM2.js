import{u as M}from"./workflowStore-BE3mQCmw.js";import{r as L,f as j,Q as H,c as A,a as b,o as h,b as w,g as D,i as z,k as B,v as U,x as V,F,l as W,t as P,Y as G,n as X}from"./app-CDd5Lidm.js";const Y=["disabled"],q={class:"p-2 border-b"},Q={class:"px-3 py-1.5 text-[11px] font-semibold uppercase tracking-wide text-gray-500 bg-gray-50"},J=["onClick"],K={key:1,class:"px-3 py-2 text-xs text-gray-500"},Z={__name:"DataTokenPicker",props:{groups:{type:Array,default:()=>[]},placeholder:{type:String,default:""},disabled:{type:Boolean,default:!1},maxHeight:{type:String,default:"300px"},minWidth:{type:[String,Number],default:320},maxPanelWidth:{type:[String,Number],default:480}},emits:["select"],setup($,{emit:I}){const d=$,N=I,v=L(!1),y=L(null),x=L(null),_=L({top:0,left:0,width:0}),C=L(""),k=r=>{if(typeof r=="number")return r;const e=parseInt(String(r).replace("px",""));return isNaN(e)?0:e};function a(){d.disabled||(v.value=!v.value,X(()=>s()))}function s(){const r=y.value;if(!r)return;const e=r.getBoundingClientRect(),t=8,o=window.innerWidth||document.documentElement.clientWidth,p=Math.max(e.width,k(d.minWidth)),c=Math.min(k(d.maxPanelWidth),o-t*2),n=Math.min(Math.max(p,k(d.minWidth)),c);let l=e.left+window.scrollX;l+n+t>o+window.scrollX&&(l=o+window.scrollX-n-t,l<t&&(l=t)),_.value={top:e.bottom+window.scrollY,left:l,width:n}}function m(){v.value&&s()}function f(r){const e=y.value&&y.value.contains(r.target),t=x.value&&x.value.contains(r.target);!e&&!t&&(v.value=!1)}j(()=>{window.addEventListener("scroll",m,!0),window.addEventListener("resize",m),document.addEventListener("click",f)}),H(()=>{window.removeEventListener("scroll",m,!0),window.removeEventListener("resize",m),document.removeEventListener("click",f)}),A(()=>{const r=[];return(d.groups||[]).forEach((e,t)=>{(e.fields||[]).forEach((o,p)=>{r.push({groupIndex:t,itemIndex:p,group:e.name||"Data",label:o.label,value:o.value})})}),r});const S=A(()=>{const r=C.value.trim().toLowerCase();if(!r)return d.groups;const e=[];return(d.groups||[]).forEach(t=>{const o=(t.fields||[]).filter(p=>String(p.label||"").toLowerCase().includes(r));o.length&&e.push({name:t.name,fields:o})}),e});function T(r){N("select",r),v.value=!1}return(r,e)=>(h(),b("div",{class:"relative inline-block",ref_key:"triggerRef",ref:y},[w("button",{type:"button",onClick:a,disabled:$.disabled,"aria-label":"Insert data",class:"inline-flex items-center justify-center rounded-full border border-gray-300 bg-white p-1.5 text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-60"},e[1]||(e[1]=[w("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-4 w-4",viewBox:"0 0 20 20",fill:"currentColor"},[w("path",{"fill-rule":"evenodd",d:"M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z","clip-rule":"evenodd"})],-1)]),8,Y),(h(),D(G,{to:"body"},[v.value?(h(),b("div",{key:0,ref_key:"portalRef",ref:x,class:"fixed z-[9999] bg-white rounded-md shadow-xl ring-1 ring-black ring-opacity-5",style:B({top:_.value.top+"px",left:_.value.left+"px",width:_.value.width+"px",maxWidth:"min(480px, 96vw)"})},[w("div",q,[U(w("input",{type:"text","onUpdate:modelValue":e[0]||(e[0]=t=>C.value=t),placeholder:"Search fields...",class:"w-full border border-gray-200 rounded px-2 py-1 text-xs focus:ring-indigo-500 focus:border-indigo-500"},null,512),[[V,C.value]])]),w("div",{class:"max-h-[calc(100vh-180px)] overflow-auto",style:B({maxHeight:$.maxHeight})},[S.value&&S.value.length?(h(!0),b(F,{key:0},W(S.value,t=>(h(),b("div",{key:t.name,class:"py-1"},[w("div",Q,P(t.name),1),(h(!0),b(F,null,W(t.fields||[],o=>(h(),b("button",{key:o.value,type:"button",class:"w-full text-left px-3 py-2 text-sm hover:bg-gray-50",onClick:p=>T(o.value)},P(o.label),9,J))),128))]))),128)):(h(),b("div",K,"No data available"))],4)],4)):z("",!0)]))],512))}},oe={__name:"DataTokenInserter",props:{allStepsBefore:{type:Array,default:()=>[]},loopContextSchema:{type:Object,default:null},inferLoopFromNearest:{type:Boolean,default:!0}},emits:["insert"],setup($,{emit:I}){const d=$,N=I,v=M(),y=A(()=>v.automationSchema||[]);function x(a){if(!a||typeof a!="string")return"";let s=a.toLowerCase();if(s==="id")return"ID";s.endsWith("_id")&&(s=s.slice(0,-3)),s=s.replace(/[_-]+/g," ");let m=s.replace(/\b\w/g,f=>f.toUpperCase());return m=m.replace(/\bId\b/g,"ID").replace(/\bUrl\b/g,"URL"),m}const _=A(()=>{var S,T,r;const a=[];let s=d.loopContextSchema;const m=e=>{const t=String((e==null?void 0:e.type)||"").toLowerCase(),o=String((e==null?void 0:e.itemType)||"").toLowerCase();return t==="array of objects"||t==="array"&&o==="object"};if(!s&&d.inferLoopFromNearest){const e=[...d.allStepsBefore].reverse().find(t=>{var o;return t.step_type==="FOR_EACH"&&((o=t.step_config)==null?void 0:o.sourceArray)});if(e){const t=e.step_config.sourceArray,o=typeof t=="string"?t.match(/{{step_(\w+)\.(.+)}}/):null;if(o){const p=o[1],c=o[2],n=d.allStepsBefore.find(l=>String(l.id)===String(p));if((n==null?void 0:n.step_type)==="AI_PROMPT"){const l=(((S=n.step_config)==null?void 0:S.responseStructure)||[]).find(g=>g.name===c);m(l)&&(s={name:"Loop Item",columns:l.schema||[]})}if(!s&&(n==null?void 0:n.step_type)==="FETCH_RECORDS"&&c==="records"){const l=(T=n.step_config)==null?void 0:T.model,g=y.value.find(u=>u.name===l);g&&(s={name:"Loop Item",columns:(g.columns||[]).map(i=>typeof i=="string"?{name:i}:i)})}}}}s&&Array.isArray(s.columns)&&(a.push({name:"Current Loop Item (from For Each)",fields:s.columns.filter(e=>!!(e&&e.name)).map(e=>({label:e.name,value:`{{loop.item.${e.name}}}`}))}),a.push({name:"Loop Details",fields:[{label:"index",value:"{{loop.index}}"},{label:"is_first",value:"{{loop.is_first}}"},{label:"is_last",value:"{{loop.is_last}}"}]}));const f=d.allStepsBefore.find(e=>e.step_type==="TRIGGER");if(f&&((r=f.step_config)!=null&&r.model)){const e=y.value.find(t=>t.name===f.step_config.model);e&&a.push({name:`Trigger: ${f.step_config.model}`,fields:e.columns.map(t=>{const o=typeof t=="string"?t:t.name||"";return{label:typeof t=="string"?x(t):t.label||t.name||"",value:`{{trigger.${f.step_config.model.toLowerCase()}.${o}}}`}})})}return d.allStepsBefore.forEach((e,t)=>{var o,p;if(e.step_type==="AI_PROMPT"&&((p=(o=e.step_config)==null?void 0:o.responseStructure)==null?void 0:p.length)>0){const c=[],n=(l,g="",u=0)=>{(l||[]).forEach(i=>{if(!(i!=null&&i.name))return;const E=g?`${g}.${i.name}`:i.name,O="  ".repeat(u);c.push({label:`${O}${i.name}`,value:`{{step_${e.id}.${E}}}`}),Array.isArray(i.schema)&&(m(i)?i.schema.forEach(R=>{R!=null&&R.name&&c.push({label:`${O}  - ${R.name} (from array item)`,value:`{{step_${e.id}.${E}.${R.name}}}`})}):i.type==="Object"&&n(i.schema,E,u+1))})};n(e.step_config.responseStructure),a.push({name:`Step ${t+1}: AI Response`,fields:c})}if(e.step_type==="FETCH_RECORDS"){const c=[{label:"records (array)",value:`{{step_${e.id}.records}}`},{label:"count",value:`{{step_${e.id}.count}}`}],n=e.step_config&&e.step_config.model?e.step_config.model:null,l=`Step ${t+1}: Fetch Records`+(n?` — ${n}`:"");if(e.step_config&&e.step_config.single&&n){const g=y.value.find(u=>u.name===n);g&&(g.columns||[]).forEach(u=>{const i=typeof u=="string"?u:u.name||"",E=typeof u=="string"?x(u):u.label||u.name||"";i&&c.push({label:`record.${E}`,value:`{{step_${e.id}.record.${i}}}`})}),c.push({label:"record (object)",value:`{{step_${e.id}.record}}`})}a.push({name:l,fields:c})}if(e.step_type==="TRANSFORM_CONTENT"){const c=[{label:"cleaned_body",value:`{{step_${e.id}.cleaned_body}}`},{label:"result",value:`{{step_${e.id}.result}}`}];a.push({name:`Step ${t+1}: Transformed Content`,fields:c})}if(e.step_type==="ACTION"&&e.step_config&&e.step_config.action_type==="CREATE_RECORD"){const c=e.step_config.target_model||"",n=`Step ${t+1}: Create Record`+(c?` — ${c}`:""),l=[{label:"new_record_id",value:`{{step_${e.id}.new_record_id}}`},{label:"id (legacy)",value:`{{step_${e.id}.id}}`}];a.push({name:n,fields:l})}}),a}),C=A(()=>_.value.some(a=>Array.isArray(a.fields)&&a.fields.length>0));function k(a){a&&N("insert",a)}return(a,s)=>(h(),D(Z,{groups:_.value,disabled:!C.value,onSelect:k},null,8,["groups","disabled"]))}};export{oe as default};
