<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Flipbook Reader</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Using an older, more compatible version of jQuery for turn.js -->
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <!-- turn.js for the flipbook effect -->
    <script type="text/javascript" src="/turn.min.js"></script>
    <!-- PDF.js for rendering PDF files -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>


    <style>
        body {
            overflow: hidden;
            background-color: #333;
            font-family: 'Inter', sans-serif;
        }
        #flipbook-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100vw;
        }
        #flipbook {
            /* Width and height will now be set dynamically by the script */
            display: none; /* Initially hidden until pages are loaded */
        }
        #flipbook .page {
            background-color: white;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center center;
        }
        #flipbook .page-wrapper {
            -webkit-perspective: 2000px;
            -moz-perspective: 2000px;
            -ms-perspective: 2000px;
            -o-perspective: 2000px;
            perspective: 2000px;
        }
        #flipbook .shadow {
            -webkit-box-shadow: 0 4px 10px #666;
            -moz-box-shadow: 0 4px 10px #666;
            -ms-box-shadow: 0 4px 10px #666;
            -o-box-shadow: 0 4px 10px #666;
            box-shadow: 0 4px 10px #666;
        }
        #loader {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
            z-index: 200;
        }
        #file-selector {
            position: absolute;
            top: 1.5rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 201; /* Increased z-index to be above the loader */
        }
        /* Style for the canvas elements to ensure they scale correctly within the page div */
        #flipbook canvas {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>

<div id="file-selector" class="flex items-center gap-4 p-4 bg-gray-800 rounded-lg shadow-lg">
    <label for="pdf-file" class="text-white font-semibold">Choose a PDF Book:</label>
    <input type="file" id="pdf-file" accept=".pdf" class="text-white file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100"/>
</div>

<div id="loader">
    <h2 class="text-3xl font-bold mb-4">Please select a PDF file to begin.</h2>
    <p class="text-lg">This reader turns your PDF into an interactive flipbook.</p>
</div>

<div id="flipbook-container">
    <div id="flipbook"></div>
</div>

<script type="text/javascript">
    $(document).ready(function() {
        // Set worker path for PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;

        $('#pdf-file').on('change', function(event) {
            const file = event.target.files[0];
            if (!file || file.type !== 'application/pdf') {
                alert('Please select a valid PDF file.');
                return;
            }

            const fileReader = new FileReader();
            fileReader.onload = function() {
                const typedarray = new Uint8Array(this.result);
                loadFlipbook(typedarray);
            };
            fileReader.readAsArrayBuffer(file);
        });

        function loadFlipbook(pdfData) {
            $('#loader').html('<h2 class="text-2xl font-bold animate-pulse">Loading Book...</h2>').show();
            // Destroy any existing flipbook instance before creating a new one
            if ($('#flipbook').turn('is')) {
                $('#flipbook').turn('destroy');
            }
            $('#flipbook').hide().html('');

            const loadingTask = pdfjsLib.getDocument(pdfData);
            loadingTask.promise.then(function(pdf) {
                const numPages = pdf.numPages;
                const renderPromises = [];

                for (let i = 1; i <= numPages; i++) {
                    const pageNumber = i;
                    renderPromises.push(
                        pdf.getPage(pageNumber).then(function(page) {
                            const viewport = page.getViewport({ scale: 2.0 }); // Render at a higher scale for better quality
                            const canvas = document.createElement('canvas');
                            const context = canvas.getContext('2d');
                            canvas.height = viewport.height;
                            canvas.width = viewport.width;

                            const renderContext = {
                                canvasContext: context,
                                viewport: viewport
                            };
                            return page.render(renderContext).promise.then(() => canvas);
                        })
                    );
                }

                Promise.all(renderPromises).then(function(canvases) {
                    $('#loader').hide();
                    const flipbook = $('#flipbook');

                    canvases.forEach(canvas => {
                        const pageElement = $('<div>').append(canvas);
                        flipbook.append(pageElement);
                    });

                    const container = $('#flipbook-container');
                    const singlePageWidth = canvases[0].width;
                    const singlePageHeight = canvases[0].height;
                    const aspectRatio = (singlePageWidth * 2) / singlePageHeight;

                    const containerHeight = container.height();
                    const containerWidth = container.width();

                    let finalWidth, finalHeight;

                    // Determine final book size based on container and aspect ratio
                    if ((containerWidth / aspectRatio) > containerHeight) {
                        finalHeight = containerHeight * 0.95; // 95% of container height for margin
                        finalWidth = finalHeight * aspectRatio;
                    } else {
                        finalWidth = containerWidth * 0.95; // 95% of container width for margin
                        finalHeight = finalWidth / aspectRatio;
                    }

                    flipbook.turn({
                        width: finalWidth,
                        height: finalHeight,
                        elevation: 50,
                        gradients: true,
                        autoCenter: true,
                        display: 'double',
                        when: {
                            turned: function(e, page) {
                                console.log('Current view: ', $(this).turn('view'));
                            }
                        }
                    });

                    flipbook.show();
                    $('#file-selector').fadeOut();
                }).catch(function(err) {
                    console.error('Error rendering pages: ', err);
                    $('#loader').html('<h2 class="text-2xl font-bold text-red-500">Error rendering the book.</h2>');
                });

            }).catch(function(reason) {
                console.error('Error loading PDF: ' + reason);
                $('#loader').html('<h2 class="text-2xl font-bold text-red-500">Could not load the PDF file.</h2>');
            });
        }
    });
</script>
</body>
</html>

