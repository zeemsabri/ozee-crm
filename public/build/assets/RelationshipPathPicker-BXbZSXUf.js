import{c as f,r as C,e as A,a as o,o as n,b as a,i as c,v as T,G as M,j as W,F as x,l as k,t as b,m as G}from"./app-CH-gkOrV.js";import{u as H}from"./workflowStore-C9cnl0-w.js";const q={class:"relative inline-flex items-center gap-2"},J={key:0,class:"absolute z-50 mt-2 w-[28rem] bg-white border rounded shadow p-3"},K={class:"space-y-3"},Q={class:"flex items-center gap-2"},X=["value"],Y={key:0},Z={class:"flex flex-wrap items-center gap-2 mb-2"},ee=["onClick"],te={class:"flex items-center gap-2"},le=["value"],se={key:1},ae=["value"],oe={key:2},ne=["value"],re={key:3},ue=["disabled"],ie=["value"],de={class:"flex items-center justify-between mt-3"},ve={key:0,class:"text-[11px] text-gray-500 truncate"},pe={class:"font-mono"},me={class:"flex items-center gap-2 ml-auto"},fe=["disabled"],ge={__name:"RelationshipPathPicker",props:{mode:{type:String,default:"id"},allStepsBefore:{type:Array,default:()=>[]},value:{type:String,default:""}},emits:["select"],setup(P,{emit:D}){const p=P,R=D,B=H(),w=f(()=>B.automationSchema||[]),S=f(()=>B.morphMap||[]),_=C(!1),u=C(null),i=C([]),d=C(""),v=C(""),E=f(()=>{var t;const l=[],e=p.allStepsBefore.find(s=>{var r;return(s.step_type==="TRIGGER"||s.step_type==="SCHEDULE_TRIGGER")&&((r=s.step_config)==null?void 0:r.model)});if((t=e==null?void 0:e.step_config)!=null&&t.model){const s=e.step_config.model;l.push({id:"trigger",label:`Trigger: ${s}`,modelName:s,baseToken:`trigger.${s.toLowerCase()}`})}return p.allStepsBefore.forEach((s,r)=>{var g,m;if(s.step_type==="ACTION"&&((g=s.step_config)==null?void 0:g.action_type)==="CREATE_RECORD"&&((m=s.step_config)!=null&&m.target_model)){const y=s.step_config.target_model;l.push({id:`step_${s.id}`,label:`Step ${r+1}: Created ${y}`,modelName:y,baseToken:`${y.toLowerCase()}`})}}),l}),h=f(()=>{var l;return(l=u.value)!=null&&l.modelName&&w.value.find(e=>e.name===u.value.modelName)||null});function $(){i.value=[],d.value="",v.value=""}function F(l){l&&(i.value.push(l),v.value="")}function L(){if(!h.value)return{model:null,lastRelMeta:null};let l=h.value;for(const e of i.value){const t=(l.relationships||[]).find(s=>s.name===e);if(!t)return{model:null,lastRelMeta:null};if(t.type!=="MorphTo"&&t.full_class){const s=w.value.find(r=>r.full_class===t.full_class||r.name===t.model);if(!s)return{model:l,lastRelMeta:t};l=s}else break}return{model:l,lastRelMeta:N}}const N=f(()=>L().lastRelMeta),V=f(()=>{const{model:l,lastRelMeta:e}=L();if(!l)return null;if(!e||e.type!=="MorphTo")return l;if(!d.value)return null;const t=S.value.find(r=>r.alias===d.value);if(!t)return null;const s=(t.class||"").split("\\").pop();return w.value.find(r=>r.name===s)||null}),j=f(()=>{if(!h.value)return[];let l=h.value;for(const e of i.value){const t=(l.relationships||[]).find(s=>s.name===e);if(!t)return[];if(t.type!=="MorphTo"&&t.full_class){const s=w.value.find(r=>r.full_class===t.full_class||r.name===t.model);if(s)l=s;else return[]}else return[]}return l.relationships||[]}),I=f(()=>{const l=V.value;return l?(l.columns||[]).map(e=>{const t=typeof e=="string"?e:e.name,s=typeof e=="string"?e:e.label||e.name;return{value:t,label:s}}):[]});function U(){var t;const l=((t=u.value)==null?void 0:t.baseToken)||"",e=i.value.length?`.${i.value.join(".")}`:"";return p.mode==="id"?`{{${l}${e}.id}}`:p.mode==="field"&&v.value?`{{${l}${e}.${v.value}}}`:""}function O(){p.mode==="type"?d.value?R("select",d.value):R("select",""):R("select",U()),_.value=!1}A(u,()=>$());function z(l){if(p.mode==="type"){if(!l||typeof l!="string"){d.value="";return}const m=S.value.find(y=>y.alias===l);if(m){d.value=m.alias;return}d.value=""}if(!l||typeof l!="string"||!l.startsWith("{{")){u.value=null,i.value=[],v.value="",d.value="";return}const e=l.replace(/[{}]/g,"").trim().split(".");if(e.length<2){u.value=null,i.value=[],v.value="";return}const t=e[0],s=t.toLowerCase()==="trigger",r=E.value.find(m=>(m.id==="trigger"?"trigger":m.modelName.toLowerCase())===t.toLowerCase());if(!r){u.value=null,i.value=[],v.value="";return}u.value=r;const g=s?e.slice(2):e.slice(1);if(g.length===0){i.value=[],v.value="";return}i.value=g.slice(0,-1),v.value=g[g.length-1]||""}return A(()=>p.value,l=>{z(l)},{immediate:!0}),(l,e)=>(n(),o("div",q,[a("button",{type:"button",onClick:e[0]||(e[0]=t=>_.value=!_.value),class:"px-2 py-1 text-xs rounded bg-indigo-50 text-indigo-700 border border-indigo-200 hover:bg-indigo-100 shrink-0"},"Pick via relationships"),_.value?(n(),o("div",J,[a("div",K,[a("div",null,[e[10]||(e[10]=a("label",{class:"block text-xs text-gray-600 mb-1"},"Start from",-1)),a("div",Q,[T(a("select",{"onUpdate:modelValue":e[1]||(e[1]=t=>u.value=t),class:W(["w-full p-2 border rounded text-sm",{"text-gray-400":!u.value}])},[e[9]||(e[9]=a("option",{value:null,disabled:""},"Select a source",-1)),(n(!0),o(x,null,k(E.value,t=>(n(),o("option",{key:t.id,value:t},b(t.label),9,X))),128))],2),[[M,u.value]]),u.value?(n(),o("button",{key:0,type:"button",onClick:e[2]||(e[2]=t=>{u.value=null,$()}),class:"text-[11px] px-2 py-1 rounded border bg-white hover:bg-gray-50"},"Clear")):c("",!0)])]),u.value&&h.value?(n(),o("div",Y,[e[12]||(e[12]=a("label",{class:"block text-xs text-gray-600 mb-1"},"Traverse relationships",-1)),a("div",Z,[(n(!0),o(x,null,k(i.value,(t,s)=>(n(),o("span",{key:s,class:"inline-flex items-center text-xs bg-gray-100 px-2 py-1 rounded border"},[G(b(t)+" ",1),a("button",{type:"button",class:"ml-1 text-gray-400 hover:text-red-600",onClick:r=>{i.value.splice(s),v.value=""}},"Ã—",8,ee)]))),128)),i.value.length?(n(),o("button",{key:0,type:"button",onClick:e[3]||(e[3]=t=>$()),class:"ml-auto text-[11px] px-2 py-1 rounded border bg-white hover:bg-gray-50"},"Clear path")):c("",!0)]),a("div",te,[a("select",{onChange:e[4]||(e[4]=t=>{F(t.target.value),t.target.value=""}),class:"w-full p-2 border rounded text-sm"},[e[11]||(e[11]=a("option",{value:""},"Add relation...",-1)),(n(!0),o(x,null,k(j.value,t=>(n(),o("option",{key:t.name,value:t.name},b(t.name)+" ("+b(t.type)+")",9,le))),128))],32)])])):c("",!0),p.mode==="type"?(n(),o("div",se,[e[14]||(e[14]=a("label",{class:"block text-xs text-gray-600 mb-1"},"Select type",-1)),T(a("select",{"onUpdate:modelValue":e[5]||(e[5]=t=>d.value=t),class:"w-full p-2 border rounded text-sm"},[e[13]||(e[13]=a("option",{value:""},"Choose a type...",-1)),(n(!0),o(x,null,k(S.value,t=>(n(),o("option",{key:t.alias,value:t.alias},b(t.label),9,ae))),128))],512),[[M,d.value]])])):c("",!0),p.mode==="field"&&N.value&&N.value.type==="MorphTo"?(n(),o("div",oe,[e[16]||(e[16]=a("label",{class:"block text-xs text-gray-600 mb-1"},"Select type",-1)),T(a("select",{"onUpdate:modelValue":e[6]||(e[6]=t=>d.value=t),class:"w-full p-2 border rounded text-sm"},[e[15]||(e[15]=a("option",{value:""},"Choose a type...",-1)),(n(!0),o(x,null,k(S.value,t=>(n(),o("option",{key:t.alias,value:t.alias},b(t.label),9,ne))),128))],512),[[M,d.value]])])):c("",!0),p.mode==="field"?(n(),o("div",re,[e[18]||(e[18]=a("label",{class:"block text-xs text-gray-600 mb-1"},"Select field",-1)),T(a("select",{"onUpdate:modelValue":e[7]||(e[7]=t=>v.value=t),class:"w-full p-2 border rounded text-sm",disabled:!V.value},[e[17]||(e[17]=a("option",{value:"",disabled:""},"Select a field...",-1)),(n(!0),o(x,null,k(I.value,t=>(n(),o("option",{key:t.value,value:t.value},b(t.label),9,ie))),128))],8,ue),[[M,v.value]])])):c("",!0),a("div",de,[p.mode!=="type"?(n(),o("div",ve,[e[19]||(e[19]=G("Token preview: ",-1)),a("span",pe,b(U()),1)])):c("",!0),a("div",me,[a("button",{onClick:e[8]||(e[8]=t=>_.value=!1),class:"px-2 py-1 text-xs rounded border"},"Cancel"),a("button",{onClick:O,class:"px-2 py-1 text-xs rounded bg-indigo-600 text-white",disabled:p.mode==="field"&&!v.value},"Use",8,fe)])])])])):c("",!0)]))}};export{ge as _};
