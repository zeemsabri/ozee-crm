import{p as E,z as D,r as c,s as L,w as T,A as Y,h as n,o as i,e as l,u as z,q as O,a as p,b as s,g as x,t as u,F as R,i as $,k as f,d as I,f as P,v as J,c as A,j as G}from"./app-C5dhlUiN.js";import{_ as H}from"./AuthenticatedLayout-DKPQWXUx.js";import{P as C}from"./PrimaryButton-DAvucddZ.js";import{_ as K,a as Q}from"./SecondaryButton-BmPmG-1_.js";import{_ as g,a as M}from"./TextInput-KuNtvHVp.js";import{_ as b}from"./InputError-DOCuQf8z.js";import"./ApplicationLogo-CdSr8yep.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const W={class:"py-12"},X={class:"max-w-7xl mx-auto sm:px-6 lg:px-8"},Z={class:"bg-white overflow-hidden shadow-sm sm:rounded-lg"},ee={class:"p-6 text-gray-900"},te={key:0,class:"bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4",role:"alert"},se={class:"block sm:inline"},oe={key:1,class:"text-gray-600"},ae={key:2,class:"text-red-600"},le={key:3,class:"text-gray-600"},ie={key:4},re={class:"min-w-full divide-y divide-gray-200"},ne={class:"bg-white divide-y divide-gray-200"},de={class:"px-6 py-4 whitespace-nowrap"},ue={class:"px-6 py-4 whitespace-nowrap"},ce={class:"px-6 py-4 truncate max-w-xs"},pe={class:"px-6 py-4 truncate max-w-xs"},me={class:"px-6 py-4 whitespace-nowrap"},ve={class:"px-6 py-4 whitespace-nowrap text-right text-sm font-medium"},_e={class:"p-6"},fe={key:0},ye={class:"mb-2"},xe={class:"mb-4"},ge=["value"],be={class:"mb-4"},we={class:"mb-4"},je={class:"mb-6"},he={class:"mt-6 flex justify-end space-x-2"},Ne={__name:"Rejected",setup(ke){const V=E(()=>D().props.auth.user),w=c([]),y=c([]),S=c([]),j=c(!0),r=c(""),m=c(""),v=c(!1),_=c(null),a=L({project_id:"",client_id:"",subject:"",body:"",to:""}),d=c({}),N=E(()=>V.value.role==="contractor"?y.value.filter(e=>e.users&&e.users.some(t=>t.id===V.value.id)):y.value),h=E(()=>{const e=y.value.find(t=>t.id===a.project_id);return e?S.value.find(t=>t.id===e.client_id):null}),B=e=>{if(!e||!e.to)return"";if(Array.isArray(e.to))return e.to[0]||"";if(typeof e.to=="string")try{const t=JSON.parse(e.to);return Array.isArray(t)?t[0]||"":e.to}catch{return e.to}return""},k=async()=>{j.value=!0,r.value="";try{const[e,t,o]=await Promise.all([window.axios.get("/api/projects"),window.axios.get("/api/clients"),window.axios.get("/api/emails/rejected")]);y.value=e.data,S.value=t.data,w.value=o.data}catch(e){r.value="Failed to load data.",console.error("Error fetching initial data:",e),e.response&&(e.response.status===401||e.response.status===403)&&(r.value="You are not authorized to view this content or your session expired. Please log in.")}finally{j.value=!1}},F=e=>{_.value=e,a.project_id=e.conversation.project_id,a.client_id=e.conversation.client_id,a.subject=e.subject,a.body=e.body,a.to=B(e),d.value={},v.value=!0},U=async()=>{d.value={},r.value="";try{const e={project_id:a.project_id,client_id:a.client_id,subject:a.subject,body:a.body,to:a.to};await window.axios.put(`/api/emails/${_.value.id}`,e),m.value="Email updated successfully! You can now resubmit it.",await k()}catch(e){e.response&&e.response.status===422?d.value=e.response.data.errors:e.response&&e.response.data.message?r.value=e.response.data.message:(r.value="Failed to update email.",console.error("Error updating email:",e))}},q=async()=>{d.value={},r.value="";try{await window.axios.post(`/api/emails/${_.value.id}/resubmit`),m.value="Email resubmitted for approval successfully!",v.value=!1,await k()}catch(e){e.response&&e.response.data.message?r.value=e.response.data.message:(r.value="Failed to resubmit email.",console.error("Error resubmitting email:",e))}};return T(()=>a.project_id,e=>{e&&h.value&&(a.to=h.value.email)}),Y(()=>{k()}),(e,t)=>(i(),n(R,null,[l(z(O),{title:"Rejected Emails"}),l(H,null,{header:p(()=>t[6]||(t[6]=[s("h2",{class:"font-semibold text-xl text-gray-800 leading-tight"},"Rejected Emails",-1)])),default:p(()=>[s("div",W,[s("div",X,[s("div",Z,[s("div",ee,[t[9]||(t[9]=s("h3",{class:"text-2xl font-bold mb-4"},"Your Rejected Emails",-1)),m.value?(i(),n("div",te,[s("span",se,u(m.value),1)])):x("",!0),j.value?(i(),n("div",oe,"Loading rejected emails...")):r.value?(i(),n("div",ae,u(r.value),1)):w.value.length===0?(i(),n("div",le,"No rejected emails found.")):(i(),n("div",ie,[s("table",re,[t[8]||(t[8]=s("thead",{class:"bg-gray-50"},[s("tr",null,[s("th",{scope:"col",class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"},"Project"),s("th",{scope:"col",class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"},"Client"),s("th",{scope:"col",class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"},"Subject"),s("th",{scope:"col",class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"},"Rejection Reason"),s("th",{scope:"col",class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"},"Submitted On"),s("th",{scope:"col",class:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"},"Actions")])],-1)),s("tbody",ne,[(i(!0),n(R,null,$(w.value,o=>(i(),n("tr",{key:o.id},[s("td",de,u(o.conversation.project.name),1),s("td",ue,u(o.conversation.client.name),1),s("td",ce,u(o.subject),1),s("td",pe,u(o.rejection_reason),1),s("td",me,u(new Date(o.created_at).toLocaleString()),1),s("td",ve,[l(C,{onClick:Ee=>F(o)},{default:p(()=>t[7]||(t[7]=[f("View/Edit")])),_:2,__:[7]},1032,["onClick"])])]))),128))])])]))])])])]),l(K,{show:v.value,onClose:t[5]||(t[5]=o=>v.value=!1),"max-width":"3xl"},{default:p(()=>[s("div",_e,[t[16]||(t[16]=s("h2",{class:"text-2xl font-bold text-gray-900 mb-4"},"Edit Rejected Email",-1)),_.value?(i(),n("div",fe,[s("p",ye,[t[10]||(t[10]=s("strong",null,"Rejection Reason:",-1)),f(" "+u(_.value.rejection_reason),1)]),t[15]||(t[15]=s("hr",{class:"my-4"},null,-1)),s("form",{onSubmit:I(U,["prevent"])},[s("div",xe,[l(g,{for:"project_id",value:"Select Project"}),P(s("select",{id:"project_id",class:"border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 rounded-md shadow-sm mt-1 block w-full","onUpdate:modelValue":t[0]||(t[0]=o=>a.project_id=o),required:""},[t[11]||(t[11]=s("option",{value:"",disabled:""},"Select a Project",-1)),(i(!0),n(R,null,$(N.value,o=>(i(),n("option",{key:o.id,value:o.id},u(o.name)+" (Client: "+u(o.client?o.client.name:"N/A")+") ",9,ge))),128))],512),[[J,a.project_id]]),l(b,{message:d.value.project_id?d.value.project_id[0]:"",class:"mt-2"},null,8,["message"])]),s("div",be,[l(g,{for:"to_client_email",value:"To (Client Email)"}),l(M,{id:"to_client_email",type:"email",class:"mt-1 block w-full bg-gray-100",modelValue:a.to,"onUpdate:modelValue":t[1]||(t[1]=o=>a.to=o),readonly:""},null,8,["modelValue"]),!h.value&&a.project_id?(i(),A(b,{key:0,message:"Selected project has no client or client email is missing.",class:"mt-2"})):x("",!0)]),s("div",we,[l(g,{for:"subject",value:"Subject"}),l(M,{id:"subject",type:"text",class:"mt-1 block w-full",modelValue:a.subject,"onUpdate:modelValue":t[2]||(t[2]=o=>a.subject=o),required:""},null,8,["modelValue"]),l(b,{message:d.value.subject?d.value.subject[0]:"",class:"mt-2"},null,8,["message"])]),s("div",je,[l(g,{for:"body",value:"Email Body"}),P(s("textarea",{id:"body",rows:"10",class:"border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 rounded-md shadow-sm mt-1 block w-full","onUpdate:modelValue":t[3]||(t[3]=o=>a.body=o),required:""},null,512),[[G,a.body]]),l(b,{message:d.value.body?d.value.body[0]:"",class:"mt-2"},null,8,["message"])]),s("div",he,[l(Q,{onClick:t[4]||(t[4]=o=>v.value=!1)},{default:p(()=>t[12]||(t[12]=[f("Cancel")])),_:1,__:[12]}),l(C,{type:"submit"},{default:p(()=>t[13]||(t[13]=[f("Save Changes")])),_:1,__:[13]}),m.value?(i(),A(C,{key:0,onClick:q,disabled:!m.value},{default:p(()=>t[14]||(t[14]=[f("Resubmit for Approval")])),_:1,__:[14]},8,["disabled"])):x("",!0)])],32)])):x("",!0)])]),_:1},8,["show"])]),_:1})],64))}};export{Ne as default};
