import{r as g,b as C,l as y,c as v,o as f,u as G,a as s,F as I,q as A,k as D,f as N,v as U,e as L}from"./app-BfaUIa5i.js";import{u as W}from"./workflowStore-DOdgr6Xd.js";import $ from"./Workflow-D6EXdNze.js";import F from"./TriggerSelectionModal-OXppbGHH.js";import"./TriggerStep-B6fEFYsO.js";import"./StepCard-CRKF5M4T.js";import"./trash-CCSDpdeO.js";import"./createLucideIcon-D0ZpVBKJ.js";import"./SelectDropdown-M3AHc6lT.js";/* empty css                                                                       */import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./ConditionStep-CbZyNZ6J.js";import"./RelationshipPathPicker-eTtOy2pI.js";import"./plus-CRkvJOmu.js";import"./ActionStep-GIvmUD3t.js";import"./DataTokenInserter-D0wX6jAn.js";import"./AIStep-DoA74Ouj.js";import"./RelatedDataPicker-BM43vXBH.js";import"./BaseFormModal-B0-uAlS4.js";import"./Modal-Dz0vzl9e.js";import"./PrimaryButton-DmkBadzw.js";import"./SecondaryButton-kMFm4gnl.js";import"./PromptForm-CQ_wth3a.js";import"./ResponseBuilder-8ssdpEp2.js";import"./FieldBuilder-DYC3tc9N.js";import"./chevron-down-B331Z9vW.js";import"./circle-x-Bqipi-jd.js";import"./ForEachStep-DwK1Z1Uc.js";import"./FetchRecordsStep-ja0Qq_c9.js";import"./ScheduleTriggerStep-CrJoWwbf.js";import"./AddStepButton-3fWqRMN-.js";import"./TransformStep-BtNxCJaa.js";import"./DefineVariableStep-tP0enOZe.js";const H={class:"max-w-12xl mx-auto space-y-6"},B={key:0,class:"text-center py-10"},O={class:"bg-white p-4 rounded-lg shadow-md border flex justify-between items-center sticky top-4 z-20"},V={class:"flex space-x-2"},M=["disabled"],J={class:"p-2 sm:p-6 pb-40 overflow-x-auto"},j={class:"inline-block min-w-max"},Ee={__name:"AutomationBuilder",props:{automationId:{type:[Number,String],default:null}},emits:["back"],setup(_,{emit:w}){const m=_,h=w,i=W(),l=g([]),p=g(""),d=g(!1);C(async()=>{try{i.automationSchema.length||await i.fetchAutomationSchema()}catch{}m.automationId?(await i.fetchWorkflow(m.automationId),i.activeWorkflow&&(l.value=JSON.parse(JSON.stringify(i.activeWorkflow.steps)),p.value=i.activeWorkflow.name)):(i.activeWorkflow=null,p.value="Untitled Automation",l.value=[],d.value=!0)});function b(o){let e;o==="SCHEDULE_TRIGGER"?e={id:`temp_${Date.now()}`,step_type:"SCHEDULE_TRIGGER",name:"Starts on a Schedule",step_config:{trigger_event:"schedule.run"}}:e={id:`temp_${Date.now()}`,step_type:"TRIGGER",name:"New Event Trigger",step_config:{}},l.value=[e],d.value=!1}const x=y(()=>{const o=l.value[0];return o?o.step_type==="SCHEDULE_TRIGGER"?!0:!!(o.step_config&&o.step_config.trigger_event):!1}),k=y(()=>x.value&&p.value.trim()!==""),c=(o,e=null,n=null)=>{let a=[];return o.forEach((r,u)=>{const t={...r},E=t.if_true,R=t.if_false,T=t.children;delete t.if_true,delete t.if_false,delete t.children,t.step_order=u+1,(t.delay_minutes===void 0||t.delay_minutes===null)&&(t.delay_minutes=0),e&&(t.step_config=t.step_config||{},t.step_config._parent_id=e,t.step_config._branch=n),a.push(t),r.step_type==="CONDITION"&&(a=[...a,...c(E||[],r.id,"yes"),...c(R||[],r.id,"no")]),r.step_type==="FOR_EACH"&&(a=[...a,...c(T||[],r.id,null)])}),a};async function S(){var r;const o=l.value[0]||{},e=o.step_type==="SCHEDULE_TRIGGER"?"schedule.run":((r=o.step_config)==null?void 0:r.trigger_event)||null,n=c(l.value).map(u=>u.step_type==="SCHEDULE_TRIGGER"?{...u,step_type:"TRIGGER",step_config:{...u.step_config||{},trigger_event:"schedule.run"}}:u),a={name:p.value,trigger_event:e,is_active:!0,steps:n};try{m.automationId?await i.updateWorkflow(m.automationId,a):await i.createWorkflow(a),h("back")}catch(u){console.error("Failed to save automation:",u),i.showAlert("Save Failed","Could not save the automation.")}}return(o,e)=>(f(),v("div",H,[G(i).isLoading&&_.automationId?(f(),v("div",B,e[5]||(e[5]=[s("p",null,"Loading Automation...",-1)]))):(f(),v(I,{key:1},[s("div",O,[N(s("input",{type:"text","onUpdate:modelValue":e[0]||(e[0]=n=>p.value=n),placeholder:"Untitled Automation",class:"text-xl font-bold text-gray-800 focus:outline-none bg-transparent w-full"},null,512),[[U,p.value]]),s("div",V,[s("button",{onClick:e[1]||(e[1]=n=>o.$emit("back")),class:"inline-flex items-center gap-x-2 rounded-md px-3.5 py-2 text-sm font-semibold shadow-sm bg-white text-gray-900 ring-1 ring-inset ring-gray-300 hover:bg-gray-50"}," Cancel "),s("button",{onClick:S,disabled:!k.value,class:"inline-flex items-center gap-x-2 rounded-md px-3.5 py-2 text-sm font-semibold shadow-sm bg-indigo-600 text-white hover:bg-indigo-500 focus-visible:outline-indigo-600 disabled:opacity-50"}," Save and Activate ",8,M)])]),s("div",J,[s("div",j,[L($,{steps:l.value,"onUpdate:steps":e[2]||(e[2]=n=>l.value=n),onAddTrigger:e[3]||(e[3]=n=>d.value=!0)},null,8,["steps"]),e[6]||(e[6]=s("div",{class:"h-60"},null,-1))])]),d.value?(f(),A(F,{key:0,onClose:e[4]||(e[4]=n=>d.value=!1),onSelect:b})):D("",!0)],64))]))}};export{Ee as default};
