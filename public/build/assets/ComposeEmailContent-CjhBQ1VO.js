import{q as ee,r as m,c as L,e as I,f as te,a as n,o as i,b as u,i as p,d as r,u as l,g as w,t as O,F as ae,l as le,w as A,m as N,j as se,s as oe,p as _}from"./app-x8m_4hY2.js";import{_ as x}from"./InputLabel-BQt1_ZvA.js";import{_ as F}from"./TextInput-DXxzU_mf.js";import{_ as h}from"./InputError-Db7L5aye.js";import{O as H}from"./CustomMultiSelect-D2y4i7PO.js";import{_ as R}from"./PrimaryButton-w5tinKZZ.js";import{S as T}from"./SelectDropdown-ChnFxdu6.js";import{_ as ie}from"./RepeatableDynamicField-DXrpFOcY.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";/* empty css                                                                       */import"./vuedraggable.umd-DuiKtT07.js";import"./index-fqzFiUEp.js";import"./InformationCircleIcon-Cn6nwm2i.js";import"./TrashIcon-C1uI61Ep.js";const ne={class:"p-4 space-y-6"},re={class:"space-y-4"},de={key:0},me={key:0,class:"text-xs text-gray-500 mt-1"},ce={key:1},ue={key:0,class:"text-gray-500 text-sm"},pe={key:1,class:"text-red-500 text-sm"},_e={key:2},ve={key:3,class:"space-y-4"},fe={key:0},ye={key:1},be={key:0,class:"text-gray-500 text-sm mt-1"},ge={key:2},ke={key:0,class:"text-gray-500 text-sm mt-1"},je={key:3,class:"grid grid-cols-1 sm:grid-cols-2 gap-2"},Ve={key:4,class:"mt-6"},we={class:"flex justify-between items-center mb-3"},xe=["innerHTML"],he={class:"flex items-center justify-end mt-4"},Ae={__name:"ComposeEmailContent",props:{projectId:[Number,String]},emits:["submitted","error"],setup(q,{emit:z}){const $=q,P=z,t=ee({subject:"",client_ids:[],status:"pending_approval",template_id:null,template_data:{},project_id:$.projectId||null}),M=m([]),S=m(!1),U=m([]),E=m(!1),y=m(""),b=m([]),v=m({}),f=m(!1),g=m(""),k=m(!1),B=L(()=>b.value.find(a=>a.id===t.template_id)),G=L(()=>B.value?B.value.placeholders.filter(a=>a.is_dynamic||a.is_repeatable||a.is_selectable):[]),c=m({}),D=(a,s)=>`(${a||""})[${s||""}]`,Z=L(()=>b.value.map(a=>({value:a.id,label:a.name}))),J=async()=>{S.value=!0;try{const a=await _.get("/api/projects-simplified");M.value=a.data}catch(a){console.error("Failed to fetch projects:",a)}finally{S.value=!1}},K=async a=>{var s,e;if(!a){U.value=[];return}E.value=!0,y.value="";try{const o=await _.get(`/api/projects/${a}/sections/clients?type=clients`);U.value=o.data}catch(o){console.error("Failed to fetch project clients:",o),y.value=((e=(s=o.response)==null?void 0:s.data)==null?void 0:e.message)||"Failed to load client data."}finally{E.value=!1}},Q=async()=>{try{const a=await _.get("/api/email-templates");b.value=a.data}catch(a){console.error("Failed to fetch email templates:",a)}},W=async a=>{if(!(!t.project_id||!a||!a.placeholders)){f.value=!0,v.value={};try{const s=a.placeholders.filter(d=>(d.is_selectable||d.is_repeatable)&&d.source_model);if(s.length===0){f.value=!1;return}const e={};s.forEach(d=>{e[d.source_model]||(e[d.source_model]=[]),e[d.source_model].push(d)});const o=Object.keys(e).map(async d=>{try{const C=await _.get(`/api/source-models/${encodeURIComponent(d)}`);e[d].forEach(j=>{v.value[j.name]=C.data.map(V=>({id:V.id,label:V[j.source_attribute]||V.name||`ID: ${V.id}`}))})}catch(C){console.error(`Failed to fetch data for model ${d}:`,C),e[d].forEach(j=>{v.value[j.name]=[]})}});await Promise.all(o)}catch(s){console.error("Error fetching source models data:",s)}finally{f.value=!1}}},X=async()=>{if(!t.template_id||t.client_ids.length===0||!t.project_id){g.value='<p class="text-gray-500 italic">Select a project, template, and at least one recipient to see a preview.</p>';return}k.value=!0;try{const a={template_id:t.template_id,client_id:t.client_ids[0],template_data:t.template_data},s=await _.post(`/api/projects/${t.project_id}/email-preview`,a);g.value=s.data.body_html,s.data.subject&&(t.subject=s.data.subject)}catch(a){console.error("Failed to fetch email preview:",a),g.value='<p class="text-red-500 italic">Error loading preview.</p>'}finally{k.value=!1}},Y=async()=>{const a=!!t.template_id;if(!a){console.error("Template not selected. All emails must be template-based.");return}const s="/api/emails/templated",e={project_id:t.project_id,subject:t.subject,body:null,composition_type:"template",status:"pending_approval"};t.client_ids.length>0?e.client_ids=t.client_ids:e.client_ids=[],a&&(e.template_id=t.template_id,e.template_data=t.template_data);try{await _.post(s,e),t.reset(),P("submitted")}catch(o){console.error("Email submission error:",o),P("error",o)}};return I(()=>t.project_id,a=>{t.client_ids=[],t.template_id=null,t.template_data={},K(a)},{immediate:!0}),I(()=>t.template_id,a=>{t.template_data={},c.value={};const s=b.value.find(e=>e.id===a);s&&(s.placeholders.forEach(e=>{e.is_repeatable?t.template_data[e.name]=[]:e.is_selectable?t.template_data[e.name]=null:(t.template_data[e.name]="",e.is_dynamic&&e.is_link&&(c.value[e.name]={label:"",url:""}))}),W(s))},{immediate:!0}),te(()=>{Q(),$.projectId||J()}),(a,s)=>(i(),n("div",ne,[u("form",{onSubmit:oe(Y,["prevent"])},[u("div",re,[$.projectId?p("",!0):(i(),n("div",de,[r(x,{for:"project",value:"Select Project"}),r(T,{id:"project",modelValue:l(t).project_id,"onUpdate:modelValue":s[0]||(s[0]=e=>l(t).project_id=e),options:M.value,placeholder:"Select a project","value-key":"id","label-key":"name","allow-empty":!0,class:"mt-1"},null,8,["modelValue","options"]),S.value?(i(),n("div",me," Loading projects... ")):p("",!0),r(h,{message:l(t).errors.project_id,class:"mt-2"},null,8,["message"])])),l(t).project_id?(i(),n("div",ce,[r(x,{for:"client_ids",value:"To (Clients)"}),E.value?(i(),n("div",ue,"Loading clients...")):y.value?(i(),n("div",pe,O(y.value),1)):(i(),w(H,{key:2,modelValue:l(t).client_ids,"onUpdate:modelValue":s[1]||(s[1]=e=>l(t).client_ids=e),options:U.value,placeholder:"Select one or more clients","label-key":"name","value-key":"id",class:"mt-1 block w-full"},null,8,["modelValue","options"])),r(h,{message:l(t).errors.client_ids,class:"mt-2"},null,8,["message"])])):p("",!0),l(t).project_id?(i(),n("div",_e,[r(x,{for:"template-select",value:"Select Template"}),r(T,{id:"template-select",modelValue:l(t).template_id,"onUpdate:modelValue":s[2]||(s[2]=e=>l(t).template_id=e),options:Z.value,placeholder:"Select a template","value-key":"value","label-key":"label","allow-empty":!1,class:"mt-1"},null,8,["modelValue","options"]),r(h,{message:l(t).errors.template_id,class:"mt-2"},null,8,["message"])])):p("",!0),l(t).template_id&&l(t).project_id?(i(),n("div",ve,[(i(!0),n(ae,null,le(G.value,e=>(i(),n("div",{key:e.name},[r(x,{for:e.name,value:e.label||e.name},null,8,["for","value"]),e.is_repeatable&&e.is_dynamic?(i(),n("div",fe,[r(ie,{modelValue:l(t).template_data[e.name],"onUpdate:modelValue":o=>l(t).template_data[e.name]=o,"allow-links":!!e.is_link,"placeholder-name":e.name,"add-button-text":`Add ${e.label||e.name}`,"item-placeholder":`Enter ${e.label||e.name}`},null,8,["modelValue","onUpdate:modelValue","allow-links","placeholder-name","add-button-text","item-placeholder"])])):e.is_repeatable?(i(),n("div",ye,[f.value?(i(),n("div",be,"Loading options...")):(i(),w(H,{key:1,modelValue:l(t).template_data[e.name],"onUpdate:modelValue":o=>l(t).template_data[e.name]=o,options:v.value[e.name]||[],placeholder:`Select ${e.name}`,"label-key":"label","value-key":"id",class:"mt-1"},null,8,["modelValue","onUpdate:modelValue","options","placeholder"]))])):e.is_selectable?(i(),n("div",ge,[f.value?(i(),n("div",ke,"Loading options...")):(i(),w(T,{key:1,id:e.name,modelValue:l(t).template_data[e.name],"onUpdate:modelValue":o=>l(t).template_data[e.name]=o,options:v.value[e.name]||[],placeholder:`Select a ${e.name}`,"value-key":"id","label-key":"label",class:"mt-1 block w-full"},null,8,["id","modelValue","onUpdate:modelValue","options","placeholder"]))])):e.is_dynamic&&e.is_link?(i(),n("div",je,[r(F,{id:`${e.name}-label`,modelValue:c.value[e.name].label,"onUpdate:modelValue":[o=>c.value[e.name].label=o,o=>{l(t).template_data[e.name]=D(o,c.value[e.name].url)}],type:"text",class:"mt-1 block w-full",placeholder:"Link text/label"},null,8,["id","modelValue","onUpdate:modelValue"]),r(F,{id:`${e.name}-url`,modelValue:c.value[e.name].url,"onUpdate:modelValue":[o=>c.value[e.name].url=o,o=>{l(t).template_data[e.name]=D(c.value[e.name].label,o)}],type:"url",class:"mt-1 block w-full",placeholder:"https://example.com"},null,8,["id","modelValue","onUpdate:modelValue"])])):(i(),w(F,{key:4,id:e.name,modelValue:l(t).template_data[e.name],"onUpdate:modelValue":o=>l(t).template_data[e.name]=o,type:"text",class:"mt-1 block w-full",placeholder:`Enter a value for ${e.name}`},null,8,["id","modelValue","onUpdate:modelValue","placeholder"])),r(h,{message:l(t).errors[`template_data.${e.name}`],class:"mt-2"},null,8,["message"])]))),128))])):p("",!0),l(t).template_id?(i(),n("div",Ve,[u("div",we,[s[3]||(s[3]=u("h4",{class:"text-md font-semibold text-gray-800"},"Email Preview",-1)),r(R,{onClick:X,disabled:k.value||!l(t).project_id||l(t).client_ids.length===0},{default:A(()=>[N(O(k.value?"Loading...":"Refresh Preview"),1)]),_:1},8,["disabled"])]),u("div",{class:"bg-gray-100 p-4 rounded-lg shadow-inner min-h-[300px]",innerHTML:g.value},null,8,xe)])):p("",!0)]),u("div",he,[r(R,{class:se({"opacity-25":l(t).processing}),disabled:l(t).processing||!l(t).project_id||l(t).client_ids.length===0},{default:A(()=>s[4]||(s[4]=[N(" Submit for Approval ",-1)])),_:1,__:[4]},8,["class","disabled"])])],32)]))}};export{Ae as default};
