import{u as P}from"./workflowStore-B7plWg-6.js";import{r as E,f as D,Q as M,c as R,a as _,o as f,b,g as W,i as H,k as I,v as j,x as z,F as N,l as B,t as O,Y as U,n as V}from"./app-CZiJFItQ.js";const G=["disabled"],X={class:"p-2 border-b"},Y={class:"px-3 py-1.5 text-[11px] font-semibold uppercase tracking-wide text-gray-500 bg-gray-50"},q=["onClick"],Q={key:1,class:"px-3 py-2 text-xs text-gray-500"},J={__name:"DataTokenPicker",props:{groups:{type:Array,default:()=>[]},placeholder:{type:String,default:""},disabled:{type:Boolean,default:!1},maxHeight:{type:String,default:"300px"},minWidth:{type:[String,Number],default:320},maxPanelWidth:{type:[String,Number],default:480}},emits:["select"],setup(C,{emit:A}){const c=C,T=A,g=E(!1),h=E(null),w=E(null),v=E({top:0,left:0,width:0}),$=E(""),k=s=>{if(typeof s=="number")return s;const e=parseInt(String(s).replace("px",""));return isNaN(e)?0:e};function r(){c.disabled||(g.value=!g.value,V(()=>l()))}function l(){const s=h.value;if(!s)return;const e=s.getBoundingClientRect(),t=8,o=window.innerWidth||document.documentElement.clientWidth,d=Math.max(e.width,k(c.minWidth)),i=Math.min(k(c.maxPanelWidth),o-t*2),n=Math.min(Math.max(d,k(c.minWidth)),i);let a=e.left+window.scrollX;a+n+t>o+window.scrollX&&(a=o+window.scrollX-n-t,a<t&&(a=t)),v.value={top:e.bottom+window.scrollY,left:a,width:n}}function p(){g.value&&l()}function m(s){const e=h.value&&h.value.contains(s.target),t=w.value&&w.value.contains(s.target);!e&&!t&&(g.value=!1)}D(()=>{window.addEventListener("scroll",p,!0),window.addEventListener("resize",p),document.addEventListener("click",m)}),M(()=>{window.removeEventListener("scroll",p,!0),window.removeEventListener("resize",p),document.removeEventListener("click",m)}),R(()=>{const s=[];return(c.groups||[]).forEach((e,t)=>{(e.fields||[]).forEach((o,d)=>{s.push({groupIndex:t,itemIndex:d,group:e.name||"Data",label:o.label,value:o.value})})}),s});const x=R(()=>{const s=$.value.trim().toLowerCase();if(!s)return c.groups;const e=[];return(c.groups||[]).forEach(t=>{const o=(t.fields||[]).filter(d=>String(d.label||"").toLowerCase().includes(s));o.length&&e.push({name:t.name,fields:o})}),e});function L(s){T("select",s),g.value=!1}return(s,e)=>(f(),_("div",{class:"relative inline-block",ref_key:"triggerRef",ref:h},[b("button",{type:"button",onClick:r,disabled:C.disabled,"aria-label":"Insert data",class:"inline-flex items-center justify-center rounded-full border border-gray-300 bg-white p-1.5 text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-60"},e[1]||(e[1]=[b("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-4 w-4",viewBox:"0 0 20 20",fill:"currentColor"},[b("path",{"fill-rule":"evenodd",d:"M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z","clip-rule":"evenodd"})],-1)]),8,G),(f(),W(U,{to:"body"},[g.value?(f(),_("div",{key:0,ref_key:"portalRef",ref:w,class:"fixed z-[9999] bg-white rounded-md shadow-xl ring-1 ring-black ring-opacity-5",style:I({top:v.value.top+"px",left:v.value.left+"px",width:v.value.width+"px",maxWidth:"min(480px, 96vw)"})},[b("div",X,[j(b("input",{type:"text","onUpdate:modelValue":e[0]||(e[0]=t=>$.value=t),placeholder:"Search fields...",class:"w-full border border-gray-200 rounded px-2 py-1 text-xs focus:ring-indigo-500 focus:border-indigo-500"},null,512),[[z,$.value]])]),b("div",{class:"max-h-[calc(100vh-180px)] overflow-auto",style:I({maxHeight:C.maxHeight})},[x.value&&x.value.length?(f(!0),_(N,{key:0},B(x.value,t=>(f(),_("div",{key:t.name,class:"py-1"},[b("div",Y,O(t.name),1),(f(!0),_(N,null,B(t.fields||[],o=>(f(),_("button",{key:o.value,type:"button",class:"w-full text-left px-3 py-2 text-sm hover:bg-gray-50",onClick:d=>L(o.value)},O(o.label),9,q))),128))]))),128)):(f(),_("div",Q,"No data available"))],4)],4)):H("",!0)]))],512))}},ee={__name:"DataTokenInserter",props:{allStepsBefore:{type:Array,default:()=>[]},loopContextSchema:{type:Object,default:null},inferLoopFromNearest:{type:Boolean,default:!0}},emits:["insert"],setup(C,{emit:A}){const c=C,T=A,g=P(),h=R(()=>g.automationSchema||[]);function w(r){if(!r||typeof r!="string")return"";let l=r.toLowerCase();if(l==="id")return"ID";l.endsWith("_id")&&(l=l.slice(0,-3)),l=l.replace(/[_-]+/g," ");let p=l.replace(/\b\w/g,m=>m.toUpperCase());return p=p.replace(/\bId\b/g,"ID").replace(/\bUrl\b/g,"URL"),p}const v=R(()=>{var x,L,s;const r=[];let l=c.loopContextSchema;const p=e=>{const t=String((e==null?void 0:e.type)||"").toLowerCase(),o=String((e==null?void 0:e.itemType)||"").toLowerCase();return t==="array of objects"||t==="array"&&o==="object"};if(!l&&c.inferLoopFromNearest){const e=[...c.allStepsBefore].reverse().find(t=>{var o;return t.step_type==="FOR_EACH"&&((o=t.step_config)==null?void 0:o.sourceArray)});if(e){const t=e.step_config.sourceArray,o=typeof t=="string"?t.match(/{{step_(\w+)\.(.+)}}/):null;if(o){const d=o[1],i=o[2],n=c.allStepsBefore.find(a=>String(a.id)===String(d));if((n==null?void 0:n.step_type)==="AI_PROMPT"){const a=(((x=n.step_config)==null?void 0:x.responseStructure)||[]).find(y=>y.name===i);p(a)&&(l={name:"Loop Item",columns:a.schema||[]})}if(!l&&(n==null?void 0:n.step_type)==="FETCH_RECORDS"&&i==="records"){const a=(L=n.step_config)==null?void 0:L.model,y=h.value.find(u=>u.name===a);y&&(l={name:"Loop Item",columns:(y.columns||[]).map(S=>typeof S=="string"?{name:S}:S)})}}}}l&&Array.isArray(l.columns)&&(r.push({name:"Current Loop Item (from For Each)",fields:l.columns.filter(e=>!!(e&&e.name)).map(e=>({label:e.name,value:`{{loop.item.${e.name}}}`}))}),r.push({name:"Loop Details",fields:[{label:"index",value:"{{loop.index}}"},{label:"is_first",value:"{{loop.is_first}}"},{label:"is_last",value:"{{loop.is_last}}"}]}));const m=c.allStepsBefore.find(e=>e.step_type==="TRIGGER");if(m&&((s=m.step_config)!=null&&s.model)){const e=h.value.find(t=>t.name===m.step_config.model);e&&r.push({name:`Trigger: ${m.step_config.model}`,fields:e.columns.map(t=>{const o=typeof t=="string"?t:t.name||"";return{label:typeof t=="string"?w(t):t.label||t.name||"",value:`{{trigger.${m.step_config.model.toLowerCase()}.${o}}}`}})})}return c.allStepsBefore.forEach((e,t)=>{var o,d;if(e.step_type==="AI_PROMPT"&&((d=(o=e.step_config)==null?void 0:o.responseStructure)==null?void 0:d.length)>0){const i=[];(e.step_config.responseStructure||[]).forEach(n=>{i.push({label:n.name,value:`{{step_${e.id}.${n.name}}}`}),p(n)&&Array.isArray(n.schema)&&n.schema.forEach(a=>{a!=null&&a.name&&i.push({label:`- ${a.name}`,value:`{{step_${e.id}.${n.name}.${a.name}}}`})})}),r.push({name:`Step ${t+1}: AI Response`,fields:i})}if(e.step_type==="FETCH_RECORDS"){const i=[{label:"records (array)",value:`{{step_${e.id}.records}}`},{label:"count",value:`{{step_${e.id}.count}}`}],n=e.step_config&&e.step_config.model?e.step_config.model:null,a=`Step ${t+1}: Fetch Records`+(n?` — ${n}`:"");if(e.step_config&&e.step_config.single&&n){const y=h.value.find(u=>u.name===n);y&&(y.columns||[]).forEach(u=>{const S=typeof u=="string"?u:u.name||"",F=typeof u=="string"?w(u):u.label||u.name||"";S&&i.push({label:`record.${F}`,value:`{{step_${e.id}.record.${S}}}`})}),i.push({label:"record (object)",value:`{{step_${e.id}.record}}`})}r.push({name:a,fields:i})}if(e.step_type==="TRANSFORM_CONTENT"){const i=[{label:"cleaned_body",value:`{{step_${e.id}.cleaned_body}}`},{label:"result",value:`{{step_${e.id}.result}}`}];r.push({name:`Step ${t+1}: Transformed Content`,fields:i})}if(e.step_type==="ACTION"&&e.step_config&&e.step_config.action_type==="CREATE_RECORD"){const i=e.step_config.target_model||"",n=`Step ${t+1}: Create Record`+(i?` — ${i}`:""),a=[{label:"new_record_id",value:`{{step_${e.id}.new_record_id}}`},{label:"id (legacy)",value:`{{step_${e.id}.id}}`}];r.push({name:n,fields:a})}}),r}),$=R(()=>v.value.some(r=>Array.isArray(r.fields)&&r.fields.length>0));function k(r){r&&T("insert",r)}return(r,l)=>(f(),W(J,{groups:v.value,disabled:!$.value,onSelect:k},null,8,["groups","disabled"]))}};export{ee as default};
