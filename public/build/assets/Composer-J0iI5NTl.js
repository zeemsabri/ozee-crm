import{B as D,C as M,D as $,p as g,r as u,s as q,w as G,A as L,E as R,h as r,o as n,e as l,u as x,q as T,a as p,b as a,t as m,k as f,d as I,g as Y,f as z,F as k,i as Q,v as H}from"./app-BIwMTLGy.js";import{_ as J}from"./AuthenticatedLayout-BMcP76RR.js";import{P as K}from"./PrimaryButton-DBKTw9ZT.js";import{_ as b,a as O}from"./TextInput-BaE0AonU.js";import{_ as y}from"./InputError-BZciBhnq.js";import{R as W}from"./RichTextEditor-Bu9Bt-3b.js";import{s as X}from"./vue-multiselect-T8vGdYy2.js";import"./ApplicationLogo-jJvFTmVZ.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const Z={class:"py-12"},ee={class:"max-w-7xl mx-auto sm:px-6 lg:px-8"},se={class:"bg-white overflow-hidden shadow-sm sm:rounded-lg"},oe={class:"p-6 text-gray-900"},te={key:0,class:"text-red-600 mb-4"},ae={key:1,class:"text-gray-600 mb-4"},le={key:2,class:"text-red-600 mb-4"},ie={key:3,class:"text-gray-600 mb-4"},re={key:0},ne={key:1},ce={key:4},de={key:0,class:"bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4",role:"alert"},ue={class:"block sm:inline"},me={class:"mb-4"},pe=["value"],_e={class:"mb-4"},ve={class:"multiselect__tag"},ge=["onClick"],fe={class:"mb-4"},be={class:"mb-6"},ye={class:"flex items-center justify-end"},Ne={__name:"Composer",setup(he){const C=D(),{permissions:E,loading:V,error:S}=M(),{canDo:A}=$(),w=g(()=>A("compose_emails").value||!0),_=u([]),h=u([]),j=u(!0),i=u({}),c=u(""),v=u(""),t=q({project_id:"",client_ids:[],subject:"",body:""}),P=g(()=>_.value);g(()=>h.value.filter(s=>t.client_ids.includes(s.id)));const N=g(()=>{if(!t.project_id)return[];const s=_.value.find(e=>e.id===t.project_id);if(!s||!s.clients)return[];const o=s.clients.map(e=>e.id);return h.value.filter(e=>o.includes(e.id))}),F=async()=>{j.value=!0,c.value="";try{const s=await window.axios.get("/api/projects-for-email");_.value=s.data.projects;const o=new Map;_.value.forEach(e=>{e.clients&&e.clients.length>0&&e.clients.forEach(d=>{o.set(d.id,d)})}),h.value=Array.from(o.values())}catch(s){c.value="Failed to load projects.",console.error("Error fetching initial data:",s),s.response&&(s.response.status===401||s.response.status===403)&&(c.value="You are not authorized to view this content or your session expired. Please log in.")}finally{j.value=!1}};G(()=>t.project_id,s=>{t.client_ids=[]});const U=async()=>{if(i.value={},c.value="",v.value="",!t.project_id){i.value.project_id=["Please select a project."];return}if(!t.client_ids||t.client_ids.length===0){i.value.client_ids=["Please select at least one client."];return}try{const s=t.client_ids.map(e=>typeof e=="object"&&e!==null?{id:e.id}:{id:e}),o={project_id:t.project_id,client_ids:s,subject:t.subject,body:t.body,status:"pending_approval"};await window.axios.post("/api/emails",o),v.value="Email submitted for approval successfully!",t.project_id="",t.client_ids=[],t.subject="",t.body="",i.value={}}catch(s){s.response&&s.response.status===422?i.value=s.response.data.errors:s.response&&s.response.data.message?c.value=s.response.data.message:(c.value="Failed to submit email. An unexpected error occurred.",console.error("Error submitting email:",s))}},B=()=>{const o=new URLSearchParams(window.location.search).get("project_id");o&&(t.project_id=o)};return L(async()=>{try{console.log("Fetching global permissions...");const s=await R();console.log("Global permissions fetched:",s)}catch(s){console.error("Error fetching global permissions:",s)}F().then(()=>{B()}),console.log("All data loaded, permission status:"),console.log("- Global permissions:",E.value),console.log("- Permissions loading:",V.value),console.log("- Permissions error:",S.value),console.log("- Can compose emails:",w.value)}),(s,o)=>(n(),r(k,null,[l(x(T),{title:"Compose Email"}),l(J,null,{header:p(()=>o[4]||(o[4]=[a("h2",{class:"font-semibold text-xl text-gray-800 leading-tight"},"Compose New Email",-1)])),default:p(()=>[a("div",Z,[a("div",ee,[a("div",se,[a("div",oe,[o[8]||(o[8]=a("h3",{class:"text-2xl font-bold mb-6"},"Create New Email for Client",-1)),w.value?j.value?(n(),r("div",ae,"Loading data...")):c.value?(n(),r("div",le,m(c.value),1)):P.value.length===0?(n(),r("div",ie,[o[5]||(o[5]=f(" No projects assigned to you for email composition. ")),x(C).role==="contractor"?(n(),r("span",re,"Please ensure you are assigned to a project.")):(n(),r("span",ne,"Please ensure there are projects available."))])):(n(),r("div",ce,[a("form",{onSubmit:I(U,["prevent"])},[v.value?(n(),r("div",de,[a("span",ue,m(v.value),1)])):Y("",!0),a("div",me,[l(b,{for:"project_id",value:"Select Project"}),z(a("select",{id:"project_id",class:"border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 rounded-md shadow-sm mt-1 block w-full","onUpdate:modelValue":o[0]||(o[0]=e=>t.project_id=e),required:""},[o[6]||(o[6]=a("option",{value:"",disabled:""},"Select a Project",-1)),(n(!0),r(k,null,Q(P.value,e=>(n(),r("option",{key:e.id,value:e.id},m(e.name)+" (Clients: "+m(e.clients.length?e.clients.map(d=>d.name).join(", "):"N/A")+") ",9,pe))),128))],512),[[H,t.project_id]]),l(y,{message:i.value.project_id?i.value.project_id[0]:"",class:"mt-2"},null,8,["message"])]),a("div",_e,[l(b,{for:"client_ids",value:"To (Clients)"}),l(x(X),{id:"client_ids",modelValue:t.client_ids,"onUpdate:modelValue":o[1]||(o[1]=e=>t.client_ids=e),options:N.value,multiple:!0,"close-on-select":!0,"clear-on-select":!1,"preserve-search":!0,placeholder:"Select one or more clients",label:"name","track-by":"id",searchable:!0,"allow-empty":!0},{option:p(({option:e})=>[f(m(e.name),1)]),tag:p(({option:e,remove:d})=>[a("span",ve,[f(m(e.name)+" ",1),a("i",{class:"multiselect__tag-icon",onClick:je=>d(e)},null,8,ge)])]),_:1},8,["modelValue","options"]),l(y,{message:i.value.client_ids?i.value.client_ids[0]:"",class:"mt-2"},null,8,["message"])]),a("div",fe,[l(b,{for:"subject",value:"Subject"}),l(O,{id:"subject",type:"text",class:"mt-1 block w-full",modelValue:t.subject,"onUpdate:modelValue":o[2]||(o[2]=e=>t.subject=e),required:""},null,8,["modelValue"]),l(y,{message:i.value.subject?i.value.subject[0]:"",class:"mt-2"},null,8,["message"])]),a("div",be,[l(b,{for:"body",value:"Email Body"}),l(W,{id:"body",modelValue:t.body,"onUpdate:modelValue":o[3]||(o[3]=e=>t.body=e),placeholder:"Compose your email here...",height:"300px"},null,8,["modelValue"]),l(y,{message:i.value.body?i.value.body[0]:"",class:"mt-2"},null,8,["message"])]),a("div",ye,[l(K,{type:"submit"},{default:p(()=>o[7]||(o[7]=[f("Submit for Approval")])),_:1,__:[7]})])],32)])):(n(),r("div",te," You do not have permission to compose emails. Please contact your administrator. "))])])])])]),_:1})],64))}};export{Ne as default};
