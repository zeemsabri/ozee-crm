import{u as $}from"./workflowStore-DMkwNXfJ.js";import N from"./StepCard-lQ3hdvW4.js";import{S as j}from"./SelectDropdown-CFOqYu4w.js";import{c as d,f as P,g as E,o as i,w as V,b as c,a as v,i as I,F as _,l as w,t as S,j as G}from"./app-DPPlWUgE.js";import"./trash-Bqntw_EZ.js";import"./createLucideIcon-DCzPbb62.js";/* empty css                                                                       */import"./_plugin-vue_export-helper-DlAUqK2U.js";const q={class:"flex flex-col space-y-2 text-md p-2 bg-gray-50 rounded-md"},H={class:"grid grid-cols-2 gap-2"},M=["value"],z=["value"],U=["value"],W=["value"],J=["value"],K=["value"],Q=["value"],X=["type","value","placeholder"],ne={__name:"ConditionStep",props:{step:{type:Object,required:!0},allStepsBefore:{type:Array,default:()=>[]},loopContextSchema:{type:Object,default:null}},emits:["update:step","delete"],setup(D,{emit:k}){const p=D,x=k,B=$(),T=d(()=>B.automationSchema||[]),s=d({get:()=>p.step.step_config||{},set:a=>x("update:step",{...p.step,step_config:a})}),u=d(()=>{var t,g;if(p.loopContextSchema&&Array.isArray(p.loopContextSchema.columns)&&p.loopContextSchema.columns.length>0)return p.loopContextSchema;const a=[...p.allStepsBefore].reverse().find(n=>{var y;return n.step_type==="FOR_EACH"&&((y=n.step_config)==null?void 0:y.sourceArray)});if(!a)return null;const e=a.step_config.sourceArray,l=typeof e=="string"?e.match(/{{\s*step_(\w+)\.(.+?)\s*}}/):null;if(!l)return null;const o=l[1],r=l[2],m=p.allStepsBefore.find(n=>String(n.id)===String(o));if(!m)return null;if(m.step_type==="AI_PROMPT"){const n=(((t=m.step_config)==null?void 0:t.responseStructure)||[]).find(y=>y.name===r);return(n==null?void 0:n.type)==="Array of Objects"?{name:"Loop Item",columns:n.schema||[]}:null}if(m.step_type==="FETCH_RECORDS"&&r==="records"){const n=(g=m.step_config)==null?void 0:g.model;if(!n)return null;const y=T.value.find(h=>h.name===n);return y?{name:"Loop Item",columns:(y.columns||[]).map(h=>typeof h=="string"?{name:h}:h)}:null}return null});P(()=>{s.value.sourceId?u.value&&Array.isArray(u.value.columns)&&u.value.columns.length>0&&s.value.sourceId!=="loop"&&f("sourceId","loop"):!!(u.value&&Array.isArray(u.value.columns)&&u.value.columns.length>0)?f("sourceId","loop"):p.allStepsBefore.some(e=>e.step_type==="TRIGGER")&&f("sourceId","trigger")});const R=d(()=>{var l;const a=[];if(u.value&&Array.isArray(u.value.columns)&&u.value.columns.length>0){const o=u.value.columns.map(r=>typeof r=="string"?{name:r,type:"Text"}:{name:r.name,type:r.type||"Text"});a.push({id:"loop",name:"Current Loop Item (from For Each)",schema:{name:"LoopItem",columns:o}})}const e=p.allStepsBefore.find(o=>o.step_type==="TRIGGER");if(e&&((l=e.step_config)!=null&&l.model)){const o=T.value.find(r=>r.name===e.step_config.model);o&&a.push({id:"trigger",name:`Trigger: ${e.step_config.model}`,schema:o})}return p.allStepsBefore.forEach((o,r)=>{var m,t;if(o.step_type==="AI_PROMPT"&&((t=(m=o.step_config)==null?void 0:m.responseStructure)==null?void 0:t.length)>0&&a.push({id:o.id,name:`Step ${r+1}: AI Response`,schema:{name:`Step_${o.id}_Response`,columns:o.step_config.responseStructure.map(g=>({name:g.name,type:g.type==="Array of Objects"?"Array":g.type,schema:g.schema}))}}),o.step_type==="FETCH_RECORDS"&&!!!(u.value&&Array.isArray(u.value.columns)&&u.value.columns.length>0)){const n=o.step_config&&o.step_config.model?o.step_config.model:null,y=`Step ${r+1}: Fetch Records`+(n?` â€” ${n}`:"");a.push({id:`fetch_${o.id}`,name:y,schema:{name:`Step_${o.id}_Fetch`,columns:[{name:"records",type:"Array"},{name:"count",type:"Number"}]}})}}),a});function f(a,e){const l={...s.value,[a]:e};a==="sourceId"&&(delete l.field,delete l.operator,delete l.value),a==="field"&&(delete l.operator,delete l.value),s.value=l}const C=d(()=>R.value.find(a=>a.id==s.value.sourceId)),F=d(()=>{var a,e;return(e=(a=C.value)==null?void 0:a.schema)!=null&&e.columns?C.value.schema.columns.map(l=>typeof l=="string"?{name:l,label:l,type:"Text"}:{name:l.name,label:l.label||l.name,type:l.type||"Text",allowed_values:l.allowed_values||null}):[]}),b=d(()=>s.value.field?F.value.find(a=>a.name===s.value.field):null),O=d(()=>{var e;switch((e=b.value)==null?void 0:e.type){case"Array":return[{value:"not_empty",label:"is not empty"},{value:"empty",label:"is empty"}];case"True/False":return[{value:"==",label:"is"},{value:"!=",label:"is not"}];case"Number":return[{value:"==",label:"equals"},{value:">",label:"is greater than"},{value:"<",label:"is less than"},{value:">=",label:"is on or after"},{value:"<=",label:"is on or before"}];case"Date":case"DateTime":return[{value:"==",label:"is on"},{value:">",label:"is after"},{value:"<",label:"is before"},{value:"in_past",label:"is in the past"},{value:"in_future",label:"is in the future"},{value:"today",label:"is today"}];default:return[{value:"==",label:"is"},{value:"!=",label:"is not"},{value:"contains",label:"contains"}]}}),A=d(()=>{var e;const a=String(((e=s.value)==null?void 0:e.operator)||"").toLowerCase();return!["","empty","not_empty","in_past","in_future","today"].includes(a)}),L=d(()=>{var e;const a=(e=b.value)==null?void 0:e.type;return a==="Date"?"date":a==="DateTime"?"datetime-local":"text"});return(a,e)=>(i(),E(N,{icon:"ðŸ”€",title:"If/Else Condition",onDelete:()=>x("delete")},{default:V(()=>{var l,o,r,m;return[c("div",q,[e[10]||(e[10]=c("span",{class:"font-semibold text-gray-700"},"If...",-1)),c("div",H,[c("select",{value:s.value.sourceId||"",onChange:e[0]||(e[0]=t=>f("sourceId",t.target.value)),class:"p-2 border border-gray-300 rounded-md bg-white shadow-sm col-span-2 text-sm"},[e[6]||(e[6]=c("option",{value:"",disabled:""},"Select data source (Trigger, Current Loop Item, AI)...",-1)),(i(!0),v(_,null,w(R.value,t=>(i(),v("option",{key:t.id,value:t.id},S(t.name),9,z))),128))],40,M),C.value?(i(),v("select",{key:0,value:s.value.field||"",onChange:e[1]||(e[1]=t=>f("field",t.target.value)),class:"p-2 border border-gray-300 rounded-md bg-white shadow-sm col-span-2 text-sm"},[e[7]||(e[7]=c("option",{value:"",disabled:""},"Select field...",-1)),(i(!0),v(_,null,w(F.value,t=>(i(),v("option",{key:t.name,value:t.name},S(t.label)+" ("+S(t.type)+") ",9,W))),128))],40,U)):I("",!0),s.value.field?(i(),v(_,{key:1},[c("select",{value:s.value.operator||"",onChange:e[2]||(e[2]=t=>f("operator",t.target.value)),class:G(["p-2 border border-gray-300 rounded-md bg-white shadow-sm text-sm",{"col-span-2":((l=b.value)==null?void 0:l.type)==="Array"}])},[e[8]||(e[8]=c("option",{value:"",disabled:""},"Select condition...",-1)),(i(!0),v(_,null,w(O.value,t=>(i(),v("option",{key:t.value,value:t.value},S(t.label),9,K))),128))],42,J),(o=b.value)!=null&&o.allowed_values&&A.value?(i(),E(j,{key:0,options:(b.value.allowed_values||[]).map(t=>({value:t.value,label:t.label})),"model-value":s.value.value??null,placeholder:"Select value...","onUpdate:modelValue":e[3]||(e[3]=t=>f("value",t))},null,8,["options","model-value"])):((r=b.value)==null?void 0:r.type)==="True/False"&&A.value?(i(),v("select",{key:1,value:s.value.value??"true",onChange:e[4]||(e[4]=t=>f("value",t.target.value)),class:"p-2 border border-gray-300 rounded-md bg-white shadow-sm text-sm"},e[9]||(e[9]=[c("option",{value:"true"},"True",-1),c("option",{value:"false"},"False",-1)]),40,Q)):((m=b.value)==null?void 0:m.type)!=="Array"&&A.value?(i(),v("input",{key:2,type:L.value,value:s.value.value||"",onInput:e[5]||(e[5]=t=>f("value",t.target.value)),placeholder:L.value==="text"?"Value":"",class:"p-2 border border-gray-300 rounded-md bg-white shadow-sm text-sm"},null,40,X)):I("",!0)],64)):I("",!0)])])]}),_:1},8,["onDelete"]))}};export{ne as default};
