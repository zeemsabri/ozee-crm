import{aA as M,aL as D,D as G,c as f,r as u,C as L,e as B,f as q,aM as I,a as r,o as n,d as l,u as w,h as T,w as p,b as a,t as m,m as g,s as Y,i as z,v as Q,F as C,l as R,G as H}from"./app-DLjAqOLz.js";import{_ as J}from"./AuthenticatedLayout-BVUr15BD.js";import{_ as K}from"./PrimaryButton-Cjq6h6xi.js";import{_ as b}from"./InputLabel-CrNYsmle.js";import{_ as O}from"./TextInput-Bu9IgCoB.js";import{_ as h}from"./InputError-BRGOJlIi.js";import{_ as W}from"./EmailEditor-CpKCHqr2.js";import{s as X}from"./vue-multiselect-DmVVRDs-.js";import"./Modal-Ba2dzumd.js";import"./SecondaryButton-UcxkpF2R.js";import"./index-Cj9RV2uE.js";import"./BaseFormModal-CiIBTfgV.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./SelectDropdown-By67b8hZ.js";/* empty css                                                                       */import"./debounce-C-hnF4Z3.js";import"./ApplicationLogo-1InKgam7.js";import"./DangerButton-Cs8nuPnh.js";import"./moment-BLMuvzoS.js";import"./NoticeboardModal-XfR3NgKv.js";import"./EmailEditor.vue_vue_type_style_index_0_lang-C9ALDHnB.js";const Z={class:"py-12"},ee={class:"max-w-7xl mx-auto sm:px-6 lg:px-8"},se={class:"bg-white overflow-hidden shadow-sm sm:rounded-lg"},oe={class:"p-6 text-gray-900"},te={key:0,class:"text-red-600 mb-4"},ae={key:1,class:"text-gray-600 mb-4"},le={key:2,class:"text-red-600 mb-4"},ie={key:3,class:"text-gray-600 mb-4"},re={key:0},ne={key:1},ce={key:4},de={key:0,class:"bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4",role:"alert"},ue={class:"block sm:inline"},me={class:"mb-4"},pe=["value"],_e={class:"mb-4"},ve={class:"multiselect__tag"},fe=["onClick"],ge={class:"mb-4"},be={class:"mb-6"},he={class:"flex items-center justify-end"},Ye={__name:"Composer",setup(ye){const k=M(),{permissions:E,loading:V,error:S}=D(),{canDo:A}=G(),x=f(()=>A("compose_emails").value||!0),_=u([]),y=u([]),j=u(!0),i=u({}),c=u(""),v=u(""),t=L({project_id:"",client_ids:[],subject:"",body:""}),P=f(()=>_.value);f(()=>y.value.filter(s=>t.client_ids.includes(s.id)));const N=f(()=>{if(!t.project_id)return[];const s=_.value.find(e=>e.id===t.project_id);if(!s||!s.clients)return[];const o=s.clients.map(e=>e.id);return y.value.filter(e=>o.includes(e.id))}),F=async()=>{j.value=!0,c.value="";try{const s=await window.axios.get("/api/projects-for-email");_.value=s.data.projects;const o=new Map;_.value.forEach(e=>{e.clients&&e.clients.length>0&&e.clients.forEach(d=>{o.set(d.id,d)})}),y.value=Array.from(o.values())}catch(s){c.value="Failed to load projects.",console.error("Error fetching initial data:",s),s.response&&(s.response.status===401||s.response.status===403)&&(c.value="You are not authorized to view this content or your session expired. Please log in.")}finally{j.value=!1}};B(()=>t.project_id,s=>{t.client_ids=[]});const U=async()=>{if(i.value={},c.value="",v.value="",!t.project_id){i.value.project_id=["Please select a project."];return}if(!t.client_ids||t.client_ids.length===0){i.value.client_ids=["Please select at least one client."];return}try{const s=t.client_ids.map(e=>typeof e=="object"&&e!==null?{id:e.id}:{id:e}),o={project_id:t.project_id,client_ids:s,subject:t.subject,body:t.body,status:"pending_approval"};await window.axios.post("/api/emails",o),v.value="Email submitted for approval successfully!",t.project_id="",t.client_ids=[],t.subject="",t.body="",i.value={}}catch(s){s.response&&s.response.status===422?i.value=s.response.data.errors:s.response&&s.response.data.message?c.value=s.response.data.message:(c.value="Failed to submit email. An unexpected error occurred.",console.error("Error submitting email:",s))}},$=()=>{const o=new URLSearchParams(window.location.search).get("project_id");o&&(t.project_id=o)};return q(async()=>{try{console.log("Fetching global permissions...");const s=await I();console.log("Global permissions fetched:",s)}catch(s){console.error("Error fetching global permissions:",s)}F().then(()=>{$()}),console.log("All data loaded, permission status:"),console.log("- Global permissions:",E.value),console.log("- Permissions loading:",V.value),console.log("- Permissions error:",S.value),console.log("- Can compose emails:",x.value)}),(s,o)=>(n(),r(C,null,[l(w(T),{title:"Compose Email"}),l(J,null,{header:p(()=>o[4]||(o[4]=[a("h2",{class:"font-semibold text-xl text-gray-800 leading-tight"},"Compose New Email",-1)])),default:p(()=>[a("div",Z,[a("div",ee,[a("div",se,[a("div",oe,[o[8]||(o[8]=a("h3",{class:"text-2xl font-bold mb-6"},"Create New Email for Client",-1)),x.value?j.value?(n(),r("div",ae,"Loading data...")):c.value?(n(),r("div",le,m(c.value),1)):P.value.length===0?(n(),r("div",ie,[o[5]||(o[5]=g(" No projects assigned to you for email composition. ",-1)),w(k).role==="contractor"?(n(),r("span",re,"Please ensure you are assigned to a project.")):(n(),r("span",ne,"Please ensure there are projects available."))])):(n(),r("div",ce,[a("form",{onSubmit:Y(U,["prevent"])},[v.value?(n(),r("div",de,[a("span",ue,m(v.value),1)])):z("",!0),a("div",me,[l(b,{for:"project_id",value:"Select Project"}),Q(a("select",{id:"project_id",class:"border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 rounded-md shadow-sm mt-1 block w-full","onUpdate:modelValue":o[0]||(o[0]=e=>t.project_id=e),required:""},[o[6]||(o[6]=a("option",{value:"",disabled:""},"Select a Project",-1)),(n(!0),r(C,null,R(P.value,e=>(n(),r("option",{key:e.id,value:e.id},m(e.name)+" (Clients: "+m(e.clients.length?e.clients.map(d=>d.name).join(", "):"N/A")+") ",9,pe))),128))],512),[[H,t.project_id]]),l(h,{message:i.value.project_id?i.value.project_id[0]:"",class:"mt-2"},null,8,["message"])]),a("div",_e,[l(b,{for:"client_ids",value:"To (Clients)"}),l(w(X),{id:"client_ids",modelValue:t.client_ids,"onUpdate:modelValue":o[1]||(o[1]=e=>t.client_ids=e),options:N.value,multiple:!0,"close-on-select":!0,"clear-on-select":!1,"preserve-search":!0,placeholder:"Select one or more clients",label:"name","track-by":"id",searchable:!0,"allow-empty":!0},{option:p(({option:e})=>[g(m(e.name),1)]),tag:p(({option:e,remove:d})=>[a("span",ve,[g(m(e.name)+" ",1),a("i",{class:"multiselect__tag-icon",onClick:je=>d(e)},null,8,fe)])]),_:1},8,["modelValue","options"]),l(h,{message:i.value.client_ids?i.value.client_ids[0]:"",class:"mt-2"},null,8,["message"])]),a("div",ge,[l(b,{for:"subject",value:"Subject"}),l(O,{id:"subject",type:"text",class:"mt-1 block w-full",modelValue:t.subject,"onUpdate:modelValue":o[2]||(o[2]=e=>t.subject=e),required:""},null,8,["modelValue"]),l(h,{message:i.value.subject?i.value.subject[0]:"",class:"mt-2"},null,8,["message"])]),a("div",be,[l(b,{for:"body",value:"Email Body"}),l(W,{id:"body",modelValue:t.body,"onUpdate:modelValue":o[3]||(o[3]=e=>t.body=e),placeholder:"Compose your email here...",height:"300px"},null,8,["modelValue"]),l(h,{message:i.value.body?i.value.body[0]:"",class:"mt-2"},null,8,["message"])]),a("div",he,[l(K,{type:"submit"},{default:p(()=>o[7]||(o[7]=[g("Submit for Approval",-1)])),_:1,__:[7]})])],32)])):(n(),r("div",te," You do not have permission to compose emails. Please contact your administrator. "))])])])])]),_:1})],64))}};export{Ye as default};
