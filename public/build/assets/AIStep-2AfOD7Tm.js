import{u as ne}from"./workflowStore-DMkwNXfJ.js";import re from"./StepCard-lQ3hdvW4.js";import{_ as ie,a as ue}from"./RelatedDataPicker-BJfh-eqW.js";import{B as me}from"./BaseFormModal-_SRr_3OK.js";import pe from"./PromptForm-Cntn7pDm.js";import{S as de}from"./SelectDropdown-CFOqYu4w.js";import{C as ce}from"./circle-x-BUqGyZop.js";import{c as a,e as q,f as ve,r as R,a as r,o as n,d as k,w as X,b as l,i as _,t as p,F as v,l as V,m as g,u as fe,g as ge}from"./app-DPPlWUgE.js";import"./trash-Bqntw_EZ.js";import"./createLucideIcon-DCzPbb62.js";import"./Modal-Dtl518ch.js";import"./PrimaryButton-BGxDguGg.js";import"./SecondaryButton-CS9GxTxs.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./ResponseBuilder-oJ5yh6Ck.js";import"./FieldBuilder-DELdh6bs.js";import"./chevron-down-87F3hybH.js";/* empty css                                                                       */const ye={class:"mb-3"},he={class:"flex gap-2 mt-1 items-center"},be={class:"flex-1"},_e=["disabled"],xe={key:0,class:"text-[11px] text-gray-500 mt-1"},Se={class:"space-y-2"},ke={class:"p-2 bg-gray-50 rounded-md border space-y-2"},we={class:"text-sm font-medium text-indigo-700"},Ce=["onClick"],Ae={class:"flex items-center justify-between"},Ie={class:"text-xs inline-flex items-center gap-1"},$e=["checked"],Pe={key:0,class:"border-t pt-3 mt-3"},Ne={class:"flex items-center justify-between"},Oe={class:"block text-sm font-medium text-gray-700"},Re={key:0,class:"mt-2 text-xs text-gray-700"},Ve={class:"list-disc ml-5 space-y-0.5"},je={class:"space-y-2"},Ee={class:"p-2 bg-gray-50 rounded border"},Le={key:0,class:"text-xs text-gray-500"},Fe={key:1,class:"text-xs text-gray-700 space-y-1"},Me={class:"font-medium"},Be={key:0,class:"ml-4 list-disc"},De={class:"font-medium"},nt={__name:"AIStep",props:{step:{type:Object,required:!0},allStepsBefore:{type:Array,default:()=>[]},loopContextSchema:{type:Object,default:null}},emits:["update:step","delete"],setup(Y,{emit:K}){const c=Y,B=K,y=ne(),j=a(()=>y.automationSchema||[]);a(()=>y.campaigns||[]);const D=a(()=>y.prompts||[]),$=a(()=>{const t=Array.isArray(D.value)?[...D.value]:[];return t.sort((e,s)=>{const o=(e.name||"").localeCompare(s.name||"");return o!==0?o:(s.version||0)-(e.version||0)}),t}),Q=a(()=>$.value.map(t=>({value:t.id,label:`${t.name} (v${t.version})`}))),u=a({get:()=>c.step.step_config||{},set:t=>B("update:step",{...c.step,step_config:t})}),P=a(()=>{var e,s;const t=(s=(e=u.value)==null?void 0:e.promptRef)==null?void 0:s.id;return t&&$.value.find(o=>String(o.id)===String(t))||null});q(P,t=>{if(t&&Array.isArray(t.response_variables)){const e=JSON.parse(JSON.stringify(t.response_variables));f("responseStructure",e)}},{immediate:!0}),ve(()=>{y.prompts.length||y.fetchPrompts()});const w=a({get:()=>{var t,e;return((e=(t=u.value)==null?void 0:t.promptRef)==null?void 0:e.id)||null},set:t=>{const e=$.value.find(s=>String(s.id)===String(t))||null;e?f("promptRef",{id:e.id,name:e.name,version:e.version}):f("promptRef",null)}}),x=R(!1),E=R("create"),h=R(null);function Z(){E.value="create",h.value={name:"New Prompt",category:"General",version:1,system_prompt_text:`You are a helpful AI assistant.

Use the provided template variables like {{example_variable}} to craft your response.`,model_name:"gemini-2.5-flash-preview-05-20",generation_config:{temperature:.7,maxOutputTokens:2048,responseMimeType:"application/json"},template_variables:["example_variable"],response_variables:[],response_json_template:[],status:"draft"},x.value=!0}function ee(){const t=w.value,e=$.value.find(s=>s.id===t);e&&(E.value="edit",h.value=JSON.parse(JSON.stringify(e)),x.value=!0)}async function te(t){try{let e;if(t.id&&!t.isNewVersion)e=await y.updatePrompt(t.id,t);else{const{id:s,isNewVersion:o,...d}=t;e=await y.createPrompt(d)}e&&e.id&&(w.value=e.id),x.value=!1,h.value=null}catch(e){console.error("Failed to save prompt from modal",e)}}const C=a(()=>c.allStepsBefore.find(t=>t.step_type==="TRIGGER")),T=a(()=>{var t,e;return((e=(t=C.value)==null?void 0:t.step_config)==null?void 0:e.model)||"Trigger"}),N=a(()=>{var t;return!C.value||!((t=C.value.step_config)!=null&&t.model)?null:j.value.find(e=>e.name===C.value.step_config.model)}),L=a(()=>Array.isArray(u.value.aiInputs)?u.value.aiInputs:[]),se=a(()=>L.value.filter(t=>typeof t=="string"&&(t.startsWith("trigger:")||!t.includes(":"))).map(t=>t.startsWith("trigger:")?t.slice(8):t)),oe=a(()=>L.value.filter(t=>typeof t=="string"&&t.startsWith("loop:")).map(t=>t.slice(5)));a(()=>{if(!N.value)return[];const t=new Set(se.value);return(N.value.columns||[]).filter(e=>!t.has(e.name||e))});const W=a(()=>{var G,H;if(c.loopContextSchema&&Array.isArray(c.loopContextSchema.columns)&&c.loopContextSchema.columns.length>0)return c.loopContextSchema;const t=[...c.allStepsBefore].reverse().find(m=>{var b;return m.step_type==="FOR_EACH"&&((b=m.step_config)==null?void 0:b.sourceArray)});if(!t)return null;const e=t.step_config.sourceArray,s=typeof e=="string"?e.match(/{{\s*step_(\w+)\.(.+?)\s*}}/):null;if(!s)return null;const o=s[1],d=s[2],A=c.allStepsBefore.find(m=>String(m.id)===String(o));if(!A)return null;if(A.step_type==="AI_PROMPT"){const m=(((G=A.step_config)==null?void 0:G.responseStructure)||[]).find(b=>b.name===d);return(m==null?void 0:m.type)==="Array of Objects"?{name:"Loop Item",columns:m.schema||[]}:null}if(A.step_type==="FETCH_RECORDS"&&d==="records"){const m=(H=A.step_config)==null?void 0:H.model;if(!m)return null;const b=j.value.find(I=>I.name===m);return b?{name:"Loop Item",columns:(b.columns||[]).map(I=>typeof I=="string"?{name:I}:I),modelName:m}:null}return null}),J=a(()=>{const t=W.value;if(!t||!Array.isArray(t.columns)||t.columns.length===0)return[];const e=new Set(oe.value);return t.columns.map(s=>typeof s=="string"?{name:s,label:s}:{name:s.name,label:s.label||s.name}).filter(s=>s.name&&!e.has(s.name))}),O=a(()=>{const t=[];if(N.value){const e=T.value||"Trigger";(N.value.columns||[]).forEach(s=>{const o=typeof s=="string"?s:s.name||"",d=typeof s=="string"?s:s.label||s.name||"";o&&t.push({value:`trigger:${o}`,label:`Trigger: ${e} â€” ${d}`})})}return J.value.length>0&&J.value.forEach(e=>{const s=e.name,o=e.label||e.name;s&&t.push({value:`loop:${s}`,label:`Current Loop Item â€” ${o}`})}),t}),F=a({get:()=>(Array.isArray(u.value.aiInputs)?u.value.aiInputs:[]).map(e=>typeof e=="string"&&e.includes(":")?e:`trigger:${e}`),set:t=>{f("aiInputs",Array.isArray(t)?t:[])}}),U=a(()=>{const t=O.value.length,e=new Set(F.value||[]),s=new Set(O.value.map(d=>d.value));let o=0;return s.forEach(d=>{e.has(d)&&o++}),t>0&&o===t});function le(){U.value?f("aiInputs",[]):f("aiInputs",O.value.map(t=>t.value))}const S=a(()=>{var t,e,s;return((t=W.value)==null?void 0:t.modelName)||((s=(e=C.value)==null?void 0:e.step_config)==null?void 0:s.model)||null}),z=a(()=>S.value?j.value.find(t=>t.name===S.value):null),i=a({get:()=>u.value.relationships||{base_model:S.value||null,roots:[],nested:{},fields:{}},set:t=>f("relationships",t)});q(S,t=>{const e=i.value||{};e.base_model!==t&&(i.value={...e,base_model:t})},{immediate:!0}),a(()=>{var t;return((t=z.value)==null?void 0:t.relationships)||[]});function f(t,e){u.value={...u.value,[t]:e}}function ae(t){const e=L.value;f("aiInputs",e.filter(s=>s!==t))}a(()=>{const t=u.value.responseStructure||[];if(t.length===0)return"";const e=s=>(s||[]).filter(o=>o.name).map(o=>o.type==="Array of Objects"?`"${o.name}": [{ ${e(o.schema||[])} }]`:`"${o.name}": <${o.type.toLowerCase()}>`).join(", ");return`Respond with JSON in this exact format: { ${e(t)} }`});const M=R(!1);return(t,e)=>(n(),r(v,null,[k(re,{icon:"ðŸ§ ",title:"Analyze with AI",onDelete:()=>B("delete")},{default:X(()=>[l("div",ye,[e[7]||(e[7]=l("label",{class:"block text-sm font-medium text-gray-700"},"Prompt",-1)),l("div",he,[l("div",be,[k(de,{options:Q.value,modelValue:w.value,"onUpdate:modelValue":e[0]||(e[0]=s=>w.value=s),placeholder:"â€” Select a prompt â€”"},null,8,["options","modelValue"])]),l("button",{type:"button",onClick:Z,class:"px-2 py-1 text-xs font-semibold text-white bg-indigo-600 rounded-md hover:bg-indigo-700"},"Create"),l("button",{type:"button",onClick:ee,disabled:!w.value,class:"px-2 py-1 text-xs font-semibold bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"},"Edit",8,_e)]),P.value?(n(),r("p",xe,"Linked: "+p(P.value.name)+" (v"+p(P.value.version)+")",1)):_("",!0)]),l("div",Se,[e[9]||(e[9]=l("h4",{class:"text-sm font-medium text-gray-700"},"Data to Analyze",-1)),l("div",ke,[(n(!0),r(v,null,V(u.value.aiInputs||[],s=>(n(),r("div",{key:s,class:"flex items-center justify-between bg-white p-1 rounded border"},[l("span",we,[typeof s=="string"&&s.startsWith("loop:")?(n(),r(v,{key:0},[g(" Current Loop Item: "+p(s.slice(5)),1)],64)):(n(),r(v,{key:1},[g(p(T.value)+": "+p(typeof s=="string"&&s.startsWith("trigger:")?s.slice(8):s),1)],64))]),l("button",{onClick:o=>ae(s),class:"text-gray-400 hover:text-red-500"},[k(fe(ce),{class:"h-4 w-4"})],8,Ce)]))),128)),l("div",Ae,[l("label",Ie,[l("input",{type:"checkbox",checked:U.value,onChange:le,class:"rounded border-gray-300"},null,40,$e),e[8]||(e[8]=g(" Select all ",-1))])]),k(ie,{options:O.value,"model-value":F.value,placeholder:"Select fields from Trigger and/or Current Loop Item...","onUpdate:modelValue":e[1]||(e[1]=s=>F.value=s)},null,8,["options","model-value"])])]),z.value?(n(),r("div",Pe,[l("div",Ne,[l("label",Oe,"Include Related Data from "+p(S.value),1),l("button",{onClick:e[2]||(e[2]=s=>M.value=!0),type:"button",class:"text-xs px-2 py-1 rounded-md bg-white ring-1 ring-gray-300 hover:bg-gray-50"},"Chooseâ€¦")]),i.value&&(i.value.roots&&i.value.roots.length||Object.keys(i.value.fields||{}).length)?(n(),r("div",Re,[e[10]||(e[10]=l("p",{class:"font-medium"},"Summary",-1)),l("ul",Ve,[(n(!0),r(v,null,V(i.value.roots||[],s=>(n(),r("li",{key:"sum-"+s},[g(p(s)+" ",1),i.value.fields&&i.value.fields[s]&&i.value.fields[s].length&&!i.value.fields[s].includes("*")?(n(),r(v,{key:0},[g(" â€” fields: "+p(i.value.fields[s].join(", ")),1)],64)):_("",!0),i.value.nested&&i.value.nested[s]&&i.value.nested[s].length?(n(),r(v,{key:1},[g(" â€” also: "+p(i.value.nested[s].map(o=>s+"."+o).join(", ")),1)],64)):_("",!0)]))),128))]),e[11]||(e[11]=l("p",{class:"text-[11px] text-gray-500 mt-1"},"Selected related records will be available in your prompt under the with key (e.g., with.campaign, with.campaign.leads).",-1))])):_("",!0),k(ue,{show:M.value,"base-model-name":S.value,modelValue:i.value,"onUpdate:modelValue":e[3]||(e[3]=s=>i.value=s),onClose:e[4]||(e[4]=s=>M.value=!1)},null,8,["show","base-model-name","modelValue"])])):_("",!0),l("div",je,[e[13]||(e[13]=l("h4",{class:"text-sm font-medium text-gray-700"},"Expected AI Response Structure",-1)),l("div",Ee,[u.value.responseStructure&&u.value.responseStructure.length?(n(),r("ul",Fe,[(n(!0),r(v,null,V(u.value.responseStructure,s=>(n(),r("li",{key:"r-"+s.id},[l("span",Me,p(s.name),1),g(": "+p(s.type)+" ",1),s.schema&&s.schema.length?(n(),r("ul",Be,[(n(!0),r(v,null,V(s.schema,o=>(n(),r("li",{key:"r-"+s.id+"-"+o.id},[l("span",De,p(o.name),1),g(": "+p(o.type),1)]))),128))])):_("",!0)]))),128))])):(n(),r("p",Le," Link a Prompt to auto-fill the expected response structure. ")),e[12]||(e[12]=l("p",{class:"text-[11px] text-gray-500 mt-1"},"To change the structure, edit the linked Prompt.",-1))])])]),_:1},8,["onDelete"]),k(me,{show:x.value,title:E.value==="create"?"Create Prompt":"Edit Prompt",formData:h.value||{},showFooter:!1,onClose:e[6]||(e[6]=s=>x.value=!1)},{default:X(()=>[h.value?(n(),ge(pe,{key:0,prompt:h.value,onSave:te,onCancel:e[5]||(e[5]=s=>{x.value=!1,h.value=null})},null,8,["prompt"])):_("",!0)]),_:1},8,["show","title","formData"])],64))}};export{nt as default};
