import{r as g,f as C,c as y,a as v,o as f,u as G,b as p,F as I,g as A,i as D,v as N,x as U,d as L}from"./app-C_l5dlFM.js";import{u as W}from"./workflowStore-XAGUmoSA.js";import $ from"./Workflow-m-0tyKuT.js";import F from"./TriggerSelectionModal-CD1gvVcC.js";import"./TriggerStep-thykhdf8.js";import"./StepCard-C2N0dOAe.js";import"./trash-Bh-xRuVC.js";import"./createLucideIcon-kJjbaSbK.js";import"./SelectDropdown-Duuae3KQ.js";/* empty css                                                                       */import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./ConditionStep-zRpXgAw5.js";import"./ActionStep-D5GfFcAv.js";import"./DataTokenInserter-B5tp_nJc.js";import"./plus-BLJjzuTJ.js";import"./AIStep-C_IlUOxS.js";import"./RelatedDataPicker-OZ5dHcCt.js";import"./BaseFormModal-gnHL_btQ.js";import"./Modal-ernkAfjj.js";import"./PrimaryButton-BeqOxdrm.js";import"./SecondaryButton-CHg2i9M2.js";import"./PromptForm-BV1zDQVI.js";import"./ResponseBuilder-BjjM8RZ2.js";import"./FieldBuilder-CAOdJHz8.js";import"./chevron-down-CCfqkMMZ.js";import"./circle-x-DCvXriQI.js";import"./ForEachStep-Bfr3boIP.js";import"./FetchRecordsStep-DxJjA9Tu.js";import"./ScheduleTriggerStep-DToDv6XI.js";import"./AddStepButton-3OZ8Cs5L.js";const H={class:"max-w-12xl mx-auto space-y-6"},B={key:0,class:"text-center py-10"},O={class:"bg-white p-4 rounded-lg shadow-md border flex justify-between items-center sticky top-4 z-20"},V={class:"flex space-x-2"},M=["disabled"],J={class:"p-2 sm:p-6 pb-40"},be={__name:"AutomationBuilder",props:{automationId:{type:[Number,String],default:null}},emits:["back"],setup(_,{emit:w}){const m=_,h=w,i=W(),s=g([]),u=g(""),d=g(!1);C(async()=>{try{i.automationSchema.length||await i.fetchAutomationSchema()}catch{}m.automationId?(await i.fetchWorkflow(m.automationId),i.activeWorkflow&&(s.value=JSON.parse(JSON.stringify(i.activeWorkflow.steps)),u.value=i.activeWorkflow.name)):(i.activeWorkflow=null,u.value="Untitled Automation",s.value=[],d.value=!0)});function b(t){let e;t==="SCHEDULE_TRIGGER"?e={id:`temp_${Date.now()}`,step_type:"SCHEDULE_TRIGGER",name:"Starts on a Schedule",step_config:{trigger_event:"schedule.run"}}:e={id:`temp_${Date.now()}`,step_type:"TRIGGER",name:"New Event Trigger",step_config:{}},s.value=[e],d.value=!1}const x=y(()=>{const t=s.value[0];return t?t.step_type==="SCHEDULE_TRIGGER"?!0:!!(t.step_config&&t.step_config.trigger_event):!1}),S=y(()=>x.value&&u.value.trim()!==""),c=(t,e=null,n=null)=>{let a=[];return t.forEach((r,l)=>{const o={...r},E=o.if_true,R=o.if_false,T=o.children;delete o.if_true,delete o.if_false,delete o.children,o.step_order=l+1,e&&(o.step_config=o.step_config||{},o.step_config._parent_id=e,o.step_config._branch=n),a.push(o),r.step_type==="CONDITION"&&(a=[...a,...c(E||[],r.id,"yes"),...c(R||[],r.id,"no")]),r.step_type==="FOR_EACH"&&(a=[...a,...c(T||[],r.id,null)])}),a};async function k(){var r;const t=s.value[0]||{},e=t.step_type==="SCHEDULE_TRIGGER"?"schedule.run":((r=t.step_config)==null?void 0:r.trigger_event)||null,n=c(s.value).map(l=>l.step_type==="SCHEDULE_TRIGGER"?{...l,step_type:"TRIGGER",step_config:{...l.step_config||{},trigger_event:"schedule.run"}}:l),a={name:u.value,trigger_event:e,is_active:!0,steps:n};try{m.automationId?await i.updateWorkflow(m.automationId,a):await i.createWorkflow(a),h("back")}catch(l){console.error("Failed to save automation:",l),i.showAlert("Save Failed","Could not save the automation.")}}return(t,e)=>(f(),v("div",H,[G(i).isLoading&&_.automationId?(f(),v("div",B,e[5]||(e[5]=[p("p",null,"Loading Automation...",-1)]))):(f(),v(I,{key:1},[p("div",O,[N(p("input",{type:"text","onUpdate:modelValue":e[0]||(e[0]=n=>u.value=n),placeholder:"Untitled Automation",class:"text-xl font-bold text-gray-800 focus:outline-none bg-transparent w-full"},null,512),[[U,u.value]]),p("div",V,[p("button",{onClick:e[1]||(e[1]=n=>t.$emit("back")),class:"inline-flex items-center gap-x-2 rounded-md px-3.5 py-2 text-sm font-semibold shadow-sm bg-white text-gray-900 ring-1 ring-inset ring-gray-300 hover:bg-gray-50"}," Cancel "),p("button",{onClick:k,disabled:!S.value,class:"inline-flex items-center gap-x-2 rounded-md px-3.5 py-2 text-sm font-semibold shadow-sm bg-indigo-600 text-white hover:bg-indigo-500 focus-visible:outline-indigo-600 disabled:opacity-50"}," Save and Activate ",8,M)])]),p("div",J,[L($,{steps:s.value,"onUpdate:steps":e[2]||(e[2]=n=>s.value=n),onAddTrigger:e[3]||(e[3]=n=>d.value=!0)},null,8,["steps"]),e[6]||(e[6]=p("div",{class:"h-60"},null,-1))]),d.value?(f(),A(F,{key:0,onClose:e[4]||(e[4]=n=>d.value=!1),onSelect:b})):D("",!0)],64))]))}};export{be as default};
