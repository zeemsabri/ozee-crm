import{r as f,c as z,e as D,n as C,f as G,N as K,a as v,o as u,F as A,l as U,b as m,t as Q,i as B,x as W,J as X,R as Y,g as Z}from"./app-B0PCYUNM.js";import ee from"./ProjectCard-DqEPfuaX.js";import"./currency-0iatj6pI.js";const te={class:"space-y-6"},ae={key:0,class:"space-y-6"},ne={key:1,class:"flex justify-center items-center h-48 bg-white rounded-xl shadow-md p-6 text-red-500"},re={key:2,class:"flex justify-center items-center h-48 bg-white rounded-xl shadow-md p-6 text-gray-500"},se={key:0,class:"bg-white rounded-xl shadow-md p-6"},oe={key:1,class:"text-center text-sm text-gray-400 py-2"},O=5,I=14400*1e3,ue={__name:"ProjectCards",props:{search:{type:String,default:""},activeFilter:{type:String,default:"all"}},setup(L){const o=L,h=f(!0),_=f(null),i=f([]),M=z(()=>{const e=i.value||[],t=(o.activeFilter||"all").toLowerCase();return t==="manager"?e.filter(a=>a.role==="Manager"):t==="contributor"?e.filter(a=>a.role==="Contributor"):e}),l=f(1),c=f(1),w=f(!1),x=f(null);let r=null;const N=e=>{try{return e?new Date(e).toLocaleString():null}catch{return null}},R=e=>{if(e<=0||!isFinite(e))return null;const t=Math.floor(e/(3600*1e3)),a=Math.floor(e%(3600*1e3)/(60*1e3));return t>0&&a>0?`${t}h ${a}m`:t>0?`${t}h`:`${a}m`},V=e=>e&&(e==="manager"||e==="admin")?"Manager":"Contributor",S=e=>e==="active"?"on-track":e==="on_hold"?"needs-attention":e==="completed"?"on-track":"at-risk",q=e=>{var y,k;const t=e.current_milestone||null,a=t?`${t.progress_percent??0}% Complete`:"No active milestone",d=t?`${t.name} (${a})`:"No active milestone";let g="$8,000 / $10,000 Used";if(t&&t.budget&&t.budget.amount!=null){const n=t.budget.currency||"",p=t.budget.approved_amount??0,j=t.budget.amount??0;g=`${p}${n?" "+n:""} / ${j}${n?" "+n:""} Used`}const s={id:e.id,name:e.name,role:"Manager",health:S(e.status),alert:null,overview:{milestone:d,budget:g,status:"In Progress"},tasks:{today:(((y=e.tasks)==null?void 0:y.today)||[]).map(n=>({id:n.id,name:n.name,status:n.status})),tomorrow:(((k=e.tasks)==null?void 0:k.tomorrow)||[]).map(n=>({id:n.id,name:n.name,status:n.status})),completed:[]},communication:{lastSent:N(e.last_email_sent)||"—",lastReceived:N(e.last_email_received)||"—"}};if(e.last_email_received){const p=new Date(e.last_email_received).getTime();if(!isNaN(p)){const j=Date.now()-p,J=I-j,T=R(J);T&&(s.alert={text:`Client email from ${s.name} requires a reply.`,timer:T,incentive:"Reply in time to earn 50 points."})}}return s},E=e=>{var d,g;const t=e.current_milestone||null,a={id:e.id,name:e.name,role:"Contributor",health:S(e.status),tasks:{today:(((d=e.tasks)==null?void 0:d.today)||[]).map(s=>({id:s.id,name:s.name,status:s.status})),tomorrow:(((g=e.tasks)==null?void 0:g.tomorrow)||[]).map(s=>({id:s.id,name:s.name,status:s.status})),completed:[]},milestone:{name:(t==null?void 0:t.name)||"Current Milestone",deadline:(t==null?void 0:t.deadline)||"",progress:(t==null?void 0:t.progress_percent)??0,completed:typeof(t==null?void 0:t.tasks_done)=="number"?t.tasks_done:null,left:typeof(t==null?void 0:t.tasks_total)=="number"&&typeof(t==null?void 0:t.tasks_done)=="number"?Math.max(0,t.tasks_total-t.tasks_done):null,incentive:""}};if(e.last_email_received){const y=new Date(e.last_email_received).getTime();if(!isNaN(y)){const k=Date.now()-y,n=I-k,p=R(n);p&&(a.alert={text:`Client email from ${a.name} requires a reply.`,timer:p,incentive:"Reply in time to earn 50 points."})}}return a},b=e=>V(e.role)==="Manager"?q(e):E(e),P=e=>e&&typeof e=="object"&&Array.isArray(e.data)&&typeof e.current_page<"u",F=async()=>{h.value=!0,_.value=null,l.value=1,c.value=1,i.value=[];try{const{data:e}=await window.axios.get("/api/workspace/projects",{params:{page:l.value,per_page:O,search:o.search||void 0,filter:o.activeFilter&&o.activeFilter!=="all"?o.activeFilter:void 0}}),t=e;Array.isArray(t)?(i.value=t.map(b),c.value=1,l.value=1):P(t)?(i.value=(t.data||[]).map(b),l.value=t.current_page||1,c.value=t.last_page||1):(i.value=[],c.value=1)}catch(e){console.error("Failed to load workspace projects",e),_.value="Failed to load your projects.",i.value=[],c.value=1}finally{h.value=!1}},H=async()=>{if(!(h.value||w.value)&&!(l.value>=c.value)){w.value=!0;try{const e=l.value+1,{data:t}=await window.axios.get("/api/workspace/projects",{params:{page:e,per_page:O,search:o.search||void 0,filter:o.activeFilter&&o.activeFilter!=="all"?o.activeFilter:void 0}}),a=t;if(Array.isArray(a)){const d=a.map(b);d.length&&(i.value=i.value.concat(d)),l.value=e,c.value=e}else if(P(a)){const d=(a.data||[]).map(b);i.value=i.value.concat(d),l.value=a.current_page||e,c.value=a.last_page||l.value}}catch(e){console.error("Failed to load more workspace projects",e)}finally{w.value=!1}}};function $(){r&&r.disconnect(),r=new IntersectionObserver(e=>{const t=e[0];t&&t.isIntersecting&&H()},{root:null,rootMargin:"200px",threshold:0}),x.value&&r.observe(x.value)}return D(()=>o.search,async()=>{r&&(r.disconnect(),r=null),await F(),await C(),$()}),D(()=>o.activeFilter,async()=>{r&&(r.disconnect(),r=null),await F(),await C(),$()}),G(async()=>{await F(),await C(),$()}),K(()=>{r&&(r.disconnect(),r=null)}),(e,t)=>(u(),v("div",te,[h.value?(u(),v("div",ae,[(u(),v(A,null,U(5,a=>m("div",{key:"skeleton-"+a,class:"bg-white rounded-xl shadow-md p-6"},t[0]||(t[0]=[Y('<div class="animate-pulse space-y-4"><div class="flex items-center justify-between"><div class="h-6 w-1/3 bg-gray-200 rounded"></div><div class="h-4 w-24 bg-gray-200 rounded"></div></div><div class="h-4 w-1/2 bg-gray-200 rounded"></div><div class="h-24 w-full bg-gray-200 rounded"></div></div>',1)]))),64))])):_.value?(u(),v("div",ne,[m("p",null,Q(_.value),1)])):M.value.length===0?(u(),v("div",re,t[1]||(t[1]=[m("p",null,"No projects to display.",-1)]))):(u(),v(A,{key:3},[(u(!0),v(A,null,U(M.value,a=>(u(),Z(ee,{key:a.id,project:a},null,8,["project"]))),128)),w.value?(u(),v("div",se,t[2]||(t[2]=[m("div",{class:"animate-pulse space-y-4"},[m("div",{class:"h-6 w-1/3 bg-gray-200 rounded"}),m("div",{class:"h-4 w-1/2 bg-gray-200 rounded"}),m("div",{class:"h-24 w-full bg-gray-200 rounded"})],-1)]))):B("",!0),W(m("div",{ref_key:"sentinel",ref:x,class:"h-2"},null,512),[[X,l.value<c.value]]),l.value>=c.value&&i.value.length>0?(u(),v("div",oe," End of list ")):B("",!0)],64))]))}};export{ue as default};
