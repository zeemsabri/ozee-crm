import{r as S,E as B,w as T,i as o,g as x,o as r,b as t,t as c,m as R,f as L,k as P,F as z,j as F}from"./app-Qb6DK_6t.js";import{_ as I}from"./_plugin-vue_export-helper-DlAUqK2U.js";const V={key:0,class:"fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4"},$={class:"bg-white rounded-lg shadow-xl w-full h-full max-w-6xl max-h-[90vh] flex flex-col relative"},U={class:"flex justify-between items-center p-4 border-b border-gray-200"},Y={class:"text-xl font-semibold text-gray-800 truncate pr-10"},H={class:"flex-1 overflow-hidden flex flex-col lg:flex-row"},Z={class:"flex-1 p-4 bg-gray-50 overflow-auto flex items-center justify-center"},J={key:0,class:"w-full h-full flex items-center justify-center"},G=["src","alt"],K=["src"],Q={key:2,class:"text-center text-gray-600 p-8"},W=["href"],X={key:1,class:"p-4 text-gray-700 bg-white rounded-lg shadow-md max-w-prose overflow-auto max-h-full"},ee={class:"whitespace-pre-wrap"},te={key:2,class:"text-center text-gray-600 p-8"},le={class:"lg:w-96 p-4 border-l border-gray-200 flex flex-col"},ae={class:"space-y-3 mb-4"},oe=["disabled"],re=["disabled"],ie={class:"bg-gray-100 p-3 rounded-lg flex-1 overflow-y-auto text-sm text-gray-600"},se={key:0},ne={class:"mb-2"},de={class:"text-xs text-gray-500"},ce={key:1,class:"mt-4 pt-4 border-t border-gray-200"},ue={class:"font-semibold text-blue-700"},be={class:"text-xs text-gray-500 mt-1"},ve={key:0,class:"ml-2 text-gray-400"},fe={key:2,class:"text-center text-gray-500"},me={__name:"DeliverableViewerModal",props:{isOpen:{type:Boolean,required:!0},deliverable:{type:Object,default:null},initialAuthToken:{type:String,required:!0},projectId:{type:[String,Number],required:!0}},emits:["update:isOpen","deliverable-action-success","comment-added"],setup(e,{emit:N}){const i=e,f=N,n=S(""),m=S(null),{showModal:u}=B("modalService");T(()=>i.deliverable,a=>{var l;a&&(n.value=((l=a.client_interaction)==null?void 0:l.feedback_text)||"",i.isOpen&&h())},{immediate:!1}),T(()=>i.isOpen,a=>{a&&i.deliverable&&h()});const g=()=>{f("update:isOpen",!1),n.value="",m.value=null},y=async(a,l,b=null)=>{m.value=null;try{const s=await fetch(`/api/client-api/deliverables/${i.deliverable.id}/${a}`,{method:l,headers:{Authorization:`Bearer ${i.initialAuthToken}`,"Content-Type":"application/json",Accept:"application/json"},body:b?JSON.stringify(b):null}),v=await s.json();if(!s.ok)throw new Error(v.message||"API request failed.");return v}catch(s){throw console.error(`Error during API call to ${a}:`,s),m.value=s.message||"An unexpected error occurred.",u("Error",m.value,"alert"),s}},h=async()=>{if(i.deliverable&&(!i.deliverable.client_interaction||!i.deliverable.client_interaction.read_at))try{await y("mark-read","POST"),f("deliverable-action-success")}catch(a){console.error("Error marking deliverable as read:",a)}},D=async()=>{u("Confirm Approval","Are you sure you want to approve this deliverable? This action cannot be undone easily.","confirm",async()=>{try{await y("approve","POST",{feedback_text:n.value}),u("Success","Deliverable approved successfully!","alert"),f("deliverable-action-success"),g()}catch{}})},E=async()=>{if(!n.value.trim()){u("Feedback Required","Please provide detailed feedback for requesting revisions.","alert");return}u("Confirm Revisions","Are you sure you want to request revisions for this deliverable? Your feedback will be sent to the team.","confirm",async()=>{try{await y("request-revisions","POST",{feedback_text:n.value}),u("Success","Revision request sent successfully!","alert"),f("deliverable-action-success"),g()}catch{}})},M=(a,l)=>a?(l==="google_doc"||l==="report"||a.includes("docs.google.com")||a.includes(".pdf"))&&a.includes("docs.google.com")?a.replace(/\/edit(\?usp=[a-zA-Z0-9]+)?/,"/preview").replace(/\/view(\?usp=[a-zA-Z0-9]+)?/,"/preview"):a:null;return(a,l)=>{var b,s,v,p,w,k,_,C,A,j,q;return e.isOpen&&e.deliverable?(r(),o("div",V,[t("div",$,[t("div",U,[t("h3",Y,"Review: "+c((b=e.deliverable)==null?void 0:b.title),1),t("button",{onClick:g,class:"text-gray-500 hover:text-gray-800 text-3xl transition-colors leading-none","aria-label":"Close"},"Ã—")]),t("div",H,[t("div",Z,[e.deliverable.content_url?(r(),o("div",J,[e.deliverable.type==="social_media_post"||e.deliverable.type==="design_mockup"?(r(),o("img",{key:0,src:e.deliverable.content_url,alt:e.deliverable.title,class:"max-w-full max-h-full object-contain rounded-lg shadow-md",onerror:"this.onerror=null;this.src='https://placehold.co/600x400/CCCCCC/000000?text=Image+Not+Found';"},null,8,G)):["blog_post","report","contract_draft","proposal"].includes(e.deliverable.type)||e.deliverable.content_url.includes("docs.google.com")||e.deliverable.content_url.includes(".pdf")?(r(),o("iframe",{key:1,src:M(e.deliverable.content_url,e.deliverable.type),class:"w-full h-full border-0 rounded-lg shadow-md",allowfullscreen:"",frameborder:"0",allow:"autoplay",sandbox:"allow-forms allow-modals allow-popups allow-popups-to-escape-sandbox allow-scripts allow-same-origin"},null,8,K)):(r(),o("div",Q,[l[2]||(l[2]=t("p",{class:"text-lg mb-2"},"Unsupported content type or unable to embed:",-1)),t("a",{href:e.deliverable.content_url,target:"_blank",class:"text-blue-600 hover:underline font-semibold"},l[1]||(l[1]=[R(" Open in New Tab ",-1),t("svg",{class:"inline-block w-4 h-4 ml-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"})],-1)]),8,W)]))])):e.deliverable.content_text?(r(),o("div",X,[l[3]||(l[3]=t("h4",{class:"font-bold text-lg mb-2"},"Text Content:",-1)),t("p",ee,c(e.deliverable.content_text),1)])):(r(),o("div",te,l[4]||(l[4]=[t("p",null,"No preview available for this deliverable.",-1)])))]),t("div",le,[l[7]||(l[7]=t("h4",{class:"text-lg font-semibold mb-3 text-gray-800"},"Your Feedback:",-1)),L(t("textarea",{"onUpdate:modelValue":l[0]||(l[0]=d=>n.value=d),placeholder:"Leave your comments or reasons for revision/rejection here...",rows:"4",class:"w-full p-2 border border-gray-300 rounded-lg mb-4 focus:ring-blue-500 focus:border-blue-500 resize-y"},null,512),[[P,n.value]]),t("div",ae,[t("button",{onClick:D,class:"w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",disabled:((v=(s=e.deliverable)==null?void 0:s.client_interaction)==null?void 0:v.approved_at)||((w=(p=e.deliverable)==null?void 0:p.client_interaction)==null?void 0:w.rejected_at)||((k=e.deliverable)==null?void 0:k.status)==="approved"}," Approve ",8,oe),t("button",{onClick:E,class:"w-full bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",disabled:!n.value.trim()||((C=(_=e.deliverable)==null?void 0:_.client_interaction)==null?void 0:C.approved_at)||((j=(A=e.deliverable)==null?void 0:A.client_interaction)==null?void 0:j.rejected_at)||((q=e.deliverable)==null?void 0:q.status)==="approved"}," Request Revisions ",8,re)]),l[8]||(l[8]=t("h4",{class:"text-lg font-semibold mb-3 text-gray-800 mt-auto"},"Comments History:",-1)),t("div",ie,[e.deliverable&&e.deliverable.client_interaction&&e.deliverable.client_interaction.feedback_text?(r(),o("div",se,[l[5]||(l[5]=t("p",{class:"font-bold text-gray-800"},"Your Last Action:",-1)),t("p",ne,c(e.deliverable.client_interaction.feedback_text),1),t("p",de," ("+c(new Date(e.deliverable.client_interaction.updated_at).toLocaleString())+") ",1)])):x("",!0),e.deliverable.comments&&e.deliverable.comments.length>0?(r(),o("div",ce,[l[6]||(l[6]=t("p",{class:"font-bold text-gray-800 mb-2"},"All Comments:",-1)),(r(!0),o(z,null,F(e.deliverable.comments,d=>{var O;return r(),o("div",{key:d.id,class:"mb-3 p-2 bg-white rounded-lg shadow-sm"},[t("p",ue,c(((O=d.client)==null?void 0:O.name)||"Client"),1),t("p",null,c(d.comment_text),1),t("p",be,[R(c(new Date(d.created_at).toLocaleString())+" ",1),d.context?(r(),o("span",ve,"("+c(d.context)+")",1)):x("",!0)])])}),128))])):!e.deliverable.client_interaction||!e.deliverable.client_interaction.feedback_text?(r(),o("p",fe," No feedback or comments yet for this deliverable. ")):x("",!0)])])])])])):x("",!0)}}},ye=I(me,[["__scopeId","data-v-9475963e"]]);export{ye as default};
