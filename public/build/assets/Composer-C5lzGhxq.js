import{B as U,C as D,D as $,p as b,r as d,s as G,w as L,A as M,E as q,h as r,o as i,e as l,u as x,q as T,a as y,b as a,t as p,k as w,d as Y,g as P,f as z,F as k,i as I,v as Q,c as H}from"./app-CS1SazYH.js";import{_ as J}from"./AuthenticatedLayout-Dl7FkUAT.js";import{P as K}from"./PrimaryButton-B0Wd3v7f.js";import{_ as v,a as E}from"./TextInput-CYVSfnk6.js";import{_}from"./InputError-Bpe3i3Ii.js";import{R as O}from"./RichTextEditor-CXsiDNkR.js";import"./ApplicationLogo-Cba5TCYG.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const W={class:"py-12"},X={class:"max-w-7xl mx-auto sm:px-6 lg:px-8"},Z={class:"bg-white overflow-hidden shadow-sm sm:rounded-lg"},ee={class:"p-6 text-gray-900"},se={key:0,class:"text-red-600 mb-4"},oe={key:1,class:"text-gray-600 mb-4"},te={key:2,class:"text-red-600 mb-4"},ae={key:3,class:"text-gray-600 mb-4"},le={key:0},ie={key:1},re={key:4},ne={key:0,class:"bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4",role:"alert"},ce={class:"block sm:inline"},de={class:"mb-4"},ue=["value"],me={class:"mb-4"},pe={class:"mb-4"},ve={class:"mb-6"},_e={class:"flex items-center justify-end"},ke={__name:"Composer",setup(ge){const C=U(),{permissions:V,loading:S,error:N}=D(),{canDo:A}=$(),h=b(()=>A("compose_emails").value||!0),u=d([]),g=d(!0),n=d({}),c=d(""),m=d(""),o=G({project_id:"",client_id:"",subject:"",body:""}),j=b(()=>u.value),f=b(()=>{const s=u.value.find(e=>e.id===o.project_id);return s?s.client:null}),B=async()=>{g.value=!0,c.value="";try{const s=await window.axios.get("/api/projects-for-email");u.value=s.data}catch(s){c.value="Failed to load projects.",console.error("Error fetching initial data:",s),s.response&&(s.response.status===401||s.response.status===403)&&(c.value="You are not authorized to view this content or your session expired. Please log in.")}finally{g.value=!1}};L(()=>o.project_id,s=>{if(s){const e=u.value.find(t=>t.id===s);e&&e.client&&e.client.id&&(o.client_id=e.client.id)}else o.client_id=""});const F=async()=>{if(n.value={},c.value="",m.value="",!o.project_id){n.value.project_id=["Please select a project."];return}if(!o.client_id){c.value="Selected project does not have an associated client. Please select a different project.";return}try{const e=(await window.axios.get(`/api/clients/${o.client_id}/email`)).data.email,t={...o,status:"pending_approval",client_email:e};await window.axios.post("/api/emails",t),m.value="Email submitted for approval successfully!",o.project_id="",o.client_id="",o.subject="",o.body="",n.value={}}catch(s){s.response&&s.response.status===422?n.value=s.response.data.errors:s.response&&s.response.data.message?c.value=s.response.data.message:(c.value="Failed to submit email. An unexpected error occurred.",console.error("Error submitting email:",s))}},R=()=>{const e=new URLSearchParams(window.location.search).get("project_id");e&&(o.project_id=e)};return M(async()=>{try{console.log("Fetching global permissions...");const s=await q();console.log("Global permissions fetched:",s)}catch(s){console.error("Error fetching global permissions:",s)}B().then(()=>{R()}),console.log("All data loaded, permission status:"),console.log("- Global permissions:",V.value),console.log("- Permissions loading:",S.value),console.log("- Permissions error:",N.value),console.log("- Can compose emails:",h.value)}),(s,e)=>(i(),r(k,null,[l(x(T),{title:"Compose Email"}),l(J,null,{header:y(()=>e[3]||(e[3]=[a("h2",{class:"font-semibold text-xl text-gray-800 leading-tight"},"Compose New Email",-1)])),default:y(()=>[a("div",W,[a("div",X,[a("div",Z,[a("div",ee,[e[7]||(e[7]=a("h3",{class:"text-2xl font-bold mb-6"},"Create New Email for Client",-1)),h.value?g.value?(i(),r("div",oe,"Loading data...")):c.value?(i(),r("div",te,p(c.value),1)):j.value.length===0?(i(),r("div",ae,[e[4]||(e[4]=w(" No projects assigned to you for email composition. ")),x(C).role==="contractor"?(i(),r("span",le,"Please ensure you are assigned to a project.")):(i(),r("span",ie,"Please ensure there are projects available."))])):(i(),r("div",re,[a("form",{onSubmit:Y(F,["prevent"])},[m.value?(i(),r("div",ne,[a("span",ce,p(m.value),1)])):P("",!0),a("div",de,[l(v,{for:"project_id",value:"Select Project"}),z(a("select",{id:"project_id",class:"border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 rounded-md shadow-sm mt-1 block w-full","onUpdate:modelValue":e[0]||(e[0]=t=>o.project_id=t),required:""},[e[5]||(e[5]=a("option",{value:"",disabled:""},"Select a Project",-1)),(i(!0),r(k,null,I(j.value,t=>(i(),r("option",{key:t.id,value:t.id},p(t.name)+" (Client: "+p(t.client?t.client.name:"N/A")+") ",9,ue))),128))],512),[[Q,o.project_id]]),l(_,{message:n.value.project_id?n.value.project_id[0]:"",class:"mt-2"},null,8,["message"])]),a("div",me,[l(v,{for:"to_client_name",value:"To (Client)"}),l(E,{id:"to_client_name",type:"text",class:"mt-1 block w-full bg-gray-100",value:f.value?f.value.name:"",readonly:""},null,8,["value"]),!f.value&&o.project_id?(i(),H(_,{key:0,message:"Selected project has no client.",class:"mt-2"})):P("",!0)]),a("div",pe,[l(v,{for:"subject",value:"Subject"}),l(E,{id:"subject",type:"text",class:"mt-1 block w-full",modelValue:o.subject,"onUpdate:modelValue":e[1]||(e[1]=t=>o.subject=t),required:""},null,8,["modelValue"]),l(_,{message:n.value.subject?n.value.subject[0]:"",class:"mt-2"},null,8,["message"])]),a("div",ve,[l(v,{for:"body",value:"Email Body"}),l(O,{id:"body",modelValue:o.body,"onUpdate:modelValue":e[2]||(e[2]=t=>o.body=t),placeholder:"Compose your email here...",height:"300px"},null,8,["modelValue"]),l(_,{message:n.value.body?n.value.body[0]:"",class:"mt-2"},null,8,["message"])]),a("div",_e,[l(K,{type:"submit"},{default:y(()=>e[6]||(e[6]=[w("Submit for Approval")])),_:1,__:[6]})])],32)])):(i(),r("div",se," You do not have permission to compose emails. Please contact your administrator. "))])])])])]),_:1})],64))}};export{ke as default};
