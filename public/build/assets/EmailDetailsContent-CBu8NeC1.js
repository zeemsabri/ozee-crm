import{p as _,r as n,c as y,z as X,e as M,a as d,i as f,o as i,b as s,t as m,g as Y,d as Z,q as R,D as O}from"./app-DISKht3j.js";import ee from"./EmailAttachmentsList-BzUu_g_s.js";import te from"./TaskCreationForm-CfXAZ_t0.js";const h="/api",Re=async(o,v)=>{const l={...o,page:v};return l.type==="new"&&(l.is_read=!1),l.type==="waiting-approval"&&(l.statuses=["pending_approval","pending_approval_received"]),(await _.get(`${h}/inbox/all-emails`,{params:l})).data},se=async o=>(await _.get(`${h}/emails/${o}`)).data,Oe=async o=>(await _.post(`${h}/inbox/emails/${o}/mark-as-read`)).data,ae=async o=>(await _.get(`${h}/files`,{params:{model_type:"App\\Models\\Email",model_id:o}})).data,le=async(o,{delete_gmail:v=!1,delete_local:l=!0}={})=>(await _.delete(`${h}/emails/${o}`,{data:{delete_gmail:v,delete_local:l}})).data,oe={key:0,class:"flex items-center justify-center h-full"},ne={key:1,class:"flex items-center justify-center h-full"},ie={key:2,class:"space-y-4 p-4"},re={class:"border-b pb-4"},de={class:"text-xl font-semibold text-gray-800"},ue={class:"text-sm text-gray-600 mt-1"},ce={key:0,class:"text-sm text-gray-600 mt-1"},me={class:"text-sm text-gray-600 mt-1"},ve={class:"flex flex-col sm:flex-row justify-between items-start sm:items-center pt-4"},pe={class:"w-full sm:w-auto"},fe={key:0,class:"text-gray-500"},ge={key:1,class:"text-red-500"},ye={key:0,class:"mt-6 border-t border-gray-200 pt-6"},be={class:"prose max-w-none"},xe=["innerHTML"],_e={key:1},he={class:"bg-red-100 border-l-4 border-red-500 text-red-700 p-4",role:"alert"},we={class:"flex justify-between items-center pt-4"},ke={key:0,class:"flex space-x-2"},De={key:2,class:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"},je={class:"bg-white rounded-lg shadow-xl max-w-md w-full p-6"},Ee={class:"space-y-3 mb-4"},$e={class:"flex items-center space-x-2"},Ae={class:"flex items-center space-x-2"},Ce={key:0,class:"text-sm text-red-600 mb-3"},Te={class:"flex justify-end space-x-2"},Se=["disabled"],Be={__name:"EmailDetailsContent",props:{email:Object,canApproveEmails:Boolean},emits:["edit","reject","open-bulk-tasks","deleted"],setup(o,{emit:v}){const l=o,$=v,w=n([]),A=n(!1),k=n(null),g=n(!1),a=n(null),C=n(!1),T=n([]),S=n(!1),B=n(null),U=y(()=>{var t,e;return((t=a.value)==null?void 0:t.status)==="pending_approval"||((e=a.value)==null?void 0:e.status)==="pending_approval_received"}),z=y(()=>{var t;return((t=a.value)==null?void 0:t.type)==="sent"}),{canDo:P}=X(),V=y(()=>P("delete_emails").value),D=n(!1),j=n(!1),b=n(null),c=n({delete_gmail:!0,delete_local:!0}),H=()=>{b.value=null,c.value={delete_gmail:!0,delete_local:!0},D.value=!0},N=async()=>{var t,e,u;if((t=l.email)!=null&&t.id){j.value=!0,b.value=null;try{await le(l.email.id,{delete_gmail:c.value.delete_gmail,delete_local:c.value.delete_local}),D.value=!1,$("deleted")}catch(r){b.value=((u=(e=r==null?void 0:r.response)==null?void 0:e.data)==null?void 0:u.message)||"Failed to delete email."}finally{j.value=!1}}},q=y(()=>z.value?"Approve & Send":"Approve"),G=async()=>{if(!l.email||!l.email.id){a.value=null;return}C.value=!0,a.value=null;try{const t=await se(l.email.id);a.value=t,a.value&&a.value.id&&L()}catch(t){console.error("Failed to fetch email details:",t),a.value=null}finally{C.value=!1}},L=async()=>{if(!a.value||!a.value.id){w.value=[];return}A.value=!0,k.value=null;try{const t=await ae(a.value.id);w.value=t}catch(t){console.error("Failed to fetch attachments:",t),k.value="Failed to load attachments."}finally{A.value=!1}},I=async t=>{if(!t){T.value=[];return}S.value=!0,B.value=null;try{const{data:e}=await axios.get(`/api/projects/${t}/sections/users`,{params:{type:"users"}}),u=Array.isArray(e==null?void 0:e.users)?e.users:Array.isArray(e)?e:(e==null?void 0:e.project_users)||[];T.value=u.map(r=>({id:r.id,name:r.name}))}catch(e){B.value="Failed to load users",console.error(e)}finally{S.value=!1}},J=y(()=>{var r;if(!a.value||!a.value.body_html)return((r=a.value)==null?void 0:r.body)||"";let t=a.value.body_html;const e=/src="cid:(.*?)"/g;return t=t.replace(e,(F,E)=>{const x=w.value.find(p=>p.cid===E);return x?`src="${x.path_url}"`:'src=""'}),new DOMParser().parseFromString(t,"text/html").body.innerHTML}),K=y(()=>{var t;if(!l.email||!((t=l.email.sender)!=null&&t.name))return"Unknown";if(l.email.type==="sent")return l.email.recipient_email}),Q=()=>{g.value=!1},W=()=>{var t,e,u;g.value=!g.value,g.value&&((u=(e=(t=a.value)==null?void 0:t.conversation)==null?void 0:e.project)!=null&&u.id)&&I(a.value.conversation.project.id)};return M(()=>l.email,t=>{t&&(G(),g.value=!1)},{immediate:!0}),M(a,t=>{t&&t.id&&L()}),(t,e)=>{var u,r,F,E,x;return o.email?C.value?(i(),d("div",ne,e[6]||(e[6]=[s("div",{class:"animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500"},null,-1)]))):a.value?(i(),d("div",ie,[s("div",re,[s("h2",de,m(a.value.subject),1),s("div",ue," From: "+m(((r=(u=l.email)==null?void 0:u.sender)==null?void 0:r.name)||"Unknown"),1),l.email.type==="sent"?(i(),d("div",ce," To: "+m(K.value),1)):f("",!0),s("div",me," Date: "+m(new Date((F=l.email)==null?void 0:F.created_at).toLocaleString()),1)]),s("div",ve,[s("div",pe,[A.value?(i(),d("div",fe,"Loading attachments...")):k.value?(i(),d("div",ge,m(k.value),1)):(i(),Y(ee,{key:2,attachments:w.value},null,8,["attachments"]))]),s("div",{class:"mt-4 sm:mt-0"},[s("button",{onClick:W,class:"inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"}," Create Tasks ")])]),e[13]||(e[13]=s("hr",{class:"my-4"},null,-1)),g.value?(i(),d("div",ye,[e[7]||(e[7]=s("h3",{class:"text-lg font-medium text-gray-900 mb-4"},"Create Tasks",-1)),Z(te,{"email-id":a.value.id,"project-id":(x=(E=a.value.conversation)==null?void 0:E.project)==null?void 0:x.id,users:T.value,"users-loading":S.value,"users-error":B.value,onTasksSubmitted:Q},null,8,["email-id","project-id","users","users-loading","users-error"])])):f("",!0),s("div",be,[s("div",{innerHTML:J.value},null,8,xe)]),a.value.rejection_reason?(i(),d("div",_e,[s("div",he,[e[8]||(e[8]=s("p",{class:"font-bold"},"Rejection Reason",-1)),s("p",null,m(a.value.rejection_reason),1)])])):f("",!0),s("div",we,[s("div",null,[V.value?(i(),d("button",{key:0,onClick:H,class:"inline-flex items-center px-3 py-2 border border-transparent rounded-md shadow-sm text-xs sm:text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"}," Delete ")):f("",!0)]),U.value&&o.canApproveEmails?(i(),d("div",ke,[s("button",{onClick:e[0]||(e[0]=p=>t.$emit("edit",l.email)),class:"inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"},m(q.value),1),s("button",{onClick:e[1]||(e[1]=p=>t.$emit("reject",l.email)),class:"inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"}," Reject ")])):f("",!0)]),D.value?(i(),d("div",De,[s("div",je,[e[11]||(e[11]=s("h3",{class:"text-lg font-semibold text-gray-900 mb-2"},"Delete Email",-1)),e[12]||(e[12]=s("p",{class:"text-sm text-gray-600 mb-4"},"Choose what to delete:",-1)),s("div",Ee,[s("label",$e,[R(s("input",{type:"checkbox","onUpdate:modelValue":e[2]||(e[2]=p=>c.value.delete_local=p)},null,512),[[O,c.value.delete_local]]),e[9]||(e[9]=s("span",{class:"text-sm text-gray-700"},"Delete local copy",-1))]),s("label",Ae,[R(s("input",{type:"checkbox","onUpdate:modelValue":e[3]||(e[3]=p=>c.value.delete_gmail=p)},null,512),[[O,c.value.delete_gmail]]),e[10]||(e[10]=s("span",{class:"text-sm text-gray-700"},"Delete Gmail copy",-1))])]),b.value?(i(),d("div",Ce,m(b.value),1)):f("",!0),s("div",Te,[s("button",{onClick:e[4]||(e[4]=p=>D.value=!1),class:"px-3 py-2 rounded-md text-sm border border-gray-300 text-gray-700 bg-white hover:bg-gray-50"},"Cancel"),s("button",{disabled:j.value||!c.value.delete_local&&!c.value.delete_gmail,onClick:N,class:"px-3 py-2 rounded-md text-sm text-white bg-red-600 hover:bg-red-700 disabled:opacity-50"},m(j.value?"Deleting...":"Confirm Delete"),9,Se)])])])):f("",!0)])):f("",!0):(i(),d("div",oe,e[5]||(e[5]=[s("p",{class:"text-gray-500"},"Select an email to view its details.",-1)])))}}},Ue=Object.freeze(Object.defineProperty({__proto__:null,default:Be},Symbol.toStringTag,{value:"Module"}));export{Ue as E,Be as _,Re as f,Oe as m};
