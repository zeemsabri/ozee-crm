import{r as x,z as ze,s as J,w as ce,i as r,o as l,g as v,t as k,b as a,e as d,f as ve,v as De,F as te,j as se,n as ee,m as Y,L as Qe,a as oe,B as Ne,E as et,M as tt,V as st,J as We,h as m,c as ke,q as at,x as Re,H as ot,Y as nt,Z as lt,$ as Le,k as Fe,d as rt}from"./app-C2zORGKA.js";import{P as ge}from"./PrimaryButton-Dgl94Es9.js";import{_ as R,a as F}from"./InputError-Br8DFn3G.js";import{_ as ne}from"./TextInput-D1Zqx-wu.js";import{_ as it}from"./Checkbox-BpqlOfY1.js";import{a as Ue}from"./SecondaryButton-D-sb8oLe.js";import{e as Ce,s as Ae}from"./AuthenticatedLayout-DTQRz_Bh.js";const dt={key:0,class:"text-red-600 text-sm mb-4"},ut={key:1,class:"text-gray-500 text-sm mb-4"},ct={key:2},mt={class:"mb-4"},vt={class:"mb-4"},pt=["disabled"],yt=["value"],ft={class:"mb-4"},gt={class:"mt-2"},bt={class:"flex items-center mb-2"},_t=["for"],ht={key:0,class:"pl-6"},wt={class:"grid grid-cols-2 gap-4 mb-2"},kt=["id","onUpdate:modelValue","disabled"],xt={class:"mb-2"},jt={key:0},$t={class:"flex justify-between items-center mb-1"},Pt=["onClick"],St={class:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2"},Vt={class:"flex"},Ct=["onClick"],It={key:0},Ut={class:"mt-4"},At={key:1,class:"mt-2 flex items-center"},Dt={key:0,class:"mt-6 flex justify-end"},Rt={__name:"ServicesAndPaymentForm",props:{projectId:{type:[Number,String],required:!0},paymentTypeOptions:{type:Array,required:!0},canManageProjectServicesAndPayments:{type:Boolean,required:!0},canViewProjectServicesAndPayments:{type:Boolean,required:!0}},emits:["updated"],setup(g,{emit:ie}){const p=g,G=ie,b=x({}),S=x(!1),M=x([...[{value:"Website Designing",label:"Website Designing"},{value:"SEO",label:"SEO"},{value:"Social Media",label:"Social Media"},{value:"Content Writing",label:"Content Writing"},{value:"Graphic Design",label:"Graphic Design"}]]),f=x(""),O=x(!1),_=ze({services:[],service_details:[],total_amount:"",payment_type:"one_off"}),U=J(()=>{const u=_.services.filter(s=>{const o=N(s);return o&&o.frequency!=="monthly"});return u.length===0?!0:u.every(s=>$(s)===100)}),w=J(()=>!p.projectId||!p.canManageProjectServicesAndPayments||!U.value),L=()=>{const u=f.value.trim();u&&!M.value.some(s=>s.label.toLowerCase()===u.toLowerCase())&&(M.value.push({value:u,label:u}),f.value="",O.value=!1)},Z=async()=>{if(p.projectId){S.value=!0;try{const s=(await window.axios.get(`/api/projects/${p.projectId}/sections/services-payment`)).data;return _.services=s.services||[],_.service_details=s.service_details||[],_.total_amount=s.total_amount||"",_.payment_type=s.payment_type||"one_off",_.services.forEach(o=>{M.value.some(h=>h.value===o)||M.value.push({value:o,label:o})}),_.service_details.forEach(o=>{if(o.payment_breakdown&&!Array.isArray(o.payment_breakdown)){const h=o.payment_breakdown;o.payment_breakdown=[{label:"First",percentage:parseInt(h.first)||30},{label:"Second",percentage:parseInt(h.second)||30},{label:"Third",percentage:parseInt(h.third)||40}]}else(!o.payment_breakdown||o.payment_breakdown.length===0)&&(o.payment_breakdown=[{label:"Payment 1",percentage:100}])}),s}catch(u){return console.error("Error fetching services and payment data:",u),b.value.general="Failed to fetch services and payment data.",null}finally{S.value=!1}}},H=async()=>{b.value={},S.value=!0;try{const u={services:_.services,service_details:_.service_details,total_amount:_.total_amount,payment_type:_.payment_type},s=await window.axios.put(`/api/projects/${p.projectId}/sections/services-payment`,u);alert("Services and payment information updated successfully!"),G("updated")}catch(u){u.response&&u.response.status===422?b.value=u.response.data.errors:u.response&&u.response.data.message?b.value.general=u.response.data.message:(b.value.general="Failed to update services and payment information.",console.error("Error:",u))}finally{S.value=!1}},W=(u,s)=>{s?_.service_details.some(o=>o.service_id===u)||_.service_details.push({service_id:u,amount:"",frequency:"one_off",start_date:"",payment_breakdown:[{label:"Payment 1",percentage:100}]}):_.service_details=_.service_details.filter(o=>o.service_id!==u)},N=u=>{let s=_.service_details.find(o=>o.service_id===u);if(!s)s={service_id:u,amount:"",frequency:"one_off",start_date:"",payment_breakdown:[{label:"Payment 1",percentage:100}]},_.service_details.push(s);else if(s.payment_breakdown&&!Array.isArray(s.payment_breakdown)){const o=s.payment_breakdown;s.payment_breakdown=[{label:"First",percentage:parseInt(o.first)||30},{label:"Second",percentage:parseInt(o.second)||30},{label:"Third",percentage:parseInt(o.third)||40}]}else(!s.payment_breakdown||s.payment_breakdown.length===0)&&(s.payment_breakdown=[{label:"Payment 1",percentage:100}]);return s},$=u=>{const s=N(u);return!s.payment_breakdown||!Array.isArray(s.payment_breakdown)?0:s.payment_breakdown.reduce((o,h)=>o+(parseInt(h.percentage)||0),0)},X=u=>{const s=N(u);if(s.payment_breakdown||(s.payment_breakdown=[]),!Array.isArray(s.payment_breakdown)){const V=s.payment_breakdown;s.payment_breakdown=[{label:"First",percentage:parseInt(V.first)||30},{label:"Second",percentage:parseInt(V.second)||30},{label:"Third",percentage:parseInt(V.third)||40}]}const o=s.payment_breakdown.length;let h=0;if(o>0){const V=s.payment_breakdown[o-1];h=Math.floor(V.percentage/2),V.percentage-=h}else h=100;s.payment_breakdown.push({label:`Payment ${o+1}`,percentage:h})},j=(u,s)=>{const o=N(u);if(!o.payment_breakdown||!Array.isArray(o.payment_breakdown)||o.payment_breakdown.length<=1)return;const h=parseInt(o.payment_breakdown[s].percentage)||0;if(o.payment_breakdown.splice(s,1),h>0&&o.payment_breakdown.length>0){const V=s>0&&s<=o.payment_breakdown.length?s-1:0;o.payment_breakdown[V].percentage=(parseInt(o.payment_breakdown[V].percentage)||0)+h}o.payment_breakdown.forEach((V,le)=>{V.label=`Payment ${le+1}`})};return ce(()=>p.projectId,u=>{u&&Z()},{immediate:!0}),(u,s)=>(l(),r("div",null,[b.value.general?(l(),r("div",dt,k(b.value.general),1)):v("",!0),S.value?(l(),r("div",ut,"Loading...")):(l(),r("div",ct,[a("div",mt,[d(R,{for:"total_amount",value:"Total Amount"}),d(ne,{id:"total_amount",type:"number",step:"0.01",class:"mt-1 block w-full",modelValue:_.total_amount,"onUpdate:modelValue":s[0]||(s[0]=o=>_.total_amount=o),disabled:!g.canManageProjectServicesAndPayments},null,8,["modelValue","disabled"]),d(F,{message:b.value.total_amount?b.value.total_amount[0]:"",class:"mt-2"},null,8,["message"])]),a("div",vt,[d(R,{for:"payment_type",value:"Payment Type"}),ve(a("select",{id:"payment_type",class:"border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 rounded-md shadow-sm mt-1 block w-full","onUpdate:modelValue":s[1]||(s[1]=o=>_.payment_type=o),required:"",disabled:!g.canManageProjectServicesAndPayments},[(l(!0),r(te,null,se(g.paymentTypeOptions,o=>(l(),r("option",{key:o.value,value:o.value},k(o.label),9,yt))),128))],8,pt),[[De,_.payment_type]]),d(F,{message:b.value.payment_type?b.value.payment_type[0]:"",class:"mt-2"},null,8,["message"])]),a("div",ft,[d(R,{for:"services",value:"Services"}),a("div",gt,[(l(!0),r(te,null,se(M.value,o=>(l(),r("div",{key:o.value,class:"border p-3 mb-3 rounded"},[a("div",bt,[d(it,{id:`service_${o.value}`,value:o.value,checked:_.services,"onUpdate:checked":[s[2]||(s[2]=h=>_.services=h),h=>W(o.value,h)],disabled:!g.canManageProjectServicesAndPayments},null,8,["id","value","checked","onUpdate:checked","disabled"]),a("label",{for:`service_${o.value}`,class:"ms-2 text-sm font-medium text-gray-700"},k(o.label),9,_t)]),(_.services||[]).includes(o.value)?(l(),r("div",ht,[a("div",wt,[a("div",null,[d(R,{for:`service_amount_${o.value}`,value:"Amount",class:"text-xs"},null,8,["for"]),d(ne,{id:`service_amount_${o.value}`,type:"number",step:"0.01",placeholder:"Amount",class:"w-full",modelValue:N(o.value).amount,"onUpdate:modelValue":h=>N(o.value).amount=h,disabled:!g.canManageProjectServicesAndPayments},null,8,["id","modelValue","onUpdate:modelValue","disabled"])]),a("div",null,[d(R,{for:`service_frequency_${o.value}`,value:"Frequency",class:"text-xs"},null,8,["for"]),ve(a("select",{id:`service_frequency_${o.value}`,class:"border-gray-300 rounded-md w-full","onUpdate:modelValue":h=>N(o.value).frequency=h,disabled:!g.canManageProjectServicesAndPayments},s[6]||(s[6]=[a("option",{value:"monthly"},"Monthly",-1),a("option",{value:"one_off"},"One off",-1)]),8,kt),[[De,N(o.value).frequency]])])]),a("div",xt,[d(R,{for:`service_start_date_${o.value}`,value:"Start Date",class:"text-xs"},null,8,["for"]),d(ne,{id:`service_start_date_${o.value}`,type:"date",class:"w-full",modelValue:N(o.value).start_date,"onUpdate:modelValue":h=>N(o.value).start_date=h,disabled:!g.canManageProjectServicesAndPayments},null,8,["id","modelValue","onUpdate:modelValue","disabled"])]),N(o.value).frequency!=="monthly"?(l(),r("div",jt,[a("div",$t,[d(R,{value:"Payment Breakdown (%)",class:"text-xs"}),g.canManageProjectServicesAndPayments?(l(),r("button",{key:0,type:"button",class:"text-xs text-blue-600 hover:text-blue-800",onClick:h=>X(o.value)}," + Add Payment ",8,Pt)):v("",!0)]),a("div",St,[(l(!0),r(te,null,se(N(o.value).payment_breakdown,(h,V)=>(l(),r("div",{key:V,class:"relative"},[d(R,{for:`service_payment_${V}_${o.value}`,value:h.label,class:"text-xs"},null,8,["for","value"]),a("div",Vt,[d(ne,{id:`service_payment_${V}_${o.value}`,type:"text",inputmode:"numeric",pattern:"[0-9]*",min:"0",max:"100",class:"w-full",modelValue:h.percentage,"onUpdate:modelValue":le=>h.percentage=le,modelModifiers:{number:!0},onInput:le=>{h.percentage=Math.max(0,Math.min(100,parseInt(le.target.value)||0))},disabled:!g.canManageProjectServicesAndPayments},null,8,["id","modelValue","onUpdate:modelValue","onInput","disabled"]),g.canManageProjectServicesAndPayments&&N(o.value).payment_breakdown.length>1?(l(),r("button",{key:0,type:"button",class:"ml-1 text-red-500 hover:text-red-700",onClick:le=>j(o.value,V)},s[7]||(s[7]=[a("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor"},[a("path",{"fill-rule":"evenodd",d:"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z","clip-rule":"evenodd"})],-1)]),8,Ct)):v("",!0)])]))),128))]),a("div",{class:ee(["text-xs mt-2",{"text-gray-500":$(o.value)===100,"text-red-500 font-bold":$(o.value)!==100}])},[Y(" Total: "+k($(o.value))+"% ",1),$(o.value)!==100?(l(),r("span",It," (Total must be 100%) ")):v("",!0)],2)])):v("",!0)])):v("",!0)]))),128))]),a("div",Ut,[g.canManageProjectServicesAndPayments&&!O.value?(l(),r("button",{key:0,type:"button",class:"text-sm text-blue-600 hover:text-blue-800",onClick:s[3]||(s[3]=o=>O.value=!0)}," + Add New Service/Department ")):v("",!0),g.canManageProjectServicesAndPayments&&O.value?(l(),r("div",At,[d(ne,{type:"text",class:"flex-grow mr-2",modelValue:f.value,"onUpdate:modelValue":s[4]||(s[4]=o=>f.value=o),placeholder:"New service/department name",onKeyup:Qe(L,["enter"])},null,8,["modelValue"]),d(ge,{onClick:L},{default:oe(()=>s[8]||(s[8]=[Y("Add",-1)])),_:1,__:[8]}),a("button",{type:"button",class:"ml-2 text-sm text-gray-500 hover:text-gray-700",onClick:s[5]||(s[5]=o=>{O.value=!1,f.value=""})}," Cancel ")])):v("",!0)]),d(F,{message:b.value.services?b.value.services[0]:"",class:"mt-2"},null,8,["message"])]),g.canManageProjectServicesAndPayments?(l(),r("div",Dt,[d(ge,{onClick:H,disabled:w.value,class:ee({"opacity-25":w.value})},{default:oe(()=>s[9]||(s[9]=[Y(" Update Services & Payment ",-1)])),_:1,__:[9]},8,["disabled","class"])])):v("",!0)]))]))}},Nt=["disabled"],Et={class:"absolute z-50 mt-1 w-full rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5"},Ot=["onClick"],Tt={key:0,class:"block px-4 py-2 text-sm text-gray-500"},Ie={__name:"SelectDropdown",props:{modelValue:{type:[String,Number,Object],default:""},options:{type:Array,default:()=>[]},placeholder:{type:String,default:"Select an option"},valueKey:{type:String,default:"value"},labelKey:{type:String,default:"label"},disabled:{type:Boolean,default:!1},required:{type:Boolean,default:!1},maxHeight:{type:String,default:"250px"},width:{type:String,default:"full"}},emits:["update:modelValue","change"],setup(g,{emit:ie}){const p=g,G=ie,b=x(!1),S=x(null),B=U=>{S.value&&!S.value.contains(U.target)&&(b.value=!1)},M=U=>{U.key==="Escape"&&b.value&&(b.value=!1)};Ne(()=>{document.addEventListener("click",B),document.addEventListener("keydown",M)}),et(()=>{document.removeEventListener("click",B),document.removeEventListener("keydown",M)});const f=J(()=>{if(!p.modelValue)return p.placeholder;const U=p.options.find(w=>w[p.valueKey]===p.modelValue);return U?U[p.labelKey]:p.placeholder}),O=U=>{G("update:modelValue",U[p.valueKey]),G("change",U[p.valueKey]),b.value=!1},_=()=>{p.disabled||(b.value=!b.value)};return(U,w)=>(l(),r("div",{ref_key:"dropdownRef",ref:S,class:ee(["relative",{"w-full":g.width==="full"}])},[a("button",{type:"button",onClick:_,disabled:g.disabled,class:ee(["border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 rounded-md shadow-sm mt-1 block w-full text-left px-3 py-2 text-gray-700 bg-white",{"opacity-50 cursor-not-allowed":g.disabled}])},[a("span",{class:ee({"text-gray-500":!p.modelValue})},k(f.value),3),w[0]||(w[0]=a("svg",{class:"float-right h-4 w-4 mt-1",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor"},[a("path",{"fill-rule":"evenodd",d:"M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z","clip-rule":"evenodd"})],-1))],10,Nt),ve(a("div",Et,[a("div",{class:"py-1 overflow-y-auto",style:st({maxHeight:g.maxHeight})},[(l(!0),r(te,null,se(g.options,L=>(l(),r("div",{key:L[g.valueKey],onClick:Z=>O(L),class:ee(["block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer",{"bg-gray-100":L[g.valueKey]===g.modelValue}])},k(L[g.labelKey]),11,Ot))),128)),g.options.length===0?(l(),r("div",Tt," No options available ")):v("",!0)],4)],512),[[tt,b.value]])],2))}},Ft={class:"p-6 bg-white rounded-lg shadow-xl"},Mt={key:0,class:"text-red-600 text-sm mb-4"},Bt={key:1,class:"mb-6 p-4 bg-gray-50 rounded-md"},qt={class:"mb-6"},Lt={class:"mb-4"},Kt={class:"grid grid-cols-1 md:grid-cols-3 gap-4"},zt={class:"p-3 bg-blue-100 rounded-md"},Wt={class:"text-lg font-bold text-blue-800"},Gt={class:"p-3 bg-red-100 rounded-md"},Jt={class:"text-lg font-bold text-red-800"},Yt={class:"p-3 bg-green-100 rounded-md"},Ht={class:"text-lg font-bold text-green-800"},Xt={class:"grid grid-cols-1 gap-4 md:grid-cols-2"},Zt={key:0},Qt={key:1},es={class:"mt-4 flex justify-end"},ts={key:2},ss={key:0,class:"text-gray-600"},as={key:1,class:"p-4 bg-gray-50 rounded-md text-gray-600 text-center"},os={key:2,class:"space-y-4"},ns={class:"flex justify-between items-center"},ls={class:"font-medium"},rs={class:"text-sm text-gray-600"},is={key:0},ds={key:1},us={key:2},cs={class:"flex space-x-2"},ms={key:0,class:"mt-4 p-4 bg-blue-50 rounded-md border border-blue-200"},vs={class:"mb-4"},ps={class:"flex items-center"},ys=["disabled"],fs={key:0,class:"mb-4"},gs={class:"flex justify-end space-x-2"},bs={__name:"ProjectTransactions",props:{projectId:{type:[Number,String],required:!0},userProjectRole:{type:Object,default:()=>({})}},setup(g){const ie={PKR:.0034,AUD:.65,INR:.012,EUR:1.08,GBP:1.28,USD:1},p=g,{canDo:G,canManage:b}=We(()=>p.projectId),S=b("project_expenses",p.userProjectRole),B=b("project_income",p.userProjectRole),M=G("view_project_transactions",p.userProjectRole),f=x([]),O=x([]),_=x({}),U=x(""),w=x(!1),L=x(null),Z=x(""),H=x(!1),W=x({}),N=x(null),$=x({description:"",amount:"",currency:"PKR",user_id:null,hours_spent:"",type:"expense"}),X=[{value:"PKR",label:"PKR"},{value:"AUD",label:"AUD"},{value:"INR",label:"INR"},{value:"USD",label:"USD"},{value:"EUR",label:"EUR"},{value:"GBP",label:"GBP"}],j=[{value:"expense",label:"Expense"},{value:"income",label:"Income"}],u=J(()=>O.value.map(P=>({value:P.id,label:P.name||"Unknown User"}))),s=(P,i)=>isNaN(P)||P==null?"0.00":new Intl.NumberFormat("en-US",{style:"currency",currency:i,minimumFractionDigits:2,maximumFractionDigits:2}).format(P),o=(P,i,I)=>{if(!P||isNaN(P)||!i||!I)return 0;if(i===I)return Number(P);const q=ie[i.toUpperCase()],re=ie[I.toUpperCase()];if(!q||!re)return console.warn(`Invalid currency: ${i} to ${I}`),0;const de=Number(P)*q/re;return Number(de.toFixed(2))},h=async()=>{if(!(!p.projectId||!M))try{const P=await window.axios.get(`/api/projects/${p.projectId}/sections/clients-users`);O.value=P.data.users||[]}catch(P){U.value="Failed to fetch users.",console.error("Error fetching users:",P)}},V=async()=>{if(!(!p.projectId||!M)){w.value=!0;try{const P=await window.axios.get(`/api/projects/${p.projectId}/sections/transactions`);f.value=P.data.map(i=>({...i,amount:Number(i.amount)||0,amount_usd:o(Number(i.amount)||0,i.currency,"USD")}))}catch(P){U.value="Failed to fetch transactions.",console.error("Error fetching transactions:",P)}finally{w.value=!1}}},le=async()=>{var P;if(!S&&!B){Ce("You do not have permission to manage transactions.");return}if(!$.value.amount||isNaN($.value.amount)){_.value.amount=["Please enter a valid amount"];return}_.value={},U.value="",w.value=!0;try{const i={...$.value,amount:Number($.value.amount),amount_usd:o(Number($.value.amount),$.value.currency,"USD")},I=await window.axios.post(`/api/projects/${p.projectId}/transactions`,i);f.value.unshift({...I.data,amount:Number(I.data.amount)||0,amount_usd:o(Number(I.data.amount)||0,I.data.currency,"USD")}),K(),Ae("Transaction saved successfully!")}catch(i){((P=i.response)==null?void 0:P.status)===422?_.value=i.response.data.errors:(U.value="Failed to save transaction.",console.error("Error saving transaction:",i))}finally{w.value=!1}},K=()=>{$.value={description:"",amount:"",currency:"PKR",user_id:null,hours_spent:"",type:"expense"}},Ee=async P=>{if(!S&&!B){Ce("You do not have permission to delete transactions.");return}if(confirm("Are you sure you want to delete this transaction?"))try{const i=f.value[P].id;await window.axios.delete(`/api/projects/${p.projectId}/transactions/${i}`),f.value.splice(P,1),Ae("Transaction deleted successfully!")}catch(i){U.value="Failed to delete transaction.",console.error("Error deleting transaction:",i)}},me=P=>{if(!S&&!B){Ce("You do not have permission to manage transactions.");return}const i=f.value[P];L.value===i.id?(L.value=null,N.value=null):(N.value=P,L.value=i.id,Z.value=i.amount,H.value=!1,W.value={})},pe=()=>{L.value=null,N.value=null,Z.value="",H.value=!1,W.value={}},be=async()=>{var re;if(!S&&!B){Ce("You do not have permission to manage transactions.");return}const P=N.value,i=f.value[P],I=Number(Z.value),q=Number(i.amount);if(!H.value&&(!Z.value||isNaN(I)||I<=0||I>q)){W.value.amount=["Please enter a valid amount between 0 and "+s(q,i.currency)];return}W.value={},w.value=!0;try{const Q=i.id,de=H.value,_e={payment_amount:de?q:I,pay_in_full:de,transaction_currency:i.currency,transaction_type:i.type,original_description:i.description};await window.axios.patch(`/api/projects/${p.projectId}/transactions/${Q}/process-payment`,_e),await V(),Ae("Payment processed successfully!"),pe()}catch(Q){((re=Q.response)==null?void 0:re.status)===422?W.value=Q.response.data.errors:(U.value="Failed to process payment.",console.error("Error processing payment:",Q))}finally{w.value=!1}},z=x("PKR"),he=J(()=>{const P=f.value.filter(i=>i.type==="income").reduce((i,I)=>i+o(Number(I.amount)||0,I.currency,z.value),0);return s(P,z.value)}),Oe=J(()=>{const P=f.value.filter(i=>i.type==="expense").reduce((i,I)=>i+o(Number(I.amount)||0,I.currency,z.value),0);return s(P,z.value)}),xe=J(()=>{const P=f.value.filter(I=>I.type==="income").reduce((I,q)=>I+o(Number(q.amount)||0,q.currency,z.value),0),i=f.value.filter(I=>I.type==="expense").reduce((I,q)=>I+o(Number(q.amount)||0,q.currency,z.value),0);return s(P-i,z.value)});return Ne(()=>{V(),h()}),ce(()=>p.projectId,()=>{V(),h()}),(P,i)=>{var I,q,re,Q,de,_e;return l(),r("div",Ft,[i[20]||(i[20]=a("h3",{class:"text-lg font-medium text-gray-900 mb-4"},"Project Transactions",-1)),U.value?(l(),r("div",Mt,k(U.value),1)):v("",!0),m(S)||m(B)?(l(),r("div",Bt,[a("div",qt,[i[12]||(i[12]=a("h4",{class:"text-md font-medium text-gray-700 mb-2"},"Summary",-1)),a("div",Lt,[d(R,{for:"display_currency",value:"Display Currency",class:"sr-only"}),d(Ie,{id:"display_currency",modelValue:z.value,"onUpdate:modelValue":i[0]||(i[0]=C=>z.value=C),options:X,class:"w-32"},null,8,["modelValue"])]),a("div",Kt,[a("div",zt,[i[9]||(i[9]=a("p",{class:"text-sm text-gray-600"},"Total Income",-1)),a("p",Wt,k(he.value),1)]),a("div",Gt,[i[10]||(i[10]=a("p",{class:"text-sm text-gray-600"},"Total Expenses",-1)),a("p",Jt,k(Oe.value),1)]),a("div",Yt,[i[11]||(i[11]=a("p",{class:"text-sm text-gray-600"},"Balance",-1)),a("p",Ht,k(xe.value),1)])])]),i[13]||(i[13]=a("h4",{class:"text-md font-medium text-gray-700 mb-4"},"Add Transaction",-1)),a("div",Xt,[a("div",null,[d(R,{for:"description",value:"Description"}),d(ne,{id:"description",modelValue:$.value.description,"onUpdate:modelValue":i[1]||(i[1]=C=>$.value.description=C),class:"mt-1 block w-full",disabled:w.value},null,8,["modelValue","disabled"]),d(F,{message:(I=_.value.description)==null?void 0:I[0],class:"mt-2"},null,8,["message"])]),a("div",null,[d(R,{for:"amount",value:"Amount"}),d(ne,{id:"amount",type:"number",modelValue:$.value.amount,"onUpdate:modelValue":i[2]||(i[2]=C=>$.value.amount=C),class:"mt-1 block w-full",disabled:w.value},null,8,["modelValue","disabled"]),d(F,{message:(q=_.value.amount)==null?void 0:q[0],class:"mt-2"},null,8,["message"])]),a("div",null,[d(R,{for:"currency",value:"Currency"}),d(Ie,{id:"currency",modelValue:$.value.currency,"onUpdate:modelValue":i[3]||(i[3]=C=>$.value.currency=C),options:X,disabled:w.value},null,8,["modelValue","disabled"]),d(F,{message:(re=_.value.currency)==null?void 0:re[0],class:"mt-2"},null,8,["message"])]),a("div",null,[d(R,{for:"type",value:"Type"}),d(Ie,{id:"type",modelValue:$.value.type,"onUpdate:modelValue":i[4]||(i[4]=C=>$.value.type=C),options:j,disabled:w.value||!m(S)&&$.value.type==="expense"||!m(B)&&$.value.type==="income"},null,8,["modelValue","disabled"]),d(F,{message:(Q=_.value.type)==null?void 0:Q[0],class:"mt-2"},null,8,["message"])]),$.value.type==="expense"?(l(),r("div",Zt,[d(R,{for:"user_id",value:"User"}),d(Ie,{id:"user_id",modelValue:$.value.user_id,"onUpdate:modelValue":i[5]||(i[5]=C=>$.value.user_id=C),options:u.value,disabled:w.value||!O.value.length,placeholder:"Select a user"},null,8,["modelValue","options","disabled"]),$.value.type==="expense"?(l(),ke(F,{key:0,message:(de=_.value.user_id)==null?void 0:de[0],class:"mt-2"},null,8,["message"])):v("",!0)])):v("",!0),$.value.type==="expense"?(l(),r("div",Qt,[d(R,{for:"hours_spent",value:"Hours Spent (Optional)"}),d(ne,{id:"hours_spent",type:"number",modelValue:$.value.hours_spent,"onUpdate:modelValue":i[6]||(i[6]=C=>$.value.hours_spent=C),class:"mt-1 block w-full",disabled:w.value},null,8,["modelValue","disabled"]),$.value.type==="expense"?(l(),ke(F,{key:0,message:(_e=_.value.hours_spent)==null?void 0:_e[0],class:"mt-2"},null,8,["message"])):v("",!0)])):v("",!0)]),a("div",es,[d(ge,{onClick:le,disabled:w.value},{default:oe(()=>[Y(k(w.value?"Saving...":"Save Transaction"),1)]),_:1},8,["disabled"])])])):v("",!0),m(M)?(l(),r("div",ts,[i[19]||(i[19]=a("h4",{class:"text-md font-medium text-gray-700 mb-4"},"Transaction History",-1)),w.value?(l(),r("div",ss,"Loading transactions...")):f.value.length===0?(l(),r("div",as," No transactions found for this project. ")):(l(),r("div",os,[(l(!0),r(te,null,se(f.value,(C,we)=>{var A,E;return l(),r("div",{key:C.id,class:"p-4 bg-gray-50 rounded-md shadow-sm"},[a("div",ns,[a("div",null,[a("p",ls,k(C.description),1),a("p",rs,[Y(k(C.type==="income"?"Income":"Expense")+": "+k(s(C.amount,C.currency))+" ",1),z.value!==C.currency?(l(),r("span",is," ("+k(s(o(C.amount,C.currency,z.value),z.value))+") ",1)):v("",!0),C.user_id?(l(),r("span",ds," (User: "+k(((A=O.value.find(T=>T.id===C.user_id))==null?void 0:A.name)||"Unknown")+")",1)):v("",!0),C.hours_spent?(l(),r("span",us," ("+k(C.hours_spent)+" hours)",1)):v("",!0),a("span",{class:ee(["ml-2",C.is_paid?"text-green-600":"text-red-600"])},k(C.is_paid?"(Paid)":"(Unpaid)"),3)])]),a("div",cs,[!C.is_paid&&(m(S)||m(B))?(l(),ke(Ue,{key:0,onClick:T=>me(we),class:"text-green-600"},{default:oe(()=>i[14]||(i[14]=[Y(" Pay ",-1)])),_:2,__:[14]},1032,["onClick"])):v("",!0),m(S)||m(B)?(l(),ke(Ue,{key:1,onClick:T=>Ee(we),class:"text-red-600"},{default:oe(()=>i[15]||(i[15]=[Y(" Delete ",-1)])),_:2,__:[15]},1032,["onClick"])):v("",!0)])]),L.value===C.id?(l(),r("div",ms,[i[18]||(i[18]=a("h4",{class:"text-md font-medium text-gray-900 mb-4"},"Make Payment",-1)),a("div",vs,[a("label",ps,[ve(a("input",{type:"checkbox","onUpdate:modelValue":i[7]||(i[7]=T=>H.value=T),class:"mr-2 rounded text-blue-600 focus:ring-blue-500",disabled:w.value},null,8,ys),[[at,H.value]]),i[16]||(i[16]=a("span",{class:"text-sm text-gray-700"},"Pay in Full",-1))])]),H.value?v("",!0):(l(),r("div",fs,[d(R,{for:"payment_amount",value:"Payment Amount"}),d(ne,{id:"payment_amount",type:"number",modelValue:Z.value,"onUpdate:modelValue":i[8]||(i[8]=T=>Z.value=T),class:"mt-1 block w-full",disabled:w.value,placeholder:"Enter partial payment amount (Max: "+s(C.amount,C.currency)+")"},null,8,["modelValue","disabled","placeholder"]),d(F,{message:(E=W.value.amount)==null?void 0:E[0],class:"mt-2"},null,8,["message"])])),a("div",gs,[d(Ue,{onClick:pe,disabled:w.value},{default:oe(()=>i[17]||(i[17]=[Y(" Cancel ",-1)])),_:1,__:[17]},8,["disabled"]),d(ge,{onClick:be,disabled:w.value},{default:oe(()=>[Y(k(w.value?"Processing...":"Submit Payment"),1)]),_:1},8,["disabled"])])])):v("",!0)])}),128))]))])):v("",!0)])}}},_s={class:"mt-2"},hs={class:"mb-2"},ws={key:0,class:"text-gray-500 text-sm mb-2"},ks=["disabled"],xs={value:""},js=["value"],$s={class:"flex-grow"},Ps=["value","onChange","disabled"],Ss=["value"],Vs=["onClick"],Ke={__name:"MultiSelectWithRoles",props:{label:{type:String,required:!0},items:{type:Array,default:()=>[]},endpoint:{type:String,default:""},selectedItems:{type:Array,default:()=>[]},itemText:{type:String,default:"name"},itemSubtext:{type:String,default:"email"},itemValue:{type:String,default:"id"},roleOptions:{type:Array,default:()=>[]},roleType:{type:String,default:"application"},defaultRoleId:{type:Number,default:null},error:{type:String,default:""},placeholder:{type:String,default:"Select an item"},showRemoveButton:{type:Boolean,default:!0}},emits:["update:selectedItems"],setup(g,{emit:ie}){const p=g,G=ie,b=x([]),S=x([]),B=x([]),M=x([]),f=x(!1),O=async()=>{if(!(p.roleOptions.length>0))try{const u=(await Re.get(`/api/roles?type=${p.roleType}`)).data;B.value=u.map(s=>({value:s.id,label:s.name}))}catch(j){console.error("Error fetching roles:",j)}},_=J(()=>B.value.length>0?B.value:p.roleOptions),U=()=>p.defaultRoleId?p.defaultRoleId:_.value.length>0?_.value[0].value:1,w=()=>{if(console.log("initializeFromProps called with selectedItems:",p.selectedItems),!p.selectedItems||p.selectedItems.length===0){b.value=[],S.value=[],console.log("Cleared selectedIds and selectedItemsWithRoles because props.selectedItems is empty");return}const j=new Set;p.selectedItems.forEach(u=>{const s=typeof u=="object"?u.id:u;if(!j.has(s)){if(j.add(s),!b.value.includes(s))b.value.push(s),typeof u=="object"&&u.role_id?S.value.push({id:s,role_id:u.role_id}):S.value.push({id:s,role_id:U()});else if(typeof u=="object"&&u.role_id){const o=S.value.find(h=>h.id===s);o&&(o.role_id=u.role_id)}}}),console.log("After initialization, selectedIds:",b.value),console.log("After initialization, selectedItemsWithRoles:",S.value)};ce(()=>p.selectedItems,(j,u)=>{console.log("selectedItems changed:",j),JSON.stringify(j)!==JSON.stringify(u)?(console.log("selectedItems changed significantly, reinitializing"),w()):console.log("selectedItems change was not significant, skipping reinitialization")},{deep:!0,immediate:!0}),ce(S,j=>{G("update:selectedItems",j)},{deep:!0});const L=j=>{j&&!b.value.includes(j)&&(b.value.push(j),S.value.push({id:j,role_id:U()}))},Z=j=>{b.value=b.value.filter(u=>u!==j),S.value=S.value.filter(u=>u.id!==j)},H=(j,u)=>{const s=S.value.find(o=>o.id===j);s&&(s.role_id=parseInt(u))},W=j=>X.value.find(u=>u[p.itemValue]===j),N=j=>{const u=S.value.find(s=>s.id===j);return u?u.role_id:U()},$=async()=>{if(p.endpoint){f.value=!0;try{const j=await Re.get(p.endpoint);j.data&&Array.isArray(j.data)?M.value=j.data:j.data&&j.data.data&&Array.isArray(j.data.data)&&(M.value=j.data.data)}catch(j){console.error("Error fetching items from endpoint:",j)}finally{f.value=!1}}},X=J(()=>p.endpoint&&M.value.length>0?M.value:p.items);return Ne(()=>{O(),w(),p.endpoint&&$()}),(j,u)=>(l(),r("div",null,[d(R,{value:g.label},null,8,["value"]),a("div",_s,[a("div",hs,[f.value?(l(),r("div",ws,"Loading...")):v("",!0),g.showRemoveButton?(l(),r("select",{key:1,class:"border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 rounded-md shadow-sm mt-1 block w-full",onChange:u[0]||(u[0]=s=>{const o=parseInt(s.target.value);L(o),s.target.value=""}),disabled:f.value},[a("option",xs,k(g.placeholder),1),(l(!0),r(te,null,se(X.value.filter(s=>!b.value.includes(s[g.itemValue])),s=>(l(),r("option",{key:s[g.itemValue],value:s[g.itemValue]},k(s[g.itemText])+" ("+k(s[g.itemSubtext])+") ",9,js))),128))],40,ks)):v("",!0)]),(l(!0),r(te,null,se(b.value,s=>{var o,h;return l(),r("div",{key:s,class:"flex items-center mb-1 p-2 border rounded"},[a("div",$s,k((o=W(s))==null?void 0:o[g.itemText])+" ("+k((h=W(s))==null?void 0:h[g.itemSubtext])+") ",1),a("select",{class:"ms-2 border-gray-300 rounded-md",value:N(s),onChange:V=>H(s,V.target.value),disabled:!g.showRemoveButton},[(l(!0),r(te,null,se(_.value,V=>(l(),r("option",{key:V.value,value:V.value},k(V.label),9,Ss))),128))],40,Ps),g.showRemoveButton?(l(),r("button",{key:0,type:"button",class:"ml-2 text-red-600",onClick:()=>Z(s)}," Remove ",8,Vs)):v("",!0)])}),128))]),d(F,{message:g.error,class:"mt-2"},null,8,["message"])]))}},Cs={class:"p-6 w-full max-w-6xl mx-auto bg-white rounded-lg shadow-xl"},Is={class:"flex justify-between items-center mb-4"},Us={class:"text-lg font-medium text-gray-900"},As={key:0,class:"text-red-600 text-sm mb-4"},Ds={key:1,class:"mb-4"},Rs={key:0,class:"text-xs text-gray-500 mt-2 p-2 bg-gray-100 rounded"},Ns={class:"font-bold"},Es={class:"mt-1"},Os={key:0},Ts={key:1},Fs={key:2},Ms={key:0},Bs={class:"list-disc ml-4"},qs={key:0},Ls={class:"mt-1"},Ks={class:"border-b border-gray-200 mb-6"},zs={class:"flex -mb-px"},Ws={key:0},Gs={class:"mb-4"},Js={class:"mb-4"},Ys=["disabled"],Hs={class:"mb-4"},Xs={class:"mb-4"},Zs={class:"mb-4"},Qs=["disabled"],ea=["value"],ta={class:"mb-4"},sa=["disabled"],aa=["value"],oa={key:0,class:"mt-6 flex justify-end"},na={key:1},la={key:0,class:"mb-4"},ra={key:0,class:"mt-2 flex justify-end"},ia={key:1,class:"mt-2 text-green-600 text-sm"},da={key:2,class:"mt-2 text-red-600 text-sm"},ua={class:"mb-4"},ca=["disabled"],ma={key:1,class:"mb-4"},va={key:0,class:"mt-2 flex justify-end"},pa={key:1,class:"mt-2 text-green-600 text-sm"},ya={key:2,class:"mt-2 text-red-600 text-sm"},fa={key:2},ga={key:3},ba={key:4},_a={class:"mb-4"},ha={class:"mt-2"},wa={key:0,class:"mb-4"},ka={class:"mt-4"},xa={key:0,class:"text-sm text-red-500 mt-2"},ja={key:1,class:"mt-4"},$a={class:"flex-grow"},Pa=["href"],Sa=["onClick"],Va={key:5},Ca={class:"mb-4"},Ia={class:"mt-2"},Ua={key:0},Aa={class:"flex items-start mb-2"},Da=["onUpdate:modelValue","readonly"],Ra={key:1,class:"p-4 bg-gray-50 rounded-md text-gray-600 text-center"},Na={class:"mt-6 flex justify-end"},La={__name:"ProjectForm",props:{show:{type:Boolean,required:!0},project:{type:Object,default:()=>({})},statusOptions:{type:Array,required:!0},departmentOptions:{type:Array,required:!0},sourceOptions:{type:Array,required:!0},clientRoleOptions:{type:Array,default:()=>[]},userRoleOptions:{type:Array,default:()=>[]},paymentTypeOptions:{type:Array,required:!0}},emits:["close","submit"],setup(g,{emit:ie}){ot();const p=x({}),G=g;ce(()=>G.project,t=>{p.value=t||{}},{immediate:!0});const b=J(()=>{var t;return((t=p.value)==null?void 0:t.id)||null}),{permissions:S,loading:B,error:M}=nt(b),f=lt(p);J(()=>!!f.value),J(()=>{if(!f.value)return!1;const t=f.value.name,n=f.value.slug;return t==="Manager"||t==="Project Manager"||n==="manager"||n==="project-manager"});const{canDo:O,canView:_,canManage:U}=We(b),w=O("manage_projects",f),L=O("create_projects",f),Z=O("create_clients",f),H=O("upload_project_documents",f);U("project_expenses",f),U("project_income",f);const W=U("project_services_and_payments",f),N=O("add_project_notes",f),$=U("project_users",f),X=U("project_clients",f),j=U("project_basic_details",f),u=_("project_documents",f),s=_("project_services_and_payments",f),o=_("project_notes",f),h=_("project_users",f),V=_("project_clients",f),le=_("project_transactions",f),K=x("basic"),Ee=J(()=>V.value&&h.value?"Clients and Users":V.value?"Clients":h.value?"Users":"Clients and Users"),me=t=>{if(!(t==="documents"&&!e.id)&&(K.value=t,e.id))switch(T.value=!0,t){case"basic":q(e.id).finally(()=>{T.value=!1});break;case"client":V.value||X.value||h.value||$.value?re(e.id).finally(()=>{T.value=!1}):T.value=!1;break;case"services":s.value||W.value?Q(e.id).finally(()=>{T.value=!1}):T.value=!1;break;case"transactions":T.value=!1;break;case"documents":u.value?de(e.id).finally(()=>{T.value=!1}):T.value=!1;break;case"notes":o.value||N.value?_e(e.id).finally(()=>{T.value=!1}):T.value=!1;break;default:T.value=!1;break}},pe=x([]),be=x([]),z=x([]),he=x([]),Oe=async()=>{try{const n=(await Re.get("/api/roles?type=client")).data;pe.value=n.map(D=>({value:D.id,label:D.name}));const c=(await Re.get("/api/roles?type=project")).data;be.value=c.map(D=>({value:D.id,label:D.name}))}catch(t){console.error("Error fetching roles:",t)}},xe=async()=>{try{if(Z.value){const t=await window.axios.get("/api/clients");z.value=t.data.data||t.data}else if(b.value){const t=await window.axios.get(`/api/projects/${b.value}/clients`);z.value=t.data}else{const t=await window.axios.get("/api/clients");z.value=t.data.data||t.data}}catch(t){console.error("Error fetching clients:",t),E.value="Failed to load clients."}},P=async()=>{try{if(L.value){const t=await window.axios.get("/api/users");he.value=t.data}else if(b.value){const t=await window.axios.get(`/api/projects/${b.value}/users`);he.value=t.data}else{const t=await window.axios.get("/api/users");he.value=t.data}}catch(t){console.error("Error fetching users:",t),E.value="Failed to load users."}},i=J(()=>pe.value.length>0?pe.value:G.clientRoleOptions),I=J(()=>be.value.length>0?be.value:G.userRoleOptions),q=async t=>{try{const y=(await window.axios.get(`/api/projects/${t}/sections/basic`)).data;return e.name=y.name||"",e.description=y.description||"",e.website=y.website||"",e.social_media_link=y.social_media_link||"",e.preferred_keywords=y.preferred_keywords||"",e.google_chat_id=y.google_chat_id||"",e.status=y.status||"active",e.project_type=y.project_type||"",e.source=y.source||"",e.google_drive_link=y.google_drive_link||"",y}catch(n){return console.error("Error fetching basic project data:",n),E.value="Failed to fetch basic project data.",null}},re=async t=>{try{const y=(await window.axios.get(`/api/projects/${t}/sections/clients-users`)).data;return y.clients&&y.clients.length>0&&(e.client_ids=y.clients.map(c=>{var ae;let D=((ae=c.pivot)==null?void 0:ae.role_id)||(pe.value.length>0?pe.value[0].value:1);return{id:c.id,role_id:D}})),y.users&&y.users.length>0&&(e.user_ids=y.users.map(c=>{var ae;let D=((ae=c.pivot)==null?void 0:ae.role_id)||(be.value.length>0?be.value[0].value:2);return{id:c.id,role_id:D}})),y.contract_details!==void 0&&(e.contract_details=y.contract_details||""),y}catch(n){return console.error("Error fetching clients and users data:",n),E.value="Failed to fetch clients and users data.",null}},Q=async t=>{try{const y=(await window.axios.get(`/api/projects/${t}/sections/services-payment`)).data;return e.services=y.services||[],e.service_details=y.service_details||[],e.total_amount=y.total_amount||"",e.payment_type=y.payment_type||"one_off",y}catch(n){return console.error("Error fetching services and payment data:",n),E.value="Failed to fetch services and payment data.",null}},de=async t=>{try{const y=(await window.axios.get(`/api/projects/${t}/sections/documents`)).data;return e.documents=y.documents||[],y}catch(n){return console.error("Error fetching documents data:",n),E.value="Failed to fetch documents data.",null}},_e=async t=>{try{const y=(await window.axios.get(`/api/projects/${t}/sections/notes`)).data;return e.notes=y.map(c=>({content:c.content})),y}catch(n){return console.error("Error fetching notes data:",n),E.value="Failed to fetch notes data.",null}},C=async t=>{try{switch(await q(t),K.value){case"client":(V.value||X.value||h.value||$.value)&&await re(t);break;case"services":(s.value||W.value)&&await Q(t);break;case"documents":u.value&&await de(t);break;case"notes":(o.value||N.value)&&await _e(t);break}}catch(n){console.error("Error fetching project data:",n),E.value="Failed to fetch project data."}};Ne(()=>{Oe(),xe(),P(),b.value&&Le(b.value).then(t=>{}).catch(t=>{})}),ce(b,(t,n)=>{t&&t!==n&&(Le(t).then(y=>{}).catch(y=>{}),P(),xe())});const we=ie,A=x({}),E=x(""),T=x(!1),Ge=x(!1),je=x(!1),$e=x(!1),ye=x(""),Pe=x(!1),Se=x(!1),fe=x(""),e=ze({id:null,name:"",description:"",website:"",social_media_link:"",preferred_keywords:"",google_chat_id:"",logo:null,documents:[],client_ids:[],status:"active",project_type:"",services:[],service_details:[],source:"",total_amount:"",contract_details:"",google_drive_link:"",payment_type:"one_off",user_ids:[],notes:[]});ce(()=>G.show,t=>{t&&(e.client_ids||(e.client_ids=[]),e.user_ids||(e.user_ids=[]),e.id&&C(e.id))},{immediate:!0}),ce(()=>G.project,t=>{const n=e.id;e.id=t.id||null,n&&!e.id&&K.value==="documents"&&me("basic"),e.name=t.name||"",e.description=t.description||"",e.website=t.website||"",e.social_media_link=t.social_media_link||"",e.preferred_keywords=t.preferred_keywords||"",e.google_chat_id=t.google_chat_id||"",e.logo=t.logo||null,e.documents=t.documents||[],e.client_ids=[],e.status=t.status||"active",e.project_type=t.project_type||"",e.services=t.services||[],e.service_details=t.service_details||[],e.source=t.source||"",e.total_amount=t.total_amount||"",e.contract_details=t.contract_details||"",e.google_drive_link=t.google_drive_link||"",e.payment_type=t.payment_type||"one_off",e.user_ids=[],e.notes=t.notes?t.notes.map(y=>({content:y.content})):[],A.value={},E.value=""},{immediate:!0});const Je=async()=>{A.value={},E.value="";try{const t={name:e.name,description:e.description,website:e.website,social_media_link:e.social_media_link,preferred_keywords:e.preferred_keywords,google_chat_id:e.google_chat_id,status:e.status,project_type:e.project_type,source:e.source,google_drive_link:e.google_drive_link,user_ids:e.user_ids},n=e.logo;typeof n=="object"&&n!==null&&"name"in n&&delete t.logo;const y=await window.axios.post("/api/projects",t);e.id=y.data.id,typeof n=="object"&&n!==null&&"name"in n&&await qe(n,e.id),we("submit",y.data)}catch(t){Me(t,"Failed to create project.")}},Ye=async()=>{A.value={},E.value="";try{const t={name:e.name,description:e.description,website:e.website,social_media_link:e.social_media_link,preferred_keywords:e.preferred_keywords,google_chat_id:e.google_chat_id,status:e.status,project_type:e.project_type,source:e.source,google_drive_link:e.google_drive_link},n=e.logo;typeof n=="object"&&n!==null&&"name"in n&&delete t.logo;const y=await window.axios.put(`/api/projects/${e.id}/sections/basic`,t);typeof n=="object"&&n!==null&&"name"in n&&await qe(n,e.id),Ae("Basic information updated successfully!")}catch(t){Me(t,"Failed to update basic information.")}},Me=(t,n)=>{t.response&&t.response.status===422?A.value=t.response.data.errors:t.response&&t.response.data.message?E.value=t.response.data.message:(E.value=n,console.error("Error:",t))},Ve=x(!1),Te=x({});ce(e,()=>{Object.keys(Te.value).length>0&&(Ve.value=!0)},{deep:!0}),ce(()=>G.show,t=>{t&&setTimeout(()=>{Te.value=JSON.parse(JSON.stringify(e)),Ve.value=!1},100)});const Be=()=>{Ve.value?confirm("You have unsaved changes. Are you sure you want to close this form?")&&we("close"):we("close")},qe=async(t,n)=>{try{const y=new FormData;y.append("logo",t);const c=await window.axios.post(`/api/projects/${n}/logo`,y,{headers:{"Content-Type":"multipart/form-data"}});return c.data&&c.data.logo&&(e.logo=c.data.logo),c}catch(y){console.error("Error uploading logo:",y)}},He=async()=>{if(!e.id){ye.value="Please save the project first before saving clients.";return}if(!e.client_ids||e.client_ids.length===0){ye.value="Please select at least one client to save.";return}je.value=!0,$e.value=!1,ye.value="";try{const t=await window.axios.post(`/api/projects/${e.id}/attach-clients`,{client_ids:e.client_ids});$e.value=!0,setTimeout(()=>{$e.value=!1},3e3)}catch(t){t.response&&t.response.status===422?ye.value="Validation error. Please check your input.":t.response&&t.response.data.message?ye.value=t.response.data.message:(ye.value="Failed to save clients.",console.error("Error saving clients:",t))}finally{je.value=!1}},Xe=async()=>{if(!e.id){fe.value="Please save the project first before saving users.";return}if(!e.user_ids||e.user_ids.length===0){fe.value="Please select at least one user to save.";return}Pe.value=!0,Se.value=!1,fe.value="";try{const t=await window.axios.post(`/api/projects/${e.id}/attach-users`,{user_ids:e.user_ids});Se.value=!0,setTimeout(()=>{Se.value=!1},3e3)}catch(t){t.response&&t.response.status===422?fe.value="Validation error. Please check your input.":t.response&&t.response.data.message?fe.value=t.response.data.message:(fe.value="Failed to save users.",console.error("Error saving users:",t))}finally{Pe.value=!1}},Ze=async()=>{if(!e.id){E.value="Please save the project first before uploading documents.";return}if(!e.documents||!e.documents.some(t=>typeof t=="object"&&t!==null&&"name"in t&&"size"in t&&"type"in t)){E.value="Please select documents to upload.";return}try{const t=new FormData;e.documents.filter(D=>typeof D=="object"&&D!==null&&"name"in D&&"size"in D&&"type"in D).forEach((D,ae)=>{t.append(`documents[${ae}]`,D)});const y=await window.axios.post(`/api/projects/${e.id}/documents`,t,{headers:{"Content-Type":"multipart/form-data"}});e.documents=y.data.documents||[],document.getElementById("documents").value="",alert("Documents uploaded successfully!");const c=JSON.parse(JSON.stringify(e));Te.value=c,Ve.value=!1}catch(t){t.response&&t.response.status===422?A.value=t.response.data.errors:t.response&&t.response.data.message?E.value=t.response.data.message:(E.value="Failed to upload documents.",console.error("Error uploading documents:",t))}};return(t,n)=>{var y;return l(),r("div",Cs,[a("div",Is,[a("h2",Us,k(e.id?"Edit Project":"Create New Project"),1),a("button",{onClick:Be,class:"text-gray-400 hover:text-gray-500"},n[19]||(n[19]=[a("svg",{class:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)]))]),E.value?(l(),r("div",As,k(E.value),1)):v("",!0),b.value?(l(),r("div",Ds,[Ge.value?(l(),r("div",Rs,[a("div",Ns,"Project ID: "+k(b.value),1),a("div",null,k(m(f)?"Project Role: "+(((y=m(f).value)==null?void 0:y.name)||"None"):"No Project Role"),1),a("div",Es,[n[21]||(n[21]=a("div",{class:"font-semibold"},"Project Permissions:",-1)),m(B)?(l(),r("div",Os,"Loading project permissions...")):m(M)?(l(),r("div",Ts,"Error loading project permissions")):m(S)?(l(),r("div",Fs,[Y(" Count: "+k(m(S).permissions?m(S).permissions.length:0)+" ",1),m(S).permissions&&m(S).permissions.length>0?(l(),r("div",Ms,[n[20]||(n[20]=a("div",{class:"font-semibold"},"Permissions:",-1)),a("ul",Bs,[(l(!0),r(te,null,se(m(S).permissions.slice(0,5),c=>(l(),r("li",{key:c.slug},k(c.name)+" ("+k(c.source)+") ",1))),128)),m(S).permissions.length>5?(l(),r("li",qs," ... and "+k(m(S).permissions.length-5)+" more ",1)):v("",!0)])])):v("",!0)])):v("",!0)]),a("div",Ls,"Can manage projects: "+k(m(w)?"Yes":"No"),1)])):v("",!0)])):v("",!0),a("div",Ks,[a("nav",zs,[m(w)?(l(),r("button",{key:0,onClick:n[0]||(n[0]=c=>me("basic")),class:ee(["py-2 px-4 text-center border-b-2 font-medium text-sm",K.value==="basic"?"border-indigo-500 text-indigo-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"])}," Basic Information ",2)):v("",!0),m(V)||m(h)?(l(),r("button",{key:1,onClick:n[1]||(n[1]=c=>me("client")),class:ee(["py-2 px-4 text-center border-b-2 font-medium text-sm",K.value==="client"?"border-indigo-500 text-indigo-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"])},k(Ee.value),3)):v("",!0),e.id&&(m(W)||m(s))?(l(),r("button",{key:2,onClick:n[2]||(n[2]=c=>me("services")),class:ee(["py-2 px-4 text-center border-b-2 font-medium text-sm",K.value==="services"?"border-indigo-500 text-indigo-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"])}," Services & Payment ",2)):v("",!0),e.id&&m(le)?(l(),r("button",{key:3,onClick:n[3]||(n[3]=c=>me("transactions")),class:ee(["py-2 px-4 text-center border-b-2 font-medium text-sm",K.value==="transactions"?"border-indigo-500 text-indigo-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"])}," Transactions ",2)):v("",!0),e.id&&m(u)?(l(),r("button",{key:4,onClick:n[4]||(n[4]=c=>me("documents")),class:ee(["py-2 px-4 text-center border-b-2 font-medium text-sm",K.value==="documents"?"border-indigo-500 text-indigo-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"])}," Documents ",2)):v("",!0),e.id&&(m(N)||m(o))?(l(),r("button",{key:5,onClick:n[5]||(n[5]=c=>me("notes")),class:ee(["py-2 px-4 text-center border-b-2 font-medium text-sm",K.value==="notes"?"border-indigo-500 text-indigo-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"])}," Notes ",2)):v("",!0)])]),a("form",{onSubmit:n[18]||(n[18]=rt(()=>{},["prevent"]))},[K.value==="basic"?(l(),r("div",Ws,[a("div",Gs,[d(R,{for:"name",value:"Project Name"}),d(ne,{id:"name",type:"text",class:"mt-1 block w-full",modelValue:e.name,"onUpdate:modelValue":n[6]||(n[6]=c=>e.name=c),required:"",autofocus:"",disabled:!m(w)},null,8,["modelValue","disabled"]),d(F,{message:A.value.name?A.value.name[0]:"",class:"mt-2"},null,8,["message"])]),a("div",Js,[d(R,{for:"description",value:"Description"}),ve(a("textarea",{id:"description",class:"border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 rounded-md shadow-sm mt-1 block w-full","onUpdate:modelValue":n[7]||(n[7]=c=>e.description=c),disabled:!m(w)},null,8,Ys),[[Fe,e.description]]),d(F,{message:A.value.description?A.value.description[0]:"",class:"mt-2"},null,8,["message"])]),a("div",Hs,[d(R,{for:"website",value:"Website"}),d(ne,{id:"website",type:"url",class:"mt-1 block w-full",modelValue:e.website,"onUpdate:modelValue":n[8]||(n[8]=c=>e.website=c),disabled:!m(w)},null,8,["modelValue","disabled"]),d(F,{message:A.value.website?A.value.website[0]:"",class:"mt-2"},null,8,["message"])]),a("div",Xs,[d(R,{for:"preferred_keywords",value:"Client Preferred Keywords"}),d(ne,{id:"preferred_keywords",type:"text",class:"mt-1 block w-full",modelValue:e.preferred_keywords,"onUpdate:modelValue":n[9]||(n[9]=c=>e.preferred_keywords=c),disabled:!m(w)},null,8,["modelValue","disabled"]),d(F,{message:A.value.preferred_keywords?A.value.preferred_keywords[0]:"",class:"mt-2"},null,8,["message"])]),a("div",Zs,[d(R,{for:"status",value:"Status"}),ve(a("select",{id:"status",class:"border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 rounded-md shadow-sm mt-1 block w-full","onUpdate:modelValue":n[10]||(n[10]=c=>e.status=c),required:"",disabled:!m(w)},[(l(!0),r(te,null,se(g.statusOptions,c=>(l(),r("option",{key:c.value,value:c.value},k(c.label),9,ea))),128))],8,Qs),[[De,e.status]]),d(F,{message:A.value.status?A.value.status[0]:"",class:"mt-2"},null,8,["message"])]),a("div",ta,[d(R,{for:"source",value:"Source"}),ve(a("select",{id:"source",class:"border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 rounded-md shadow-sm mt-1 block w-full","onUpdate:modelValue":n[11]||(n[11]=c=>e.source=c),disabled:!m(w)},[n[22]||(n[22]=a("option",{value:"",disabled:""},"Select a Source",-1)),(l(!0),r(te,null,se(g.sourceOptions,c=>(l(),r("option",{key:c.value,value:c.value},k(c.label),9,aa))),128))],8,sa),[[De,e.source]]),d(F,{message:A.value.source?A.value.source[0]:"",class:"mt-2"},null,8,["message"])]),m(w)?(l(),r("div",oa,[e.id&&m(j)||!e.id?(l(),ke(ge,{key:0,onClick:n[12]||(n[12]=c=>e.id?Ye():Je()),disabled:!m(w)},{default:oe(()=>[Y(k(e.id?"Update Basic Information":"Create Project"),1)]),_:1},8,["disabled"])):v("",!0)])):v("",!0)])):v("",!0),K.value==="client"?(l(),r("div",na,[m(V)?(l(),r("div",la,[d(Ke,{label:"Clients",items:z.value,selectedItems:e.client_ids,"onUpdate:selectedItems":n[13]||(n[13]=c=>e.client_ids=c),roleOptions:i.value,roleType:"client",error:A.value.client_ids?A.value.client_ids[0]:"",placeholder:"Select a client to add",disabled:!m(X),readonly:!m(X)&&m(V),showRemoveButton:m(X)},null,8,["items","selectedItems","roleOptions","error","disabled","readonly","showRemoveButton"]),m(X)?(l(),r("div",ra,[d(ge,{onClick:He,disabled:je.value},{default:oe(()=>[Y(k(je.value?"Saving...":"Save Clients"),1)]),_:1},8,["disabled"])])):v("",!0),$e.value?(l(),r("div",ia," Clients saved successfully! ")):v("",!0),ye.value?(l(),r("div",da,k(ye.value),1)):v("",!0)])):v("",!0),a("div",ua,[d(R,{for:"contract_details",value:"Contract Details"}),ve(a("textarea",{id:"contract_details",class:"border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 rounded-md shadow-sm mt-1 block w-full","onUpdate:modelValue":n[14]||(n[14]=c=>e.contract_details=c),disabled:!m(w)},null,8,ca),[[Fe,e.contract_details]]),d(F,{message:A.value.contract_details?A.value.contract_details[0]:"",class:"mt-2"},null,8,["message"])]),m(h)?(l(),r("div",ma,[d(Ke,{label:"Assign Users",items:he.value,selectedItems:e.user_ids,"onUpdate:selectedItems":n[15]||(n[15]=c=>e.user_ids=c),roleOptions:I.value,roleType:"project",defaultRoleId:2,error:A.value.user_ids?A.value.user_ids[0]:"",placeholder:"Select a user to add",disabled:!m($),readonly:!m($)&&m(h),showRemoveButton:m($)},null,8,["items","selectedItems","roleOptions","error","disabled","readonly","showRemoveButton"]),m($)?(l(),r("div",va,[d(ge,{onClick:Xe,disabled:Pe.value},{default:oe(()=>[Y(k(Pe.value?"Saving...":"Save Users"),1)]),_:1},8,["disabled"])])):v("",!0),Se.value?(l(),r("div",pa," Users saved successfully! ")):v("",!0),fe.value?(l(),r("div",ya,k(fe.value),1)):v("",!0)])):v("",!0)])):v("",!0),K.value==="services"?(l(),r("div",fa,[d(Rt,{projectId:e.id,departmentOptions:g.departmentOptions,paymentTypeOptions:g.paymentTypeOptions,canManageProjectServicesAndPayments:m(W),canViewProjectServicesAndPayments:m(s),onUpdated:n[16]||(n[16]=c=>Q(e.id))},null,8,["projectId","departmentOptions","paymentTypeOptions","canManageProjectServicesAndPayments","canViewProjectServicesAndPayments"])])):v("",!0),K.value==="transactions"&&m(le)?(l(),r("div",ga,[d(bs,{projectId:e.id,userProjectRole:m(f).value},null,8,["projectId","userProjectRole"])])):v("",!0),K.value==="documents"?(l(),r("div",ba,[a("div",_a,[d(R,{value:"Project Documents"}),a("div",ha,[m(H)?(l(),r("div",wa,[d(R,{for:"documents",value:"Upload Documents"}),a("input",{type:"file",id:"documents",onChange:n[17]||(n[17]=c=>{const D=Array.from(c.target.files);if(D.length>0){const ae=Array.isArray(e.documents)?e.documents.filter(ue=>typeof ue=="object"&&"path"in ue):[];e.documents=[...ae,...D],console.log("Files selected:",D),console.log("Are files File objects?",D.some(ue=>typeof ue=="object"&&ue!==null&&"name"in ue&&"size"in ue&&"type"in ue)),console.log("Updated documents array:",e.documents)}}),class:"mt-1 block w-full",multiple:"",accept:".pdf,.doc,.docx,.jpg,.png"},null,32),n[24]||(n[24]=a("p",{class:"text-sm text-gray-500 mt-1"},"Supported formats: PDF, DOC, DOCX, JPG, PNG",-1)),d(F,{message:A.value.documents?A.value.documents[0]:"",class:"mt-2"},null,8,["message"]),a("div",ka,[d(ge,{type:"button",onClick:Ze,disabled:!e.id||!e.documents||!e.documents.some(c=>typeof c=="object"&&c!==null&&"name"in c&&"size"in c&&"type"in c)},{default:oe(()=>n[23]||(n[23]=[Y(" Upload Documents ",-1)])),_:1,__:[23]},8,["disabled"]),e.id?v("",!0):(l(),r("p",xa," Please save the project first before uploading documents. "))])])):v("",!0),e.documents&&e.documents.length>0&&typeof e.documents[0]=="object"&&"path"in e.documents[0]?(l(),r("div",ja,[n[25]||(n[25]=a("h3",{class:"font-medium text-gray-700 mb-2"},"Existing Documents",-1)),(l(!0),r(te,null,se(e.documents,(c,D)=>(l(),r("div",{key:D,class:"flex items-center mb-2 p-2 border rounded"},[a("div",$a,[a("a",{href:"/storage/"+c.path,target:"_blank",class:"text-blue-600 hover:underline"},k(c.filename),9,Pa)]),m(H).value?(l(),r("button",{key:0,type:"button",class:"ml-2 text-red-600",onClick:()=>{e.documents=e.documents.filter((ae,ue)=>ue!==D)}}," Remove ",8,Sa)):v("",!0)]))),128))])):v("",!0),n[26]||(n[26]=a("div",{class:"mt-4"},[a("p",{class:"text-sm text-gray-500"}," Documents will be uploaded to the project's Google Drive folder. ")],-1))])])])):v("",!0),K.value==="notes"?(l(),r("div",Va,[a("div",Ca,[d(R,{value:"Notes"}),a("div",Ia,[e.notes&&e.notes.length>0?(l(),r("div",Ua,[(l(!0),r(te,null,se(e.notes,(c,D)=>(l(),r("div",{key:D,class:"mb-4"},[a("div",Aa,[ve(a("textarea",{"onUpdate:modelValue":ae=>c.content=ae,readonly:!m(N),placeholder:"Note Content",class:"border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 rounded-md shadow-sm mt-1 block w-full h-32"},null,8,Da),[[Fe,c.content]])])]))),128))])):(l(),r("div",Ra," No notes found for this project. "))]),d(F,{message:A.value.notes?A.value.notes[0]:"",class:"mt-2"},null,8,["message"])])])):v("",!0),a("div",Na,[d(Ue,{onClick:Be},{default:oe(()=>n[27]||(n[27]=[Y("Close",-1)])),_:1,__:[27]})])],32)])}}};export{La as _};
