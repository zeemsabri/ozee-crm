import{p as b,r as u,c as g,D as ne,e as V,a as i,i as p,o as r,b as s,F as re,l as ie,t as m,g as de,d as ue,j as ce,v as N,z as H}from"./app-D5B69b4J.js";import me from"./EmailAttachmentsList-CumC_x8f.js";import ve from"./TaskCreationForm-CAMzUKMf.js";const x="/api",et=async(d,v)=>{const l={...d,page:v};return l.type==="new"&&(l.is_read=!1),l.type==="waiting-approval"&&(l.statuses=["pending_approval","pending_approval_received"]),(await b.get(`${x}/inbox/all-emails`,{params:l})).data},pe=async d=>(await b.get(`${x}/emails/${d}`)).data,tt=async d=>(await b.post(`${x}/inbox/emails/${d}/mark-as-read`)).data,fe=async d=>(await b.get(`${x}/files`,{params:{model_type:"App\\Models\\Email",model_id:d}})).data,ge=async(d,{delete_gmail:v=!1,delete_local:l=!0}={})=>(await b.delete(`${x}/emails/${d}`,{data:{delete_gmail:v,delete_local:l}})).data,ye=async(d,v=null)=>{const l={};v!==null&&(l.is_private=!!v);const{data:_}=await b.patch(`${x}/emails/${d}/privacy`,l);return _},be={key:0,class:"flex items-center justify-center h-full"},xe={key:1,class:"flex items-center justify-center h-full"},_e={key:2,class:"space-y-4 p-4"},he={class:"border-b pb-4"},we={key:0,class:"mb-3 flex flex-col space-y-2"},ke=["title"],je={class:"text-xl font-semibold text-gray-800"},De={class:"text-sm text-gray-600 mt-1"},$e={key:1,class:"text-sm text-gray-600 mt-1"},Ee={class:"text-sm text-gray-600 mt-1"},Ce={class:"flex flex-col sm:flex-row justify-between items-start sm:items-center pt-4"},Ae={class:"w-full sm:w-auto"},Se={key:0,class:"text-gray-500"},Te={key:1,class:"text-red-500"},Fe={key:0,class:"mt-6 border-t border-gray-200 pt-6"},Be={class:"prose max-w-none"},Le=["innerHTML"],Me={key:1},Oe={class:"bg-red-100 border-l-4 border-red-500 text-red-700 p-4",role:"alert"},Pe={class:"flex justify-between items-center pt-4"},ze={class:"flex items-center gap-2"},Re=["disabled"],Ue={key:0,class:"flex space-x-2"},Ve={key:2,class:"mt-2 text-sm text-red-600"},Ne={key:3,class:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"},He={class:"bg-white rounded-lg shadow-xl max-w-md w-full p-6"},Je={class:"space-y-3 mb-4"},Ge={class:"flex items-center space-x-2"},qe={class:"flex items-center space-x-2"},Ie={key:0,class:"text-sm text-red-600 mb-3"},Ke={class:"flex justify-end space-x-2"},Qe=["disabled"],We={__name:"EmailDetailsContent",props:{email:Object,canApproveEmails:Boolean},emits:["edit","reject","open-bulk-tasks","deleted"],setup(d,{emit:v}){const l=d,_=v,j=u([]),F=u(!1),D=u(null),y=u(!1),a=u(null),B=u(!1),L=u([]),M=u(!1),O=u(null),J=g(()=>{var t,e;return((t=a.value)==null?void 0:t.status)==="pending_approval"||((e=a.value)==null?void 0:e.status)==="pending_approval_received"}),G=g(()=>{var t;return((t=a.value)==null?void 0:t.type)==="sent"}),{canDo:P}=ne(),q=g(()=>P("delete_emails").value),I=g(()=>P("delete_emails").value),$=u(!1),E=u(null),K=async()=>{var t,e,o;if((t=l.email)!=null&&t.id){$.value=!0,E.value=null;try{const n=a.value?!a.value.is_private:null,w=await ye(l.email.id,n);a.value&&(a.value.is_private=w.is_private)}catch(n){E.value=((o=(e=n==null?void 0:n.response)==null?void 0:e.data)==null?void 0:o.message)||"Failed to update privacy."}finally{$.value=!1}}},C=u(!1),A=u(!1),h=u(null),f=u({delete_gmail:!0,delete_local:!0}),Q=()=>{h.value=null,f.value={delete_gmail:!0,delete_local:!0},C.value=!0},W=async()=>{var t,e,o;if((t=l.email)!=null&&t.id){A.value=!0,h.value=null;try{await ge(l.email.id,{delete_gmail:f.value.delete_gmail,delete_local:f.value.delete_local}),C.value=!1,_("deleted")}catch(n){h.value=((o=(e=n==null?void 0:n.response)==null?void 0:e.data)==null?void 0:o.message)||"Failed to delete email."}finally{A.value=!1}}},X=g(()=>G.value?"Approve & Send":"Approve"),Y=async()=>{if(!l.email||!l.email.id){a.value=null;return}B.value=!0,a.value=null;try{const t=await pe(l.email.id);a.value=t,a.value&&a.value.id&&z()}catch(t){console.error("Failed to fetch email details:",t),a.value=null}finally{B.value=!1}},z=async()=>{if(!a.value||!a.value.id){j.value=[];return}F.value=!0,D.value=null;try{const t=await fe(a.value.id);j.value=t}catch(t){console.error("Failed to fetch attachments:",t),D.value="Failed to load attachments."}finally{F.value=!1}},Z=async t=>{if(!t){L.value=[];return}M.value=!0,O.value=null;try{const{data:e}=await axios.get(`/api/projects/${t}/sections/users`,{params:{type:"users"}}),o=Array.isArray(e==null?void 0:e.users)?e.users:Array.isArray(e)?e:(e==null?void 0:e.project_users)||[];L.value=o.map(n=>({id:n.id,name:n.name}))}catch(e){O.value="Failed to load users",console.error(e)}finally{M.value=!1}},ee=g(()=>{var n;if(!a.value||!a.value.body_html)return((n=a.value)==null?void 0:n.body)||"";let t=a.value.body_html;const e=/src="cid:(.*?)"/g;return t=t.replace(e,(w,S)=>{const k=j.value.find(T=>T.cid===S);return k?`src="${k.path_url}"`:'src=""'}),new DOMParser().parseFromString(t,"text/html").body.innerHTML}),te=g(()=>{var t;if(!l.email||!((t=l.email.sender)!=null&&t.name))return"Unknown";if(l.email.type==="sent")return l.email.recipient_email}),se=()=>{y.value=!1},ae=()=>{var t,e,o;y.value=!y.value,y.value&&((o=(e=(t=a.value)==null?void 0:t.conversation)==null?void 0:e.project)!=null&&o.id)&&Z(a.value.conversation.project.id)};V(()=>l.email,t=>{t&&(Y(),y.value=!1)},{immediate:!0}),V(a,t=>{t&&t.id&&z()});const le=t=>{if(typeof t=="boolean")return t?"true":"false";if(t===1)return"true";if(t===0)return"false";if(t&&typeof t=="object")try{return JSON.stringify(t)}catch{return String(t)}return String(t??"")},oe=t=>{if(t==null)return"";let e=t;if(typeof e=="string")try{const o=JSON.parse(e);o&&typeof o=="object"&&(e=o)}catch{return String(e)}return e&&typeof e=="object"&&!Array.isArray(e)?Object.entries(e).map(([o,n])=>`${o}: ${le(n)}`).join(`
`):String(e)};return(t,e)=>{var o,n,w,S,k,T,R,U;return d.email?B.value?(r(),i("div",xe,e[6]||(e[6]=[s("div",{class:"animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500"},null,-1)]))):a.value?(r(),i("div",_e,[s("div",he,[Array.isArray((o=a.value)==null?void 0:o.contexts)&&a.value.contexts.length?(r(),i("div",we,[(r(!0),i(re,null,ie(a.value.contexts,c=>(r(),i("div",{key:c.id||c.summary,class:"w-full text-sm px-3 py-2 rounded-md bg-indigo-50 text-indigo-900 border border-indigo-200 leading-snug whitespace-pre-wrap break-words",title:oe(c==null?void 0:c.meta_data)},m(c.summary),9,ke))),128))])):p("",!0),s("h2",je,m(a.value.subject),1),s("div",De," From: "+m(((w=(n=l.email)==null?void 0:n.sender)==null?void 0:w.name)||"Unknown"),1),l.email.type==="sent"?(r(),i("div",$e," To: "+m(te.value),1)):p("",!0),s("div",Ee," Date: "+m(new Date((S=l.email)==null?void 0:S.created_at).toLocaleString()),1)]),s("div",Ce,[s("div",Ae,[F.value?(r(),i("div",Se,"Loading attachments...")):D.value?(r(),i("div",Te,m(D.value),1)):(r(),de(me,{key:2,attachments:j.value},null,8,["attachments"]))]),s("div",{class:"mt-4 sm:mt-0"},[s("button",{onClick:ae,class:"inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"}," Create Tasks ")])]),e[14]||(e[14]=s("hr",{class:"my-4"},null,-1)),y.value?(r(),i("div",Fe,[e[7]||(e[7]=s("h3",{class:"text-lg font-medium text-gray-900 mb-4"},"Create Tasks",-1)),ue(ve,{"email-id":a.value.id,"project-id":(T=(k=a.value.conversation)==null?void 0:k.project)==null?void 0:T.id,users:L.value,"users-loading":M.value,"users-error":O.value,onTasksSubmitted:se},null,8,["email-id","project-id","users","users-loading","users-error"])])):p("",!0),s("div",Be,[s("div",{innerHTML:ee.value},null,8,Le)]),a.value.rejection_reason?(r(),i("div",Me,[s("div",Oe,[e[8]||(e[8]=s("p",{class:"font-bold"},"Rejection Reason",-1)),s("p",null,m(a.value.rejection_reason),1)])])):p("",!0),s("div",Pe,[s("div",ze,[I.value?(r(),i("button",{key:0,onClick:K,disabled:$.value,class:ce(["inline-flex items-center px-3 py-2 border border-transparent rounded-md shadow-sm text-xs sm:text-sm font-medium text-white",(R=a.value)!=null&&R.is_private?"bg-yellow-600 hover:bg-yellow-700 focus:ring-yellow-500":"bg-gray-600 hover:bg-gray-700 focus:ring-gray-500"]),title:"Toggle privacy"},[e[9]||(e[9]=s("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-4 w-4 mr-1",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 15c1.657 0 3-1.567 3-3.5S13.657 8 12 8s-3 1.567-3 3.5 1.343 3.5 3 3.5z"}),s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"})],-1)),s("span",null,m($.value?"Saving...":(U=a.value)!=null&&U.is_private?"Private":"Public"),1)],10,Re)):p("",!0),q.value?(r(),i("button",{key:1,onClick:Q,class:"inline-flex items-center px-3 py-2 border border-transparent rounded-md shadow-sm text-xs sm:text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"}," Delete ")):p("",!0)]),J.value&&d.canApproveEmails?(r(),i("div",Ue,[s("button",{onClick:e[0]||(e[0]=c=>t.$emit("edit",l.email)),class:"inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"},m(X.value),1),s("button",{onClick:e[1]||(e[1]=c=>t.$emit("reject",l.email)),class:"inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"}," Reject ")])):p("",!0)]),E.value?(r(),i("div",Ve,m(E.value),1)):p("",!0),C.value?(r(),i("div",Ne,[s("div",He,[e[12]||(e[12]=s("h3",{class:"text-lg font-semibold text-gray-900 mb-2"},"Delete Email",-1)),e[13]||(e[13]=s("p",{class:"text-sm text-gray-600 mb-4"},"Choose what to delete:",-1)),s("div",Je,[s("label",Ge,[N(s("input",{type:"checkbox","onUpdate:modelValue":e[2]||(e[2]=c=>f.value.delete_local=c)},null,512),[[H,f.value.delete_local]]),e[10]||(e[10]=s("span",{class:"text-sm text-gray-700"},"Delete local copy",-1))]),s("label",qe,[N(s("input",{type:"checkbox","onUpdate:modelValue":e[3]||(e[3]=c=>f.value.delete_gmail=c)},null,512),[[H,f.value.delete_gmail]]),e[11]||(e[11]=s("span",{class:"text-sm text-gray-700"},"Delete Gmail copy",-1))])]),h.value?(r(),i("div",Ie,m(h.value),1)):p("",!0),s("div",Ke,[s("button",{onClick:e[4]||(e[4]=c=>C.value=!1),class:"px-3 py-2 rounded-md text-sm border border-gray-300 text-gray-700 bg-white hover:bg-gray-50"},"Cancel"),s("button",{disabled:A.value||!f.value.delete_local&&!f.value.delete_gmail,onClick:W,class:"px-3 py-2 rounded-md text-sm text-white bg-red-600 hover:bg-red-700 disabled:opacity-50"},m(A.value?"Deleting...":"Confirm Delete"),9,Qe)])])])):p("",!0)])):p("",!0):(r(),i("div",be,e[5]||(e[5]=[s("p",{class:"text-gray-500"},"Select an email to view its details.",-1)])))}}},st=Object.freeze(Object.defineProperty({__proto__:null,default:We},Symbol.toStringTag,{value:"Module"}));export{st as E,We as _,et as f,tt as m};
