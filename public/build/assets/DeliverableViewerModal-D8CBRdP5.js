import{r as g,E as Q,w as A,I as Y,s as W,i as r,g as x,o as s,b as t,t as y,m as j,f as X,k as ee,F as te,j as le}from"./app-Bgd6iDAB.js";import{_ as oe}from"./_plugin-vue_export-helper-DlAUqK2U.js";const re={key:0,class:"fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4 font-inter"},se={class:"bg-white rounded-2xl shadow-xl w-full h-full max-w-7xl max-h-[95vh] flex flex-col relative"},ae={class:"flex items-center justify-between p-5 border-b border-gray-200"},ie={class:"text-2xl font-bold text-gray-900 truncate pr-10"},ne={class:"flex-1 overflow-hidden flex flex-col lg:flex-row"},de={class:"flex-1 p-6 bg-gray-50 overflow-auto flex items-center justify-center rounded-bl-2xl lg:rounded-bl-none lg:rounded-tl-2xl"},ce={key:0,class:"w-full h-full flex items-center justify-center"},ue=["src"],be={key:1,class:"w-full h-full flex items-center justify-center"},ve=["src","alt"],me={key:2,class:"p-6 text-gray-700 bg-white rounded-lg shadow-md max-w-prose overflow-auto max-h-full"},fe={class:"whitespace-pre-wrap leading-relaxed"},pe={key:3,class:"text-center text-gray-600 p-8"},ye=["href"],he={key:4,class:"text-center text-gray-600 p-8"},ge={key:0,class:"mt-4"},xe=["href"],we={class:"lg:w-96 p-6 border-l border-gray-200 flex flex-col bg-gray-100 rounded-br-2xl lg:rounded-bl-none"},_e={class:"space-y-3 mb-6"},ke=["disabled"],Ce={key:0},Te={key:1},Ae=["disabled"],je={key:0},qe={key:1},Re=["disabled"],Se={key:0},Oe={key:1},De={key:0,class:"mb-4 p-3 bg-blue-50 rounded-lg border border-blue-200"},Me={class:"mb-1"},Ne={class:"text-xs text-gray-500"},Ie={key:1,class:"space-y-3"},Pe={class:"font-semibold text-indigo-700"},Be={class:"mt-1"},Ee={class:"text-xs text-gray-500 mt-1"},Le={key:0,class:"ml-2 text-gray-400 italic"},$e={key:2,class:"text-center text-gray-500 py-4"},ze={__name:"DeliverableViewerModal",props:{isOpen:{type:Boolean,required:!0},deliverable:{type:Object,default:null},initialAuthToken:{type:String,required:!0},projectId:{type:[String,Number],required:!0}},emits:["update:isOpen","deliverable-action-success"],setup(o,{emit:Z}){const i=o,w=Z,n=g(""),_=g(null),c=g(!1),b=g([]),k=g(null),{showModal:v}=Q("modalService");A(()=>i.deliverable,e=>{var l;e&&(n.value=((l=e.client_interaction)==null?void 0:l.feedback_text)||"",b.value=[...e.comments||[]])},{immediate:!0}),A(()=>i.isOpen,e=>{e&&i.deliverable?(U(),Y(()=>{q()})):e||(n.value="",_.value=null,c.value=!1,b.value=[])}),A(b,()=>{Y(()=>{q()})},{deep:!0});const T=()=>{w("update:isOpen",!1)},C=async(e,l,f=null)=>{_.value=null,c.value=!0;try{const a=await fetch(`/api/client-api/deliverables/${i.deliverable.id}/${e}`,{method:l,headers:{Authorization:`Bearer ${i.initialAuthToken}`,"Content-Type":"application/json",Accept:"application/json"},body:f?JSON.stringify(f):null}),p=await a.json();if(!a.ok){const d=p.errors?Object.values(p.errors).flat().join(`
`):p.message||"API request failed.";throw new Error(d)}return p}catch(a){throw console.error(`Error during API call to ${e}:`,a),_.value=a.message||"An unexpected error occurred.",v("Error",_.value,"alert"),a}finally{c.value=!1}},U=async()=>{if(i.deliverable&&(!i.deliverable.client_interaction||!i.deliverable.client_interaction.read_at))try{await C("mark-read","POST"),w("deliverable-action-success")}catch(e){console.error("Error marking deliverable as read:",e)}},G=async()=>{v("Confirm Approval","Are you sure you want to approve this deliverable? This action cannot be undone easily.","confirm",async()=>{try{await C("approve","POST",{feedback_text:n.value}),v("Success","Deliverable approved successfully!","alert"),w("deliverable-action-success",i.deliverable.id,"approve"),T()}catch{}})},J=async()=>{if(!n.value.trim()){v("Feedback Required","Please provide detailed feedback for requesting revisions.","alert");return}v("Confirm Revisions","Are you sure you want to request revisions for this deliverable? Your feedback will be sent to the team.","confirm",async()=>{try{await C("request-revisions","POST",{feedback_text:n.value}),v("Success","Revision request sent successfully!","alert"),w("deliverable-action-success"),T()}catch{}})},K=async()=>{if(!n.value.trim()){v("Comment Required","Please type a comment before submitting.","alert");return}try{const e=await C("comments","POST",{comment_text:n.value});v("Success","Comment added successfully!","alert"),b.value.push(e.comment),n.value=""}catch{}},q=()=>{k.value&&(k.value.scrollTop=k.value.scrollHeight)},m=W(()=>{if(!i.deliverable)return{type:"none"};const e=i.deliverable.content_url,l=i.deliverable.content_text,f=i.deliverable.type,a=i.deliverable.mime_type;if(l)return{type:"text",content:l};if(e){if(e.includes("drive.google.com/file/d/")){const d=e.match(/\/d\/([a-zA-Z0-9_-]+)/);if(d&&d[1]){const h=d[1];return a&&a.includes("image")?{type:"image",src:`https://drive.google.com/uc?export=view&id=${h}`}:{type:"iframe",src:`https://docs.google.com/file/d/${h}/preview`}}}else{if(e.includes("docs.google.com"))return{type:"iframe",src:e.replace(/\/edit(\?usp=[a-zA-Z0-9]+)?/,"/preview").replace(/\/view(\?usp=[a-zA-Z0-9]+)?/,"/preview")};if(e.includes(".pdf")||a&&a.includes("pdf"))return{type:"iframe",src:e};if(a&&a.includes("image"))return{type:"image",src:e};if(f==="youtube"||e.includes("youtube.com")||e.includes("youtu.be")){const d=e.match(/(?:https?:\/\/)?(?:www\.)?(?:m\.)?(?:youtube\.com|youtu\.be)\/(?:watch\?v=|embed\/|v\/|)([\w-]{11})(?:\S+)?/);if(d&&d[1])return{type:"iframe",src:`https://www.youtube.com/embed/${d[1]}`}}}return["blog_post","report","contract_draft","proposal","social_media_post","design_mockup"].includes(f)?{type:"iframe",src:e}:{type:"external_link",url:e}}return{type:"none"}}),R=e=>e?new Date(e).toLocaleString("en-US",{month:"short",day:"numeric",year:"numeric",hour:"2-digit",minute:"2-digit"}):"N/A";return(e,l)=>{var f,a,p,d,h,S,O,D,M,N,I,P,B,E,L,$,z,F,H,V;return o.isOpen&&o.deliverable?(s(),r("div",re,[t("div",se,[t("div",ae,[t("h3",ie,"Review: "+y((f=o.deliverable)==null?void 0:f.title),1),t("button",{onClick:T,class:"text-gray-500 hover:text-gray-800 text-4xl leading-none transition-colors duration-200","aria-label":"Close"},"Ã—")]),t("div",ne,[t("div",de,[m.value.type==="iframe"?(s(),r("div",ce,[t("iframe",{src:m.value.src,class:"w-full h-full border-0 rounded-lg shadow-md",allowfullscreen:"",frameborder:"0",allow:"autoplay",sandbox:"allow-forms allow-modals allow-popups allow-popups-to-escape-sandbox allow-scripts allow-same-origin"},null,8,ue)])):m.value.type==="image"?(s(),r("div",be,[t("img",{src:m.value.src,alt:o.deliverable.title,class:"max-w-full max-h-full object-contain rounded-lg shadow-md",onerror:"this.onerror=null;this.src='https://placehold.co/600x400/CCCCCC/000000?text=Image+Not+Found';"},null,8,ve)])):m.value.type==="text"?(s(),r("div",me,[l[1]||(l[1]=t("h4",{class:"font-bold text-xl mb-3 text-gray-800"},"Text Content:",-1)),t("p",fe,y(m.value.content),1)])):m.value.type==="external_link"?(s(),r("div",pe,[l[3]||(l[3]=t("p",{class:"text-lg mb-4"},"This content cannot be embedded directly. Please open it in a new tab:",-1)),t("a",{href:m.value.url,target:"_blank",class:"inline-flex items-center px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200"},l[2]||(l[2]=[j(" Open in New Tab ",-1),t("svg",{class:"inline-block w-5 h-5 ml-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"})],-1)]),8,ye)])):(s(),r("div",he,[l[5]||(l[5]=t("p",{class:"text-lg"},"No preview available for this deliverable.",-1)),(a=o.deliverable)!=null&&a.content_url?(s(),r("p",ge,[t("a",{href:o.deliverable.content_url,target:"_blank",class:"inline-flex items-center px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200"},l[4]||(l[4]=[j(" Try Opening in New Tab ",-1),t("svg",{class:"inline-block w-5 h-5 ml-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"})],-1)]),8,xe)])):x("",!0)]))]),t("div",we,[l[7]||(l[7]=t("h4",{class:"text-xl font-semibold mb-4 text-gray-900"},"Your Feedback:",-1)),X(t("textarea",{"onUpdate:modelValue":l[0]||(l[0]=u=>n.value=u),placeholder:"Leave your comments or feedback here...",rows:"5",class:"w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-indigo-500 focus:border-indigo-500 transition-colors duration-200 resize-y shadow-sm"},null,512),[[ee,n.value]]),t("div",_e,[t("button",{onClick:G,class:"w-full bg-green-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-green-700 transition-all duration-200 ease-in-out transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:scale-100",disabled:c.value||((d=(p=o.deliverable)==null?void 0:p.client_interaction)==null?void 0:d.approved_at)||((S=(h=o.deliverable)==null?void 0:h.client_interaction)==null?void 0:S.rejected_at)||((O=o.deliverable)==null?void 0:O.status)==="approved"},[c.value&&!((M=(D=o.deliverable)==null?void 0:D.client_interaction)!=null&&M.approved_at)?(s(),r("span",Ce,"Approving...")):(s(),r("span",Te,"Approve Deliverable"))],8,ke),t("button",{onClick:J,class:"w-full bg-red-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-red-700 transition-all duration-200 ease-in-out transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:scale-100",disabled:c.value||!n.value.trim()||((I=(N=o.deliverable)==null?void 0:N.client_interaction)==null?void 0:I.approved_at)||((B=(P=o.deliverable)==null?void 0:P.client_interaction)==null?void 0:B.rejected_at)||((E=o.deliverable)==null?void 0:E.status)==="approved"},[c.value&&!(($=(L=o.deliverable)==null?void 0:L.client_interaction)!=null&&$.revisions_requested_at)?(s(),r("span",je,"Requesting Revisions...")):(s(),r("span",qe,"Request Revisions"))],8,Ae),t("button",{onClick:K,class:"w-full bg-blue-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-blue-700 transition-all duration-200 ease-in-out transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:scale-100",disabled:c.value||!n.value.trim()},[c.value?(s(),r("span",Se,"Adding Comment...")):(s(),r("span",Oe,"Add General Comment"))],8,Re)]),l[8]||(l[8]=t("h4",{class:"text-xl font-semibold mb-4 text-gray-900 mt-auto pt-4 border-t border-gray-200"},"Comments History:",-1)),t("div",{ref_key:"commentsHistoryRef",ref:k,class:"bg-white p-4 rounded-lg flex-1 overflow-y-auto text-sm text-gray-700 shadow-inner"},[(F=(z=o.deliverable)==null?void 0:z.client_interaction)!=null&&F.feedback_text?(s(),r("div",De,[l[6]||(l[6]=t("p",{class:"font-bold text-blue-800 mb-1"},"Your Last Feedback:",-1)),t("p",Me,y(o.deliverable.client_interaction.feedback_text),1),t("p",Ne," ("+y(R(o.deliverable.client_interaction.updated_at))+") ",1)])):x("",!0),b.value&&b.value.length>0?(s(),r("div",Ie,[(s(!0),r(te,null,le(b.value,u=>(s(),r("div",{key:u.id,class:"p-3 bg-gray-50 rounded-lg shadow-sm border border-gray-200"},[t("p",Pe,y(u.creator_name||"Client"),1),t("p",Be,y(u.content||u.comment_text),1),t("p",Ee,[j(y(R(u.created_at))+" ",1),u.context?(s(),r("span",Le,"("+y(u.context)+")",1)):x("",!0)])]))),128))])):!((V=(H=o.deliverable)==null?void 0:H.client_interaction)!=null&&V.feedback_text)&&b.value.length===0?(s(),r("p",$e," No feedback or comments yet for this deliverable. ")):x("",!0)],512)])])])])):x("",!0)}}},Ve=oe(ze,[["__scopeId","data-v-499ee51f"]]);export{Ve as default};
