import{u as ne}from"./workflowStore-DOdgr6Xd.js";import se from"./StepCard-CRKF5M4T.js";import{S as O}from"./SelectDropdown-M3AHc6lT.js";import{_ as re}from"./RelationshipPathPicker-eTtOy2pI.js";import{T as ue}from"./trash-CCSDpdeO.js";import{P as ie}from"./plus-CRkvJOmu.js";import{l as T,q as V,o as y,w as pe,a as p,n as $,c as _,F as B,i as Q,k as L,e as j,t as X,u as Z,g as ce}from"./app-BfaUIa5i.js";/* empty css                                                                       */import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./createLucideIcon-D0ZpVBKJ.js";const me={class:"flex flex-col space-y-3 text-md p-2 bg-gray-50 rounded-md"},de={class:"flex items-center gap-2 bg-gray-100 p-1 rounded-md"},ve={class:"space-y-2"},ge={class:"flex items-start gap-2"},ye={class:"flex-1 space-y-2"},fe={class:"flex items-center gap-2"},be=["title"],_e={key:1,class:"col-span-2 mt-1 px-1"},he=["value","onInput"],xe={key:2,class:"grid grid-cols-2 gap-2"},we=["value","onChange"],Te=["value"],Se=["value","onChange"],Ce=["type","value","onInput"],$e=["onClick","disabled"],Ae={class:"mt-2 flex items-center justify-end"},Re=["onClick","disabled"],Be={__name:"ConditionStep",props:{step:{type:Object,required:!0},allStepsBefore:{type:Array,default:()=>[]},loopContextSchema:{type:Object,default:null}},emits:["update:step","delete"],setup(M,{emit:ee}){const b=M,U=ee,q=ne(),A=T(()=>q.automationSchema||[]),te=T(()=>q.morphMap||[]),R=T(()=>{var d,m;if(b.loopContextSchema&&Array.isArray(b.loopContextSchema.columns)&&b.loopContextSchema.columns.length)return b.loopContextSchema;const e=[...b.allStepsBefore].reverse().find(u=>{var o;return u.step_type==="FOR_EACH"&&((o=u.step_config)==null?void 0:o.sourceArray)});if(!e)return null;const l=e.step_config.sourceArray,t=typeof l=="string"?l.match(/{{step_(\w+)\.(.+)}}/):null;if(!t)return null;const n=t[1],a=t[2],s=b.allStepsBefore.find(u=>String(u.id)===String(n));if((s==null?void 0:s.step_type)==="AI_PROMPT"){const u=(((d=s.step_config)==null?void 0:d.responseStructure)||[]).find(o=>o.name===a);if((u==null?void 0:u.type)==="Array of Objects")return{name:"Loop Item",columns:u.schema||[]}}if((s==null?void 0:s.step_type)==="FETCH_RECORDS"&&a==="records"){const u=(m=s.step_config)==null?void 0:m.model,o=(A.value||[]).find(i=>i.name===u);if(o)return{name:"Loop Item",columns:(o.columns||[]).map(g=>typeof g=="string"?{name:g}:g)}}return null}),c=T({get:()=>{const e=b.step.step_config||{};return Array.isArray(e.rules)||(e.rules=[{}]),e.logic||(e.logic="AND"),e},set:e=>U("update:step",{...b.step,step_config:e})});function h(e,l,t){const n=[...c.value.rules],a={...n[e]};l==="field"?(a.left={type:"var",path:t},delete a.operator,delete a.right):l==="operator"?(a.operator=t,delete a.right):l==="json_path"?a.json_path=t:l==="value"&&(a.right={type:"literal",value:t}),n[e]=a,c.value={...c.value,rules:n}}function le(){const e=[...c.value.rules,{}];c.value={...c.value,rules:e}}function G(e){const l=c.value.rules.filter((t,n)=>n!==e);c.value={...c.value,rules:l}}function H(e){c.value={...c.value,logic:e}}function v(e){var l;return((l=e==null?void 0:e.left)==null?void 0:l.path)||""}function F(e){return(e==null?void 0:e.operator)||""}function D(e){var l;return((l=e==null?void 0:e.right)==null?void 0:l.value)??null}function I(e){return!e||typeof e!="string"?"":e.replace(/{{|}}/g,"")}const W=T(()=>b.allStepsBefore.find(e=>["TRIGGER","SCHEDULE_TRIGGER"].includes(e.step_type))),P=T(()=>{var t,n;const e=[];R.value&&Array.isArray(R.value.columns)&&(R.value.columns.filter(a=>!!(a!=null&&a.name)).forEach(a=>{e.push({value:`{{loop.item.${a.name}}}`,name:`{{loop.item.${a.name}}}`,label:`Loop Item: ${a.label||a.name}`,type:a.type||"Text",group:"Current Loop Item",allowed_values:a.allowed_values||null})}),e.push({value:"{{loop.index}}",name:"{{loop.index}}",label:"Loop: index",type:"Number",group:"Loop Details"}),e.push({value:"{{loop.is_first}}",name:"{{loop.is_first}}",label:"Loop: is_first",type:"True/False",group:"Loop Details"}),e.push({value:"{{loop.is_last}}",name:"{{loop.is_last}}",label:"Loop: is_last",type:"True/False",group:"Loop Details"})),e.push({value:"triggering_object_id",name:"triggering_object_id",label:"Triggering Object ID",type:"Number",group:"Workflow Context"});const l=(n=(t=W.value)==null?void 0:t.step_config)==null?void 0:n.model;if(l){const a=A.value.find(s=>s.name===l);if(a){const s=(l.split("\\").pop()||"").toLowerCase();(a.columns||[]).forEach(d=>{const m=typeof d=="string"?{name:d}:d;e.push({value:`trigger.${s}.${m.name}`,name:`trigger.${s}.${m.name}`,label:`${l}: ${m.label||m.name}`,type:m.type||"Text",group:"Trigger Data",allowed_values:m.allowed_values})})}}else W.value&&(e.push({value:"trigger.user.id",name:"trigger.user.id",label:"Triggering User ID",type:"Number",group:"Trigger Data"}),e.push({value:"trigger.email.type",name:"trigger.email.type",label:"Trigger Email Type",type:"Text",group:"Trigger Data"}),e.push({value:"trigger.email.status",name:"trigger.email.status",label:"Trigger Email Status",type:"Text",group:"Trigger Data"}));return b.allStepsBefore.forEach((a,s)=>{var d,m;if(a.step_type==="AI_PROMPT"&&((m=(d=a.step_config)==null?void 0:d.responseStructure)==null?void 0:m.length)>0){const u=i=>{const g=String((i==null?void 0:i.type)||"").toLowerCase(),f=String((i==null?void 0:i.itemType)||"").toLowerCase();return g==="array of objects"||g==="array"&&f==="object"},o=(i,g="",f=0)=>{(i||[]).forEach(r=>{if(!(r!=null&&r.name))return;const C=g?`${g}.${r.name}`:r.name,Y="  ".repeat(f);e.push({value:`step_${a.id}.${C}`,name:`step_${a.id}.${C}`,label:`Step ${s+1} (AI): ${Y}${r.name}`,type:r.type,group:`Step ${s+1}: ${a.name}`,allowed_values:r.allowed_values||null}),Array.isArray(r.schema)&&(u(r)?r.schema.forEach(x=>{x!=null&&x.name&&e.push({value:`step_${a.id}.${C}.${x.name}`,name:`step_${a.id}.${C}.${x.name}`,label:`Step ${s+1} (AI): ${Y}  - ${x.name} (from array)`,type:x.type||"Text",group:`Step ${s+1}: ${a.name}`,allowed_values:x.allowed_values||null})}):r.type==="Object"&&o(r.schema,C,f+1))})};o(a.step_config.responseStructure)}a.step_type==="FETCH_RECORDS"&&e.push({value:`step_${a.id}.count`,name:`step_${a.id}.count`,label:`Step ${s+1} (Fetch): Count`,type:"Number",group:`Step ${s+1}: ${a.name}`})}),e});function w(e){return e?P.value.find(l=>l.value===e||l.name===e)||{name:e,value:e,label:e,type:"Text"}:null}function S(e){return!e||typeof e!="string"?!1:e.startsWith("{{")}function E(e){return!e||typeof e!="string"?!1:I(e).endsWith("_type")}const z=T(()=>(te.value||[]).map(e=>({value:e.alias,label:e.label||e.alias})));function N(e){var o;if(!e||typeof e!="string")return null;const t=I(e).split(".");if(!t.length)return null;if(t[0]==="loop"){if(t[1]==="item"&&t.length>=3){const i=t.slice(2).join("."),f=(((o=R.value)==null?void 0:o.columns)||[]).map(r=>typeof r=="string"?{name:r}:r).find(r=>r.name===i);return f?{type:f.type||"Text",allowed_values:f.allowed_values||null}:{type:"Text",allowed_values:null}}return t[1]==="index"?{type:"Number",allowed_values:null}:t[1]==="is_first"||t[1]==="is_last"?{type:"True/False",allowed_values:null}:{type:"Text",allowed_values:null}}let n=0,a=t[n++],s=null;a.toLowerCase()==="trigger"?s=(t[n++]||"").toLowerCase():s=a.toLowerCase();let d=(A.value||[]).find(i=>(i.name||"").toLowerCase()===s)||null;if(!d)return null;for(;n<t.length-1;n++){const i=t[n],g=(d.relationships||[]).find(r=>r.name===i);if(!g)return null;if(g.type==="MorphTo")return{type:"Text",allowed_values:null};const f=(A.value||[]).find(r=>r.full_class===g.full_class||r.name===g.model);if(!f)return null;d=f}const m=t[t.length-1],u=(d.columns||[]).find(i=>typeof i=="string"?i===m:i.name===m);return u?typeof u=="string"?{type:"Text",allowed_values:null}:{type:u.type||"Text",allowed_values:u.allowed_values||null}:{type:"Text",allowed_values:null}}function ae(e){var n;const l=v(e);if(E(l))return[{value:"==",label:"is"},{value:"!=",label:"is not"}];if(S(l)){const s=(N(l)||{}).type||"Text";return k[s]||k.Text}const t=(n=w(l))==null?void 0:n.type;return k[t]||k.Text}const k={json:[{value:"==",label:"is"},{value:"!=",label:"is not"},{value:"contains",label:"contains"},{value:"not_empty",label:"is not empty"},{value:"empty",label:"is empty"},{value:"is_null",label:"is null"},{value:"is_not_null",label:"is not null"}],jsonb:[{value:"==",label:"is"},{value:"!=",label:"is not"},{value:"contains",label:"contains"},{value:"not_empty",label:"is not empty"},{value:"empty",label:"is empty"},{value:"is_null",label:"is null"},{value:"is_not_null",label:"is not null"}],Array:[{value:"==",label:"is"},{value:"!=",label:"is not"},{value:"contains",label:"contains"},{value:"not_empty",label:"is not empty"},{value:"empty",label:"is empty"},{value:"is_null",label:"is null"},{value:"is_not_null",label:"is not null"}],"True/False":[{value:"==",label:"is"},{value:"!=",label:"is not"}],Number:[{value:"==",label:"equals"},{value:"!=",label:"does not equal"},{value:">",label:"is greater than"},{value:"<",label:"is less than"},{value:">=",label:"is greater than or equal to"},{value:"<=",label:"is less than or equal to"}],Date:[{value:"==",label:"is on"},{value:">",label:"is after"},{value:"<",label:"is before"},{value:"in_past",label:"is in the past"},{value:"in_future",label:"is in the future"},{value:"today",label:"is today"}],DateTime:[{value:"==",label:"is on"},{value:">",label:"is after"},{value:"<",label:"is before"},{value:"in_past",label:"is in the past"},{value:"in_future",label:"is in the future"},{value:"today",label:"is today"}],Text:[{value:"==",label:"is"},{value:"!=",label:"is not"},{value:"contains",label:"contains"},{value:"not_empty",label:"is not empty"},{value:"empty",label:"is empty"}]};function J(e){const l=String(e||"").toLowerCase();return!["","empty","not_empty","in_past","in_future","today"].includes(l)}function K(e){var t;const l=v(e);if(E(l))return z.value;if(S(l)){const n=N(l);return(n==null?void 0:n.allowed_values)||null}return((t=w(l))==null?void 0:t.allowed_values)||null}function oe(e){if(S(e)){const t=N(e)||{};return t.type==="Date"?"date":t.type==="DateTime"?"datetime-local":t.type==="Number"?"number":"text"}const l=w(e);return l?l.type==="Date"?"date":l.type==="DateTime"?"datetime-local":l.type==="Number"?"number":"text":"text"}return(e,l)=>(y(),V(se,{icon:"ðŸ”€",title:"If/Else Condition",onDelete:()=>U("delete")},{default:pe(()=>[p("div",me,[p("div",de,[p("button",{onClick:l[0]||(l[0]=t=>H("AND")),class:$([[c.value.logic==="AND"?"bg-white shadow-sm text-gray-800":"bg-transparent text-gray-500 hover:bg-gray-200"],"flex-1 py-1 px-2 text-sm font-medium rounded-md transition-colors duration-150"])}," If ALL are true ",2),p("button",{onClick:l[1]||(l[1]=t=>H("OR")),class:$([[c.value.logic==="OR"?"bg-white shadow-sm text-gray-800":"bg-transparent text-gray-500 hover:bg-gray-200"],"flex-1 py-1 px-2 text-sm font-medium rounded-md transition-colors duration-150"])}," If ANY are true ",2)]),p("div",ve,[(y(!0),_(B,null,Q(c.value.rules,(t,n)=>{var a,s,d,m,u;return y(),_("div",{key:n,class:"p-2 border rounded-md bg-white"},[p("div",ge,[p("div",ye,[p("div",fe,[j(O,{"model-value":v(t),options:P.value,"group-by":"group",placeholder:"Select field...","onUpdate:modelValue":o=>h(n,"field",o),class:"w-full"},null,8,["model-value","options","onUpdate:modelValue"]),j(re,{mode:"field","all-steps-before":M.allStepsBefore,value:v(t),onSelect:o=>h(n,"field",o)},null,8,["all-steps-before","value","onSelect"])]),S(v(t))?(y(),_("p",{key:0,class:"text-[11px] text-gray-600 font-mono mt-1 px-2 py-1 bg-gray-50 rounded overflow-hidden break-words",title:v(t)}," Path: "+X(I(v(t))),9,be)):L("",!0),((a=w(v(t)))==null?void 0:a.type)==="json"||((s=w(v(t)))==null?void 0:s.type)==="jsonb"||((d=w(v(t)))==null?void 0:d.type)==="Array"?(y(),_("div",_e,[l[2]||(l[2]=p("label",{class:"block text-[10px] font-medium text-gray-500 mb-1"},"Nested JSON Path (optional)",-1)),p("input",{type:"text",value:t.json_path||"",onInput:o=>h(n,"json_path",o.target.value),placeholder:"e.g. metadata.key or address.city",class:"w-full border border-gray-300 rounded-md px-2 py-1.5 text-xs bg-gray-50"},null,40,he)])):L("",!0),v(t)?(y(),_("div",xe,[p("select",{value:F(t),onChange:o=>h(n,"operator",o.target.value),class:$(["p-2 border border-gray-300 rounded-md bg-white shadow-sm text-sm",{"col-span-2":!J(F(t))}])},[l[3]||(l[3]=p("option",{value:"",disabled:""},"Select condition...",-1)),(y(!0),_(B,null,Q(ae(t),o=>(y(),_("option",{key:o.value,value:o.value},X(o.label),9,Te))),128))],42,we),J(F(t))?(y(),_(B,{key:0},[E(v(t))?(y(),V(O,{key:0,options:z.value,"model-value":D(t),placeholder:"Select type...","onUpdate:modelValue":o=>h(n,"value",o)},null,8,["options","model-value","onUpdate:modelValue"])):K(t)?(y(),V(O,{key:1,options:(K(t)||[]).map(o=>({value:o.value,label:o.label})),"model-value":D(t),placeholder:"Select value...","onUpdate:modelValue":o=>h(n,"value",o)},null,8,["options","model-value","onUpdate:modelValue"])):(S(v(t))?((m=N(v(t)))==null?void 0:m.type)==="True/False":((u=w(v(t)))==null?void 0:u.type)==="True/False")?(y(),_("select",{key:2,value:D(t)??"true",onChange:o=>h(n,"value",o.target.value),class:"p-2 border border-gray-300 rounded-md bg-white shadow-sm text-sm"},l[4]||(l[4]=[p("option",{value:"true"},"True",-1),p("option",{value:"false"},"False",-1)]),40,Se)):(y(),_("input",{key:3,type:oe(v(t)),value:D(t)||"",onInput:o=>h(n,"value",o.target.value),placeholder:"Value...",class:"p-2 border border-gray-300 rounded-md bg-white shadow-sm text-sm"},null,40,Ce))],64)):L("",!0)])):L("",!0)]),p("button",{onClick:o=>G(n),class:$(["p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-full",{"opacity-50 cursor-not-allowed":c.value.rules.length<=1}]),title:"Remove condition","aria-label":"Remove condition",disabled:c.value.rules.length<=1},[j(Z(ue),{class:"w-4 h-4"})],10,$e)]),p("div",Ae,[p("button",{onClick:o=>G(n),class:$(["text-xs text-red-600 hover:text-red-700 hover:underline",{"opacity-50 cursor-not-allowed":c.value.rules.length<=1}]),disabled:c.value.rules.length<=1}," Remove this condition ",10,Re)])])}),128))]),p("div",null,[p("button",{onClick:le,class:"w-full flex items-center justify-center gap-1 px-2 py-1.5 text-xs rounded-md bg-gray-100 hover:bg-gray-200 text-gray-600"},[j(Z(ie),{class:"h-3 w-3"}),l[5]||(l[5]=ce(" Add Condition ",-1))])])])]),_:1},8,["onDelete"]))}};export{Be as default};
