import{_ as ee}from"./Modal-D6W0cgKy.js";import{P as K}from"./PrimaryButton-ZwHmGBND.js";import{_ as q}from"./SecondaryButton-CwsDALDU.js";import{g as T,o as r,w as C,b as e,a as _,i as S,t as I,m as L,j as te,d as m,r as j,I as oe,x as Z,A as se,C as ue,c as F,J as ae,e as H,F as O,am as ce,l as X,y as me,f as ie,q as pe}from"./app-SqGcPtWR.js";import{B as le}from"./AuthenticatedLayout-fXnLTnWw.js";import{_ as B}from"./InputLabel-Bb8lo1WW.js";import{_ as R}from"./TextInput-CXH52_1a.js";import{_ as fe}from"./EmailEditor-CmxS3ksi.js";import{_ as P}from"./InputError-CNTSKuH2.js";import{_ as ne}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{S as Q}from"./SelectDropdown-CqneZTUc.js";const ve={class:"p-6"},ye={key:0,class:"space-y-4"},be={class:"border-b pb-4"},_e={class:"text-xl font-medium text-gray-900 mb-2"},ge={class:"grid grid-cols-2 gap-4 text-sm"},he={class:"text-gray-600"},we={class:"text-gray-900"},xe={class:"text-gray-600 mt-1"},ke={class:"text-gray-600"},je={class:"text-gray-900"},$e={class:"prose max-w-none"},Ve=["innerHTML"],Ee={key:0,class:"mt-4 p-4 bg-red-50 rounded-md"},Se={class:"text-red-700"},Ce={key:1,class:"mt-4 text-sm text-gray-600"},Ie={key:0},Le={key:2,class:"mt-6 flex justify-end space-x-2"},Wt={__name:"EmailDetailsModal",props:{show:{type:Boolean,required:!0},email:{type:Object,required:!0},canApproveEmails:{type:Boolean,required:!0}},emits:["close","edit","reject"],setup(l,{emit:M}){const p=l,h=M,i=()=>{h("close")},n=()=>{h("edit",p.email)},$=()=>{h("reject",p.email)};return(x,u)=>(r(),T(ee,{show:l.show,onClose:i},{default:C(()=>{var o;return[e("div",ve,[e("div",{class:"flex justify-between items-center mb-4"},[u[1]||(u[1]=e("h3",{class:"text-lg font-semibold text-gray-900"},"Email Details",-1)),e("button",{onClick:i,class:"text-gray-400 hover:text-gray-500"},u[0]||(u[0]=[e("svg",{class:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)]))]),l.email?(r(),_("div",ye,[e("div",be,[e("h4",_e,I(l.email.subject),1),e("div",ge,[e("div",null,[e("p",he,[u[2]||(u[2]=L("From: ",-1)),e("span",we,I(((o=l.email.sender)==null?void 0:o.name)||"N/A"),1)]),e("p",xe,[u[3]||(u[3]=L("Status: ",-1)),e("span",{class:te({"px-2 py-1 rounded-full text-xs font-medium":!0,"bg-green-100 text-green-800":l.email.status==="sent","bg-yellow-100 text-yellow-800":l.email.status==="pending_approval","bg-red-100 text-red-800":l.email.status==="rejected","bg-gray-100 text-gray-800":l.email.status==="draft"})},I(l.email.status?l.email.status.replace("_"," ").toUpperCase():"N/A"),3)])]),e("div",null,[e("p",ke,[u[4]||(u[4]=L("Date: ",-1)),e("span",je,I(new Date(l.email.created_at).toLocaleString()),1)])])])]),e("div",$e,[e("div",{innerHTML:l.email.body},null,8,Ve)]),l.email.rejection_reason?(r(),_("div",Ee,[u[5]||(u[5]=e("h5",{class:"font-medium text-red-800"},"Rejection Reason:",-1)),e("p",Se,I(l.email.rejection_reason),1)])):S("",!0),l.email.approver?(r(),_("div",Ce,[e("p",null,"Approved/Rejected by: "+I(l.email.approver.name),1),l.email.sent_at?(r(),_("p",Ie,"Sent at: "+I(new Date(l.email.sent_at).toLocaleString()),1)):S("",!0)])):S("",!0),(l.email.status==="pending_approval"||l.email.status==="pending_approval_received")&&l.canApproveEmails?(r(),_("div",Le,[m(K,{onClick:n,class:"bg-blue-600 hover:bg-blue-700"},{default:C(()=>u[6]||(u[6]=[L("Edit & Approve",-1)])),_:1,__:[6]}),m(q,{onClick:$,class:"text-red-600 hover:text-red-800"},{default:C(()=>u[7]||(u[7]=[L("Reject",-1)])),_:1,__:[7]})])):S("",!0)])):S("",!0)])]}),_:1},8,["show"]))}},Me={class:"p-6"},Ue={key:0,class:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4",role:"alert"},Be={class:"block sm:inline"},Te={class:"mb-4"},De={class:"mb-6"},Ae={class:"flex justify-end space-x-3"},Fe={__name:"InsertLinkModal",props:{show:{type:Boolean,default:!1}},emits:["close","insert"],setup(l,{emit:M}){const p=M,h=j(""),i=j(""),n=j(""),$=()=>{if(!h.value.trim()){n.value="Link text cannot be empty.";return}let u=i.value.trim();!u.startsWith("http://")&&!u.startsWith("https://")&&(u="http://"+u);try{new URL(u)}catch{n.value="Please enter a valid URL (e.g., https://example.com or www.example.com).";return}const o=`[${h.value.trim()}] {${u}}`;p("insert",o),x()},x=()=>{h.value="",i.value="",n.value="",p("close")};return(u,o)=>(r(),T(ee,{show:l.show,onClose:x,"max-width":"md"},{default:C(()=>[e("div",Me,[o[4]||(o[4]=e("h3",{class:"text-lg font-medium text-gray-900 mb-4"},"Insert Link",-1)),n.value?(r(),_("div",Ue,[e("span",Be,I(n.value),1)])):S("",!0),e("div",Te,[m(B,{for:"link_text",value:"Link Text"}),m(R,{id:"link_text",type:"text",class:"mt-1 block w-full",modelValue:h.value,"onUpdate:modelValue":o[0]||(o[0]=b=>h.value=b),onKeyup:oe($,["enter"])},null,8,["modelValue"])]),e("div",De,[m(B,{for:"link_url",value:"URL"}),m(R,{id:"link_url",type:"text",class:"mt-1 block w-full",modelValue:i.value,"onUpdate:modelValue":o[1]||(o[1]=b=>i.value=b),placeholder:"e.g., https://www.example.com",onKeyup:oe($,["enter"])},null,8,["modelValue"])]),e("div",Ae,[m(q,{onClick:x},{default:C(()=>o[2]||(o[2]=[L("Cancel",-1)])),_:1,__:[2]}),m(K,{onClick:$},{default:C(()=>o[3]||(o[3]=[L("Insert",-1)])),_:1,__:[3]})])])]),_:1},8,["show"]))}},Pe={class:"p-6"},Re={key:0,class:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4",role:"alert"},Ne={class:"block sm:inline"},Oe={class:"mb-4"},qe={class:"mb-6"},He={class:"flex justify-end space-x-3"},Ke={__name:"InsertListModal",props:{show:{type:Boolean,default:!1}},emits:["close","insert"],setup(l,{emit:M}){const p=M,h=j(""),i=j("bullet"),n=j(""),$=()=>{const u=h.value.split(`
`).map(w=>w.trim()).filter(w=>w!=="");if(u.length===0){n.value="Please enter at least one list item.";return}const o=i.value==="bullet"?"ul":"ol";let b=`<${o}>`;u.forEach(w=>{b+=`<li>${w}</li>`}),b+=`</${o}>`,p("insert",b),x()},x=()=>{h.value="",i.value="bullet",n.value="",p("close")};return(u,o)=>(r(),T(ee,{show:l.show,onClose:x,"max-width":"md"},{default:C(()=>[e("div",Pe,[o[5]||(o[5]=e("h3",{class:"text-lg font-medium text-gray-900 mb-4"},"Insert List",-1)),n.value?(r(),_("div",Re,[e("span",Ne,I(n.value),1)])):S("",!0),e("div",Oe,[m(B,{for:"list_items",value:"List Items (one per line)"}),Z(e("textarea",{id:"list_items",rows:"6",class:"border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 rounded-md shadow-sm mt-1 block w-full","onUpdate:modelValue":o[0]||(o[0]=b=>h.value=b),placeholder:"Enter each list item on a new line"},null,512),[[se,h.value]])]),e("div",qe,[m(B,{for:"list_type",value:"List Type"}),Z(e("select",{id:"list_type",class:"border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 rounded-md shadow-sm mt-1 block w-full","onUpdate:modelValue":o[1]||(o[1]=b=>i.value=b)},o[2]||(o[2]=[e("option",{value:"bullet"},"Bulleted List",-1),e("option",{value:"numbered"},"Numbered List",-1)]),512),[[ue,i.value]])]),e("div",He,[m(q,{onClick:x},{default:C(()=>o[3]||(o[3]=[L("Cancel",-1)])),_:1,__:[3]}),m(K,{onClick:$},{default:C(()=>o[4]||(o[4]=[L("Insert List",-1)])),_:1,__:[4]})])])]),_:1},8,["show"]))}};function ze(l){const M=i=>{const n=/\[([^\]]+?)\][\s\u00A0]*\{([^}]+?)\}/g;return i.replace(n,($,x,u)=>{let o=u.trim();return!o.startsWith("http://")&&!o.startsWith("https://")&&(o=`https://${o}`),`<a href="${o}" target="_blank" style="color: #1a73e8; text-decoration: underline;">${x.trim()}</a>`})},p=i=>{const n=/<(ul|ol)>(.*?)<\/(ul|ol)>/gs;return i.replace(n,($,x,u)=>{const o=x,b=o==="ul"?"list-style-type: disc;":"list-style-type: decimal;",w=/<li>(.*?)<\/li>/gs,E=u.replace(w,(V,a)=>`<li style="margin-bottom: 5px; font-family: 'Inter', sans-serif; font-size: 16px; line-height: 1.6; color: #1a202c;">${a}</li>`);return`<${o} style="margin: 0; padding: 0 0 0 20px; ${b}">${E}</${o}>`})};return{processedHtmlBody:F(()=>{let i=l.value;return i=M(i),i=p(i),i})}}const We={key:0},Je={class:"mb-4"},Ge={class:"mb-6"},Ze={class:"mb-2 flex justify-end space-x-2"},Qe={key:0,class:"min-h-[300px] flex items-center justify-center bg-gray-50 rounded-md"},Xe={key:1},Ye={key:0,class:"text-red-500 mb-2"},et={class:"mb-2 flex justify-end space-x-2"},tt={key:1},st={class:"mb-6"},at={__name:"EmailActionModal",props:{show:{type:Boolean,default:!1},title:{type:String,required:!0},apiEndpoint:{type:String,required:!0},httpMethod:{type:String,default:"post"},submitButtonText:{type:String,default:"Save"},successMessage:{type:String,default:"Operation successful!"},emailId:{type:Number,required:!1},projectId:{type:Number,required:!0}},emits:["close","submitted","error","fetchEmails"],setup(l,{emit:M}){const p=l,h=M,i=ae({}),n=j(!1),$=j(!1),x=async()=>{if(p.emailId){$.value=!0;try{for(const f in i)delete i[f];if(p.title==="Reject Email"){Object.assign(i,{rejection_reason:""}),$.value=!1;return}const t=(await window.axios.get(`/api/emails/${p.emailId}/edit-content`)).data;t.body_html&&!t.body&&(t.body=t.body_html),Object.assign(i,t)}catch(c){console.error("Failed to fetch email data:",c),h("error",c)}finally{$.value=!1}}};H(()=>p.show,c=>{c&&p.emailId&&x()});const u=j(!1),o=j(!1),b=F(()=>i.body||""),{processedHtmlBody:w}=ze(b),E=c=>{const t={...c};return p.title==="Edit and Approve Email"&&(t.body=w.value),t},V=()=>{console.log("EmailActionModal is closing"),h("close")},a=c=>{h("submitted",c)},U=c=>{h("error",c)},z=()=>{u.value=!0},N=c=>{i.body+=c,u.value=!1},W=()=>{o.value=!0},J=c=>{i.body+=c,o.value=!1},G=j({}),A=j(!1),v=async()=>{A.value=!0;try{console.log("Saving email with ID:",p.emailId),console.log("Email data:",{subject:i.subject,body:i.body}),await window.axios.post(`/api/emails/${p.emailId}/update`,{subject:i.subject,body:i.body}),console.log("Email saved successfully"),alert("Email saved successfully!"),A.value=!1,h("fetchEmails"),V()}catch(c){A.value=!1,console.error("Error saving email:",c);let t="Failed to save email.";c.response&&c.response.data.message&&(t=c.response.data.message),G.value=t,alert(t)}},g=()=>{if(p.emailId){const c=`/emails/${p.emailId}/preview`;window.open(c,"_blank")}else console.warn("Cannot preview email: Email ID not available.")};return(c,t)=>(r(),_(O,null,[m(le,{show:l.show,title:l.title,"api-endpoint":l.apiEndpoint,"http-method":l.httpMethod,"form-data":i,"submit-button-text":l.submitButtonText,"success-message":l.successMessage,"format-data-for-api":E,onClose:V,onSubmitted:a,onError:U,"max-width":"3xl"},{default:C(({errors:f})=>[l.title==="Edit and Approve Email"?(r(),_("div",We,[e("div",Je,[m(B,{for:"edit_subject",value:"Subject"}),m(R,{id:"edit_subject",type:"text",class:"mt-1 block w-full",modelValue:i.subject,"onUpdate:modelValue":t[0]||(t[0]=s=>i.subject=s),required:""},null,8,["modelValue"]),m(P,{message:f.subject?f.subject[0]:"",class:"mt-2"},null,8,["message"])]),e("div",Ge,[e("div",Ze,[m(q,{type:"button",onClick:W},{default:C(()=>t[5]||(t[5]=[L(" Insert List ",-1)])),_:1,__:[5]}),m(q,{type:"button",onClick:z},{default:C(()=>t[6]||(t[6]=[L(" Insert Link ",-1)])),_:1,__:[6]})]),m(B,{for:"edit_body",value:"Email Body",class:"sr-only"}),n.value?(r(),_("div",Qe,t[7]||(t[7]=[e("div",{class:"animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500"},null,-1)]))):(r(),_("div",Xe,[b.value?S("",!0):(r(),_("div",Ye,"Warning: Email body content is empty!")),m(fe,{id:"edit_body",modelValue:i.body,"onUpdate:modelValue":t[1]||(t[1]=s=>i.body=s),value:b.value,placeholder:"Edit your email here...",height:"300px"},null,8,["modelValue","value"])])),m(P,{message:f.body?f.body[0]:"",class:"mt-2"},null,8,["message"])]),e("div",et,[m(K,{type:"button",disabled:A.value,onClick:v},{default:C(()=>[L(I(A.value?"Saving...":"Save"),1)]),_:1},8,["disabled"]),m(q,{type:"button",onClick:g},{default:C(()=>t[8]||(t[8]=[L(" Preview Email ",-1)])),_:1,__:[8]})])])):l.title==="Reject Email"?(r(),_("div",tt,[e("div",st,[m(B,{for:"rejection_reason",value:"Rejection Reason"}),Z(e("textarea",{id:"rejection_reason",rows:"5",class:"border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 rounded-md shadow-sm mt-1 block w-full","onUpdate:modelValue":t[2]||(t[2]=s=>i.rejection_reason=s),required:"",placeholder:"Please provide a reason for rejecting this email (minimum 10 characters)"},null,512),[[se,i.rejection_reason]]),m(P,{message:f.rejection_reason?f.rejection_reason[0]:"",class:"mt-2"},null,8,["message"])])])):S("",!0)]),_:1},8,["show","title","api-endpoint","http-method","form-data","submit-button-text","success-message"]),m(Fe,{show:u.value,onClose:t[3]||(t[3]=f=>u.value=!1),onInsert:N},null,8,["show"]),m(Ke,{show:o.value,onClose:t[4]||(t[4]=f=>o.value=!1),onInsert:J},null,8,["show"])],64))}},Jt=ne(at,[["__scopeId","data-v-d9b7301b"]]),lt={class:"relative"},ot={key:0,class:"text-gray-400 text-sm"},it=["onClick"],nt=["placeholder"],dt={key:0,class:"absolute z-50 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 max-h-60 overflow-y-auto"},rt={class:"py-1"},ut={key:0,class:"px-4 py-2 text-gray-500 text-sm"},ct=["onClick"],mt={__name:"CustomMultiSelect",props:{modelValue:{type:Array,default:()=>[]},options:{type:Array,default:()=>[],required:!0},placeholder:{type:String,default:"Select items"},labelKey:{type:String,default:"name"},trackBy:{type:String,default:"id"}},emits:["update:modelValue"],setup(l,{emit:M}){const p=l,h=M,i=j(!1),n=j(""),$=F(()=>{if(!n.value)return p.options;const b=n.value.toLowerCase();return p.options.filter(w=>w[p.labelKey].toLowerCase().includes(b))});H(()=>p.modelValue,b=>{},{deep:!0});const x=b=>{const w=[...p.modelValue],E=w.findIndex(V=>V===b[p.trackBy]);E===-1?w.push(b[p.trackBy]):w.splice(E,1),h("update:modelValue",w),n.value=""},u=b=>{const w=p.options.find(E=>E[p.trackBy]===b);return w?w[p.labelKey]:""},o=b=>p.modelValue.includes(b);return(b,w)=>{const E=ce("click-outside");return Z((r(),_("div",lt,[e("div",{class:"flex flex-wrap items-center w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm cursor-pointer min-h-[38px] bg-white focus-within:border-indigo-500 focus-within:ring-indigo-500",onClick:w[2]||(w[2]=V=>i.value=!i.value)},[l.modelValue.length===0&&!n.value?(r(),_("span",ot,I(l.placeholder),1)):S("",!0),(r(!0),_(O,null,X(l.modelValue,V=>(r(),_("div",{key:V,class:"inline-flex items-center bg-indigo-100 text-indigo-800 text-xs font-medium px-2.5 py-0.5 rounded mr-2 mb-1"},[L(I(u(V))+" ",1),e("button",{type:"button",onClick:me(a=>x(l.options.find(U=>U[l.trackBy]===V)),["stop"]),class:"ml-1 text-indigo-800 hover:text-indigo-900 focus:outline-none"},w[3]||(w[3]=[e("svg",{class:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)]),8,it)]))),128)),Z(e("input",{type:"text","onUpdate:modelValue":w[0]||(w[0]=V=>n.value=V),onInput:w[1]||(w[1]=V=>i.value=!0),class:"flex-grow border-none focus:ring-0 p-0 text-sm placeholder-gray-400 bg-transparent outline-none",placeholder:l.modelValue.length===0?"Search...":""},null,40,nt),[[se,n.value]])]),i.value?(r(),_("div",dt,[e("ul",rt,[$.value.length===0?(r(),_("li",ut,"No items found.")):S("",!0),(r(!0),_(O,null,X($.value,V=>(r(),_("li",{key:V[l.trackBy],class:te(["px-4 py-2 cursor-pointer hover:bg-gray-100 text-sm",{"bg-indigo-50 text-indigo-900":o(V[l.trackBy])}]),onClick:a=>x(V)},I(V[l.labelKey]),11,ct))),128))])])):S("",!0)])),[[E,()=>i.value=!1]])}}},Y=ne(mt,[["__scopeId","data-v-5326f069"]]),pt={class:"mb-4"},ft={class:"grid grid-cols-1 sm:grid-cols-2 gap-6 mt-4"},vt={key:2},yt={key:0,class:"text-gray-500 text-sm mt-1"},bt={class:"mt-6"},_t={class:"flex justify-between items-center mb-3"},gt=["innerHTML"],Gt={__name:"EditTemplateEmailModal",props:{show:Boolean,title:String,apiEndpoint:String,httpMethod:{type:String,default:"post"},submitButtonText:String,successMessage:String,emailId:Number,projectId:Number,clientId:{type:Number,default:null}},emits:["close","submitted","error"],setup(l,{expose:M,emit:p}){const h=l,i=p,n=ae({subject:"",template_id:null,template_data:{}}),$=j([]),x=j({}),u=j(!1),o=j(""),b=j(!1),w=F(()=>$.value.find(v=>v.id===n.template_id)),E=F(()=>w.value?w.value.placeholders.filter(v=>v.is_dynamic||v.is_repeatable||v.is_selectable):[]),V=async()=>{try{const v=await window.axios.get("/api/email-templates");$.value=v.data}catch(v){console.error("Failed to fetch email templates:",v)}},a=async v=>{if(!(!v||!v.placeholders)){u.value=!0,x.value={};try{const g=v.placeholders.filter(f=>(f.is_selectable||f.is_repeatable)&&f.source_model);if(g.length===0){u.value=!1;return}const c={};g.forEach(f=>{c[f.source_model]||(c[f.source_model]=[]),c[f.source_model].push(f)});const t=Object.keys(c).map(async f=>{try{const s=await window.axios.get(`/api/source-models/${encodeURIComponent(f)}`);c[f].forEach(d=>{x.value[d.name]=s.data.map(k=>({id:k.id,label:k[d.source_attribute]||k.name||`ID: ${k.id}`}))})}catch(s){console.error(`Failed to fetch data for model ${f}:`,s),c[f].forEach(d=>{x.value[d.name]=[]})}});await Promise.all(t)}catch(g){console.error("Error fetching source models data:",g)}finally{u.value=!1}}},U=async v=>{if(Object.assign(n,{subject:"",template_id:null,template_data:{}}),o.value="",x.value={},v.template_id){await V(),n.subject=v.subject,n.template_id=v.template_id,n.template_data=v.template_data||{};const g=$.value.find(c=>c.id===n.template_id);g&&await a(g),N()}else console.error("This modal is only for template-based emails")};M({setData:U});const z=v=>{const g={...v};if(g.composition_type="template",typeof g.template_data=="object"&&g.template_data!==null){const c=$.value.find(t=>t.id===g.template_id);if(c&&c.placeholders){const t={};c.placeholders.forEach(f=>{const s=f.name,d=g.template_data[s];d!=null&&(f.is_repeatable&&Array.isArray(d)||f.is_selectable,t[s]=d)}),g.template_data=t}}else if(typeof g.template_data=="string")try{g.template_data=JSON.parse(g.template_data)}catch(c){console.error("Error parsing template_data:",c),g.template_data={}}else g.template_data={};return g},N=async()=>{b.value=!0;try{const v={},g=$.value.find(f=>f.id===n.template_id);g&&g.placeholders?g.placeholders.forEach(f=>{const s=f.name,d=n.template_data[s];d!=null&&(f.is_repeatable&&Array.isArray(d)||f.is_selectable,v[s]=d)}):Object.assign(v,n.template_data);const c={template_id:n.template_id,template_data:v};h.clientId&&(c.client_id=h.clientId);const t=await window.axios.post(`/api/projects/${h.projectId}/email-preview`,c);o.value=t.data.body_html,n.subject=t.data.subject}catch(v){console.error("Error fetching preview:",v),o.value='<p class="text-red-500 italic">Error loading preview.</p>'}finally{b.value=!1}},W=()=>{i("close")},J=v=>{i("submitted",v)},G=v=>{i("error",v)};H(()=>h.show,v=>{v&&h.emailId&&A()});const A=async()=>{if(h.emailId)try{const g=(await window.axios.get(`/api/emails/${h.emailId}/edit-content`)).data;if(!g.template_id){console.error("This email does not use a template"),i("close");return}await U(g)}catch(v){console.error("Failed to fetch email data:",v),i("error",v)}};return ie(()=>{V()}),(v,g)=>(r(),T(le,{show:l.show,title:l.title,"api-endpoint":l.apiEndpoint,"http-method":l.httpMethod,"form-data":n,"submit-button-text":l.submitButtonText,"success-message":l.successMessage,"format-data-for-api":z,onClose:W,onSubmitted:J,onError:G,"max-width":"4xl"},{default:C(({errors:c})=>[e("div",pt,[m(B,{for:"edit_subject",value:"Subject"}),m(R,{id:"edit_subject",type:"text",class:"mt-1 block w-full",modelValue:n.subject,"onUpdate:modelValue":g[0]||(g[0]=t=>n.subject=t),required:""},null,8,["modelValue"]),m(P,{message:c.subject?c.subject[0]:"",class:"mt-2"},null,8,["message"])]),e("div",null,[g[2]||(g[2]=e("h4",{class:"text-md font-semibold text-gray-800 mb-3 border-b pb-2"},"Editing Template Fields",-1)),e("div",ft,[(r(!0),_(O,null,X(E.value,t=>(r(),_("div",{key:t.id},[m(B,{for:t.name,value:t.name},null,8,["for","value"]),t.is_dynamic&&!t.is_selectable&&!t.is_repeatable?(r(),T(R,{key:0,type:"text",class:"mt-1 block w-full",modelValue:n.template_data[t.name],"onUpdate:modelValue":f=>n.template_data[t.name]=f},null,8,["modelValue","onUpdate:modelValue"])):t.is_selectable?(r(),T(Q,{key:1,id:t.name,modelValue:n.template_data[t.name],"onUpdate:modelValue":f=>n.template_data[t.name]=f,options:x.value[t.name]||[],"value-key":"id","label-key":"label",class:"mt-1 block w-full",disabled:u.value},null,8,["id","modelValue","onUpdate:modelValue","options","disabled"])):t.is_repeatable?(r(),_("div",vt,[u.value?(r(),_("div",yt,"Loading options...")):(r(),T(Y,{key:1,modelValue:n.template_data[t.name],"onUpdate:modelValue":f=>n.template_data[t.name]=f,options:x.value[t.name]||[],placeholder:`Select ${t.name}`,"label-key":"label","value-key":"id",class:"mt-1"},null,8,["modelValue","onUpdate:modelValue","options","placeholder"]))])):(r(),T(R,{key:3,type:"text",class:"mt-1 block w-full",modelValue:n.template_data[t.name],"onUpdate:modelValue":f=>n.template_data[t.name]=f},null,8,["modelValue","onUpdate:modelValue"])),m(P,{message:c[`template_data.${t.name}`]?c[`template_data.${t.name}`][0]:"",class:"mt-2"},null,8,["message"])]))),128))]),e("div",bt,[e("div",_t,[g[1]||(g[1]=e("h4",{class:"text-md font-semibold text-gray-800"},"Email Preview",-1)),m(K,{onClick:N,disabled:b.value},{default:C(()=>[L(I(b.value?"Loading...":"Refresh Preview"),1)]),_:1},8,["disabled"])]),e("div",{class:"bg-gray-100 p-4 rounded-lg shadow-inner min-h-[300px]",innerHTML:o.value},null,8,gt)])])]),_:1},8,["show","title","api-endpoint","http-method","form-data","submit-button-text","success-message"]))}},ht={class:"flex flex-col space-y-6"},wt={class:"grid grid-cols-1 sm:grid-cols-2 gap-6"},xt={key:0},kt={key:0,class:"text-xs text-gray-500 mt-1"},jt={key:0,class:"text-xs text-gray-500 mt-1"},$t={key:0},Vt={class:"grid grid-cols-1 sm:grid-cols-2 gap-6"},Et={class:"mb-4"},St={key:0,class:"text-xs text-gray-500 mt-1"},Ct={key:0,class:"text-xs text-gray-500 mt-1"},It={class:"flex justify-between items-center mb-3"},Lt={key:0,class:"flex items-center"},Mt={key:1},Ut={class:"bg-gray-100 p-4 rounded-lg shadow-inner min-h-[300px]"},Bt={key:0,class:"flex items-center justify-center h-full"},Tt=["innerHTML"],Zt={__name:"ComposeEmailModal",props:{show:{type:Boolean,default:!1},projectId:{type:Number,required:!1,default:null},clients:{type:Array,default:()=>[]}},emits:["close"],setup(l,{emit:M}){const p=l,h=M,i=j([]),n=j([]),$=j(!1),x=j([]),u=j(!1),o=j(""),b=j(!1),w=j({}),E=j({}),V=j(!1),a=ae({template_id:null,template_data:{},project_id:p.projectId||null,client_ids:[],subject:"",greeting_name:"",custom_greeting_name:"",status:"pending_approval"});pe(a.project_id);const U=F(()=>i.value.find(s=>s.id===a.template_id)),z=async s=>{if(!a.project_id){console.error("Cannot fetch source model data: No project selected");return}V.value=!0,E.value={};const d=new Set;s.placeholders.forEach(k=>{(k.is_repeatable||k.is_selectable)&&k.source_model&&d.add(k.source_model)});try{const k=Array.from(d).map(y=>{const D=y.split("\\").pop(),de=`/api/projects/${a.project_id}/model-data/${D}`;return window.axios.get(de).then(re=>{E.value[D]=re.data})});await Promise.all(k)}catch(k){console.error("Failed to fetch source model data:",k)}finally{V.value=!1}},N=async()=>{try{const s=await window.axios.get("/api/email-templates");i.value=s.data}catch(s){console.error("Failed to fetch email templates:",s)}},W=async()=>{if(!a.template_id||a.client_ids.length===0||!a.project_id){o.value='<p class="text-gray-500 italic">Select a project, template, and at least one recipient to see a preview.</p>';return}b.value=!0;try{const s=a.client_ids[0],d=typeof s=="object"?s.id:s,k=await window.axios.post(`/api/projects/${a.project_id}/email-preview`,{template_id:a.template_id,client_id:d,template_data:a.template_data});o.value=k.data.body_html,k.data.subject&&(a.subject=k.data.subject)}catch(s){console.error("Failed to fetch email preview:",s),o.value='<p class="text-red-500 italic">Error loading preview.</p>'}finally{b.value=!1}};H(()=>p.show,s=>{s&&(Object.assign(a,{template_id:null,template_data:{},project_id:p.projectId||null,client_ids:[],subject:"",greeting_name:"",custom_greeting_name:"",status:"pending_approval"}),o.value="",w.value={},E.value={},N(),p.projectId||t())}),H(U,s=>{a.template_data={},s&&s.placeholders&&(s.placeholders.forEach(d=>{d.is_dynamic?a.template_data[d.name]="":(d.is_repeatable||d.is_selectable)&&(d.is_repeatable?a.template_data[d.name]=[]:a.template_data[d.name]=null)}),z(s))});const J=async()=>{if(Array.isArray(a.client_ids)&&a.client_ids.length>0&&typeof a.client_ids[0]=="object"&&(a.client_ids=a.client_ids.map(s=>s.id)),!a.subject&&U.value&&(a.subject=U.value.subject||""),a.client_ids.length>0){const s=a.client_ids[0],k=(p.clients.length>0?p.clients:x.value).find(y=>y.id===s);k&&(a.greeting_name=k.name||"")}return console.log("Form data prepared:",JSON.stringify(a)),!0},G=()=>{h("close")},A=()=>{h("close")},v=F(()=>i.value.map(s=>({value:s.id,label:s.name}))),g=F(()=>U.value?U.value.placeholders.filter(s=>s.is_dynamic||s.is_repeatable||s.is_selectable):[]),c=F(()=>"/api/emails/templated"),t=async()=>{$.value=!0;try{const s=await window.axios.get("/api/projects-simplified");n.value=s.data}catch(s){console.error("Failed to fetch projects:",s)}finally{$.value=!1}},f=async s=>{if(s){u.value=!0,x.value=[];try{const d=await window.axios.get(`/api/projects/${s}/sections/clients?type=clients`);x.value=d.data}catch(d){console.error("Failed to fetch clients:",d)}finally{u.value=!1}}};return H(()=>a.project_id,s=>{a.template_id=null,a.template_data={},a.client_ids=[],o.value="",s?f(s):x.value=[]}),ie(()=>{N(),p.projectId||t()}),(s,d)=>(r(),T(le,{show:l.show,title:"Compose Email from Template","api-endpoint":c.value,"http-method":"post","form-data":a,"submit-button-text":"Submit for Approval","success-message":"Email submitted for approval successfully!",onClose:A,onSubmitted:G,"before-submit":J},{default:C(({errors:k})=>[e("div",ht,[e("div",wt,[p.projectId?S("",!0):(r(),_("div",xt,[m(B,{for:"project",value:"Select Project"}),m(Q,{id:"project",modelValue:a.project_id,"onUpdate:modelValue":d[0]||(d[0]=y=>a.project_id=y),options:n.value,placeholder:"Select a project","value-key":"id","label-key":"name","allow-empty":!0,class:"mt-1"},null,8,["modelValue","options"]),$.value?(r(),_("div",kt," Loading projects... ")):S("",!0),m(P,{message:k.project_id?k.project_id[0]:"",class:"mt-2"},null,8,["message"])])),e("div",null,[m(B,{for:"template",value:"Select Template"}),m(Q,{id:"template",modelValue:a.template_id,"onUpdate:modelValue":d[1]||(d[1]=y=>a.template_id=y),options:v.value,placeholder:"Select a template","value-key":"value","label-key":"label","allow-empty":!0,class:"mt-1"},null,8,["modelValue","options"]),m(P,{message:k.template_id?k.template_id[0]:"",class:"mt-2"},null,8,["message"])]),e("div",null,[m(B,{for:"client_ids",value:"Recipients"}),m(Y,{id:"client_ids",modelValue:a.client_ids,"onUpdate:modelValue":d[2]||(d[2]=y=>a.client_ids=y),options:p.clients.length>0?p.clients:x.value,placeholder:"Select clients to send to","label-key":"name","track-by":"id","preserve-search":!0,"object-value":!0,class:"mt-1"},null,8,["modelValue","options"]),u.value?(r(),_("div",jt," Loading clients... ")):S("",!0),m(P,{message:k.client_ids?k.client_ids[0]:"",class:"mt-2"},null,8,["message"])])]),U.value?(r(),_("div",$t,[d[3]||(d[3]=e("h4",{class:"text-md font-semibold text-gray-800 mb-3"},"Dynamic Placeholders",-1)),e("div",Vt,[(r(!0),_(O,null,X(g.value,y=>(r(),_("div",{key:y.id},[e("div",Et,[m(B,{for:y.name,value:y.name},null,8,["for","value"]),y.is_repeatable&&y.source_model?(r(),_(O,{key:0},[m(Y,{id:y.name,modelValue:a.template_data[y.name],"onUpdate:modelValue":D=>a.template_data[y.name]=D,options:E.value[y.source_model.split("\\").pop()]||[],placeholder:`Select one or more ${y.name}`,"label-key":y.source_attribute,"track-by":"id",class:"mt-1"},null,8,["id","modelValue","onUpdate:modelValue","options","placeholder","label-key"]),V.value?(r(),_("div",St," Loading "+I(y.source_model.split("\\").pop())+"... ",1)):S("",!0)],64)):y.is_selectable&&y.source_model?(r(),_(O,{key:1},[m(Q,{id:y.name,modelValue:a.template_data[y.name],"onUpdate:modelValue":D=>a.template_data[y.name]=D,options:E.value[y.source_model.split("\\").pop()]||[],placeholder:`Select a ${y.name}`,"value-key":y.trackBy??"id","label-key":y.source_attribute,"allow-empty":!0,class:"mt-1"},null,8,["id","modelValue","onUpdate:modelValue","options","placeholder","value-key","label-key"]),V.value?(r(),_("div",Ct," Loading "+I(y.source_model.split("\\").pop())+"... ",1)):S("",!0)],64)):y.is_dynamic&&y.is_link?(r(),T(R,{key:2,id:y.name,type:"url",class:"mt-1 block w-full",modelValue:a.template_data[y.name],"onUpdate:modelValue":D=>a.template_data[y.name]=D,placeholder:"Enter URL"},null,8,["id","modelValue","onUpdate:modelValue"])):(r(),T(R,{key:3,id:y.name,type:"text",class:"mt-1 block w-full",modelValue:a.template_data[y.name],"onUpdate:modelValue":D=>a.template_data[y.name]=D},null,8,["id","modelValue","onUpdate:modelValue"])),m(P,{message:k[`template_data.${y.name}`]?k[`template_data.${y.name}`][0]:"",class:"mt-2"},null,8,["message"])])]))),128))])])):S("",!0),e("div",null,[e("div",It,[d[5]||(d[5]=e("h4",{class:"text-md font-semibold text-gray-800"},"Email Preview",-1)),m(K,{onClick:W,disabled:!a.project_id||!a.template_id||a.client_ids.length===0||b.value,class:te({"opacity-50 cursor-not-allowed":!a.project_id||!a.template_id||a.client_ids.length===0||b.value})},{default:C(()=>[b.value?(r(),_("span",Lt,d[4]||(d[4]=[e("svg",{class:"animate-spin -ml-1 mr-3 h-5 w-5 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24"},[e("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"}),e("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})],-1),L(" Loading... ",-1)]))):(r(),_("span",Mt," Refresh Preview "))]),_:1},8,["disabled","class"])]),e("div",Ut,[b.value?(r(),_("div",Bt,d[6]||(d[6]=[e("div",{class:"animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500"},null,-1)]))):(r(),_("div",{key:1,innerHTML:o.value},null,8,Tt))])])])]),_:1},8,["show","api-endpoint","form-data"]))}};export{Jt as E,Y as O,Wt as _,Gt as a,Zt as b,ze as u};
