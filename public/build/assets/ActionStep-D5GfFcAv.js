import{u as Z}from"./workflowStore-XAGUmoSA.js";import ee from"./StepCard-C2N0dOAe.js";import A from"./DataTokenInserter-B5tp_nJc.js";import{S as te}from"./SelectDropdown-Duuae3KQ.js";import{c as f,r as le,e as $,f as oe,g as ae,o as r,w as ne,b as s,a as u,i as m,F as y,l as k,t as b,d as g,m as se,u as j,j as re,p as ue}from"./app-C_l5dlFM.js";import{P as ie}from"./plus-BLJjzuTJ.js";import{T as de}from"./trash-Bh-xRuVC.js";/* empty css                                                                       */import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./createLucideIcon-kJjbaSbK.js";const ce=["value"],me=["value"],ve={key:0,class:"space-y-4 mt-4 border-t pt-4"},pe={class:"flex items-center gap-2"},fe=["value"],ye={class:"flex items-center gap-2"},ge=["value"],be={class:"relative"},he=["value"],_e={class:"absolute top-2 right-2"},xe={class:"block text-xs font-medium text-gray-600 mb-1"},Ce={key:0},Ae={class:"flex items-center gap-2"},ke=["value"],we={class:"flex items-center justify-between mb-2"},Ee={key:0,class:"mb-2 text-[11px]"},Se={class:"text-gray-600"},Ie={class:"px-1.5 py-0.5 rounded bg-amber-50 border border-amber-200 text-amber-700"},Re={key:0},Te={key:0,class:"mt-1 text-red-600"},Fe={key:1,class:"space-y-2"},De={class:"flex items-center justify-between gap-2"},Oe={class:"flex-1 flex items-center gap-2"},Me=["value","onChange","disabled"],qe=["value"],Ue={key:0,class:"text-[10px] px-1.5 py-0.5 rounded bg-amber-50 border border-amber-200 text-amber-700"},Be=["onClick","title"],$e={class:"flex items-center gap-2 mt-2"},je=["value","onChange"],Le=["value"],Ne=["value","onInput"],Pe=["value","onInput"],Ve={key:2,class:"p-3 bg-blue-50 border-l-4 border-blue-400 text-blue-800 text-sm rounded-r-md"},et={__name:"ActionStep",props:{step:{type:Object,required:!0},allStepsBefore:{type:Array,default:()=>[]},loopContextSchema:{type:Object,default:null}},emits:["update:step","delete"],setup(d,{emit:L}){const F=d,D=L,N=Z(),_=f(()=>N.automationSchema||[]),x=le({});function O(t,e){return`${t||""}:${e||""}`}async function w(t,e){if(!t||!e)return null;const l=O(t,e);if(Array.isArray(x.value[l])&&x.value[l].length)return x.value[l];try{const{data:o}=await ue.get(`/api/value-dictionaries/${encodeURIComponent(t)}/${encodeURIComponent(e)}`);let a=null;if(Array.isArray(o)?a=o:o&&Array.isArray(o.values)&&(a=o.values),Array.isArray(a)&&a.length)return x.value[l]=a,a}catch{}return null}const P=[{value:"SEND_EMAIL",label:"Send Email"},{value:"CREATE_RECORD",label:"Create Record"},{value:"UPDATE_RECORD",label:"Update Record"},{value:"CHECK_MILESTONE_COMPLETION",label:"Check for Milestone Completion & Update"}],n=f({get:()=>F.step.step_config||{},set:t=>D("update:step",{...F.step,step_config:t})});function c(t,e){n.value={...n.value,[t]:e}}function V(t){n.value={action_type:t}}function E(t,e){const l=n.value[t]||"";c(t,`${l}${e}`)}f(()=>_.value.map(t=>t.name));const K=f(()=>(_.value||[]).map(t=>({label:t.name,value:t.name})));function S(t){if(!t||typeof t!="string")return"";let e=t.toLowerCase();if(e==="id")return"ID";e.endsWith("_id")&&(e=e.slice(0,-3)),e=e.replace(/[_-]+/g," ");let l=e.replace(/\b\w/g,o=>o.toUpperCase());return l=l.replace(/\bId\b/g,"ID").replace(/\bUrl\b/g,"URL"),l}const I=f(()=>{const t=n.value.target_model;if(!t)return null;let e=(_.value||[]).find(o=>o.name===t);if(e||(e=(_.value||[]).find(o=>o.full_class===t),e))return e;const l=typeof t=="string"?t.split("\\").pop().split("/").pop():t;return(_.value||[]).find(o=>o.name===l)||null}),R=f(()=>{const t=I.value;return t?(t.columns||[]).map(e=>typeof e=="string"?{name:e,label:S(e),is_required:!1,allowed_values:null}:{name:e.name,label:e.label||S(e.name),is_required:!!e.is_required,allowed_values:e.allowed_values??null}):[]}),h=f(()=>{var t;return((t=I.value)==null?void 0:t.required_on_create)||[]}),W=f(()=>{var t;return((t=I.value)==null?void 0:t.defaults_on_create)||{}});function M(t){return h.value.includes(t)}function z(t){const e=W.value||{},l=n.value.target_model,a=`{{trigger.${l?l.toLowerCase():""}.${t}}}`,i=(()=>{const p=(R.value||[]).find(Y=>Y.name===t);return!!(p&&Array.isArray(p.allowed_values)&&p.allowed_values.length>0)})();return n.value.action_type==="CREATE_RECORD"&&i?"":e[t]!==void 0&&e[t]!==null||t.endsWith("_id")?a:""}function q(){const t=h.value||[];if(!t.length)return;const e=Array.isArray(n.value.fields)?[...n.value.fields]:[],l=new Map;e.forEach(i=>{const v=i.column||i.field||i.name;v&&l.set(v,!0)});const o=[];for(const i of t)l.has(i)||o.push({column:i,value:z(i)});o.length&&c("fields",[...e,...o]);const a=n.value.target_model;if(a)for(const i of t)w(a,i)}function H(t){c("target_model",t),q()}$(()=>n.value.target_model,async(t,e)=>{if(t&&t!==e){q();const l=Array.isArray(n.value.fields)?n.value.fields:[];for(const o of l){const a=(o==null?void 0:o.column)||(o==null?void 0:o.field)||(o==null?void 0:o.name);a&&await w(t,a)}}}),$(()=>n.value.fields,async t=>{const e=n.value.target_model;if(!(!e||!Array.isArray(t)))for(const l of t){const o=(l==null?void 0:l.column)||(l==null?void 0:l.field)||(l==null?void 0:l.name);o&&await w(e,o)}},{deep:!0,immediate:!0}),oe(async()=>{const t=n.value.target_model,e=Array.isArray(n.value.fields)?n.value.fields:[];if(t)for(const l of e){const o=(l==null?void 0:l.column)||(l==null?void 0:l.field)||(l==null?void 0:l.name);o&&await w(t,o)}});function G(){const t=n.value.fields||[];c("fields",[...t,{column:"",value:""}])}function J(t){const e=n.value.fields||[];c("fields",e.filter((l,o)=>o!==t))}function C(t,e,l){const a=[...n.value.fields||[]];a[t]={...a[t],[e]:l},c("fields",a)}function Q(t,e){const o=(n.value.fields||[])[t].value||"";C(t,"value",o+e)}function U(t){var v;const e=n.value.target_model;if(!e||!t)return null;const l=t.column||t.field||t.name;if(!l)return null;const o=(v=(R.value||[]).find(p=>p.name===l))==null?void 0:v.allowed_values;if(Array.isArray(o)&&o.length)return o;const a=O(e,l),i=x.value[a];return Array.isArray(i)&&i.length?i:null}function X(t){const e=U(t);return!(!e||!e.length||(t.value||"").toString().includes("{{"))}const B=f(()=>{const t=h.value||[];if(!t.length)return[];const e=new Map;return(Array.isArray(n.value.fields)?n.value.fields:[]).forEach(o=>{const a=o.column||o.field||o.name,i=(o.value??"").toString().trim();a&&i&&e.set(a,!0)}),t.filter(o=>!e.has(o))});function T(t){var a,i,v;const e=Array.isArray(n.value.fields)?n.value.fields:[],l=((a=e[t])==null?void 0:a.column)||((i=e[t])==null?void 0:i.field)||((v=e[t])==null?void 0:v.name);return!l||!M(l)?!0:e.filter(p=>(p.column||p.field||p.name)===l).length>1}return(t,e)=>(r(),ae(ee,{icon:"⚙️",title:"Perform an Action",onDelete:()=>D("delete")},{default:ne(()=>[s("select",{value:n.value.action_type||"",onChange:e[0]||(e[0]=l=>V(l.target.value)),class:"p-2 border border-gray-300 rounded-md bg-white shadow-sm w-full text-sm"},[e[9]||(e[9]=s("option",{value:"",disabled:""},"Select an action...",-1)),(r(),u(y,null,k(P,l=>s("option",{key:l.value,value:l.value},b(l.label),9,me)),64))],40,ce),n.value.action_type?(r(),u("div",ve,[n.value.action_type==="SEND_EMAIL"?(r(),u(y,{key:0},[s("div",null,[e[10]||(e[10]=s("label",{class:"block text-xs font-medium text-gray-600 mb-1"},"To",-1)),s("div",pe,[s("input",{type:"text",value:n.value.to||"",onInput:e[1]||(e[1]=l=>c("to",l.target.value)),class:"w-full p-2 border border-gray-300 rounded-md text-sm",placeholder:"e.g., {{trigger.email.sender}}"},null,40,fe),g(A,{"all-steps-before":d.allStepsBefore,"loop-context-schema":d.loopContextSchema,onInsert:e[2]||(e[2]=l=>E("to",l))},null,8,["all-steps-before","loop-context-schema"])])]),s("div",null,[e[11]||(e[11]=s("label",{class:"block text-xs font-medium text-gray-600 mb-1"},"Subject",-1)),s("div",ye,[s("input",{type:"text",value:n.value.subject||"",onInput:e[3]||(e[3]=l=>c("subject",l.target.value)),class:"w-full p-2 border border-gray-300 rounded-md text-sm",placeholder:"e.g., AI says: {{step_2.category}}"},null,40,ge),g(A,{"all-steps-before":d.allStepsBefore,"loop-context-schema":d.loopContextSchema,onInsert:e[4]||(e[4]=l=>E("subject",l))},null,8,["all-steps-before","loop-context-schema"])])]),s("div",null,[e[12]||(e[12]=s("label",{class:"block text-xs font-medium text-gray-600 mb-1"},"Body",-1)),s("div",be,[s("textarea",{rows:"5",value:n.value.body||"",onInput:e[5]||(e[5]=l=>c("body",l.target.value)),class:"w-full p-2 border border-gray-300 rounded-md text-sm"},null,40,he),s("div",_e,[g(A,{"all-steps-before":d.allStepsBefore,"loop-context-schema":d.loopContextSchema,onInsert:e[6]||(e[6]=l=>E("body",l))},null,8,["all-steps-before","loop-context-schema"])])])])],64)):m("",!0),n.value.action_type==="CREATE_RECORD"||n.value.action_type==="UPDATE_RECORD"?(r(),u(y,{key:1},[s("div",null,[s("label",xe,b(n.value.action_type==="CREATE_RECORD"?"Model to Create":"Model to Update"),1),g(te,{"model-value":n.value.target_model||"",options:K.value,placeholder:"Select model...","onUpdate:modelValue":H,class:"w-full"},null,8,["model-value","options"])]),n.value.action_type==="UPDATE_RECORD"?(r(),u("div",Ce,[e[13]||(e[13]=s("label",{class:"block text-xs font-medium text-gray-600 mb-1"},"Record ID",-1)),s("div",Ae,[s("input",{type:"text",value:n.value.record_id||"",onInput:e[7]||(e[7]=l=>c("record_id",l.target.value)),class:"w-full p-2 border border-gray-300 rounded-md text-sm",placeholder:"e.g., {{trigger.task.id}}"},null,40,ke),g(A,{"all-steps-before":d.allStepsBefore,"loop-context-schema":d.loopContextSchema,onInsert:e[8]||(e[8]=l=>E("record_id",l))},null,8,["all-steps-before","loop-context-schema"])])])):m("",!0),s("div",null,[s("div",we,[e[15]||(e[15]=s("label",{class:"text-xs font-medium text-gray-600"},"Fields to set",-1)),s("button",{onClick:G,class:"flex items-center gap-1 px-2 py-1 text-xs rounded-md bg-gray-100 hover:bg-gray-200"},[g(j(ie),{class:"h-3 w-3"}),e[14]||(e[14]=se(" Add ",-1))])]),h.value.length?(r(),u("div",Ee,[s("span",Se,"Required for "+b(n.value.target_model)+":",1),(r(!0),u(y,null,k(h.value,(l,o)=>(r(),u("span",{class:"ml-1",key:l},[s("span",Ie,b(S(l)),1),o<h.value.length-1?(r(),u("span",Re,", ")):m("",!0)]))),128)),B.value.length?(r(),u("div",Te,"Missing: "+b(B.value.map(S).join(", ")),1)):m("",!0)])):m("",!0),n.value.fields&&n.value.fields.length>0?(r(),u("div",Fe,[(r(!0),u(y,null,k(n.value.fields,(l,o)=>(r(),u("div",{key:o,class:"p-2 border rounded-md bg-gray-50/50"},[s("div",De,[s("div",Oe,[s("select",{value:l.column,onChange:a=>C(o,"column",a.target.value),class:"w-full p-2 border border-gray-300 rounded-md text-sm",disabled:!n.value.target_model},[e[16]||(e[16]=s("option",{value:"",disabled:""},"Field...",-1)),(r(!0),u(y,null,k(R.value,a=>(r(),u("option",{key:a.name,value:a.name},b(a.label),9,qe))),128))],40,Me),M(l.column)?(r(),u("span",Ue,"Required")):m("",!0)]),s("button",{onClick:a=>T(o)&&J(o),class:re([[T(o)?"text-gray-400 hover:text-red-500 hover:bg-red-50":"text-gray-300 cursor-not-allowed"],"p-1 rounded-full"]),title:T(o)?"Remove Field":"Cannot remove required field"},[g(j(de),{class:"w-4 h-4"})],10,Be)]),s("div",$e,[n.value.target_model?(r(),u(y,{key:0},[X(l)?(r(),u("select",{key:0,value:l.value||"",onChange:a=>C(o,"value",a.target.value),class:"w-full p-2 border border-gray-300 rounded-md text-sm"},[e[17]||(e[17]=s("option",{value:"",disabled:""},"Select value...",-1)),(r(!0),u(y,null,k(U(l)||[],a=>(r(),u("option",{key:a.value,value:a.value},b(a.label??a.value),9,Le))),128))],40,je)):(r(),u("input",{key:1,value:l.value,onInput:a=>C(o,"value",a.target.value),type:"text",class:"w-full border rounded px-2 py-2 text-sm",placeholder:"Value..."},null,40,Ne))],64)):(r(),u("input",{key:1,value:l.value,onInput:a=>C(o,"value",a.target.value),type:"text",class:"w-full border rounded px-2 py-2 text-sm",placeholder:"Value..."},null,40,Pe)),g(A,{"all-steps-before":d.allStepsBefore,"loop-context-schema":d.loopContextSchema,onInsert:a=>Q(o,a)},null,8,["all-steps-before","loop-context-schema","onInsert"])])]))),128))])):m("",!0)])],64)):m("",!0),n.value.action_type==="CHECK_MILESTONE_COMPLETION"?(r(),u("div",Ve,e[18]||(e[18]=[s("p",{class:"font-semibold"},"This is a smart action.",-1),s("p",null,"It will automatically use the context from the trigger to check if all tasks in the milestone are complete. If so, it will mark the milestone as completed.",-1)]))):m("",!0)])):m("",!0)]),_:1},8,["onDelete"]))}};export{et as default};
