import{D as oe,E as Le,l as $,r as i,m as ie,c as d,o as n,a as o,e as a,k as y,f as R,g as f,X as ne,q as F,t as N,w as _,u as re,z as de,v as Ce,H as he,F as we,s as A}from"./app-DBy4gMm0.js";import{_ as m}from"./InputLabel-lP2I98ov.js";import{_ as q}from"./TextInput-B7DxLwZZ.js";import{_ as D}from"./InputError-BYDmaKb3.js";import{C as ue}from"./CustomMultiSelect-DQ3I0t5a.js";import{_ as Q}from"./PrimaryButton-BJ7HNQHV.js";import{_ as K}from"./SecondaryButton-CYN5Cc4x.js";import{S as Y}from"./SelectDropdown-BcA2DM2i.js";import{_ as Ve}from"./EmailEditor-oZ5W8CZu.js";import{_ as me}from"./Modal-BxM6YtRz.js";import{u as Ie}from"./useEmailSignature-j1HuaR-W.js";import{u as $e}from"./useEmailTemplate-ajheb0yN.js";import{_ as Ne}from"./_plugin-vue_export-helper-DlAUqK2U.js";/* empty css                                                                       */import"./EmailEditor.vue_vue_type_style_index_0_lang-9ZiqOgFs.js";const Ue={class:"space-y-4"},Ee={key:0,class:"flex gap-3 items-center mb-2"},Se={class:"inline-flex items-center"},Te={key:0,class:"inline-flex items-center"},He={key:1,class:"mb-4 space-y-3"},Me={key:0,class:"text-gray-500 text-sm mt-1"},Be={key:0,class:"text-gray-500 text-sm"},Pe={key:1,class:"text-red-500 text-sm"},Re={key:2,class:"mb-4 space-y-4"},Fe={key:0,class:"text-gray-500 text-sm mt-1"},Ae={key:0,class:"text-gray-500 text-sm"},qe={key:1,class:"text-red-500 text-sm"},De={class:"mb-4"},Ke={class:"mb-6"},Oe={class:"mb-2 flex justify-end space-x-2"},ze={class:"mb-4"},We={key:0,class:"mt-2"},Ge={class:"text-gray-700 text-base mb-2"},Xe=["innerHTML"],Je={class:"flex justify-end gap-2 pt-2 border-t border-gray-100"},Qe={class:"p-6"},Ye={key:0,class:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4",role:"alert"},Ze={class:"block sm:inline"},et={class:"mb-4"},tt={class:"mb-6"},lt={class:"flex justify-end space-x-3"},st={class:"p-6"},at={key:0,class:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4",role:"alert"},ot={class:"block sm:inline"},it={class:"mb-4"},nt={class:"mb-6"},rt={class:"flex justify-end space-x-3"},dt={__name:"CustomComposeEmailContent",props:{projectId:{type:[Number,String],required:!1,default:null},userProjectRole:{type:Object,required:!1,default:()=>({})},forceRecipientMode:{type:String,required:!1,default:null},presetLeadIds:{type:Array,required:!1,default:()=>[]},hideRecipientControls:{type:Boolean,required:!1,default:!1}},emits:["submitted","error"],setup(O,{emit:ce}){const u=O,Z=ce,s=oe({project_id:u.projectId!==null?Number(u.projectId):null,client_ids:[],lead_ids:[],subject:"",body:"",status:"pending_approval"}),c=oe({client_ids:null,subject:null,body:null}),{canDo:pe}=Le(),ee=$(()=>pe("contact_lead").value),p=i("clients");u.forceRecipientMode==="leads"&&(p.value="leads");const U=i([]),E=i(!1),te=$(()=>(U.value||[]).map(l=>({value:l.id,label:l.name}))),S=i([]),z=i(!1),T=i(""),H=i([]),W=i(!1),M=i(""),x=i("full_name"),j=i(""),ve=i([{value:"full_name",label:"Full Name"},{value:"first_name",label:"First Name"},{value:"last_name",label:"Last Name"},{value:"custom",label:"Custom"}]),{userSignature:le}=Ie($(()=>u.userProjectRole)),fe=$(()=>s.body||""),{processedHtmlBody:_e}=$e(fe),se=$(()=>{if(p.value==="leads"&&s.lead_ids&&s.lead_ids.length>0){const l=s.lead_ids[0],e=H.value.find(t=>t.id===l);if(e){const t=(e.first_name?e.first_name+" ":"")+(e.last_name||""),r=t.trim().split(" ").filter(Boolean),k=r[0]||"",P=r.length>1?r[r.length-1]:"",v=t.trim()||e.company||"there";switch(x.value){case"full_name":return`Hi ${v},`;case"first_name":return`Hi ${k||v},`;case"last_name":return`Hi ${P||v},`;case"custom":return`Hi ${j.value.trim()||"there"},`;default:return`Hi ${v},`}}}else if(s.client_ids&&s.client_ids.length>0){const l=s.client_ids[0],e=S.value.find(t=>t.id===l);if(e){const t=e.name.split(" ").filter(Boolean),r=t[0]||"",k=t.length>1?t[t.length-1]:"";switch(x.value){case"full_name":return`Hi ${e.name},`;case"first_name":return`Hi ${r},`;case"last_name":return`Hi ${k},`;case"custom":return`Hi ${j.value.trim()||"there"},`;default:return`Hi ${e.name},`}}}return"Hi there,"}),L=i(!1),b=i(""),C=i(""),g=i(""),h=i(!1),w=i(""),B=i("bullet"),V=i("");function ye(){c.client_ids=null,c.subject=null,c.body=null}async function G(){var l,e;if(!s.project_id){S.value=[];return}z.value=!0,T.value="";try{const t=await A.get(`/api/projects/${s.project_id}/sections/clients?type=clients`);S.value=t.data}catch(t){console.error("Failed to fetch project clients:",t),T.value=((e=(l=t.response)==null?void 0:l.data)==null?void 0:e.message)||"Failed to load client data."}finally{z.value=!1}}async function X(){var l,e;W.value=!0,M.value="";try{const{data:t}=await A.get("/api/leads",{params:{per_page:100}}),r=(t==null?void 0:t.data)??t;H.value=Array.isArray(r)?r:[]}catch(t){console.error("Failed to fetch leads:",t),M.value=((e=(l=t.response)==null?void 0:l.data)==null?void 0:e.message)||"Failed to load leads."}finally{W.value=!1}}async function ae(){E.value=!0;try{const l=await A.get("/api/projects-simplified");U.value=l.data||[]}catch(l){console.error("Failed to fetch projects:",l)}finally{E.value=!1}}ie(()=>u.projectId,l=>{s.project_id=l!==null?Number(l):null,s.client_ids=[],s.lead_ids=[],p.value==="clients"?(U.value.length||ae(),G()):(X(),U.value.length||ae())},{immediate:!0}),ie(()=>[u.forceRecipientMode,u.presetLeadIds],()=>{u.forceRecipientMode==="leads"&&Array.isArray(u.presetLeadIds)&&u.presetLeadIds.length&&(s.lead_ids=[...u.presetLeadIds],H.value.length||X())},{immediate:!0});const be=()=>{b.value="",C.value="",g.value="",L.value=!0},J=()=>{if(!b.value.trim()){g.value="Link text cannot be empty.";return}let l=C.value.trim();!l.startsWith("http://")&&!l.startsWith("https://")&&(l="http://"+l);try{new URL(l)}catch{g.value="Please enter a valid URL (e.g., https://example.com or www.example.com).";return}const e=`[${b.value.trim()}] {${l}}`;s.body+=e,L.value=!1,b.value="",C.value="",g.value=""},ge=()=>{w.value="",B.value="bullet",V.value="",h.value=!0},ke=()=>{const l=w.value.split(`
`).map(r=>r.trim()).filter(Boolean);if(l.length===0){V.value="Please enter at least one list item.";return}const e=B.value==="bullet"?"ul":"ol";let t=`<${e}>`;l.forEach(r=>{t+=`<li>${r}</li>`}),t+=`</${e}>`,s.body+=t,h.value=!1,w.value="",V.value=""};function xe(){const l={...s};if(p.value==="clients"){if(!l.project_id)return c.client_ids="Please select a project first.",null;l.client_ids=(l.client_ids||[]).map(e=>({id:e})),l.lead_ids=[]}else l.lead_ids=(l.lead_ids||[]).map(e=>({id:e})),l.client_ids=[],u.projectId||(l.project_id=l.project_id?Number(l.project_id):null);return l.body=_e.value,l.greeting_name=se.value,l.custom_greeting_name=j.value.trim(),l.first_client_id=s.client_ids&&s.client_ids.length?s.client_ids[0]:null,l}async function je(){var l,e,t,r,k,P;ye();try{const v=xe();if(!v)return;await A.post("/api/emails",v),Z("submitted")}catch(v){console.error("Failed to submit email:",v);const I=(e=(l=v.response)==null?void 0:l.data)==null?void 0:e.errors;I&&(c.client_ids=((t=I.client_ids)==null?void 0:t[0])||((r=I.recipient)==null?void 0:r[0])||null,c.subject=((k=I.subject)==null?void 0:k[0])||null,c.body=((P=I.body)==null?void 0:P[0])||null),Z("error",v)}}return(l,e)=>(n(),d(we,null,[o("div",Ue,[O.hideRecipientControls?y("",!0):(n(),d("div",Ee,[o("label",Se,[R(o("input",{type:"radio",class:"mr-2",value:"clients","onUpdate:modelValue":e[0]||(e[0]=t=>p.value=t),onChange:e[1]||(e[1]=()=>{s.client_ids=[],s.lead_ids=[],p.value==="clients"&&G()})},null,544),[[ne,p.value]]),e[20]||(e[20]=f(" Clients ",-1))]),ee.value?(n(),d("label",Te,[R(o("input",{type:"radio",class:"mr-2",value:"leads","onUpdate:modelValue":e[2]||(e[2]=t=>p.value=t),onChange:e[3]||(e[3]=()=>{s.client_ids=[],s.lead_ids=[],p.value==="leads"&&X()})},null,544),[[ne,p.value]]),e[21]||(e[21]=f(" Leads ",-1))])):y("",!0)])),p.value==="clients"?(n(),d("div",He,[o("div",null,[a(m,{for:"client_project",value:"Select Project"}),E.value?(n(),d("div",Me,"Loading projects...")):(n(),F(Y,{key:1,id:"client_project",modelValue:s.project_id,"onUpdate:modelValue":[e[4]||(e[4]=t=>s.project_id=t),G],options:te.value,"value-key":"value","label-key":"label",placeholder:"Choose a project",class:"mt-1 w-full"},null,8,["modelValue","options"]))]),a(m,{for:"client_ids",value:"To (Clients)"}),z.value?(n(),d("div",Be,"Loading clients...")):T.value?(n(),d("div",Pe,N(T.value),1)):(n(),F(ue,{key:2,modelValue:s.client_ids,"onUpdate:modelValue":e[5]||(e[5]=t=>s.client_ids=t),options:S.value,placeholder:"Select one or more clients","label-key":"name","value-key":"id"},null,8,["modelValue","options"])),a(D,{message:c.client_ids,class:"mt-2"},null,8,["message"])])):ee.value?(n(),d("div",Re,[o("div",null,[a(m,{for:"lead_project",value:"Select Project (optional)"}),E.value?(n(),d("div",Fe,"Loading projects...")):(n(),F(Y,{key:1,id:"lead_project",modelValue:s.project_id,"onUpdate:modelValue":e[6]||(e[6]=t=>s.project_id=t),options:te.value,"value-key":"value","label-key":"label",placeholder:"Choose a project or leave empty",class:"mt-1 w-full"},null,8,["modelValue","options"])),e[22]||(e[22]=o("p",{class:"text-xs text-gray-500 mt-1"},"If not selected, backend will default to the Project::LEADS project.",-1))]),a(m,{for:"lead_ids",value:"To (Leads)"}),W.value?(n(),d("div",Ae,"Loading leads...")):M.value?(n(),d("div",qe,N(M.value),1)):O.hideRecipientControls?y("",!0):(n(),F(ue,{key:2,modelValue:s.lead_ids,"onUpdate:modelValue":e[7]||(e[7]=t=>s.lead_ids=t),options:H.value,placeholder:"Select one or more leads","label-key":"full_name","value-key":"id"},null,8,["modelValue","options"])),a(D,{message:c.client_ids,class:"mt-2"},null,8,["message"])])):y("",!0),o("div",De,[a(m,{for:"subject",value:"Subject"}),a(q,{id:"subject",type:"text",class:"mt-1 block w-full",modelValue:s.subject,"onUpdate:modelValue":e[8]||(e[8]=t=>s.subject=t),required:""},null,8,["modelValue"]),a(D,{message:c.subject,class:"mt-2"},null,8,["message"])]),o("div",Ke,[o("div",Oe,[a(K,{type:"button",onClick:ge},{default:_(()=>e[23]||(e[23]=[f("Insert List",-1)])),_:1,__:[23]}),a(K,{type:"button",onClick:be},{default:_(()=>e[24]||(e[24]=[f("Insert Link",-1)])),_:1,__:[24]})]),o("div",ze,[a(m,{for:"greeting_type",value:"Address Client By"}),a(Y,{id:"greeting_type",modelValue:x.value,"onUpdate:modelValue":e[9]||(e[9]=t=>x.value=t),options:ve.value,"value-key":"value","label-key":"label",class:"mt-1 block w-full"},null,8,["modelValue","options"]),x.value==="custom"?(n(),d("div",We,[a(m,{for:"custom_greeting_name",value:"Custom Name"}),a(q,{id:"custom_greeting_name",type:"text",class:"mt-1 block w-full",modelValue:j.value,"onUpdate:modelValue":e[10]||(e[10]=t=>j.value=t),placeholder:"e.g., Azaan"},null,8,["modelValue"])])):y("",!0)]),o("p",Ge,N(se.value),1),a(m,{for:"body",value:"Email Body",class:"sr-only"}),a(Ve,{id:"body",modelValue:s.body,"onUpdate:modelValue":e[11]||(e[11]=t=>s.body=t),placeholder:"Compose your email here...",height:"300px"},null,8,["modelValue"]),a(D,{message:c.body,class:"mt-2"},null,8,["message"])]),re(le)?(n(),d("div",{key:3,class:"unselectable-signature",innerHTML:re(le)},null,8,Xe)):y("",!0),o("div",Je,[a(Q,{onClick:je},{default:_(()=>e[25]||(e[25]=[f("Submit for Approval",-1)])),_:1,__:[25]})])]),a(me,{show:L.value,onClose:e[15]||(e[15]=t=>L.value=!1),"max-width":"md"},{default:_(()=>[o("div",Qe,[e[28]||(e[28]=o("h3",{class:"text-lg font-medium text-gray-900 mb-4"},"Insert Link",-1)),g.value?(n(),d("div",Ye,[o("span",Ze,N(g.value),1)])):y("",!0),o("div",et,[a(m,{for:"link_text",value:"Link Text"}),a(q,{id:"link_text",type:"text",class:"mt-1 block w-full",modelValue:b.value,"onUpdate:modelValue":e[12]||(e[12]=t=>b.value=t),onKeyup:de(J,["enter"])},null,8,["modelValue"])]),o("div",tt,[a(m,{for:"link_url",value:"URL"}),a(q,{id:"link_url",type:"text",class:"mt-1 block w-full",modelValue:C.value,"onUpdate:modelValue":e[13]||(e[13]=t=>C.value=t),placeholder:"e.g., https://www.example.com",onKeyup:de(J,["enter"])},null,8,["modelValue"])]),o("div",lt,[a(K,{onClick:e[14]||(e[14]=t=>L.value=!1)},{default:_(()=>e[26]||(e[26]=[f("Cancel",-1)])),_:1,__:[26]}),a(Q,{onClick:J},{default:_(()=>e[27]||(e[27]=[f("Insert",-1)])),_:1,__:[27]})])])]),_:1},8,["show"]),a(me,{show:h.value,onClose:e[19]||(e[19]=t=>h.value=!1),"max-width":"md"},{default:_(()=>[o("div",st,[e[32]||(e[32]=o("h3",{class:"text-lg font-medium text-gray-900 mb-4"},"Insert List",-1)),V.value?(n(),d("div",at,[o("span",ot,N(V.value),1)])):y("",!0),o("div",it,[a(m,{for:"list_items",value:"List Items (one per line)"}),R(o("textarea",{id:"list_items",rows:"6",class:"border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 rounded-md shadow-sm mt-1 block w-full","onUpdate:modelValue":e[16]||(e[16]=t=>w.value=t),placeholder:"Enter each list item on a new line"},null,512),[[Ce,w.value]])]),o("div",nt,[a(m,{for:"list_type",value:"List Type"}),R(o("select",{id:"list_type",class:"border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 rounded-md shadow-sm mt-1 block w-full","onUpdate:modelValue":e[17]||(e[17]=t=>B.value=t)},e[29]||(e[29]=[o("option",{value:"bullet"},"Bulleted List",-1),o("option",{value:"numbered"},"Numbered List",-1)]),512),[[he,B.value]])]),o("div",rt,[a(K,{onClick:e[18]||(e[18]=t=>h.value=!1)},{default:_(()=>e[30]||(e[30]=[f("Cancel",-1)])),_:1,__:[30]}),a(Q,{onClick:ke},{default:_(()=>e[31]||(e[31]=[f("Insert List",-1)])),_:1,__:[31]})])])]),_:1},8,["show"])],64))}},ht=Ne(dt,[["__scopeId","data-v-282a2d31"]]);export{ht as default};
