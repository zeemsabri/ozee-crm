import{u as me}from"./workflowStore-BIN1OJBV.js";import ce from"./StepCard-DX5Q96qv.js";import{S as P}from"./SelectDropdown-NcnKkYwS.js";import{_ as de}from"./RelationshipPathPicker-C4koGIUV.js";import{T as ve}from"./trash-CsF3ICac.js";import{P as ye}from"./plus-DVV8RatJ.js";import{l as C,q,o as g,w as ge,a as p,n as N,c as b,F as H,i as ae,k as E,e as O,t as oe,u as ne,g as fe}from"./app-CdAy66B_.js";import"./createLucideIcon-C35i-icL.js";import"./x-GToanPWG.js";/* empty css                                                                       */import"./_plugin-vue_export-helper-DlAUqK2U.js";const _e={class:"flex flex-col space-y-3 text-md p-2 bg-gray-50 rounded-md"},be={class:"flex items-center gap-2 bg-gray-100 p-1 rounded-md"},he={class:"space-y-2"},xe={class:"flex items-start gap-2"},we={class:"flex-1 space-y-2"},Te={class:"flex items-center gap-2"},$e=["title"],Ce={key:1,class:"col-span-2 mt-1 px-1"},Se=["value","onInput"],Ae={key:2,class:"grid grid-cols-2 gap-2"},Re=["value","onChange"],Ne=["value"],De=["value","onChange"],Ie=["type","value","onInput"],Fe=["onClick","disabled"],Le={class:"mt-2 flex items-center justify-end"},ke=["onClick","disabled"],We={__name:"ConditionStep",props:{step:{type:Object,required:!0},allStepsBefore:{type:Array,default:()=>[]},loopContextSchema:{type:Object,default:null}},emits:["update:step","delete"],setup(G,{emit:se}){const f=G,j=se,W=me(),D=C(()=>W.automationSchema||[]),re=C(()=>W.morphMap||[]),I=C(()=>{var u,i;if(f.loopContextSchema&&Array.isArray(f.loopContextSchema.columns)&&f.loopContextSchema.columns.length)return f.loopContextSchema;const e=[...f.allStepsBefore].reverse().find(r=>{var o;return r.step_type==="FOR_EACH"&&((o=r.step_config)==null?void 0:o.sourceArray)});if(!e)return null;const a=e.step_config.sourceArray,t=typeof a=="string"?a.match(/{{step_(\w+)\.(.+)}}/):null;if(!t)return null;const n=t[1],l=t[2],s=f.allStepsBefore.find(r=>String(r.id)===String(n));if((s==null?void 0:s.step_type)==="AI_PROMPT"){const r=(((u=s.step_config)==null?void 0:u.responseStructure)||[]).find(o=>o.name===l);if((r==null?void 0:r.type)==="Array of Objects")return{name:"Loop Item",columns:r.schema||[]}}if((s==null?void 0:s.step_type)==="FETCH_RECORDS"&&l==="records"){const r=(i=s.step_config)==null?void 0:i.model,o=(D.value||[]).find(d=>d.name===r);if(o)return{name:"Loop Item",columns:(o.columns||[]).map(_=>typeof _=="string"?{name:_}:_)}}return null}),m=C({get:()=>{const e=f.step.step_config||{};return Array.isArray(e.rules)||(e.rules=[{}]),e.logic||(e.logic="AND"),e},set:e=>j("update:step",{...f.step,step_config:e})});function x(e,a,t){const n=[...m.value.rules],l={...n[e]};a==="field"?(l.left={type:"var",path:t},delete l.operator,delete l.right):a==="operator"?(l.operator=t,delete l.right):a==="json_path"?l.json_path=t:a==="value"&&(l.right={type:"literal",value:t}),n[e]=l,m.value={...m.value,rules:n}}function ue(){const e=[...m.value.rules,{}];m.value={...m.value,rules:e}}function z(e){const a=m.value.rules.filter((t,n)=>n!==e);m.value={...m.value,rules:a}}function J(e){m.value={...m.value,logic:e}}function c(e){var a;return((a=e==null?void 0:e.left)==null?void 0:a.path)||""}function V(e){return(e==null?void 0:e.operator)||""}function F(e){var a;return((a=e==null?void 0:e.right)==null?void 0:a.value)??null}function B(e){return!e||typeof e!="string"?"":e.replace(/{{|}}/g,"")}const K=C(()=>f.allStepsBefore.find(e=>["TRIGGER","SCHEDULE_TRIGGER"].includes(e.step_type))),Y=C(()=>{var t,n;const e=[];I.value&&Array.isArray(I.value.columns)&&(I.value.columns.filter(l=>!!(l!=null&&l.name)).forEach(l=>{e.push({value:`{{loop.item.${l.name}}}`,name:`{{loop.item.${l.name}}}`,label:`Loop Item: ${l.label||l.name}`,type:l.type||"Text",group:"Current Loop Item",allowed_values:l.allowed_values||null})}),e.push({value:"{{loop.index}}",name:"{{loop.index}}",label:"Loop: index",type:"Number",group:"Loop Details"}),e.push({value:"{{loop.is_first}}",name:"{{loop.is_first}}",label:"Loop: is_first",type:"True/False",group:"Loop Details"}),e.push({value:"{{loop.is_last}}",name:"{{loop.is_last}}",label:"Loop: is_last",type:"True/False",group:"Loop Details"})),e.push({value:"triggering_object_id",name:"triggering_object_id",label:"Triggering Object ID",type:"Number",group:"Workflow Context"});const a=(n=(t=K.value)==null?void 0:t.step_config)==null?void 0:n.model;if(a){const l=D.value.find(s=>s.name===a);if(l){const s=(a.split("\\").pop()||"").toLowerCase();(l.columns||[]).forEach(u=>{const i=typeof u=="string"?{name:u}:u;e.push({value:`trigger.${s}.${i.name}`,name:`trigger.${s}.${i.name}`,label:`${a}: ${i.label||i.name}`,type:i.type||"Text",group:"Trigger Data",allowed_values:i.allowed_values})})}}else K.value&&(e.push({value:"trigger.user.id",name:"trigger.user.id",label:"Triggering User ID",type:"Number",group:"Trigger Data"}),e.push({value:"trigger.email.type",name:"trigger.email.type",label:"Trigger Email Type",type:"Text",group:"Trigger Data"}),e.push({value:"trigger.email.status",name:"trigger.email.status",label:"Trigger Email Status",type:"Text",group:"Trigger Data"}));return f.allStepsBefore.forEach((l,s)=>{var _,h,y,ee,te;const u=l.name||`Step ${s+1}`;let i=l.step_type.split("_").pop().toLowerCase();l.step_type==="AI_PROMPT"?i="AI":l.step_type==="FETCH_RECORDS"?i="Fetch":l.step_type==="ACTION"&&((_=l.step_config)==null?void 0:_.action_type)==="FETCH_API_DATA"&&(i="API");const r=`${u} (${i})`,o=R=>{const S=String((R==null?void 0:R.type)||"").toLowerCase();return S==="array of objects"||S==="array"||S==="collection"},d=(R,S="",le=0)=>{(R||[]).forEach(v=>{if(!(v!=null&&v.name))return;const $=S?`${S}.${v.name}`:v.name,U="  ".repeat(le);e.push({value:`step_${l.id}.${$}`,name:`step_${l.id}.${$}`,label:`${r}: ${U}${v.name}`,type:v.type,group:`${u}: ${l.name||l.step_type}`,allowed_values:v.allowed_values||null}),Array.isArray(v.schema)&&(o(v)?(e.push({value:`step_${l.id}.${$}.count`,name:`step_${l.id}.${$}.count`,label:`${r}: ${U}${v.name} (Count)`,type:"Number",group:`${u}: ${l.name||l.step_type}`}),v.schema.forEach(w=>{w!=null&&w.name&&e.push({value:`step_${l.id}.${$}.${w.name}`,name:`step_${l.id}.${$}.${w.name}`,label:`${r}: ${U}  - ${w.name} (from array)`,type:w.type||"Text",group:`${u}: ${l.name||l.step_type}`,allowed_values:w.allowed_values||null})})):v.type==="Object"&&d(v.schema,$,le+1))})};(l.step_type==="AI_PROMPT"||l.step_type==="ACTION"&&((h=l.step_config)==null?void 0:h.action_type)==="FETCH_API_DATA")&&((ee=(y=l.step_config)==null?void 0:y.responseStructure)==null?void 0:ee.length)>0&&d(l.step_config.responseStructure),l.step_type==="FETCH_RECORDS"&&e.push({value:`step_${l.id}.count`,name:`step_${l.id}.count`,label:`${l.name||((te=l.step_config)!=null&&te.model?`${l.step_config.model}`:`Step ${s+1}`)} (Fetch): Count`,type:"Number",group:`${u}: ${l.name||l.step_type}`})}),e});function T(e){return e?Y.value.find(a=>a.value===e||a.name===e)||{name:e,value:e,label:e,type:"Text"}:null}function A(e){return!e||typeof e!="string"?!1:e.startsWith("{{")}function M(e){return!e||typeof e!="string"?!1:B(e).endsWith("_type")}const Q=C(()=>(re.value||[]).map(e=>({value:e.alias,label:e.label||e.alias})));function L(e){var o;if(!e||typeof e!="string")return null;const t=B(e).split(".");if(!t.length)return null;if(t[0]==="loop"){if(t[1]==="item"&&t.length>=3){const d=t.slice(2).join("."),h=(((o=I.value)==null?void 0:o.columns)||[]).map(y=>typeof y=="string"?{name:y}:y).find(y=>y.name===d);return h?{type:h.type||"Text",allowed_values:h.allowed_values||null}:{type:"Text",allowed_values:null}}return t[1]==="index"?{type:"Number",allowed_values:null}:t[1]==="is_first"||t[1]==="is_last"?{type:"True/False",allowed_values:null}:{type:"Text",allowed_values:null}}let n=0,l=t[n++],s=null;l.toLowerCase()==="trigger"?s=(t[n++]||"").toLowerCase():s=l.toLowerCase();let u=(D.value||[]).find(d=>(d.name||"").toLowerCase()===s)||null;if(!u)return null;for(;n<t.length-1;n++){const d=t[n],_=(u.relationships||[]).find(y=>y.name===d);if(!_)return null;if(_.type==="MorphTo")return{type:"Text",allowed_values:null};const h=(D.value||[]).find(y=>y.full_class===_.full_class||y.name===_.model);if(!h)return null;u=h}const i=t[t.length-1],r=(u.columns||[]).find(d=>typeof d=="string"?d===i:d.name===i);return r?typeof r=="string"?{type:"Text",allowed_values:null}:{type:r.type||"Text",allowed_values:r.allowed_values||null}:{type:"Text",allowed_values:null}}function ie(e){var n;const a=c(e);if(M(a))return[{value:"==",label:"is"},{value:"!=",label:"is not"}];if(A(a)){const s=(L(a)||{}).type||"Text";return k[s]||k.Text}const t=(n=T(a))==null?void 0:n.type;return k[t]||k.Text}const k={json:[{value:"==",label:"is"},{value:"!=",label:"is not"},{value:"contains",label:"contains"},{value:"not_empty",label:"is not empty"},{value:"empty",label:"is empty"},{value:"is_null",label:"is null"},{value:"is_not_null",label:"is not null"}],jsonb:[{value:"==",label:"is"},{value:"!=",label:"is not"},{value:"contains",label:"contains"},{value:"not_empty",label:"is not empty"},{value:"empty",label:"is empty"},{value:"is_null",label:"is null"},{value:"is_not_null",label:"is not null"}],Array:[{value:"==",label:"is"},{value:"!=",label:"is not"},{value:"contains",label:"contains"},{value:"not_empty",label:"is not empty"},{value:"empty",label:"is empty"},{value:"is_null",label:"is null"},{value:"is_not_null",label:"is not null"}],"Array of Objects":[{value:"==",label:"is"},{value:"!=",label:"is not"},{value:"contains",label:"contains"},{value:"not_empty",label:"is not empty"},{value:"empty",label:"is empty"},{value:"is_null",label:"is null"},{value:"is_not_null",label:"is not null"}],"True/False":[{value:"==",label:"is"},{value:"!=",label:"is not"}],Number:[{value:"==",label:"equals"},{value:"!=",label:"does not equal"},{value:">",label:"is greater than"},{value:"<",label:"is less than"},{value:">=",label:"is greater than or equal to"},{value:"<=",label:"is less than or equal to"}],Date:[{value:"==",label:"is on"},{value:">",label:"is after"},{value:"<",label:"is before"},{value:"in_past",label:"is in the past"},{value:"in_future",label:"is in the future"},{value:"today",label:"is today"}],DateTime:[{value:"==",label:"is on"},{value:">",label:"is after"},{value:"<",label:"is before"},{value:"in_past",label:"is in the past"},{value:"in_future",label:"is in the future"},{value:"today",label:"is today"}],Text:[{value:"==",label:"is"},{value:"!=",label:"is not"},{value:"contains",label:"contains"},{value:"not_empty",label:"is not empty"},{value:"empty",label:"is empty"}]};function X(e){const a=String(e||"").toLowerCase();return!["","empty","not_empty","in_past","in_future","today"].includes(a)}function Z(e){var t;const a=c(e);if(M(a))return Q.value;if(A(a)){const n=L(a);return(n==null?void 0:n.allowed_values)||null}return((t=T(a))==null?void 0:t.allowed_values)||null}function pe(e){if(A(e)){const t=L(e)||{};return t.type==="Date"?"date":t.type==="DateTime"?"datetime-local":t.type==="Number"?"number":"text"}const a=T(e);return a?a.type==="Date"?"date":a.type==="DateTime"?"datetime-local":a.type==="Number"?"number":"text":"text"}return(e,a)=>(g(),q(ce,{icon:"ðŸ”€",title:f.step.name||"If/Else Condition",onDelete:()=>j("delete"),"onUpdate:title":a[2]||(a[2]=t=>j("update:step",{...f.step,name:t}))},{default:ge(()=>[p("div",_e,[p("div",be,[p("button",{onClick:a[0]||(a[0]=t=>J("AND")),class:N([[m.value.logic==="AND"?"bg-white shadow-sm text-gray-800":"bg-transparent text-gray-500 hover:bg-gray-200"],"flex-1 py-1 px-2 text-sm font-medium rounded-md transition-colors duration-150"])}," If ALL are true ",2),p("button",{onClick:a[1]||(a[1]=t=>J("OR")),class:N([[m.value.logic==="OR"?"bg-white shadow-sm text-gray-800":"bg-transparent text-gray-500 hover:bg-gray-200"],"flex-1 py-1 px-2 text-sm font-medium rounded-md transition-colors duration-150"])}," If ANY are true ",2)]),p("div",he,[(g(!0),b(H,null,ae(m.value.rules,(t,n)=>{var l,s,u,i,r;return g(),b("div",{key:n,class:"p-2 border rounded-md bg-white"},[p("div",xe,[p("div",we,[p("div",Te,[O(P,{"model-value":c(t),options:Y.value,"group-by":"group",placeholder:"Select field...","onUpdate:modelValue":o=>x(n,"field",o),class:"w-full"},null,8,["model-value","options","onUpdate:modelValue"]),O(de,{mode:"field","all-steps-before":G.allStepsBefore,value:c(t),onSelect:o=>x(n,"field",o)},null,8,["all-steps-before","value","onSelect"])]),A(c(t))?(g(),b("p",{key:0,class:"text-[11px] text-gray-600 font-mono mt-1 px-2 py-1 bg-gray-50 rounded overflow-hidden break-words",title:c(t)}," Path: "+oe(B(c(t))),9,$e)):E("",!0),((l=T(c(t)))==null?void 0:l.type)==="json"||((s=T(c(t)))==null?void 0:s.type)==="jsonb"||((u=T(c(t)))==null?void 0:u.type)==="Array"?(g(),b("div",Ce,[a[3]||(a[3]=p("label",{class:"block text-[10px] font-medium text-gray-500 mb-1"},"Nested JSON Path (optional)",-1)),p("input",{type:"text",value:t.json_path||"",onInput:o=>x(n,"json_path",o.target.value),placeholder:"e.g. metadata.key or address.city",class:"w-full border border-gray-300 rounded-md px-2 py-1.5 text-xs bg-gray-50"},null,40,Se)])):E("",!0),c(t)?(g(),b("div",Ae,[p("select",{value:V(t),onChange:o=>x(n,"operator",o.target.value),class:N(["p-2 border border-gray-300 rounded-md bg-white shadow-sm text-sm",{"col-span-2":!X(V(t))}])},[a[4]||(a[4]=p("option",{value:"",disabled:""},"Select condition...",-1)),(g(!0),b(H,null,ae(ie(t),o=>(g(),b("option",{key:o.value,value:o.value},oe(o.label),9,Ne))),128))],42,Re),X(V(t))?(g(),b(H,{key:0},[M(c(t))?(g(),q(P,{key:0,options:Q.value,"model-value":F(t),placeholder:"Select type...","onUpdate:modelValue":o=>x(n,"value",o)},null,8,["options","model-value","onUpdate:modelValue"])):Z(t)?(g(),q(P,{key:1,options:(Z(t)||[]).map(o=>({value:o.value,label:o.label})),"model-value":F(t),placeholder:"Select value...","onUpdate:modelValue":o=>x(n,"value",o)},null,8,["options","model-value","onUpdate:modelValue"])):(A(c(t))?((i=L(c(t)))==null?void 0:i.type)==="True/False":((r=T(c(t)))==null?void 0:r.type)==="True/False")?(g(),b("select",{key:2,value:F(t)??"true",onChange:o=>x(n,"value",o.target.value),class:"p-2 border border-gray-300 rounded-md bg-white shadow-sm text-sm"},a[5]||(a[5]=[p("option",{value:"true"},"True",-1),p("option",{value:"false"},"False",-1)]),40,De)):(g(),b("input",{key:3,type:pe(c(t)),value:F(t)||"",onInput:o=>x(n,"value",o.target.value),placeholder:"Value...",class:"p-2 border border-gray-300 rounded-md bg-white shadow-sm text-sm"},null,40,Ie))],64)):E("",!0)])):E("",!0)]),p("button",{onClick:o=>z(n),class:N(["p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-full",{"opacity-50 cursor-not-allowed":m.value.rules.length<=1}]),title:"Remove condition","aria-label":"Remove condition",disabled:m.value.rules.length<=1},[O(ne(ve),{class:"w-4 h-4"})],10,Fe)]),p("div",Le,[p("button",{onClick:o=>z(n),class:N(["text-xs text-red-600 hover:text-red-700 hover:underline",{"opacity-50 cursor-not-allowed":m.value.rules.length<=1}]),disabled:m.value.rules.length<=1}," Remove this condition ",10,ke)])])}),128))]),p("div",null,[p("button",{onClick:ue,class:"w-full flex items-center justify-center gap-1 px-2 py-1.5 text-xs rounded-md bg-gray-100 hover:bg-gray-200 text-gray-600"},[O(ne(ye),{class:"h-3 w-3"}),a[6]||(a[6]=fe(" Add Condition ",-1))])])])]),_:1},8,["title","onDelete"]))}};export{We as default};
