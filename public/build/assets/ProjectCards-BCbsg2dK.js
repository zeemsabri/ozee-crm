import{r as p,c as z,e as S,n as $,f as G,Q as J,a as m,o as c,F as N,l as B,b as v,t as W,i as O,v as X,K as Y,V as Z,g as ee}from"./app-C_l5dlFM.js";import te from"./ProjectCard-DuDRxhZG.js";import"./currency-Ttnynh5T.js";const ae={class:"space-y-6"},ne={key:0,class:"space-y-6"},re={key:1,class:"flex justify-center items-center h-48 bg-white rounded-xl shadow-md p-6 text-red-500"},se={key:2,class:"flex justify-center items-center h-48 bg-white rounded-xl shadow-md p-6 text-gray-500"},ie={key:0,class:"bg-white rounded-xl shadow-md p-6"},oe={key:1,class:"text-center text-sm text-gray-400 py-2"},V=5,I=14400*1e3,de={__name:"ProjectCards",props:{search:{type:String,default:""},activeFilter:{type:String,default:"all"},pendingFilter:{type:String,default:"with"}},setup(L){const i=L,_=p(!0),h=p(null),o=p([]),R=z(()=>{const e=o.value||[],t=(i.activeFilter||"all").toLowerCase();return t==="manager"?e.filter(a=>a.role==="Manager"):t==="contributor"?e.filter(a=>a.role==="Contributor"):e}),l=p(1),u=p(1),w=p(!1),j=p(null);let s=null;const f=e=>{try{return e?new Date(e).toLocaleString():null}catch{return null}},P=e=>{if(e<=0||!isFinite(e))return null;const t=Math.floor(e/(3600*1e3)),a=Math.floor(e%(3600*1e3)/(60*1e3));return t>0&&a>0?`${t}h ${a}m`:t>0?`${t}h`:`${a}m`},q=e=>e&&(e==="manager"||e==="admin")?"Manager":"Contributor",T=e=>e==="active"?"on-track":e==="on_hold"?"needs-attention":e==="completed"?"on-track":"at-risk",E=e=>{var y,F,A;const t=e.current_milestone||null,a=t?`${t.progress_percent??0}% Complete`:"No active milestone",d=t?`${t.name} (${a})`:"No active milestone";let g="$8,000 / $10,000 Used";if(t&&t.budget&&t.budget.amount!=null){const n=t.budget.currency||"",C=t.budget.approved_amount??0,M=t.budget.amount??0;g=`${C}${n?" "+n:""} / ${M}${n?" "+n:""} Used`}const r={id:e.id,name:e.name,role:"Manager",health:T(e.status),alert:null,overview:{milestone:d,budget:g,status:"In Progress",latestContext:((y=e.latest_context)==null?void 0:y.summary)||null},tasks:{today:(((F=e.tasks)==null?void 0:F.today)||[]).map(n=>({id:n.id,name:n.name,status:n.status})),tomorrow:(((A=e.tasks)==null?void 0:A.tomorrow)||[]).map(n=>({id:n.id,name:n.name,status:n.status})),completed:[]},communication:{lastSent:f(e.last_email_sent)||"—",lastReceived:f(e.last_email_received)||"—",contexts:Array.isArray(e.contexts)?e.contexts.map(n=>({summary:n.summary,created_at:f(n.created_at),user:n.user||null,source_type:n.source_type||null})):[]}};if(e.last_email_received){const C=new Date(e.last_email_received).getTime();if(!isNaN(C)){const M=Date.now()-C,Q=I-M,U=P(Q);U&&(r.alert={text:`Client email from ${r.name} requires a reply.`,timer:U,incentive:"Reply in time to earn 50 points."})}}return r},H=e=>{var d,g;const t=e.current_milestone||null,a={id:e.id,name:e.name,role:"Contributor",health:T(e.status),tasks:{today:(((d=e.tasks)==null?void 0:d.today)||[]).map(r=>({id:r.id,name:r.name,status:r.status})),tomorrow:(((g=e.tasks)==null?void 0:g.tomorrow)||[]).map(r=>({id:r.id,name:r.name,status:r.status})),completed:[]},milestone:{name:(t==null?void 0:t.name)||"Current Milestone",deadline:(t==null?void 0:t.deadline)||"",progress:(t==null?void 0:t.progress_percent)??0,completed:typeof(t==null?void 0:t.tasks_done)=="number"?t.tasks_done:null,left:typeof(t==null?void 0:t.tasks_total)=="number"&&typeof(t==null?void 0:t.tasks_done)=="number"?Math.max(0,t.tasks_total-t.tasks_done):null,incentive:""},communication:{lastSent:f(e.last_email_sent)||"—",lastReceived:f(e.last_email_received)||"—",contexts:Array.isArray(e.contexts)?e.contexts.map(r=>({summary:r.summary,created_at:f(r.created_at),user:r.user||null,source_type:r.source_type||null})):[]}};if(e.last_email_received){const y=new Date(e.last_email_received).getTime();if(!isNaN(y)){const F=Date.now()-y,A=I-F,n=P(A);n&&(a.alert={text:`Client email from ${a.name} requires a reply.`,timer:n,incentive:"Reply in time to earn 50 points."})}}return a},b=e=>q(e.role)==="Manager"?E(e):H(e),D=e=>e&&typeof e=="object"&&Array.isArray(e.data)&&typeof e.current_page<"u",k=async()=>{_.value=!0,h.value=null,l.value=1,u.value=1,o.value=[];try{const{data:e}=await window.axios.get("/api/workspace/projects",{params:{page:l.value,per_page:V,search:i.search||void 0,filter:i.activeFilter&&i.activeFilter!=="all"?i.activeFilter:void 0,pending:i.pendingFilter||"with"}}),t=e;Array.isArray(t)?(o.value=t.map(b),u.value=1,l.value=1):D(t)?(o.value=(t.data||[]).map(b),l.value=t.current_page||1,u.value=t.last_page||1):(o.value=[],u.value=1)}catch(e){console.error("Failed to load workspace projects",e),h.value="Failed to load your projects.",o.value=[],u.value=1}finally{_.value=!1}},K=async()=>{if(!(_.value||w.value)&&!(l.value>=u.value)){w.value=!0;try{const e=l.value+1,{data:t}=await window.axios.get("/api/workspace/projects",{params:{page:e,per_page:V,search:i.search||void 0,filter:i.activeFilter&&i.activeFilter!=="all"?i.activeFilter:void 0,pending:i.pendingFilter||"with"}}),a=t;if(Array.isArray(a)){const d=a.map(b);d.length&&(o.value=o.value.concat(d)),l.value=e,u.value=e}else if(D(a)){const d=(a.data||[]).map(b);o.value=o.value.concat(d),l.value=a.current_page||e,u.value=a.last_page||l.value}}catch(e){console.error("Failed to load more workspace projects",e)}finally{w.value=!1}}};function x(){s&&s.disconnect(),s=new IntersectionObserver(e=>{const t=e[0];t&&t.isIntersecting&&K()},{root:null,rootMargin:"200px",threshold:0}),j.value&&s.observe(j.value)}return S(()=>i.search,async()=>{s&&(s.disconnect(),s=null),await k(),await $(),x()}),S(()=>i.activeFilter,async()=>{s&&(s.disconnect(),s=null),await k(),await $(),x()}),S(()=>i.pendingFilter,async()=>{s&&(s.disconnect(),s=null),await k(),await $(),x()}),G(async()=>{await k(),await $(),x()}),J(()=>{s&&(s.disconnect(),s=null)}),(e,t)=>(c(),m("div",ae,[_.value?(c(),m("div",ne,[(c(),m(N,null,B(5,a=>v("div",{key:"skeleton-"+a,class:"bg-white rounded-xl shadow-md p-6"},t[0]||(t[0]=[Z('<div class="animate-pulse space-y-4"><div class="flex items-center justify-between"><div class="h-6 w-1/3 bg-gray-200 rounded"></div><div class="h-4 w-24 bg-gray-200 rounded"></div></div><div class="h-4 w-1/2 bg-gray-200 rounded"></div><div class="h-24 w-full bg-gray-200 rounded"></div></div>',1)]))),64))])):h.value?(c(),m("div",re,[v("p",null,W(h.value),1)])):R.value.length===0?(c(),m("div",se,t[1]||(t[1]=[v("p",null,"No projects to display.",-1)]))):(c(),m(N,{key:3},[(c(!0),m(N,null,B(R.value,a=>(c(),ee(te,{key:a.id,project:a},null,8,["project"]))),128)),w.value?(c(),m("div",ie,t[2]||(t[2]=[v("div",{class:"animate-pulse space-y-4"},[v("div",{class:"h-6 w-1/3 bg-gray-200 rounded"}),v("div",{class:"h-4 w-1/2 bg-gray-200 rounded"}),v("div",{class:"h-24 w-full bg-gray-200 rounded"})],-1)]))):O("",!0),X(v("div",{ref_key:"sentinel",ref:j,class:"h-2"},null,512),[[Y,l.value<u.value]]),l.value>=u.value&&o.value.length>0?(c(),m("div",oe," End of list ")):O("",!0)],64))]))}};export{de as default};
