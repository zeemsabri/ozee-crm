import{u as le}from"./workflowStore-BR1PCcyo.js";import ae from"./StepCard-DecfiN_t.js";import{S as E}from"./SelectDropdown-C5smnqto.js";import{_ as oe}from"./RelationshipPathPicker-BaBNtpQ3.js";import{T as ne}from"./trash-BRUK1WSY.js";import{P as se}from"./plus-DVAY_DV-.js";import{c as h,g as I,o as m,w as re,b as i,j as T,a as b,F as O,l as K,i as V,d as A,t as Y,u as J,m as ue}from"./app-CDr3a6VS.js";/* empty css                                                                       */import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./createLucideIcon-C7qfAF7e.js";const ie={class:"flex flex-col space-y-3 text-md p-2 bg-gray-50 rounded-md"},pe={class:"flex items-center gap-2 bg-gray-100 p-1 rounded-md"},de={class:"space-y-2"},ce={class:"flex items-start gap-2"},me={class:"flex-1 space-y-2"},fe={class:"flex items-center gap-2"},ge=["title"],ve={key:1,class:"grid grid-cols-2 gap-2"},ye=["value","onChange"],be=["value"],_e=["value","onChange"],he=["type","value","onInput"],xe=["onClick","disabled"],we={class:"mt-2 flex items-center justify-end"},Te=["onClick","disabled"],Ee={__name:"ConditionStep",props:{step:{type:Object,required:!0},allStepsBefore:{type:Array,default:()=>[]},loopContextSchema:{type:Object,default:null}},emits:["update:step","delete"],setup(j,{emit:Q}){const f=j,B=Q,M=le(),S=h(()=>M.automationSchema||[]),X=h(()=>M.morphMap||[]),C=h(()=>{var o,p;if(f.loopContextSchema&&Array.isArray(f.loopContextSchema.columns)&&f.loopContextSchema.columns.length)return f.loopContextSchema;const e=[...f.allStepsBefore].reverse().find(r=>{var g;return r.step_type==="FOR_EACH"&&((g=r.step_config)==null?void 0:g.sourceArray)});if(!e)return null;const l=e.step_config.sourceArray,t=typeof l=="string"?l.match(/{{step_(\w+)\.(.+)}}/):null;if(!t)return null;const n=t[1],a=t[2],s=f.allStepsBefore.find(r=>String(r.id)===String(n));if((s==null?void 0:s.step_type)==="AI_PROMPT"){const r=(((o=s.step_config)==null?void 0:o.responseStructure)||[]).find(g=>g.name===a);if((r==null?void 0:r.type)==="Array of Objects")return{name:"Loop Item",columns:r.schema||[]}}if((s==null?void 0:s.step_type)==="FETCH_RECORDS"&&a==="records"){const r=(p=s.step_config)==null?void 0:p.model,g=(S.value||[]).find(c=>c.name===r);if(g)return{name:"Loop Item",columns:(g.columns||[]).map(y=>typeof y=="string"?{name:y}:y)}}return null}),u=h({get:()=>{const e=f.step.step_config||{};return Array.isArray(e.rules)||(e.rules=[{}]),e.logic||(e.logic="AND"),e},set:e=>B("update:step",{...f.step,step_config:e})});function _(e,l,t){const n=[...u.value.rules],a={...n[e]};l==="field"?(a.left={type:"var",path:t},delete a.operator,delete a.right):l==="operator"?(a.operator=t,delete a.right):l==="value"&&(a.right={type:"literal",value:t}),n[e]=a,u.value={...u.value,rules:n}}function Z(){const e=[...u.value.rules,{}];u.value={...u.value,rules:e}}function U(e){const l=u.value.rules.filter((t,n)=>n!==e);u.value={...u.value,rules:l}}function q(e){u.value={...u.value,logic:e}}function d(e){var l;return((l=e==null?void 0:e.left)==null?void 0:l.path)||""}function k(e){return(e==null?void 0:e.operator)||""}function $(e){var l;return((l=e==null?void 0:e.right)==null?void 0:l.value)??null}function L(e){return!e||typeof e!="string"?"":e.replace(/{{|}}/g,"")}const G=h(()=>f.allStepsBefore.find(e=>["TRIGGER","SCHEDULE_TRIGGER"].includes(e.step_type))),H=h(()=>{var t,n;const e=[];C.value&&Array.isArray(C.value.columns)&&(C.value.columns.filter(a=>!!(a!=null&&a.name)).forEach(a=>{e.push({value:`{{loop.item.${a.name}}}`,name:`{{loop.item.${a.name}}}`,label:`Loop Item: ${a.label||a.name}`,type:a.type||"Text",group:"Current Loop Item",allowed_values:a.allowed_values||null})}),e.push({value:"{{loop.index}}",name:"{{loop.index}}",label:"Loop: index",type:"Number",group:"Loop Details"}),e.push({value:"{{loop.is_first}}",name:"{{loop.is_first}}",label:"Loop: is_first",type:"True/False",group:"Loop Details"}),e.push({value:"{{loop.is_last}}",name:"{{loop.is_last}}",label:"Loop: is_last",type:"True/False",group:"Loop Details"})),e.push({value:"triggering_object_id",name:"triggering_object_id",label:"Triggering Object ID",type:"Number",group:"Workflow Context"});const l=(n=(t=G.value)==null?void 0:t.step_config)==null?void 0:n.model;if(l){const a=S.value.find(s=>s.name===l);if(a){const s=(l.split("\\").pop()||"").toLowerCase();(a.columns||[]).forEach(o=>{const p=typeof o=="string"?{name:o}:o;e.push({value:`trigger.${s}.${p.name}`,name:`trigger.${s}.${p.name}`,label:`${l}: ${p.label||p.name}`,type:p.type||"Text",group:"Trigger Data",allowed_values:p.allowed_values})})}}else G.value&&(e.push({value:"trigger.user.id",name:"trigger.user.id",label:"Triggering User ID",type:"Number",group:"Trigger Data"}),e.push({value:"trigger.email.type",name:"trigger.email.type",label:"Trigger Email Type",type:"Text",group:"Trigger Data"}),e.push({value:"trigger.email.status",name:"trigger.email.status",label:"Trigger Email Status",type:"Text",group:"Trigger Data"}));return f.allStepsBefore.forEach((a,s)=>{var o,p;a.step_type==="AI_PROMPT"&&((p=(o=a.step_config)==null?void 0:o.responseStructure)==null?void 0:p.length)>0&&a.step_config.responseStructure.forEach(r=>{e.push({value:`step_${a.id}.${r.name}`,name:`step_${a.id}.${r.name}`,label:`Step ${s+1} (AI): ${r.name}`,type:r.type,group:`Step ${s+1}: ${a.name}`})}),a.step_type==="FETCH_RECORDS"&&e.push({value:`step_${a.id}.count`,name:`step_${a.id}.count`,label:`Step ${s+1} (Fetch): Count`,type:"Number",group:`Step ${s+1}: ${a.name}`})}),e});function R(e){return e?H.value.find(l=>l.value===e||l.name===e)||{name:e,value:e,label:e,type:"Text"}:null}function w(e){return!e||typeof e!="string"?!1:e.startsWith("{{")}function F(e){return!e||typeof e!="string"?!1:L(e).endsWith("_type")}const W=h(()=>(X.value||[]).map(e=>({value:e.alias,label:e.label||e.alias})));function D(e){var g;if(!e||typeof e!="string")return null;const t=L(e).split(".");if(!t.length)return null;if(t[0]==="loop"){if(t[1]==="item"&&t.length>=3){const c=t.slice(2).join("."),x=(((g=C.value)==null?void 0:g.columns)||[]).map(v=>typeof v=="string"?{name:v}:v).find(v=>v.name===c);return x?{type:x.type||"Text",allowed_values:x.allowed_values||null}:{type:"Text",allowed_values:null}}return t[1]==="index"?{type:"Number",allowed_values:null}:t[1]==="is_first"||t[1]==="is_last"?{type:"True/False",allowed_values:null}:{type:"Text",allowed_values:null}}let n=0,a=t[n++],s=null;a.toLowerCase()==="trigger"?s=(t[n++]||"").toLowerCase():s=a.toLowerCase();let o=(S.value||[]).find(c=>(c.name||"").toLowerCase()===s)||null;if(!o)return null;for(;n<t.length-1;n++){const c=t[n],y=(o.relationships||[]).find(v=>v.name===c);if(!y)return null;if(y.type==="MorphTo")return{type:"Text",allowed_values:null};const x=(S.value||[]).find(v=>v.full_class===y.full_class||v.name===y.model);if(!x)return null;o=x}const p=t[t.length-1],r=(o.columns||[]).find(c=>typeof c=="string"?c===p:c.name===p);return r?typeof r=="string"?{type:"Text",allowed_values:null}:{type:r.type||"Text",allowed_values:r.allowed_values||null}:{type:"Text",allowed_values:null}}function ee(e){var n;const l=d(e);if(F(l))return[{value:"==",label:"is"},{value:"!=",label:"is not"}];if(w(l)){const s=(D(l)||{}).type||"Text";return N[s]||N.Text}const t=(n=R(l))==null?void 0:n.type;return N[t]||N.Text}const N={Array:[{value:"not_empty",label:"is not empty"},{value:"empty",label:"is empty"}],"True/False":[{value:"==",label:"is"},{value:"!=",label:"is not"}],Number:[{value:"==",label:"equals"},{value:"!=",label:"does not equal"},{value:">",label:"is greater than"},{value:"<",label:"is less than"},{value:">=",label:"is greater than or equal to"},{value:"<=",label:"is less than or equal to"}],Date:[{value:"==",label:"is on"},{value:">",label:"is after"},{value:"<",label:"is before"},{value:"in_past",label:"is in the past"},{value:"in_future",label:"is in the future"},{value:"today",label:"is today"}],DateTime:[{value:"==",label:"is on"},{value:">",label:"is after"},{value:"<",label:"is before"},{value:"in_past",label:"is in the past"},{value:"in_future",label:"is in the future"},{value:"today",label:"is today"}],Text:[{value:"==",label:"is"},{value:"!=",label:"is not"},{value:"contains",label:"contains"},{value:"not_empty",label:"is not empty"},{value:"empty",label:"is empty"}]};function P(e){const l=String(e||"").toLowerCase();return!["","empty","not_empty","in_past","in_future","today"].includes(l)}function z(e){var t;const l=d(e);if(F(l))return W.value;if(w(l)){const n=D(l);return(n==null?void 0:n.allowed_values)||null}return((t=R(l))==null?void 0:t.allowed_values)||null}function te(e){if(w(e)){const t=D(e)||{};return t.type==="Date"?"date":t.type==="DateTime"?"datetime-local":t.type==="Number"?"number":"text"}const l=R(e);return l?l.type==="Date"?"date":l.type==="DateTime"?"datetime-local":l.type==="Number"?"number":"text":"text"}return(e,l)=>(m(),I(ae,{icon:"ðŸ”€",title:"If/Else Condition",onDelete:()=>B("delete")},{default:re(()=>[i("div",ie,[i("div",pe,[i("button",{onClick:l[0]||(l[0]=t=>q("AND")),class:T([[u.value.logic==="AND"?"bg-white shadow-sm text-gray-800":"bg-transparent text-gray-500 hover:bg-gray-200"],"flex-1 py-1 px-2 text-sm font-medium rounded-md transition-colors duration-150"])}," If ALL are true ",2),i("button",{onClick:l[1]||(l[1]=t=>q("OR")),class:T([[u.value.logic==="OR"?"bg-white shadow-sm text-gray-800":"bg-transparent text-gray-500 hover:bg-gray-200"],"flex-1 py-1 px-2 text-sm font-medium rounded-md transition-colors duration-150"])}," If ANY are true ",2)]),i("div",de,[(m(!0),b(O,null,K(u.value.rules,(t,n)=>{var a,s;return m(),b("div",{key:n,class:"p-2 border rounded-md bg-white"},[i("div",ce,[i("div",me,[i("div",fe,[A(E,{"model-value":d(t),options:H.value,"group-by":"group",placeholder:"Select field...","onUpdate:modelValue":o=>_(n,"field",o),class:"w-full"},null,8,["model-value","options","onUpdate:modelValue"]),A(oe,{mode:"field","all-steps-before":j.allStepsBefore,value:d(t),onSelect:o=>_(n,"field",o)},null,8,["all-steps-before","value","onSelect"])]),w(d(t))?(m(),b("p",{key:0,class:"text-[11px] text-gray-600 font-mono mt-1 px-2 py-1 bg-gray-50 rounded overflow-hidden break-words",title:d(t)}," Path: "+Y(L(d(t))),9,ge)):V("",!0),d(t)?(m(),b("div",ve,[i("select",{value:k(t),onChange:o=>_(n,"operator",o.target.value),class:T(["p-2 border border-gray-300 rounded-md bg-white shadow-sm text-sm",{"col-span-2":!P(k(t))}])},[l[2]||(l[2]=i("option",{value:"",disabled:""},"Select condition...",-1)),(m(!0),b(O,null,K(ee(t),o=>(m(),b("option",{key:o.value,value:o.value},Y(o.label),9,be))),128))],42,ye),P(k(t))?(m(),b(O,{key:0},[F(d(t))?(m(),I(E,{key:0,options:W.value,"model-value":$(t),placeholder:"Select type...","onUpdate:modelValue":o=>_(n,"value",o)},null,8,["options","model-value","onUpdate:modelValue"])):z(t)?(m(),I(E,{key:1,options:(z(t)||[]).map(o=>({value:o.value,label:o.label})),"model-value":$(t),placeholder:"Select value...","onUpdate:modelValue":o=>_(n,"value",o)},null,8,["options","model-value","onUpdate:modelValue"])):(w(d(t))?((a=D(d(t)))==null?void 0:a.type)==="True/False":((s=R(d(t)))==null?void 0:s.type)==="True/False")?(m(),b("select",{key:2,value:$(t)??"true",onChange:o=>_(n,"value",o.target.value),class:"p-2 border border-gray-300 rounded-md bg-white shadow-sm text-sm"},l[3]||(l[3]=[i("option",{value:"true"},"True",-1),i("option",{value:"false"},"False",-1)]),40,_e)):(m(),b("input",{key:3,type:te(d(t)),value:$(t)||"",onInput:o=>_(n,"value",o.target.value),placeholder:"Value...",class:"p-2 border border-gray-300 rounded-md bg-white shadow-sm text-sm"},null,40,he))],64)):V("",!0)])):V("",!0)]),i("button",{onClick:o=>U(n),class:T(["p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-full",{"opacity-50 cursor-not-allowed":u.value.rules.length<=1}]),title:"Remove condition","aria-label":"Remove condition",disabled:u.value.rules.length<=1},[A(J(ne),{class:"w-4 h-4"})],10,xe)]),i("div",we,[i("button",{onClick:o=>U(n),class:T(["text-xs text-red-600 hover:text-red-700 hover:underline",{"opacity-50 cursor-not-allowed":u.value.rules.length<=1}]),disabled:u.value.rules.length<=1}," Remove this condition ",10,Te)])])}),128))]),i("div",null,[i("button",{onClick:Z,class:"w-full flex items-center justify-center gap-1 px-2 py-1.5 text-xs rounded-md bg-gray-100 hover:bg-gray-200 text-gray-600"},[A(J(se),{class:"h-3 w-3"}),l[4]||(l[4]=ue(" Add Condition ",-1))])])])]),_:1},8,["onDelete"]))}};export{Ee as default};
