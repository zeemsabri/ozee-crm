import{u as ne}from"./workflowStore-BpEtorFZ.js";import se from"./StepCard-v5z4ZMXR.js";import{S as O}from"./SelectDropdown-CPLyGcRc.js";import{_ as re}from"./RelationshipPathPicker-Bu0kG3Qd.js";import{T as ue}from"./trash-Dq6xPxFB.js";import{P as ie}from"./plus-BdelaFVR.js";import{l as w,q as V,o as f,w as pe,a as i,n as $,c as _,F as B,i as Q,k as L,e as F,t as X,u as Z,g as ce}from"./app-DHObBZ9c.js";/* empty css                                                                       */import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./createLucideIcon-C2r74J4U.js";const me={class:"flex flex-col space-y-3 text-md p-2 bg-gray-50 rounded-md"},de={class:"flex items-center gap-2 bg-gray-100 p-1 rounded-md"},ge={class:"space-y-2"},ve={class:"flex items-start gap-2"},fe={class:"flex-1 space-y-2"},ye={class:"flex items-center gap-2"},be=["title"],_e={key:1,class:"col-span-2 mt-1 px-1"},he=["value","onInput"],xe={key:2,class:"grid grid-cols-2 gap-2"},we=["value","onChange"],Te=["value"],Se=["value","onChange"],Ce=["type","value","onInput"],$e=["onClick","disabled"],Re={class:"mt-2 flex items-center justify-end"},Ae=["onClick","disabled"],Be={__name:"ConditionStep",props:{step:{type:Object,required:!0},allStepsBefore:{type:Array,default:()=>[]},loopContextSchema:{type:Object,default:null}},emits:["update:step","delete"],setup(M,{emit:ee}){const b=M,U=ee,q=ne(),R=w(()=>q.automationSchema||[]),te=w(()=>q.morphMap||[]),A=w(()=>{var m,c;if(b.loopContextSchema&&Array.isArray(b.loopContextSchema.columns)&&b.loopContextSchema.columns.length)return b.loopContextSchema;const e=[...b.allStepsBefore].reverse().find(o=>{var v;return o.step_type==="FOR_EACH"&&((v=o.step_config)==null?void 0:v.sourceArray)});if(!e)return null;const l=e.step_config.sourceArray,t=typeof l=="string"?l.match(/{{step_(\w+)\.(.+)}}/):null;if(!t)return null;const n=t[1],a=t[2],s=b.allStepsBefore.find(o=>String(o.id)===String(n));if((s==null?void 0:s.step_type)==="AI_PROMPT"){const o=(((m=s.step_config)==null?void 0:m.responseStructure)||[]).find(v=>v.name===a);if((o==null?void 0:o.type)==="Array of Objects")return{name:"Loop Item",columns:o.schema||[]}}if((s==null?void 0:s.step_type)==="FETCH_RECORDS"&&a==="records"){const o=(c=s.step_config)==null?void 0:c.model,v=(R.value||[]).find(u=>u.name===o);if(v)return{name:"Loop Item",columns:(v.columns||[]).map(g=>typeof g=="string"?{name:g}:g)}}return null}),p=w({get:()=>{const e=b.step.step_config||{};return Array.isArray(e.rules)||(e.rules=[{}]),e.logic||(e.logic="AND"),e},set:e=>U("update:step",{...b.step,step_config:e})});function h(e,l,t){const n=[...p.value.rules],a={...n[e]};l==="field"?(a.left={type:"var",path:t},delete a.operator,delete a.right):l==="operator"?(a.operator=t,delete a.right):l==="json_path"?a.json_path=t:l==="value"&&(a.right={type:"literal",value:t}),n[e]=a,p.value={...p.value,rules:n}}function le(){const e=[...p.value.rules,{}];p.value={...p.value,rules:e}}function G(e){const l=p.value.rules.filter((t,n)=>n!==e);p.value={...p.value,rules:l}}function H(e){p.value={...p.value,logic:e}}function d(e){var l;return((l=e==null?void 0:e.left)==null?void 0:l.path)||""}function I(e){return(e==null?void 0:e.operator)||""}function D(e){var l;return((l=e==null?void 0:e.right)==null?void 0:l.value)??null}function j(e){return!e||typeof e!="string"?"":e.replace(/{{|}}/g,"")}const W=w(()=>b.allStepsBefore.find(e=>["TRIGGER","SCHEDULE_TRIGGER"].includes(e.step_type))),P=w(()=>{var t,n;const e=[];A.value&&Array.isArray(A.value.columns)&&(A.value.columns.filter(a=>!!(a!=null&&a.name)).forEach(a=>{e.push({value:`{{loop.item.${a.name}}}`,name:`{{loop.item.${a.name}}}`,label:`Loop Item: ${a.label||a.name}`,type:a.type||"Text",group:"Current Loop Item",allowed_values:a.allowed_values||null})}),e.push({value:"{{loop.index}}",name:"{{loop.index}}",label:"Loop: index",type:"Number",group:"Loop Details"}),e.push({value:"{{loop.is_first}}",name:"{{loop.is_first}}",label:"Loop: is_first",type:"True/False",group:"Loop Details"}),e.push({value:"{{loop.is_last}}",name:"{{loop.is_last}}",label:"Loop: is_last",type:"True/False",group:"Loop Details"})),e.push({value:"triggering_object_id",name:"triggering_object_id",label:"Triggering Object ID",type:"Number",group:"Workflow Context"});const l=(n=(t=W.value)==null?void 0:t.step_config)==null?void 0:n.model;if(l){const a=R.value.find(s=>s.name===l);if(a){const s=(l.split("\\").pop()||"").toLowerCase();(a.columns||[]).forEach(m=>{const c=typeof m=="string"?{name:m}:m;e.push({value:`trigger.${s}.${c.name}`,name:`trigger.${s}.${c.name}`,label:`${l}: ${c.label||c.name}`,type:c.type||"Text",group:"Trigger Data",allowed_values:c.allowed_values})})}}else W.value&&(e.push({value:"trigger.user.id",name:"trigger.user.id",label:"Triggering User ID",type:"Number",group:"Trigger Data"}),e.push({value:"trigger.email.type",name:"trigger.email.type",label:"Trigger Email Type",type:"Text",group:"Trigger Data"}),e.push({value:"trigger.email.status",name:"trigger.email.status",label:"Trigger Email Status",type:"Text",group:"Trigger Data"}));return b.allStepsBefore.forEach((a,s)=>{var m,c;if(a.step_type==="AI_PROMPT"&&((c=(m=a.step_config)==null?void 0:m.responseStructure)==null?void 0:c.length)>0){const o=u=>{const g=String((u==null?void 0:u.type)||"").toLowerCase(),y=String((u==null?void 0:u.itemType)||"").toLowerCase();return g==="array of objects"||g==="array"&&y==="object"},v=(u,g="",y=0)=>{(u||[]).forEach(r=>{if(!(r!=null&&r.name))return;const C=g?`${g}.${r.name}`:r.name,Y="  ".repeat(y);e.push({value:`step_${a.id}.${C}`,name:`step_${a.id}.${C}`,label:`Step ${s+1} (AI): ${Y}${r.name}`,type:r.type,group:`Step ${s+1}: ${a.name}`,allowed_values:r.allowed_values||null}),Array.isArray(r.schema)&&(o(r)?r.schema.forEach(x=>{x!=null&&x.name&&e.push({value:`step_${a.id}.${C}.${x.name}`,name:`step_${a.id}.${C}.${x.name}`,label:`Step ${s+1} (AI): ${Y}  - ${x.name} (from array)`,type:x.type||"Text",group:`Step ${s+1}: ${a.name}`,allowed_values:x.allowed_values||null})}):r.type==="Object"&&v(r.schema,C,y+1))})};v(a.step_config.responseStructure)}a.step_type==="FETCH_RECORDS"&&e.push({value:`step_${a.id}.count`,name:`step_${a.id}.count`,label:`Step ${s+1} (Fetch): Count`,type:"Number",group:`Step ${s+1}: ${a.name}`})}),e});function T(e){return e?P.value.find(l=>l.value===e||l.name===e)||{name:e,value:e,label:e,type:"Text"}:null}function S(e){return!e||typeof e!="string"?!1:e.startsWith("{{")}function E(e){return!e||typeof e!="string"?!1:j(e).endsWith("_type")}const z=w(()=>(te.value||[]).map(e=>({value:e.alias,label:e.label||e.alias})));function N(e){var v;if(!e||typeof e!="string")return null;const t=j(e).split(".");if(!t.length)return null;if(t[0]==="loop"){if(t[1]==="item"&&t.length>=3){const u=t.slice(2).join("."),y=(((v=A.value)==null?void 0:v.columns)||[]).map(r=>typeof r=="string"?{name:r}:r).find(r=>r.name===u);return y?{type:y.type||"Text",allowed_values:y.allowed_values||null}:{type:"Text",allowed_values:null}}return t[1]==="index"?{type:"Number",allowed_values:null}:t[1]==="is_first"||t[1]==="is_last"?{type:"True/False",allowed_values:null}:{type:"Text",allowed_values:null}}let n=0,a=t[n++],s=null;a.toLowerCase()==="trigger"?s=(t[n++]||"").toLowerCase():s=a.toLowerCase();let m=(R.value||[]).find(u=>(u.name||"").toLowerCase()===s)||null;if(!m)return null;for(;n<t.length-1;n++){const u=t[n],g=(m.relationships||[]).find(r=>r.name===u);if(!g)return null;if(g.type==="MorphTo")return{type:"Text",allowed_values:null};const y=(R.value||[]).find(r=>r.full_class===g.full_class||r.name===g.model);if(!y)return null;m=y}const c=t[t.length-1],o=(m.columns||[]).find(u=>typeof u=="string"?u===c:u.name===c);return o?typeof o=="string"?{type:"Text",allowed_values:null}:{type:o.type||"Text",allowed_values:o.allowed_values||null}:{type:"Text",allowed_values:null}}function ae(e){var n;const l=d(e);if(E(l))return[{value:"==",label:"is"},{value:"!=",label:"is not"}];if(S(l)){const s=(N(l)||{}).type||"Text";return k[s]||k.Text}const t=(n=T(l))==null?void 0:n.type;return k[t]||k.Text}const k={Array:[{value:"not_empty",label:"is not empty"},{value:"empty",label:"is empty"}],"True/False":[{value:"==",label:"is"},{value:"!=",label:"is not"}],Number:[{value:"==",label:"equals"},{value:"!=",label:"does not equal"},{value:">",label:"is greater than"},{value:"<",label:"is less than"},{value:">=",label:"is greater than or equal to"},{value:"<=",label:"is less than or equal to"}],Date:[{value:"==",label:"is on"},{value:">",label:"is after"},{value:"<",label:"is before"},{value:"in_past",label:"is in the past"},{value:"in_future",label:"is in the future"},{value:"today",label:"is today"}],DateTime:[{value:"==",label:"is on"},{value:">",label:"is after"},{value:"<",label:"is before"},{value:"in_past",label:"is in the past"},{value:"in_future",label:"is in the future"},{value:"today",label:"is today"}],Text:[{value:"==",label:"is"},{value:"!=",label:"is not"},{value:"contains",label:"contains"},{value:"not_empty",label:"is not empty"},{value:"empty",label:"is empty"}]};function J(e){const l=String(e||"").toLowerCase();return!["","empty","not_empty","in_past","in_future","today"].includes(l)}function K(e){var t;const l=d(e);if(E(l))return z.value;if(S(l)){const n=N(l);return(n==null?void 0:n.allowed_values)||null}return((t=T(l))==null?void 0:t.allowed_values)||null}function oe(e){if(S(e)){const t=N(e)||{};return t.type==="Date"?"date":t.type==="DateTime"?"datetime-local":t.type==="Number"?"number":"text"}const l=T(e);return l?l.type==="Date"?"date":l.type==="DateTime"?"datetime-local":l.type==="Number"?"number":"text":"text"}return(e,l)=>(f(),V(se,{icon:"ðŸ”€",title:"If/Else Condition",onDelete:()=>U("delete")},{default:pe(()=>[i("div",me,[i("div",de,[i("button",{onClick:l[0]||(l[0]=t=>H("AND")),class:$([[p.value.logic==="AND"?"bg-white shadow-sm text-gray-800":"bg-transparent text-gray-500 hover:bg-gray-200"],"flex-1 py-1 px-2 text-sm font-medium rounded-md transition-colors duration-150"])}," If ALL are true ",2),i("button",{onClick:l[1]||(l[1]=t=>H("OR")),class:$([[p.value.logic==="OR"?"bg-white shadow-sm text-gray-800":"bg-transparent text-gray-500 hover:bg-gray-200"],"flex-1 py-1 px-2 text-sm font-medium rounded-md transition-colors duration-150"])}," If ANY are true ",2)]),i("div",ge,[(f(!0),_(B,null,Q(p.value.rules,(t,n)=>{var a,s,m,c;return f(),_("div",{key:n,class:"p-2 border rounded-md bg-white"},[i("div",ve,[i("div",fe,[i("div",ye,[F(O,{"model-value":d(t),options:P.value,"group-by":"group",placeholder:"Select field...","onUpdate:modelValue":o=>h(n,"field",o),class:"w-full"},null,8,["model-value","options","onUpdate:modelValue"]),F(re,{mode:"field","all-steps-before":M.allStepsBefore,value:d(t),onSelect:o=>h(n,"field",o)},null,8,["all-steps-before","value","onSelect"])]),S(d(t))?(f(),_("p",{key:0,class:"text-[11px] text-gray-600 font-mono mt-1 px-2 py-1 bg-gray-50 rounded overflow-hidden break-words",title:d(t)}," Path: "+X(j(d(t))),9,be)):L("",!0),((a=T(d(t)))==null?void 0:a.type)==="json"||((s=T(d(t)))==null?void 0:s.type)==="jsonb"?(f(),_("div",_e,[l[2]||(l[2]=i("label",{class:"block text-[10px] font-medium text-gray-500 mb-1"},"Nested JSON Path (optional)",-1)),i("input",{type:"text",value:t.json_path||"",onInput:o=>h(n,"json_path",o.target.value),placeholder:"e.g. metadata.key or address.city",class:"w-full border border-gray-300 rounded-md px-2 py-1.5 text-xs bg-gray-50"},null,40,he)])):L("",!0),d(t)?(f(),_("div",xe,[i("select",{value:I(t),onChange:o=>h(n,"operator",o.target.value),class:$(["p-2 border border-gray-300 rounded-md bg-white shadow-sm text-sm",{"col-span-2":!J(I(t))}])},[l[3]||(l[3]=i("option",{value:"",disabled:""},"Select condition...",-1)),(f(!0),_(B,null,Q(ae(t),o=>(f(),_("option",{key:o.value,value:o.value},X(o.label),9,Te))),128))],42,we),J(I(t))?(f(),_(B,{key:0},[E(d(t))?(f(),V(O,{key:0,options:z.value,"model-value":D(t),placeholder:"Select type...","onUpdate:modelValue":o=>h(n,"value",o)},null,8,["options","model-value","onUpdate:modelValue"])):K(t)?(f(),V(O,{key:1,options:(K(t)||[]).map(o=>({value:o.value,label:o.label})),"model-value":D(t),placeholder:"Select value...","onUpdate:modelValue":o=>h(n,"value",o)},null,8,["options","model-value","onUpdate:modelValue"])):(S(d(t))?((m=N(d(t)))==null?void 0:m.type)==="True/False":((c=T(d(t)))==null?void 0:c.type)==="True/False")?(f(),_("select",{key:2,value:D(t)??"true",onChange:o=>h(n,"value",o.target.value),class:"p-2 border border-gray-300 rounded-md bg-white shadow-sm text-sm"},l[4]||(l[4]=[i("option",{value:"true"},"True",-1),i("option",{value:"false"},"False",-1)]),40,Se)):(f(),_("input",{key:3,type:oe(d(t)),value:D(t)||"",onInput:o=>h(n,"value",o.target.value),placeholder:"Value...",class:"p-2 border border-gray-300 rounded-md bg-white shadow-sm text-sm"},null,40,Ce))],64)):L("",!0)])):L("",!0)]),i("button",{onClick:o=>G(n),class:$(["p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-full",{"opacity-50 cursor-not-allowed":p.value.rules.length<=1}]),title:"Remove condition","aria-label":"Remove condition",disabled:p.value.rules.length<=1},[F(Z(ue),{class:"w-4 h-4"})],10,$e)]),i("div",Re,[i("button",{onClick:o=>G(n),class:$(["text-xs text-red-600 hover:text-red-700 hover:underline",{"opacity-50 cursor-not-allowed":p.value.rules.length<=1}]),disabled:p.value.rules.length<=1}," Remove this condition ",10,Ae)])])}),128))]),i("div",null,[i("button",{onClick:le,class:"w-full flex items-center justify-center gap-1 px-2 py-1.5 text-xs rounded-md bg-gray-100 hover:bg-gray-200 text-gray-600"},[F(Z(ie),{class:"h-3 w-3"}),l[5]||(l[5]=ce(" Add Condition ",-1))])])])]),_:1},8,["onDelete"]))}};export{Be as default};
