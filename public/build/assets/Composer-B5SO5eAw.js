import{aC as D,b4 as M,E as B,b as f,r as u,D as G,m as L,d as q,b7 as I,c as r,o as n,f as i,u as w,h as T,w as p,a,t as m,i as g,y as Y,l as z,g as H,F as C,j as Q,H as R}from"./app-DTsjYMjF.js";import{_ as J}from"./AuthenticatedLayout-D17oGgsj.js";import{_ as K}from"./PrimaryButton-D076RvOo.js";import{_ as b}from"./InputLabel-p_uEzplv.js";import{_ as O}from"./TextInput-CUpprBTS.js";import{_ as y}from"./InputError-BY1ILKbO.js";import{_ as W}from"./EmailEditor-BCro6Ht8.js";import{s as X}from"./vue-multiselect-DvGpOdK7.js";import"./Modal-lthPmoFq.js";import"./SecondaryButton-DFL_0W38.js";import"./index-BX4cYnC4.js";import"./BaseFormModal-BDiV8hA6.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./SelectDropdown-Jct9JlPq.js";/* empty css                                                                       */import"./debounce-C-hnF4Z3.js";import"./RightSidebar-Cz8C3-mM.js";import"./ApplicationLogo-BlwxnmM_.js";import"./MultiSelectDropdown-Bm2yaaOu.js";import"./createLucideIcon-CdumglnZ.js";import"./plus-DaGPOpMo.js";import"./DangerButton-DzjLaV1C.js";import"./moment-BLMuvzoS.js";import"./taskState-CuaCDlH1.js";import"./NoticeboardModal-CHa5nCCL.js";import"./x-BF9xoPW-.js";import"./EmailEditor.vue_vue_type_style_index_0_lang-CQERrWPV.js";const Z={class:"py-12"},ee={class:"max-w-7xl mx-auto sm:px-6 lg:px-8"},se={class:"bg-white overflow-hidden shadow-sm sm:rounded-lg"},oe={class:"p-6 text-gray-900"},te={key:0,class:"text-red-600 mb-4"},ae={key:1,class:"text-gray-600 mb-4"},ie={key:2,class:"text-red-600 mb-4"},le={key:3,class:"text-gray-600 mb-4"},re={key:0},ne={key:1},ce={key:4},de={key:0,class:"bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4",role:"alert"},ue={class:"block sm:inline"},me={class:"mb-4"},pe=["value"],_e={class:"mb-4"},ve={class:"multiselect__tag"},fe=["onClick"],ge={class:"mb-4"},be={class:"mb-6"},ye={class:"flex items-center justify-end"},Ke={__name:"Composer",setup(he){const k=D(),{permissions:E,loading:V,error:S}=M(),{canDo:N}=B(),x=f(()=>N("compose_emails").value||!0),_=u([]),h=u([]),j=u(!0),l=u({}),c=u(""),v=u(""),t=G({project_id:"",client_ids:[],subject:"",body:""}),P=f(()=>_.value);f(()=>h.value.filter(s=>t.client_ids.includes(s.id)));const A=f(()=>{if(!t.project_id)return[];const s=_.value.find(e=>e.id===t.project_id);if(!s||!s.clients)return[];const o=s.clients.map(e=>e.id);return h.value.filter(e=>o.includes(e.id))}),F=async()=>{j.value=!0,c.value="";try{const s=await window.axios.get("/api/projects-for-email");_.value=s.data.projects;const o=new Map;_.value.forEach(e=>{e.clients&&e.clients.length>0&&e.clients.forEach(d=>{o.set(d.id,d)})}),h.value=Array.from(o.values())}catch(s){c.value="Failed to load projects.",console.error("Error fetching initial data:",s),s.response&&(s.response.status===401||s.response.status===403)&&(c.value="You are not authorized to view this content or your session expired. Please log in.")}finally{j.value=!1}};L(()=>t.project_id,s=>{t.client_ids=[]});const U=async()=>{if(l.value={},c.value="",v.value="",!t.project_id){l.value.project_id=["Please select a project."];return}if(!t.client_ids||t.client_ids.length===0){l.value.client_ids=["Please select at least one client."];return}try{const s=t.client_ids.map(e=>typeof e=="object"&&e!==null?{id:e.id}:{id:e}),o={project_id:t.project_id,client_ids:s,subject:t.subject,body:t.body,status:"pending_approval"};await window.axios.post("/api/emails",o),v.value="Email submitted for approval successfully!",t.project_id="",t.client_ids=[],t.subject="",t.body="",l.value={}}catch(s){s.response&&s.response.status===422?l.value=s.response.data.errors:s.response&&s.response.data.message?c.value=s.response.data.message:(c.value="Failed to submit email. An unexpected error occurred.",console.error("Error submitting email:",s))}},$=()=>{const o=new URLSearchParams(window.location.search).get("project_id");o&&(t.project_id=o)};return q(async()=>{try{console.log("Fetching global permissions...");const s=await I();console.log("Global permissions fetched:",s)}catch(s){console.error("Error fetching global permissions:",s)}F().then(()=>{$()}),console.log("All data loaded, permission status:"),console.log("- Global permissions:",E.value),console.log("- Permissions loading:",V.value),console.log("- Permissions error:",S.value),console.log("- Can compose emails:",x.value)}),(s,o)=>(n(),r(C,null,[i(w(T),{title:"Compose Email"}),i(J,null,{header:p(()=>o[4]||(o[4]=[a("h2",{class:"font-semibold text-xl text-gray-800 leading-tight"},"Compose New Email",-1)])),default:p(()=>[a("div",Z,[a("div",ee,[a("div",se,[a("div",oe,[o[8]||(o[8]=a("h3",{class:"text-2xl font-bold mb-6"},"Create New Email for Client",-1)),x.value?j.value?(n(),r("div",ae,"Loading data...")):c.value?(n(),r("div",ie,m(c.value),1)):P.value.length===0?(n(),r("div",le,[o[5]||(o[5]=g(" No projects assigned to you for email composition. ",-1)),w(k).role==="contractor"?(n(),r("span",re,"Please ensure you are assigned to a project.")):(n(),r("span",ne,"Please ensure there are projects available."))])):(n(),r("div",ce,[a("form",{onSubmit:Y(U,["prevent"])},[v.value?(n(),r("div",de,[a("span",ue,m(v.value),1)])):z("",!0),a("div",me,[i(b,{for:"project_id",value:"Select Project"}),H(a("select",{id:"project_id",class:"border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 rounded-md shadow-sm mt-1 block w-full","onUpdate:modelValue":o[0]||(o[0]=e=>t.project_id=e),required:""},[o[6]||(o[6]=a("option",{value:"",disabled:""},"Select a Project",-1)),(n(!0),r(C,null,Q(P.value,e=>(n(),r("option",{key:e.id,value:e.id},m(e.name)+" (Clients: "+m(e.clients.length?e.clients.map(d=>d.name).join(", "):"N/A")+") ",9,pe))),128))],512),[[R,t.project_id]]),i(y,{message:l.value.project_id?l.value.project_id[0]:"",class:"mt-2"},null,8,["message"])]),a("div",_e,[i(b,{for:"client_ids",value:"To (Clients)"}),i(w(X),{id:"client_ids",modelValue:t.client_ids,"onUpdate:modelValue":o[1]||(o[1]=e=>t.client_ids=e),options:A.value,multiple:!0,"close-on-select":!0,"clear-on-select":!1,"preserve-search":!0,placeholder:"Select one or more clients",label:"name","track-by":"id",searchable:!0,"allow-empty":!0},{option:p(({option:e})=>[g(m(e.name),1)]),tag:p(({option:e,remove:d})=>[a("span",ve,[g(m(e.name)+" ",1),a("i",{class:"multiselect__tag-icon",onClick:je=>d(e)},null,8,fe)])]),_:1},8,["modelValue","options"]),i(y,{message:l.value.client_ids?l.value.client_ids[0]:"",class:"mt-2"},null,8,["message"])]),a("div",ge,[i(b,{for:"subject",value:"Subject"}),i(O,{id:"subject",type:"text",class:"mt-1 block w-full",modelValue:t.subject,"onUpdate:modelValue":o[2]||(o[2]=e=>t.subject=e),required:""},null,8,["modelValue"]),i(y,{message:l.value.subject?l.value.subject[0]:"",class:"mt-2"},null,8,["message"])]),a("div",be,[i(b,{for:"body",value:"Email Body"}),i(W,{id:"body",modelValue:t.body,"onUpdate:modelValue":o[3]||(o[3]=e=>t.body=e),placeholder:"Compose your email here...",height:"300px"},null,8,["modelValue"]),i(y,{message:l.value.body?l.value.body[0]:"",class:"mt-2"},null,8,["message"])]),a("div",ye,[i(K,{type:"submit"},{default:p(()=>o[7]||(o[7]=[g("Submit for Approval",-1)])),_:1,__:[7]})])],32)])):(n(),r("div",te," You do not have permission to compose emails. Please contact your administrator. "))])])])])]),_:1})],64))}};export{Ke as default};
