import{p as x,r as u,c as w,D as ge,e as W,a as n,i as p,o as r,b as a,F as X,l as Y,t as m,g as ye,d as be,j as xe,v as V,G as _e,z as Z}from"./app-Bp9pk1df.js";import he from"./EmailAttachmentsList-6nEkxTE3.js";import we from"./TaskCreationForm-JOsOLVdc.js";const k="/api",xt=async(c,v)=>{const l={...c,page:v};return l.type==="new"&&(l.is_read=!1),l.type==="waiting-approval"&&(l.statuses=["pending_approval","pending_approval_received"]),(await x.get(`${k}/inbox/all-emails`,{params:l})).data},ke=async c=>(await x.get(`${k}/emails/${c}`)).data,_t=async c=>(await x.post(`${k}/inbox/emails/${c}/mark-as-read`)).data,je=async c=>(await x.get(`${k}/files`,{params:{model_type:"App\\Models\\Email",model_id:c}})).data,Ce=async(c,{delete_gmail:v=!1,delete_local:l=!0}={})=>(await x.delete(`${k}/emails/${c}`,{data:{delete_gmail:v,delete_local:l}})).data,De=async(c,v=null)=>{const l={};v!==null&&(l.is_private=!!v);const{data:C}=await x.patch(`${k}/emails/${c}/privacy`,l);return C},$e=async(c,v)=>{const{data:l}=await x.patch(`${k}/conversations/${c}/project`,{project_id:v});return l},Ee={key:0,class:"flex items-center justify-center h-full"},Se={key:1,class:"flex items-center justify-center h-full"},Ae={key:2,class:"space-y-4 p-4"},Pe={class:"border-b pb-4"},Te={key:0,class:"mb-3 flex flex-col space-y-2"},Fe=["title"],Le={class:"text-xl font-semibold text-gray-800"},Me={class:"text-sm text-gray-600 mt-1"},Be={key:1,class:"text-sm text-gray-600 mt-1"},Oe={class:"text-sm text-gray-600 mt-1"},Ue={class:"flex flex-col sm:flex-row justify-between items-start sm:items-center pt-4"},ze={class:"w-full sm:w-auto"},Re={key:0,class:"text-gray-500"},Ve={key:1,class:"text-red-500"},Ne={key:0,class:"mt-6 border-t border-gray-200 pt-6"},He={class:"prose max-w-none"},Ge=["innerHTML"],Je={key:1},Ie={class:"bg-red-100 border-l-4 border-red-500 text-red-700 p-4",role:"alert"},qe={class:"flex justify-between items-center pt-4"},Ke={class:"flex items-center gap-2"},Qe=["disabled"],We={key:0,class:"flex space-x-2"},Xe={key:2,class:"pt-6 border-t border-gray-100"},Ye={class:"flex items-center space-x-2"},Ze=["disabled"],et=["value"],tt={key:0,class:"animate-spin h-4 w-4 border-2 border-indigo-500 border-t-transparent rounded-full"},st={key:0,class:"mt-1 text-xs text-red-600"},at={key:1,class:"mt-1 text-xs text-gray-400"},lt={key:3,class:"pt-6 border-t border-gray-100"},ot={class:"text-sm font-medium text-gray-900 bg-gray-50 px-3 py-2 rounded-md border border-gray-200"},rt={key:4,class:"mt-2 text-sm text-red-600"},nt={key:5,class:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"},it={class:"bg-white rounded-lg shadow-xl max-w-md w-full p-6"},dt={class:"space-y-3 mb-4"},ut={class:"flex items-center space-x-2"},ct={class:"flex items-center space-x-2"},mt={key:0,class:"text-sm text-red-600 mb-3"},vt={class:"flex justify-end space-x-2"},pt=["disabled"],ft={__name:"EmailDetailsContent",props:{email:Object,canApproveEmails:Boolean},emits:["edit","reject","open-bulk-tasks","deleted"],setup(c,{emit:v}){const l=c,C=v,$=u([]),B=u(!1),E=u(null),j=u(!1),s=u(null),O=u(!1),U=u([]),z=u(!1),R=u(null),_=u(null),S=u(!1),A=u(null),ee=w(()=>{var t,e;return((t=s.value)==null?void 0:t.status)==="pending_approval"||((e=s.value)==null?void 0:e.status)==="pending_approval_received"}),te=w(()=>{var t;return((t=s.value)==null?void 0:t.type)==="sent"}),{canDo:N}=ge(),H=w(()=>N("delete_emails").value),se=w(()=>N("delete_emails").value),P=u(!1),T=u(null),ae=async()=>{var t,e,o;if((t=l.email)!=null&&t.id){P.value=!0,T.value=null;try{const i=s.value?!s.value.is_private:null,y=await De(l.email.id,i);s.value&&(s.value.is_private=y.is_private)}catch(i){T.value=((o=(e=i==null?void 0:i.response)==null?void 0:e.data)==null?void 0:o.message)||"Failed to update privacy."}finally{P.value=!1}}},F=u(!1),L=u(!1),D=u(null),g=u({delete_gmail:!0,delete_local:!0}),le=()=>{D.value=null,g.value={delete_gmail:!0,delete_local:!0},F.value=!0},oe=async()=>{var t,e,o;if((t=l.email)!=null&&t.id){L.value=!0,D.value=null;try{await Ce(l.email.id,{delete_gmail:g.value.delete_gmail,delete_local:g.value.delete_local}),F.value=!1,C("deleted")}catch(i){D.value=((o=(e=i==null?void 0:i.response)==null?void 0:e.data)==null?void 0:o.message)||"Failed to delete email."}finally{L.value=!1}}},re=w(()=>te.value?"Approve & Send":"Approve"),ne=async()=>{var t,e;if(!l.email||!l.email.id){s.value=null;return}O.value=!0,s.value=null;try{const o=await ke(l.email.id);s.value=o,s.value&&s.value.id&&(G(),(e=(t=s.value.conversation)==null?void 0:t.project)!=null&&e.id&&(_.value=s.value.conversation.project.id))}catch(o){console.error("Failed to fetch email details:",o),s.value=null}finally{O.value=!1}},G=async()=>{if(!s.value||!s.value.id){$.value=[];return}B.value=!0,E.value=null;try{const t=await je(s.value.id);$.value=t}catch(t){console.error("Failed to fetch attachments:",t),E.value="Failed to load attachments."}finally{B.value=!1}},ie=async t=>{if(!t){U.value=[];return}z.value=!0,R.value=null;try{const{data:e}=await x.get(`/api/projects/${t}/sections/users`,{params:{type:"users"}}),o=Array.isArray(e==null?void 0:e.users)?e.users:Array.isArray(e)?e:(e==null?void 0:e.project_users)||[];U.value=o.map(i=>({id:i.id,name:i.name}))}catch(e){R.value="Failed to load users",console.error(e)}finally{z.value=!1}},de=w(()=>{var i;if(!s.value||!s.value.body_html)return((i=s.value)==null?void 0:i.body)||"";let t=s.value.body_html;const e=/src="cid:(.*?)"/g;return t=t.replace(e,(y,h)=>{const b=$.value.find(f=>f.cid===h);return b?`src="${b.path_url}"`:'src=""'}),new DOMParser().parseFromString(t,"text/html").body.innerHTML}),ue=w(()=>{var t;if(!l.email||!((t=l.email.sender)!=null&&t.name))return"Unknown";if(l.email.type==="sent")return l.email.recipient_email}),ce=()=>{j.value=!1},me=()=>{var t,e,o;j.value=!j.value,j.value&&((o=(e=(t=s.value)==null?void 0:t.conversation)==null?void 0:e.project)!=null&&o.id)&&ie(s.value.conversation.project.id)},ve=async()=>{var t,e,o,i,y,h,b;if(!(!((e=(t=s.value)==null?void 0:t.conversation)!=null&&e.id)||!_.value)){S.value=!0,A.value=null;try{if(await $e(s.value.conversation.id,_.value),(o=s.value.conversation)!=null&&o.project){const f=s.value.available_projects.find(M=>M.id===_.value);f&&(s.value.conversation.project={...s.value.conversation.project,...f})}}catch(f){A.value=((y=(i=f==null?void 0:f.response)==null?void 0:i.data)==null?void 0:y.message)||"Failed to update project.",(b=(h=s.value.conversation)==null?void 0:h.project)!=null&&b.id&&(_.value=s.value.conversation.project.id)}finally{S.value=!1}}};W(()=>l.email,t=>{t&&(ne(),j.value=!1)},{immediate:!0}),W(s,t=>{t&&t.id&&G()});const pe=t=>{if(typeof t=="boolean")return t?"true":"false";if(t===1)return"true";if(t===0)return"false";if(t&&typeof t=="object")try{return JSON.stringify(t)}catch{return String(t)}return String(t??"")},fe=t=>{if(t==null)return"";let e=t;if(typeof e=="string")try{const o=JSON.parse(e);o&&typeof o=="object"&&(e=o)}catch{return String(e)}return e&&typeof e=="object"&&!Array.isArray(e)?Object.entries(e).map(([o,i])=>`${o}: ${pe(i)}`).join(`
`):String(e)};return(t,e)=>{var o,i,y,h,b,f,M,J,I,q,K,Q;return c.email?O.value?(r(),n("div",Se,e[7]||(e[7]=[a("div",{class:"animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500"},null,-1)]))):s.value?(r(),n("div",Ae,[a("div",Pe,[Array.isArray((o=s.value)==null?void 0:o.contexts)&&s.value.contexts.length?(r(),n("div",Te,[(r(!0),n(X,null,Y(s.value.contexts,d=>(r(),n("div",{key:d.id||d.summary,class:"w-full text-sm px-3 py-2 rounded-md bg-indigo-50 text-indigo-900 border border-indigo-200 leading-snug whitespace-pre-wrap break-words",title:fe(d==null?void 0:d.meta_data)},m(d.summary),9,Fe))),128))])):p("",!0),a("h2",Le,m(s.value.subject),1),a("div",Me," From: "+m(((y=(i=l.email)==null?void 0:i.sender)==null?void 0:y.name)||"Unknown"),1),l.email.type==="sent"?(r(),n("div",Be," To: "+m(ue.value),1)):p("",!0),a("div",Oe," Date: "+m(new Date((h=l.email)==null?void 0:h.created_at).toLocaleString()),1)]),a("div",Ue,[a("div",ze,[B.value?(r(),n("div",Re,"Loading attachments...")):E.value?(r(),n("div",Ve,m(E.value),1)):(r(),ye(he,{key:2,attachments:$.value},null,8,["attachments"]))]),a("div",{class:"mt-4 sm:mt-0"},[a("button",{onClick:me,class:"inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"}," Create Tasks ")])]),e[17]||(e[17]=a("hr",{class:"my-4"},null,-1)),j.value?(r(),n("div",Ne,[e[8]||(e[8]=a("h3",{class:"text-lg font-medium text-gray-900 mb-4"},"Create Tasks",-1)),be(we,{"email-id":s.value.id,"project-id":(f=(b=s.value.conversation)==null?void 0:b.project)==null?void 0:f.id,users:U.value,"users-loading":z.value,"users-error":R.value,onTasksSubmitted:ce},null,8,["email-id","project-id","users","users-loading","users-error"])])):p("",!0),a("div",He,[a("div",{innerHTML:de.value},null,8,Ge)]),s.value.rejection_reason?(r(),n("div",Je,[a("div",Ie,[e[9]||(e[9]=a("p",{class:"font-bold"},"Rejection Reason",-1)),a("p",null,m(s.value.rejection_reason),1)])])):p("",!0),a("div",qe,[a("div",Ke,[se.value?(r(),n("button",{key:0,onClick:ae,disabled:P.value,class:xe(["inline-flex items-center px-3 py-2 border border-transparent rounded-md shadow-sm text-xs sm:text-sm font-medium text-white",(M=s.value)!=null&&M.is_private?"bg-yellow-600 hover:bg-yellow-700 focus:ring-yellow-500":"bg-gray-600 hover:bg-gray-700 focus:ring-gray-500"]),title:"Toggle privacy"},[e[10]||(e[10]=a("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-4 w-4 mr-1",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 15c1.657 0 3-1.567 3-3.5S13.657 8 12 8s-3 1.567-3 3.5 1.343 3.5 3 3.5z"}),a("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"})],-1)),a("span",null,m(P.value?"Saving...":(J=s.value)!=null&&J.is_private?"Private":"Public"),1)],10,Qe)):p("",!0),H.value?(r(),n("button",{key:1,onClick:le,class:"inline-flex items-center px-3 py-2 border border-transparent rounded-md shadow-sm text-xs sm:text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"}," Delete ")):p("",!0)]),ee.value&&c.canApproveEmails?(r(),n("div",We,[a("button",{onClick:e[0]||(e[0]=d=>t.$emit("edit",l.email)),class:"inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"},m(re.value),1),a("button",{onClick:e[1]||(e[1]=d=>t.$emit("reject",l.email)),class:"inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"}," Reject ")])):p("",!0)]),((q=(I=s.value)==null?void 0:I.available_projects)==null?void 0:q.length)>1&&H.value?(r(),n("div",Xe,[e[11]||(e[11]=a("label",{class:"block text-xs font-semibold uppercase tracking-wider text-gray-500 mb-2"}," Linked Project ",-1)),a("div",Ye,[V(a("select",{"onUpdate:modelValue":e[2]||(e[2]=d=>_.value=d),onChange:ve,disabled:S.value,class:"block w-full text-sm border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"},[(r(!0),n(X,null,Y(s.value.available_projects,d=>(r(),n("option",{key:d.id,value:d.id},m(d.name),9,et))),128))],40,Ze),[[_e,_.value]]),S.value?(r(),n("span",tt)):p("",!0)]),A.value?(r(),n("p",st,m(A.value),1)):(r(),n("p",at,"Change project for this conversation"))])):(Q=(K=s.value)==null?void 0:K.conversation)!=null&&Q.project?(r(),n("div",lt,[e[12]||(e[12]=a("label",{class:"block text-xs font-semibold uppercase tracking-wider text-gray-500 mb-2"}," Project ",-1)),a("div",ot,m(s.value.conversation.project.name),1)])):p("",!0),T.value?(r(),n("div",rt,m(T.value),1)):p("",!0),F.value?(r(),n("div",nt,[a("div",it,[e[15]||(e[15]=a("h3",{class:"text-lg font-semibold text-gray-900 mb-2"},"Delete Email",-1)),e[16]||(e[16]=a("p",{class:"text-sm text-gray-600 mb-4"},"Choose what to delete:",-1)),a("div",dt,[a("label",ut,[V(a("input",{type:"checkbox","onUpdate:modelValue":e[3]||(e[3]=d=>g.value.delete_local=d)},null,512),[[Z,g.value.delete_local]]),e[13]||(e[13]=a("span",{class:"text-sm text-gray-700"},"Delete local copy",-1))]),a("label",ct,[V(a("input",{type:"checkbox","onUpdate:modelValue":e[4]||(e[4]=d=>g.value.delete_gmail=d)},null,512),[[Z,g.value.delete_gmail]]),e[14]||(e[14]=a("span",{class:"text-sm text-gray-700"},"Delete Gmail copy",-1))])]),D.value?(r(),n("div",mt,m(D.value),1)):p("",!0),a("div",vt,[a("button",{onClick:e[5]||(e[5]=d=>F.value=!1),class:"px-3 py-2 rounded-md text-sm border border-gray-300 text-gray-700 bg-white hover:bg-gray-50"},"Cancel"),a("button",{disabled:L.value||!g.value.delete_local&&!g.value.delete_gmail,onClick:oe,class:"px-3 py-2 rounded-md text-sm text-white bg-red-600 hover:bg-red-700 disabled:opacity-50"},m(L.value?"Deleting...":"Confirm Delete"),9,pt)])])])):p("",!0)])):p("",!0):(r(),n("div",Ee,e[6]||(e[6]=[a("p",{class:"text-gray-500"},"Select an email to view its details.",-1)])))}}},ht=Object.freeze(Object.defineProperty({__proto__:null,default:ft},Symbol.toStringTag,{value:"Module"}));export{ht as E,ft as _,xt as f,_t as m};
