import{u as ne}from"./workflowStore-CJn2Zryk.js";import re from"./StepCard-BUdyhx0C.js";import{S as O}from"./SelectDropdown-DIUru6u0.js";import{_ as se}from"./RelationshipPathPicker-CbwrSbFo.js";import{T as ue}from"./trash-C_dC7_zt.js";import{P as ie}from"./plus-CXJDgOs6.js";import{c as x,g as j,o as f,w as pe,b as c,j as C,a as _,F as V,l as Q,i as B,d as k,t as X,u as Z,m as ce}from"./app-CtYe1nZP.js";/* empty css                                                                       */import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./createLucideIcon-B0NuR17f.js";const me={class:"flex flex-col space-y-3 text-md p-2 bg-gray-50 rounded-md"},de={class:"flex items-center gap-2 bg-gray-100 p-1 rounded-md"},ge={class:"space-y-2"},ve={class:"flex items-start gap-2"},fe={class:"flex-1 space-y-2"},ye={class:"flex items-center gap-2"},be=["title"],_e={key:1,class:"grid grid-cols-2 gap-2"},he=["value","onChange"],we=["value"],xe=["value","onChange"],Te=["type","value","onInput"],Se=["onClick","disabled"],Ce={class:"mt-2 flex items-center justify-end"},$e=["onClick","disabled"],je={__name:"ConditionStep",props:{step:{type:Object,required:!0},allStepsBefore:{type:Array,default:()=>[]},loopContextSchema:{type:Object,default:null}},emits:["update:step","delete"],setup(M,{emit:ee}){const b=M,U=ee,q=ne(),$=x(()=>q.automationSchema||[]),te=x(()=>q.morphMap||[]),R=x(()=>{var o,m;if(b.loopContextSchema&&Array.isArray(b.loopContextSchema.columns)&&b.loopContextSchema.columns.length)return b.loopContextSchema;const e=[...b.allStepsBefore].reverse().find(p=>{var v;return p.step_type==="FOR_EACH"&&((v=p.step_config)==null?void 0:v.sourceArray)});if(!e)return null;const l=e.step_config.sourceArray,t=typeof l=="string"?l.match(/{{step_(\w+)\.(.+)}}/):null;if(!t)return null;const n=t[1],a=t[2],r=b.allStepsBefore.find(p=>String(p.id)===String(n));if((r==null?void 0:r.step_type)==="AI_PROMPT"){const p=(((o=r.step_config)==null?void 0:o.responseStructure)||[]).find(v=>v.name===a);if((p==null?void 0:p.type)==="Array of Objects")return{name:"Loop Item",columns:p.schema||[]}}if((r==null?void 0:r.step_type)==="FETCH_RECORDS"&&a==="records"){const p=(m=r.step_config)==null?void 0:m.model,v=($.value||[]).find(u=>u.name===p);if(v)return{name:"Loop Item",columns:(v.columns||[]).map(d=>typeof d=="string"?{name:d}:d)}}return null}),i=x({get:()=>{const e=b.step.step_config||{};return Array.isArray(e.rules)||(e.rules=[{}]),e.logic||(e.logic="AND"),e},set:e=>U("update:step",{...b.step,step_config:e})});function w(e,l,t){const n=[...i.value.rules],a={...n[e]};l==="field"?(a.left={type:"var",path:t},delete a.operator,delete a.right):l==="operator"?(a.operator=t,delete a.right):l==="value"&&(a.right={type:"literal",value:t}),n[e]=a,i.value={...i.value,rules:n}}function le(){const e=[...i.value.rules,{}];i.value={...i.value,rules:e}}function G(e){const l=i.value.rules.filter((t,n)=>n!==e);i.value={...i.value,rules:l}}function H(e){i.value={...i.value,logic:e}}function g(e){var l;return((l=e==null?void 0:e.left)==null?void 0:l.path)||""}function F(e){return(e==null?void 0:e.operator)||""}function A(e){var l;return((l=e==null?void 0:e.right)==null?void 0:l.value)??null}function E(e){return!e||typeof e!="string"?"":e.replace(/{{|}}/g,"")}const W=x(()=>b.allStepsBefore.find(e=>["TRIGGER","SCHEDULE_TRIGGER"].includes(e.step_type))),P=x(()=>{var t,n;const e=[];R.value&&Array.isArray(R.value.columns)&&(R.value.columns.filter(a=>!!(a!=null&&a.name)).forEach(a=>{e.push({value:`{{loop.item.${a.name}}}`,name:`{{loop.item.${a.name}}}`,label:`Loop Item: ${a.label||a.name}`,type:a.type||"Text",group:"Current Loop Item",allowed_values:a.allowed_values||null})}),e.push({value:"{{loop.index}}",name:"{{loop.index}}",label:"Loop: index",type:"Number",group:"Loop Details"}),e.push({value:"{{loop.is_first}}",name:"{{loop.is_first}}",label:"Loop: is_first",type:"True/False",group:"Loop Details"}),e.push({value:"{{loop.is_last}}",name:"{{loop.is_last}}",label:"Loop: is_last",type:"True/False",group:"Loop Details"})),e.push({value:"triggering_object_id",name:"triggering_object_id",label:"Triggering Object ID",type:"Number",group:"Workflow Context"});const l=(n=(t=W.value)==null?void 0:t.step_config)==null?void 0:n.model;if(l){const a=$.value.find(r=>r.name===l);if(a){const r=(l.split("\\").pop()||"").toLowerCase();(a.columns||[]).forEach(o=>{const m=typeof o=="string"?{name:o}:o;e.push({value:`trigger.${r}.${m.name}`,name:`trigger.${r}.${m.name}`,label:`${l}: ${m.label||m.name}`,type:m.type||"Text",group:"Trigger Data",allowed_values:m.allowed_values})})}}else W.value&&(e.push({value:"trigger.user.id",name:"trigger.user.id",label:"Triggering User ID",type:"Number",group:"Trigger Data"}),e.push({value:"trigger.email.type",name:"trigger.email.type",label:"Trigger Email Type",type:"Text",group:"Trigger Data"}),e.push({value:"trigger.email.status",name:"trigger.email.status",label:"Trigger Email Status",type:"Text",group:"Trigger Data"}));return b.allStepsBefore.forEach((a,r)=>{var o,m;if(a.step_type==="AI_PROMPT"&&((m=(o=a.step_config)==null?void 0:o.responseStructure)==null?void 0:m.length)>0){const p=u=>{const d=String((u==null?void 0:u.type)||"").toLowerCase(),y=String((u==null?void 0:u.itemType)||"").toLowerCase();return d==="array of objects"||d==="array"&&y==="object"},v=(u,d="",y=0)=>{(u||[]).forEach(s=>{if(!(s!=null&&s.name))return;const S=d?`${d}.${s.name}`:s.name,J="  ".repeat(y);e.push({value:`step_${a.id}.${S}`,name:`step_${a.id}.${S}`,label:`Step ${r+1} (AI): ${J}${s.name}`,type:s.type,group:`Step ${r+1}: ${a.name}`,allowed_values:s.allowed_values||null}),Array.isArray(s.schema)&&(p(s)?s.schema.forEach(h=>{h!=null&&h.name&&e.push({value:`step_${a.id}.${S}.${h.name}`,name:`step_${a.id}.${S}.${h.name}`,label:`Step ${r+1} (AI): ${J}  - ${h.name} (from array)`,type:h.type||"Text",group:`Step ${r+1}: ${a.name}`,allowed_values:h.allowed_values||null})}):s.type==="Object"&&v(s.schema,S,y+1))})};v(a.step_config.responseStructure)}a.step_type==="FETCH_RECORDS"&&e.push({value:`step_${a.id}.count`,name:`step_${a.id}.count`,label:`Step ${r+1} (Fetch): Count`,type:"Number",group:`Step ${r+1}: ${a.name}`})}),e});function D(e){return e?P.value.find(l=>l.value===e||l.name===e)||{name:e,value:e,label:e,type:"Text"}:null}function T(e){return!e||typeof e!="string"?!1:e.startsWith("{{")}function I(e){return!e||typeof e!="string"?!1:E(e).endsWith("_type")}const z=x(()=>(te.value||[]).map(e=>({value:e.alias,label:e.label||e.alias})));function N(e){var v;if(!e||typeof e!="string")return null;const t=E(e).split(".");if(!t.length)return null;if(t[0]==="loop"){if(t[1]==="item"&&t.length>=3){const u=t.slice(2).join("."),y=(((v=R.value)==null?void 0:v.columns)||[]).map(s=>typeof s=="string"?{name:s}:s).find(s=>s.name===u);return y?{type:y.type||"Text",allowed_values:y.allowed_values||null}:{type:"Text",allowed_values:null}}return t[1]==="index"?{type:"Number",allowed_values:null}:t[1]==="is_first"||t[1]==="is_last"?{type:"True/False",allowed_values:null}:{type:"Text",allowed_values:null}}let n=0,a=t[n++],r=null;a.toLowerCase()==="trigger"?r=(t[n++]||"").toLowerCase():r=a.toLowerCase();let o=($.value||[]).find(u=>(u.name||"").toLowerCase()===r)||null;if(!o)return null;for(;n<t.length-1;n++){const u=t[n],d=(o.relationships||[]).find(s=>s.name===u);if(!d)return null;if(d.type==="MorphTo")return{type:"Text",allowed_values:null};const y=($.value||[]).find(s=>s.full_class===d.full_class||s.name===d.model);if(!y)return null;o=y}const m=t[t.length-1],p=(o.columns||[]).find(u=>typeof u=="string"?u===m:u.name===m);return p?typeof p=="string"?{type:"Text",allowed_values:null}:{type:p.type||"Text",allowed_values:p.allowed_values||null}:{type:"Text",allowed_values:null}}function ae(e){var n;const l=g(e);if(I(l))return[{value:"==",label:"is"},{value:"!=",label:"is not"}];if(T(l)){const r=(N(l)||{}).type||"Text";return L[r]||L.Text}const t=(n=D(l))==null?void 0:n.type;return L[t]||L.Text}const L={Array:[{value:"not_empty",label:"is not empty"},{value:"empty",label:"is empty"}],"True/False":[{value:"==",label:"is"},{value:"!=",label:"is not"}],Number:[{value:"==",label:"equals"},{value:"!=",label:"does not equal"},{value:">",label:"is greater than"},{value:"<",label:"is less than"},{value:">=",label:"is greater than or equal to"},{value:"<=",label:"is less than or equal to"}],Date:[{value:"==",label:"is on"},{value:">",label:"is after"},{value:"<",label:"is before"},{value:"in_past",label:"is in the past"},{value:"in_future",label:"is in the future"},{value:"today",label:"is today"}],DateTime:[{value:"==",label:"is on"},{value:">",label:"is after"},{value:"<",label:"is before"},{value:"in_past",label:"is in the past"},{value:"in_future",label:"is in the future"},{value:"today",label:"is today"}],Text:[{value:"==",label:"is"},{value:"!=",label:"is not"},{value:"contains",label:"contains"},{value:"not_empty",label:"is not empty"},{value:"empty",label:"is empty"}]};function K(e){const l=String(e||"").toLowerCase();return!["","empty","not_empty","in_past","in_future","today"].includes(l)}function Y(e){var t;const l=g(e);if(I(l))return z.value;if(T(l)){const n=N(l);return(n==null?void 0:n.allowed_values)||null}return((t=D(l))==null?void 0:t.allowed_values)||null}function oe(e){if(T(e)){const t=N(e)||{};return t.type==="Date"?"date":t.type==="DateTime"?"datetime-local":t.type==="Number"?"number":"text"}const l=D(e);return l?l.type==="Date"?"date":l.type==="DateTime"?"datetime-local":l.type==="Number"?"number":"text":"text"}return(e,l)=>(f(),j(re,{icon:"ðŸ”€",title:"If/Else Condition",onDelete:()=>U("delete")},{default:pe(()=>[c("div",me,[c("div",de,[c("button",{onClick:l[0]||(l[0]=t=>H("AND")),class:C([[i.value.logic==="AND"?"bg-white shadow-sm text-gray-800":"bg-transparent text-gray-500 hover:bg-gray-200"],"flex-1 py-1 px-2 text-sm font-medium rounded-md transition-colors duration-150"])}," If ALL are true ",2),c("button",{onClick:l[1]||(l[1]=t=>H("OR")),class:C([[i.value.logic==="OR"?"bg-white shadow-sm text-gray-800":"bg-transparent text-gray-500 hover:bg-gray-200"],"flex-1 py-1 px-2 text-sm font-medium rounded-md transition-colors duration-150"])}," If ANY are true ",2)]),c("div",ge,[(f(!0),_(V,null,Q(i.value.rules,(t,n)=>{var a,r;return f(),_("div",{key:n,class:"p-2 border rounded-md bg-white"},[c("div",ve,[c("div",fe,[c("div",ye,[k(O,{"model-value":g(t),options:P.value,"group-by":"group",placeholder:"Select field...","onUpdate:modelValue":o=>w(n,"field",o),class:"w-full"},null,8,["model-value","options","onUpdate:modelValue"]),k(se,{mode:"field","all-steps-before":M.allStepsBefore,value:g(t),onSelect:o=>w(n,"field",o)},null,8,["all-steps-before","value","onSelect"])]),T(g(t))?(f(),_("p",{key:0,class:"text-[11px] text-gray-600 font-mono mt-1 px-2 py-1 bg-gray-50 rounded overflow-hidden break-words",title:g(t)}," Path: "+X(E(g(t))),9,be)):B("",!0),g(t)?(f(),_("div",_e,[c("select",{value:F(t),onChange:o=>w(n,"operator",o.target.value),class:C(["p-2 border border-gray-300 rounded-md bg-white shadow-sm text-sm",{"col-span-2":!K(F(t))}])},[l[2]||(l[2]=c("option",{value:"",disabled:""},"Select condition...",-1)),(f(!0),_(V,null,Q(ae(t),o=>(f(),_("option",{key:o.value,value:o.value},X(o.label),9,we))),128))],42,he),K(F(t))?(f(),_(V,{key:0},[I(g(t))?(f(),j(O,{key:0,options:z.value,"model-value":A(t),placeholder:"Select type...","onUpdate:modelValue":o=>w(n,"value",o)},null,8,["options","model-value","onUpdate:modelValue"])):Y(t)?(f(),j(O,{key:1,options:(Y(t)||[]).map(o=>({value:o.value,label:o.label})),"model-value":A(t),placeholder:"Select value...","onUpdate:modelValue":o=>w(n,"value",o)},null,8,["options","model-value","onUpdate:modelValue"])):(T(g(t))?((a=N(g(t)))==null?void 0:a.type)==="True/False":((r=D(g(t)))==null?void 0:r.type)==="True/False")?(f(),_("select",{key:2,value:A(t)??"true",onChange:o=>w(n,"value",o.target.value),class:"p-2 border border-gray-300 rounded-md bg-white shadow-sm text-sm"},l[3]||(l[3]=[c("option",{value:"true"},"True",-1),c("option",{value:"false"},"False",-1)]),40,xe)):(f(),_("input",{key:3,type:oe(g(t)),value:A(t)||"",onInput:o=>w(n,"value",o.target.value),placeholder:"Value...",class:"p-2 border border-gray-300 rounded-md bg-white shadow-sm text-sm"},null,40,Te))],64)):B("",!0)])):B("",!0)]),c("button",{onClick:o=>G(n),class:C(["p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-full",{"opacity-50 cursor-not-allowed":i.value.rules.length<=1}]),title:"Remove condition","aria-label":"Remove condition",disabled:i.value.rules.length<=1},[k(Z(ue),{class:"w-4 h-4"})],10,Se)]),c("div",Ce,[c("button",{onClick:o=>G(n),class:C(["text-xs text-red-600 hover:text-red-700 hover:underline",{"opacity-50 cursor-not-allowed":i.value.rules.length<=1}]),disabled:i.value.rules.length<=1}," Remove this condition ",10,$e)])])}),128))]),c("div",null,[c("button",{onClick:le,class:"w-full flex items-center justify-center gap-1 px-2 py-1.5 text-xs rounded-md bg-gray-100 hover:bg-gray-200 text-gray-600"},[k(Z(ie),{class:"h-3 w-3"}),l[4]||(l[4]=ce(" Add Condition ",-1))])])])]),_:1},8,["onDelete"]))}};export{je as default};
