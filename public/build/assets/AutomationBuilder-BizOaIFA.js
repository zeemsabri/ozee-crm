import{r as v,d as M,b as h,c as _,o as f,u as b,a as i,F as W,q as $,l as k,f as y,g as U,v as O,t as S,w as V,i as B}from"./app-CyL2wLyO.js";import{u as F}from"./workflowStore-3Vyxb0wC.js";import H from"./VueFlowCanvas-DxAuQDK1.js";import J from"./WorkflowMinimap-QKV9Qb6S.js";import j from"./TriggerSelectionModal-ZW_nKQen.js";import{R as z}from"./RightSidebar-Dikc40fU.js";import{c as q}from"./createLucideIcon-CO9mYJgo.js";import"./WorkflowNode-BPqnyiBZ.js";import"./TriggerStep-D9XMSCol.js";import"./StepCard-DYLLALCF.js";import"./x-ZMax1QnZ.js";import"./trash-CPxY_8H8.js";import"./SelectDropdown-CzJBflKr.js";/* empty css                                                                       */import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./ConditionStep-BTHeWjUB.js";import"./RelationshipPathPicker-DehRbMVg.js";import"./plus-Cfwa6LTb.js";import"./ActionStep-BHjTu1jR.js";import"./DataTokenInserter-DiLt-moy.js";import"./AIStep-BwdMJIHr.js";import"./RelatedDataPicker-B133ciLS.js";import"./BaseFormModal-Dsf7XBYD.js";import"./Modal-JbcKvSYg.js";import"./PrimaryButton-xItLiNnq.js";import"./SecondaryButton-Bblf67Ij.js";import"./PromptForm-Rr_Jr6qJ.js";import"./ResponseBuilder--2ehUuut.js";import"./FieldBuilder-0XVeiSi1.js";import"./chevron-down-BJToNRxN.js";import"./circle-x-BH0dSnaz.js";import"./ForEachStep-B2TIdHsh.js";import"./FetchRecordsStep-CmAjFMav.js";import"./ScheduleTriggerStep-Dy7C8PF6.js";import"./TransformStep-Dvr9iYMz.js";import"./DefineVariableStep-2ubTlGOs.js";import"./AddStepButton-BFXnwop8.js";/**
 * @license lucide-vue-next v0.536.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const K=q("map",[["path",{d:"M14.106 5.553a2 2 0 0 0 1.788 0l3.659-1.83A1 1 0 0 1 21 4.619v12.764a1 1 0 0 1-.553.894l-4.553 2.277a2 2 0 0 1-1.788 0l-4.212-2.106a2 2 0 0 0-1.788 0l-3.659 1.83A1 1 0 0 1 3 19.381V6.618a1 1 0 0 1 .553-.894l4.553-2.277a2 2 0 0 1 1.788 0z",key:"169xi5"}],["path",{d:"M15 5.764v15",key:"1pn4in"}],["path",{d:"M9 3.236v15",key:"1uimfh"}]]),P={class:"max-w-12xl mx-auto space-y-6"},Q={key:0,class:"text-center py-10"},X={class:"bg-white p-4 rounded-lg shadow-md border flex justify-between items-center sticky top-4 z-20"},Y={class:"flex space-x-2 flex-shrink-0"},Z=["disabled"],tt={class:"p-2 sm:p-6 pb-40"},et={class:"w-full h-[calc(100vh-200px)] min-h-[600px]"},ot={class:"ml-1 bg-indigo-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center"},it={class:"space-y-3"},nt={class:"flex items-center gap-2 text-xs text-gray-600 font-medium"},st={class:"bg-indigo-100 text-indigo-700 rounded-full px-2 py-0.5 text-xs font-bold"},Ht={__name:"AutomationBuilder",props:{automationId:{type:[Number,String],default:null}},emits:["back"],setup(w,{emit:E}){const c=w,T=E,s=F(),a=v([]),d=v(""),u=v(!1),g=v(!1);M(async()=>{try{s.automationSchema.length||await s.fetchAutomationSchema()}catch{}c.automationId?(await s.fetchWorkflow(c.automationId),s.activeWorkflow&&(a.value=JSON.parse(JSON.stringify(s.activeWorkflow.steps)),d.value=s.activeWorkflow.name)):(s.activeWorkflow=null,d.value="Untitled Automation",a.value=[],u.value=!0)});function C(e){let t;e==="SCHEDULE_TRIGGER"?t={id:`temp_${Date.now()}`,step_type:"SCHEDULE_TRIGGER",name:"Starts on a Schedule",step_config:{trigger_event:"schedule.run"}}:t={id:`temp_${Date.now()}`,step_type:"TRIGGER",name:"New Event Trigger",step_config:{}},a.value=[t],u.value=!1}const I=h(()=>{const e=a.value[0];return e?e.step_type==="SCHEDULE_TRIGGER"?!0:!!(e.step_config&&e.step_config.trigger_event):!1}),R=h(()=>I.value&&d.value.trim()!==""),m=(e,t=null,n=null)=>{let r=[];return e.forEach((l,p)=>{const o=JSON.parse(JSON.stringify(l)),N=o.if_true||[],D=o.if_false||[],L=o.children||[];delete o.if_true,delete o.if_false,delete o.children,o.step_order=p+1,o.step_config=o.step_config||{},o.step_config._parent_id=t,o.step_config._branch=n,(o.delay_minutes===void 0||o.delay_minutes===null)&&(o.delay_minutes=0),r.push(o),l.step_type==="CONDITION"&&(r=[...r,...m(N,l.id,"yes"),...m(D,l.id,"no")]),l.step_type==="FOR_EACH"&&(r=[...r,...m(L,l.id,null)])}),r};async function G(){var l;const e=a.value[0]||{},t=e.step_type==="SCHEDULE_TRIGGER"?"schedule.run":((l=e.step_config)==null?void 0:l.trigger_event)||null,n=m(a.value).map(p=>p.step_type==="SCHEDULE_TRIGGER"?{...p,step_type:"TRIGGER",step_config:{...p.step_config||{},trigger_event:"schedule.run"}}:p),r={name:d.value,trigger_event:t,is_active:!0,steps:n};try{c.automationId?await s.updateWorkflow(c.automationId,r):await s.createWorkflow(r),T("back")}catch(p){console.error("Failed to save automation:",p),s.showAlert("Save Failed","Could not save the automation.")}}function A(e){g.value=!1,setTimeout(()=>{const t=document.getElementById(`step-card-${e}`);t&&(t.scrollIntoView({behavior:"smooth",block:"center"}),t.classList.add("ring-2","ring-indigo-500","ring-offset-2"),setTimeout(()=>t.classList.remove("ring-2","ring-indigo-500","ring-offset-2"),1500))},200)}const x=h(()=>m(a.value).length);return(e,t)=>(f(),_("div",P,[b(s).isLoading&&w.automationId?(f(),_("div",Q,t[7]||(t[7]=[i("p",null,"Loading Automation...",-1)]))):(f(),_(W,{key:1},[i("div",X,[U(i("input",{type:"text","onUpdate:modelValue":t[0]||(t[0]=n=>d.value=n),placeholder:"Untitled Automation",class:"text-xl font-bold text-gray-800 focus:outline-none bg-transparent w-full"},null,512),[[O,d.value]]),i("div",Y,[i("button",{onClick:t[1]||(t[1]=n=>e.$emit("back")),class:"inline-flex items-center gap-x-2 rounded-md px-3.5 py-2 text-sm font-semibold shadow-sm bg-white text-gray-900 ring-1 ring-inset ring-gray-300 hover:bg-gray-50"}," Cancel "),i("button",{onClick:G,disabled:!R.value,class:"inline-flex items-center gap-x-2 rounded-md px-3.5 py-2 text-sm font-semibold shadow-sm bg-indigo-600 text-white hover:bg-indigo-500 focus-visible:outline-indigo-600 disabled:opacity-50"}," Save and Activate ",8,Z)])]),i("div",tt,[i("div",et,[y(H,{steps:a.value,"onUpdate:steps":t[2]||(t[2]=n=>a.value=n),onAddTrigger:t[3]||(t[3]=n=>u.value=!0)},null,8,["steps"]),t[8]||(t[8]=i("div",{class:"h-20"},null,-1))])]),u.value?(f(),$(j,{key:0,onClose:t[4]||(t[4]=n=>u.value=!1),onSelect:C})):k("",!0),a.value.length>0?(f(),_("button",{key:1,onClick:t[5]||(t[5]=n=>g.value=!0),class:"fixed bottom-8 right-8 z-30 flex items-center gap-2 rounded-full bg-indigo-600 text-white px-4 py-2.5 shadow-lg hover:bg-indigo-700 transition-all text-sm font-semibold group",title:"Open Workflow Map"},[y(b(K),{class:"h-4 w-4"}),t[9]||(t[9]=i("span",null,"Workflow Map",-1)),i("span",ot,S(x.value),1)])):k("",!0),y(z,{show:g.value,"onUpdate:show":t[6]||(t[6]=n=>g.value=n),title:"Workflow Map","initial-width":28,"min-width":20,"max-width":50},{content:V(()=>[i("div",it,[t[11]||(t[11]=i("p",{class:"text-xs text-gray-500 bg-gray-50 border border-gray-200 rounded-md px-3 py-2"}," ðŸ’¡ Click any step to jump to it on the canvas. Drag the left edge of this panel to resize. ",-1)),i("div",nt,[i("span",st,S(x.value),1),t[10]||(t[10]=B(" steps total ",-1))]),y(J,{steps:a.value,onJump:A},null,8,["steps"])])]),_:1},8,["show"])],64))]))}};export{Ht as default};
