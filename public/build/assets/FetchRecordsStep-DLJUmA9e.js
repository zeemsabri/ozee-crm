import{u as M}from"./workflowStore-BpEtorFZ.js";import P from"./StepCard-v5z4ZMXR.js";import W from"./DataTokenInserter-CiOFkCIS.js";import{S as b}from"./SelectDropdown-CPLyGcRc.js";import{a as E}from"./RelatedDataPicker-DhNV4nZc.js";import{P as z}from"./plus-BdelaFVR.js";import{T as H}from"./trash-Dq6xPxFB.js";import{l as m,r as J,q as $,o as u,w as G,a as s,c as d,k as D,e as v,g as F,u as j,F as K,i as Q,t as Y}from"./app-DHObBZ9c.js";/* empty css                                                                       */import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./createLucideIcon-C2r74J4U.js";const Z={class:"space-y-3"},ee={key:0,class:"space-y-3"},le={class:"flex items-center justify-between"},te={class:"space-y-2"},ae={class:"grid grid-cols-3 gap-2 items-center"},oe={class:"flex items-center justify-end"},se=["onClick"],ne={class:"grid grid-cols-2 gap-2"},ue={class:"flex items-center gap-1"},re={key:0,class:"text-xs text-gray-500 italic px-2"},ie=["value","onChange"],de=["value","onInput"],pe=["value","onInput"],me=["type","value","onInput"],ve={key:0,class:"col-span-2 mt-1"},ce=["value","onInput"],be={class:"flex items-center gap-2 pt-1"},fe={class:"inline-flex items-center gap-2 text-sm"},ye=["checked"],he={class:"p-2 border rounded-md bg-gray-50/60"},_e={class:"flex items-center justify-between"},ge={class:"text-[11px] text-gray-500"},Te={__name:"FetchRecordsStep",props:{step:{type:Object,required:!0},allStepsBefore:{type:Array,default:()=>[]},loopContextSchema:{type:Object,default:null}},emits:["update:step","delete"],setup(f,{emit:T}){const h=f,_=T,U=M(),g=m(()=>U.automationSchema||[]),a=m({get:()=>h.step.step_config||{conditions:[]},set:l=>_("update:step",{...h.step,step_config:l})}),N=m(()=>g.value.map(l=>l.name)),O=m(()=>N.value.map(l=>({value:l,label:l}))),x=m(()=>a.value.model&&g.value.find(l=>l.name===a.value.model)||null);function w(l){if(!l||typeof l!="string")return"";let e=l.toLowerCase();if(e==="id")return"ID";e.endsWith("_id")&&(e=e.slice(0,-3)),e=e.replace(/[_-]+/g," ");let t=e.replace(/\b\w/g,o=>o.toUpperCase());return t=t.replace(/\bId\b/g,"ID").replace(/\bUrl\b/g,"URL"),t}const k=m(()=>x.value?(x.value.columns||[]).map(l=>typeof l=="string"?{name:l,label:w(l),type:"Text"}:{...l,label:l.label||w(l.name)}):[]),A=m(()=>k.value.map(l=>({value:l.name,label:`${l.label||l.name}${l.type?` (${l.type})`:""}`})));function p(l){return k.value.find(e=>e.name===l)||null}function B(l){const e=p(l);switch((e==null?void 0:e.type)||"Text"){case"True/False":return[{value:"==",label:"is"},{value:"!=",label:"is not"},{value:"is_null",label:"is null"},{value:"is_not_null",label:"is not null"}];case"Number":return[{value:"==",label:"equals"},{value:"!=",label:"not equals"},{value:">",label:">"},{value:"<",label:"<"},{value:">=",label:">="},{value:"<=",label:"<="},{value:"is_null",label:"is null"},{value:"is_not_null",label:"is not null"}];case"Date":case"DateTime":return[{value:"==",label:"on"},{value:"!=",label:"not on"},{value:">",label:"after"},{value:"<",label:"before"},{value:">=",label:"on or after"},{value:"<=",label:"on or before"},{value:"is_null",label:"is null"},{value:"is_not_null",label:"is not null"},{value:"older_than_hours",label:"older than X hours"},{value:"within_hours",label:"within last X hours"},{value:"older_than_days",label:"older than X days"},{value:"within_days",label:"within last X days"}];default:return[{value:"==",label:"is"},{value:"!=",label:"is not"},{value:"contains",label:"contains"},{value:"starts_with",label:"starts with"},{value:"ends_with",label:"ends with"},{value:"is_null",label:"is null"},{value:"is_not_null",label:"is not null"}]}}function R(){const l=[...a.value.conditions||[],{column:"",operator:"==",value:""}];a.value={...a.value,conditions:l}}function q(l){const e=(a.value.conditions||[]).filter((t,o)=>o!==l);a.value={...a.value,conditions:e}}function i(l,e,t){const o=[...a.value.conditions||[]];o[l]={...o[l],[e]:t},a.value={...a.value,conditions:o}}function X(l,e){var r;const o=((r=(a.value.conditions||[])[l])==null?void 0:r.value)||"";i(l,"value",`${o}${e}`)}const y=J(!1),L=m(()=>{const l=a.value.relationships||{},e=Array.isArray(l.roots)?l.roots:[],t=l.nested||{};if(!e.length)return"None";const o=[];return e.forEach(r=>{const c=Array.isArray(t[r])?t[r]:[];c.length?o.push(`${r} (+ ${c.join(", ")})`):o.push(r)}),o.join(", ")});return(l,e)=>(u(),$(P,{icon:"ðŸ”",title:"Fetch Records",onDelete:()=>_("delete")},{default:G(()=>[s("div",Z,[s("div",null,[e[5]||(e[5]=s("label",{class:"block text-xs font-medium text-gray-600 mb-1"},"Find records from",-1)),v(b,{options:O.value,"model-value":a.value.model||null,placeholder:"Select model...","onUpdate:modelValue":e[0]||(e[0]=t=>a.value={...a.value,model:t,conditions:[]})},null,8,["options","model-value"])]),a.value.model?(u(),d("div",ee,[s("div",le,[e[7]||(e[7]=s("label",{class:"text-xs font-medium text-gray-600"},"Where conditions match",-1)),s("button",{onClick:R,class:"flex items-center gap-1 px-2 py-1 text-xs rounded-md bg-gray-100 hover:bg-gray-200"},[v(j(z),{class:"h-3 w-3"}),e[6]||(e[6]=F(" Add",-1))])]),s("div",te,[(u(!0),d(K,null,Q(a.value.conditions,(t,o)=>{var r,c,C,S,I,V;return u(),d("div",{key:o,class:"p-2 border rounded-md bg-gray-50/50 space-y-2"},[s("div",ae,[v(b,{options:A.value,"model-value":t.column||null,placeholder:"Field...","onUpdate:modelValue":n=>i(o,"column",n),class:"col-span-2"},null,8,["options","model-value","onUpdate:modelValue"]),s("div",oe,[s("button",{onClick:n=>q(o),class:"p-1 text-gray-400 hover:text-red-500"},[v(j(H),{class:"w-4 h-4"})],8,se)])]),s("div",ne,[v(b,{options:B(t.column),"model-value":t.operator||"==",placeholder:"Operator","onUpdate:modelValue":n=>i(o,"operator",n)},null,8,["options","model-value","onUpdate:modelValue"]),s("div",ue,[t.operator==="is_null"||t.operator==="is_not_null"?(u(),d("span",re,"No value needed")):(r=p(t.column))!=null&&r.allowed_values?(u(),$(b,{key:1,options:(p(t.column).allowed_values||[]).map(n=>({value:n.value,label:n.label})),"model-value":t.value||null,placeholder:"Select value...","onUpdate:modelValue":n=>i(o,"value",n)},null,8,["options","model-value","onUpdate:modelValue"])):((c=p(t.column))==null?void 0:c.type)==="True/False"?(u(),d("select",{key:2,value:t.value??"true",onChange:n=>i(o,"value",n.target.value),class:"w-full border rounded px-2 py-2 text-sm"},e[8]||(e[8]=[s("option",{value:"true"},"True",-1),s("option",{value:"false"},"False",-1)]),40,ie)):t.operator==="older_than_hours"||t.operator==="within_hours"?(u(),d("input",{key:3,type:"number",value:t.value,onInput:n=>i(o,"value",n.target.value),placeholder:"Hours (e.g. 24)",min:"1",class:"w-full border rounded px-2 py-2 text-sm"},null,40,de)):t.operator==="older_than_days"||t.operator==="within_days"?(u(),d("input",{key:4,type:"number",value:t.value,onInput:n=>i(o,"value",n.target.value),placeholder:"Days (e.g. 7)",min:"1",class:"w-full border rounded px-2 py-2 text-sm"},null,40,pe)):(u(),d("input",{key:5,type:((C=p(t.column))==null?void 0:C.type)==="Date"?"date":((S=p(t.column))==null?void 0:S.type)==="DateTime"?"datetime-local":"text",value:t.value,onInput:n=>i(o,"value",n.target.value),placeholder:"Value",class:"w-full border rounded px-2 py-2 text-sm"},null,40,me)),v(W,{"all-steps-before":f.allStepsBefore,"loop-context-schema":f.loopContextSchema,onInsert:n=>X(o,n)},null,8,["all-steps-before","loop-context-schema","onInsert"])]),((I=p(t.column))==null?void 0:I.type)==="json"||((V=p(t.column))==null?void 0:V.type)==="jsonb"?(u(),d("div",ve,[e[9]||(e[9]=s("label",{class:"block text-[10px] font-medium text-gray-500 mb-1"},"Nested JSON Path (optional)",-1)),s("input",{type:"text",value:t.json_path||"",onInput:n=>i(o,"json_path",n.target.value),placeholder:"e.g. metadata.key or address.city",class:"w-full border border-gray-300 rounded-md px-2 py-1.5 text-xs bg-gray-50"},null,40,ce)])):D("",!0)])])}),128))]),s("div",be,[s("label",fe,[s("input",{type:"checkbox",checked:!!a.value.single,onChange:e[1]||(e[1]=t=>a.value={...a.value,single:t.target.checked}),class:"rounded border-gray-300"},null,40,ye),e[10]||(e[10]=F(" Only first match (single record) ",-1))])]),s("div",he,[s("div",_e,[s("div",null,[e[11]||(e[11]=s("p",{class:"text-xs font-medium text-gray-700"},"Include Related Data",-1)),s("p",ge,Y(L.value),1)]),s("button",{type:"button",class:"text-xs px-2 py-1 rounded-md bg-white ring-1 ring-gray-300 hover:bg-gray-50",onClick:e[2]||(e[2]=t=>y.value=!0)},"Chooseâ€¦")]),v(E,{show:y.value,"base-model-name":a.value.model,"model-value":a.value.relationships||{base_model:a.value.model,roots:[],nested:{},fields:{}},"onUpdate:modelValue":e[3]||(e[3]=t=>a.value={...a.value,relationships:t}),onClose:e[4]||(e[4]=t=>y.value=!1)},null,8,["show","base-model-name","model-value"])])])):D("",!0)])]),_:1},8,["onDelete"]))}};export{Te as default};
