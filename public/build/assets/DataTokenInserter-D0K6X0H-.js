import{u as W}from"./workflowStore-I6WPJ2Rv.js";import{r as k,f as F,Q as P,c as C,a as v,o as p,b as y,g as O,i as D,k as T,v as M,x as H,F as I,l as N,t as B,Y as z,n as U}from"./app-D5B69b4J.js";const V=["disabled"],j={class:"p-2 border-b"},G={class:"px-3 py-1.5 text-[11px] font-semibold uppercase tracking-wide text-gray-500 bg-gray-50"},X=["onClick"],Y={key:1,class:"px-3 py-2 text-xs text-gray-500"},q={__name:"DataTokenPicker",props:{groups:{type:Array,default:()=>[]},placeholder:{type:String,default:""},disabled:{type:Boolean,default:!1},maxHeight:{type:String,default:"300px"},minWidth:{type:[String,Number],default:320},maxPanelWidth:{type:[String,Number],default:480}},emits:["select"],setup(b,{emit:$}){const c=b,R=$,f=k(!1),m=k(null),w=k(null),g=k({top:0,left:0,width:0}),x=k(""),S=e=>{if(typeof e=="number")return e;const t=parseInt(String(e).replace("px",""));return isNaN(t)?0:t};function l(){c.disabled||(f.value=!f.value,U(()=>r()))}function r(){const e=m.value;if(!e)return;const t=e.getBoundingClientRect(),o=8,i=window.innerWidth||document.documentElement.clientWidth,s=Math.max(t.width,S(c.minWidth)),a=Math.min(S(c.maxPanelWidth),i-o*2),n=Math.min(Math.max(s,S(c.minWidth)),a);let u=t.left+window.scrollX;u+n+o>i+window.scrollX&&(u=i+window.scrollX-n-o,u<o&&(u=o)),g.value={top:t.bottom+window.scrollY,left:u,width:n}}function d(){f.value&&r()}function h(e){const t=m.value&&m.value.contains(e.target),o=w.value&&w.value.contains(e.target);!t&&!o&&(f.value=!1)}F(()=>{window.addEventListener("scroll",d,!0),window.addEventListener("resize",d),document.addEventListener("click",h)}),P(()=>{window.removeEventListener("scroll",d,!0),window.removeEventListener("resize",d),document.removeEventListener("click",h)}),C(()=>{const e=[];return(c.groups||[]).forEach((t,o)=>{(t.fields||[]).forEach((i,s)=>{e.push({groupIndex:o,itemIndex:s,group:t.name||"Data",label:i.label,value:i.value})})}),e});const _=C(()=>{const e=x.value.trim().toLowerCase();if(!e)return c.groups;const t=[];return(c.groups||[]).forEach(o=>{const i=(o.fields||[]).filter(s=>String(s.label||"").toLowerCase().includes(e));i.length&&t.push({name:o.name,fields:i})}),t});function E(e){R("select",e),f.value=!1}return(e,t)=>(p(),v("div",{class:"relative inline-block",ref_key:"triggerRef",ref:m},[y("button",{type:"button",onClick:l,disabled:b.disabled,"aria-label":"Insert data",class:"inline-flex items-center justify-center rounded-full border border-gray-300 bg-white p-1.5 text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-60"},t[1]||(t[1]=[y("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-4 w-4",viewBox:"0 0 20 20",fill:"currentColor"},[y("path",{"fill-rule":"evenodd",d:"M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z","clip-rule":"evenodd"})],-1)]),8,V),(p(),O(z,{to:"body"},[f.value?(p(),v("div",{key:0,ref_key:"portalRef",ref:w,class:"fixed z-[9999] bg-white rounded-md shadow-xl ring-1 ring-black ring-opacity-5",style:T({top:g.value.top+"px",left:g.value.left+"px",width:g.value.width+"px",maxWidth:"min(480px, 96vw)"})},[y("div",j,[M(y("input",{type:"text","onUpdate:modelValue":t[0]||(t[0]=o=>x.value=o),placeholder:"Search fields...",class:"w-full border border-gray-200 rounded px-2 py-1 text-xs focus:ring-indigo-500 focus:border-indigo-500"},null,512),[[H,x.value]])]),y("div",{class:"max-h-[calc(100vh-180px)] overflow-auto",style:T({maxHeight:b.maxHeight})},[_.value&&_.value.length?(p(!0),v(I,{key:0},N(_.value,o=>(p(),v("div",{key:o.name,class:"py-1"},[y("div",G,B(o.name),1),(p(!0),v(I,null,N(o.fields||[],i=>(p(),v("button",{key:i.value,type:"button",class:"w-full text-left px-3 py-2 text-sm hover:bg-gray-50",onClick:s=>E(i.value)},B(i.label),9,X))),128))]))),128)):(p(),v("div",Y,"No data available"))],4)],4)):D("",!0)]))],512))}},K={__name:"DataTokenInserter",props:{allStepsBefore:{type:Array,default:()=>[]},loopContextSchema:{type:Object,default:null},inferLoopFromNearest:{type:Boolean,default:!0}},emits:["insert"],setup(b,{emit:$}){const c=b,R=$,f=W(),m=C(()=>f.automationSchema||[]);function w(l){if(!l||typeof l!="string")return"";let r=l.toLowerCase();if(r==="id")return"ID";r.endsWith("_id")&&(r=r.slice(0,-3)),r=r.replace(/[_-]+/g," ");let d=r.replace(/\b\w/g,h=>h.toUpperCase());return d=d.replace(/\bId\b/g,"ID").replace(/\bUrl\b/g,"URL"),d}const g=C(()=>{var h,_,E;const l=[];let r=c.loopContextSchema;if(!r&&c.inferLoopFromNearest){const e=[...c.allStepsBefore].reverse().find(t=>{var o;return t.step_type==="FOR_EACH"&&((o=t.step_config)==null?void 0:o.sourceArray)});if(e){const t=e.step_config.sourceArray,o=typeof t=="string"?t.match(/{{step_(\w+)\.(.+)}}/):null;if(o){const i=o[1],s=o[2],a=c.allStepsBefore.find(n=>String(n.id)===String(i));if((a==null?void 0:a.step_type)==="AI_PROMPT"){const n=(((h=a.step_config)==null?void 0:h.responseStructure)||[]).find(u=>u.name===s);(n==null?void 0:n.type)==="Array of Objects"&&(r={name:"Loop Item",columns:n.schema||[]})}if(!r&&(a==null?void 0:a.step_type)==="FETCH_RECORDS"&&s==="records"){const n=(_=a.step_config)==null?void 0:_.model,u=m.value.find(L=>L.name===n);u&&(r={name:"Loop Item",columns:(u.columns||[]).map(A=>typeof A=="string"?{name:A}:A)})}}}}r&&Array.isArray(r.columns)&&(l.push({name:"Current Loop Item (from For Each)",fields:r.columns.filter(e=>!!(e&&e.name)).map(e=>({label:e.name,value:`{{loop.item.${e.name}}}`}))}),l.push({name:"Loop Details",fields:[{label:"index",value:"{{loop.index}}"},{label:"is_first",value:"{{loop.is_first}}"},{label:"is_last",value:"{{loop.is_last}}"}]}));const d=c.allStepsBefore.find(e=>e.step_type==="TRIGGER");if(d&&((E=d.step_config)!=null&&E.model)){const e=m.value.find(t=>t.name===d.step_config.model);e&&l.push({name:`Trigger: ${d.step_config.model}`,fields:e.columns.map(t=>{const o=typeof t=="string"?t:t.name||"";return{label:typeof t=="string"?w(t):t.label||t.name||"",value:`{{trigger.${d.step_config.model.toLowerCase()}.${o}}}`}})})}return c.allStepsBefore.forEach((e,t)=>{var o,i;if(e.step_type==="AI_PROMPT"&&((i=(o=e.step_config)==null?void 0:o.responseStructure)==null?void 0:i.length)>0){const s=[];(e.step_config.responseStructure||[]).forEach(a=>{s.push({label:a.name,value:`{{step_${e.id}.${a.name}}}`}),a.type==="Array of Objects"&&Array.isArray(a.schema)&&a.schema.forEach(n=>{n!=null&&n.name&&s.push({label:`- ${n.name}`,value:`{{step_${e.id}.${a.name}.${n.name}}}`})})}),l.push({name:`Step ${t+1}: AI Response`,fields:s})}if(e.step_type==="FETCH_RECORDS"){const s=[{label:"records (array)",value:`{{step_${e.id}.records}}`},{label:"count",value:`{{step_${e.id}.count}}`}],a=e.step_config&&e.step_config.model?e.step_config.model:null,n=`Step ${t+1}: Fetch Records`+(a?` — ${a}`:"");l.push({name:n,fields:s})}if(e.step_type==="TRANSFORM_CONTENT"){const s=[{label:"cleaned_body",value:`{{step_${e.id}.cleaned_body}}`},{label:"result",value:`{{step_${e.id}.result}}`}];l.push({name:`Step ${t+1}: Transformed Content`,fields:s})}if(e.step_type==="ACTION"&&e.step_config&&e.step_config.action_type==="CREATE_RECORD"){const s=e.step_config.target_model||"",a=`Step ${t+1}: Create Record`+(s?` — ${s}`:""),n=[{label:"new_record_id",value:`{{step_${e.id}.new_record_id}}`},{label:"id (legacy)",value:`{{step_${e.id}.id}}`}];l.push({name:a,fields:n})}}),l}),x=C(()=>g.value.some(l=>Array.isArray(l.fields)&&l.fields.length>0));function S(l){l&&R("insert",l)}return(l,r)=>(p(),O(q,{groups:g.value,disabled:!x.value,onSelect:S},null,8,["groups","disabled"]))}};export{K as default};
