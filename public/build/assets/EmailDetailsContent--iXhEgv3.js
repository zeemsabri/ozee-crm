import{p as b,r as i,c as f,z as ae,e as U,a as u,i as v,o as r,b as s,t as m,g as le,d as oe,j as ne,q as V,D as H}from"./app-BXwNPRau.js";import ie from"./EmailAttachmentsList-CB1Sp0Ou.js";import re from"./TaskCreationForm-DZvi6TSf.js";const x="/api",Je=async(n,c)=>{const l={...n,page:c};return l.type==="new"&&(l.is_read=!1),l.type==="waiting-approval"&&(l.statuses=["pending_approval","pending_approval_received"]),(await b.get(`${x}/inbox/all-emails`,{params:l})).data},de=async n=>(await b.get(`${x}/emails/${n}`)).data,Ke=async n=>(await b.post(`${x}/inbox/emails/${n}/mark-as-read`)).data,ue=async n=>(await b.get(`${x}/files`,{params:{model_type:"App\\Models\\Email",model_id:n}})).data,ce=async(n,{delete_gmail:c=!1,delete_local:l=!0}={})=>(await b.delete(`${x}/emails/${n}`,{data:{delete_gmail:c,delete_local:l}})).data,me=async(n,c=null)=>{const l={};c!==null&&(l.is_private=!!c);const{data:_}=await b.patch(`${x}/emails/${n}/privacy`,l);return _},ve={key:0,class:"flex items-center justify-center h-full"},pe={key:1,class:"flex items-center justify-center h-full"},fe={key:2,class:"space-y-4 p-4"},ge={class:"border-b pb-4"},ye={class:"text-xl font-semibold text-gray-800"},be={class:"text-sm text-gray-600 mt-1"},xe={key:0,class:"text-sm text-gray-600 mt-1"},_e={class:"text-sm text-gray-600 mt-1"},he={class:"flex flex-col sm:flex-row justify-between items-start sm:items-center pt-4"},we={class:"w-full sm:w-auto"},ke={key:0,class:"text-gray-500"},je={key:1,class:"text-red-500"},De={key:0,class:"mt-6 border-t border-gray-200 pt-6"},Ee={class:"prose max-w-none"},$e=["innerHTML"],Ce={key:1},Ae={class:"bg-red-100 border-l-4 border-red-500 text-red-700 p-4",role:"alert"},Te={class:"flex justify-between items-center pt-4"},Se={class:"flex items-center gap-2"},Be=["disabled"],Fe={key:0,class:"flex space-x-2"},Le={key:2,class:"mt-2 text-sm text-red-600"},Me={key:3,class:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"},Pe={class:"bg-white rounded-lg shadow-xl max-w-md w-full p-6"},ze={class:"space-y-3 mb-4"},Re={class:"flex items-center space-x-2"},Oe={class:"flex items-center space-x-2"},Ue={key:0,class:"text-sm text-red-600 mb-3"},Ve={class:"flex justify-end space-x-2"},He=["disabled"],Ne={__name:"EmailDetailsContent",props:{email:Object,canApproveEmails:Boolean},emits:["edit","reject","open-bulk-tasks","deleted"],setup(n,{emit:c}){const l=n,_=c,j=i([]),B=i(!1),D=i(null),g=i(!1),a=i(null),F=i(!1),L=i([]),M=i(!1),P=i(null),N=f(()=>{var t,e;return((t=a.value)==null?void 0:t.status)==="pending_approval"||((e=a.value)==null?void 0:e.status)==="pending_approval_received"}),q=f(()=>{var t;return((t=a.value)==null?void 0:t.type)==="sent"}),{canDo:z}=ae(),G=f(()=>z("delete_emails").value),I=f(()=>z("delete_emails").value),E=i(!1),$=i(null),J=async()=>{var t,e,d;if((t=l.email)!=null&&t.id){E.value=!0,$.value=null;try{const o=a.value?!a.value.is_private:null,w=await me(l.email.id,o);a.value&&(a.value.is_private=w.is_private)}catch(o){$.value=((d=(e=o==null?void 0:o.response)==null?void 0:e.data)==null?void 0:d.message)||"Failed to update privacy."}finally{E.value=!1}}},C=i(!1),A=i(!1),h=i(null),p=i({delete_gmail:!0,delete_local:!0}),K=()=>{h.value=null,p.value={delete_gmail:!0,delete_local:!0},C.value=!0},Q=async()=>{var t,e,d;if((t=l.email)!=null&&t.id){A.value=!0,h.value=null;try{await ce(l.email.id,{delete_gmail:p.value.delete_gmail,delete_local:p.value.delete_local}),C.value=!1,_("deleted")}catch(o){h.value=((d=(e=o==null?void 0:o.response)==null?void 0:e.data)==null?void 0:d.message)||"Failed to delete email."}finally{A.value=!1}}},W=f(()=>q.value?"Approve & Send":"Approve"),X=async()=>{if(!l.email||!l.email.id){a.value=null;return}F.value=!0,a.value=null;try{const t=await de(l.email.id);a.value=t,a.value&&a.value.id&&R()}catch(t){console.error("Failed to fetch email details:",t),a.value=null}finally{F.value=!1}},R=async()=>{if(!a.value||!a.value.id){j.value=[];return}B.value=!0,D.value=null;try{const t=await ue(a.value.id);j.value=t}catch(t){console.error("Failed to fetch attachments:",t),D.value="Failed to load attachments."}finally{B.value=!1}},Y=async t=>{if(!t){L.value=[];return}M.value=!0,P.value=null;try{const{data:e}=await axios.get(`/api/projects/${t}/sections/users`,{params:{type:"users"}}),d=Array.isArray(e==null?void 0:e.users)?e.users:Array.isArray(e)?e:(e==null?void 0:e.project_users)||[];L.value=d.map(o=>({id:o.id,name:o.name}))}catch(e){P.value="Failed to load users",console.error(e)}finally{M.value=!1}},Z=f(()=>{var o;if(!a.value||!a.value.body_html)return((o=a.value)==null?void 0:o.body)||"";let t=a.value.body_html;const e=/src="cid:(.*?)"/g;return t=t.replace(e,(w,T)=>{const k=j.value.find(S=>S.cid===T);return k?`src="${k.path_url}"`:'src=""'}),new DOMParser().parseFromString(t,"text/html").body.innerHTML}),ee=f(()=>{var t;if(!l.email||!((t=l.email.sender)!=null&&t.name))return"Unknown";if(l.email.type==="sent")return l.email.recipient_email}),te=()=>{g.value=!1},se=()=>{var t,e,d;g.value=!g.value,g.value&&((d=(e=(t=a.value)==null?void 0:t.conversation)==null?void 0:e.project)!=null&&d.id)&&Y(a.value.conversation.project.id)};return U(()=>l.email,t=>{t&&(X(),g.value=!1)},{immediate:!0}),U(a,t=>{t&&t.id&&R()}),(t,e)=>{var d,o,w,T,k,S,O;return n.email?F.value?(r(),u("div",pe,e[6]||(e[6]=[s("div",{class:"animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500"},null,-1)]))):a.value?(r(),u("div",fe,[s("div",ge,[s("h2",ye,m(a.value.subject),1),s("div",be," From: "+m(((o=(d=l.email)==null?void 0:d.sender)==null?void 0:o.name)||"Unknown"),1),l.email.type==="sent"?(r(),u("div",xe," To: "+m(ee.value),1)):v("",!0),s("div",_e," Date: "+m(new Date((w=l.email)==null?void 0:w.created_at).toLocaleString()),1)]),s("div",he,[s("div",we,[B.value?(r(),u("div",ke,"Loading attachments...")):D.value?(r(),u("div",je,m(D.value),1)):(r(),le(ie,{key:2,attachments:j.value},null,8,["attachments"]))]),s("div",{class:"mt-4 sm:mt-0"},[s("button",{onClick:se,class:"inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"}," Create Tasks ")])]),e[14]||(e[14]=s("hr",{class:"my-4"},null,-1)),g.value?(r(),u("div",De,[e[7]||(e[7]=s("h3",{class:"text-lg font-medium text-gray-900 mb-4"},"Create Tasks",-1)),oe(re,{"email-id":a.value.id,"project-id":(k=(T=a.value.conversation)==null?void 0:T.project)==null?void 0:k.id,users:L.value,"users-loading":M.value,"users-error":P.value,onTasksSubmitted:te},null,8,["email-id","project-id","users","users-loading","users-error"])])):v("",!0),s("div",Ee,[s("div",{innerHTML:Z.value},null,8,$e)]),a.value.rejection_reason?(r(),u("div",Ce,[s("div",Ae,[e[8]||(e[8]=s("p",{class:"font-bold"},"Rejection Reason",-1)),s("p",null,m(a.value.rejection_reason),1)])])):v("",!0),s("div",Te,[s("div",Se,[I.value?(r(),u("button",{key:0,onClick:J,disabled:E.value,class:ne(["inline-flex items-center px-3 py-2 border border-transparent rounded-md shadow-sm text-xs sm:text-sm font-medium text-white",(S=a.value)!=null&&S.is_private?"bg-yellow-600 hover:bg-yellow-700 focus:ring-yellow-500":"bg-gray-600 hover:bg-gray-700 focus:ring-gray-500"]),title:"Toggle privacy"},[e[9]||(e[9]=s("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-4 w-4 mr-1",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 15c1.657 0 3-1.567 3-3.5S13.657 8 12 8s-3 1.567-3 3.5 1.343 3.5 3 3.5z"}),s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"})],-1)),s("span",null,m(E.value?"Saving...":(O=a.value)!=null&&O.is_private?"Private":"Public"),1)],10,Be)):v("",!0),G.value?(r(),u("button",{key:1,onClick:K,class:"inline-flex items-center px-3 py-2 border border-transparent rounded-md shadow-sm text-xs sm:text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"}," Delete ")):v("",!0)]),N.value&&n.canApproveEmails?(r(),u("div",Fe,[s("button",{onClick:e[0]||(e[0]=y=>t.$emit("edit",l.email)),class:"inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"},m(W.value),1),s("button",{onClick:e[1]||(e[1]=y=>t.$emit("reject",l.email)),class:"inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"}," Reject ")])):v("",!0)]),$.value?(r(),u("div",Le,m($.value),1)):v("",!0),C.value?(r(),u("div",Me,[s("div",Pe,[e[12]||(e[12]=s("h3",{class:"text-lg font-semibold text-gray-900 mb-2"},"Delete Email",-1)),e[13]||(e[13]=s("p",{class:"text-sm text-gray-600 mb-4"},"Choose what to delete:",-1)),s("div",ze,[s("label",Re,[V(s("input",{type:"checkbox","onUpdate:modelValue":e[2]||(e[2]=y=>p.value.delete_local=y)},null,512),[[H,p.value.delete_local]]),e[10]||(e[10]=s("span",{class:"text-sm text-gray-700"},"Delete local copy",-1))]),s("label",Oe,[V(s("input",{type:"checkbox","onUpdate:modelValue":e[3]||(e[3]=y=>p.value.delete_gmail=y)},null,512),[[H,p.value.delete_gmail]]),e[11]||(e[11]=s("span",{class:"text-sm text-gray-700"},"Delete Gmail copy",-1))])]),h.value?(r(),u("div",Ue,m(h.value),1)):v("",!0),s("div",Ve,[s("button",{onClick:e[4]||(e[4]=y=>C.value=!1),class:"px-3 py-2 rounded-md text-sm border border-gray-300 text-gray-700 bg-white hover:bg-gray-50"},"Cancel"),s("button",{disabled:A.value||!p.value.delete_local&&!p.value.delete_gmail,onClick:Q,class:"px-3 py-2 rounded-md text-sm text-white bg-red-600 hover:bg-red-700 disabled:opacity-50"},m(A.value?"Deleting...":"Confirm Delete"),9,He)])])])):v("",!0)])):v("",!0):(r(),u("div",ve,e[5]||(e[5]=[s("p",{class:"text-gray-500"},"Select an email to view its details.",-1)])))}}},Qe=Object.freeze(Object.defineProperty({__proto__:null,default:Ne},Symbol.toStringTag,{value:"Module"}));export{Qe as E,Ne as _,Je as f,Ke as m};
