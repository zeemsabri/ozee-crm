<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bug Reporter</title>
    <!-- Use Tailwind CSS for easy styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Define a container for the app */
        .app-container {
            display: flex;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            flex-direction: column;
            font-family: 'Inter', sans-serif;
        }

        /* Style the top bar for controls */
        .top-bar {
            background-color: #2D3748; /* slate-800 */
            color: white;
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
        }

        /* Style the iframe container to take remaining space */
        .iframe-container {
            flex-grow: 1;
            position: relative;
            overflow: hidden;
            background-color: #E2E8F0; /* slate-200 */
        }

        /* Ensure the iframe fills its container */
        #websiteFrame {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* The transparent overlay for clicks */
        .click-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            cursor: crosshair;
            display: none; /* Hidden by default */
        }

        /* Modal styling */
        .feedback-modal {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            z-index: 9999;
            transition: opacity 0.3s, transform 0.3s;
            opacity: 0;
            pointer-events: none;
        }
        .feedback-modal.active {
            opacity: 1;
            pointer-events: auto;
        }
        .feedback-modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 32rem;
            transform: scale(0.95);
            transition: transform 0.3s;
        }
        .feedback-modal.active .feedback-modal-content {
            transform: scale(1);
        }

        /* Message overlay styling */
        .message-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            font-size: 1rem;
            text-align: center;
            z-index: 10000;
            animation: fadeInOut 3s forwards;
            pointer-events: none;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { opacity: 0; }
        }

        /* Button styling */
        .btn {
            padding: 0.5rem 1rem;
            font-weight: 600;
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn-blue {
            background-color: #3B82F6; /* blue-500 */
            color: white;
        }
        .btn-blue:hover {
            background-color: #2563EB; /* blue-600 */
        }
        .btn-red {
            background-color: #EF4444; /* red-500 */
            color: white;
        }
        .btn-red:hover {
            background-color: #DC2626; /* red-600 */
        }
        .btn-green {
            background-color: #10B981; /* green-500 */
            color: white;
        }
        .btn-green:hover {
            background-color: #059669; /* green-600 */
        }

    </style>
</head>
<body class="bg-gray-100">

<div class="app-container">
    <!-- Top bar with controls -->
    <div class="top-bar">
        <h1 class="text-xl font-bold">Bug Reporter</h1>
        <button id="startFeedbackBtn" class="btn btn-blue">
            Start Feedback
        </button>
        <div id="status" class="hidden text-sm font-medium">
            <p>Click on an element...</p>
        </div>
    </div>

    <!-- The iframe container -->
    <div class="iframe-container">
        <iframe id="websiteFrame" src=""></iframe>
        <!-- New click-blocking overlay -->
        <div id="clickOverlay" class="click-overlay"></div>
    </div>
</div>

<!-- The feedback modal (hidden initially) -->
<div id="feedback-modal" class="feedback-modal">
    <div class="feedback-modal-content">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Report an Issue</h2>
        <form id="feedback-form" class="space-y-4">
            <div>
                <label for="issue-description" class="block text-sm font-medium text-gray-700">Description</label>
                <textarea id="issue-description" name="description" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" required></textarea>
            </div>
            <div>
                <label for="technical-info" class="block text-sm font-medium text-gray-700">Technical Information</label>
                <textarea id="technical-info" name="tech_info" rows="5" class="mt-1 block w-full bg-gray-100 rounded-md border-gray-300 shadow-sm font-mono text-xs" readonly></textarea>
            </div>
            <div id="screenshot-preview-container" class="hidden">
                <h3 class="text-lg font-medium text-gray-800 mb-2">Screenshot Preview</h3>
                <img id="screenshot-preview" class="w-full rounded-md border border-gray-300" alt="Screenshot Preview">
            </div>
            <div class="flex justify-end space-x-2">
                <button type="button" id="cancelBtn" class="btn btn-red">Cancel</button>
                <button type="submit" class="btn btn-green">Submit Report</button>
            </div>
        </form>
    </div>
</div>

<!-- We'll use html2canvas to take a screenshot of the iframe -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
    // Use a state object to manage the application's state
    const appState = {
        feedbackModeActive: false,
        // We need to keep a reference to the element outline so we can remove it later
        outlinedElement: null,
        urlToLoad: null
    };

    // --- DOM Element References ---
    const startFeedbackBtn = document.getElementById('startFeedbackBtn');
    const statusDiv = document.getElementById('status');
    const websiteFrame = document.getElementById('websiteFrame');
    const clickOverlay = document.getElementById('clickOverlay'); // Reference to the new overlay
    const feedbackModal = document.getElementById('feedback-modal');
    const feedbackForm = document.getElementById('feedback-form');
    const cancelBtn = document.getElementById('cancelBtn');
    const descriptionTextarea = document.getElementById('issue-description');
    const techInfoTextarea = document.getElementById('technical-info');
    const screenshotPreviewContainer = document.getElementById('screenshot-preview-container');
    const screenshotPreview = document.getElementById('screenshot-preview');

    // --- Helper Functions ---

    /**
     * Parses the URL parameters and loads the website into the iframe.
     */
    function loadWebsiteFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        appState.urlToLoad = urlParams.get('url');
        if (appState.urlToLoad) {
            websiteFrame.src = appState.urlToLoad;
        } else {
            // Handle case where no URL is provided, maybe show a message or a form
            websiteFrame.src = "about:blank";
            showOverlayMessage("Please provide a URL parameter (e.g., ?url=https://example.com) to load a website.");
            startFeedbackBtn.disabled = true;
        }
    }

    /**
     * Displays a temporary message overlay on the iframe.
     * @param {string} message - The message to display.
     */
    function showOverlayMessage(message) {
        const messageElement = document.createElement('div');
        messageElement.className = 'message-overlay';
        messageElement.textContent = message;
        // Append to the parent of the iframe so it's over the iframe
        websiteFrame.parentNode.appendChild(messageElement);
    }

    /**
     * Opens the feedback modal and captures a screenshot.
     */
    async function startFeedbackMode() {
        // Check if a URL has been loaded before starting
        if (!appState.urlToLoad || appState.urlToLoad === "about:blank") {
            showOverlayMessage("No website to report on. Please provide a URL.");
            return;
        }

        // Hide the button and show the status message
        startFeedbackBtn.style.display = 'none';
        statusDiv.style.display = 'block';

        // Show the overlay to capture clicks
        clickOverlay.style.display = 'block';

        // Wait for the user to click the overlay
        await new Promise(resolve => {
            clickOverlay.addEventListener('click', resolve, { once: true });
        });

        // Hide the overlay after the click
        clickOverlay.style.display = 'none';

        // Re-show the button and hide the status message
        startFeedbackBtn.style.display = 'block';
        statusDiv.style.display = 'none';

        appState.feedbackModeActive = true;
        // Capture screenshot and display the modal
        captureScreenshot();

        // Collect technical information. Note: We cannot get deep info from the iframe.
        const technicalInfo = {
            url: appState.urlToLoad,
            timestamp: new Date().toISOString(),
            userAgent: navigator.userAgent,
            screenSize: `${window.innerWidth}x${window.innerHeight}`,
        };

        // Populate the technical info textarea
        techInfoTextarea.value = `URL: ${technicalInfo.url}\n` +
            `Timestamp: ${technicalInfo.timestamp}\n` +
            `User Agent: ${technicalInfo.userAgent}\n` +
            `Screen Size: ${technicalInfo.screenSize}\n`;
    }

    /**
     * Uses html2canvas to capture a screenshot of the iframe element.
     * Note: This will not work for cross-origin iframes due to browser security.
     * The iframe area will be blank in the resulting screenshot.
     */
    function captureScreenshot() {
        // Capture the iframe container to get the full view, including the overlay
        const container = websiteFrame.parentNode;

        html2canvas(container, {
            // Ignore the iframe to prevent security errors
            ignoreElements: (element) => {
                return element.tagName === 'IFRAME';
            },
            logging: true, // Enable logging for debugging
        }).then(canvas => {
            const dataUrl = canvas.toDataURL('image/png');
            screenshotPreview.src = dataUrl;
            screenshotPreviewContainer.classList.remove('hidden');
            feedbackModal.classList.add('active');
        }).catch(err => {
            // Catch any remaining errors and display a helpful message
            console.error("Failed to capture screenshot:", err);
            showOverlayMessage("Failed to capture screenshot. This is a browser security limitation for cross-origin iframes.");
        });
    }

    /**
     * Closes the feedback modal and resets the form.
     */
    function closeFeedbackModal() {
        feedbackModal.classList.remove('active');
        feedbackForm.reset();
        screenshotPreviewContainer.classList.add('hidden');
        appState.feedbackModeActive = false;
    }

    // --- Event Listeners ---

    // Start feedback on button click
    startFeedbackBtn.addEventListener('click', startFeedbackMode);

    // Handle form submission
    feedbackForm.addEventListener('submit', (event) => {
        event.preventDefault();

        const description = descriptionTextarea.value;
        const techInfo = techInfoTextarea.value;
        const screenshot = screenshotPreview.src;

        // In a real app, you would send this to your CRM backend
        const report = { description, techInfo, screenshot };

        console.log('--- Bug Report Submitted ---');
        console.log(report);
        console.log('----------------------------');

        // Show a success message
        showOverlayMessage("Report submitted successfully!");

        // Close the modal
        closeFeedbackModal();
    });

    // Handle cancel button click
    cancelBtn.addEventListener('click', () => {
        closeFeedbackModal();
    });

    // --- Initial Load ---
    window.onload = loadWebsiteFromUrl;

</script>
</body>
</html>
